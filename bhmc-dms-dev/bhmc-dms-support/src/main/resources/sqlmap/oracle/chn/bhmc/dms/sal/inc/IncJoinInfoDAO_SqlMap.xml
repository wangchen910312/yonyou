<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.inc.service.dao.IncJoinInfoDAO">

	<!-- 보험가입정보관리목록 조회  -->
	<select id="selectIncJoinInfoByCondition" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                 , FN_GET_CARLINE_NM_NC(T1.CARLINE_CD) AS CARLINE_NM
                 , CASE WHEN T1.MODEL_CD IS NULL THEN T1.FSC_CD
                        ELSE FN_GET_MODEL_TP_CD(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_CD
                 , CASE WHEN T1.MODEL_CD IS NULL THEN FN_GET_FSC_NM(T1.CARLINE_CD, T1.FSC_CD)
                        ELSE FN_GET_MODEL_TP_NM(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_NM
                 , T1.* FROM (
                        SELECT SA0216.DLR_CD || SA0216.INC_NO AS INC_PK
                             , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT OCN_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                                    ELSE SA0121.OCN_CD
                                END  AS OCN_CD
                             , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT EXT_COLOR_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                                    ELSE SA0121.EXT_COLOR_CD
                                END  AS EXT_COLOR_CD
                             , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT INT_COLOR_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                                    ELSE SA0121.INT_COLOR_CD
                                END  AS INT_COLOR_CD
                             , CR0101.CUST_TP,CR0101.CUST_NM
                             , SA0216.DLR_CD,SA0216.INC_NO,SA0216.CARLINE_CD,SA0216.FSC_CD,SA0216.MODEL_CD,SA0216.VIN_NO,SA0216.ENGIN_SERIAL_NO
                             , SA0216.CART_NO,SA0216.CAR_SALE_DT,SA0216.INC_EXPC_TOT_AMT,SA0216.REAL_INC_TOT_AMT
                             , SA0216.INC_FEE_TOT_AMT, SA0216.SALE_ID
                             , (SELECT USR_NM FROM CM_0801T WHERE USR_ID = SA0216.SALE_ID) AS SALE_NM
                             , SA0216.INC_JOIN_DT,SA0216.CUST_NO,SA0216.CUST_TEL_NO
                             , SA0216.INC_PROFIT_NM,SA0216.INC_PRSN_ID,SA0216.CONTRACT_NO,SA0216.INC_RCPT_NM,SA0216.CUST_SSN_CRN_NO
                             , SA0216.INC_CMP_CD,SA0216.FRC_INC_AMT,SA0216.BUS_INC_AMT,SA0216.REMARK
                             , SA0216.REG_USR_ID,SA0216.REG_DT,SA0216.UPDT_USR_ID,SA0216.UPDT_DT
                             , SA0216.FINC_YN
                             , SA0216.FINC_CMP_CD
                             , ( SELECT Z2.CMM_CD_NM
                                   FROM (SELECT A.CMM_CD
                                              , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                          FROM CM_0303T A
                                          LEFT OUTER JOIN CM_0304T B
                                                ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                               AND A.CMM_CD = B.CMM_CD
                                               AND B.LANG_CD = #{sLangCd}
                                         WHERE A.CMM_GRP_CD = 'SAL127'   /*보험회사명*/
                                           AND A.USE_YN = 'Y'
                                         ) Z2
                                 WHERE SA0216.INC_CMP_CD = Z2.CMM_CD
                               ) AS INC_CMP_NM             -- 보험회사명
                              , SA0216.INC_STAT
                              , ( SELECT Z2.CMM_CD_NM
                                   FROM (SELECT A.CMM_CD
                                              , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                          FROM CM_0303T A
                                          LEFT OUTER JOIN CM_0304T B
                                                ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                               AND A.CMM_CD = B.CMM_CD
                                               AND B.LANG_CD = #{sLangCd}
                                         WHERE A.CMM_GRP_CD = 'SAL177'   /*보험상태*/
                                           AND A.USE_YN = 'Y'
                                         ) Z2
                                 WHERE SA0216.INC_STAT = Z2.CMM_CD
                               ) AS INC_STAT_NM             -- 보험상태명
                             , SA0216.INC_CS
                             , ( SELECT Z2.CMM_CD_NM
                                  FROM (SELECT A.CMM_CD
                                             , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                         FROM CM_0303T A
                                         LEFT OUTER JOIN CM_0304T B
                                               ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                              AND A.CMM_CD = B.CMM_CD
                                              AND B.LANG_CD = #{sLangCd}
                                        WHERE A.CMM_GRP_CD = 'SAL176'   /*보험종류*/
                                          AND A.USE_YN = 'Y'
                                        ) Z2
                                WHERE SA0216.INC_CS = Z2.CMM_CD
                              ) AS INC_CS_NM             -- 보험종류명
                             , NVL(SA0216.CAR_BRAND_CD, 'O') AS CAR_BRAND_CD
                             , ( SELECT Z1.CMM_CD_NM
                                   FROM (SELECT A.CMM_CD
                                              , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                           FROM CM_0303T A
                                           LEFT OUTER JOIN CM_0304T B
                                             ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                            AND A.CMM_CD = B.CMM_CD
                                            AND B.LANG_CD = #{sLangCd}
                                         WHERE A.CMM_GRP_CD = 'COM019'
                                           AND A.USE_YN = 'Y'
                                         ) Z1
                                  WHERE NVL(SA0216.CAR_BRAND_CD, 'O') = Z1.CMM_CD
                               ) AS CAR_BRAND_NM
                             , SA0216.USE_CAR_NM
                             , (SELECT USR_NM FROM CM_0801T WHERE USR_ID = SA0216.UPDT_USR_ID) AS INC_PRSN_NM
                          FROM SA_0216T SA0216
                             , CR_0101T CR0101
                             ,( SELECT DLR_CD        AS DLR_CD
                                     , VIN_NO
                                     , MAX(CARLINE_CD)   AS CARLINE_CD
                                     , MAX(MODEL_CD)     AS MODEL_CD
                                     , MAX(OCN_CD)       AS OCN_CD
                                     , MAX(EXT_COLOR_CD) AS EXT_COLOR_CD
                                     , MAX(INT_COLOR_CD) AS INT_COLOR_CD
                                     , MAX(CAR_REG_NO)   AS CAR_REG_NO
                                     , MAX(ENGIN_MODEL_CD || ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                                     , MAX(CERT_NO) AS CART_NO
                                  FROM SA_0121T
                                 GROUP BY DLR_CD, VIN_NO
                               ) SA0121
                             , (
                                 SELECT DLR_CD, INC_NO, MAX(INC_END_DT) AS INC_END_DT
                                   FROM SA_0253T
                                  WHERE 1=1
                                  <if test='sIncEndFromDt != null'>
                                    AND INC_END_DT <![CDATA[>=]]> TRUNC(#{sIncEndFromDt},'DD')
                                  </if>
                                  <if test='sIncEndToDt != null'>
                                    AND INC_END_DT <![CDATA[<]]> TRUNC(#{sIncEndToDt},'DD')+1
                                  </if>
                                  GROUP BY DLR_CD, INC_NO
                              ) SA0253
                         WHERE 1=1
                           AND SA0216.CUST_NO = CR0101.CUST_NO(+)
                           AND SA0216.VIN_NO = SA0121.VIN_NO(+)
                           AND SA0216.DLR_CD = SA0121.DLR_CD(+)
                           AND SA0216.DLR_CD = SA0253.DLR_CD(+)
                           AND SA0216.INC_NO = SA0253.INC_NO(+)
                           AND SA0216.DLR_CD = #{sDlrCd}
                         <if test='sIncEndFromDt != null'>
                           AND SA0253.INC_END_DT <![CDATA[>=]]> TRUNC(#{sIncEndFromDt},'DD')
                         </if>
                         <if test='sIncEndToDt != null'>
                           AND SA0253.INC_END_DT <![CDATA[<]]> TRUNC(#{sIncEndToDt},'DD')+1
                         </if>
                         <!-- <if test='sVinNo1 != null and sVinNo1 != ""'>
                            AND SUBSTR(SA0216.VIN_NO,0,11) = #{sVinNo1}
                         </if>
                         <if test='sVinNo2 != null and sVinNo2 != ""'>
                            AND SUBSTR(SA0216.VIN_NO,12,6) = #{sVinNo2}
                         </if> -->
                         <if test='sVinNo != null and sVinNo != ""'>
                            AND SA0216.VIN_NO LIKE '%' || #{sVinNo} || '%'
                         </if>
                         <if test='sSaleId != null and sSaleId != ""'>
                            AND CR0101.MNG_SC_ID = #{sSaleId}
                         </if>
                         <if test='sIncCmpCd != null and sIncCmpCd != ""'>
                            AND SA0216.INC_CMP_CD = #{sIncCmpCd}
                         </if>
                         <if test='sCustNo != null and sCustNo != ""'>
                            AND SA0216.CUST_NO = #{sCustNo}
                         </if>
                         <if test='sCustNm != null and sCustNm != ""'>
                            AND CR0101.CUST_NM LIKE '%'||#{sCustNm}||'%'
                         </if>
                         <if test='sContractNo != null and sContractNo != ""'>
                            AND SA0216.CONTRACT_NO = #{sContractNo}
                         </if>
                         <if test='sIncNo != null and sIncNo != ""'>
                            AND SA0216.INC_NO = #{sIncNo}
                         </if>
                         <if test='sIncCs != null and sIncCs != ""'>
                            AND SA0216.INC_CS = #{sIncCs}
                         </if>
                         <if test='sIncStat != null and sIncStat != ""'>
                            AND SA0216.INC_STAT = #{sIncStat}
                         </if>
                         <if test='sCarRegNo != null and sCarRegNo != ""'>
                            AND SA0216.CAR_REG_NO LIKE '%'||#{sCarRegNo}||'%'
                         </if>
                         <if test='sIncJoinStartDt != null'>
                             AND SA0216.INC_JOIN_DT <![CDATA[>=]]> TRUNC(#{sIncJoinStartDt},'DD')
                         </if>
                         <if test='sIncJoinEndDt != null'>
                             AND SA0216.INC_JOIN_DT <![CDATA[<]]> TRUNC(#{sIncJoinEndDt},'DD')+1
                         </if>
                         <if test='sCarSaleStartDt != null'>
                             AND SA0216.CAR_SALE_DT <![CDATA[>=]]> TRUNC(#{sCarSaleStartDt},'DD')
                         </if>
                         <if test='sCarSaleEndDt != null'>
                             AND SA0216.CAR_SALE_DT <![CDATA[<]]> TRUNC(#{sCarSaleEndDt},'DD')+1
                         </if>
                         <if test='sFincYn != null and sFincYn != ""'>
                            AND SA0216.FINC_YN = #{sFincYn}
                         </if>
                        ORDER BY
                         <choose>
                            <when test='sort != null'>
                                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                    <choose>
                                        <when test='item.field == "custNo"'>CUST_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "custNm"'>CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "custTelNo"'>CUST_TEL_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "carlineNm"'>FN_GET_CARLINE_NM_NC(SA0216.CARLINE_CD) <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "fscNm"'>DECODE(SA0216.MODEL_CD, NULL, FN_GET_FSC_NM(SA0216.CARLINE_CD, SA0216.FSC_CD), FN_GET_MODEL_TP_NM(SA0216.MODEL_CD, OCN_CD)) <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incCmpCd"'>INC_CMP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incAmt"'>INC_EXPC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "realIncAmt"'>REAL_INC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "profitAmt"'>INC_FEE_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incNo"'>INC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "saleNm"'>SALE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incJoinDt"'>INC_JOIN_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "carRegNo"'>CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "carSaleDt"'>CAR_SALE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incPrsnId"'>INC_PRSN_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "icnProfitNm"'>INC_PROFIT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <when test='item.field == "incStatNm"'>INC_STAT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                        <otherwise>
                                            INC_NO DESC
                                        </otherwise>
                                    </choose>
                                </foreach>
                            </when>
                            <otherwise>
                                INC_NO DESC
                            </otherwise>
                        </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>


	<!-- 보험가입정보관리목록 갯수  -->
	<select id="selectIncJoinInfoByConditionCnt" parameterType="IncJoinInfoSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0216T SA0216
             , CR_0101T CR0101
             ,( SELECT DLR_CD        AS DLR_CD
                     , VIN_NO
                     , MAX(CARLINE_CD)   AS CARLINE_CD
                     , MAX(MODEL_CD)     AS MODEL_CD
                     , MAX(OCN_CD)       AS OCN_CD
                     , MAX(EXT_COLOR_CD) AS EXT_COLOR_CD
                     , MAX(INT_COLOR_CD) AS INT_COLOR_CD
                     , MAX(CAR_REG_NO)   AS CAR_REG_NO
                     , MAX(ENGIN_MODEL_CD || ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                     , MAX(CERT_NO) AS CART_NO
                  FROM SA_0121T
                 GROUP BY DLR_CD, VIN_NO
               ) SA0121
             , (
                 SELECT DLR_CD, INC_NO, MAX(INC_END_DT) AS INC_END_DT
                   FROM SA_0253T
                  WHERE 1=1
                  <if test='sIncEndFromDt != null'>
                    AND INC_END_DT <![CDATA[>=]]> TRUNC(#{sIncEndFromDt},'DD')
                  </if>
                  <if test='sIncEndToDt != null'>
                    AND INC_END_DT <![CDATA[<]]> TRUNC(#{sIncEndToDt},'DD')+1
                  </if>
                  GROUP BY DLR_CD, INC_NO
              ) SA0253
         WHERE 1=1
           AND SA0216.CUST_NO = CR0101.CUST_NO(+)
           AND SA0216.VIN_NO = SA0121.VIN_NO(+)
           AND SA0216.DLR_CD = SA0121.DLR_CD(+)
           AND SA0216.DLR_CD = SA0253.DLR_CD(+)
           AND SA0216.INC_NO = SA0253.INC_NO(+)
           AND SA0216.DLR_CD = #{sDlrCd}
         <if test='sIncEndFromDt != null'>
           AND SA0253.INC_END_DT <![CDATA[>=]]> TRUNC(#{sIncEndFromDt},'DD')
         </if>
         <if test='sIncEndToDt != null'>
           AND SA0253.INC_END_DT <![CDATA[<]]> TRUNC(#{sIncEndToDt},'DD')+1
         </if>
         <!-- <if test='sVinNo1 != null and sVinNo1 != ""'>
            AND SUBSTR(SA0216.VIN_NO,0,11) = #{sVinNo1}
         </if>
         <if test='sVinNo2 != null and sVinNo2 != ""'>
            AND SUBSTR(SA0216.VIN_NO,12,6) = #{sVinNo2}
         </if> -->
         <if test='sVinNo != null and sVinNo != ""'>
            AND SA0216.VIN_NO LIKE '%' || #{sVinNo} || '%'
         </if>
         <if test='sSaleId != null and sSaleId != ""'>
            AND SA0216.SALE_ID = #{sSaleId}
         </if>
         <if test='sIncCmpCd != null and sIncCmpCd != ""'>
            AND SA0216.INC_CMP_CD = #{sIncCmpCd}
         </if>
         <if test='sCustNo != null and sCustNo != ""'>
            AND SA0216.CUST_NO = #{sCustNo}
         </if>
         <if test='sCustNm != null and sCustNm != ""'>
            AND CR0101.CUST_NM LIKE '%'||#{sCustNm}||'%'
         </if>
         <if test='sContractNo != null and sContractNo != ""'>
            AND SA0216.CONTRACT_NO = #{sContractNo}
         </if>
         <if test='sIncNo != null and sIncNo != ""'>
            AND SA0216.INC_NO = #{sIncNo}
         </if>
         <if test='sIncCs != null and sIncCs != ""'>
            AND SA0216.INC_CS = #{sIncCs}
         </if>
         <if test='sIncStat != null and sIncStat != ""'>
            AND SA0216.INC_STAT = #{sIncStat}
         </if>
         <if test='sCarRegNo != null and sCarRegNo != ""'>
            AND SA0216.CAR_REG_NO LIKE '%'||#{sCarRegNo}||'%'
         </if>
         <if test='sIncJoinStartDt != null'>
             AND SA0216.INC_JOIN_DT <![CDATA[>=]]> TRUNC(#{sIncJoinStartDt},'DD')
         </if>
         <if test='sIncJoinEndDt != null'>
             AND SA0216.INC_JOIN_DT <![CDATA[<]]> TRUNC(#{sIncJoinEndDt},'DD')+1
         </if>
         <if test='sCarSaleStartDt != null'>
             AND SA0216.CAR_SALE_DT <![CDATA[>=]]> TRUNC(#{sCarSaleStartDt},'DD')
         </if>
         <if test='sCarSaleEndDt != null'>
             AND SA0216.CAR_SALE_DT <![CDATA[<]]> TRUNC(#{sCarSaleEndDt},'DD')+1
         </if>
         <if test='sFincYn != null and sFincYn != ""'>
            AND SA0216.FINC_YN = #{sFincYn}
         </if>

	</select>

    <select id="selectSungCd" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT SUNG_CD,MAX(SUNG_NM) AS SUNG_NM
          FROM CM_0205T
         WHERE USE_YN = 'Y'
         GROUP BY SUNG_CD
    </select>


    <select id="selectCityCd" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT CITY_CD,MAX(CITY_NM) AS CITY_NM
          FROM CM_0205T
         WHERE 1=1
           AND SUNG_CD = #{sungCd}
           AND USE_YN = 'Y'
         GROUP BY CITY_CD
    </select>

    <select id="selectDistCd" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT DIST_CD,DIST_NM AS DIST_NM,ZIP_CD
          FROM CM_0205T
         WHERE 1=1
           AND SUNG_CD = #{sungCd}
           AND CITY_CD = #{cityCd}
           AND USE_YN = 'Y'
    </select>



    <select id="selectIncNo" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT INC_NO
          FROM SA_0216T SA0216
         WHERE 1=1
           AND SA0216.CONTRACT_NO = #{sContractNo}
           AND SA0216.DLR_CD = #{sDlrCd}
           AND SA0216.CUST_NO = #{sCustNo}
    </select>

    <!-- 보험정보를 등록한다. -->
    <insert id="insertIncJoinInfo" parameterType="IncJoinInfoVO">
        INSERT INTO SA_0216T(
               DLR_CD           ,INC_NO
              ,CARLINE_CD       ,FSC_CD             ,MODEL_CD
              ,VIN_NO
              ,ENGIN_SERIAL_NO
              ,CART_NO
              ,CAR_REG_NO
              ,CAR_SALE_DT      ,INC_EXPC_TOT_AMT   ,REAL_INC_TOT_AMT   ,INC_FEE_TOT_AMT    ,SALE_ID         ,INC_JOIN_DT
              ,CUST_NO          ,CUST_TEL_NO        ,INC_PROFIT_NM      ,INC_PRSN_ID        ,CONTRACT_NO     ,INC_RCPT_NM
              ,CUST_SSN_CRN_NO  ,INC_CMP_CD         ,FRC_INC_AMT        ,BUS_INC_AMT        ,CUST_SSN_CRN_TP ,CUST_TP
              ,REG_USR_ID       ,REG_DT             ,UPDT_USR_ID        ,UPDT_DT            ,INC_CUST_NM     ,INC_CUST_TEL_NO
              ,CAR_BRAND_CD     ,USE_CAR_NM         ,NCAR_DSTIN_CD      ,INC_PCON_CUST_NM   ,INC_PCON_CUST_TEL_NO
              ,FIN_IMPLY_YN     ,INC_CS             ,INC_STAT           ,IMPLY_YN           ,REMARK          ,TRANS_TAX_AMT
              ,FINC_YN          ,FINC_CMP_CD
         )VALUES(
               #{dlrCd}         ,(SELECT 'INC' || LPAD(NVL(MAX(SUBSTR(INC_NO,-10)),0)+1,'10','0') FROM SA_0216T)
              ,#{carlineCd}     ,#{fscCd}         ,#{modelCd}
              ,#{vinNo}
              ,(SELECT MAX(A.ENGIN_MODEL_CD || A.ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                  FROM SA_0121T A
                 WHERE A.DLR_CD = #{dlrCd}
                   AND A.VIN_NO = #{vinNo}
               )
              ,(SELECT MAX(A.CERT_NO) AS CART_NO
                  FROM SA_0121T A
                 WHERE A.DLR_CD = #{dlrCd}
                   AND A.VIN_NO = #{vinNo}
               )
              ,(SELECT MAX(A.CAR_REG_NO) AS CAR_REG_NO
                  FROM SA_0121T A
                 WHERE A.DLR_CD = #{dlrCd}
                   AND A.VIN_NO = #{vinNo}
               )
              ,#{carSaleDt}     ,#{incExpcTotAmt}   ,#{realIncTotAmt}   ,#{incFeeTotAmt}    ,#{saleId}       ,#{incJoinDt}
              ,#{custNo}        ,#{custTelNo}       ,#{incProfitNm}     ,#{incPrsnId}       ,#{contractNo}   ,#{incRcptNm}
              ,#{custSsnCrnNo}  ,#{incCmpCd}        ,#{frcIncAmt}       ,#{busIncAmt}       ,#{custSsnCrnTp} ,#{custTp}
              ,#{regUsrId}      ,SYSDATE            ,#{regUsrId}        ,SYSDATE            ,#{incCustNm}    ,#{incCustTelNo}
              ,#{carBrandCd}    ,#{useCarNm}        ,#{ncarDstinCd}     ,#{incPconCustNm}   ,#{incPconCustTelNo}
              ,#{finImplyYn}    ,#{incCs}           ,#{incStat}         ,#{implyYn}         ,#{remark}       ,#{transTaxAmt}
              ,#{fincYn}        ,#{fincCmpCd}
        )
        <selectKey resultType="String" keyProperty="incNo" order="AFTER">
            SELECT MAX(INC_NO) AS incNo FROM SA_0216T WHERE DLR_CD = #{dlrCd}
        </selectKey>
    </insert>

    <!-- 보험정보를 내용을 저장.  -->
    <update id="updateIncJoinInfo" parameterType="IncJoinInfoVO">
        UPDATE SA_0216T
           SET
             <if test='pageGubun == "G"'>
              VIN_NO = #{vinNo}
             ,ENGIN_SERIAL_NO = (
                                 SELECT MAX(A.ENGIN_MODEL_CD || A.ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                                   FROM SA_0121T A
                                  WHERE A.ORD_DLR_CD = #{dlrCd}
                                    AND A.VIN_NO = #{vinNo}
                               )
             ,CART_NO = (
                         SELECT MAX(A.CERT_NO) AS CART_NO
                           FROM SA_0121T A
                          WHERE A.ORD_DLR_CD = #{dlrCd}
                            AND A.VIN_NO = #{vinNo}
                        )
             ,CAR_REG_NO = (
                            SELECT MAX(A.CAR_REG_NO) AS CAR_REG_NO
                              FROM SA_0121T A
                             WHERE A.ORD_DLR_CD = #{dlrCd}
                               AND A.VIN_NO = #{vinNo}
                           )
             ,CAR_SALE_DT = (
                            SELECT MAX(A.CUST_SALE_DT) AS CUST_SALE_DT
                              FROM SA_0121T A
                             WHERE A.ORD_DLR_CD = #{dlrCd}
                               AND A.VIN_NO = #{vinNo}
                           )
             </if>
             <if test='pageGubun != "G"'>
             INC_EXPC_TOT_AMT = #{incExpcTotAmt}
             , REAL_INC_TOT_AMT = #{realIncTotAmt}
             , INC_FEE_TOT_AMT = #{incFeeTotAmt}
             , INC_PROFIT_NM = #{incProfitNm}
             , INC_PRSN_ID = #{incPrsnId}
             , INC_RCPT_NM = #{incRcptNm}
             , INC_CMP_CD = #{incCmpCd}
             , FRC_INC_AMT = #{frcIncAmt}
             , BUS_INC_AMT = #{busIncAmt}
             , INC_PCON_CUST_NM = #{incPconCustNm}
             , INC_PCON_CUST_TEL_NO = #{incPconCustTelNo}
             , FIN_IMPLY_YN = #{finImplyYn}
             , INC_CS = #{incCs}
             , INC_STAT = #{incStat}
             , CUST_SSN_CRN_NO = #{custSsnCrnNo}
             , INC_CUST_NM = #{incCustNm}
             , INC_CUST_TEL_NO = #{incCustTelNo}
             , REMARK = #{remark}
             , TRANS_TAX_AMT = #{transTaxAmt}
             , INC_JOIN_DT = #{incJoinDt}
             , FINC_YN = #{fincYn}
             , FINC_CMP_CD = #{fincCmpCd}
             </if>
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
        WHERE 1=1
          AND DLR_CD = #{dlrCd}
          AND INC_NO = #{incNo}
    </update>

    <!-- 계약에서 보험 헤더정보를 수정. -->
    <update id="updateIncJoinInfoContract" parameterType="IncJoinInfoVO">
        UPDATE SA_0216T
           SET CARLINE_CD = #{carlineCd}
             , FSC_CD = #{fscCd}
             , MODEL_CD = #{modelCd}
             , VIN_NO = #{vinNo}
             , ENGIN_SERIAL_NO = (SELECT MAX(A.ENGIN_MODEL_CD || A.ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                                    FROM SA_0121T A
                                   WHERE A.ORD_DLR_CD = #{dlrCd}
                                     AND A.VIN_NO = #{vinNo}
                                 )
             , CART_NO = (SELECT MAX(A.CERT_NO) AS CART_NO
                            FROM SA_0121T A
                           WHERE A.ORD_DLR_CD = #{dlrCd}
                             AND A.VIN_NO = #{vinNo}
                          )

             , CAR_REG_NO = (SELECT MAX(A.CAR_REG_NO) AS CAR_REG_NO
                               FROM SA_0121T A
                              WHERE A.ORD_DLR_CD = #{dlrCd}
                                AND A.VIN_NO = #{vinNo}
                            )
             , SALE_ID = #{saleId}
             , INC_EXPC_TOT_AMT = #{incExpcTotAmt}
             , REAL_INC_TOT_AMT = #{realIncTotAmt}
             , INC_FEE_TOT_AMT = #{incFeeTotAmt}
             , FRC_INC_AMT = #{frcIncAmt}
             , BUS_INC_AMT = #{busIncAmt}
             , TRANS_TAX_AMT = #{transTaxAmt}
             , INC_JOIN_DT = #{incJoinDt}
             , CUST_NO = #{custNo}
             , CUST_TP = #{custTp}
             , CUST_TEL_NO = #{custTelNo}
             , CONTRACT_NO = #{contractNo}
             , CUST_SSN_CRN_TP = #{custSsnCrnTp}
             , CUST_SSN_CRN_NO = #{custSsnCrnNo}
             , INC_PROFIT_NM = #{incProfitNm}
             , INC_CMP_CD = #{incCmpCd}
             , INC_CUST_NM = #{incCustNm}
             , INC_CUST_TEL_NO = #{incCustTelNo}
             , NCAR_DSTIN_CD = #{ncarDstinCd}
             , INC_PCON_CUST_NM = #{incPconCustNm}
             , INC_PCON_CUST_TEL_NO = #{incPconCustTelNo}
             , FIN_IMPLY_YN = #{finImplyYn}
             , IMPLY_YN = #{implyYn}
             , REMARK = #{remark}
             , INC_STAT = #{incStat}
             , INC_CS = #{incCs}
             , FINC_YN = #{fincYn}
             , FINC_CMP_CD = #{fincCmpCd}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
    </update>

    <!-- 보험가입정보관리상태를 변경한다. -->
    <update id="updateSateIncJoinInfo" parameterType="IncJoinInfoVO">
        UPDATE SA_0216T
           SET INC_STAT = #{incStat}
         WHERE DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
    </update>

    <!-- 계약과 연계된 보험가입자의 고객정보를 변경한다.  -->
    <update id="updateIncCustInfo" parameterType="IncJoinInfoVO">
        UPDATE SA_0216T
           SET SALE_ID = #{saleId}
             , CUST_NO = #{custNo}
             , CUST_TP = #{custTp}
             , CUST_TEL_NO = #{custTelNo}
             , CUST_SSN_CRN_TP = #{custSsnCrnTp}
             , CUST_SSN_CRN_NO = #{custSsnCrnNo}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <select id="selectCustContractNoCnt" parameterType="IncJoinInfoSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0201T SA0201,SA_0121T SA0121,CR_0101T CR0101
         WHERE 1=1
           AND SA0201.DLR_CD = SA0121.DLR_CD(+)
           AND SA0201.CONTRACT_NO = SA0121.CONTRACT_NO(+)
           AND SA0201.VIN_NO = SA0121.VIN_NO(+)
           AND SA0201.CONTRACT_CUST_NO = CR0101.CUST_NO(+)
           AND SA0201.CONTRACT_CUST_NO = #{sCustNo}
           AND SA0201.CONTRACT_STAT_CD IN ('20','50')
           AND SA0201.DLR_CD = #{sDlrCd}
    </select>

    <!-- 고객정보 불러온다. -->
    <select id="selectCustContractNo" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT *
          FROM (
                SELECT SA0121.ORD_DLR_CD
                     , CR0101.CUST_NO
                     , SA0121.VIN_NO
                     , SA0121.CARLINE_CD
                     , FN_GET_CARLINE_NM(SA0121.CARLINE_CD) AS CARLINE_NM
                     , FN_GET_MODEL_TP_CD(SA0121.MODEL_CD, SA0121.OCN_CD) AS FSC_CD
                     , FN_GET_MODEL_TP_NM(SA0121.MODEL_CD, SA0121.OCN_CD) AS FSC_NM
                     , SA0121.MODEL_CD
                     , FN_GET_MODEL_NM(SA0121.MODEL_CD) AS MODEL_NM
                     , SA0121.OCN_CD
                     , FN_GET_OCN_NM(SA0121.MODEL_CD, SA0121.OCN_CD) AS OCN_NM
                     , SA0121.EXT_COLOR_CD
                     , (SELECT EXT_COLOR_NM FROM SA_0107T WHERE EXT_COLOR_CD = SA0121.EXT_COLOR_CD) AS EXT_COLOR_NM
                     , SA0121.INT_COLOR_CD
                     , (SELECT INT_COLOR_NM FROM SA_0108T WHERE INT_COLOR_CD = SA0121.INT_COLOR_CD) AS INT_COLOR_NM
                     , CR0101.CUST_NO
                     , CR0101.CUST_NM
                     , CR0101.CUST_TP
                     , CR0101.HP_NO AS CUST_TEL_NO
                     , (SA0121.ENGIN_MODEL_CD || SA0121.ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                     , SA0121.CERT_NO AS CART_NO
                     , SA0121.CAR_REG_NO
                     , SA0121.TEMP1 as USE_CAR_NM
                     , SA0121.NCAR_DSTIN_CD AS CAR_BRAND_CD
                     , SA0121.NCAR_DSTIN_CD
                     , '' AS CAR_BRAND_NM
                  FROM CR_0101T CR0101
                     , (
                         SELECT VO.BP_CD
                              , V.*
                           FROM SA_0121T V
                              , SA_0123T VO
                          WHERE V.CAR_ID = VO.CAR_ID
                            AND V.DLR_CD = VO.DLR_CD  -- 자사 및 타딜러 포함
                            AND VO.DLR_CD = #{sDlrCd}
                            AND VO.USE_YN = 'Y'
                            AND V.NCAR_DSTIN_CD = 'N'
                       ) SA0121
                 WHERE CR0101.DLR_CD = SA0121.DLR_CD   -- 자사 및 타딜러 포함
                   AND CR0101.CUST_NO = SA0121.BP_CD
                   AND CR0101.DLR_CD = #{sDlrCd}
                   AND CR0101.CUST_NO = #{sCustNo}
            UNION
                SELECT A.*
                     , ( SELECT Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                   FROM CM_0303T A
                                   LEFT OUTER JOIN CM_0304T B
                                     ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                    AND A.CMM_CD = B.CMM_CD
                                    AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'COM019'
                                  -- AND A.USE_YN = 'Y'
                                 ) Z1
                         WHERE A.NCAR_DSTIN_CD = Z1.CMM_CD
                       ) AS CAR_BRAND_NM
                  FROM (
                        SELECT A.DLR_CD         -- 타사고객
                             , B.CUST_NO AS CONTRACT_CUST_NO
                             , NVL(C.VIN_NO, ' ') AS VIN_NO
                             , MAX(C.CARLINE_CD) AS CARLINE_CD
                             , '' AS CARLINE_NM
                             , '' AS FSC_CD
                             , '' AS FSC_NM
                             , '' AS MODEL_CD
                             , '' AS MODEL_NM
                             , '' AS OCN_CD
                             , '' AS OCN_NM
                             , '' AS EXT_COLOR_CD
                             , '' AS EXT_COLOR_NM
                             , '' AS INT_COLOR_CD
                             , '' AS INT_COLOR_NM
                             , MAX(B.CUST_NO) AS CUST_NO
                             , MAX(B.CUST_NM) AS CUST_NM
                             , MAX(B.CUST_TP) AS CUST_TP
                             , MAX(B.HP_NO) AS HP_NO
                             , MAX(C.ENGIN_MODEL_CD || C.ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                             , MAX(C.CERT_NO) AS CERT_NO
                             , MAX(C.CAR_REG_NO) AS CAR_REG_NO
                             , MAX(C.TEMP1) AS USE_CAR_NM
                             , MAX(C.NCAR_DSTIN_CD) AS CAR_BRAND_CD
                             , MAX(C.NCAR_DSTIN_CD) AS NCAR_DSTIN_CD
                          FROM SA_0123T A
                             , CR_0101T B
                             , SA_0121T C
                         WHERE A.DLR_CD = B.DLR_CD
                           AND A.BP_CD  = B.CUST_NO
                           AND A.DLR_CD = C.DLR_CD
                           AND A.CAR_ID = C.CAR_ID
                           AND A.USE_YN = 'Y'
                           AND C.NCAR_DSTIN_CD = 'O'
                           AND A.BP_CD = #{sCustNo}
                           AND A.DLR_CD = #{sDlrCd}
                           GROUP BY A.DLR_CD, B.CUST_NO, C.VIN_NO
                       ) A
            )
            ORDER BY NCAR_DSTIN_CD ASC, VIN_NO ASC
    </select>


    <!-- 보험가입명세 목록의 갯수를 조회한다. -->
    <select id="selectIncDetailItemCnt" parameterType="IncJoinInfoSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0253T SA0253
         WHERE 1=1
           AND SA0253.DLR_CD = #{sDlrCd}
           AND SA0253.INC_NO = #{sIncNo}
         <if test='sIncTp != null and sIncTp != ""'>
           AND SA0253.INC_TP = #{sIncTp}
         </if>
    </select>


    <!-- 보험가입명세 목록을 조회한다. -->
    <select id="selectIncDetailItem" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT SA0253.DLR_CD || SA0253.INC_NO || SA0253.INC_TP AS INC_PK
             , SA0253.DLR_CD,SA0253.INC_NO,SA0253.INC_EXPC_AMT,SA0253.REAL_INC_AMT
             , SA0253.INC_TP
             , ( SELECT Z2.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL019'   /*보험유형*/
                                   AND A.USE_YN = 'Y'
                                 ) Z2
                         WHERE SA0253.INC_TP = Z2.CMM_CD
               ) AS INC_TP_NM             /*보험유형 명칭*/
             , SA0253.INC_PRID,SA0253.INC_START_DT,SA0253.INC_END_DT,SA0253.INC_AMT,SA0253.REMARK
             , SA0253.REG_USR_ID,SA0253.REG_DT,SA0253.UPDT_USR_ID,SA0253.UPDT_DT
          FROM SA_0253T SA0253
             , (SELECT * FROM SA_0216T WHERE CUST_NO = #{sCustNo}) SA0216
         WHERE 1=1
           AND SA0253.DLR_CD = SA0216.DLR_CD
           AND SA0253.INC_NO = SA0216.INC_NO
           AND SA0253.DLR_CD = #{sDlrCd}
           AND SA0253.INC_NO = #{sIncNo}
         ORDER BY SA0253.DLR_CD, SA0253.INC_NO DESC, SA0253.INC_TP ASC
    </select>




    <!-- 보험가입명세 등록. -->
    <insert id="insertIncDetailItem" parameterType="IncJoinInfoVO">
        INSERT INTO SA_0253T(
               DLR_CD           ,INC_NO             ,INC_TP             ,INC_EXPC_AMT       ,REAL_INC_AMT   ,INC_PRID
              ,INC_START_DT     ,INC_END_DT         ,INC_AMT            ,REMARK
              ,REG_USR_ID       ,REG_DT             ,UPDT_USR_ID        ,UPDT_DT
        )VALUES(
               #{dlrCd}         ,#{incNo}           ,#{incTp}           ,#{incExpcAmt}      ,#{realIncAmt}  ,#{incPrid}
              ,#{incStartDt}    ,#{incEndDt}        ,#{incAmt}          ,#{remark}
              ,#{regUsrId}      ,SYSDATE            ,#{regUsrId}        ,SYSDATE
        )
    </insert>



    <!-- 보험가입명세 수정. -->
    <update id="updateIncDetailItem" parameterType="IncJoinInfoVO">
        UPDATE SA_0253T
           SET INC_EXPC_AMT = #{incExpcAmt}
             , REAL_INC_AMT = #{realIncAmt}
             , INC_PRID = #{incPrid}
             , INC_START_DT = #{incStartDt}
             , INC_END_DT = #{incEndDt}
             , INC_AMT = #{incAmt}
             , REMARK = #{remark}
             , REG_USR_ID = #{regUsrId}
             , REG_DT = SYSDATE
             , UPDT_USR_ID = #{regUsrId}
             , UPDT_DT = SYSDATE
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
           AND INC_TP = #{incTp}
    </update>


    <!-- 보험가입명세 삭제. -->
    <delete id="deleteIncDetailItem" parameterType="IncJoinInfoVO">
        DELETE SA_0253T
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
           AND INC_TP = #{incTp}
    </delete>

    <!-- 보험가입정보관리 상세  -->
    <select id="selectIncDetail" parameterType="IncJoinInfoSearchVO" resultType="IncJoinInfoVO">
        SELECT T.*
             , FN_GET_CARLINE_NM(T.CARLINE_CD) AS CARLINE_NM
             , FN_GET_MODEL_TP_CD(T.MODEL_CD, T.OCN_CD) AS FSC_CD
             , FN_GET_MODEL_TP_NM(T.MODEL_CD, T.OCN_CD) AS FSC_NM
             , FN_GET_OCN_NM(T.MODEL_CD, T.OCN_CD) AS OCN_NM
             , FN_GET_EXT_COLOR_NM(T.EXT_COLOR_CD)  AS EXT_COLOR_NM
             , FN_GET_INT_COLOR_NM(T.INT_COLOR_CD)  AS INT_COLOR_NM
          FROM (
                SELECT SA0216.DLR_CD || SA0216.INC_NO AS INC_PK
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT OCN_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                            ELSE SA0121.OCN_CD
                        END  AS OCN_CD
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT EXT_COLOR_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                            ELSE SA0121.EXT_COLOR_CD
                        END  AS EXT_COLOR_CD
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN (SELECT INT_COLOR_CD FROM SA_0201T WHERE CONTRACT_NO = SA0216.CONTRACT_NO)
                            ELSE SA0121.INT_COLOR_CD
                        END  AS INT_COLOR_CD
                     , SA0216.CUST_TP
                     , CR0101.CUST_NM
                     , SA0216.DLR_CD
                     , SA0216.INC_NO
                     , SA0216.CARLINE_CD
                     , SA0216.MODEL_CD
                     , SA0216.VIN_NO
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN ''
                            ELSE SA0121.CAR_REG_NO
                        END AS CAR_REG_NO
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN SA0216.ENGIN_SERIAL_NO
                            ELSE SA0121.ENGIN_SERIAL_NO
                        END AS ENGIN_SERIAL_NO
                     , CASE WHEN SA0121.VIN_NO IS NULL THEN SA0216.CART_NO
                            ELSE SA0121.CART_NO
                        END AS CART_NO
                     , SA0216.CAR_SALE_DT
                     , SA0216.INC_EXPC_TOT_AMT
                     , SA0216.REAL_INC_TOT_AMT
                     , SA0216.INC_FEE_TOT_AMT,SA0216.SALE_ID,SA0216.INC_JOIN_DT,SA0216.CUST_NO,SA0216.CUST_TEL_NO
                     , SA0216.INC_PROFIT_NM,SA0216.INC_PRSN_ID,SA0216.INC_RCPT_NM,SA0216.CUST_SSN_CRN_NO
                     , SA0216.INC_CMP_CD,SA0216.FRC_INC_AMT,SA0216.BUS_INC_AMT,SA0216.TRANS_TAX_AMT
                     , SA0216.REG_USR_ID,SA0216.REG_DT,SA0216.UPDT_USR_ID,SA0216.UPDT_DT
                     , SA0216.CONTRACT_NO
                     , SA0216.INC_CUST_NM
                     , SA0216.INC_CUST_TEL_NO
                     , SA0216.CAR_BRAND_CD
                     , ( SELECT Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                   FROM CM_0303T A
                                   LEFT OUTER JOIN CM_0304T B
                                     ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                    AND A.CMM_CD = B.CMM_CD
                                    AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'COM019'
                                   AND A.USE_YN = 'Y'
                                 ) Z1
                          WHERE SA0216.CAR_BRAND_CD = Z1.CMM_CD
                       ) AS CAR_BRAND_NM
                     , SA0216.USE_CAR_NM
                     , SA0216.NCAR_DSTIN_CD
                     , SA0216.INC_PCON_CUST_NM
                     , SA0216.INC_PCON_CUST_TEL_NO
                     , SA0216.FIN_IMPLY_YN
                     , SA0216.INC_CS
                     , SA0216.INC_STAT
                     , SA0216.IMPLY_YN
                     , SA0216.REMARK
                     , SA0216.FINC_YN
                     , SA0216.FINC_CMP_CD
                     , (SELECT USR_NM FROM CM_0801T WHERE USR_ID = SA0216.UPDT_USR_ID) AS INC_PRSN_NM
                  FROM SA_0216T SA0216
                     , CR_0101T CR0101
                     ,( SELECT DLR_CD        AS DLR_CD
                             , VIN_NO
                             , MAX(CARLINE_CD)   AS CARLINE_CD
                             , MAX(MODEL_CD)     AS MODEL_CD
                             , MAX(OCN_CD)       AS OCN_CD
                             , MAX(EXT_COLOR_CD) AS EXT_COLOR_CD
                             , MAX(INT_COLOR_CD) AS INT_COLOR_CD
                             , MAX(CAR_REG_NO)   AS CAR_REG_NO
                             , MAX(ENGIN_MODEL_CD || ENGIN_SERIAL_NO) AS ENGIN_SERIAL_NO
                             , MAX(CERT_NO) AS CART_NO
                          FROM SA_0121T
                         GROUP BY DLR_CD, VIN_NO
                       ) SA0121
                 WHERE 1=1
                   AND SA0216.CUST_NO = CR0101.CUST_NO(+)
                   AND SA0216.VIN_NO = SA0121.VIN_NO(+)
                   AND SA0216.DLR_CD = SA0121.DLR_CD(+)
                   AND SA0216.INC_NO = #{sIncNo}
                   AND SA0216.DLR_CD = #{sDlrCd}
               ) T
    </select>

    <!-- 보험내역을 삭제한다.(소매계약 확정시 호출) -->
    <delete id="deleteContractSaleDetailItem" parameterType="IncJoinInfoVO">
        DELETE SA_0253T
         WHERE DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
    </delete>

    <delete id="deleteContractSaleHeader" parameterType="IncJoinInfoVO">
        DELETE SA_0216T
         WHERE DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
    </delete>

    <!-- 보험추적의 목록 갯수를 조회한다 -->
    <select id="selectIncProcessByConditionCnt" parameterType="IncProcessSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0254T A    --보험고객추적
         WHERE A.DLR_CD = #{sDlrCd}
           AND A.INC_NO = #{sIncNo}
         <if test='sSeq != null and sSeq != ""'>
           AND A.SEQ = #{sSeq}
         </if>
    </select>

    <!-- 보험추적을 조회한다. -->
    <select id="selectIncProcessByCondition" parameterType="IncProcessSearchVO" resultType="IncProcessVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.*
              FROM (
                    SELECT A.DLR_CD                   --딜러코드
                         , A.INC_NO                   --보험번호
                         , A.SEQ                      --일련번호
                         , A.TRACE_CONT               --추적내용
                         , A.TRACE_GRADE_CD           --추적등급코드
                         , ( SELECT Z1.CMM_CD_NM FROM (SELECT A.CMM_CD, NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM FROM CM_0303T A LEFT OUTER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                               AND B.LANG_CD = #{sLangCd}
                              WHERE A.CMM_GRP_CD = 'SAL209'
                                AND A.USE_YN = 'Y') Z1
                              WHERE A.TRACE_GRADE_CD = Z1.CMM_CD
                           ) AS TRACE_GRADE_NM
                         , A.TRACE_DT                 --추적일자
                         , A.TRACE_MTH_CD             --추적방법코드
                         , ( SELECT Z1.CMM_CD_NM FROM (SELECT A.CMM_CD, NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM FROM CM_0303T A LEFT OUTER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                                AND B.LANG_CD = #{sLangCd}
                              WHERE A.CMM_GRP_CD = 'CRM377'
                                AND A.USE_YN = 'Y') Z1
                              WHERE A.TRACE_MTH_CD = Z1.CMM_CD
                            ) AS TRACE_MTH_NM
                         , A.NEXT_TRACE_DT            --다음추적일자
                         , A.NEXT_TRACE_MTH_CD        --다음추적방법코드
                         , ( SELECT Z1.CMM_CD_NM FROM (SELECT A.CMM_CD, NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM FROM CM_0303T A LEFT OUTER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                                AND B.LANG_CD = #{sLangCd}
                              WHERE A.CMM_GRP_CD = 'CRM377'
                                AND A.USE_YN = 'Y') Z1
                              WHERE A.NEXT_TRACE_MTH_CD = Z1.CMM_CD
                            ) AS NEXT_TRACE_MTH_NM
                         , A.VALID_GRADE_CD           --유효등급코드
                         , ( SELECT Z1.CMM_CD_NM FROM (SELECT A.CMM_CD, NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM FROM CM_0303T A LEFT OUTER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                                AND B.LANG_CD = #{sLangCd}
                              WHERE A.CMM_GRP_CD = 'CRM364'
                                AND A.USE_YN = 'Y') Z1
                              WHERE A.VALID_GRADE_CD = Z1.CMM_CD
                           ) AS VALID_GRADE_NM
                         , A.INVALID_CAU_CD           --무효원인코드
                         , ( SELECT Z1.CMM_CD_NM FROM (SELECT A.CMM_CD, NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM FROM CM_0303T A LEFT OUTER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                                AND B.LANG_CD = #{sLangCd}
                              WHERE A.CMM_GRP_CD = 'CRM365'
                                AND A.USE_YN = 'Y') Z1
                              WHERE A.INVALID_CAU_CD = Z1.CMM_CD
                           ) AS INVALID_CAU_NM
                         , A.USE_YN                   --사용여부
                         , A.REG_USR_ID               --등록자ID
                         , A.REG_DT                   --등록일자
                         , A.UPDT_USR_ID              --수정자ID
                         , A.UPDT_DT                  --수정일자
                         ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID ) AS MNG_SC_NM
                      FROM SA_0254T A    --보험고객추적
                     WHERE A.DLR_CD = #{sDlrCd}
                       AND A.INC_NO = #{sIncNo}
                     <if test='sSeq != null and sSeq != ""'>
                       AND A.SEQ = #{sSeq}
                     </if>
                 ORDER BY
                 <choose>
                     <when test='sort != null'>
                         <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                             <choose>
                                 <when test='item.field == "dlrCd"'>            A.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                 <when test='item.field == "incNo"'>            A.INC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                 <when test='item.field == "seq"'>              A.SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                 <when test='item.field == "traceCont"'>        A.TRACE_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                 <when test='item.field == "traceGradeCd"'>     A.TRACE_GRADE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                 <when test='item.field == "traceDt"'>          A.TRACE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                 <when test='item.field == "traceMthCd"'>       A.TRACE_MTH_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                 <when test='item.field == "nextTraceDt"'>      A.NEXT_TRACE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                 <when test='item.field == "nextTraceMthCd"'>   A.NEXT_TRACE_MTH_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                 <when test='item.field == "validGradeCd"'>     A.VALID_GRADE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                 <when test='item.field == "invalidCauCd"'>     A.INVALID_CAU_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                 <when test='item.field == "useYn"'>            A.USE_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                 <otherwise>
                                   A.DLR_CD ASC, A.INC_NO ASC, A.SEQ DESC
                                 </otherwise>
                             </choose>
                         </foreach>
                     </when>
                     <otherwise>
                       A.DLR_CD ASC, A.INC_NO ASC, A.SEQ DESC
                     </otherwise>
                 </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 보험추적을 저장한다. -->
    <insert id="insertIncProcess" parameterType="IncProcessVO">
        INSERT
          INTO SA_0254T    --보험고객추적
        (
          DLR_CD                   --딜러코드
         ,INC_NO                   --보험번호
         ,SEQ                      --일련번호
         ,TRACE_CONT               --추적내용
         ,TRACE_GRADE_CD           --추적등급코드
         ,TRACE_DT                 --추적일자
         ,TRACE_MTH_CD             --추적방법코드
         ,NEXT_TRACE_DT            --다음추적일자
         ,NEXT_TRACE_MTH_CD        --다음추적방법코드
         ,VALID_GRADE_CD           --유효등급코드
         ,INVALID_CAU_CD           --무효원인코드
         ,USE_YN                   --사용여부
         ,REG_USR_ID               --등록자ID
         ,REG_DT                   --등록일자
         ,UPDT_USR_ID              --수정자ID
         ,UPDT_DT                  --수정일자
        )
        VALUES
        (
          #{dlrCd}                   --딜러코드
         ,#{incNo}                   --보험번호
         ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0254T WHERE DLR_CD = #{dlrCd} AND INC_NO = #{incNo})
         ,#{traceCont}               --추적내용
         ,#{traceGradeCd}            --추적등급코드
         ,#{traceDt}                 --추적일자
         ,#{traceMthCd}              --추적방법코드
         ,#{nextTraceDt}             --다음추적일자
         ,#{nextTraceMthCd}          --다음추적방법코드
         ,#{validGradeCd}            --유효등급코드
         ,#{invalidCauCd}            --무효원인코드
         ,#{useYn}                   --사용여부
         ,#{regUsrId}                --등록자ID
         ,SYSDATE
         ,#{updtUsrId}               --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 보험추적을 수정한다. -->
    <update id="updateIncProcess" parameterType="IncProcessVO">
        UPDATE SA_0254T    --보험고객추적
           SET TRACE_CONT        = #{traceCont}               --추적내용
             , TRACE_GRADE_CD    = #{traceGradeCd}            --추적등급코드
             , TRACE_DT          = #{traceDt}                 --추적일자
             , TRACE_MTH_CD      = #{traceMthCd}              --추적방법코드
             , NEXT_TRACE_DT     = #{nextTraceDt}             --다음추적일자
             , NEXT_TRACE_MTH_CD = #{nextTraceMthCd}          --다음추적방법코드
             , VALID_GRADE_CD    = #{validGradeCd}            --유효등급코드
             , INVALID_CAU_CD    = #{invalidCauCd}            --무효원인코드
             , USE_YN            = #{useYn}                   --사용여부
             , UPDT_USR_ID       = #{updtUsrId}               --수정자ID
             , UPDT_DT           = SYSDATE
          WHERE DLR_CD            = #{dlrCd}                   --딜러코드
            AND INC_NO            = #{incNo}                   --보험번호
            AND SEQ               = #{seq}                     --일련번호
    </update>

    <!-- 보험추적을 삭제한다.(소매계약 확정시 호출) -->
    <delete id="deleteIncProcess" parameterType="IncJoinInfoVO">
        DELETE sa_0254T
         WHERE DLR_CD = #{dlrCd}
           AND INC_NO = #{incNo}
    </delete>



</mapper>