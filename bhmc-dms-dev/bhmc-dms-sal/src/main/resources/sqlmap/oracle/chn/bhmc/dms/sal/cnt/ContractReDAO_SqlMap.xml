<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO">

	<!-- 조회 목록  -->
	<select id="selectContractResByCondition" parameterType="ContractReSearchVO" resultType="ContractReVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                 , FN_GET_CARLINE_NM(T1.CARLINE_CD) AS CARLINE_NM
                 , FN_GET_MODEL_NM(T1.MODEL_CD) AS MODEL_NM
                 , FN_GET_OCN_NM(T1.MODEL_CD, T1.OCN_CD) AS OCN_NM
                 , FN_GET_EXT_COLOR_NM(T1.EXT_COLOR_CD) AS EXT_COLOR_NM
                 , FN_GET_INT_COLOR_NM(T1.INT_COLOR_CD) AS INT_COLOR_NM
                 , T1.*
              FROM (
                  SELECT A.DLR_CD                    --딜러코드
                       , A.CONTRACT_NO               --계약번호
                       , A.CONTRACT_TP               --계약유형
                       , A.CONTRACT_STAT_CD          --계약상태코드
                       , A.CONTRACT_DT               --계약일자
                       , A.SALE_EMP_NO               --판매사원번호
                       , A.CONTRACT_CUST_NO          --계약고객번호
                       , A.REAL_DRIVER_CUST_NO       --실제운전자고객번호
                       , A.REAL_DRIVER_SAME_YN       --실제운전자동일여부
                       , A.SALES_MNG_NO              --영업관리번호
                       , A.GRP_CONTRACT_NO           --그룹계약번호
                       , A.PAY_TP                    --지불유형
                       , A.CARLINE_CD                --차종코드
                       , A.MODEL_CD                  --모델코드
                       , A.OCN_CD                    --OCN코드
                       , A.EXT_COLOR_CD              --외장색상코드
                       , A.INT_COLOR_CD              --내장색상코드
                       , A.VIN_NO                     --차대번호
                       , A.CAR_RETL_AMT               --지도가

                       , A.CONS_TP                    --탁송유형
                       , A.WHSL_AMT                   --도매금액
                       , A.RETL_AMT                   --소매금액
                       , A.PROMOTION_AMT              --프로모션금액
                       , A.CORP_PROMOTION_AMT         --법인프로모션금액
                       , A.DLR_PROMOTION_AMT          --딜러프로모션금액
                       , A.SBST_AMT                   --치환금액
                       , A.GOODS_AMT                  --용품금액
                       , A.CONS_AMT                   --탁송금액
                       , A.INC_AMT                    --보험금액
                       , A.AAP_AMT                    --대행금액
                       , A.VAT_AMT                    --부가가치세금액
                       , A.REAL_CAR_AMT               --실제차량금액
                       , A.ETC_SUM_AMT                --기타합계금액
                       , A.REAL_PAY_AMT               --실제지불금액
                       , A.CONTRACT_PDPST_NM          --계약입금자명
                       , A.CONTRACT_RCPT_NO           --계약영수증번호
                       , A.CONTRACT_RCPT_AMT          --계약영수증금액
                       , A.CONTRACT_RCPT_ID           --계약영수증ID
                       , A.CONTRACT_RCPT_DT           --계약영수증일자
                       , A.REG_TP                     --등록유형
                       , A.REG_AMT                    --등록금액
                       , A.REG_FEE_AMT                --등록수수료금액
                       , A.INC_AAP_TP                 --보험대행유형
                       , A.INC_FEE_AMT                --보험수수료금액
                       , A.FINC_REQ_YN                --금융요청여부
                       , A.FINC_FEE_AMT               --금융수수료금액
                       , A.UATC_CAR_PURC_YN           --중고차량구매여부
                       , A.DL_REQ_DT                  --인도요청일자
                       , A.REAL_DL_DT                 --실제인도일자
                       , A.DSTB_CHN_CD                --유통채널코드
                       , A.RETL_TP                    --소매유형
                       , A.CANC_DT                    --취소일자
                       , A.CANC_REASON_CD             --취소사유코드
                       , A.FILE_DOC_ID                --파일문서ID
                       , A.REMARK                     --비고
                       , A.REMARK1                    --비고1
                       , A.LV2_DLR_YN                 --2급딜러여부
                       , A.LV2_DLR_ORG_CD             --2급딜러조직코드
                       , H.LV2_DLR_NM       AS LV2_DLR_ORG_NM

                       , A.SALE_OPPT_NO               --판매기회일련번호
                       , A.INTRO_DLR_CD               --소개딜러코드
                       , A.GOODS_CONTRACT_NO          --용품계약번호
                       , A.REG_USR_ID                 --등록자ID
                       , A.REG_DT                     --등록일자
                       , A.UPDT_USR_ID                --수정자ID
                       , A.UPDT_DT                    --수정일자
                       , A.DC_LVL_CD                  --할인레벨코드
                       , A.DC_APPROVE_YN              --할인승인여부
                       , A.DC_APPROVE_DT              --할인승인일자

                       , (SELECT CUST_CD
                            FROM CR_0101T
                           WHERE DLR_CD = B1.DLR_CD
                             AND CUST_NO = B1.CUST_CD
                          ) AS CUST_CCD               -- 고객상태코드
                       , B1.CUST_CD                   -- 고객코드
                       , B1.CUST_TP                   -- 고객유형
                       , B1.CUST_NM                   -- 고객명
                       , B1.TEL_NO1                   -- 전화번호1
                       , B1.TEL_NO2                   -- 전화번호2
                       , B1.EMAIL_NM                  -- 이메일명
                       , B1.SSN_CRN_NO                -- 신분증번호
                       , B1.SSN_CRN_TP
                       , B1.ZIP_CD                    -- 우편번호
                       , B1.SUNG_CD
                       , B1.CITY_CD
                       , B1.DIST_CD
                       , B1.SUNG_NM
                       , B1.CITY_NM
                       , B1.DIST_NM
                       , B1.ADDR_NM
                       , B1.ADDR_DETL_CONT

                       , B2.CUST_CD            as DRV_CUST_CD
                       , B2.CUST_TP            as DRV_CUST_TP
                       , B2.CUST_NM            as DRV_CUST_NM
                       , B2.TEL_NO1            as DRV_TEL_NO1
                       , B2.TEL_NO2            as DRV_TEL_NO2
                       , B2.EMAIL_NM           as DRV_EMAIL_NM
                       , B2.SSN_CRN_NO         as DRV_SSN_CRN_NO
                       , B2.SSN_CRN_TP         as DRV_SSN_CRN_TP
                       , B2.ZIP_CD             as DRV_ZIP_CD
                       , B2.SUNG_CD            as DRV_SUNG_CD
                       , B2.CITY_CD            as DRV_CITY_CD
                       , B2.DIST_CD            as DRV_DIST_CD
                       , B2.SUNG_NM            AS DRV_SUNG_NM
                       , B2.CITY_NM            AS DRV_CITY_NM
                       , B2.DIST_NM            AS DRV_DIST_NM
                       , B2.ADDR_NM            AS DRV_ADDR_NM
                       , B2.ADDR_DETL_CONT     AS DRV_ADDR_DETL_CONT

                       , C.VIN_NO              AS USR_VIN_NO
                       , C.SBST_AMT            AS USR_SBST_AMT
                       , C.PURC_NO
                       , (SELECT DECODE(NVL(MAX(Z.PURC_NO), 'N'), 'N', 'N', 'Y')
                            FROM SA_0241T Z
                           WHERE Z.DLR_CD = C.DLR_CD
                             AND Z.VIN_NO = C.VIN_NO
                             AND ROWNUM = '1'
                          )                    AS USR_VIN_NO_SR_YN

                       , D.ZIP_CD              AS CONS_ZIP_CD
                       , D.SUNG_CD             AS CONS_SUNG_CD
                       , D.CITY_CD             AS CONS_CITY_CD
                       , D.DIST_CD             AS CONS_DIST_CD
                       , D.SUNG_NM             AS CONS_SUNG_NM
                       , D.CITY_NM             AS CONS_CITY_NM
                       , D.DIST_NM             AS CONS_DIST_NM
                       , D.ADDR_NM             AS CONS_ADDR_NM
                       , D.ADDR_DETL_CONT      AS CONS_ADDR_DETL_CONT
                       , D.CONS_AMT            AS CONS_CONS_AMT
                       , D.TEL_NO              AS CONS_TEL_NO

                       , E.REG_PRE_AMT
                       , E.REAL_REG_AMT
                       , E.REG_FEE_AMT         AS REAL_REG_FEE_AMT
                       , E.REG_DIST_CD
                       , E.REG_EXPC_DT
                       , E.PURC_TAX_PRE_AMT
                       , E.REAL_PURC_TAX_AMT

                       , F.INC_CMP_CD
                       , F.INC_PROFIT_NM
                       , F.INC_JOIN_DT
                       , F.INC_EXPC_AMT
                       , F.REAL_INC_AMT
                       , F.INC_FEE_AMT          AS REAL_INC_FEE_AMT
                       , F.REMARK               AS INC_REMARK
                       , F.IMPLY_YN
                       , F.FIN_IMPLY_YN
                       , F.INC_CUST_NM
                       , F.INC_CUST_TEL_NO
                       , F.INC_PCON_CUST_NM
                       , F.INC_PCON_CUST_TEL_NO
                       , F.FRC_INC_AMT
                       , F.BUS_INC_AMT

                       , G.FINC_CMP_CD
                       , G.FINC_ITEM_CD
                       , G.FINC_REQ_DT
                       , G.FINC_REQ_AMT
                       , G.FINC_END_DT
                       , G.FINC_FEE_AMT         AS REAL_FINC_FEE_AMT
                       , G.FINC_RPAY_PRID
                       , G.FINC_LOAD_RATE

                       , G.INST_INTR_RATE
                       , G.GRTE_INC_AMT
                       , G.FINC_BURD_AMT
                  FROM SA_0201T A                     /* 계약헤더 */
                  LEFT OUTER JOIN SA_0202T B1               /* 계약고객 */
                    ON A.DLR_CD = B1.DLR_CD
                   and A.CONTRACT_NO = B1.CONTRACT_NO
                   and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
                  LEFT OUTER JOIN SA_0202T B2               /* 실운전자 */
                    ON A.DLR_CD = B2.DLR_CD
                   and A.CONTRACT_NO = B2.CONTRACT_NO
                   and B2.PARTNER_TP = 'D'   -- 실운전자 : SAL028
                  LEFT OUTER JOIN SA_0205T C          /* 중고차 */
                    ON A.DLR_CD = C.DLR_CD
                   AND A.CONTRACT_NO = C.CONTRACT_NO
                  LEFT OUTER JOIN SA_0217T D          /* 탁송 */
                    ON A.DLR_CD = D.DLR_CD
                   AND A.CONTRACT_NO = D.CONTRACT_NO
                  LEFT OUTER JOIN SA_0220T E         /* 번호판 */
                    ON A.DLR_CD = E.DLR_CD
                   AND A.CONTRACT_NO = E.CONTRACT_NO
                  LEFT OUTER JOIN SA_0221T F          /* 보험 헤더 */
                    ON A.DLR_CD = F.DLR_CD
                   AND A.CONTRACT_NO = F.CONTRACT_NO
                  LEFT OUTER JOIN SA_0223T G          /* 금융 */
                    ON A.DLR_CD = G.DLR_CD
                   AND A.CONTRACT_NO = G.CONTRACT_NO
                  LEFT OUTER JOIN SA_0132T H           /* 2급딜러 */
                    ON A.LV2_DLR_ORG_CD = H.LV2_DLR_CD
                  WHERE 1 = 1
                  <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
                  </if>
                  <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
                    AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
                  </if>
                  <if test='sContractCustNo != null and sContractCustNo != ""'>
                    AND ( B1.CUST_CD = #{sContractCustNo} OR B2.CUST_CD = #{sContractCustNo} )   -- 고객코드
                  </if>
                  <if test='sContractCustNm != null and sContractCustNm != ""'>
                    AND ( B1.CUST_NM LIKE '%'||#{sContractCustNm}||'%' OR B2.CUST_NM LIKE '%'||#{sContractCustNm}||'%' )   -- 고객명
                  </if>
                  <if test='sContractTp != null and sContractTp != ""'>
                    AND A.CONTRACT_TP = #{sContractTp}        -- 계약유형
                  </if>
                  <if test='sContractNo != null and sContractNo != ""'>
                  <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
                      <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                        AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
                    </when>
                    <otherwise>
                        AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
                    </otherwise>
                  </choose>
                  </if>
                  <if test='sContractStatCd != null and sContractStatCd != ""'>
                    AND A.CONTRACT_STAT_CD = #{sContractStatCd}      -- 계약상태
                  </if>

                  <if test='sStartContractDt != null'>
                    AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ >= ]]> TRUNC(#{sStartContractDt},'DD')
                  </if>
                  <if test='sEndContractDt != null'>
                    AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ < ]]> TRUNC(#{sEndContractDt},'DD')+1
                  </if>

                  <if test='sCarlineCd != null and sCarlineCd != ""'>
                    AND A.CARLINE_CD = #{sCarlineCd}      -- 차종코드
                  </if>
                  <if test='sModelCd != null and sModelCd != ""'>
                    AND A.MODEL_CD = #{sModelCd}          -- 모델코드
                  </if>
                  <if test='sOcnCd != null and sOcnCd != ""'>
                    AND A.OCN_CD = #{sOcnCd}              -- OCN
                  </if>
                  <if test='sSaleOpptNo != null and sSaleOpptNo != ""'>
                    AND A.SALE_OPPT_NO = #{sSaleOpptNo}     -- 판매기회
                  </if>

                  ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "contractNo"'>A.CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grpContractNo"'>A.GRP_CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractDt"'>A.CONTRACT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractStatCd"'>A.CONTRACT_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractCustNo"'>B1.CUST_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custNm"'>B1.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "telNo1"'>B1.TEL_NO1 <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "saleEmpNo"'>A.SALE_EMP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineNm"'>A.CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelNm"'>A.MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnNm"'>A.OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "extColorNm"'>A.EXT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "intColorNm"'>A.INT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "realPayAmt"'>A.REAL_PAY_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dcLvlCd"'>A.DC_LVL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>

	<!-- 목록 갯수  -->
	<select id="selectContractResByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
		SELECT COUNT(*)
          FROM SA_0201T A    --계약헤더
          LEFT OUTER JOIN SA_0202T B1               /* 계약고객 */
            ON A.DLR_CD = B1.DLR_CD
           and A.CONTRACT_NO = B1.CONTRACT_NO
           and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
          LEFT OUTER JOIN SA_0202T B2               /* 실운전자 */
            ON A.DLR_CD = B2.DLR_CD
           and A.CONTRACT_NO = B2.CONTRACT_NO
           and B2.PARTNER_TP = 'D'   -- 실운전자 : SAL028
          LEFT OUTER JOIN SA_0205T C          /* 중고차 */
            ON A.DLR_CD = C.DLR_CD
           AND A.CONTRACT_NO = C.CONTRACT_NO
          LEFT OUTER JOIN SA_0217T D          /* 탁송 */
            ON A.DLR_CD = D.DLR_CD
           AND A.CONTRACT_NO = D.CONTRACT_NO
          LEFT OUTER JOIN SA_0220T E         /* 번호판 */
            ON A.DLR_CD = E.DLR_CD
           AND A.CONTRACT_NO = E.CONTRACT_NO
          LEFT OUTER JOIN SA_0221T F          /* 보험 헤더 */
            ON A.DLR_CD = F.DLR_CD
           AND A.CONTRACT_NO = F.CONTRACT_NO
          LEFT OUTER JOIN SA_0223T G          /* 금융 */
            ON A.DLR_CD = G.DLR_CD
           AND A.CONTRACT_NO = G.CONTRACT_NO
          LEFT OUTER JOIN SA_0132T H           /* 2급딜러 */
            ON A.LV2_DLR_ORG_CD = H.LV2_DLR_CD
          WHERE 1 = 1
          <if test='sDlrCd != null and sDlrCd != ""'>
            AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
          </if>
          <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
            AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
          </if>
          <if test='sContractCustNo != null and sContractCustNo != ""'>
            AND ( B1.CUST_CD = #{sContractCustNo} OR B2.CUST_CD = #{sContractCustNo} )   -- 고객코드
          </if>
          <if test='sContractTp != null and sContractTp != ""'>
            AND A.CONTRACT_TP = #{sContractTp}        -- 계약유형
          </if>
          <if test='sContractNo != null and sContractNo != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
              <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
            </when>
            <otherwise>
                AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
            </otherwise>
          </choose>
          </if>
          <if test='sContractStatCd != null and sContractStatCd != ""'>
            AND A.CONTRACT_STAT_CD = #{sContractStatCd}      -- 계약상태
          </if>
          <if test='sStartContractDt != null'>
            AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ >= ]]> TRUNC(#{sStartContractDt},'DD')
          </if>
          <if test='sEndContractDt != null'>
            AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ < ]]> TRUNC(#{sEndContractDt},'DD')+1
          </if>
          <if test='sCarlineCd != null and sCarlineCd != ""'>
            AND A.CARLINE_CD = #{sCarlineCd}      -- 차종코드
          </if>
          <if test='sModelCd != null and sModelCd != ""'>
            AND A.MODEL_CD = #{sModelCd}          -- 모델코드
          </if>
          <if test='sOcnCd != null and sOcnCd != ""'>
            AND A.OCN_CD = #{sOcnCd}              -- OCN
          </if>
	</select>

    <!-- 계약 헤더에 저장한다.  -->
    <insert id="insertContract" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.insertContract] */
        INSERT INTO SA_0201T    --계약헤더
        (
              DLR_CD                     --딜러코드
             ,CONTRACT_NO                --계약번호
             ,CONTRACT_TP                --계약유형
             ,CONTRACT_STAT_CD           --계약상태코드
             ,CONTRACT_DT                --계약일자
             ,SALE_EMP_NO                --판매사원번호
             ,CONTRACT_CUST_NO           --계약고객번호
             ,REAL_DRIVER_CUST_NO        --실제운전자고객번호
             ,REAL_DRIVER_SAME_YN        --실제운전자동일여부
             ,SALES_MNG_NO               --영업관리번호
             ,PAY_TP                     --지불유형
             ,CARLINE_CD                 --차종코드
             ,MODEL_CD                   --모델코드
             ,OCN_CD                     --OCN코드
             ,EXT_COLOR_CD               --외장색상코드
             ,INT_COLOR_CD               --내장색상코드
             ,CONS_TP                    --탁송유형
             ,WHSL_AMT                   --도매금액
             ,RETL_AMT                   --소매금액
             ,PROMOTION_AMT              --프로모션금액
             ,CORP_PROMOTION_AMT         --법인프로모션금액
             ,DLR_PROMOTION_AMT          --딜러프로모션금액
             ,SBST_AMT                   --치환금액
             ,GOODS_AMT                  --용품금액
             ,CONS_AMT                   --탁송금액
             ,INC_AMT                    --보험금액
             ,AAP_AMT                    --대행금액
             ,VAT_AMT                    --부가가치세금액
             ,REAL_CAR_AMT               --실제차량금액
             ,ETC_SUM_AMT                --기타합계금액
             ,REAL_PAY_AMT               --실제지불금액
             ,CONTRACT_PDPST_NM          --계약입금자명
             ,CONTRACT_RCPT_NO           --계약영수증번호
             ,CONTRACT_RCPT_AMT          --계약영수증금액
             ,CONTRACT_RCPT_ID           --계약영수증ID
             ,CONTRACT_RCPT_DT           --계약영수증일자
             ,REG_TP                     --등록유형
             ,REG_AMT                    --등록금액
             ,REG_FEE_AMT                --등록수수료금액
             ,INC_AAP_TP                 --보험대행유형
             ,INC_FEE_AMT                --보험수수료금액
             ,FINC_REQ_YN                --금융요청여부
             ,FINC_FEE_AMT               --금융수수료금액
             ,UATC_CAR_PURC_YN           --중고차량구매여부
             ,DL_REQ_DT                  --인도요청일자
             ,REAL_DL_DT                 --실제인도일자
             ,DSTB_CHN_CD                --유통채널코드
             ,RETL_TP                    --소매유형
             ,CANC_DT                    --취소일자
             ,CANC_REASON_CD             --취소사유코드
             ,FILE_DOC_ID                --파일문서ID
             ,REMARK                     --비고
             ,REMARK1                    --비고1
             ,SALE_OPPT_NO              --판매기회일련번호
             ,INTRO_DLR_CD               --소개딜러코드
             ,GOODS_CONTRACT_NO          --용품계약번호
             ,GRP_CONTRACT_NO            --그룹계약번호
             ,REG_USR_ID                 --등록자ID
             ,REG_DT                     --등록일자
             ,UPDT_USR_ID                --수정자ID
             ,UPDT_DT                    --수정일자
             ,DC_LVL_CD                  --할인레벨코드
             ,DC_APPROVE_YN              --할인승인여부
             <if test='dcLvlCd != null and dcLvlCd != ""'>
             ,DC_APPROVE_DT              --할인승인일자
             </if>
             ,VIN_NO                     --차대번호
             ,CAR_RETL_AMT               --차량소매금액
        )
        VALUES
        (
              #{dlrCd}                     --딜러코드
             ,#{contractNo}                --계약번호
             ,#{contractTp}                --계약유형
             ,#{contractStatCd}            --계약상태코드
             ,#{contractDt}                --계약일자
             ,#{saleEmpNo}                 --판매사원번호
             ,#{contractCustNo}            --계약고객번호
             ,#{realDriverCustNo}          --실제운전자고객번호
             ,#{realDriverSameYn}          --실제운전자동일여부
             ,#{salesMngNo}                --영업관리번호
             ,#{payTp}                     --지불유형
             ,#{carlineCd}                 --차종코드
             ,#{modelCd}                   --모델코드
             ,#{ocnCd}                     --OCN코드
             ,#{extColorCd}                --외장색상코드
             ,#{intColorCd}                --내장색상코드
             ,#{consTp}                    --탁송유형
             ,#{whslAmt}                   --도매금액
             ,#{retlAmt}                   --소매금액
             ,#{promotionAmt}              --프로모션금액
             ,#{corpPromotionAmt}          --법인프로모션금액
             ,#{dlrPromotionAmt}           --딜러프로모션금액
             ,#{sbstAmt}                   --치환금액
             ,#{goodsAmt}                  --용품금액
             ,#{consAmt}                   --탁송금액
             ,#{incAmt}                    --보험금액
             ,#{aapAmt}                    --대행금액
             ,#{vatAmt}                    --부가가치세금액
             ,#{realCarAmt}                --실제차량금액
             ,#{etcSumAmt}                 --기타합계금액
             ,#{realPayAmt}                --실제지불금액
             ,#{contractPdpstNm}           --계약입금자명
             ,#{contractRcptNo}            --계약영수증번호
             ,#{contractRcptAmt}           --계약영수증금액
             ,#{contractRcptId}            --계약영수증ID
             ,#{contractRcptDt}            --계약영수증일자
             ,#{regTp}                     --등록유형
             ,#{realRegAmt}                --등록금액
             ,#{regFeeAmt}                 --등록수수료금액
             ,#{incAapTp}                  --보험대행유형
             ,#{incFeeAmt}                 --보험수수료금액
             ,#{fincReqYn}                 --금융요청여부
             ,#{fincFeeAmt}                --금융수수료금액
             ,#{uatcCarPurcYn}             --중고차량구매여부
             ,#{dlReqDt}                   --인도요청일자
             ,''                           --실제인도일자
             ,#{dstbChnCd}                 --유통채널코드
             ,#{retlTp}                    --소매유형
             ,''                           --취소일자
             ,#{cancReasonCd}              --취소사유코드
             ,#{fileDocId}                 --파일문서ID
             ,#{remark}                    --비고
             ,#{remark1}                   --비고1
             ,#{saleOpptNo}               --판매기회일련번호
             ,''                           --소개딜러코드
             ,#{goodsContractNo}           --용품계약번호
             ,#{grpContractNo}             --그룹계약번호
             ,#{regUsrId}                  --등록자ID
             ,SYSDATE
             ,#{updtUsrId}                 --수정자ID
             ,SYSDATE
             ,#{dcLvlCd}                   --할인레벨코드
             ,#{dcApproveYn}               --할인승인여부
           <if test='dcLvlCd != null and dcLvlCd != ""'>
             ,SYSDATE
           </if>
             ,#{vinNo}                     --차대번호
             ,#{carRetlAmt}                --차량소매금액
      )
    </insert>

    <!-- SA_0202 : 실운전자 저장 -->
    <insert id="insertContractCustomer" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.insertContractCustomer] */
       INSERT INTO SA_0202T    --계약고객상세
        (
          DLR_CD                --딜러코드
         ,CONTRACT_NO           --계약번호
         ,PARTNER_TP            --파트너유형
         ,CUST_CD               --고객코드
         ,CUST_TP               --고객유형
         ,CUST_NM               --고객명
         ,TEL_NO1               --전화번호1
         ,TEL_NO2               --전화번호2
         ,EMAIL_NM              --이메일명
         ,SSN_CRN_NO            --신분증번호
         ,ZIP_CD                --우편번호
         ,REG_USR_ID            --등록자ID
         ,REG_DT                --등록일자
         ,UPDT_USR_ID           --수정자ID
         ,UPDT_DT               --수정일자
         ,SSN_CRN_TP            --신분증유형
         ,SUNG_CD               --성코드
         ,CITY_CD               --도시코드
         ,DIST_CD               --지역코드
         ,SUNG_NM               --성명
         ,CITY_NM               --도시명
         ,DIST_NM               --지역명
         ,ADDR_NM               --주소명
         ,ADDR_DETL_CONT        --주소상세내용
        )
        VALUES
        (
          #{dlrCd}                --딜러코드
         ,#{contractNo}           --계약번호
         ,#{partnerTp}            --파트너유형
         ,#{custCd}               --고객코드
         ,#{custTp}               --고객유형
         ,#{custNm}               --고객명
         ,#{telNo1}               --전화번호1
         ,#{telNo2}               --전화번호2
         ,#{emailNm}              --이메일명
         ,#{ssnCrnNo}             --신분증번호
         ,#{zipCd}                --우편번호
         ,#{regUsrId}             --등록자ID
         ,SYSDATE
         ,#{updtUsrId}            --수정자ID
         ,SYSDATE
         ,#{ssnCrnTp}             --신분증유형
         ,#{sungCd}               --성코드
         ,#{cityCd}               --도시코드
         ,#{distCd}               --지역코드
         ,#{sungNm}               --성명
         ,#{cityNm}               --도시명
         ,#{distNm}               --지역명
         ,#{addrNm}               --주소명
         ,#{addrDetlCont}         --주소상세내용
        )
    </insert>

    <!-- 계약고객 유효성 체크 -->
    <select id="selectContractCustomersChkByConditionCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectContractCustomersByConditionCnt] */
        SELECT COUNT(*)
          FROM SA_0202T
          WHERE DLR_CD         = #{dlrCd}                --딜러코드
            AND CONTRACT_NO    = #{contractNo}           --계약번호
            AND PARTNER_TP     = #{partnerTp}            --파트너유형
    </select>

    <!-- SA_0205 : 중고차 저장 -->
    <insert id="insertUsedCar" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.insertUsedCar] */
        INSERT
          INTO SA_0205T    --계약중고차
        (
              DLR_CD             --딜러코드
             ,CONTRACT_NO        --계약번호
             ,VIN_NO             --차대번호
             ,SBST_AMT           --치환금액
             ,PURC_NO            --매입번호
             ,REG_USR_ID         --등록자ID
             ,REG_DT             --등록일자
             ,UPDT_USR_ID        --수정자ID
             ,UPDT_DT            --수정일자
        )VALUES(
              #{dlrCd}             --딜러코드
             ,#{contractNo}        --계약번호
             ,#{usrVinNo}          --차대번호
             ,#{usrSbstAmt}        --치환금액
             ,#{purcNo}            --매입번호
             ,#{regUsrId}          --등록자ID
             ,SYSDATE
             ,#{updtUsrId}         --수정자ID
             ,SYSDATE
        )
    </insert>

    <!-- SA_0217T : 탁송 저장 -->
    <insert id="insertCons" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.insertCons] */
        INSERT
          INTO SA_0217T    --계약탁송정보
        (
              DLR_CD                --딜러코드
             ,CONTRACT_NO           --계약번호
             ,ZIP_CD                --우편번호
             ,SUNG_CD               --성코드
             ,CITY_CD               --도시코드
             ,DIST_CD               --지역코드
             ,SUNG_NM               --성명
             ,CITY_NM               --도시명
             ,DIST_NM               --지역명
             ,ADDR_NM               --주소명
             ,ADDR_DETL_CONT        --주소상세내용
             ,CONS_AMT              --탁송금액
             ,TEL_NO                --전화번호
             ,REG_USR_ID            --등록자ID
             ,REG_DT                --등록일자
             ,UPDT_USR_ID           --수정자ID
             ,UPDT_DT               --수정일자
        )VALUES(
              #{dlrCd}                --딜러코드
             ,#{contractNo}           --계약번호
             ,#{consZipCd}            --우편번호
             ,#{consSungCd}           --성코드
             ,#{consCityCd}           --도시코드
             ,#{consDistCd}           --지역코드
             ,#{consSungNm}           --성명
             ,#{consCityNm}           --도시명
             ,#{consDistNm}           --지역명
             ,#{consAddrNm}           --주소명
             ,#{consAddrDetlCont}     --주소상세내용
             ,#{consConsAmt}          --탁송금액
             ,#{consTelNo}            --전화번호
             ,#{regUsrId}             --등록자ID
             ,SYSDATE
             ,#{updtUsrId}            --수정자ID
             ,SYSDATE
        )
    </insert>


    <!-- 계약 헤더에 수정한다.  -->
    <update id="updateContract" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateContract] */
        UPDATE SA_0201T    --계약헤더
           SET CONTRACT_TP         = #{contractTp}                --계약유형
             , CONTRACT_STAT_CD    = #{contractStatCd}            --계약상태코드
             , CONTRACT_DT         = #{contractDt}                --계약일자
             , SALE_EMP_NO         = #{saleEmpNo}                 --판매사원번호
             , CONTRACT_CUST_NO    = #{contractCustNo}            --계약고객번호
             , REAL_DRIVER_CUST_NO = #{realDriverCustNo}          --실제운전자고객번호
             , REAL_DRIVER_SAME_YN = #{realDriverSameYn}          --실제운전자동일여부
             , SALES_MNG_NO        = #{salesMngNo}                --영업관리번호
             , PAY_TP              = #{payTp}                     --지불유형
             , CARLINE_CD          = #{carlineCd}                 --차종코드
             , MODEL_CD            = #{modelCd}                   --모델코드
             , OCN_CD              = #{ocnCd}                     --OCN코드
             , EXT_COLOR_CD        = #{extColorCd}                --외장색상코드
             , INT_COLOR_CD        = #{intColorCd}                --내장색상코드
             , CONS_TP             = #{consTp}                    --탁송유형
             , WHSL_AMT            = #{whslAmt}                   --도매금액
             , RETL_AMT            = #{retlAmt}                   --소매금액
             , PROMOTION_AMT       = #{promotionAmt}              --프로모션금액
             , CORP_PROMOTION_AMT  = #{corpPromotionAmt}          --법인프로모션금액
             , DLR_PROMOTION_AMT   = #{dlrPromotionAmt}           --딜러프로모션금액
             , SBST_AMT            = #{sbstAmt}                   --치환금액
             , GOODS_AMT           = #{goodsAmt}                  --용품금액
             , CONS_AMT            = #{consAmt}                   --탁송금액
             , INC_AMT             = #{incAmt}                    --보험금액
             , AAP_AMT             = #{aapAmt}                    --대행금액
             , VAT_AMT             = #{vatAmt}                    --부가가치세금액
             , REAL_CAR_AMT        = #{realCarAmt}                --실제차량금액
             , ETC_SUM_AMT         = #{etcSumAmt}                 --기타합계금액
             , REAL_PAY_AMT        = #{realPayAmt}                --실제지불금액
             , CONTRACT_PDPST_NM   = #{contractPdpstNm}           --계약입금자명
             , CONTRACT_RCPT_NO    = #{contractRcptNo}            --계약영수증번호
             , CONTRACT_RCPT_AMT   = #{contractRcptAmt}           --계약영수증금액
             , CONTRACT_RCPT_ID    = #{contractRcptId}            --계약영수증ID
             , CONTRACT_RCPT_DT    = #{contractRcptDt}            --계약영수증일자
             , REG_TP              = #{regTp}                     --등록유형
             , REG_AMT             = #{realRegAmt}                    --등록금액
             , REG_FEE_AMT         = #{regFeeAmt}                 --등록수수료금액
             , INC_AAP_TP          = #{incAapTp}                  --보험대행유형
             , INC_FEE_AMT         = #{incFeeAmt}                 --보험수수료금액
             , FINC_REQ_YN         = #{fincReqYn}                 --금융요청여부
             , FINC_FEE_AMT        = #{fincFeeAmt}                --금융수수료금액
             , UATC_CAR_PURC_YN    = #{uatcCarPurcYn}             --중고차량구매여부
             , DL_REQ_DT           = #{dlReqDt}                   --인도요청일자
             , DSTB_CHN_CD         = #{dstbChnCd}                 --유통채널코드
             , RETL_TP             = #{retlTp}                    --소매유형

             , CANC_REASON_CD      = #{cancReasonCd}              --취소사유코드
             , FILE_DOC_ID         = #{fileDocId}                 --파일문서ID
             , REMARK              = #{remark}                    --비고
             , REMARK1             = #{remark1}                   --비고1
             , SALE_OPPT_NO        = #{saleOpptNo}                --판매기회일련번호

             , GOODS_CONTRACT_NO   = ''
             , GRP_CONTRACT_NO     = #{grpContractNo}             --그룹계약번호

             , UPDT_USR_ID         = #{updtUsrId}                 --수정자ID
             , UPDT_DT             = SYSDATE
             , DC_LVL_CD           = #{dcLvlCd}                   --할인레벨코드
             , DC_APPROVE_YN       = #{dcApproveYn}               --할인승인여부
             , VIN_NO              = #{vinNo}                     -- 차대번호
             , CAR_RETL_AMT        = #{carRetlAmt}                -- 차량소매금액
         WHERE 1 = 1
           AND DLR_CD              = #{dlrCd}                     --딜러코드
           AND CONTRACT_NO         = #{contractNo}                --계약번호
    </update>

    <!-- SA_0202 : 실운전자 수정 -->
    <update id="updateContractCustomer" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateContractCustomer] */
        UPDATE SA_0202T    --계약고객상세
           SET CUST_CD        = #{custCd}               --고객코드
             , CUST_TP        = #{custTp}               --고객유형
             , CUST_NM        = #{custNm}               --고객명
             , TEL_NO1        = #{telNo1}               --전화번호1
             , TEL_NO2        = #{telNo2}               --전화번호2
             , EMAIL_NM       = #{emailNm}              --이메일명
             , SSN_CRN_NO     = #{ssnCrnNo}             --신분증번호
             , SSN_CRN_TP     = #{ssnCrnTp}             --신분증유형
             , ZIP_CD         = #{zipCd}                --우편번호
             , SUNG_CD        = #{sungCd}               --성코드
             , CITY_CD        = #{cityCd}               --도시코드
             , DIST_CD        = #{distCd}               --지역코드
             , SUNG_NM        = #{sungNm}               --성명
             , CITY_NM        = #{cityNm}               --도시명
             , DIST_NM        = #{distNm}               --지역명
             , ADDR_NM        = #{addrNm}               --주소명
             , ADDR_DETL_CONT = #{addrDetlCont}         --주소상세내용
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
           AND PARTNER_TP     = #{partnerTp}            --파트너유형
    </update>

    <!-- SA_0205 : 중고차 수정 -->
    <update id="updateUsedCar" parameterType="ContractReVO">
        /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateUsedCar] */
        UPDATE DMSDB.SA_0205T    --계약중고차
           SET VIN_NO      = #{usrVinNo}          --차대번호
             , SBST_AMT    = #{sbstAmt}           --치환금액
             , PURC_NO     = #{purcNo}            --매입번호
             , UPDT_USR_ID = #{updtUsrId}         --수정자ID
             , UPDT_DT     = SYSDATE
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
    </update>

    <!-- SA_0205T : 중고차 저장된 갯수 확인 -->
    <select id="selectUsedCarCnt" parameterType="ContractReVO" resultType="int">
        /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectUsedCarCnt] */
        SELECT COUNT(*)
          FROM SA_0205T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>
    <!-- SA_0205T : 중고차의 내역을 삭제 -->
    <delete id="deleteUsedCar" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteUsedCar] */
        DELETE
          FROM SA_0205T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0217T : 탁송 수정 -->
    <update id="updateCons" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateCons] */
        UPDATE SA_0217T    --계약탁송정보
           SET ZIP_CD         = #{consZipCd}                --우편번호
              ,SUNG_CD        = #{consSungCd}               --성코드
              ,CITY_CD        = #{consCityCd}               --도시코드
              ,DIST_CD        = #{consDistCd}               --지역코드
              ,SUNG_NM        = #{consSungNm}               --성명
              ,CITY_NM        = #{consCityNm}               --도시명
              ,DIST_NM        = #{consDistNm}               --지역명
              ,ADDR_NM        = #{consAddrNm}               --주소명
              ,ADDR_DETL_CONT = #{consAddrDetlCont}         --주소상세내용
              ,CONS_AMT       = #{consConsAmt}              --탁송금액
              ,TEL_NO         = #{consTelNo}                --전화번호
              ,UPDT_USR_ID    = #{updtUsrId}                --수정자ID
              ,UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
    </update>

    <!-- SA_0217T : 탁송 저장된 갯수 확인 -->
    <select id="selectConsCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectConsCnt] */
        SELECT COUNT(*)
          FROM SA_0217T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0217T : 탁송의 내역을 삭제 -->
    <delete id="deleteCons" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteCons] */
        DELETE
          FROM SA_0217T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0220T : 번호판 수정 -->
    <update id="updateReg" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateReg] */
        UPDATE SA_0220T         --계약번호판등록서비스
           SET REG_PRE_AMT       = #{regPreAmt}               --등록선수금액
             , REAL_REG_AMT      = #{realRegAmt}              --실제등록금액
             , REG_FEE_AMT       = #{regFeeAmt}               --등록수수료금액
             <if test='regDistCd != null and regDistCd != ""'>
             , REG_DIST_CD       = #{regDistCd}               --등록지역코드
             </if>
             , REG_EXPC_DT       = #{regExpcDt}               --등록예상일자
             , PURC_TAX_PRE_AMT  = #{purcTaxPreAmt}           --구입세금선수금액
             , REAL_PURC_TAX_AMT = #{realPurcTaxAmt}          --실제구입세금액
             , UPDT_USR_ID       = #{updtUsrId}               --수정자ID
             , UPDT_DT           = SYSDATE
         WHERE 1 = 1
           AND DLR_CD            = #{dlrCd}                   --딜러코드
           AND CONTRACT_NO       = #{contractNo}              --계약번호
    </update>

    <!-- SA_0220T : 번호판 저장된 갯수 확인 -->
    <select id="selectRegCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectRegCnt] */
        SELECT COUNT(*)
          FROM SA_0220T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0220T : 번호판의 내역을 삭제 -->
    <delete id="deleteReg" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteReg] */
        DELETE
          FROM SA_0220T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0221T : 보험헤더 수정 -->
    <update id="updateIncHead" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateIncHead] */
        UPDATE SA_0221T    --계약보험서비스헤더
           SET INC_CMP_CD    = #{incCmpCd}            --보험회사코드
             , INC_PROFIT_NM = #{incProfitNm}         --보험수혜자명
             , INC_JOIN_DT   = #{incJoinDt}           --보험가입일자
             , INC_EXPC_AMT  = #{incExpcAmt}          --보험예상금액
             , REAL_INC_AMT  = #{realIncAmt}          --실보험금액
             , INC_FEE_AMT   = #{incFeeAmt}           --보험수수료금액
             , REMARK        = #{incRemark}           --비고
             , IMPLY_YN      = #{implyYn}             --총금액포함여부
             , FIN_IMPLY_YN  = #{finImplyYn}          --재무수납포함여부
             , INC_CUST_NM   = #{incCustNm}           --피보험인
             , INC_CUST_TEL_NO      = #{incCustTelNo}       --피보험인 전화번호
             , INC_PCON_CUST_NM     = #{incPconCustNm}      --연계인
             , INC_PCON_CUST_TEL_NO = #{incPconCustTelNo}   --연계인 전화번호
             , FRC_INC_AMT   = #{frcIncAmt}           --강제보험금액
             , BUS_INC_AMT   = #{busIncAmt}           --상업보험금액
             , UPDT_USR_ID   = #{updtUsrId}           --수정자ID
             , UPDT_DT       = SYSDATE
         WHERE 1 = 1
           AND DLR_CD        = #{dlrCd}               --딜러코드
           AND CONTRACT_NO   = #{contractNo}          --계약번호
    </update>

    <!-- SA_0221T : 보험헤더 저장된 갯수 확인 -->
    <select id="selectIncHeadCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectIncHeadCnt] */
        SELECT COUNT(*)
          FROM SA_0221T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0221T : 보험헤더의 내역을 삭제 -->
    <delete id="deleteIncHead" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteIncHead] */
        DELETE
          FROM SA_0221T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0222T : 보험 아이템을 삭제한다. -->
    <delete id="deleteIncAll" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteIncAll] */
        DELETE
          FROM SA_0222T    --계약보험서비스아이템
         WHERE DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
    </delete>

    <!-- SA_0223T : 금융 서비스 수정 -->
    <update id="updateFinc" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.updateFinc] */
        UPDATE SA_0223T    --계약금융정보
           SET FINC_CMP_CD    = #{fincCmpCd}            --금융회사코드
             , FINC_ITEM_CD   = #{fincItemCd}           --금융품목코드
             , FINC_REQ_DT    = #{fincReqDt}            --금융요청일자
             , FINC_REQ_AMT   = #{fincReqAmt}           --금융요청금액
             , FINC_END_DT    = #{fincEndDt}            --금융만기일자
             , FINC_FEE_AMT   = #{fincFeeAmt}           --금융수수료금액
             , FINC_RPAY_PRID = #{fincRpayPrid}         --금융상환기간
             , FINC_LOAD_RATE = #{fincLoadRate}         --금융대출비율
             --, FINC_ITEM_KIND_CD = #{fincItemKindCd}    --금융품목종류코드
             , INST_INTR_RATE = #{instIntrRate}         --할부이자율
             , GRTE_INC_AMT   = #{grteIncAmt}           --보증보험금액
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
    </update>

    <!-- SA_0223T : 금융 서비스 저장된 갯수 확인 -->
    <select id="selectFincCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectFincCnt] */
        SELECT COUNT(*)
          FROM SA_0223T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0223T : 금융 서비스의 내역을 삭제 -->
    <delete id="deleteFinc" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.deleteFinc] */
        DELETE
          FROM SA_0223T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>


    <!-- 계약된 프로모션 내역을 조회한다.  -->
    <select id="selectPromotionListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM (
                SELECT SA0113.DLR_CD
                     ,SA0113.PROMOTION_CD
                     ,SA0113.PROMOTION_NM
                     ,SA0113.PROMOTION_TP     /* SAL010 프로모션유형 */
                     ,SA_0115.MODEL_CD
                     ,SA0113.START_DT
                     ,SA0113.END_DT
                     ,SA0113.APPLY_TP        -- 비율(R) , 금액(F)
                     ,SA0113.PROMOTION_AMT
                     ,SA0113.IMS_BUDN_RATE   -- 제조사부담율
                     ,SA0113.DLR_BUDN_RATE   -- 딜러부담율
                     ,SA0113.REG_USR_ID
                     ,SA0113.REG_DT
                     ,SA0113.UPDT_USR_ID
                     ,SA0113.UPDT_DT
                     ,SA0116.CONTRACT_TP    -- N: 일반판매, P:선출고판매, Q:집단판매
                     ,DECODE(SA0203.CONTRACT_NO, NULL, 'N', 'Y') AS CHK_YN
                  FROM SA_0113T SA0113                         /* 프로모션 헤더 */
                  INNER JOIN SA_0115T SA_0115                  /* 프로모션 모델 */
                    ON SA0113.DLR_CD = SA_0115.DLR_CD
                   AND SA0113.PROMOTION_CD = SA_0115.PROMOTION_CD
                  INNER JOIN SA_0116T SA0116                  /* 프로모션 계약유형 */
                    ON SA0113.DLR_CD = SA0116.DLR_CD
                   AND SA0113.PROMOTION_CD = SA0116.PROMOTION_CD
                  LEFT OUTER JOIN (
                                     SELECT A.*
                                       FROM SA_0203T A               /*계약 프로모션*/
                                      WHERE CONTRACT_NO = #{sContractNo}
                                   ) SA0203
                    ON SA0113.DLR_CD = SA0203.DLR_CD
                   AND SA0113.PROMOTION_CD = SA0203.PROMOTION_CD
                 WHERE SA0113.USE_YN = 'Y'
                   AND SA0113.APPROVE_CD = 'C'
                   AND SA0116.CONTRACT_TP = #{sContractTp}
                   AND SA_0115.MODEL_CD = #{sModelCd}
                   AND #{sStartContractDt} BETWEEN SA0113.START_DT AND SA0113.END_DT    -- 계약일
                   AND SA0113.DLR_CD = #{sDlrCd}
                   AND SA0113.PROMOTION_OWN_CD = #{sPromotionOwnCd}      -- 프로모션 주관 01:법인, 02:딜러

                UNION

                SELECT SA0113.DLR_CD
                     ,SA0113.PROMOTION_CD
                     ,SA0113.PROMOTION_NM
                     ,SA0113.PROMOTION_TP     /* SAL010 프로모션유형 */
                     ,SA_0115.MODEL_CD
                     ,SA0113.START_DT
                     ,SA0113.END_DT
                     ,SA0113.APPLY_TP        -- 비율(R) , 금액(F)
                     ,SA0113.PROMOTION_AMT
                     ,SA0113.IMS_BUDN_RATE   -- 제조사부담율
                     ,SA0113.DLR_BUDN_RATE   -- 딜러부담율
                     ,SA0113.REG_USR_ID
                     ,SA0113.REG_DT
                     ,SA0113.UPDT_USR_ID
                     ,SA0113.UPDT_DT
                     ,SA0116.CONTRACT_TP    -- N: 일반판매, P:선출고판매, Q:집단판매
                     ,DECODE(SA0203.CONTRACT_NO, NULL, 'N', 'Y') AS CHK_YN
                  FROM SA_0113T SA0113                         /* 프로모션 헤더 */
                  INNER JOIN SA_0115T SA_0115                  /* 프로모션 모델 */
                    ON SA0113.DLR_CD = SA_0115.DLR_CD
                   AND SA0113.PROMOTION_CD = SA_0115.PROMOTION_CD
                  INNER JOIN SA_0116T SA0116                  /* 프로모션 계약유형 */
                    ON SA0113.DLR_CD = SA0116.DLR_CD
                   AND SA0113.PROMOTION_CD = SA0116.PROMOTION_CD
                  INNER JOIN SA_0114T SA0114
                     ON SA0113.DLR_CD = SA0114.DLR_CD
                    AND SA0113.PROMOTION_CD = SA0114.PROMOTION_CD
                  LEFT OUTER JOIN (
                                     SELECT A.*
                                       FROM SA_0203T A               /*계약 프로모션*/
                                      WHERE CONTRACT_NO = #{sContractNo}
                                   ) SA0203
                    ON SA0113.DLR_CD = SA0203.DLR_CD
                   AND SA0113.PROMOTION_CD = SA0203.PROMOTION_CD
                 WHERE SA0113.USE_YN = 'Y'
                   AND SA0113.APPROVE_CD = 'C'
                   AND SA0116.CONTRACT_TP = #{sContractTp}
                   AND SA_0115.MODEL_CD = #{sModelCd}
                   AND #{sStartContractDt} BETWEEN SA0113.START_DT AND SA0113.END_DT    -- 계약일
                   AND SA0113.DLR_CD = #{sDlrCd}
                   AND SA0114.CUST_CD = #{sContractCustNo}
                   AND SA0113.PROMOTION_OWN_CD = #{sPromotionOwnCd}      -- 프로모션 주관 01:법인, 02:딜러
          )
    </select>
    <select id="selectPromotionListsByCondition" parameterType="ContractReSearchVO" resultType="ContractPromotionVO">
        SELECT SA0113.DLR_CD
             ,SA0113.PROMOTION_CD
             ,SA0113.PROMOTION_NM
             ,SA0113.PROMOTION_TP     /* SAL010 프로모션유형 */
             ,SA_0115.MODEL_CD
             ,SA0113.START_DT
             ,SA0113.END_DT
             ,SA0113.APPLY_TP        -- 비율(R) , 금액(F)
             --,SA0113.PROMOTION_AMT
             , CASE WHEN NVL(SA0203.PROMOTION_AMT, 0) = 0 then SA0113.PROMOTION_AMT
                    ELSE SA0203.PROMOTION_AMT
                END AS PROMOTION_AMT
             ,SA0113.IMS_BUDN_RATE   -- 제조사부담율
             ,SA0113.DLR_BUDN_RATE   -- 딜러부담율
             ,SA0113.REG_USR_ID
             ,SA0113.REG_DT
             ,SA0113.UPDT_USR_ID
             ,SA0113.UPDT_DT
             ,SA0116.CONTRACT_TP    -- N: 일반판매, P:선출고판매, Q:집단판매
             ,DECODE(SA0203.CONTRACT_NO, NULL, 'N', 'Y') AS CHK_YN
          FROM SA_0113T SA0113                         /* 프로모션 헤더 */
          INNER JOIN SA_0115T SA_0115                  /* 프로모션 모델 */
            ON SA0113.DLR_CD = SA_0115.DLR_CD
           AND SA0113.PROMOTION_CD = SA_0115.PROMOTION_CD
          INNER JOIN SA_0116T SA0116                  /* 프로모션 계약유형 */
            ON SA0113.DLR_CD = SA0116.DLR_CD
           AND SA0113.PROMOTION_CD = SA0116.PROMOTION_CD
          LEFT OUTER JOIN (
                             SELECT A.*
                               FROM SA_0203T A               /*계약 프로모션*/
                              WHERE CONTRACT_NO = #{sContractNo}
                           ) SA0203
            ON SA0113.DLR_CD = SA0203.DLR_CD
           AND SA0113.PROMOTION_CD = SA0203.PROMOTION_CD
         WHERE SA0113.USE_YN = 'Y'
           AND SA0113.APPROVE_CD = 'C'
           AND SA0116.CONTRACT_TP = #{sContractTp}
           AND SA_0115.MODEL_CD = #{sModelCd}
           AND #{sStartContractDt} BETWEEN SA0113.START_DT AND SA0113.END_DT    -- 계약일
           AND SA0113.DLR_CD = #{sDlrCd}
           AND SA0113.PROMOTION_OWN_CD = #{sPromotionOwnCd}      -- 프로모션 주관 01:법인, 02:딜러

        UNION

        SELECT SA0113.DLR_CD
             ,SA0113.PROMOTION_CD
             ,SA0113.PROMOTION_NM
             ,SA0113.PROMOTION_TP     /* SAL010 프로모션유형 */
             ,SA_0115.MODEL_CD
             ,SA0113.START_DT
             ,SA0113.END_DT
             ,SA0113.APPLY_TP        -- 비율(R) , 금액(F)
             --,SA0113.PROMOTION_AMT
             , CASE WHEN NVL(SA0203.PROMOTION_AMT, 0) = 0 then SA0113.PROMOTION_AMT
                    ELSE SA0203.PROMOTION_AMT
                END     AS PROMOTION_AMT
             ,SA0113.IMS_BUDN_RATE   -- 제조사부담율
             ,SA0113.DLR_BUDN_RATE   -- 딜러부담율
             ,SA0113.REG_USR_ID
             ,SA0113.REG_DT
             ,SA0113.UPDT_USR_ID
             ,SA0113.UPDT_DT
             ,SA0116.CONTRACT_TP    -- N: 일반판매, P:선출고판매, Q:집단판매
             ,DECODE(SA0203.CONTRACT_NO, NULL, 'N', 'Y') AS CHK_YN
          FROM SA_0113T SA0113                         /* 프로모션 헤더 */
          INNER JOIN SA_0115T SA_0115                  /* 프로모션 모델 */
            ON SA0113.DLR_CD = SA_0115.DLR_CD
           AND SA0113.PROMOTION_CD = SA_0115.PROMOTION_CD
          INNER JOIN SA_0116T SA0116                  /* 프로모션 계약유형 */
            ON SA0113.DLR_CD = SA0116.DLR_CD
           AND SA0113.PROMOTION_CD = SA0116.PROMOTION_CD
          INNER JOIN SA_0114T SA0114
             ON SA0113.DLR_CD = SA0114.DLR_CD
            AND SA0113.PROMOTION_CD = SA0114.PROMOTION_CD
          LEFT OUTER JOIN (
                             SELECT A.*
                               FROM SA_0203T A               /*계약 프로모션*/
                              WHERE CONTRACT_NO = #{sContractNo}
                           ) SA0203
            ON SA0113.DLR_CD = SA0203.DLR_CD
           AND SA0113.PROMOTION_CD = SA0203.PROMOTION_CD
         WHERE SA0113.USE_YN = 'Y'
           AND SA0113.APPROVE_CD = 'C'
           AND SA0116.CONTRACT_TP = #{sContractTp}
           AND SA_0115.MODEL_CD = #{sModelCd}
           AND #{sStartContractDt} BETWEEN SA0113.START_DT AND SA0113.END_DT    -- 계약일
           AND SA0113.DLR_CD = #{sDlrCd}
           AND SA0114.CUST_CD = #{sContractCustNo}
           AND SA0113.PROMOTION_OWN_CD = #{sPromotionOwnCd}      -- 프로모션 주관 01:법인, 02:딜러
    </select>

    <!-- 계약 프로모션 저장 -->
    <insert id="insertContractPromotions" parameterType="ContractPromotionVO">
        INSERT
          INTO SA_0203T(
               DLR_CD
             , CONTRACT_NO
             , PROMOTION_CD
             , PROMOTION_AMT
             , USE_YN
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
             , PROMOTION_OWN_CD
        )VALUES(
               #{dlrCd}
             , #{contractNo}
             , #{promotionCd}
             , #{promotionAmt}
             , 'Y'
             , #{regUsrId}
             , SYSDATE
             , #{updtUsrId}
             , SYSDATE
             , #{promotionOwnCd}
        )
    </insert>

    <!-- 계약 프로모션 삭제 -->
    <delete id="deleteContractPromotions" parameterType="ContractPromotionVO">
        DELETE
          FROM SA_0203T
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
           AND PROMOTION_CD = #{promotionCd}
           AND PROMOTION_OWN_CD = #{promotionOwnCd}
    </delete>

    <!-- 계약된 프로모션 삭제 -->
    <delete id="deleteContractAllPromotions" parameterType="ContractPromotionVO">
        DELETE
          FROM SA_0203T
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
           AND PROMOTION_OWN_CD = #{promotionOwnCd}
    </delete>

    <!-- 계약된 입/출금내역 조회 -->
    <select id="selectPayInfoListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0218T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>
    <select id="selectPayInfoListsByCondition" parameterType="ContractReSearchVO" resultType="ContractPayInfoVO">
        SELECT DLR_CD
             , CONTRACT_NO
             , SEQ
             , RCV_TP
             , DPST_WDRW_TP
             , DPST_WDRW_DT
             , DPST_WDRW_TARG_TP
             , DPST_WDRW_AMT
             , REMARK
          FROM SA_0218T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>

    <!-- 계약된 입/출금내역 저장 -->
    <insert id="insertPayInfo" parameterType="ContractPayInfoVO">
        INSERT INTO SA_0218T    --계약입출금관리
        (
          DLR_CD                   --딜러코드
         ,CONTRACT_NO              --계약번호
         ,SEQ                      --일련번호
         ,RCV_TP                   --수납유형
         ,DPST_WDRW_TP             --입출금유형
         ,DPST_WDRW_DT             --입출금일자
         ,DPST_WDRW_TARG_TP        --입출금대상유형
         ,DPST_WDRW_AMT            --입출금금액
         ,REMARK                   --비고
         ,REG_USR_ID               --등록자ID
         ,REG_DT                   --등록일자
         ,UPDT_USR_ID              --수정자ID
         ,UPDT_DT                  --수정일자
        )
        VALUES
        (
          #{dlrCd}                   --딜러코드
         ,#{contractNo}              --계약번호
         ,(SELECT NVL(MAX(SEQ),0)+1 FROM sa_0218T WHERE DLR_CD = #{dlrCd} AND CONTRACT_NO = #{contractNo})
         ,#{rcvTp}                   --수납유형
         ,#{dpstWdrwTp}              --입출금유형
         ,#{dpstWdrwDt}              --입출금일자
         ,#{dpstWdrwTargTp}          --입출금대상유형
         ,#{dpstWdrwAmt}             --입출금금액
         ,#{remark}                 --비고
         ,#{regUsrId}                --등록자ID
         ,SYSDATE
         ,#{updtUsrId}               --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약된 입/출금내역 수정 -->
    <update id="updatePayInfo" parameterType="ContractPayInfoVO">
        UPDATE SA_0218T    --계약입출금관리
           SET RCV_TP            = #{rcvTp}                   --수납유형
             , DPST_WDRW_TP      = #{dpstWdrwTp}              --입출금유형
             , DPST_WDRW_DT      = #{dpstWdrwDt}              --입출금일자
             , DPST_WDRW_TARG_TP = #{dpstWdrwTargTp}          --입출금대상유형
             , DPST_WDRW_AMT     = #{dpstWdrwAmt}             --입출금금액
             , REMARK            = #{remark}                  --비고
             , UPDT_USR_ID       = #{updtUsrId}               --수정자ID
             , UPDT_DT           = SYSDATE
         WHERE 1 = 1
           AND DLR_CD            = #{dlrCd}                   --딜러코드
           AND CONTRACT_NO       = #{contractNo}              --계약번호
           AND SEQ               = #{seq}                     --일련번호
    </update>

    <!-- 계약된 입/출금내역 삭제 -->
    <delete id="deletePayInfo" parameterType="ContractPayInfoVO">
        DELETE FROM SA_0218T    --계약입출금관리
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND CONTRACT_NO       = #{contractNo}              --계약번호
           AND SEQ               = #{seq}                     --일련번호
    </delete>

    <!-- 계약된 보험내역 조회 -->
    <select id="selectIncListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0222T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
        <if test='sIncTp != null and sIncTp != ""'>
           AND INC_TP = #{sIncTp}
        </if>
    </select>
    <select id="selectIncListsByCondition" parameterType="ContractReSearchVO" resultType="ContractReIncVO">
        SELECT DLR_CD
             , CONTRACT_NO
             , INC_TP
             , INC_EXPC_AMT
             , REAL_INC_AMT
             , INC_PRID
             , INC_START_DT
             , INC_END_DT
             , REMARK
             , VAL_REC_AMT
          FROM SA_0222T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
         ORDER BY DLR_CD, CONTRACT_NO DESC, INC_TP ASC
    </select>

    <!-- 계약된 보험내역 저장 -->
    <insert id="insertInc" parameterType="ContractReIncVO">
        INSERT INTO SA_0222T    --계약보험서비스아이템
        (
          DLR_CD              --딜러코드
         ,CONTRACT_NO         --계약번호
         ,INC_TP              --보험유형
         ,INC_EXPC_AMT        --보험예상금액
         ,REAL_INC_AMT        --실보험금액
         ,INC_PRID            --보험기간
         ,INC_START_DT        --보험시작일자
         ,INC_END_DT          --보험종료일자
         ,REMARK              --비고
         ,VAL_REC_AMT         --수령액
         ,REG_USR_ID          --등록자ID
         ,REG_DT              --등록일자
         ,UPDT_USR_ID         --수정자ID
         ,UPDT_DT             --수정일자
        )
        VALUES
        (
          #{dlrCd}              --딜러코드
         ,#{contractNo}         --계약번호
         ,#{incTp}              --보험유형
         ,#{incExpcAmt}         --보험예상금액
         ,#{realIncAmt}         --실보험금액
         ,#{incPrid}            --보험기간
         ,#{incStartDt}         --보험시작일자
         ,#{incEndDt}           --보험종료일자
         ,#{remark}             --비고
         ,#{valRecAmt}          --수령액
         ,#{regUsrId}           --등록자ID
         ,SYSDATE
         ,#{updtUsrId}          --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약된 보험내역 수정 -->
    <update id="updateInc" parameterType="ContractReIncVO">
        UPDATE SA_0222T    --계약보험서비스아이템
           SET INC_TP       = #{incTp}              --보험유형
             , INC_EXPC_AMT = #{incExpcAmt}         --보험예상금액
             , REAL_INC_AMT = #{realIncAmt}         --실보험금액
             , INC_PRID     = #{incPrid}            --보험기간
             , INC_START_DT = #{incStartDt}         --보험시작일자
             , INC_END_DT   = #{incEndDt}           --보험종료일자
             , REMARK       = #{remark}             --비고
             , VAL_REC_AMT  = #{valRecAmt}          --수령액
             , UPDT_USR_ID  = #{updtUsrId}          --수정자ID
             , UPDT_DT      = SYSDATE
         WHERE 1 = 1
           AND DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
           AND INC_TP       = #{incTp}              --보험유형
    </update>

    <!-- 계약된 보험내역 삭제 -->
    <delete id="deleteInc" parameterType="ContractReIncVO">
        DELETE FROM SA_0222T    --계약보험서비스아이템
         WHERE DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
           AND INC_TP       = #{incTp}              --보험유형
    </delete>

    <!-- 계약된 용품내역 조회 -->
    <select id="selectGoodsListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0204T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>
    <select id="selectGoodsListsByCondition" parameterType="ContractReSearchVO" resultType="ContractReGoodsVO">
        SELECT A.DLR_CD
             , A.CONTRACT_NO
             , A.SEQ
             , A.GOODS_CD
             --, B.ITEM_NM    AS GOODS_NM
             , NVL(A.GOODS_NM, B.ITEM_NM) AS GOODS_NM
             , A.GOODS_CNT
             , A.GOODS_UNIT_CD
             , A.GOODS_PRC
             , A.DC_RATE
             , A.GOODS_AMT
             , A.SERVICE_YN
             , A.REAL_GOODS_AMT             -- 실제용품금액(총금액)
             , A.DC_AMT
             , A.PKG_ITEM_CD
             , A.GR_STRGE_CD
             , A.GI_STRGE_CD
          FROM SA_0204T A
          LEFT OUTER JOIN PT_0201T B    /* 품목마스터 */
            ON A.DLR_CD = B.DLR_CD
           AND A.GOODS_CD = B.ITEM_CD
         WHERE A.DLR_CD = #{sDlrCd}
           AND A.CONTRACT_NO = #{sContractNo}
    </select>


    <!-- 계약 용품내역 저장 -->
    <insert id="insertGoods" parameterType="ContractReGoodsVO">
        INSERT
          INTO SA_0204T    --계약용품내역
        (
              DLR_CD                --딜러코드
             ,CONTRACT_NO           --계약번호
             ,SEQ                   --일련번호
             ,REG_USR_ID            --등록자ID
             ,REG_DT                --등록일자
             ,UPDT_USR_ID           --수정자ID
             ,UPDT_DT               --수정일자
             ,GOODS_CD              --용품코드
             ,GOODS_NM              --용품명
             ,GOODS_CNT             --용품수
             ,GOODS_UNIT_CD         --용품단위
             ,GOODS_PRC             --용품단가
             ,DC_RATE               --할인율
             ,GOODS_AMT             --용품금액
             ,SERVICE_YN
             ,REAL_GOODS_AMT        --실제용품금액
             ,DC_AMT                --할인금액
             ,PKG_ITEM_CD           --패키지품목코드
             ,GR_STRGE_CD           --입고창고코드
             ,GI_STRGE_CD           --출고창고코드
             ,STAT_CD               --처리상태
             ,REF_DOC_NO            --참조문서번호
             ,REF_DOC_LINE_NO       --참조문서라인번호
        )
        VALUES
        (
              #{dlrCd}                --딜러코드
             ,#{contractNo}           --계약번호
             ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0204T WHERE DLR_CD = #{dlrCd} AND CONTRACT_NO = #{contractNo})
             ,#{regUsrId}             --등록자ID
             ,SYSDATE
             ,#{updtUsrId}            --수정자ID
             ,SYSDATE
             ,#{goodsCd}              --용품코드
             ,#{goodsNm}              --용품명
             ,#{goodsCnt}             --용품수
             ,#{goodsUnitCd}          --용품단위
             ,#{goodsPrc}             --용품단가
             ,#{dcRate}               --할인율
             ,#{goodsAmt}             --용품금액
             ,#{serviceYn}            --서비스여부
             ,#{realGoodsAmt}         --실제용품금액
             ,#{dcAmt}                --할인금액
             ,#{pkgItemCd}          --패키지품목코드
             ,#{grStrgeCd}          --입고창고코드
             ,#{giStrgeCd}          --출고창고코드
             ,'10'
             ,#{refDocNo}
             ,#{refDocLineNo}
        )
    </insert>

    <!-- 계약 용품내역 수정 -->
    <update id="updateGoods" parameterType="ContractReGoodsVO">
       UPDATE SA_0204T       /* 계약용품정보 */
          SET UPDT_USR_ID    = #{updtUsrId}            --수정자ID
            , UPDT_DT        = SYSDATE
            , GOODS_CD       = #{goodsCd}              --용품코드
            , GOODS_NM       = #{goodsNm}              --용품명
            , GOODS_CNT      = #{goodsCnt}             --용품수
            , GOODS_UNIT_CD  = #{goodsUnitCd}          --용품단위
            , GOODS_PRC      = #{goodsPrc}             --용품단가
            , DC_RATE        = #{dcRate}               --할인율
            , GOODS_AMT      = #{goodsAmt}             --용품금액
            , SERVICE_YN     = #{serviceYn}            --서비스여부
            , REAL_GOODS_AMT = #{realGoodsAmt}         --실제용품금액
            , DC_AMT         = #{dcAmt}                --할인금액
            , PKG_ITEM_CD    = #{pkgItemCd}            --패키지품목코드
            , GR_STRGE_CD    = #{grStrgeCd}            --입고창고코드
            , GI_STRGE_CD    = #{giStrgeCd}            --출고창고코드
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
           AND SEQ            = #{seq}                  --일련번호
    </update>

    <!-- 계약 용품내역 삭제 -->
    <delete id="deleteGoods" parameterType="ContractReGoodsVO">
        DELETE FROM SA_0204T    --계약용품정보
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
           AND SEQ         = #{seq}               --일련번호
    </delete>

    <!-- 계약된 부가비용 조회 -->
    <select id="selectOptionListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0219T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>
    <select id="selectOptionListsByCondition" parameterType="ContractReSearchVO" resultType="ContractReOptionVO">
        SELECT DLR_CD
             , CONTRACT_NO
             , SEQ
             , ADD_ATC_NM
             , ADD_AMT
          FROM SA_0219T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>

    <!-- 계약 부가비용 저장 -->
    <insert id="insertOption" parameterType="ContractReOptionVO">
        INSERT INTO SA_0219T    --계약부가비용
        (
          DLR_CD             --딜러코드
         ,CONTRACT_NO        --계약번호
         ,SEQ                --일련번호
         ,ADD_ATC_NM         --부가항목명
         ,ADD_AMT            --부가금액
         ,REG_USR_ID         --등록자ID
         ,REG_DT             --등록일자
         ,UPDT_USR_ID        --수정자ID
         ,UPDT_DT            --수정일자
        )
        VALUES
        (
          #{dlrCd}             --딜러코드
         ,#{contractNo}        --계약번호
         ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0219T WHERE DLR_CD = #{dlrCd} AND CONTRACT_NO = #{contractNo})
         ,#{addAtcNm}          --부가항목명
         ,#{addAmt}            --부가금액
         ,#{regUsrId}          --등록자ID
         ,SYSDATE
         ,#{updtUsrId}         --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약 부가비용 수정 -->
    <update id="updateOption" parameterType="ContractReOptionVO">
        UPDATE SA_0219T    --계약부가비용
           SET ADD_ATC_NM  = #{addAtcNm}          --부가항목명
             , ADD_AMT     = #{addAmt}            --부가금액
             , UPDT_USR_ID = #{updtUsrId}         --수정자ID
             , UPDT_DT     = SYSDATE
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
           AND SEQ         = #{seq}               --일련번호
    </update>

    <!-- 계약 부가비용 삭제 -->
    <delete id="deleteOption" parameterType="ContractReOptionVO">
        DELETE FROM SA_0219T    --계약부가비용
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
           AND SEQ         = #{seq}               --일련번호
    </delete>

    <!-- 계약 번호판 등록 -->
    <insert id="insertReg" parameterType="ContractReVO">
        INSERT
          INTO SA_0220T    --계약번호판등록서비스
        (
              DLR_CD                   --딜러코드
             ,CONTRACT_NO              --계약번호
             ,REG_PRE_AMT              --등록선수금액
             ,REAL_REG_AMT             --실제등록금액
             ,REG_FEE_AMT              --등록수수료금액
             ,REG_DIST_CD              --등록지역코드
             ,REG_EXPC_DT              --등록예상일자
             ,PURC_TAX_PRE_AMT         --구입세금선수금액
             ,REAL_PURC_TAX_AMT        --실제구입세금액
             ,REG_USR_ID               --등록자ID
             ,REG_DT                   --등록일자
             ,UPDT_USR_ID              --수정자ID
             ,UPDT_DT                  --수정일자
        )VALUES(
              #{dlrCd}                   --딜러코드
             ,#{contractNo}              --계약번호
             ,#{regPreAmt}               --등록선수금액
             ,#{realRegAmt}              --실제등록금액
             ,#{regFeeAmt}               --등록수수료금액
             ,#{regDistCd}               --등록지역코드
             ,#{regExpcDt}               --등록예상일자
             ,#{purcTaxPreAmt}           --구입세금선수금액
             ,#{realPurcTaxAmt}          --실제구입세금액
             ,#{regUsrId}                --등록자ID
             ,SYSDATE
             ,#{updtUsrId}               --수정자ID
             ,SYSDATE
        )
    </insert>

    <!-- 계약 보험헤더 등록 -->
    <insert id="insertIncHead" parameterType="ContractReVO">
        INSERT
          INTO SA_0221T    --계약보험서비스헤더
        (
          DLR_CD               --딜러코드
         ,CONTRACT_NO          --계약번호
         ,INC_CMP_CD           --보험회사코드
         ,INC_PROFIT_NM        --보험수혜자명
         ,INC_JOIN_DT          --보험가입일자
         ,INC_EXPC_AMT         --보험예상금액
         ,REAL_INC_AMT         --실보험금액
         ,INC_FEE_AMT          --보험수수료금액
         ,REMARK               --비고
         ,IMPLY_YN             --총금액포함여부
         ,FIN_IMPLY_YN         --재무수납포함여부
         ,INC_CUST_NM          --피보험인
         ,INC_CUST_TEL_NO      --피보험인 전화번호
         ,INC_PCON_CUST_NM     --연계인
         ,INC_PCON_CUST_TEL_NO --연계인 전화번호
         ,FRC_INC_AMT          --강제보험금액
         ,BUS_INC_AMT          --상업보험금액
         ,REG_USR_ID           --등록자ID
         ,REG_DT               --등록일자
         ,UPDT_USR_ID          --수정자ID
         ,UPDT_DT              --수정일자
        )
        VALUES
        (
          #{dlrCd}               --딜러코드
         ,#{contractNo}          --계약번호
         ,#{incCmpCd}            --보험회사코드
         ,#{incProfitNm}         --보험수혜자명
         ,#{incJoinDt}           --보험가입일자
         ,#{incExpcAmt}          --보험예상금액
         ,#{realIncAmt}          --실보험금액
         ,#{incFeeAmt}           --보험수수료금액
         ,#{incRemark}           --비고
         ,#{implyYn}
         ,#{finImplyYn}
         ,#{incCustNm}
         ,#{incCustTelNo}
         ,#{incPconCustNm}
         ,#{incPconCustTelNo}
         ,#{frcIncAmt}
         ,#{busIncAmt}
         ,#{regUsrId}            --등록자ID
         ,SYSDATE
         ,#{updtUsrId}           --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약된 금융서비스 등록 -->
    <insert id="insertFinc" parameterType="ContractReVO">
        INSERT INTO SA_0223T    --계약금융정보
        (
              DLR_CD                --딜러코드
             ,CONTRACT_NO           --계약번호
             ,FINC_CMP_CD           --금융회사코드
             ,FINC_ITEM_CD          --금융품목코드
             ,FINC_REQ_DT           --금융요청일자
             ,FINC_REQ_AMT          --금융요청금액
             ,FINC_END_DT           --금융만기일자
             ,FINC_FEE_AMT          --금융수수료금액
             ,FINC_RPAY_PRID        --금융상환기간
             ,FINC_LOAD_RATE        --금융대출비율
             --,FINC_ITEM_KIND_CD
             ,INST_INTR_RATE
             ,GRTE_INC_AMT
             ,REG_USR_ID            --등록자ID
             ,REG_DT                --등록일자
             ,UPDT_USR_ID           --수정자ID
             ,UPDT_DT               --수정일자
        ) VALUES (
              #{dlrCd}                --딜러코드
             ,#{contractNo}           --계약번호
             ,#{fincCmpCd}            --금융회사코드
             ,#{fincItemCd}           --금융품목코드
             ,#{fincReqDt}            --금융요청일자
             ,#{fincReqAmt}           --금융요청금액
             ,#{fincEndDt}            --금융만기일자
             ,#{fincFeeAmt}           --금융수수료금액
             ,#{fincRpayPrid}         --금융상환기간
             ,#{fincLoadRate}         --금융대출비율
             --,#{fincItemKindCd}       --금융품목종류코드
             ,#{instIntrRate}         --할부이자율
             ,#{grteIncAmt}           --보증보험금액
             ,#{regUsrId}             --등록자ID
             ,SYSDATE
             ,#{updtUsrId}            --수정자ID
             ,SYSDATE
        )
    </insert>


    <!-- 딜러 프로모션에 대한 할인 레벨을 조회한다. -->
    <select id="selectDlrDcLevel2" parameterType="ContractReSearchVO" resultType="ContractReVO">
     SELECT CASE WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  0 THEN ''
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT1 THEN '01'
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT2 THEN '02'
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT3 THEN '03'
                 ELSE '04'
             END AS DC_LVL_CD
          , C.PROMOTION_AMT
          , A.PRC_NREG_YN
       FROM SA_0119T A
          , SA_0120T B
          , (
              SELECT DLR_CD
                   , CONTRACT_NO
                   , SUM(PROMOTION_AMT) AS PROMOTION_AMT
                FROM SA_0203T
               WHERE PROMOTION_OWN_CD = '02'  -- 딜러
                 AND USE_YN = 'Y'
                 AND CONTRACT_NO = #{sContractNo}
                 AND DLR_Cd = #{sDlrCd}
               GROUP BY DLR_CD, CONTRACT_NO
            ) C
      WHERE A.DLR_CD = B.DLR_CD
        AND A.DLR_CD = C.DLR_CD(+)
        AND B.MODEL_CD = #{sModelCd}
        AND B.OCN_CD =  #{sOcnCd}
        AND B.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
        AND B.END_DT <![CDATA[ >= ]]> #{sStartContractDt}

        AND A.DC_APPLY_YN = 'Y'
        AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
        AND A.end_dt <![CDATA[ >= ]]> #{sStartContractDt}
        AND A.DLR_Cd = #{sDlrCd}
    </select>

    <select id="selectDlrDcLevelCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
           FROM (
               SELECT 'A' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  #{sOcnCd}
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'X' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'Z' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = 'ALL'
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

                ORDER BY ETC DESC           -- ALL 우선 적용
             ) A
        WHERE ROWNUM = 1                    -- 다중건일시 한건만 처리
    </select>


    <select id="selectDlrDcLevel" parameterType="ContractReSearchVO" resultType="ContractReVO">
        SELECT A.DC_LVL_CD
             , A.PRC_NREG_YN
           FROM (
               SELECT 'A' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  #{sOcnCd}
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'X' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'Z' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = 'ALL'
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

                ORDER BY ETC DESC           -- ALL 우선 적용
             ) A
        WHERE ROWNUM = 1                    -- 다중건일시 한건만 처리
    </select>



    <!-- 계약 승인확정한다.(상태만 변경)  -->
    <update id="approval" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '20'
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약을 삭제한다.(상태만 변경)  -->
    <update id="deleteContract" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '90'
             , CNCL_DT             = SYSDATE
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약을 삭제한다.(상태만 변경)  -->
    <update id="cancelContract" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '91'
             , CNCL_DT             = SYSDATE
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!--계약 미배정 차량조회 -->
    <select id="selectContractReVinNosByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0121T
         WHERE 1 = 1
         <if test='sCarlineCd != null and sCarlineCd != ""'>
           AND CARLINE_CD = #{sCarlineCd}
         </if>
         <if test='sModelCd != null and sModelCd != ""'>
           AND MODEL_CD = #{sModelCd}
         </if>
         <if test='sOcnCd != null and sOcnCd != ""'>
           AND OCN_CD = #{sOcnCd}
         </if>
         <if test='sExtColorCd != null and sExtColorCd != ""'>
           AND EXT_COLOR_CD = #{sExtColorCd}
         </if>
         <if test='sIntColorCd != null and sIntColorCd != ""'>
           AND INT_COLOR_CD = #{sIntColorCd}
         </if>
         <if test='sVinNo != null and sVinNo != ""'>
           AND VIN_NO LIKE '%'|| #{sVinNo} ||'%'
         </if>
          <if test='sVinNo1 != null and sVinNo1 != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo1,"*")'>
              <bind name='sVinNo1' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo1, "*", "%")' />
                AND VIN_NO1 LIKE #{sVinNo1}
            </when>
            <otherwise>
                AND VIN_NO1 = #{sVinNo1}
            </otherwise>
          </choose>
          </if>
          <if test='sVinNo2 != null and sVinNo2 != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo2,"*")'>
              <bind name='sVinNo2' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo2, "*", "%")' />
                AND VIN_NO2 LIKE #{sVinNo2}
            </when>
            <otherwise>
                AND VIN_NO2 = #{sVinNo2}
            </otherwise>
          </choose>
          </if>
           AND NCAR_DSTIN_CD = 'N'
           AND CONTRACT_NO IS NULL
           --AND NVL(OWN_STAT_CD, 'O') = 'O'
           AND CAR_STAT_CD IN ('60')
           AND ORD_DLR_CD = #{sDlrCd}
           ORDER BY RETL_PRC DESC, CAR_STAT_CD ASC
    </select>
    <select id="selectContractReVinNosByCondition" parameterType="ContractReSearchVO" resultType="VehicleMasterVO">
        SELECT X.*
             , Z.WH_PRC
             , Z.MS_PRC
          FROM (
                SELECT ROWNUM AS RNUM
                     , FN_GET_CARLINE_NM(T1.CARLINE_CD) AS CARLINE_NM
                     , FN_GET_MODEL_NM(T1.MODEL_CD) AS MODEL_NM
                     , FN_GET_OCN_NM(T1.MODEL_CD, T1.OCN_CD) AS OCN_NM
                     , FN_GET_EXT_COLOR_NM(T1.EXT_COLOR_CD) AS EXT_COLOR_NM
                     , FN_GET_INT_COLOR_NM(T1.INT_COLOR_CD) AS INT_COLOR_NM
                     , T1.*
                  FROM (
                        SELECT CAR_ID
                             , VIN_NO
                             , CAR_STAT_CD
                             , NVL( TRUNC(MONTHS_BETWEEN(SYSDATE, CAR_VIN_ALLOC_DT), 0) , 0) AS MM_CNT
                             , NVL(RETL_PRC, 0) AS RETL_PRC
                             , CARLINE_CD                --차종코드
                             , MODEL_CD                  --모델코드
                             , OCN_CD                    --OCN코드
                             , EXT_COLOR_CD              --외장색상코드
                             , INT_COLOR_CD              --내장색상코드
                             , BLOCK_YN
                             , BLOCK_SALE_ADV_NO
                             , NVL(DAMAGE_CD, '02') AS DAMAGE_CD
                             , NVL(OWN_STAT_CD, 'O') AS OWN_STAT_CD
                             , CASE WHEN SA0421.REQ_STAT_CD = 'R' THEN 'R' -- 요청후 심사중
                                    WHEN SA0421.REQ_STAT_CD = 'Y' AND SA0421.APPROVE_YN = 'Y' THEN 'Y' -- 요청후 심사통과
                                    WHEN SA0421.REQ_STAT_CD = 'N' AND SA0421.APPROVE_YN = 'Y' THEN 'N' -- 요청후 심사거절
                               ELSE 'N' END AS EXP_APR_YN   -- 이상출고 심사통과 여부
                          FROM SA_0121T A
                             , (
                                 SELECT A.*
                                   FROM SA_0421T A
                                      , (
                                          SELECT DLR_CD, VIN_NO1, VIN_NO2, MAX(SEQ) AS SEQ
                                            FROM SA_0421T
                                           GROUP BY DLR_CD, VIN_NO1, VIN_NO2
                                        )B
                                  WHERE A.DLR_CD = B.DLR_CD
                                    AND A.VIN_NO1 = B.VIN_NO1
                                    AND A.VIN_NO2 = B.VIN_NO2
                                 ) SA0421
                         WHERE 1 = 1
                           AND A.ORD_DLR_CD = SA0421.DLR_CD(+)
                           AND A.VIN_NO1 = SA0421.VIN_NO1(+)
                           AND A.VIN_NO2 = SA0421.VIN_NO2(+)
                           AND A.CONTRACT_NO = SA0421.CONTRACT_NO(+)

                         <if test='sCarlineCd != null and sCarlineCd != ""'>
                           AND A.CARLINE_CD = #{sCarlineCd}
                         </if>
                         <if test='sModelCd != null and sModelCd != ""'>
                           AND A.MODEL_CD   = #{sModelCd}
                         </if>
                         <if test='sOcnCd != null and sOcnCd != ""'>
                           AND A.OCN_CD = #{sOcnCd}
                         </if>
                         <if test='sExtColorCd != null and sExtColorCd != ""'>
                           AND A.EXT_COLOR_CD = #{sExtColorCd}
                         </if>
                         <if test='sIntColorCd != null and sIntColorCd != ""'>
                           AND A.INT_COLOR_CD = #{sIntColorCd}
                         </if>
                         <if test='sVinNo != null and sVinNo != ""'>
                           AND A.VIN_NO LIKE '%'|| #{sVinNo} ||'%'
                         </if>
                          <if test='sVinNo1 != null and sVinNo1 != ""'>
                          <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo1,"*")'>
                              <bind name='sVinNo1' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo1, "*", "%")' />
                                AND A.VIN_NO1 LIKE #{sVinNo1}
                            </when>
                            <otherwise>
                                AND A.VIN_NO1 = #{sVinNo1}
                            </otherwise>
                          </choose>
                          </if>
                          <if test='sVinNo2 != null and sVinNo2 != ""'>
                          <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo2,"*")'>
                              <bind name='sVinNo2' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo2, "*", "%")' />
                                AND A.VIN_NO2 LIKE #{sVinNo2}
                            </when>
                            <otherwise>
                                AND A.VIN_NO2 = #{sVinNo2}
                            </otherwise>
                          </choose>
                          </if>
                           AND A.NCAR_DSTIN_CD = 'N'
                           AND A.CONTRACT_NO IS NULL
                           --AND NVL(A.OWN_STAT_CD, 'O') = 'O'
                           AND A.CAR_STAT_CD IN ('60')
                           AND A.ORD_DLR_CD = #{sDlrCd}
                           ORDER BY A.RETL_PRC DESC, A.CAR_STAT_CD ASC
                    ) T1
                WHERE 1 = 1
                <if test='firstIndex != -1 and lastIndex != -1'>
                  AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
             ) X
            ,(
               SELECT MODEL_CD
                    , OCN_CD
                    , MAX(WH_PRC) AS WH_PRC
                    , MAX(MS_PRC) AS MS_PRC
                 FROM SA_0110T
                where USE_YN = 'Y'
                  AND START_DT <![CDATA[<=]]> SYSDATE   -- 시작일
                  AND END_DT   <![CDATA[>=]]> SYSDATE   -- 종료일
                GROUP BY MODEL_CD, OCN_CD
             ) Z
        WHERE 1 = 1
          AND X.MODEL_CD = Z.MODEL_CD(+)
          AND X.OCN_CD   = Z.OCN_CD(+)
          <if test='firstIndex != -1 and lastIndex != -1'>
            AND RNUM <![CDATA[>]]> #{firstIndex}
          </if>
    </select>

    <!-- 임시배정(상태변경) -->
    <update id="updateCarAssign" parameterType="VehicleMasterVO">
         UPDATE SA_0121T
            SET OWN_STAT_CD = #{ownStatCd}
              , UPDT_USR_ID = #{regUsrId}
              , UPDT_DT     = SYSDATE
         WHERE ORD_DLR_CD = #{dlrCd}
           AND VIN_NO = #{vinNo}
    </update>


    <!--계약 상태 조회 (출고 처리시 조회) -->
    <select id="selectContractStatCd" parameterType="ContractSearchVO" resultType="java.lang.String">
        SELECT CONTRACT_STAT_CD
          FROM SA_0201T
          WHERE DLR_CD = #{sDlrCd}
            AND CONTRACT_NO = #{sContractNo}
    </select>


    <!-- 품목리스트(판매단가용)-계약 용품를 조회한다. -->
    <select id="selectItemSalePrcPopupByConditionCnt" parameterType="ContractReSearchVO"  resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectItemSalePrcPopupByConditionCnt] */
            SELECT  COUNT(*) AS VALUE
              FROM   PT_0201T A
                       LEFT OUTER JOIN (
                                  SELECT   DLR_CD
                                          ,ITEM_CD
                                          ,MAX(PRC_TP) AS PRC_TP
                                          ,MAX(LINE_NO) AS LINE_NO
                                          ,MAX(NVL(RETL_PRC,0)) AS RETL_PRC
                                    FROM   PT_0214T
                                   WHERE   DLR_CD = #{sDlrCd}
                                     AND   DEL_YN != 'Y'
                                  GROUP BY DLR_CD, ITEM_CD
                               ) B
                              ON A.DLR_CD  = B.DLR_CD
                             AND A.ITEM_CD = B.ITEM_CD
                        LEFT OUTER JOIN PT_0301T C
                           ON A.DLR_CD      = C.DLR_CD
                          AND A.GI_STRGE_CD = C.STRGE_CD
                          AND A.ITEM_CD     = C.ITEM_CD
             WHERE   A.DLR_CD  = #{sDlrCd}
               <if test='sItemCd      != null and sItemCd         != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                     <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                       AND A.ITEM_CD LIKE #{sItemCd}
                   </when>
                   <otherwise>
                     AND A.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                   </otherwise>
                 </choose>
               </if>
               <if test='sItemNm != null and sItemNm != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemNm,"*")'>
                     <bind name='sItemNm' value='@org.apache.commons.lang3.StringUtils@replace(sItemNm, "*", "%")' />
                       AND A.ITEM_NM LIKE #{sItemNm}
                   </when>
                   <otherwise>
                     AND A.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                   </otherwise>
                 </choose>
               </if>
               <if test='sCarlineCd != null and sCarlineCd != ""'>
                  AND A.CARLINE_CD = #{sCarlineCd}              --차종
               </if>
               <if test='sStrgeCd != null and sStrgeCd != ""'>
                  AND C.STRGE_CD = #{sStrgeCd}
               </if>
               AND   A.END_YN  != 'Y'
               AND   A.ITEM_DSTIN_CD in ('02','05')     -- 02부품, 05악세사리
    </select>

    <!-- 품목리스트(판매단가용)-계약 용품를 조회한다. -->
    <select id="selectItemSalePrcPopupByCondition" parameterType="ContractReSearchVO" resultType="ContractReGoodsVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractReDAO.selectItemSalePrcPopupByCondition] */
     SELECT   RNUM
             ,DLR_CD                     --딜러코드
             ,ITEM_CD                    --품목코드
             ,ITEM_NM                    --품목명
             ,STOCK_UNIT_CD              --재고단위
             ,PRC_TP                     --구매단가유형
             ,SALE_PRC_AMT               --판매단가
             ,CARLINE_CD                 --차종
             ,FN_GET_CARLINE_NM(CARLINE_CD) AS CARLINE_NM
             ,PURC_LEAD_HM               --구매리드타임
             ,NVL(GR_STRGE_CD,' ') AS GR_STRGE_CD              --입고창고
             ,NVL(GI_STRGE_CD,' ') AS GI_STRGE_CD              --출고창고
             ,NVL(AVLB_STOCK_QTY, 0) AS AVLB_STOCK_QTY         --가용재고
       FROM
     (
      SELECT  ROWNUM AS RNUM
             ,T1.DLR_CD                     --딜러코드
             ,T1.ITEM_CD                    --품목코드
             ,T1.ITEM_NM                    --품목명
             ,T1.STOCK_UNIT_CD              --재고단위
             ,T1.PRC_TP                     --구매단가유형
             ,T1.SALE_PRC_AMT
             ,T1.ABC_IND                    --ABC CLASS
             ,T1.CARLINE_CD                 --차종
             ,T1.PURC_LEAD_HM               --구매리드타임
             ,T1.GR_STRGE_CD                --입고창고
             ,T1.GI_STRGE_CD                --출고창고
             ,T1.AVLB_STOCK_QTY             --가용재고
       FROM
       (
            SELECT   A.DLR_CD
                    ,A.ITEM_CD
                    ,A.ITEM_NM
                    ,A.STOCK_UNIT_CD
                    ,B.PRC_TP
                    ,NVL(B.RETL_PRC, 0) AS SALE_PRC_AMT
                    ,A.ABC_IND
                    ,A.CARLINE_CD
                    ,A.PURC_LEAD_HM
                    ,A.GR_STRGE_CD
                    ,A.GI_STRGE_CD
                    ,C.AVLB_STOCK_QTY
              FROM   PT_0201T A
              LEFT OUTER JOIN (
                          SELECT   DLR_CD
                                  ,ITEM_CD
                                  ,MAX(PRC_TP) AS PRC_TP
                                  ,MAX(LINE_NO) AS LINE_NO
                                  ,MAX(NVL(RETL_PRC,0)) AS RETL_PRC
                            FROM   PT_0214T
                           WHERE   DLR_CD = #{sDlrCd}
                             AND   DEL_YN != 'Y'
                          GROUP BY DLR_CD, ITEM_CD
                                ) B
                ON A.DLR_CD = B.DLR_CD
               AND A.ITEM_CD= B.ITEM_CD
              LEFT OUTER JOIN (
                          SELECT DLR_CD
                                ,ITEM_CD
                                ,STRGE_CD
                                ,NVL(AVLB_STOCK_QTY,0) + NVL(RESV_STOCK_QTY,0) - NVL(BORROW_QTY,0) + NVL(RENT_QTY,0) AS STOCK_QTY
                                ,NVL(AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                                ,NVL(BORROW_QTY,0) AS BORROW_QTY
                                ,NVL(RENT_QTY,0) AS RENT_QTY
                                ,NVL(CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                                ,NVL(RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                            FROM PT_0301T
                            WHERE DLR_CD  = #{sDlrCd}
                            <if test='sItemCd != null and sItemCd != ""'>
                                AND ITEM_CD LIKE '%'||#{sItemCd}||'%'
                            </if>
                            <if test='sStrgeCd != null and sStrgeCd != ""'>
                                AND STRGE_CD = #{sStrgeCd}
                            </if>
                            ) C
               ON A.DLR_CD      = C.DLR_CD
              AND A.ITEM_CD     = C.ITEM_CD
            --AND A.GI_STRGE_CD = C.STRGE_CD
             WHERE   A.DLR_CD  = #{sDlrCd}
             <if test='sItemCd != null and sItemCd != ""'>
               <choose>
                 <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                   <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                     AND A.ITEM_CD LIKE #{sItemCd}
                 </when>
                 <otherwise>
                   AND A.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                 </otherwise>
               </choose>
             </if>
             <if test='sItemNm != null and sItemNm != ""'>
               <choose>
                 <when test='@org.apache.commons.lang3.StringUtils@contains(sItemNm,"*")'>
                   <bind name='sItemNm' value='@org.apache.commons.lang3.StringUtils@replace(sItemNm, "*", "%")' />
                     AND A.ITEM_NM LIKE #{sItemNm}
                 </when>
                 <otherwise>
                   AND A.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                 </otherwise>
               </choose>
             </if>



             <if test='sCarlineCd != null and sCarlineCd != ""'>
                AND A.CARLINE_CD = #{sCarlineCd}              --차종
             </if>
             <if test='sStrgeCd != null and sStrgeCd != ""'>
                AND C.STRGE_CD = #{sStrgeCd}
             </if>
               AND A.END_YN  != 'Y'
               AND A.ITEM_DSTIN_CD in ('02','05')
             ORDER BY
             <choose>
                 <when test='sort != null'>
                     <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                         <choose>
                             <when test='item.field == "itemCd"'>             ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                             <when test='item.field == "itemNm"'>             ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                             <otherwise>
                               DLR_CD ASC
                             ,ITEM_CD ASC
                             </otherwise>
                         </choose>
                     </foreach>
                 </when>
                 <otherwise>
                   DLR_CD ASC
                 ,ITEM_CD ASC
                 </otherwise>
             </choose>
           ) T1
       <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
       </where>
     )
     <where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
     </where>
    </select>

    <!-- 계약상태변경시 : EAI호출로 DCS의 Data보정 -->
    <insert id="procDlrRetailContract" parameterType="ContractReVO" statementType="CALLABLE">
        {CALL SP_SAL_DMS_P_0201T_IF(
              'SAL068'
            , #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{contractNo, mode=IN, jdbcType=VARCHAR}
            , ''
            , ''
        )}
    </insert>

    <!-- 계약 가격 내역 변경 -->
    <update id="updateContractPrice" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET RETL_AMT      = #{retlAmt}
             , PROMOTION_AMT = #{promotionAmt}
             , SBST_AMT      = #{sbstAmt}
             , GOODS_AMT     = #{goodsAmt}
             , REAL_CAR_AMT  = #{realCarAmt}
             , ETC_SUM_AMT   = #{etcSumAmt}
             , REAL_PAY_AMT  = #{realPayAmt}
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약 용품 수정을 위한 삭제 -->
    <delete id="deleteContractGoods" parameterType="ContractReSearchVO">
        DELETE FROM SA_0204T    --계약용품정보
         WHERE 1 = 1
           AND DLR_CD      = #{sDlrCd}             --딜러코드
           AND CONTRACT_NO = #{sContractNo}        --계약번호
    </delete>

    <!-- 계약 가격 내역 변경(대행업무) -->
    <update id="updateContractAapMngPrice" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET SBST_AMT      = #{sbstAmt}
             , GOODS_AMT     = #{goodsAmt}
             , INC_AMT       = #{incAmt}
             , AAP_AMT       = #{aapAmt}
             , REAL_CAR_AMT  = #{realCarAmt}
             , REAL_PAY_AMT  = #{realPayAmt}
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

</mapper>