<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : SalesVhclCbinRcitDAO_SqlMap.xml
    Description : [DMS] 영수증관리 > 기동차통일영수증관리
    author chibeom.song
    since 2017. 2. 20.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 7. 21.   chibeom.song     최초 생성1
-->
<mapper namespace="chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO">

	<resultMap id="blobMap" type="BlobVO">
    	<result property="data" javaType="[B" column="DATA" jdbcType="BLOB"/>
	</resultMap>

    <!-- 发票管理>机动车统一发票：查询数量 宫荣枢 2021-04-22 -->
    <select id="selectSalesVehicleCombineReceiptSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptSearchCnt] */
        SELECT COUNT(*)
		FROM (
			<!-- 宫荣枢 2021-04-22 给查询结果按组追加行号：过滤同发票号和发票代码的发票数据。首选验证状态“已通过”的，其次按照创建时间倒序-->
			SELECT ROW_NUMBER() OVER(PARTITION BY RECEIPT_NO, RECEIPT_CD ORDER BY CERT_FST ASC, REG_DT DESC) NO
				, tempData.*
				<!-- 宫荣枢 2021-04-22 “本店开票A、他店开票B”区分。原VIN区分(本店开票、他店开票)在二期需求设计里没有，先注释掉 -->
				<!-- , (CASE WHEN tempData.ORD_DLR_CD = #{sDlrCd} THEN 'A' ELSE 'B' END) AS VIN_TYPE -->
			FROM SA_0501T tempData
		) receipt
		INNER JOIN SA_0121T car ON car.VIN_NO = receipt.VIN_NO
		<where>
			receipt.NO = 1
	        <if test='sCustSaleStDt != null '>
				AND car.CUST_SALE_DT <![CDATA[>=]]> TRUNC(#{sCustSaleStDt}, 'DD')
			</if>
			<if test='sCustSaleEdDt != null '>
				AND car.CUST_SALE_DT <![CDATA[<]]> TRUNC(#{sCustSaleEdDt}, 'DD')+1
			</if>
			<if test='sReceiptStDt != null '>
				AND receipt.RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt}, 'DD')
			</if>
			<if test='sReceiptEdDt != null '>
				AND receipt.RECEIPT_ISS_DT <![CDATA[<]]> TRUNC(#{sReceiptEdDt}, 'DD')+1
			</if>
			<if test='sVinNo != null and sVinNo != ""'>
				AND receipt.VIN_NO LIKE '%'||#{sVinNo}||'%'
			</if>
			<if test='sReceiptNo != null and sReceiptNo != ""'>
				AND receipt.RECEIPT_NO = #{sReceiptNo}
			</if>
			<!-- 宫荣枢 2021-04-22 原VIN区分(本店开票、他店开票)在二期需求设计里没有，先注释掉
			<if test='sVinType != null and sVinType != ""'>
				AND receipt.VIN_TYPE = #{sVinType}
			</if>
			-->
			<if test='sDlrCd != null and sDlrCd != ""'>
				<!-- DMS需要查看本店开的票和他店开的票 -->
				AND (receipt.DLR_CD = #{sDlrCd} OR car.DLR_CD = #{sDlrCd})
			</if>
			<if test='sDlrCds != null and sDlrCds != ""'>
				AND receipt.DLR_CD = #{sDlrCds}
			</if>
			<if test='sOrdDlrCd != null and sOrdDlrCd != ""'>
				AND car.ORD_DLR_CD = #{sOrdDlrCd}
			</if>
			<if test='sReceiptResource != null and sReceiptResource != ""'>
				AND receipt.RECEIPT_RESOURCE = #{sReceiptResource}
			</if>
			<if test='sReceiptStatus != null and sReceiptStatus != ""'>
				AND receipt.RECEIPT_STATUS = #{sReceiptStatus}
			</if>
		</where>
    </select>

    <!-- 发票管理>机动车统一发票：查询数据 宫荣枢 2021-04-22 -->
    <select id="selectSalesVehicleCombineReceiptSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptSearchData] */
		SELECT * FROM (
			SELECT ROWNUM AS RNUM, page.* FROM (
				SELECT
					receipt.CAR_ID,
					receipt.VIN_NO,
					receipt.DLR_CD,
					receipt.ORD_DLR_CD,
					FN_GET_CARLINE_NM_NC(car.CARLINE_CD) AS CARLINE_NM,			<!-- 车种名称 -->
					FN_GET_MODEL_TP_NM(car.MODEL_CD, car.OCN_CD) AS MODEL_NM,	<!-- 车款名称 -->
					(
						SELECT price.MS_PRC
		            	FROM SA_0110T price
		             	WHERE price.MODEL_CD = car.MODEL_CD AND price.OCN_CD = car.OCN_CD AND END_DT >= SYSDATE
		            ) AS MS_PRC,	<!-- 指导价 -->
		            receipt.RECEIPT_STATUS,
					receipt.RECEIPT_RESOURCE,
					receipt.TAXPAYER_ID_CD,
					receipt.RECEIPT_NO,
					receipt.RECEIPT_CD,
					receipt.SUM_AMT,
					receipt.RECEIPT_CUST_NM,
					receipt.SSN_CRN_NO,
					(
						SELECT CUST_NM FROM CR_0101T WHERE DLR_CD = buy.DLR_CD AND CUST_NO = buy.CONTRACT_CUST_NO
					) AS CUST_NM,
					(
						SELECT SSN_CRN_NO FROM CR_0101T WHERE DLR_CD = buy.DLR_CD AND CUST_NO = buy.CONTRACT_CUST_NO
					) AS CUST_SSN_CRN_NO,
					car.CUST_SALE_DT,
					receipt.RECEIPT_ISS_DT,
                    receipt.CERT_FST,
					receipt.REG_DT
				FROM (
					<!-- 宫荣枢 2021-04-22 给查询结果按组追加行号：过滤同发票号和发票代码的发票数据。首选验证状态“已通过”的，其次按照创建时间倒序-->
					SELECT ROW_NUMBER() OVER(PARTITION BY RECEIPT_NO, RECEIPT_CD ORDER BY CERT_FST ASC, REG_DT DESC) NO
						, tempData.*
						<!-- 宫荣枢 2021-04-22 “本店开票A、他店开票B”区分。原VIN区分(本店开票、他店开票)在二期需求设计里没有，先注释掉 -->
						<!-- , (CASE WHEN tempData.ORD_DLR_CD = #{sDlrCd} THEN 'A' ELSE 'B' END) AS VIN_TYPE -->
					FROM SA_0501T tempData
				) receipt
				INNER JOIN SA_0121T car ON car.VIN_NO = receipt.VIN_NO
				INNER JOIN SA_0201T buy ON buy.VIN_NO = car.VIN_NO
				<where>
					receipt.NO = 1
			        <if test='sCustSaleStDt != null '>
						AND car.CUST_SALE_DT <![CDATA[>=]]> TRUNC(#{sCustSaleStDt}, 'DD')
					</if>
					<if test='sCustSaleEdDt != null '>
						AND car.CUST_SALE_DT <![CDATA[<]]> TRUNC(#{sCustSaleEdDt}, 'DD')+1
					</if>
					<if test='sReceiptStDt != null '>
						AND receipt.RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt}, 'DD')
					</if>
					<if test='sReceiptEdDt != null '>
						AND receipt.RECEIPT_ISS_DT <![CDATA[<]]> TRUNC(#{sReceiptEdDt}, 'DD')+1
					</if>
					<if test='sVinNo != null and sVinNo != ""'>
						AND receipt.VIN_NO LIKE '%'||#{sVinNo}||'%'
					</if>
					<if test='sReceiptNo != null and sReceiptNo != ""'>
						AND receipt.RECEIPT_NO = #{sReceiptNo}
					</if>
					<!-- 宫荣枢 2021-04-22 原VIN区分(本店开票、他店开票)在二期需求设计里没有，先注释掉
					<if test='sVinType != null and sVinType != ""'>
						AND receipt.VIN_TYPE = #{sVinType}
					</if>
					-->
					<if test='sDlrCd != null and sDlrCd != ""'>
						<!-- DMS需要查看本店开的票和他店开的票 -->
						AND (receipt.DLR_CD = #{sDlrCd} OR car.DLR_CD = #{sDlrCd})
					</if>
					<if test='sDlrCds != null and sDlrCds != ""'>
						AND receipt.DLR_CD = #{sDlrCds}
					</if>
					<if test='sOrdDlrCd != null and sOrdDlrCd != ""'>
						AND car.ORD_DLR_CD = #{sOrdDlrCd}
					</if>
					<if test='sReceiptResource != null and sReceiptResource != ""'>
						AND receipt.RECEIPT_RESOURCE = #{sReceiptResource}
					</if>
					<if test='sReceiptStatus != null and sReceiptStatus != ""'>
						AND receipt.RECEIPT_STATUS = #{sReceiptStatus}
					</if>
				</where>
				ORDER BY
		        <choose>
		            <when test='sort != null'>
		                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
		                    <choose>
		                        <when test='item.field == "vinNo"'>receipt.VIN_NO <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "dlrCd"'>receipt.DLR_CD <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "ordDlrCd"'>car.ORD_DLR_CD <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "msPrc"'>MS_PRC <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "sumAmt"'>receipt.SUM_AMT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "custSaleDt"'>car.CUST_SALE_DT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "receiptIssDt"'>receipt.RECEIPT_ISS_DT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                    </choose>
		                </foreach>
		            </when>
		            <otherwise>
		                receipt.RECEIPT_ISS_DT DESC
		            </otherwise>
		         </choose>
			) page
			<where>
	        	<if test='firstIndex != -1 and lastIndex != -1'>
	        		ROWNUM <![CDATA[<=]]> #{lastIndex}
	        	</if>
	        </where>
	    )
	    <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>
    
    <!-- TangWei 2021/03/30 发票扫码查询数量 -->
    <select id="selectSalesVehicleCombineReceiptCnt" parameterType="SalesVhclCbinRcitAppScanSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptCnt] */
        SELECT COUNT(*) AS VALUE
            FROM SA_0510T
           WHERE 1=1
           <!-- 发票验证状态 -->
            <if test='certFst != null and certFst != ""'>
              AND CERT_FST = #{certFst}
            </if>
            <if test='sReceiptStDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt},'DD')
            </if>
            <if test='sReceiptEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sReceiptEdDt},'DD')
            </if>
            <if test='sScanStDt != null '>
              AND SCAN_DT <![CDATA[>=]]> TRUNC(#{sScanStDt},'DD')
            </if>
            <if test='sScanEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sScanEdDt},'DD')
            </if>
    </select>
    
    <!-- TangWei 2021/03/30 发票扫码查询数据 -->
    <select id="selectSalesVehicleCombineReceiptData" parameterType="SalesVhclCbinRcitAppScanSearchVO" resultType="SalesVhclCbinRcitAppScanSaveVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptData] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
		        SELECT APP_RECEIPT_ID, RECEIPT_CD, RECEIPT_NO, RECEIPT_ISS_DT, SUM_AMT, SCAN_DT,
		            CERT_FST
		        FROM SA_0510T
		        WHERE 1=1
		    <!-- 发票验证状态 -->
		    <if test='certFst != null and certFst != ""'>
              AND CERT_FST = #{certFst}
            </if>
            <if test='sReceiptStDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt},'DD')
            </if>
            <if test='sReceiptEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sReceiptEdDt},'DD')
            </if>
            <if test='sScanStDt != null '>
              AND SCAN_DT <![CDATA[>=]]> TRUNC(#{sScanStDt},'DD')
            </if>
            <if test='sScanEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sScanEdDt},'DD')
            </if>
            ORDER BY
		        <choose>
		            <when test='sort != null'>
		                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
		                    <choose>
		                        <when test='item.field == "sumAmt"'>SUM_AMT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "scanDt"'>SCAN_DT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "receiptIssDt"'>RECEIPT_ISS_DT <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                        <when test='item.field == "certFst"'>CERT_FST <choose><when test='item.dir == "desc"'>DESC</when><otherwise>ASC</otherwise></choose></when>
		                    </choose>
		                </foreach>
		            </when>
		            <otherwise>
		                RECEIPT_ISS_DT DESC
		            </otherwise>
		         </choose>
		        ) T1
		        <where>
                    <if test='firstIndex != -1 and lastIndex != -1'>
                        ROWNUM <![CDATA[<=]]> #{lastIndex}
                    </if>
                </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>
    
    <!-- TangWei 2021/04/22 发票扫码Excel下载 -->
    <select id="selectSalesVehicleCombineReceiptDataExcel" parameterType="SalesVhclCbinRcitAppScanSearchVO" resultType="SalesVhclCbinRcitAppScanSaveVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptDataExcel] */
        SELECT A.APP_RECEIPT_ID, A.RECEIPT_CD, A.RECEIPT_NO, A.RECEIPT_ISS_DT, A.SUM_AMT, A.SCAN_DT,
            ( SELECT Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAF001'
                                   AND A.USE_YN = 'Y'
                                 ) Z1
                         WHERE A.CERT_FST = Z1.CMM_CD
                       ) AS CERT_FST 
        FROM SA_0510T A
        WHERE 1=1
            <!-- 发票验证状态 -->
		    <if test='certFst != null and certFst != ""'>
              AND CERT_FST = #{certFst}
            </if>
            <if test='sReceiptStDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[>=]]> TRUNC(#{sReceiptStDt},'DD')
            </if>
            <if test='sReceiptEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sReceiptEdDt},'DD')
            </if>
            <if test='sScanStDt != null '>
              AND SCAN_DT <![CDATA[>=]]> TRUNC(#{sScanStDt},'DD')
            </if>
            <if test='sScanEdDt != null '>
              AND RECEIPT_ISS_DT <![CDATA[<=]]> TRUNC(#{sScanEdDt},'DD')
            </if>
    </select>
    
    <!-- TangWei 2021/04/11 根据发票号和发票代码，查询SA_0510T的发票信息 -->
    <select id="selectCntByReceiptNoAndReceiptCd" parameterType="java.util.Map" resultType="SalesVhclCbinRcitAppScanSaveVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectCntByReceiptNoAndReceiptCd] */
        SELECT APP_RECEIPT_ID AS appReceiptId,CERT_FST AS certFst
        FROM SA_0510T
        WHERE RECEIPT_NO = #{receiptNo} AND RECEIPT_CD = #{receiptCd}
    </select>
    
    <!-- TangWei 2021/04/13 根据发票代码和号码查询SA_0501T -->
    <select id="selectCntByReceiptNoCd" parameterType="java.util.Map" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectCntByReceiptNoCd] */
        SELECT COUNT(*) AS value
        FROM SA_0501T
        WHERE RECEIPT_NO = #{receiptNo}  AND RECEIPT_CD = #{receiptCd} AND CERT_FST = 1
    </select>
    
    <!-- TangWei 2021/04/12 根据发票号和发票代码更新发票信息 -->
    <update id="updateReceiptByReceiptNoAndReceiptCd" parameterType="java.util.Map">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateReceiptByReceiptNoAndReceiptCd] */
        UPDATE SA_0510T 
        SET RECEIPT_ISS_DT = TRUNC(to_date(#{receiptPubDt}), 'DD'), SUM_AMT = #{sumAmt}, CERT_FST = #{certFst}
        WHERE RECEIPT_NO = #{receiptNo} AND RECEIPT_CD = #{receiptCd}       
    </update>
    
    <!-- TangWei 2021/04/13 根据carId更新SA_0501T信息 -->
    <update id="updateVhclReceiptInfo" parameterType="java.util.Map">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateVhclReceiptInfo] */
        UPDATE SA_0501T 
        SET BRAND_MODEL = #{brandModel}, CAR_TYPE = #{carType}, COM_INS_NO = #{comInsNo}, DLR_CD = #{dlrCd}, DRAWER = #{drawer}, ENGN_NO = #{engnNo}, ENT_NM = #{entNm},
            IMPORT_CERT_NO = #{importCertNo}, LIMIT_NUM = #{limitNum}, PROD_AREA = #{prodArea}, RECEIPT_CUST_NM = #{receiptCustNm}, RECEIPT_IN_RESOURCE = #{receiptInResource},
            RECEIPT_RESOURCE = #{receiptResource}, RECEIPT_STATUS = #{RECEIPT_STATUS}, RECEIPT_TYPE = #{receiptType}, REG_DT = #{regDt}, REG_USR_ID = #{regUsrId}, REMARK = #{remark},
            SEL_ADDR = #{selAddr}, SEL_BANK = #{selBank}, SEL_BANK_NO = #{selBankNo}, SEL_NM = #{selNm}, SEL_PHONE = #{selPhone}, SEL_TAXPAYER_ID_CD = #{selTaxpayerIdCd},
            SSN_CRN_NO = #{ssnCrnNo}, SUM_INC_TAX = #{sumIncTax}, TAX_AMT = #{taxAmt}, TAX_CHK_YN = #{taxChkYn}, TAX_RT = #{taxRt}, TAXPAYER_ID_CD = #{taxpayerIdCd}, TON = #{ton},
            VIN_NO = #{vinNo}
        WHERE CAR_ID = #{carId}       
    </update>
    
    <!-- TangWei 2021/04/13 插入SA_0501T表 -->
    <insert id="addVhclReceiptInfo" parameterType="java.util.Map">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.addVhclReceiptInfo] */
        INSERT INTO SA_0501T(
            CAR_ID, BRAND_MODEL, CAR_TYPE, DLR_CD, ENGN_NO, LIMIT_NUM, PROD_AREA, RECEIPT_CUST_NM, RECEIPT_IN_RESOURCE, RECEIPT_RESOURCE,
            RECEIPT_STATUS, RECEIPT_TYPE, REG_USR_ID, SEL_ADDR, SEL_BANK, SEL_BANK_NO, SEL_NM, SEL_PHONE, SEL_TAXPAYER_ID_CD, SSN_CRN_NO, SUM_INC_TAX, TAX_AMT,
            TAX_CHK_YN, TAX_RT, TAXPAYER_ID_CD, VIN_NO, RECEIPT_NO, RECEIPT_CD, RECEIPT_ISS_DT, SUM_AMT, BINDING_CAR_YN, CERT_FST, SCAN_VIN_NO, SUM_EXC_TAX,
            VIN_NO2, VIN_NO1
        ) VALUES(
            #{carId},#{brandModel},#{carType},#{dlrCd},#{engnNo},#{limitNum},#{prodArea},#{receiptCustNm},#{receiptInResource},#{receiptResource},
            #{receiptStatus},#{receiptType},#{regUsrId},#{selAddr},#{selBank},#{selBankNo},#{selNm},#{selPhone},#{selTaxpayerIdCd},#{ssnCrnNo},#{sumIncTax},
            #{taxAmt},#{taxChkYn},#{taxRt},#{taxpayerIdCd},#{vinNo},#{receiptNo},#{receiptCd},#{receiptIssDt},#{sumAmt},#{bindingCarYn},#{certFst},#{scanVinNo},
            #{sumExcTax},#{vinNo2},#{vinNo1}
        )       
    </insert>
    
    <!-- 发票扫码-删除 -->
    <delete id="deleteReceiptByAppReceiptId" parameterType="java.lang.String">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.deleteReceiptByAppReceiptId] */
        DELETE
        SA_0510T
        WHERE APP_RECEIPT_ID = #{appReceiptId}
    </delete>
    
    <!-- 根据id查询SA_0510T发票信息 -->
    <select id="selectReceiptAppSearchVOByAppReceiptId" parameterType="java.lang.String" resultType="SalesVhclCbinRcitAppScanSearchVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectReceiptAppSearchVOByAppReceiptId] */
        SELECT RECEIPT_CD, RECEIPT_NO, RECEIPT_ISS_DT, SUM_AMT, CERT_FST, RECEIPT_RESOURCE FROM SA_0510T
        WHERE APP_RECEIPT_ID = #{appReceiptId}
    </select>

    <!-- 성(우편번호) 목록을  조회한다. -->
    <select id="selectProvinceInfoList" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectProvinceInfoList] */
        SELECT CSTL_CD AS provinceCd, CSTL_NM AS provinceNm FROM CM_2701T
        <where>
            <if test='sProvince != null and sProvince != ""'>
                SUNG_CD = #{sProvince}
            </if>
        </where>
        GROUP BY CSTL_CD, CSTL_NM ORDER BY CSTL_CD
    </select>

    <!-- 영수증관리 > 기동차통일영수증관리 총 갯수를 조회한다. -->
    <select id="selectSaleVehicleCombineReceiptCnt" parameterType="SalesVhclCbinRcitVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSaleVehicleCombineReceiptCnt] */
        SELECT COUNT(*) VALUE
          FROM SA_0501T
         WHERE VIN_NO = #{vinNo}
          <!-- R19080700284  同车架号+同发票号不能重复上传  同车架号+同发票号不能重复上传，同车架号+不同发票号可以重复上传，并且保存上传的履历。但发票系统，只保留最后上传的票据信息 。贾明 2019-8-7   AND TAXPAYER_ID_CD = #{scanPayTaxPinNo} 此处是纳税人识别号  -->
           AND RECEIPT_NO = #{scanRcptNo};
    </select>
    
     <!-- CSR 67 发票提交时对（ 发票代码+发票号码）进行唯一性校验  贾明 2020-3-19 -->
    <select id="selectSaleVehicleCombineReceiptNOCnt" parameterType="SalesVhclCbinRcitVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSaleVehicleCombineReceiptNOCnt] */
        SELECT COUNT(*) VALUE
          FROM SA_0501T
         WHERE RECEIPT_CD = #{scanRcptCd}
           AND RECEIPT_NO = #{scanRcptNo};
    </select>
    
   <!-- R19111100817 发票提交写入SA_0501T 表  贾明 2019-11-11 -->
  <insert id="insertSalesInvoiceInformationSave" parameterType="SalesVhclCbinRcitVO">
  /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesInvoiceInformationSave] */
       INSERT INTO DMSDB.SA_0501T
	        (
	                CAR_ID
                   ,VIN_NO
                   ,VIN_NO1
                   ,VIN_NO2
                   ,DLR_CD
                   ,TAXPAYER_ID_CD
                   ,RECEIPT_NO
                   ,RECEIPT_CD
                   ,RECEIPT_CUST_NM
                   ,SSN_CRN_NO
                   ,RECEIPT_ISS_DT
                   ,SCAN_VIN_NO
                   ,SUM_AMT
                   ,CERT_NO
                   ,ENGN_NO
                   ,SUM_INC_TAX
                   ,SUM_EXC_TAX
                   ,TAX_RT
                   ,TAX_AMT
                   ,MERCH_NM
                   ,ADDR
                   ,SDLR_CD
                   ,TAX_CHK_YN
                   ,REMARK
                   ,TMR_CD
                   ,EVAL_RSLT_CD
                   ,ERR_UP_CD
                   ,ORD_DLR_CD
                   ,TAX_SUNG_CD
                   ,SDLR_TP
                   ,SDLR_NM
                   ,TEL_NO        <!-- crs 37 发票上传扫描信息显示的画面，在 证件号码 后面增加 手机号码 ，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
                   ,REG_USR_ID
                   ,REG_DT
                   ,UPDT_USR_ID
                   ,UPDT_DT
	       ) VALUES (
	                 #{carId}
                    ,#{vinNo}
                    ,SUBSTR(#{vinNo}, 1, 11)
                    ,SUBSTR(#{vinNo}, 12, 6)
                    ,#{dlrCd}
                    ,#{scanPayTaxPinNo}
                    ,#{scanRcptNo}
                    ,#{scanRcptCd}
                    ,#{scanCustInfo}
                    ,#{scanSsnCrnNo}
                    ,#{scanRcptPubDt}
                    ,#{scanVinNo}
                    ,#{scanTaxIncPrice}
                    ,#{scanCertNo}
                    ,#{scanEngNo}
                    ,#{scanTaxIncPrice}
                    ,#{scanTaxExcPrice}
                    ,#{scanTaxRate}
                    ,#{scanTaxAmt}
                    ,#{scanSaleCmpnNm}
                    ,#{scanSaleCmpnAddr}
                    ,#{secDlrCd}
                    ,#{taxBeforeChk}
                    ,''
                    ,''
                    ,''
                    ,''
                    ,#{ordDlrCd}
                    ,#{taxSungCd}
                    ,#{sdlrTp}
                    ,#{sdlrNm}
                    ,#{telNo}          <!-- crs 37 发票上传扫描信息显示的画面，在 证件号码 后面增加 手机号码 ，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
                    ,#{regUsrId}
                    ,#{regDt}
                    ,#{updtUsrId}
                    ,#{updtDt}
	        )
  
  </insert>
  
   <!--  R19111100817 发票提交写入SA_0501T 表  图片贾明 2019-11-11 -->
    <update id="updateSalesInvoiceInformationImg" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesInvoiceInformationImg] */
    	UPDATE SA_0501T SET
    		RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
    	WHERE CAR_ID = #{carId}
    	      AND VIN_NO = #{vinNo}
    	      AND RECEIPT_NO = #{scanRcptNo}
    </update>
    
      <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据  修改时，重新发给DCS的信息 贾明 2019-11-11  -->
    <select id="selectSalesInvoiceInformationInfo" parameterType="SalesVhclCbinRcitVO" resultType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesInvoiceInformationInfo] */
        SELECT * FROM SA_0501T
        WHERE VIN_NO = #{vinNo}
              AND CAR_ID = #{carId}
              AND RECEIPT_NO = #{scanRcptNo}
    </select>
    
    <!-- 영수증관리 > 기동차통일영수증관리 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptSave] */
        MERGE INTO SA_0501T A
            USING ( SELECT #{carId} AS CAR_ID
                         , #{vinNo} AS VIN_NO
                         , SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1
                         , SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2
                         , #{dlrCd} AS DLR_CD
                         , #{scanPayTaxPinNo} AS TAXPAYER_ID_CD
                         , #{scanRcptNo} AS RECEIPT_NO
                         , #{scanRcptCd} AS RECEIPT_CD
                         , #{scanCustInfo} AS RECEIPT_CUST_NM
                         , #{scanSsnCrnNo} AS SSN_CRN_NO
                         , #{scanRcptPubDt} AS RECEIPT_ISS_DT
                         , #{scanVinNo} AS SCAN_VIN_NO
                         , #{scanTaxIncPrice} AS SUM_AMT
                         , #{scanCertNo} AS CERT_NO
                         , #{scanEngNo} AS ENGN_NO
                         , #{scanTaxIncPrice} AS SUM_INC_TAX
                         , #{scanTaxExcPrice} AS SUM_EXC_TAX
                         , #{scanTaxRate} AS TAX_RT
                         , #{scanTaxAmt} AS TAX_AMT
                         , #{scanSaleCmpnNm} AS MERCH_NM
                         , #{scanSaleCmpnAddr} AS ADDR
                         , '' AS TMR_CD
                         , '' AS EVAL_RSLT_CD
                         , '' AS ERR_UP_CD
                         , #{secDlrCd} AS SDLR_CD
                         , #{taxBeforeChk} AS TAX_CHK_YN
                         , '' AS REMARK
                         , #{ordDlrCd} AS ORD_DLR_CD
                         , #{taxSungCd} AS TAX_SUNG_CD
                         , #{sdlrTp} AS SDLR_TP
                         , #{sdlrNm} AS SDLR_NM
                         , #{regUsrId} AS REG_USR_ID
                         , #{regDt} AS REG_DT
                         , #{updtUsrId} AS UPDT_USR_ID
                         , #{updtDt} AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                  A.DLR_CD          = B.DLR_CD
                 ,A.TAXPAYER_ID_CD  = B.TAXPAYER_ID_CD
                 ,A.RECEIPT_NO      = B.RECEIPT_NO
                 ,A.RECEIPT_CD      = B.RECEIPT_CD
                 ,A.RECEIPT_CUST_NM = B.RECEIPT_CUST_NM
                 ,A.SSN_CRN_NO      = B.SSN_CRN_NO
                 ,A.RECEIPT_ISS_DT  = B.RECEIPT_ISS_DT
                 ,A.SCAN_VIN_NO     = B.SCAN_VIN_NO
                 ,A.SUM_AMT         = B.SUM_AMT
                 ,A.CERT_NO         = B.CERT_NO
                 ,A.ENGN_NO         = B.ENGN_NO
                 ,A.SUM_INC_TAX     = B.SUM_INC_TAX
                 ,A.SUM_EXC_TAX     = B.SUM_EXC_TAX
                 ,A.TAX_RT          = B.TAX_RT
                 ,A.TAX_AMT         = B.TAX_AMT
                 ,A.MERCH_NM        = B.MERCH_NM
                 ,A.ADDR            = B.ADDR
                 ,A.SDLR_CD         = B.SDLR_CD
                 ,A.TAX_CHK_YN      = B.TAX_CHK_YN
                 ,A.REMARK          = B.REMARK
                 ,A.ERR_UP_CD       = B.ERR_UP_CD
                 ,A.ORD_DLR_CD      = B.ORD_DLR_CD
                 ,A.TAX_SUNG_CD     = B.TAX_SUNG_CD
                 ,A.SDLR_TP         = B.SDLR_TP
                 ,A.SDLR_NM         = B.SDLR_NM
                 ,A.UPDT_USR_ID     = B.UPDT_USR_ID
                 ,A.UPDT_DT         = B.UPDT_DT
                 ,A.CERT_FST        = NULL
                 ,A.CERT_2ND        = NULL
                 ,A.CERT_3RD        = NULL
                 ,A.CERT_2RT        = NULL
                 ,A.CERT_3RT        = NULL
        WHEN NOT MATCHED THEN
            INSERT( A.CAR_ID
                   ,A.VIN_NO
                   ,A.VIN_NO1
                   ,A.VIN_NO2
                   ,A.DLR_CD
                   ,A.TAXPAYER_ID_CD
                   ,A.RECEIPT_NO
                   ,A.RECEIPT_CD
                   ,A.RECEIPT_CUST_NM
                   ,A.SSN_CRN_NO
                   ,A.RECEIPT_ISS_DT
                   ,A.SCAN_VIN_NO
                   ,A.SUM_AMT
                   ,A.CERT_NO
                   ,A.ENGN_NO
                   ,A.SUM_INC_TAX
                   ,A.SUM_EXC_TAX
                   ,A.TAX_RT
                   ,A.TAX_AMT
                   ,A.MERCH_NM
                   ,A.ADDR
                   ,A.SDLR_CD
                   ,A.TAX_CHK_YN
                   ,A.REMARK
                   ,A.TMR_CD
                   ,A.EVAL_RSLT_CD
                   ,A.ERR_UP_CD
                   ,A.ORD_DLR_CD
                   ,A.TAX_SUNG_CD
                   ,A.SDLR_TP
                   ,A.SDLR_NM
                   ,A.REG_USR_ID
                   ,A.REG_DT
                   ,A.UPDT_USR_ID
                   ,A.UPDT_DT
            )VALUES( B.CAR_ID
                    ,B.VIN_NO
                    ,B.VIN_NO1
                    ,B.VIN_NO2
                    ,B.DLR_CD
                    ,B.TAXPAYER_ID_CD
                    ,B.RECEIPT_NO
                    ,B.RECEIPT_CD
                    ,B.RECEIPT_CUST_NM
                    ,B.SSN_CRN_NO
                    ,B.RECEIPT_ISS_DT
                    ,B.SCAN_VIN_NO
                    ,B.SUM_AMT
                    ,B.CERT_NO
                    ,B.ENGN_NO
                    ,B.SUM_INC_TAX
                    ,B.SUM_EXC_TAX
                    ,B.TAX_RT
                    ,B.TAX_AMT
                    ,B.MERCH_NM
                    ,B.ADDR
                    ,B.SDLR_CD
                    ,B.TAX_CHK_YN
                    ,B.REMARK
                    ,B.TMR_CD
                    ,B.EVAL_RSLT_CD
                    ,B.ERR_UP_CD
                    ,B.ORD_DLR_CD
                    ,B.TAX_SUNG_CD
                    ,B.SDLR_TP
                    ,B.SDLR_NM
                    ,B.REG_USR_ID
                    ,B.REG_DT
                    ,B.UPDT_USR_ID
                    ,B.UPDT_DT
            )
    </insert>

    <!-- 영수증관리 > 기동차통일영수증관리 이력 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptHistSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptHistSave] */
        INSERT INTO SA_0503T (
             DLR_CD
            ,UP_DT
            ,RECEIPT_NO
            ,RECEIPT_TYPE
            ,VIN_NO
            ,VIN_NO1
            ,VIN_NO2
            ,TAXPAYER_ID_CD
            ,RECEIPT_CD
            ,RECEIPT_CUST_NM
            ,SSN_CRN_NO
            ,RECEIPT_ISS_DT
            ,SCAN_VIN_NO
            ,SUM_AMT
            ,CERT_NO
            ,ENGN_NO
            ,SUM_INC_TAX
            ,SUM_EXC_TAX
            ,TAX_RT
            ,TAX_AMT
            ,MERCH_NM
            ,ADDR
            ,TMR_CD
            ,REG_USR_ID
            ,REG_DT
        ) VALUES (
               #{dlrCd}
             , SYSDATE
             , #{scanRcptNo}
             , 'P'
             , #{scanVinNo}
             , SUBSTR(#{scanVinNo}, 1, 11)
             , SUBSTR(#{scanVinNo}, 12, 6)
             , #{scanPayTaxPinNo}
             , #{scanRcptCd}
             , #{scanCustInfo}
             , #{scanSsnCrnNo}
             , #{scanRcptPubDt}
             , #{scanVinNo}
             , #{scanTaxIncPrice}
             , #{scanCertNo}
             , #{scanEngNo}
             , #{scanTaxIncPrice}
             , #{scanTaxExcPrice}
             , #{scanTaxRate}
             , #{scanTaxAmt}
             , #{scanSaleCmpnNm}
             , #{scanSaleCmpnAddr}
             , ''
             , #{regUsrId}
             , #{regDt}
        );
    </insert>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptGridSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptGridSave] */
        INSERT INTO SA_0501T(
                 CAR_ID
                ,VIN_NO
                ,VIN_NO1
                ,VIN_NO2
                ,DLR_CD
                ,ERR_UP_CD
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
        )VALUES(
              #{carId}
            , #{vinNo}
            , SUBSTR(#{vinNo}, 1, 11)
            , SUBSTR(#{vinNo}, 12, 6)
            , #{dlrCd}
            , #{errUpCd}
            , #{regUsrId}
            , SYSDATE
            , #{regUsrId}
            , SYSDATE
        )
    </insert>
    
    <!-- TangWei 2021/03/31 发票扫码-提交 -->
    <insert id="addsalesVehicleCombineReceiptGridScanSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.addsalesVehicleCombineReceiptGridScanSave] */
        INSERT INTO SA_0501T(
				 CAR_ID
                ,VIN_NO
                ,RECEIPT_NO
                ,RECEIPT_CD
                ,RECEIPT_ISS_DT
                ,SUM_AMT
				,CERT_FST
				,SCAN_DT
        )VALUES(
        	  #{carId}
            , #{vinNo} 
            , #{receiptNo}
            , #{receiptCd}
            , #{receiptIssDt}
            , #{sumAmt}
            , (CASE WHEN #{certFst} = '未通过' THEN 0 WHEN #{certFst} = '已通过' THEN 1 ELSE 2  END)
            , #{scanDt}
        )
    </insert>
    
    <!-- TangWei 2021/04/09 发票扫码添加弹出框-保存 -->
   <insert id="addReceiptScan" parameterType="java.util.Map">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.addReceiptScan] */
        INSERT INTO SA_0510T(
				 APP_RECEIPT_ID
                ,RECEIPT_NO
                ,RECEIPT_CD
                ,RECEIPT_ISS_DT
                ,SUM_AMT
                ,CERT_FST
				,RECEIPT_IN_RESOURCE
				,RECEIPT_RESOURCE
				,RECEIPT_STATUS
				,REG_USR_ID
				,REG_DT
        )VALUES(
        	  SEQ_SA0510T.Nextval
            , #{receiptNo} 
            , #{receiptCd}
            , #{receiptPubDt}
            , #{sumAmt}
            , #{certFst}
            , #{receiptInResource}
            , #{receiptResource}
            , #{receiptStatus}
            , #{regUserId}
            , #{regDt}
        )
    </insert>
    
    
    <!-- R19080700284 初审回传结果有审核通过/不通过两种，在界面显示为“通过”或“不通过”。当为“不通过”时，进入发票明细界面可进行修改再提交的操作。 贾明2019-8-12  -->
  <update id="updateVehicleUnifiedInvoiceinfo" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateVehicleUnifiedInvoiceinfo] */
        UPDATE SA_0501T SET
              TAXPAYER_ID_CD = #{scanPayTaxPinNo} <!-- 纳税人识别号 -->
            , CERT_FST = '3'   <!-- 初审 -->
            , RECEIPT_NO  =  #{scanRcptNo} <!-- 发票号码 -->
            , RECEIPT_CD  =  #{scanRcptCd}   <!-- 发票代码 -->
            , RECEIPT_CUST_NM  =  #{scanCustInfo}   <!-- 购买方名称 -->
            , SSN_CRN_NO  =  #{scanSsnCrnNo}   <!-- 证件号码 -->
            , SUM_AMT  =  #{scanTaxIncPrice}   <!-- 价税合计小写-->
            , SUM_INC_TAX  =  #{scanTaxIncPrice}   <!-- 价税合计小写-->
            , SUM_EXC_TAX  =  #{scanTaxExcPrice}   <!-- 不含税价 -->  
            , TAX_AMT  =  #{scanTaxAmt}   <!--税额 -->
            , TAX_RT  =  #{scanTaxRate}   <!-- 税率 -->
            , RECEIPT_ISS_DT  =  #{scanRcptPubDt}   <!--开票日期 -->
            , MERCH_NM  =  #{scanSaleCmpnNm}   <!-- 销货单位名称 -->
            , ADDR  =  #{scanSaleCmpnAddr}   <!-- 联系地址 -->
            , UPDT_USR_ID = #{updtUsrId}
            , UPDT_DT = SYSDATE
            , TEL_NO = #{telNo} <!-- 电话 -->
        WHERE VIN_NO = #{vinNo}
              AND  CAR_ID = #{carId}
              AND RECEIPT_NO = #{scanRcptNo}
  </update>
    <!-- 영수증관리 > 기동차통일영수증관리 정보를 수정한다. -->
    <update id="updateSalesVehicleCombineReceiptGridSave" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptGridSave] */
        <!-- UPDATE SA_0501T SET
              ERR_UP_CD = #{errUpCd}
            , UPDT_USR_ID = #{updtUsrId}
            , UPDT_DT = SYSDATE
        WHERE VIN_NO = #{vinNo} -->

        MERGE INTO SA_0501T A
            USING ( SELECT #{carId} AS CAR_ID,
                           #{vinNo} AS VIN_NO,
                           SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1,
                           SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2,
                           #{dlrCd} AS DLR_CD,
                           #{errUpCd} AS ERR_UP_CD,
                           #{updtUsrId} AS REG_USR_ID,
                           SYSDATE AS REG_DT,
                           #{updtUsrId} AS UPDT_USR_ID,
                           SYSDATE AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                 A.ERR_UP_CD = B.ERR_UP_CD,
                 A.UPDT_USR_ID = B.UPDT_USR_ID,
                 A.UPDT_DT = B.UPDT_DT
        WHEN NOT MATCHED THEN
            INSERT(A.CAR_ID,
                   A.VIN_NO,
                   A.VIN_NO1,
                   A.VIN_NO2,
                   A.DLR_CD,
                   A.ERR_UP_CD,
                   A.REG_USR_ID,
                   A.REG_DT,
                   A.UPDT_USR_ID,
                   A.UPDT_DT
            )VALUES(B.CAR_ID,
                    B.VIN_NO,
                    B.VIN_NO1,
                    B.VIN_NO2,
                    B.DLR_CD,
                    B.ERR_UP_CD,
                    B.REG_USR_ID,
                    B.REG_DT,
                    B.UPDT_USR_ID,
                    B.UPDT_DT
            )
    </update>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 조회한다. -->
    <select id="selectSalesVehicleCombineReceiptGridSaveByKey" parameterType="map" resultType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptGridSaveByKey] */
        SELECT * FROM SA_0501T
        WHERE VIN_NO = #{vinNo}
    </select>

<!--  crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
    <select id="selectContractNoSearchTelData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectContractNoSearchTelData] */
    
            SELECT * FROM (
                            SELECT   NVL(TEL_NO1,TEL_NO2) AS TEL_NO
						             ,ROW_NUMBER() OVER(PARTITION BY CONTRACT_NO ORDER BY UPDT_DT DESC) NO  
						        FROM SA_0202T A  
						       WHERE 
						          DLR_CD = #{sDlrCd}
						          <if test='sContractNo != null '>
						              AND A.CONTRACT_NO = #{sContractNo}
						          </if>
						    ) T
						      WHERE NO =1 
    </select>
    

    <!-- 기동차통일영수증관리 > 영수증 업로드 > VIN 총 갯수를 조회한다. -->
    <select id="selectVinNoSearchPopupSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVinNoSearchPopupSearchCnt] */
        SELECT COUNT(*) AS VALUE
          FROM SA_0121T A
         WHERE A.CAR_STAT_CD IN ('50','60','70')
           AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
           AND A.NCAR_DSTIN_CD = 'N'
    </select>
    
    <!-- 기동차통일영수증관리 > 영수증 업로드 > VIN 정보를 조회한다. -->
    <select id="selectVinNoSearchPopupSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVinNoSearchPopupSearchData] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.CAR_ID
                      ,A.VIN_NO
                      ,A.ORD_DLR_CD AS DLR_CD
                      ,A.CARLINE_CD
                      ,FN_GET_CARLINE_NM(A.CARLINE_CD) AS CARLINE_NM
                      ,A.MODEL_CD
                      ,FN_GET_MODEL_TP_NM(A.MODEL_CD, A.OCN_CD) AS MODEL_NM
                      ,A.OCN_CD
                      ,FN_GET_OCN_NM(A.MODEL_CD, A.OCN_CD) AS OCN_NM
                      ,A.EXT_COLOR_CD
                      ,FN_GET_EXT_COLOR_NM(A.EXT_COLOR_CD) AS EXT_COLOR_NM
                      ,A.INT_COLOR_CD
                      ,FN_GET_INT_COLOR_NM(A.INT_COLOR_CD) AS INT_COLOR_NM
                      ,A.CAR_STAT_CD
                      ,A.PLT_GI_DT
                      ,A.CUST_SALE_DT
                      ,A.JEONGPAN_NO
                      ,A.VINM_F20010
                      ,B.MS_PRC AS WS_PRC
                      ,A.CONTRACT_NO    <!-- crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 -->
                  FROM SA_0121T A
                  LEFT OUTER JOIN SA_0110T B
                    ON A.MODEL_CD = B.MODEL_CD
                   AND A.OCN_CD   = B.OCN_CD
                WHERE A.CAR_STAT_CD IN ('50','60','70')
                  AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
                  AND A.NCAR_DSTIN_CD = 'N'
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 영수증관리 > 2급딜러정보 총 갯수를 조회한다. -->
    <select id="selectSecondDealerSearchCnt" parameterType="SalesVhclCbinRcitSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSecondDealerSearchCnt] */
        SELECT COUNT(*) AS VALUE
          FROM SA_0504T
         WHERE DLR_CD = #{sDlrCd}
           AND TAXPAYER_ID_CD = #{sTaxPayerId}
    </select>

    <!-- 영수증관리 > 2급딜러정보를 조회한다. -->
    <select id="selectSecondDealerSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSecondDealerSearchData] */
        SELECT SDLR_CD
              ,SDLR_TP
              ,DLR_CD
              ,SDLR_NM
          FROM SA_0504T
         WHERE DLR_CD = #{sDlrCd}
           AND TAXPAYER_ID_CD = #{sTaxPayerId}
    </select>

    <!-- 영수증관리 > 영수증 명세를 조회한다. -->
    <select id="selectReceiptDetailPopupSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectReceiptDetailPopupSearchData] */
          SELECT
        	 CAR_ID
            ,VIN_NO
            ,VIN_NO1
            ,VIN_NO2
            ,DLR_CD
            ,TAXPAYER_ID_CD
            ,RECEIPT_NO
            ,RECEIPT_CD
            ,RECEIPT_CUST_NM
            ,SSN_CRN_NO
            ,RECEIPT_ISS_DT
            ,SCAN_VIN_NO
            ,SUM_AMT
            ,CERT_NO
            ,ENGN_NO
            ,SUM_INC_TAX
            ,SUM_EXC_TAX
            ,TAX_RT
            ,TAX_AMT
            ,MERCH_NM
            ,ADDR
            ,TMR_CD
            ,EVAL_RSLT_CD
            ,ERR_UP_CD
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,TEL_NO  <!-- crs 37 发票上传扫描信息显示的画面，在“证件号码”后面增加“手机号码”，取合同上的客户手机号，允许修改，校验手机号为11位数字。提交给发票系统，发票初审不通过时可修 贾明 2019-12-11 查找合同客户表的电话 -->
     	FROM SA_0501T
        WHERE CAR_ID = #{sCarId} 
        <if test='sReceiptNo != null and sReceiptNo != ""'>
              AND RECEIPT_NO = #{sReceiptNo}   <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据 贾明 2019-11-11 查看信息修改数据 -->
       </if>
    </select>
    
     <!-- NO 31 DMS端车辆主信息的发票展示逻辑确定如下：1、车辆对应的发票，只有初审通过状态，没有复核通过的情况，那就以最新审核通过展示；2、有复核通过的发票，那就展示最新复核通过的。 贾明 2019-11-28  -->
    <select id="selectVehicleInfoMotorVehInvo" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVehicleInfoMotorVehInvo] */
        SELECT * FROM (
			 SELECT 
			       T2.*
			       ,ROW_NUMBER() OVER(PARTITION BY T2.VIN_NO ORDER BY T2.RECEIPT_ISS_DT DESC) NO
			     FROM ( 
			     SELECT * FROM (    
			        SELECT 
			         C.*
			        ,CASE WHEN TO_NUMBER(NVL(C.CERT_FST,0)) <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS CERT_FSTM
			        ,CASE WHEN TO_NUMBER(NVL(C.CERT_2ND,0)) <![CDATA[!=]]> 1  THEN 0 ELSE 1 END  AS CERT_2NDM
			        FROM SA_0501T C 
			     ) A,
			     (
			        SELECT T1.CAR_ID,MAX(NVL(T1.CERT_FSTS,0) + NVL(T1.CERT_2NDS,0)) CERT_COUNT FROM (
				       SELECT 
				           T.CAR_ID
				           ,CASE WHEN TO_NUMBER(NVL(T.CERT_FST,0))  <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS  CERT_FSTS
				           ,CASE WHEN TO_NUMBER(NVL(T.CERT_2ND,0))  <![CDATA[!=]]> 1  THEN 0 ELSE 1  END AS  CERT_2NDS
				           FROM SA_0501T T
				          WHERE  1 = 1
				              AND TO_NUMBER(NVL(T.CERT_2ND,0)) <![CDATA[!=]]> 2
				          <if test='sCarId != null and sCarId != ""'>
				              AND T.CAR_ID = #{sCarId}
				          </if>
				     ) T1 
				       GROUP BY T1.CAR_ID
			      ) B
			    WHERE A.CAR_ID = B.CAR_ID 
			      AND (NVL(A.CERT_FSTM,0) + NVL(A.CERT_2NDM,0)) = B.CERT_COUNT
			       <if test='sCarId != null and sCarId != ""'>
				       AND A.CAR_ID = #{sCarId}
				   </if>
			      AND B.CERT_COUNT <![CDATA[>]]>  0
			    ) T2
		 )
			   WHERE  NO = 1
			   ORDER BY RECEIPT_ISS_DT DESC
    </select>

    <select id="selectReceiptImageSearchData" parameterType="SalesVhclCbinRcitSearchVO" resultType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectReceiptImageSearchData] */
        SELECT RECEIPT_IMG
        FROM SA_0501T
        WHERE CAR_ID = #{sCarId} AND VIN_NO = #{sVinNo} AND RECEIPT_NO = #{sReceiptNo}
        <!-- R19111100817 一台车提交了两个不同号的发票，应该显示两行，目前只显示了一行。同时希望可以像<新能源补贴申请审核>页面类似的，可显示全部和最新的数据 贾明 2019-11-11 图片信息 -->
    </select>

    <!-- 영수증관리 > 영수증 이미지를 조회한다.  -->
    <select id="selectSalesVehicleCombineReceiptImg" parameterType="string" resultMap="blobMap">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectSalesVehicleCombineReceiptImg] */
	   	SELECT RECEIPT_IMG AS DATA
	   	FROM SA_0501T
	   	WHERE CAR_ID = #{value}
    </select>

    <!-- 영수증관리 > 기동차통일영수증 스캔파일을 등록한다. -->
    <update id="updateSalesVehicleCombineReceiptImg" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptImg] */
    	UPDATE SA_0501T SET
    		RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
    	WHERE CAR_ID = #{carId}
    </update>

    <!-- 영수증관리 > 차량마스터의 보증시작일자 수정구분을 조회한다. -->
    <select id="selectVehicleMasterUpdtCd" parameterType="SalesVhclCbinRcitVO" resultType="String">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectVehicleMasterUpdtCd] */
        SELECT NVL(TEMP4, ' ') AS UPDT_CD
          FROM SA_0121T
         WHERE CAR_ID = #{carId}
    </select>

    <!-- 영수증관리 > 차량마스터의 보증시작일자를 수정한다. -->
    <update id="updateSalesVehicleMasterSave" parameterType="SalesVhclCbinRcitVO">
        UPDATE SA_0121T SET TEMP3 = GRTE_START_DT
                           ,GRTE_START_DT = #{scanRcptPubDt}
                           ,TEMP4 = 'I'
                           ,UPDT_USR_ID = #{updtUsrId}
                           ,UPDT_DT = #{updtDt}
         WHERE CAR_STAT_CD IN ('70')
           AND CAR_ID = #{carId}
    </update>

    <select id="selectDealerSungStr" parameterType="SalesVhclCbinRcitVO" resultType="String">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.selectDealerSungStr] */
        SELECT SALE_DLR_SUNG_CD
          FROM CM_0101T
         WHERE DLR_CD = #{sDlrCd}
    </select>

    <!-- 영수증관리 > 기동차통일영수증관리 정보를 IS테이블에 신규 저장한다. -->
    <insert id="insertSalesVehicleCombineReceiptSaveIs" parameterType="SalesVhclCbinRcitVO">
        /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.insertSalesVehicleCombineReceiptSaveIs] */
        MERGE INTO SA_0501IS A
            USING ( SELECT #{carId} AS CAR_ID
                         , #{vinNo} AS VIN_NO
                         , SUBSTR(#{vinNo}, 1, 11) AS VIN_NO1
                         , SUBSTR(#{vinNo}, 12, 6) AS VIN_NO2
                         , #{dlrCd} AS DLR_CD
                         , #{scanPayTaxPinNo} AS TAXPAYER_ID_CD
                         , #{scanRcptNo} AS RECEIPT_NO
                         , #{scanRcptCd} AS RECEIPT_CD
                         , #{scanCustInfo} AS RECEIPT_CUST_NM
                         , #{scanSsnCrnNo} AS SSN_CRN_NO
                         , #{scanRcptPubDt} AS RECEIPT_ISS_DT
                         , #{scanVinNo} AS SCAN_VIN_NO
                         , #{scanTaxIncPrice} AS SUM_AMT
                         , #{scanCertNo} AS CERT_NO
                         , #{scanEngNo} AS ENGN_NO
                         , #{scanTaxIncPrice} AS SUM_INC_TAX
                         , #{scanTaxExcPrice} AS SUM_EXC_TAX
                         , #{scanTaxRate} AS TAX_RT
                         , #{scanTaxAmt} AS TAX_AMT
                         , #{scanSaleCmpnNm} AS MERCH_NM
                         , #{scanSaleCmpnAddr} AS ADDR
                         , '' AS TMR_CD
                         , '' AS EVAL_RSLT_CD
                         , '' AS ERR_UP_CD
                         , #{secDlrCd} AS SDLR_CD
                         , #{taxBeforeChk} AS TAX_CHK_YN
                         , '' AS REMARK
                         , #{ordDlrCd} AS ORD_DLR_CD
                         , #{taxSungCd} AS TAX_SUNG_CD
                         , #{sdlrTp} AS SDLR_TP
                         , #{sdlrNm} AS SDLR_NM
                         , #{regUsrId} AS REG_USR_ID
                         , #{regDt} AS REG_DT
                         , #{updtUsrId} AS UPDT_USR_ID
                         , #{updtDt} AS UPDT_DT
                      FROM DUAL
                  ) B
            ON ( A.CAR_ID = B.CAR_ID )
        WHEN MATCHED THEN
            UPDATE SET
                  A.DLR_CD          = B.DLR_CD
                 ,A.TAXPAYER_ID_CD  = B.TAXPAYER_ID_CD
                 ,A.RECEIPT_NO      = B.RECEIPT_NO
                 ,A.RECEIPT_CD      = B.RECEIPT_CD
                 ,A.RECEIPT_CUST_NM = B.RECEIPT_CUST_NM
                 ,A.SSN_CRN_NO      = B.SSN_CRN_NO
                 ,A.RECEIPT_ISS_DT  = B.RECEIPT_ISS_DT
                 ,A.SCAN_VIN_NO     = B.SCAN_VIN_NO
                 ,A.SUM_AMT         = B.SUM_AMT
                 ,A.CERT_NO         = B.CERT_NO
                 ,A.ENGN_NO         = B.ENGN_NO
                 ,A.SUM_INC_TAX     = B.SUM_INC_TAX
                 ,A.SUM_EXC_TAX     = B.SUM_EXC_TAX
                 ,A.TAX_RT          = B.TAX_RT
                 ,A.TAX_AMT         = B.TAX_AMT
                 ,A.MERCH_NM        = B.MERCH_NM
                 ,A.ADDR            = B.ADDR
                 ,A.SDLR_CD         = B.SDLR_CD
                 ,A.TAX_CHK_YN      = B.TAX_CHK_YN
                 ,A.REMARK          = B.REMARK
                 ,A.ERR_UP_CD       = B.ERR_UP_CD
                 ,A.ORD_DLR_CD      = B.ORD_DLR_CD
                 ,A.TAX_SUNG_CD     = B.TAX_SUNG_CD
                 ,A.SDLR_TP         = B.SDLR_TP
                 ,A.SDLR_NM         = B.SDLR_NM
                 ,A.UPDT_USR_ID     = B.UPDT_USR_ID
                 ,A.UPDT_DT         = B.UPDT_DT
                 ,A.IFRESULT        = 'N'
        WHEN NOT MATCHED THEN
            INSERT( A.CAR_ID
                   ,A.VIN_NO
                   ,A.VIN_NO1
                   ,A.VIN_NO2
                   ,A.DLR_CD
                   ,A.TAXPAYER_ID_CD
                   ,A.RECEIPT_NO
                   ,A.RECEIPT_CD
                   ,A.RECEIPT_CUST_NM
                   ,A.SSN_CRN_NO
                   ,A.RECEIPT_ISS_DT
                   ,A.SCAN_VIN_NO
                   ,A.SUM_AMT
                   ,A.CERT_NO
                   ,A.ENGN_NO
                   ,A.SUM_INC_TAX
                   ,A.SUM_EXC_TAX
                   ,A.TAX_RT
                   ,A.TAX_AMT
                   ,A.MERCH_NM
                   ,A.ADDR
                   ,A.SDLR_CD
                   ,A.TAX_CHK_YN
                   ,A.REMARK
                   ,A.TMR_CD
                   ,A.EVAL_RSLT_CD
                   ,A.ERR_UP_CD
                   ,A.ORD_DLR_CD
                   ,A.TAX_SUNG_CD
                   ,A.SDLR_TP
                   ,A.SDLR_NM
                   ,A.REG_USR_ID
                   ,A.REG_DT
                   ,A.UPDT_USR_ID
                   ,A.UPDT_DT
                   ,A.IFRESULT
            )VALUES( B.CAR_ID
                    ,B.VIN_NO
                    ,B.VIN_NO1
                    ,B.VIN_NO2
                    ,B.DLR_CD
                    ,B.TAXPAYER_ID_CD
                    ,B.RECEIPT_NO
                    ,B.RECEIPT_CD
                    ,B.RECEIPT_CUST_NM
                    ,B.SSN_CRN_NO
                    ,B.RECEIPT_ISS_DT
                    ,B.SCAN_VIN_NO
                    ,B.SUM_AMT
                    ,B.CERT_NO
                    ,B.ENGN_NO
                    ,B.SUM_INC_TAX
                    ,B.SUM_EXC_TAX
                    ,B.TAX_RT
                    ,B.TAX_AMT
                    ,B.MERCH_NM
                    ,B.ADDR
                    ,B.SDLR_CD
                    ,B.TAX_CHK_YN
                    ,B.REMARK
                    ,B.TMR_CD
                    ,B.EVAL_RSLT_CD
                    ,B.ERR_UP_CD
                    ,B.ORD_DLR_CD
                    ,B.TAX_SUNG_CD
                    ,B.SDLR_TP
                    ,B.SDLR_NM
                    ,B.REG_USR_ID
                    ,B.REG_DT
                    ,B.UPDT_USR_ID
                    ,B.UPDT_DT
                    ,'N'
            )
    </insert>

    <!-- 영수증관리 > 기동차통일영수증 스캔파일을 Is테이블에 등록한다. -->
    <update id="updateSalesVehicleCombineReceiptImgIs" parameterType="SalesVhclCbinRcitVO">
    /* [chn.bhmc.dms.sal.rcp.service.dao.SalesVhclCbinRcitDAO.updateSalesVehicleCombineReceiptImgIs] */
        UPDATE SA_0501IS SET
            RECEIPT_IMG = #{receiptImg, jdbcType=BLOB}
        WHERE CAR_ID = #{carId}
    </update>
</mapper>