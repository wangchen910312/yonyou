<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.orc.service.dao.NotAssignedOrderDAO">

    <select id="selectNotAssignedOrderCnt" parameterType="NotAssignedOrderSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM (SELECT *
                  FROM SA_0416T A, SA_0417T B
                 WHERE A.DLR_CD = B.DLR_CD
                   AND A.ORD_YYMM = B.ORD_YY_MM_DT
                   AND A.ORD_WEEK = B.ORD_PRID
                   AND A.CARLINE_CD = B.CARLINE_CD
                   AND A.ORD_SEQ = TO_NUMBER(B.ORD_NO)
                   AND A.SORD = B.ORD_TP
                   AND A.PRTY = 'A'
                 <if test='sDlrCd != null and sDlrCd != ""'>
                   AND A.DLR_CD = #{sDlrCd}
                 </if>
                 <if test='sOrdTp != null and sOrdTp != ""'>
                   AND A.SORD = #{sOrdTp}
                 </if>
                 <if test='sCarlineCd != null and sCarlineCd != ""'>
                   AND A.CARLINE_CD = #{sCarlineCd}
                 </if>
                 <if test='sModelCd != null and sModelCd != ""'>
                   AND A.MODEL_CD = #{sModelCd}
                 </if>
                 <if test='sOcnCd != null and sOcnCd != ""'>
                   AND A.OCN_CD = #{sOcnCd}
                 </if>
                 <if test='sOrdStartDtStr != "" and sOrdStartDtStr != null and sOrdEndDtStr != "" and sOrdEndDtStr != null' >
                   AND TO_CHAR(B.ORD_DT,'YYYYMMDD') BETWEEN #{sOrdStartDtStr} AND #{sOrdEndDtStr}
                 </if>
                 <if test='sOrdStartDt != null' >
                   AND B.ORD_DT <![CDATA[ >= ]]> #{sOrdStartDt}
                 </if>
                 <if test='sOrdEndDt != null' >
                   AND B.ORD_DT <![CDATA[ < ]]> #{sOrdEndDt} +1
                 </if>
                 <if test='sPaym != null and sPaym != ""'>
                   AND A.PAYM = #{sPaym}
                 </if>
                 <if test='sOrdPrid != null and sOrdPrid != ""'>
                   AND B.ORD_YY_MM_DT = SUBSTR(#{sOrdPrid}, 1, 6)
                   AND B.ORD_PRID = SUBSTR(#{sOrdPrid}, 7, 2)
                 </if>
                 <if test='sFscCd != null and sFscCd != "" and sFscCd != "None"'>
                   AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
                 </if>
                 <if test='sFscCd == "None"'>
                   AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD) IS NULL
                 </if>
                 )
    </select>

	<select id="selectNotAssignedOrder" parameterType="NotAssignedOrderSearchVO" resultType="NotAssignedOrderVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                  ,FN_GET_MODEL_TP_NM(T1.MODEL_CD, T1.OCN_CD) AS MODEL_NM
                  ,T1.*
            FROM (
                SELECT ORD_YYMM || '-' || ORD_WEEK AS ORDP_CNDY
                     , ORD_DT
                     , SALES_NO
                     , SORD
                     , CARLINE_NM
                     , CARLINE_CD
                     , MODEL_CD
                     , OCN_NM
                     , OCN_CD
                     , EXT_COLOR_NM
                     , EXT_COLOR_CD
                     , INT_COLOR_NM
                     , INT_COLOR_CD
                     , CHRG_CD
                     , MDPR
                     , MDPR - ADJP AS AFT_MDPR
                     , MDPR - ADJP AS ORDP_VAPR
                     , ORTY AS ORDP_COUNT
                     , ORTY
                     , TO_DATE(INNO,'YYYYMMDD') AS ORDP_EXNO
                     , SUM(MDPR)-SUM(ADJP) AS NEEDS_AMT
                     , PAYM
                     , DLR_CD
                     , CASH_AMT
                     , D2PRT_AMT
                     , D3PRT_AMT
                     , ADJP
                     , DAMT
                     , AAMT
                     , ORD_YYMM_S
                     , ORD_WEEK
                     , ORD_TYPE
                     , SALE_RGST_ID
                     , SALE_RGST_NM
                     , SUBSTR(INNO,1,4)||'-'||SUBSTR(INNO,5,2)||'-'||SUBSTR(INNO,7) AS ORDP_EXNO_XLS
                     , ORD_DT_XLS
                     , DC_RATE
                     , REG_USR_ID AS ORD_RGST_ID
                     , ( SELECT '['|| SORD ||']'||Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL138'   /*오더유형*/
                                   AND A.USE_YN = 'Y'
                                 ) Z1
                         WHERE SORD = Z1.CMM_CD
                       ) AS ORD_TP_NM             -- 주문유형
                     , ORD_YYMM
                     , ORD_GRADE_CD
                     , ORD_SEQ
                     , ADJ_STAT_CD
                  FROM (SELECT A.ORD_YYMM,
                               A.ORD_WEEK,
                               A.SALES_NO,
                               A.SORD,
                               B.ORD_DT,
                               FN_GET_CARLINE_NM_NC(A.CARLINE_CD) AS CARLINE_NM,
                               A.CARLINE_CD,
                               FN_GET_MODEL_TP_NM(A.MODEL_CD, A.OCN_CD) AS MODEL_NM,
                               A.MODEL_CD,
                               FN_GET_OCN_NM_NC(A.MODEL_CD, A.OCN_CD) AS OCN_NM,
                               A.OCN_CD,
                               FN_GET_EXT_COLOR_NM_NC(A.EXT_COLOR_CD) AS EXT_COLOR_NM,
                               A.EXT_COLOR_CD,
                               FN_GET_INT_COLOR_NM_NC(A.INT_COLOR_CD) AS INT_COLOR_NM,
                               A.INT_COLOR_CD,
                               B.REG_USR_ID AS CHRG_CD,
                               DECODE(A.INNO, '00000000', NULL, A.INNO) AS INNO,
                               (SELECT X.WH_PRC
                                 FROM SA_0110T X
                                WHERE X.MODEL_CD = A.MODEL_CD
                                  AND X.OCN_CD = A.OCN_CD
                                  AND TO_CHAR(X.END_DT,'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                                  AND X.USE_YN = 'Y') AS WH_PRC,
                               (SELECT X.MS_PRC
                                 FROM SA_0110T X
                                WHERE X.MODEL_CD = A.MODEL_CD
                                  AND X.OCN_CD = A.OCN_CD
                                  AND TO_CHAR(X.END_DT,'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                                  AND X.USE_YN = 'Y') AS MDPR,
                               CASE WHEN B.ORD_QTY <![CDATA[>]]> 1 THEN 1
                                    ELSE B.ORD_QTY
                                      END AS ORTY,
                               A.PAYM,
                               A.DLR_CD,
                               A.CASH_AMT,
                               A.D2PRT_AMT,
                               A.D3PRT_AMT,
                               A.ADJP,
                               A.DAMT,
                               A.AAMT,
                               SUBSTR(A.ORD_YYMM, 3) AS ORD_YYMM_S,
                               A.SORD AS ORD_TYPE
                              ,B.SALE_RGST_ID
                              ,(SELECT Z.USR_NM
                                    FROM CM_0801T Z
                                   WHERE Z.USR_ID = B.SALE_RGST_ID
                              ) AS SALE_RGST_NM
                              ,TO_CHAR(B.ORD_DT, 'YYYY-MM-DD') AS ORD_DT_XLS
                              ,CASE WHEN A.AAMT+(A.DAMT)*-1 <![CDATA[>]]> 0
                                    THEN ROUND(((A.DAMT)*-1)/(A.AAMT+(A.DAMT)*-1)*100,2)
                                    ELSE 0 END AS DC_RATE
                              ,B.REG_USR_ID
                              ,B.ORD_GRADE_CD
                              ,A.ORD_SEQ
                              ,C.ADJ_STAT_CD
                          FROM SA_0416T A, SA_0417T B
                             , (
                                SELECT A.*
                                  FROM SA_0453T A
                                     , (
                                        SELECT DLR_CD
                                             , ORD_YYMM
                                             , ORD_WEEK
                                             , ORD_SEQ
                                             , SORD
                                             , SALES_NO
                                             , MAX(SEQ) AS SEQ
                                          FROM SA_0453T
                                         GROUP BY DLR_CD, ORD_YYMM, ORD_WEEK, ORD_SEQ, SORD, SALES_NO
                                        ) B
                                  WHERE A.DLR_CD = B.DLR_CD
                                    AND A.ORD_YYMM = B.ORD_YYMM
                                    AND A.ORD_WEEK = B.ORD_WEEK
                                    AND A.ORD_SEQ = B.ORD_SEQ
                                    AND A.SORD = B.SORD
                                    AND A.SALES_NO = B.SALES_NO
                                    AND A.SEQ = B.SEQ
                              ) C
                         WHERE A.DLR_CD = B.DLR_CD
                           AND A.ORD_YYMM = B.ORD_YY_MM_DT
                           AND A.ORD_WEEK = B.ORD_PRID
                           AND A.CARLINE_CD = B.CARLINE_CD
                           AND A.ORD_SEQ = TO_NUMBER(B.ORD_NO)
                           AND A.SORD = B.ORD_TP
                           AND A.DLR_CD = C.DLR_CD(+)
                           AND A.ORD_YYMM = C.ORD_YYMM(+)
                           AND A.ORD_WEEK = C.ORD_WEEK(+)
                           AND A.CARLINE_CD = C.CARLINE_CD(+)
                           AND A.ORD_SEQ = C.ORD_SEQ(+)
                           AND A.SORD = C.SORD(+)
                           AND A.SALES_NO = C.SALES_NO(+)
                           AND A.PRTY = 'A'
                         <if test='sDlrCd != null and sDlrCd != ""'>
                           AND A.DLR_CD = #{sDlrCd}
                         </if>
                         <if test='sOrdTp != null and sOrdTp != ""'>
                           AND A.SORD = #{sOrdTp}
                         </if>
                         <if test='sCarlineCd != null and sCarlineCd != ""'>
                           AND A.CARLINE_CD = #{sCarlineCd}
                         </if>
                         <if test='sModelCd != null and sModelCd != ""'>
                           AND A.MODEL_CD = #{sModelCd}
                         </if>
                         <if test='sOcnCd != null and sOcnCd != ""'>
                           AND A.OCN_CD = #{sOcnCd}
                         </if>
                         <if test='sOrdStartDtStr != "" and sOrdStartDtStr != null and sOrdEndDtStr != "" and sOrdEndDtStr != null' >
                           AND TO_CHAR(B.ORD_DT,'YYYYMMDD') BETWEEN #{sOrdStartDtStr} AND #{sOrdEndDtStr}
                         </if>
                         <if test='sOrdStartDt != null'>
                           AND B.ORD_DT <![CDATA[>=]]> TRUNC(#{sOrdStartDt},'DD')
                         </if>
                         <if test='sOrdEndDt != null'>
                           AND B.ORD_DT <![CDATA[<]]> TRUNC(#{sOrdEndDt},'DD')+1
                         </if>
                         <if test='sOrdPrid != null and sOrdPrid != ""'>
                           AND B.ORD_YY_MM_DT = SUBSTR(#{sOrdPrid}, 1, 6)
                           AND B.ORD_PRID = SUBSTR(#{sOrdPrid}, 7, 2)
                         </if>
                         <if test='sPaym != null and sPaym != ""'>
                           AND A.PAYM = #{sPaym}
                         </if>
                         <if test='sFscCd != null and sFscCd != "" and sFscCd != "None"'>
                           AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
                         </if>
                         <if test='sFscCd == "None"'>
                           AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD) IS NULL
                         </if>
                        )
                        GROUP BY ORD_YYMM
                                ,ORD_WEEK
                                ,SALES_NO
                                ,SORD
                                ,ORD_DT
                                ,CARLINE_NM
                                ,CARLINE_CD
                                ,MODEL_NM
                                ,MODEL_CD
                                ,OCN_NM
                                ,OCN_CD
                                ,EXT_COLOR_NM
                                ,EXT_COLOR_CD
                                ,INT_COLOR_NM
                                ,INT_COLOR_CD
                                ,CHRG_CD
                                ,MDPR
                                ,ADJP
                                ,ORTY
                                ,INNO
                                ,PAYM
                                ,DLR_CD
                                ,CASH_AMT
                                ,D2PRT_AMT
                                ,D3PRT_AMT
                                ,DAMT
                                ,AAMT
                                ,ORD_TYPE
                                ,ORD_YYMM_S
                                ,SALE_RGST_ID
                                ,SALE_RGST_NM
                                ,ORD_DT_XLS
                                ,DC_RATE
                                ,REG_USR_ID
                                ,ORD_GRADE_CD
                                ,ORD_SEQ
                                ,ADJ_STAT_CD
               ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "orty"'>ORTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ordpCndy"'>ORD_YYMM || '-' || ORD_WEEK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ordDt"'>ORD_DT <choose><when test='item.dir == "ordDt"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "salesNo"'>SALES_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "sord"'>SORD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineNm"'>CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelNm"'>MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnNm"'>OCN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "extColorNm"'>EXT_COLOR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "intColorNm"'>INT_COLOR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "chrgCd"'>CHRG_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ordpExno"'>ORDP_EXNO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "mdpr"'>MDPR <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "aftMdpr"'>AFT_MDPR <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "adjp"'>ADJP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ordpVapr"'>ORDP_VAPR <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ordpCount"'>ORDP_COUNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "saleRgstNm"'>SALE_RGST_NM <choose><when test='item.dir == "saleRgstNm"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "adjStatCd"'>SALE_RGST_NM <choose><when test='item.dir == "saleRgstNm"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                   ORD_DT, SORD, CARLINE_CD, MODEL_CD, OCN_CD, EXT_COLOR_CD, INT_COLOR_CD
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        ORD_DT, SORD, CARLINE_CD, MODEL_CD, OCN_CD, EXT_COLOR_CD, INT_COLOR_CD
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>

    <!-- 미배정 주문조회 합 조회 -->
    <select id="selectNotAssignedOrderSumSearch" parameterType="NotAssignedOrderSearchVO" resultType="NotAssignedOrderVO">
       SELECT NVL(SUM(AAMT),0) AS AAMT_SUM
            , NVL(SUM(ORTY),0) AS ORTY_SUM
            , NVL(SUM(MDPR),0) AS MDPR_SUM
            , NVL(SUM(DAMT),0) AS DAMT_SUM
          FROM
            (
            SELECT A.DLR_CD, A.ORD_YYMM, A.ORD_WEEK, A.CARLINE_CD
                 , A.AAMT
                 , A.DAMT
                 , CASE WHEN B.ORD_QTY <![CDATA[>]]> 1 THEN 1
                        ELSE B.ORD_QTY
                    END AS ORTY
                 , (SELECT X.MS_PRC
                      FROM SA_0110T X
                     WHERE X.MODEL_CD = A.MODEL_CD
                       AND X.OCN_CD = A.OCN_CD
                       AND TO_CHAR(X.END_DT,'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                       AND X.USE_YN = 'Y') AS MDPR
              FROM SA_0416T A
                 , SA_0417T B
             WHERE A.DLR_CD = B.DLR_CD
               AND A.ORD_YYMM = B.ORD_YY_MM_DT
               AND A.ORD_WEEK = B.ORD_PRID
               AND A.CARLINE_CD = B.CARLINE_CD
               AND A.ORD_SEQ = TO_NUMBER(B.ORD_NO)
               AND A.SORD = B.ORD_TP
               AND A.PRTY = 'A'
             <if test='sDlrCd != null and sDlrCd != ""'>
               AND A.DLR_CD = #{sDlrCd}
             </if>
             <if test='sOrdTp != null and sOrdTp != ""'>
               AND A.SORD = #{sOrdTp}
             </if>
             <if test='sCarlineCd != null and sCarlineCd != ""'>
               AND A.CARLINE_CD = #{sCarlineCd}
             </if>
             <if test='sModelCd != null and sModelCd != ""'>
               AND A.MODEL_CD = #{sModelCd}
             </if>
             <if test='sOcnCd != null and sOcnCd != ""'>
               AND A.OCN_CD = #{sOcnCd}
             </if>
             <if test='sOrdStartDtStr != "" and sOrdStartDtStr != null and sOrdEndDtStr != "" and sOrdEndDtStr != null' >
               AND TO_CHAR(B.ORD_DT,'YYYYMMDD') BETWEEN #{sOrdStartDtStr} AND #{sOrdEndDtStr}
             </if>
             <if test='sOrdStartDt != null' >
               AND B.ORD_DT <![CDATA[ >= ]]> #{sOrdStartDt}
             </if>
             <if test='sOrdEndDt != null' >
               AND B.ORD_DT <![CDATA[ < ]]> #{sOrdEndDt} +1
             </if>
              <if test='sPaym != null and sPaym != ""'>
               AND A.PAYM = #{sPaym}
              </if>
             <if test='sOrdPrid != null and sOrdPrid != ""'>
               AND B.ORD_YY_MM_DT = SUBSTR(#{sOrdPrid}, 1, 6)
               AND B.ORD_PRID = SUBSTR(#{sOrdPrid}, 7, 2)
             </if>
             <if test='sFscCd != null and sFscCd != "" and sFscCd != "None"'>
               AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
             </if>
             <if test='sFscCd == "None"'>
               AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD) IS NULL
             </if>
          )
    </select>

	<!-- OCN SEARCH  -->
	<select id="selectVehicleOcnOption" parameterType="VehicleModelPackageSearchVO" resultType="VehicleModelPackageVO">
		SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT SUBSTR(A.MODEL_CD, 1, 2) CARLINE_CD
                     , A.OCN_CD
                     , A.OPTION_CD
                     , (SELECT AA.OPTION_NM FROM SA_0103T AA WHERE AA.OPTION_CD = A.OPTION_CD) OPTION_NM
                  FROM SA_0106T A
                 <where>
                 <if test='sModelCd != null and sModelCd != ""'>
                       A.MODEL_CD = #{sModelCd}
                 </if>
                 <if test='sOcnCd != null and sOcnCd != ""'>
                   AND A.OCN_CD = #{sOcnCd}
                 </if>
                 </where>
                 ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "carlineCd"'>CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnCd"'>OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "optionCd"'>A.OPTION_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "optionNm"'>OPTION_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    CARLINE_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        CARLINE_CD ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>

    <update id="updateNotAssignedOrder" parameterType="NotAssignedOrderVO">
        UPDATE SA_0416T
           SET PAYM = #{paym}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND SALES_NO = #{salesNo}
    </update>

    <select id="orderCancelPlanSerchCnt" parameterType="NotAssignedOrderVO" resultType="int">
    /* [chn.bhmc.dms.sal.orc.service.dao.NotAssignedOrderDAO.orderCancelPlanSerchCnt] */
        SELECT SUM(NVL(CNT, 0)) AS VAL
          FROM (
                SELECT COUNT(*) AS CNT
                  FROM SA_0176T
                 WHERE START_DT <![CDATA[ <= ]]> SYSDATE
                   AND END_DT   <![CDATA[ >= ]]> SYSDATE -1
                   AND ORD_YY_MM_DT||ORD_PRID >= #{ordYyMm}||#{ordWeek}
                   AND ORD_TP = #{sord}
                   AND NVL(GRADE_CD, 'C') IN ('C', #{ordGradeCd})
                UNION ALL
                SELECT COUNT(*) AS CNT
                  FROM SA_0176T
                 WHERE START_DT <![CDATA[ <= ]]> SYSDATE
                   AND END_DT   <![CDATA[ >= ]]> SYSDATE -1
                   AND ORD_YY_MM_DT||ORD_PRID >= #{ordYyMm}||#{ordWeek}
                   AND ORD_TP IS NULL
                   AND NVL(GRADE_CD, 'C') IN ('C', #{ordGradeCd})
        )
    </select>

    <insert id="insertOrderCancelAsk" parameterType="NotAssignedOrderVO">
    /* [chn.bhmc.dms.sal.orc.service.dao.NotAssignedOrderDAO.insertOrderCancelAsk]*/
        INSERT
          INTO SA_0453T    --오더 취소
        (
          DLR_CD              --딜러코드
         ,ORD_YYMM            --주문년월
         ,ORD_WEEK            --주문주차
         ,ORD_SEQ             --주문일련번호
         ,SORD                --오더타입
         ,SALES_NO            --영업번호
         ,SEQ                 --순번
         ,ORD_DT              --오더일자
         ,CARLINE_CD          --차종코드
         ,MODEL_CD            --주문모델
         ,OCN_CD              --OCN코드
         ,EXT_COLOR_CD        --외장색상코드
         ,INT_COLOR_CD        --내장색상코드
         ,ADJ_STAT_CD         --주문상태
         <if test='adjStatCd == "A"'>
         ,ASK_DT              --신청일
         </if>
         <if test='adjStatCd == "C"'>
         ,ASK_CNC_DT
         </if>
         ,REG_USR_ID          --등록자ID
         ,REG_DT              --등록일자
         ,UPDT_USR_ID         --수정자ID
         ,UPDT_DT             --수정일자
        )VALUES(
          #{dlrCd}              --딜러코드
         ,#{ordYyMm}            --주문년월
         ,#{ordWeek}            --주문주차
         ,#{ordSeq}             --주문일련번호
         ,#{sord}               --오더타입
         ,#{salesNo}            --영업번호
         ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0453T WHERE DLR_CD = #{dlrCd} AND ORD_YYMM = #{ordYyMm} AND ORD_WEEK = #{ordWeek} AND ORD_SEQ = #{ordSeq} AND SORD = #{sord} AND SALES_NO = #{salesNo})
         ,#{ordDt}              --오더일자
         ,#{carlineCd}          --차종코드
         ,#{modelCd}            --주문모델
         ,#{ocnCd}              --OCN코드
         ,#{extColorCd}         --외장색상코드
         ,#{intColorCd}         --내장색상코드
         ,#{adjStatCd}
         <if test='adjStatCd == "A"'>
         ,SYSDATE
         </if>
         <if test='adjStatCd == "C"'>
         ,SYSDATE
         </if>
         ,#{regUsrId}           --등록자ID
         ,SYSDATE
         ,#{updtUsrId}          --수정자ID
         ,SYSDATE
        )
        <selectKey resultType="String" keyProperty="seq" order="AFTER">
        SELECT MAX(SEQ) AS seq FROM SA_0453T WHERE DLR_CD = #{dlrCd} AND ORD_YYMM = #{ordYyMm} AND ORD_WEEK = #{ordWeek} AND ORD_SEQ = #{ordSeq} AND SORD = #{sord} AND SALES_NO = #{salesNo}
        </selectKey>
    </insert>

    <!-- 오더주문취소 요청 I/F -->
    <insert id="orderCancelAskIF" parameterType="NotAssignedOrderVO" statementType="CALLABLE">
        {CALL SP_SAL_DMS_P_0453T_IF(
              #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{ordYyMm, mode=IN, jdbcType=VARCHAR}
            , #{ordWeek, mode=IN, jdbcType=VARCHAR}
            , #{ordSeq, mode=IN, jdbcType=NUMERIC}
            , #{sord, mode=IN, jdbcType=VARCHAR}
            , #{salesNo, mode=IN, jdbcType=VARCHAR}
            , #{seq, mode=IN, jdbcType=NUMERIC}
        )}
    </insert>

    <!-- 미배정 주문취소 내역 조회 -->
    <select id="selectNotAssignedOrderCancelSearchCnt" parameterType="NotAssignedOrderSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM (
                SELECT 1
                  FROM (
                        SELECT   A.DLR_CD
                                    , A.ORD_YYMM
                                    , A.ORD_WEEK
                                    , A.ORD_SEQ
                                    , A.SORD
                                    , A.SALES_NO
                                    , A.SEQ
                                    , A.ORD_DT
                                    , A.CARLINE_CD
                                    , A.MODEL_CD
                                    , A.OCN_CD
                                    , A.EXT_COLOR_CD
                                    , A.INT_COLOR_CD
                                    , A.ADJ_STAT_CD
                                    , A.TEMP1
                                    , A.TEMP2
                                    , A.TEMP3
                                    , A.TEMP4
                                    , A.TEMP5
                                    , A.REG_USR_ID
                                    , A.REG_DT
                                    , A.UPDT_USR_ID
                                    , A.UPDT_DT
                                    , B.ASK_DT
                                    , A.CNC_DT
                                    , A.ASK_CNC_DT
                          FROM SA_0453T A
                             , (
                                SELECT DLR_CD
                                     , ORD_YYMM
                                     , ORD_WEEK
                                     , ORD_SEQ
                                     , SORD
                                     , SALES_NO
                                     , MAX(SEQ) AS SEQ
                                     , MAX(ASK_DT) AS ASK_DT
                                  FROM SA_0453T
                                 GROUP BY DLR_CD, ORD_YYMM, ORD_WEEK, ORD_SEQ, SORD, SALES_NO
                                ) B
                          WHERE A.DLR_CD = B.DLR_CD
                            AND A.ORD_YYMM = B.ORD_YYMM
                            AND A.ORD_WEEK = B.ORD_WEEK
                            AND A.ORD_SEQ = B.ORD_SEQ
                            AND A.SORD = B.SORD
                            AND A.SALES_NO = B.SALES_NO
                            AND A.SEQ = B.SEQ
                             <if test='sAskDtS != null ' >
                               AND B.ASK_DT <![CDATA[ >= ]]> TRUNC(#{sAskDtS},'DD')
                             </if>
                             <if test='sAskDtE != null ' >
                               AND B.ASK_DT <![CDATA[ < ]]> TRUNC(#{sAskDtE},'DD') +1
                             </if>
                      ) A
                    , SA_0416T B
                    , SA_0417T C
                 WHERE 1 = 1
                   AND A.DLR_CD = B.DLR_CD
                   AND A.ORD_YYMM = B.ORD_YYMM
                   AND A.ORD_WEEK = B.ORD_WEEK
                   AND A.CARLINE_CD = B.CARLINE_CD
                   AND A.ORD_SEQ = B.ORD_SEQ
                   AND A.SORD = B.SORD
                   AND A.SALES_NO = B.SALES_NO
                   AND B.DLR_CD = C.DLR_CD
                   AND B.ORD_YYMM = C.ORD_YY_MM_DT
                   AND B.ORD_WEEK = C.ORD_PRID
                   AND B.CARLINE_CD = C.CARLINE_CD
                   AND B.ORD_SEQ = TO_NUMBER(C.ORD_NO)
                   AND B.SORD = C.ORD_TP

                   AND A.ADJ_STAT_CD != 'C'
                 <if test='sAdjStatCd != null and sAdjStatCd != ""'>
                   AND A.ADJ_STAT_CD = #{sAdjStatCd}
                 </if>
                 <if test='sDlrCd != null and sDlrCd != ""'>
                   AND A.DLR_CD = #{sDlrCd}
                 </if>
                 <if test='sOrdTp != null and sOrdTp != ""'>
                   AND A.SORD = #{sOrdTp}
                 </if>
                 <if test='sCarlineCd != null and sCarlineCd != ""'>
                   AND A.CARLINE_CD = #{sCarlineCd}
                 </if>
                 <if test='sModelCd != null and sModelCd != ""'>
                   AND A.MODEL_CD = #{sModelCd}
                 </if>
                 <if test='sOcnCd != null and sOcnCd != ""'>
                   AND A.OCN_CD = #{sOcnCd}
                 </if>
                 <if test='sExtColorCd != null and sExtColorCd != ""'>
                   AND A.EXT_COLOR_CD =  #{sExtColorCd}
                 </if>
                 <if test='sIntColorCd != null and sIntColorCd != ""'>
                   AND A.INT_COLOR_CD =   #{sIntColorCd}
                 </if>
                 <if test='sFscCd != null and sFscCd != "" and sFscCd != "None"'>
                   AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
                 </if>
                 <if test='sFscCd == "None"'>
                   AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD) IS NULL
                 </if>

                 <if test='sOrdPrid != null and sOrdPrid != ""'>
                   AND B.ORD_YY_MM_DT = SUBSTR(#{sOrdPrid}, 1, 6)
                   AND B.ORD_PRID = SUBSTR(#{sOrdPrid}, 7, 2)
                 </if>

                 <if test='sOrdDtS != null' >
                   AND C.ORD_DT <![CDATA[ >= ]]> #{sOrdDtS}
                 </if>
                 <if test='sOrdDtE != null' >
                   AND C.ORD_DT <![CDATA[ < ]]> #{sOrdDtE} +1
                 </if>
                )
    </select>
    <select id="selectNotAssignedOrderCancelSearch" parameterType="NotAssignedOrderSearchVO" resultType="NotAssignedOrderVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.*
            FROM (
                    SELECT A.ADJ_STAT_CD
                         , A.ORD_YYMM
                         , A.ORD_WEEK
                         , A.ASK_DT
                         , A.ORD_SEQ
                         , A.SORD AS ORD_TYPE
                         , ( SELECT '['|| A.SORD ||']'||Z1.CMM_CD_NM
                               FROM (SELECT A.CMM_CD
                                          , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                       FROM CM_0303T A
                                      LEFT OUTER JOIN CM_0304T B
                                            ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                           AND A.CMM_CD = B.CMM_CD
                                           AND B.LANG_CD = #{sLangCd}
                                     WHERE A.CMM_GRP_CD = 'SAL138'   /*오더유형*/
                                       AND A.USE_YN = 'Y'
                                     ) Z1
                             WHERE A.SORD = Z1.CMM_CD
                           ) AS ORD_TP_NM             -- 주문유형
                         , A.SALES_NO
                         -- , A.SEQ
                         , A.ORD_DT
                         , FN_GET_CARLINE_NM_NC(A.CARLINE_CD) AS CARLINE_NM
                         , A.CARLINE_CD
                         , FN_GET_MODEL_TP_NM(A.MODEL_CD, A.OCN_CD) AS MODEL_NM
                         , A.MODEL_CD
                         , FN_GET_OCN_NM_NC(A.MODEL_CD, A.OCN_CD) AS OCN_NM
                         , A.OCN_CD
                         , FN_GET_EXT_COLOR_NM_NC(A.EXT_COLOR_CD) AS EXT_COLOR_NM
                         , A.EXT_COLOR_CD
                         , FN_GET_INT_COLOR_NM_NC(A.INT_COLOR_CD) AS INT_COLOR_NM
                         , A.INT_COLOR_CD
                         , C.REG_USR_ID AS CHRG_CD
                         , TO_DATE(DECODE(B.INNO, '00000000', NULL, B.INNO),'YYYYMMDD') AS ORDP_EXNO
                         , CASE WHEN C.ORD_QTY <![CDATA[>]]> 1 THEN 1
                                ELSE C.ORD_QTY
                                  END AS ORTY
                         , A.DLR_CD
                         , C.SALE_RGST_ID
                          ,(SELECT Z.USR_NM
                                FROM CM_0801T Z
                               WHERE Z.USR_ID = C.SALE_RGST_ID
                          ) AS SALE_RGST_NM
                          ,C.REG_USR_ID AS ORD_RGST_ID
                          ,C.ORD_GRADE_CD
                      FROM (
                            SELECT A.DLR_CD
                                    , A.ORD_YYMM
                                    , A.ORD_WEEK
                                    , A.ORD_SEQ
                                    , A.SORD
                                    , A.SALES_NO
                                    , A.SEQ
                                    , A.ORD_DT
                                    , A.CARLINE_CD
                                    , A.MODEL_CD
                                    , A.OCN_CD
                                    , A.EXT_COLOR_CD
                                    , A.INT_COLOR_CD
                                    , A.ADJ_STAT_CD
                                    , A.TEMP1
                                    , A.TEMP2
                                    , A.TEMP3
                                    , A.TEMP4
                                    , A.TEMP5
                                    , A.REG_USR_ID
                                    , A.REG_DT
                                    , A.UPDT_USR_ID
                                    , A.UPDT_DT
                                    , B.ASK_DT
                                    , A.CNC_DT
                                    , A.ASK_CNC_DT
                              FROM SA_0453T A
                                 , (
                                    SELECT DLR_CD
                                         , ORD_YYMM
                                         , ORD_WEEK
                                         , ORD_SEQ
                                         , SORD
                                         , SALES_NO
                                         , MAX(SEQ) AS SEQ
                                         , MAX(ASK_DT) AS ASK_DT
                                      FROM SA_0453T
                                     GROUP BY DLR_CD, ORD_YYMM, ORD_WEEK, ORD_SEQ, SORD, SALES_NO
                                    ) B
                              WHERE A.DLR_CD = B.DLR_CD
                                AND A.ORD_YYMM = B.ORD_YYMM
                                AND A.ORD_WEEK = B.ORD_WEEK
                                AND A.ORD_SEQ = B.ORD_SEQ
                                AND A.SORD = B.SORD
                                AND A.SALES_NO = B.SALES_NO
                                AND A.SEQ = B.SEQ
                                <if test='sAskDtS != null ' >
                                   AND B.ASK_DT <![CDATA[ >= ]]> TRUNC(#{sAskDtS},'DD')
                                 </if>
                                 <if test='sAskDtE != null ' >
                                   AND B.ASK_DT <![CDATA[ < ]]> TRUNC(#{sAskDtE},'DD') +1
                                 </if>
                          ) A
                        , SA_0416T B
                        , SA_0417T C
                     WHERE 1 = 1
                       AND A.DLR_CD = B.DLR_CD
                       AND A.ORD_YYMM = B.ORD_YYMM
                       AND A.ORD_WEEK = B.ORD_WEEK
                       AND A.CARLINE_CD = B.CARLINE_CD
                       AND A.ORD_SEQ = B.ORD_SEQ
                       AND A.SORD = B.SORD
                       AND A.SALES_NO = B.SALES_NO
                       AND B.DLR_CD = C.DLR_CD
                       AND B.ORD_YYMM = C.ORD_YY_MM_DT
                       AND B.ORD_WEEK = C.ORD_PRID
                       AND B.CARLINE_CD = C.CARLINE_CD
                       AND B.ORD_SEQ = TO_NUMBER(C.ORD_NO)
                       AND B.SORD = C.ORD_TP

                       AND A.ADJ_STAT_CD != 'C'
                     <if test='sAdjStatCd != null and sAdjStatCd != ""'>
                       AND A.ADJ_STAT_CD = #{sAdjStatCd}
                     </if>
                     <if test='sDlrCd != null and sDlrCd != ""'>
                       AND A.DLR_CD = #{sDlrCd}
                     </if>
                     <if test='sOrdTp != null and sOrdTp != ""'>
                       AND A.SORD = #{sOrdTp}
                     </if>
                     <if test='sCarlineCd != null and sCarlineCd != ""'>
                       AND A.CARLINE_CD = #{sCarlineCd}
                     </if>
                     <if test='sModelCd != null and sModelCd != ""'>
                       AND A.MODEL_CD = #{sModelCd}
                     </if>
                     <if test='sOcnCd != null and sOcnCd != ""'>
                       AND A.OCN_CD = #{sOcnCd}
                     </if>
                     <if test='sExtColorCd != null and sExtColorCd != ""'>
                       AND A.EXT_COLOR_CD =  #{sExtColorCd}
                     </if>
                     <if test='sIntColorCd != null and sIntColorCd != ""'>
                       AND A.INT_COLOR_CD =   #{sIntColorCd}
                     </if>
                     <if test='sFscCd != null and sFscCd != "" and sFscCd != "None"'>
                       AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
                     </if>
                     <if test='sFscCd == "None"'>
                       AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD) IS NULL
                     </if>

                     <if test='sOrdPrid != null and sOrdPrid != ""'>
                       AND B.ORD_YY_MM_DT = SUBSTR(#{sOrdPrid}, 1, 6)
                       AND B.ORD_PRID = SUBSTR(#{sOrdPrid}, 7, 2)
                     </if>

                     <if test='sOrdDtS != null' >
                       AND C.ORD_DT <![CDATA[ >= ]]> #{sOrdDtS}
                     </if>
                     <if test='sOrdDtE != null' >
                       AND C.ORD_DT <![CDATA[ < ]]> #{sOrdDtE} +1
                     </if>
                   ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "adjStatCd"'>A.ADJ_STAT_CD <choose><when test='item.dir == "saleRgstNm"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ordpCndy"'>A.ORD_YYMM || '-' || A.ORD_WEEK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ordDt"'>A.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "salesNo"'>A.SALES_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "sord"'>ORD_TYPE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "carlineNm"'>CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "modelNm"'>MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ocnNm"'>OCN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "extColorNm"'>EXT_COLOR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "intColorNm"'>INT_COLOR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ordpExno"'>ORDP_EXNO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ordRgstId"'>ORD_RGST_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "saleRgstId"'>C.SALE_RGST_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "orty"'>ORTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "askDt"'>A.ASK_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "askDtFormat"'>A.ASK_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "ordDtFormat"'>A.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                       A.ASK_DT, ORD_DT, ORD_TYPE, A.CARLINE_CD, A.MODEL_CD, A.OCN_CD, A.EXT_COLOR_CD, A.INT_COLOR_CD
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.ASK_DT, ORD_DT, ORD_TYPE, A.CARLINE_CD, A.MODEL_CD, A.OCN_CD, A.EXT_COLOR_CD, A.INT_COLOR_CD
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

</mapper>