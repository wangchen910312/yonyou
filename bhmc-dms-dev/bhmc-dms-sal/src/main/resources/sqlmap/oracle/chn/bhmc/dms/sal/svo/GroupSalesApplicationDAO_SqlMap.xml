<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO">


    <!-- 집단판매 목록 갯수  -->
    <select id="selectGroupSalesApplicationByConditionCnt" parameterType="GroupSalesApplicationSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationByConditionCnt] */

            SELECT COUNT(A.REQ_SAL_NO) AS VALUE
              FROM SA_0414T A
             WHERE A.DLR_CD  = #{sDlrCd}
             <if test='sApplyDtS !=null'>
               AND A.APPLY_DT <![CDATA[>=]]> TRUNC(#{sApplyDtS},'DD')
             </if>
             <if test='sApplyDtE !=null'>
               AND A.APPLY_DT <![CDATA[<]]> TRUNC(#{sApplyDtE},'DD')+1
             </if>
            <if test='sCustNm != null and sCustNm != ""'>
               AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
            </if>
            <if test='sApplyNo != null and sApplyNo != ""'>
               AND A.REQ_SAL_NO LIKE '%'||#{sApplyNo}||'%'
            </if>
            <if test='sApproveCd != null and sApproveCd != ""'>
               AND A.APPROVE_CD  = #{sApproveCd}
            </if>
    </select>

    <!-- 조회 목록  -->
    <select id="selectGroupSalesApplicationByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationByCondition] */

       SELECT *
         FROM (
              SELECT ROWNUM AS RNUM , T1.*
                FROM (
                    SELECT A.DLR_CD
                          ,A.EVAL_GRADE_CD
                          ,A.LAST_APPROVE_CNT
                          ,A.LAST_APPROVE_DT
                          ,A.REQ_SAL_NO    AS APPLY_NO                  --신청번호
                          ,A.CUST_NM
                          ,A.ATC_DSTIN_CD
                          ,A.APPLY_DT
                          ,(
                             SELECT NVL(SUM(1),0)
                               FROM SA_0413T
                              WHERE DLR_CD  = A.DLR_CD
                                AND USR_ID  = A.USR_ID
                                AND REQ_SEQ = A.REQ_SEQ
                            )AS REQ_QTY                                  --배정수량
                          ,A.DLR_CD
                          ,A.USR_ID
                          ,A.REQ_SEQ
                          ,A.APPROVE_CD
                          ,(
                             SELECT MAX(EVAL_DT)
                               FROM SA_0412T
                              WHERE DLR_CD  = A.DLR_CD
                                AND USR_ID  = A.USR_ID
                                AND REQ_SEQ = A.REQ_SEQ
                                AND REQ_NO = '3'
                          )AS EVAL_DT

                          , ( SELECT Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL184'
                                   AND A.USE_YN = 'Y'
                                 ) Z1
                         WHERE A.APPROVE_CD = Z1.CMM_CD
                       ) AS APPROVE_NM


                          , ( SELECT Z1.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL151'
                                 ) Z1
                         WHERE A.ATC_DSTIN_CD = Z1.CMM_CD
                       ) AS ATC_DSTIN_NM


                      FROM SA_0414T A
                     WHERE A.DLR_CD  = #{sDlrCd}
                     <if test='sApplyDtS !=null'>
                       AND A.APPLY_DT <![CDATA[>=]]> TRUNC(#{sApplyDtS},'DD')
                     </if>
                     <if test='sApplyDtE !=null'>
                       AND A.APPLY_DT <![CDATA[<]]> TRUNC(#{sApplyDtE},'DD')+1
                     </if>
                    <if test='sCustNm != null and sCustNm != ""'>
                       AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                    </if>
                    <if test='sApplyNo != null and sApplyNo != ""'>
                       AND A.REQ_SAL_NO LIKE '%'||#{sApplyNo}||'%'
                    </if>
                    <if test='sApproveCd != null and sApproveCd != ""'>
                       AND A.APPROVE_CD  = #{sApproveCd}
                    </if>
                    ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "applyNo"'>APPLY_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custNm"'>CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "atcDstinCd"'>ATC_DSTIN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "reqQty"'>REQ_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "applyDt"'>APPLY_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "approveCd"'>APPROVE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "assignQty"'>ASSIGN_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    REQ_SEQ DESC
                                </otherwise>
                            </choose>
                         </foreach>
                    </when>
                    <otherwise>
                            REQ_SEQ DESC
                    </otherwise>
                </choose>
            )T1
                <where>
                    <if test='firstIndex != -1 and lastIndex != -1'>
                      AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                    </if>
                    <if test='sConfirmDtS !=null'>
                       AND EVAL_DT <![CDATA[>=]]> TRUNC(#{sConfirmDtS},'DD')
                     </if>
                     <if test='sConfirmDtE !=null'>
                       AND EVAL_DT <![CDATA[<]]> TRUNC(#{sConfirmDtE},'DD')+1
                     </if>
                </where>

         )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 집단오더 판매 상세 조회 -->
    <select id="selectGroupSalesApplicationDetailByKey" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationDetailByKey] */

            SELECT *
             FROM (
             SELECT A.DLR_CD
                   ,A.USR_ID
                   ,A.REQ_SEQ
                   ,A.CUST_NM
                   ,A.PRSN_ID
                   ,A.ZIP_CD
                   ,A.ADDR
                   ,A.HP_NO
                   ,A.FAX_NO
                   ,A.ATC_DSTIN_CD
                   ,A.ATC_CONT
                   ,A.CAR_USE_TP
                   ,A.PRSN_DLR_CD
                   ,A.PRSN_DLR_TEL_NO
                   ,A.LONG_DCSS_YN
                   ,TO_DATE(A.CAR_ALLOC_HOPE_DT, 'YYYYMMDD') AS CAR_ALLOC_HOPE_DT
                   ,A.RETL_AMT
                   ,A.RCPT_AMT
                   ,A.DC_AMT
                   ,A.TEL_NO
                   ,A.APPROVE_CD
                   ,A.FILE_DOC_ID
                   ,NVL(MAX(CASE WHEN A.CONTRACT_DOC_SEQ = B.FILE_NO THEN FILE_NO END ) ,0) AS CONTRACT_FILE_NO
                   ,MAX(CASE WHEN A.CONTRACT_DOC_SEQ = B.FILE_NO THEN FILE_NM END ) AS CONTRACT_FILE_NM
                   ,NVL(MAX(CASE WHEN A.CRN_DOC_SEQ = B.FILE_NO THEN FILE_NO END ) ,0) AS BUSS_LICENCE_FILE_NO
                   ,MAX(CASE WHEN A.CRN_DOC_SEQ = B.FILE_NO THEN FILE_NM END ) AS BUSS_LICENCE_FILE_NM
                   ,NVL(MAX(CASE WHEN A.ETC_DOC_SEQ = B.FILE_NO THEN FILE_NO END ) ,0) AS ETC_FILE_NO
                   ,MAX(CASE WHEN A.ETC_DOC_SEQ = B.FILE_NO THEN FILE_NM END ) AS ETC_FILE_NM
                   ,NVL(MAX(CASE WHEN A.ADD_FILE_SEQ = B.FILE_NO THEN FILE_NO END ) ,0) AS ADD_FILE_NO
                   ,MAX(CASE WHEN A.ADD_FILE_SEQ = B.FILE_NO THEN FILE_NM END ) AS ADD_FILE_NM
              FROM SA_0414T A LEFT OUTER JOIN  CM_0902T B
               ON  B.FILE_DOC_NO = A.FILE_DOC_ID
             WHERE A.DLR_CD  = #{sDlrCd}
               AND A.USR_ID  = #{sUsrId}
               AND A.REQ_SEQ = #{sReqSeq}
               GROUP BY A.DLR_CD
                       ,A.USR_ID
                       ,A.REQ_SEQ
                       ,A.CUST_NM
                       ,A.PRSN_ID
                       ,A.ZIP_CD
                       ,A.ADDR
                       ,A.HP_NO
                       ,A.FAX_NO
                       ,A.ATC_DSTIN_CD
                       ,A.ATC_CONT
                       ,A.CAR_USE_TP
                       ,A.PRSN_DLR_CD
                       ,A.PRSN_DLR_TEL_NO
                       ,A.LONG_DCSS_YN
                       ,CAR_ALLOC_HOPE_DT
                       ,A.RETL_AMT
                       ,A.RCPT_AMT
                       ,A.DC_AMT
                       ,A.TEL_NO
                       ,A.APPROVE_CD
                       ,A.FILE_DOC_ID
             )

    </select>

    <select id="selectGroupSalesApplicationDetailByCondition" parameterType="GroupSalesApplicationVO" resultType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationDetailByCondition] */
        SELECT DLR_CD,USR_ID,REQ_SEQ,CUST_NM,PRSN_ID,ZIP_CD,ADDR,HP_NO,FAX_NO,ATC_DSTIN_CD,ATC_CONT
             , CAR_USE_TP,PRSN_DLR_CD,PRSN_DLR_TEL_NO,LONG_DCSS_YN,CAR_ALLOC_HOPE_DT,FILE_DOC_ID
             , RETL_AMT,RCPT_AMT,DC_AMT,APPROVE_CD,TEL_NO
             , MAX(CONTRACT_FILE_NM) AS CONTRACT_FILE_NM
             , MAX(BUSS_LICENCE_FILE_NM) AS BUSS_LICENCE_FILE_NM,MAX(ETC_FILE_NM) AS ETC_FILE_NM
             , MAX(ADD_FILE_NM) AS ADD_FILE_NM
             , NVL(MAX(CONTRACT_FILE_NO),0) AS CONTRACT_FILE_NO
             , NVL(MAX(BUSS_LICENCE_FILE_NO),0) AS BUSS_LICENCE_FILE_NO
             , NVL(MAX(ETC_FILE_NO),0) AS ETC_FILE_NO
             , NVL(MAX(ADD_FILE_NO),0) AS ADD_FILE_NO
        FROM (
                SELECT A.DLR_CD
                     , A.USR_ID
                     , A.REQ_SEQ
                     , A.CUST_NM
                     , A.PRSN_ID
                     , A.ZIP_CD
                     , A.ADDR
                     , A.HP_NO
                     , A.FAX_NO
                     , A.ATC_DSTIN_CD
                     , A.ATC_CONT
                     , A.CAR_USE_TP
                     , A.PRSN_DLR_CD
                     , A.PRSN_DLR_TEL_NO
                     , A.LONG_DCSS_YN
                     , TO_DATE(A.CAR_ALLOC_HOPE_DT, 'YYYYMMDD') AS CAR_ALLOC_HOPE_DT
                     , A.FILE_DOC_ID
                     , A.RETL_AMT
                     , A.RCPT_AMT
                     , A.DC_AMT
                     , A.TEL_NO
                     , A.APPROVE_CD
                     , CASE WHEN A.CONTRACT_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS CONTRACT_FILE_NM
                     , CASE WHEN A.CRN_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS BUSS_LICENCE_FILE_NM
                     , CASE WHEN A.ETC_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS ETC_FILE_NM
                     , CASE WHEN A.ADD_FILE_SEQ = D.FILE_NO THEN FILE_NM END AS ADD_FILE_NM
                     , CASE WHEN A.CONTRACT_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS CONTRACT_FILE_NO
                     , CASE WHEN A.CRN_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS BUSS_LICENCE_FILE_NO
                     , CASE WHEN A.ETC_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS ETC_FILE_NO
                     , CASE WHEN A.ADD_FILE_SEQ = D.FILE_NO THEN FILE_NO END AS ADD_FILE_NO
                  FROM SA_0414T A,
                       (SELECT B.FILE_DOC_NO,C.FILE_NO,C.FILE_TP,C.FILE_NM,C.FILE_SIZE,C.FILE_DATA
                          FROM CM_0901T B, CM_0902T C
                         WHERE 1=1
                           AND B.FILE_DOC_NO = C.FILE_DOC_NO
                       ) D
                 WHERE A.FILE_DOC_ID = D.FILE_DOC_NO(+)
                   AND A.DLR_CD = #{dlrCd}
                   AND A.USR_ID = #{usrId}
                   AND A.REQ_SEQ = #{reqSeq}
             )
       GROUP BY DLR_CD,USR_ID,REQ_SEQ,CUST_NM,PRSN_ID,ZIP_CD,ADDR,HP_NO,FAX_NO,ATC_DSTIN_CD,ATC_CONT
               ,CAR_USE_TP,PRSN_DLR_CD,PRSN_DLR_TEL_NO,LONG_DCSS_YN,CAR_ALLOC_HOPE_DT
               ,FILE_DOC_ID,RETL_AMT,RCPT_AMT,DC_AMT,APPROVE_CD,TEL_NO

    </select>

    <!-- 조회 목록  -->
    <select id="selectGroupSalesApplicationDetVehByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationDetVehByCondition] */
        SELECT DLR_CD,USR_ID,REQ_SEQ,CARLINE_CD,CARLINE_NM,MODEL_CD,MODEL_NM
             , COUNT(CARLINE_CD) AS CNT,REQ_QTY
          FROM (
                SELECT SA0414.DLR_CD AS DLR_CD
                     , SA0414.USR_ID AS USR_ID
                     , SA0414.REQ_SEQ AS REQ_SEQ
                     , SA0413.REQ_NO AS REQ_NO
                     , SA0415.CARLINE_CD AS CARLINE_CD
                     , FN_GET_CARLINE_NM_NC(SA0415.CARLINE_CD) AS CARLINE_NM
                     , SA0415.MODEL_CD AS MODEL_CD
                     , FN_GET_MODEL_NM_NC(SA0415.MODEL_CD) AS MODEL_NM
                     , SA0415.OCN_CD
                     , FN_GET_OCN_NM_NC(SA0415.MODEL_CD,SA0415.OCN_CD) AS OCN_NM
                     , SA0415.EXT_COLOR_CD
                     , FN_GET_EXT_COLOR_NM_NC(SA0415.EXT_COLOR_CD) AS EXT_COLOR_NM
                 	 , SA0415.INT_COLOR_CD
                 	 , FN_GET_INT_COLOR_NM_NC(SA0415.INT_COLOR_CD) AS INT_COLOR_NM
                     , SA0415.REQ_QTY
                  FROM SA_0414T SA0414
                     , SA_0415T SA0415
                     , SA_0413T SA0413
                 WHERE SA0414.DLR_CD = #{sDlrCd}
                   AND SA0414.USR_ID = #{sUsrId}
                   AND SA0414.REQ_SEQ = #{sReqSeq}
                   AND SA0414.DLR_CD = SA0415.DLR_CD
                   AND SA0414.USR_ID = SA0415.USR_ID
                   AND SA0414.REQ_SEQ = SA0415.REQ_SEQ
                   AND SA0415.DLR_CD = SA0413.DLR_CD
                   AND SA0415.USR_ID = SA0413.USR_ID
                   AND SA0415.REQ_SEQ = SA0413.REQ_SEQ
                   AND SA0415.REQ_LOWER_SEQ = SA0413.REQ_LOWER_SEQ
               )
         GROUP BY DLR_CD,USR_ID,REQ_SEQ,CARLINE_CD,CARLINE_NM,MODEL_CD,MODEL_NM,REQ_QTY
    </select>

    <!-- 조회 목록  -->
    <select id="selectGroupSalesApplicationDetJdgByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationJdgVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationDetJdgByCondition] */
        SELECT DLR_CD
             , USR_ID
             , REQ_SEQ
             , REQ_NO
             , SUBSTR(PEVAL_ID,INSTR(PEVAL_ID,',')+1, LENGTH(PEVAL_ID) ) AS PEVAL_ID
             , EVAL_DT
             , FN_CMM_CD_NM('SAL131',EVAL_RSLT_YN, #{sLangCd},'N') AS EVAL_RSLT_YN
             , REMARK
          FROM SA_0412T
         WHERE DLR_CD = #{sDlrCd}
           AND USR_ID = #{sUsrId}
           AND REQ_SEQ = #{sReqSeq}
           <!-- 심사이력을 갖고 오는것 같은데, 마지막 이력을 갖고 오고 있어 주석처리함. 필요시 다시 해제,불필요시 삭제 (09.27 kim yewon)
           AND REQ_NO = ( SELECT MAX(REQ_NO) FROM SA_0412T
                           WHERE DLR_CD = #{sDlrCd}
                             AND USR_ID = #{sUsrId}
                             AND REQ_SEQ = #{sReqSeq}
                           GROUP BY DLR_CD, USR_ID, REQ_SEQ )
           -->
         ORDER BY REG_DT DESC
    </select>

    <!-- 법인 - 집단판매 신청 저장 -->
    <insert id="insertGroupSalesApplication" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.insertGroupSalesApplication] */
        <selectKey resultType="int" keyProperty="reqSeq" order="BEFORE">
            SELECT NVL(MAX(REQ_SEQ), 0) + 1 AS REQ_SEQ FROM SA_0414T
             WHERE DLR_CD = #{dlrCd}
        </selectKey>
        INSERT
          INTO SA_0414T(
               DLR_CD
             , USR_ID
             , REQ_SEQ
             , EVAL_GRADE_CD
             , CUST_NM
             , ZIP_CD
             , ADDR
             , PRSN_ID
             , HP_NO
             , FAX_NO
             , ATC_DSTIN_CD
             , CAR_USE_TP
             , ATC_CONT
             , PRSN_DLR_CD
             , PRSN_DLR_TEL_NO
             , APPROVE_CD
             , APPLY_DT
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
             , FILE_DOC_ID
             , CONTRACT_DOC_SEQ
             , CRN_DOC_SEQ
             , ETC_DOC_SEQ
             , ADD_FILE_SEQ
             , RETL_AMT
             , RCPT_AMT
             , DC_AMT
             , TEL_NO
             , REQ_SAL_NO
         )VALUES(
               #{dlrCd}
             , #{usrId}
             , #{reqSeq}
             , (SELECT GRADE_CD FROM SA_0435T WHERE WRK_DSTIN_CD = '01')
             , #{custNm}
             , #{zipCd}
             , #{addr}
             , #{prsnId}
             , #{hpNo}
             , #{faxNo}
             , #{atcDstinCd}
             , #{carUseTp}
             , #{atcCont}
             , #{prsnDlrCd}
             , #{prsnDlrTelNo}
             , #{approveCd}
             , SYSDATE
             , #{regUsrId}
             , SYSDATE
             , #{updtUsrId}
             , SYSDATE
             , #{headFileDocId}
             , #{contractFileNo}
             , #{bussLicenceNo}
             , #{etcFileNo}
             , #{addFileNo}
             , #{retlAmt}
             , #{rcptAmt}
             , #{dcAmt}
             , #{telNo}
             , (SELECT #{dlrCd}||TO_CHAR(SYSDATE, 'YYMM')||LPAD(TO_CHAR(NVL(SUBSTR(MAX(REQ_SAL_NO),10,12), 0)+1), 3, '0')
                  FROM SA_0414T
                 WHERE DLR_CD = #{dlrCd}
                   AND SUBSTR(REQ_SAL_NO, 1, 9) = #{dlrCd}||TO_CHAR(SYSDATE, 'YYMM'))
        )
    </insert>

    <!-- 법인 - 집단 판매 신청 확정 -->
    <update id="updateGroupSalesApplicationCnfrm" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.updateGroupSalesApplicationCnfrm] */
        UPDATE SA_0414T
           SET APPROVE_CD = 'B'
             , APPLY_DT = SYSDATE
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </update>

    <!-- 법인 - 집단 판매 신청 수정 -->
    <update id="updateGroupSalesApplication" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.updateGroupSalesApplication] */
        UPDATE SA_0414T
           SET CUST_NM          = #{custNm}
              ,ZIP_CD           = #{zipCd}
              ,APPROVE_CD       = #{approveCd}
              ,ADDR             = #{addr}
              ,PRSN_ID          = #{prsnId}
              ,HP_NO            = #{hpNo}
              ,TEL_NO           = #{telNo}
              ,FAX_NO           = #{faxNo}
              ,ATC_DSTIN_CD     = #{atcDstinCd}
              ,CAR_USE_TP       = #{carUseTp}
              ,ATC_CONT         = #{atcCont}
              ,PRSN_DLR_CD      = #{prsnDlrCd}
              ,PRSN_DLR_TEL_NO  = #{prsnDlrTelNo}
              ,RETL_AMT         = #{whPrc}
              ,RCPT_AMT         = #{rcptAmt}
              ,DC_AMT           = #{dcAmt}
              ,FILE_DOC_ID      = #{headFileDocId}
              ,CONTRACT_DOC_SEQ = #{contractFileNo}
              ,CRN_DOC_SEQ      = #{bussLicenceNo}
              ,ETC_DOC_SEQ      = #{etcFileNo}
              ,ADD_FILE_SEQ     = #{addFileNo}
              ,UPDT_USR_ID      = #{updtUsrId}
              ,UPDT_DT          = SYSDATE
         WHERE DLR_CD           = #{dlrCd}
           AND USR_ID           = #{usrId}
           AND REQ_SEQ          = #{reqSeq}
    </update>

    <!-- 법인 - 집단 판매신청 삭제 -->
    <delete id="deleteGroupSalesApplication" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.deleteGroupSalesApplication] */
        DELETE FROM SA_0414T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </delete>

    <!-- 법인 - 집단판매 신청 차량정보 저장 -->
    <insert id="insertGroupSalesApplicationVeh" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.insertGroupSalesApplicationVeh] */
        <selectKey resultType="int" keyProperty="reqLowerSeq" order="BEFORE">
            SELECT NVL(MAX(REQ_LOWER_SEQ), 0) + 1 AS REQ_LOWER_SEQ FROM SA_0415T
             WHERE DLR_CD = #{dlrCd}
               AND REQ_SEQ = #{reqSeq}
        </selectKey>
        INSERT
          INTO SA_0415T(
               DLR_CD
             , USR_ID
             , REQ_SEQ
             , REQ_LOWER_SEQ
             , CARLINE_CD
             , MODEL_CD
             , OCN_CD
             , EXT_COLOR_CD
             , INT_COLOR_CD
             , REQ_QTY
             , REG_USR_ID
             , REG_DT
         )VALUES(
               #{dlrCd}
             , #{usrId}
             , #{reqSeq}
             , #{reqLowerSeq}
             , #{carlineCd}
             , #{modelCd}
             , #{ocnCd}
             , #{extColorCd}
             , #{intColorCd}
             , 1
             , #{regUsrId}
             , SYSDATE
         )
    </insert>

    <!-- 조회 목록  -->
    <select id="selectGroupSalesApplicationDetGrpByCondition" parameterType="GroupSalesApplicationVehVO" resultType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationDetGrpByCondition] */
        SELECT DLR_CD
             , USR_ID
             , REQ_SEQ
             , REQ_LOWER_SEQ
             , MAX(CARLINE_CD) AS CARLINE_CD
             , MAX(MODEL_CD) AS MODEL_CD
             , MAX(OCN_CD) AS OCN_CD
             , MAX(EXT_COLOR_CD) AS EXT_COLOR_CD
             , MAX(INT_COLOR_CD) AS INT_COLOR_CD
             , COUNT(*) AS REQ_QTY
             , #{regUsrId} AS REG_USR_ID
             , SYSDATE AS REG_DT
             , #{updtUsrId} AS UPDT_USR_ID
             , SYSDATE AS UPDT_DT
          FROM SA_0413T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
         GROUP BY DLR_CD, USR_ID, REQ_SEQ, REQ_LOWER_SEQ
    </select>

    <!-- 법인 - 집단판매 신청 차량정보 수정 -->
    <update id="updateGroupSalesApplicationVeh" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.updateGroupSalesApplicationVeh] */
        UPDATE SA_0415T
           SET CARLINE_CD = #{carlineCd}
             , MODEL_CD = #{modelCd}
             , OCN_CD = #{ocnCd}
             , EXT_COLOR_CD = #{extColorCd}
             , INT_COLOR_CD = #{intColorCd}
             , REQ_QTY = #{reqQty}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_NO = #{reqNo}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
    </update>

    <!-- 법인 - 집단 판매신청 차량정보 삭제 -->
    <delete id="deleteGroupSalesApplicationVeh" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.deleteGroupSalesApplicationVeh] */
        DELETE FROM SA_0415T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </delete>

    <!-- 법인 - 집단판매 신청 차량 상세정보 저장 -->
    <insert id="insertGroupSalesApplicationVehDet" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.insertGroupSalesApplicationVehDet] */
        <selectKey resultType="int" keyProperty="reqNo" order="BEFORE">
            SELECT NVL(MAX(REQ_NO), 0) + 1 AS REQ_NO FROM SA_0413T
             WHERE DLR_CD = #{dlrCd}
               AND USR_ID = #{usrId}
               AND REQ_SEQ = #{reqSeq}
               AND REQ_LOWER_SEQ = #{reqLowerSeq}
        </selectKey>
        INSERT
          INTO SA_0413T(
               DLR_CD
             , USR_ID
             , REQ_SEQ
             , REQ_LOWER_SEQ
             , REQ_NO
             , CARLINE_CD
             , MODEL_CD
             , OCN_CD
             , EXT_COLOR_CD
             , INT_COLOR_CD
             , STOCK_VIN_NO1
             , STOCK_VIN_NO2
             , FILE_DOC_ID
             , ENGIN_NO
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
         )VALUES(
               #{dlrCd}
             , #{usrId}
             , #{reqSeq}
             , #{reqLowerSeq}
             , #{reqNo}
             , #{carlineCd}
             , #{modelCd}
             , #{ocnCd}
             , #{extColorCd}
             , #{intColorCd}
             , SUBSTR(#{vinNo}, 1, 11)
             , SUBSTR(#{vinNo}, 12, 6)
             , #{fileDocId}
             , #{enginNo}
             , #{regUsrId}
             , SYSDATE
             , #{updtUsrId}
             , SYSDATE
        )
    </insert>

    <!-- 시승차량신청 팝업 차량 수정 -->
    <update id="updateGroupSalesApplicationVehDet" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.updateGroupSalesApplicationVehDet] */
        UPDATE SA_0413T
           set CARLINE_CD = #{carlineCd}
             , MODEL_CD = #{modelCd}
             , OCN_CD = #{ocnCd}
             , EXT_COLOR_CD = #{extColorCd}
             , INT_COLOR_CD = #{intColorCd}
             , SPC_CAR_QTY = #{spcCarQty}
             , STOCK_VIN_NO1 = SUBSTR(#{vinNo}, 1, 11)
             , STOCK_VIN_NO2 = SUBSTR(#{vinNo}, 12, 6)
             , ENGIN_NO = #{enginNo}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
           AND REQ_NO = #{reqNo}
    </update>

    <!-- 법인 - 집단 판매신청 차량 상세정보 삭제 -->
    <delete id="deleteGroupSalesApplicationVehDet" parameterType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.deleteGroupSalesApplicationVehDet] */
        DELETE FROM SA_0413T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </delete>

    <!-- 법인 - 집단판매 신청 팝업 적용 가능 차량 정보 조회 -->
    <select id="applyGroupSalesApplicationPopup" parameterType="GroupSalesApplicationPopupVO" resultType="GroupSalesApplicationPopupVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.applyGroupSalesApplicationPopup] */
        SELECT CARLINE_CD
             , MODEL_CD
             , OCN_CD
             , EXT_COLOR_CD
             , INT_COLOR_CD
             , VIN_NO
             , ENGIN_SERIAL_NO AS ENGIN_NO
          FROM SA_0121T
         WHERE 1=1
           AND CAR_ID = #{carId}
    </select>



    <!-- 차량마스터관리PopUp 리스트 -->
    <select id="selectVehicleInfoByConditionCnt" parameterType="GroupSalesApplicationSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectVehicleInfoByConditionCnt] */
        SELECT COUNT(*)
          FROM SA_0121T A
         WHERE 1=1
         <if test='sDlrCd != null and sDlrCd != ""'>
           AND A.ORD_DLR_CD = #{sDlrCd}
         </if>
<!--          <if test='sVinNo != null and sVinNo != ""'>
            <choose>
              <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo,"*")'>
                 <bind name='sVinNo' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo, "*", "%")' />
                  AND A.VIN_NO LIKE #{sVinNo}
              </when>
              <otherwise>
                  AND A.VIN_NO = #{sVinNo}
              </otherwise>
            </choose>
          </if> -->
          <if test='sVinNo != null and sVinNo != ""'>
            AND A.VIN_NO LIKE '%' || #{sVinNo} || '%'
          </if>
          <if test='sCarlineCd != null and sCarlineCd != ""'>
            AND A.CARLINE_CD = #{sCarlineCd}
          </if>
          <if test='sModelCd != null and sModelCd != ""'>
            AND A.MODEL_CD = #{sModelCd}
          </if>
            AND A.VIN_NO NOT IN (  SELECT SA0413.STOCK_VIN_NO1 || SA0413.STOCK_VIN_NO2 AS VIN_NO
                                             FROM SA_0413T SA0413
                                            WHERE SA0413.DLR_CD = #{sDlrCd}
                                              AND SA0413.USR_ID = #{sUsrId}
                                 )
    </select>



    <!-- 차량마스터관리 사용여부 PopUp 리스트 -->
    <select id="selectVehicleInfoUseYnByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="VehicleMasterPopupVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectVehicleInfoUseYnByCondition] */

       SELECT C.STOCK_VIN_NO1 || C.STOCK_VIN_NO2 AS VIN_NO
             ,CASE WHEN B.APPROVE_CD = 'A' THEN '01' ELSE '02' END AS USE_YN
          FROM SA_0414T B , SA_0413T C
         WHERE B.DLR_CD = C.DLR_CD
           AND B.USR_ID = C.USR_ID
           AND B.REQ_SEQ = C.REQ_SEQ
           AND C.STOCK_VIN_NO1 || C.STOCK_VIN_NO2  LIKE '%' || #{sVinNo} || '%'
           AND B.DLR_CD = #{sDlrCd}
           AND B.DEL_YN = 'N'
           AND B.APPROVE_CD IN ( 'A','B','C' )

    </select>


    <select id="selectVehicleInfoByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="VehicleMasterPopupVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectVehicleInfoByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.VIN_NO
                	 , A.CAR_ID
                     , A.CARLINE_CD
                     , FN_GET_CARLINE_NM_NC(A.CARLINE_CD) AS CARLINE_NM
                     , FN_GET_CARLINE_NM(A.CARLINE_CD) AS CARLINE_CD_NM
                     , A.MODEL_CD
                     , FN_GET_MODEL_NM_NC(A.MODEL_CD) AS MODEL_NM
                     , FN_GET_MODEL_NM(A.MODEL_CD) AS MODEL_CD_NM
                     , A.OCN_CD
                     , FN_GET_OCN_NM_NC(A.MODEL_CD, A.OCN_CD) AS OCN_NM
                     , FN_GET_OCN_NM(A.MODEL_CD,A.OCN_CD) AS OCN_CD_NM
                     , A.EXT_COLOR_CD
                     , FN_GET_EXT_COLOR_NM_NC(A.EXT_COLOR_CD) AS EXT_COLOR_NM
                     , FN_GET_EXT_COLOR_NM(A.EXT_COLOR_CD) AS EXT_COLOR_CD_NM
                 	 , A.INT_COLOR_CD
                 	 , FN_GET_INT_COLOR_NM_NC(A.INT_COLOR_CD) AS INT_COLOR_NM
                 	 , FN_GET_INT_COLOR_NM(A.INT_COLOR_CD) AS INT_COLOR_CD_NM
                     , (SELECT NVL(MAX(MS_PRC),0) FROM SA_0110T WHERE MODEL_CD = A.MODEL_CD AND OCN_CD = A.OCN_CD AND END_DT  >=  SYSDATE) AS MS_PRC
                     , NVL((SELECT 'N'
                              FROM SA_0414T B , SA_0413T C
                             WHERE B.DLR_CD = C.DLR_CD
                               AND B.USR_ID = C.USR_ID
                               AND C.STOCK_VIN_NO1 = A.VIN_NO1
                               AND C.STOCK_VIN_NO2 = A.VIN_NO2
                               AND B.DLR_CD = #{sDlrCd}
                               AND B.DEL_YN ='N'
                               AND B.APPROVE_CD IN ( 'A','B' )
                               AND ROWNUM = 1
                         ),'Y') AS USE_YN
                      , CASE WHEN B.AAMT + ABS(B.DAMT) <![CDATA[>]]> 0
                             THEN ROUND(ABS(B.DAMT)/(B.AAMT+ABS(B.DAMT))*100, 2)
                        ELSE 0 END AS DC_RATE
                      , NVL(B.AAMT,0) AS AAMT
                  FROM SA_0121T A LEFT OUTER JOIN SA_0416T B
                    ON B.VIN_NO1 = A.VIN_NO1
                   AND B.VIN_NO2 = A.VIN_NO2
                 WHERE 1=1
                 <if test='sDlrCd != null and sDlrCd != ""'>
                   AND A.ORD_DLR_CD = #{sDlrCd}
                 </if>
                  <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO LIKE '%' || #{sVinNo} || '%'
                  </if>
                  <if test='sCarlineCd != null and sCarlineCd != ""'>
                    AND A.CARLINE_CD = #{sCarlineCd}
                  </if>
                  <if test='sModelCd != null and sModelCd != ""'>
                    AND A.MODEL_CD = #{sModelCd}
                  </if>
            ) T1
        )
    </select>

    <!-- 차량마스터관리PopUp 리스트 -->
    <select id="selectDetlVehPopByConditionCnt" parameterType="GroupSalesApplicationSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectDetlVehPopByConditionCnt] */

        SELECT COUNT(A.REQ_SEQ) AS VALUE
          FROM SA_0414T A , SA_0413T B
         WHERE A.DLR_CD   = #{sDlrCd}
           AND A.USR_ID   = #{sUsrId}
           AND A.REQ_SEQ  = #{sReqSeq}
           AND B.DLR_CD   = A.DLR_CD
           AND B.USR_ID   = A.USR_ID
           AND B.REQ_SEQ  = A.REQ_SEQ

    </select>

    <!-- 집단판매 차량정보 조회 -->
    <select id="selectDetlVehPopByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectDetlVehPopByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM ,T1.* FROM (
                SELECT T.*
                      , CASE WHEN C.AAMT + ABS(C.DAMT) <![CDATA[>]]> 0
                             THEN ROUND(ABS(C.DAMT)/(C.AAMT+ABS(C.DAMT))*100, 2)
                        ELSE 0 END AS DC_RATE
                      ,C.AAMT
                  FROM (
                    SELECT A.DLR_CD
                          ,A.USR_ID
                          ,A.REQ_SEQ
                          ,A.APPROVE_CD
                          ,B.REQ_LOWER_SEQ
                          ,B.CARLINE_CD
                          ,B.MODEL_CD
                          ,B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 AS VIN_NO
                          ,B.STOCK_VIN_NO1
                          ,B.STOCK_VIN_NO2
                          ,B.FILE_DOC_ID
                          ,(
                           SELECT COUNT(FILE_NO) AS FILE_CNT
                             FROM CM_0902T
                             WHERE FILE_DOC_NO  = B.FILE_DOC_ID
                               AND DEL_YN = 'N'
                          ) AS FILE_DOC_CNT
                          ,FN_GET_CARLINE_NM_NC(B.CARLINE_CD) AS CARLINE_NM
                          ,FN_GET_MODEL_TP_NM(B.MODEL_CD,B.OCN_CD) AS MODEL_NM
                          ,B.OCN_CD
                          ,FN_GET_OCN_NM_NC(B.MODEL_CD,B.OCN_CD) AS OCN_NM
                          ,B.EXT_COLOR_CD
                          ,FN_GET_EXT_COLOR_NM_NC(B.EXT_COLOR_CD) AS EXT_COLOR_NM
                          ,B.INT_COLOR_CD
                          ,FN_GET_INT_COLOR_NM_NC(B.INT_COLOR_CD) AS INT_COLOR_NM
                          ,(SELECT NVL(MAX(MS_PRC),0) FROM SA_0110T WHERE MODEL_CD = B.MODEL_CD AND OCN_CD = B.OCN_CD AND END_DT  >=  SYSDATE) AS MS_PRC
                      FROM SA_0414T A , SA_0413T B
                     WHERE A.DLR_CD   = #{sDlrCd}
                       AND A.USR_ID   = #{sUsrId}
                       AND A.REQ_SEQ  = #{sReqSeq}
                       AND B.DLR_CD   = A.DLR_CD
                       AND B.USR_ID   = A.USR_ID
                       AND B.REQ_SEQ  = A.REQ_SEQ
                   )T LEFT OUTER JOIN SA_0416T C
                       ON T.DLR_CD   = C.DLR_CD
                      AND T.STOCK_VIN_NO1 = C.VIN_NO1
                      AND T.STOCK_VIN_NO2 = C.VIN_NO2
                ) T1
        )

    </select>



    <!-- 집단판매신청된 차량 삭제(집단판매신청명세) -->
    <delete id="deleteGroupSalesVehDetl" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.deleteGroupSalesVehDetl] */
        DELETE SA_0413T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
    </delete>



    <!-- 집단판매신청된 차량 삭제(집단판매신청서브헤더) -->
    <delete id="deleteGroupSalesVehSubHead" parameterType="GroupSalesApplicationVehVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.deleteGroupSalesVehSubHead] */
        DELETE SA_0415T
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
    </delete>


    <!-- 시승차량신청 팝업 차량 수정 (차량FILE_DOC_ID추가)-->
    <update id="updateGroupSalesFile" parameterType="GroupSalesApplicationVehVO">
        UPDATE SA_0413T
           SET FILE_DOC_ID = #{fileDocId}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
           AND REQ_LOWER_SEQ = #{reqLowerSeq}
    </update>

    <update id="deleteSaveAddFile" parameterType="GroupSalesApplicationVehVO">
        DELETE SA_0414IS
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </update>

    <!-- 집단판매 보충자료 파일업로드 (차량FILE_DOC_ID추가)-->
    <update id="updateSaveAddFile" parameterType="GroupSalesApplicationVehVO">
        UPDATE SA_0414T
           SET ADD_FILE_SEQ = #{addFileNo}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </update>

    <!-- 집단판매 보충자료 파일업로드 (차량FILE_DOC_ID추가)-->
    <update id="updateSaveAddFileForInterface" parameterType="GroupSalesApplicationVehVO">
     MERGE INTO SA_0414IS A
              USING(SELECT #{dlrCd} AS DLR_CD
                          ,#{usrId} AS USR_ID
                          ,#{reqSeq} AS REQ_SEQ
                          ,#{addFileNo} AS ADD_FILE_SEQ
                          ,(SELECT X.REG_USR_ID
                              FROM SA_0414T X
                             WHERE X.DLR_CD  = #{dlrCd}
                               AND X.USR_ID  = #{usrId}
                               AND X.REQ_SEQ = #{reqSeq}) AS REG_USR_ID
                          ,(SELECT Y.REG_DT
                              FROM SA_0414T Y
                             WHERE Y.DLR_CD  = #{dlrCd}
                               AND Y.USR_ID  = #{usrId}
                               AND Y.REQ_SEQ = #{reqSeq}) AS REG_DT
                          ,'Y' AS EVAL_YN
                          ,#{updtUsrId} AS UPDT_USR_ID
                          ,SYSDATE AS UPDT_DT
                          ,'N' AS IFRESULT
                      FROM DUAL) B
                    ON(A.DLR_CD  = B.DLR_CD
                   AND A.USR_ID  = B.USR_ID
                   AND A.REQ_SEQ = B.REQ_SEQ)
      WHEN MATCHED THEN
          UPDATE SET A.ADD_FILE_SEQ = B.ADD_FILE_SEQ
                    ,A.IFRESULT     = B.IFRESULT
                    ,A.UPDT_USR_ID  = B.UPDT_USR_ID
                    ,A.UPDT_DT      = B.UPDT_DT
                    ,A.EVAL_YN      = B.EVAL_YN
      WHEN NOT MATCHED THEN
          INSERT(A.DLR_CD
                ,A.USR_ID
                ,A.REQ_SEQ
                ,A.IFRESULT
                ,A.ADD_FILE_SEQ
                ,A.REG_USR_ID
                ,A.REG_DT
                ,A.UPDT_USR_ID
                ,A.UPDT_DT
                ,A.EVAL_YN
                )VALUES(
                 B.DLR_CD
                ,B.USR_ID
                ,B.REQ_SEQ
                ,B.IFRESULT
                ,B.ADD_FILE_SEQ
                ,B.REG_USR_ID
                ,B.REG_DT
                ,B.UPDT_USR_ID
                ,B.UPDT_DT
                ,B.EVAL_YN
                )
    </update>

    <!-- 신규  -->
    <select id="selectGroupSalesApplication" parameterType="GroupSalesApplicationVO" resultType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplication] */
		SELECT DLR_CD,USR_ID,REQ_SEQ,CUST_NM,PRSN_ID,ZIP_CD,ADDR,HP_NO,FAX_NO,ATC_DSTIN_CD,ATC_CONT
             , CAR_USE_TP,PRSN_DLR_CD,PRSN_DLR_TEL_NO,LONG_DCSS_YN,CAR_ALLOC_HOPE_DT,FILE_DOC_ID
             , RETL_AMT,RCPT_AMT,DC_AMT,APPROVE_CD,TEL_NO
             , MAX(CONTRACT_FILE_NM) AS CONTRACT_FILE_NM
             , MAX(BUSS_LICENCE_FILE_NM) AS BUSS_LICENCE_FILE_NM,MAX(ETC_FILE_NM) AS ETC_FILE_NM
             , MAX(ADD_FILE_NM) AS ADD_FILE_NM
             , NVL(MAX(CONTRACT_FILE_NO),0) AS CONTRACT_FILE_NO
             , NVL(MAX(BUSS_LICENCE_FILE_NO),0) AS BUSS_LICENCE_FILE_NO
             , NVL(MAX(ETC_FILE_NO),0) AS ETC_FILE_NO
             , NVL(MAX(ADD_FILE_NO),0) AS ADD_FILE_NO
        FROM (
                SELECT A.DLR_CD
                     , A.USR_ID
                     , A.REQ_SEQ
                     , A.CUST_NM
                     , A.PRSN_ID
                     , A.ZIP_CD
                     , A.ADDR
                     , A.HP_NO
                     , A.FAX_NO
                     , A.ATC_DSTIN_CD
                     , A.ATC_CONT
                     , A.CAR_USE_TP
                     , A.PRSN_DLR_CD
                     , A.PRSN_DLR_TEL_NO
                     , A.LONG_DCSS_YN
                     , TO_DATE(A.CAR_ALLOC_HOPE_DT, 'YYYYMMDD') AS CAR_ALLOC_HOPE_DT
                     , A.FILE_DOC_ID
                     , RETL_AMT
                     , RCPT_AMT
                     , DC_AMT
                     , A.TEL_NO
                     , APPROVE_CD
                     , CASE WHEN A.CONTRACT_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS CONTRACT_FILE_NM
                     , CASE WHEN A.CRN_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS BUSS_LICENCE_FILE_NM
                     , CASE WHEN A.ETC_DOC_SEQ = D.FILE_NO THEN FILE_NM END AS ETC_FILE_NM
                     , CASE WHEN A.ADD_FILE_SEQ = D.FILE_NO THEN FILE_NM END AS ADD_FILE_NM
                     , CASE WHEN A.CONTRACT_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS CONTRACT_FILE_NO
                     , CASE WHEN A.CRN_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS BUSS_LICENCE_FILE_NO
                     , CASE WHEN A.ETC_DOC_SEQ = D.FILE_NO THEN FILE_NO END AS ETC_FILE_NO
                     , CASE WHEN A.ADD_FILE_SEQ = D.FILE_NO THEN FILE_NO END AS ADD_FILE_NO
                  FROM SA_0414T A,
                       (SELECT B.FILE_DOC_NO,C.FILE_NO,C.FILE_TP,C.FILE_NM,C.FILE_SIZE,C.FILE_DATA
                          FROM CM_0901T B, CM_0902T C
                         WHERE 1=1
                           AND B.FILE_DOC_NO = C.FILE_DOC_NO
                       ) D
                 WHERE A.FILE_DOC_ID = D.FILE_DOC_NO(+)
                   AND A.DLR_CD = #{dlrCd}
                   AND A.USR_ID = #{usrId}
                   AND A.REQ_SEQ = #{reqSeq}
             )
       GROUP BY DLR_CD,USR_ID,REQ_SEQ,CUST_NM,PRSN_ID,ZIP_CD,ADDR,HP_NO,FAX_NO,ATC_DSTIN_CD,ATC_CONT
               ,CAR_USE_TP,PRSN_DLR_CD,PRSN_DLR_TEL_NO,LONG_DCSS_YN,CAR_ALLOC_HOPE_DT
               ,FILE_DOC_ID,RETL_AMT,RCPT_AMT,DC_AMT,APPROVE_CD,TEL_NO
    </select>


    <select id="selectGroupSalesFileByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="FileItemVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesFileByCondition] */

        SELECT ROWNUM AS RNUM , B.*
         FROM CM_0902T B
         WHERE B.DEL_YN       = 'N'
           <choose>
              <otherwise>
                <![CDATA[
                 AND B.FILE_DOC_NO IN( SELECT DISTINCT REGEXP_SUBSTR (TXT, '[^,]+', 1, LEVEL)
                                   FROM ( SELECT #{sFileDocId} AS TXT FROM DUAL)
                                 CONNECT BY LEVEL <= LENGTH(REGEXP_REPLACE (TXT, '[^,]+', '') ) + 1
                                )
                ]]>
              </otherwise>
           </choose>
    </select>

    <!-- 집단판매 재상신 시, 승인정보 삭제 -->
    <delete id="deleteGroupSalesApplicationDetJdg" parameterType="GroupSalesApplicationVO">
        DELETE FROM SA_0412T
        WHERE DLR_CD = #{dlrCd}
          AND USR_ID = #{usrId}
          AND REQ_SEQ = #{reqSeq}
    </delete>

    <!-- 법인 - 집단판매 신청 차량정보 저장. : 집단판매신청정보수신1 프로시져  -->
    <insert id="procFleetSaleFigureReq1" parameterType="GroupSalesApplicationVO" statementType="CALLABLE">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.procFleetSaleFigureReq1] */
        {CALL SP_SAL_DMS_P_0414T_IF(
              #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{usrId, mode=IN, jdbcType=VARCHAR}
            , #{reqSeq, mode=IN, jdbcType=NUMERIC}
        )}
    </insert>

    <!-- 법인 - 집단판매 신청 차량정보 저장. : 집단판매신청정보수신1 프로시져  -->
    <insert id="procFleetSaleFigureReq1RollBack" parameterType="GroupSalesApplicationVO" statementType="CALLABLE">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.procFleetSaleFigureReq1] */
        {CALL SP_SAL_DMS_P_0414T_IF_ROLLBACK(
              #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{usrId, mode=IN, jdbcType=VARCHAR}
            , #{reqSeq, mode=IN, jdbcType=NUMERIC}
            , #{orgApproveCd, mode=IN, jdbcType=VARCHAR}
        )}
    </insert>

    <!-- 법인 - 집단판매 신청 차량 상세정보 저장. : 집단판매신청정보수신2 프로시져  -->
    <insert id="procFleetSaleFigureReq2" parameterType="GroupSalesApplicationVehVO" statementType="CALLABLE">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.procFleetSaleFigureReq2] */
        {CALL SP_SAL_DMS_P_0413T_IF(
              'SAL088'
            , #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{usrId, mode=IN, jdbcType=VARCHAR}
            , #{reqSeq, mode=IN, jdbcType=NUMERIC}
            , #{reqLowerSeq, mode=IN, jdbcType=VARCHAR}
            , #{reqNo, mode=IN, jdbcType=VARCHAR}
        )}
    </insert>



    <!-- 법인 - 집단판매 신청 차량 상세정보 저장. : 집단판매신청정보수신3 프로시져  -->
    <insert id="procFleetSaleFigureReq3" parameterType="GroupSalesApplicationVehVO" statementType="CALLABLE">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.procFleetSaleFigureReq3] */
        {CALL SP_SAL_DMS_P_0415T_IF(
              'SAL089'
            , #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{usrId, mode=IN, jdbcType=VARCHAR}
            , #{reqSeq, mode=IN, jdbcType=NUMERIC}
            , #{reqLowerSeq, mode=IN, jdbcType=VARCHAR}
        )}
    </insert>

        <!-- 조회 목록  -->
    <select id="selectGroupSalesApplicationMainByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="GroupSalesApplicationVO">
    /* [chn.bhmc.dms.sal.svo.service.dao.GroupSalesApplicationDAO.selectGroupSalesApplicationMainByCondition] */

        SELECT A.DLR_CD,
               A.USR_ID,
               A.REQ_SEQ,
               A.REQ_SAL_NO,
               (SELECT OFF_NM
                  FROM CM_2601T Y
                 WHERE Y.DIVI_CD = C.SDPT_CD
                   AND Y.OFF_CD  = C.DIST_OFFICE_CD
               ) AS OFFICE_NM,
               DLR_NM,
               C.SDPT_CD,
               (SELECT DIVI_NM
                  FROM CM_2501T
                 WHERE DIVI_CD = C.SDPT_CD) AS SDPT_NM,
               C.DIST_OFFICE_CD,
               C.SALE_DLR_SUNG_CD,
               C.SALE_DLR_CITY_CD,
               A.ATC_DSTIN_CD,
               A.CUST_NM,
               A.APPLY_DT,
               A.LAST_APPROVE_DT,
               D.ORD_TP,
               FN_CMM_CD_NM('SAL137',D.ORD_TP, 'zh','N') AS ORD_TP_NM,
               B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 AS VIN_NO,
               B.CARLINE_CD,
               FN_GET_CARLINE_NM(B.CARLINE_CD) AS CARLINE_NM,
               B.MODEL_CD,
               FN_GET_FSC_NM(B.CARLINE_CD , B.MODEL_CD) AS MODEL_NM,
               B.OCN_CD,
               FN_GET_OCN_NM_NC(B.MODEL_CD,B.OCN_CD) AS OCN_NM,
               B.EXT_COLOR_CD,
               FN_GET_EXT_COLOR_NM(B.EXT_COLOR_CD) AS EXT_COLOR_NM,
               B.INT_COLOR_CD,
               (SELECT NVL(MAX(MS_PRC),0)
                  FROM SA_0110T
                 WHERE MODEL_CD = B.MODEL_CD
                   AND OCN_CD = B.OCN_CD
                   AND END_DT  >=  SYSDATE) AS MS_PRC,
               CASE WHEN E.AAMT + ABS(E.DAMT) <![CDATA[>]]> 0
                    THEN ROUND(ABS(E.DAMT)/(E.AAMT+ABS(E.DAMT))*100, 2)
               ELSE 0 END AS DC_RATE,
               E.AAMT,
               FN_CMM_CD_NM('SAL151',A.ATC_DSTIN_CD,'zh','N') AS ATC_DSTIN_NM,
               A.PRSN_ID,
               A.HP_NO,
               A.TEL_NO,
               A.CAR_USE_TP,
               A.PRSN_DLR_CD,
               A.PRSN_DLR_TEL_NO,
               (SELECT FILE_NM
                  FROM CM_0902T
                WHERE FILE_DOC_NO = A.FILE_DOC_ID
                  AND FILE_NO     = A.CONTRACT_DOC_SEQ
                ) AS CONTRACT_FILE_NM,
               (SELECT FILE_NM
                  FROM CM_0902T
                 WHERE FILE_DOC_NO = A.FILE_DOC_ID
                  AND FILE_NO     = A.CRN_DOC_SEQ
                ) AS BUSS_LICENCE_FILE_NM,
               (SELECT FILE_NM
                  FROM CM_0902T
                 WHERE FILE_DOC_NO = A.FILE_DOC_ID
                   AND FILE_NO     = A.ETC_DOC_SEQ
                ) AS ETC_FILE_NM,
               (SELECT FILE_NM
                  FROM CM_0902T
                 WHERE FILE_DOC_NO = A.FILE_DOC_ID
                   AND FILE_NO     = A.ADD_FILE_SEQ
                ) AS ADD_FILE_NM,
               A.APPROVE_CD,
               A.EVAL_GRADE_CD,
               NVL(A.LAST_APPROVE_CNT,0) AS LAST_APPROVE_CNT,
               (SELECT NVL(MAX(EVAL_RSLT_YN), 0)
                   FROM SA_0412T
                  WHERE DLR_CD  = A.DLR_CD
                    AND USR_ID  = A.USR_ID
                    AND REQ_SEQ = A.REQ_SEQ
               )AS RSLT_YN,
               CASE WHEN NVL(E.AAMT,0) + ABS(NVL(E.DAMT,0)) <![CDATA[>]]> 0
                    THEN NVL(E.AAMT,0) + ABS(NVL(E.DAMT,0)) END DC_AMT,
               E.ALDY
        FROM SA_0414T A , SA_0413T B ,CM_0101T C, SA_0121T D, SA_0416T E
       WHERE C.DLR_CD = A.DLR_CD
         AND B.DLR_CD = A.DLR_CD(+)
         AND B.USR_ID = A.USR_ID(+)
         AND B.REQ_SEQ = A.REQ_SEQ(+)
         AND B.STOCK_VIN_NO1 = D.VIN_NO1(+)
         AND B.STOCK_VIN_NO2 = D.VIN_NO2(+)
         AND D.VIN_NO1 = E.VIN_NO1(+)
         AND D.VIN_NO2 = E.VIN_NO2(+)

         <if test='sApplyNo != null and sApplyNo != ""'>
            AND A.REQ_SAL_NO = #{sApplyNo}
         </if>
         <if test='sCustNm != null and sCustNm != ""'>
            AND A.CUST_NM = #{sCustNm}
         </if>
         <if test='sApproveCd != null and sApproveCd != ""'>
            AND A.APPROVE_CD = #{sApproveCd}
         </if>

          <if test='sApplyDtS != null'>
            AND A.APPLY_DT <![CDATA[>=]]> TRUNC(#{sApplyDtS},'DD')
         </if>
         <if test='sApplyDtE != null'>
            AND A.APPLY_DT <![CDATA[<]]> TRUNC(#{sApplyDtE},'DD')+1
         </if>
         <if test='sConfirmDtS != null'>
            AND A.LAST_APPROVE_DT <![CDATA[>=]]> TRUNC(#{sConfirmDtS},'DD')
         </if>
         <if test='sConfirmDtE != null'>
            AND A.LAST_APPROVE_DT <![CDATA[<]]> TRUNC(#{sConfirmDtE},'DD')+1
         </if>

       ORDER BY DLR_CD ASC, APPLY_DT DESC NULLS LAST, APPROVE_CD ASC, REQ_SEQ ASC



    </select>



</mapper>