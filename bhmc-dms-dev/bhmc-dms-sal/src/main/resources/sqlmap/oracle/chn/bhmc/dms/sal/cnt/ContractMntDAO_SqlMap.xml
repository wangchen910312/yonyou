<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO">

	<!-- 상세조회 목록  -->
	<select id="selectContractResByCondition" parameterType="ContractReSearchVO" resultType="ContractReVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                 , FN_GET_CARLINE_NM_NC(T1.CARLINE_CD) AS CARLINE_NM

                 , CASE WHEN T1.MODEL_CD IS NULL THEN T1.FSC_CD
                        ELSE FN_GET_MODEL_TP_CD(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_CD
                 , CASE WHEN T1.MODEL_CD IS NULL THEN FN_GET_FSC_NM(T1.CARLINE_CD, T1.FSC_CD)
                        ELSE FN_GET_MODEL_TP_NM(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_NM

                 , FN_GET_OCN_NM_NC(T1.MODEL_CD, T1.OCN_CD) AS OCN_NM
                 , FN_GET_EXT_COLOR_NM_NC(T1.EXT_COLOR_CD) AS EXT_COLOR_NM
                 , FN_GET_INT_COLOR_NM_NC(T1.INT_COLOR_CD) AS INT_COLOR_NM
                 , T1.*
              FROM (
                  SELECT A.DLR_CD                    --딜러코드
                       , A.CONTRACT_NO               --계약번호
                       , A.CONTRACT_TP               --계약유형
                       , A.CONTRACT_STAT_CD          --계약상태코드
                       , A.CONTRACT_DT               --계약일자
                       , A.SALE_EMP_NO               --판매사원번호
                       , (SELECT USR_NM
                           FROM CM_0801T
                          WHERE DLR_CD = #{sDlrCd}
                            AND USR_ID = A.SALE_EMP_NO) AS SALE_EMP_NM
                       , A.CONTRACT_CUST_NO          --계약고객번호
                       , A.REAL_DRIVER_CUST_NO       --실제운전자고객번호
                       , A.REAL_DRIVER_SAME_YN       --실제운전자동일여부
                       , A.SALES_MNG_NO              --영업관리번호
                       , A.GRP_CONTRACT_NO           --그룹계약번호
                       , A.BEFORE_NO                 --예약판매번호
                       , A.BEFORE_IMPLY_YN           --예판수납생성여부
                       , A.PAY_TP                    --지불유형
                       , A.CARLINE_CD                --차종코드
                       , A.FSC_CD                    --차관코드
                       , A.MODEL_CD                  --모델코드
                       , A.OCN_CD                    --OCN코드
                       , A.EXT_COLOR_CD              --외장색상코드
                       , A.INT_COLOR_CD              --내장색상코드
                       , A.VIN_NO                     --차대번호
                       , A.CAR_RETL_AMT               --지도가

                       , A.CONS_TP                    --탁송유형
                       , A.WHSL_AMT                   --도매금액
                       , A.RETL_AMT                   --소매금액
                       , A.RESERV_CONT_AMT            --예판금액
                       , A.PROMOTION_AMT              --프로모션금액
                       , A.CORP_PROMOTION_AMT         --법인프로모션금액
                       , A.DLR_PROMOTION_AMT          --딜러프로모션금액
                       , A.POINT_AMT                  --포인트금액
                       , A.BLUE_MEMBERSHIP_POINT_VAL  --BM포인트 금액
                       , A.BLUE_POINT_APPLY_RATE      --BM포인트적용율
                       , A.SBST_AMT                   --치환금액
                       , A.GOODS_AMT                  --용품금액
                       , A.CONS_AMT                   --탁송금액
                       , A.INC_AMT                    --보험금액
                       , A.AAP_AMT                    --대행금액
                       , A.VAT_AMT                    --부가가치세금액
                       , A.REAL_CAR_AMT               --실제차량금액
                       , A.ETC_SUM_AMT                --기타합계금액
                       , A.REAL_PAY_AMT               --실제지불금액
                       , A.CONTRACT_PDPST_NM          --계약입금자명
                       , A.CONTRACT_RCPT_NO           --계약영수증번호
                       , A.CONTRACT_RCPT_AMT          --계약영수증금액
                       , A.CONTRACT_RCPT_ID           --계약영수증ID
                       , A.CONTRACT_RCPT_DT           --계약영수증일자
                       , A.REG_TP                     --등록유형
                       , A.REG_AMT                    --등록금액
                       , A.REG_FEE_AMT                --등록수수료금액
                       , A.INC_AAP_TP                 --보험대행유형
                       , A.INC_FEE_AMT                --보험수수료금액
                       , A.FINC_REQ_YN                --금융요청여부
                       , A.FINC_FEE_AMT               --금융수수료금액
                       , A.UATC_CAR_PURC_YN           --중고차량구매여부
                       , A.DL_REQ_DT                  --인도요청일자
                       , A.REAL_DL_DT                 --실제인도일자
                       , NVL(A.DSTB_CHN_CD, '01') AS DSTB_CHN_CD  --유통채널코드
                       , A.RETL_TP                    --소매유형
                       , A.CANC_DT                    --취소일자
                       , A.CANC_REASON_CD             --취소사유코드
                       , A.FILE_DOC_ID                --파일문서ID
                       , A.REMARK                     --비고
                       , A.REMARK1                    --비고1
                       , A.LV2_DLR_YN                 --2급딜러여부
                       , A.LV2_DLR_ORG_CD             --2급딜러조직코드

                       , A.SALE_OPPT_NO               --판매기회번호
                       , A.SALE_OPPT_SEQ              --판매기회 일련번호
                       , A.INTRO_DLR_CD               --소개딜러코드
                       , A.GOODS_CONTRACT_NO          --용품계약번호
                       , A.REG_USR_ID                 --등록자ID
                       , A.REG_DT                     --등록일자
                       , A.UPDT_USR_ID                --수정자ID
                       , A.UPDT_DT                    --수정일자
                       , TO_CHAR(NVL(A.UPDT_DT, A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                       , A.DC_LVL_CD                  --할인레벨코드
                       , A.DC_APPROVE_YN              --할인승인여부
                       , A.DC_APPROVE_DT              --할인승인일자

                       , (SELECT CUST_CD
                            FROM CR_0101T
                           WHERE DLR_CD = B1.DLR_CD
                             AND CUST_NO = B1.CUST_CD
                          ) AS CUST_CCD               -- 고객상태코드
                       , B1.CUST_CD                   -- 고객코드
                       , B1.CUST_TP                   -- 고객유형
                       , B1.CUST_NM                   -- 고객명
                       , B1.TEL_NO1                   -- 전화번호1
                       , B1.TEL_NO2                   -- 전화번호2
                       , B1.EMAIL_NM                  -- 이메일명
                       , B1.TAX_PAY_NO                -- 납세번호
                       , B1.PURC_MNG_NM               -- 구매담당자명
                       , B1.SSN_CRN_NO                -- 신분증번호
                       , B1.SSN_CRN_TP
                       , B1.ADDR_TP                   -- 주소유형
                       , B1.ZIP_CD                    -- 우편번호
                       , B1.SUNG_CD
                       , B1.CITY_CD
                       , B1.DIST_CD
                       , B1.SUNG_NM
                       , B1.CITY_NM
                       , B1.DIST_NM
                       , B1.ADDR_NM
                       , B1.ADDR_DETL_CONT

                       , C.VIN_NO              AS USR_VIN_NO
                       , C.SBST_AMT            AS USR_SBST_AMT
                       , C.PURC_NO
                       , (SELECT DECODE(NVL(MAX(Z.PURC_NO), 'N'), 'N', 'N', 'Y')
                            FROM SA_0241T Z
                           WHERE Z.DLR_CD = C.DLR_CD
                             AND Z.VIN_NO = C.VIN_NO
                             AND ROWNUM = '1'
                          )                    AS USR_VIN_NO_SR_YN
                       , C.SBUS_TP
                       , C.SUBSIDY_AMT

                       , F.INC_CMP_CD
                       , F.INC_PROFIT_NM
                       , F.INC_JOIN_DT
                       , F.INC_EXPC_AMT
                       , F.REAL_INC_AMT
                       , F.INC_FEE_AMT          AS REAL_INC_FEE_AMT
                       , F.REMARK               AS INC_REMARK
                       , F.IMPLY_YN
                       , F.FIN_IMPLY_YN
                       , F.INC_CUST_NM
                       , F.INC_CUST_TEL_NO
                       , F.INC_PCON_CUST_NM
                       , F.INC_PCON_CUST_TEL_NO
                       , F.FRC_INC_AMT
                       , F.BUS_INC_AMT
                       , F.TRANS_TAX_AMT        AS TRANS_INC_TAX_AMT
                       , TO_CHAR(NVL(F.UPDT_DT, F.REG_DT), 'YYYYMMDDHH24MISS') AS INC_UPDT_DT_STR

                       , G.FINC_CMP_CD
                       , G.FINC_ITEM_CD
                       , G.FINC_REQ_DT
                       , G.FINC_REQ_AMT
                       , G.FINC_END_DT
                       , G.FINC_FEE_AMT         AS REAL_FINC_FEE_AMT
                       , G.FINC_RPAY_PRID
                       , G.FINC_LOAD_RATE
                       , G.INST_INTR_RATE
                       , G.GRTE_INC_AMT
                       , G.FINC_BURD_AMT
                  FROM SA_0201T A                     /* 계약헤더 */
                  LEFT OUTER JOIN SA_0202T B1         /* 계약고객 */
                    ON A.DLR_CD = B1.DLR_CD
                   and A.CONTRACT_NO = B1.CONTRACT_NO
                   and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
                  LEFT OUTER JOIN SA_0205T C          /* 중고차 */
                    ON A.DLR_CD = C.DLR_CD
                   AND A.CONTRACT_NO = C.CONTRACT_NO
                  LEFT OUTER JOIN SA_0221T F          /* 보험 헤더 */
                    ON A.DLR_CD = F.DLR_CD
                   AND A.CONTRACT_NO = F.CONTRACT_NO
                  LEFT OUTER JOIN SA_0223T G          /* 금융 */
                    ON A.DLR_CD = G.DLR_CD
                   AND A.CONTRACT_NO = G.CONTRACT_NO
                  WHERE 1 = 1
                  <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
                  </if>
                  <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
                    AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
                  </if>
                  <if test='sContractCustNo != null and sContractCustNo != ""'>
                    AND  B1.CUST_CD = #{sContractCustNo}    -- 고객코드
                  </if>
                  <if test='sContractCustNm != null and sContractCustNm != ""'>
                    AND  B1.CUST_NM LIKE '%'||#{sContractCustNm}||'%'    -- 고객명
                  </if>
                  <if test='sContractTp != null and sContractTp != ""'>
                    AND A.CONTRACT_TP = #{sContractTp}        -- 계약유형
                  </if>
                  <if test='sContractNo != null and sContractNo != ""'>
                  <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
                      <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                        AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
                    </when>
                    <otherwise>
                        AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
                    </otherwise>
                  </choose>
                  </if>
                  <if test='savedContractNo != null and savedContractNo != ""'>
                    AND A.CONTRACT_NO = #{savedContractNo}        -- 계약번호
                  </if>
                  <if test='sContractStatCd != null and sContractStatCd != ""'>
                    AND A.CONTRACT_STAT_CD = #{sContractStatCd}      -- 계약상태
                  </if>

                  <if test='sStartContractDt != null'>
                    AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ >= ]]> #{sStartContractDt}
                  </if>
                  <if test='sEndContractDt != null'>
                    AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ < ]]> TRUNC(#{sEndContractDt},'DD')+1
                  </if>
                  <if test='sCarlineCd != null and sCarlineCd != ""'>
                    AND A.CARLINE_CD = #{sCarlineCd}      -- 차종코드
                  </if>
                  <if test='sModelCd != null and sModelCd != ""'>
                    AND A.MODEL_CD = #{sModelCd}          -- 모델코드
                  </if>
                  <if test='sOcnCd != null and sOcnCd != ""'>
                    AND A.OCN_CD = #{sOcnCd}              -- OCN
                  </if>
                  <if test='sSaleOpptNo != null and sSaleOpptNo != ""'>
                    AND A.SALE_OPPT_NO = #{sSaleOpptNo}     -- 판매기회
                  </if>
                  <if test='sPurcNo != null and sPurcNo != ""'>
                    AND C.PURC_NO = #{sPurcNo}          -- 중고차 매입번호
                  </if>
                  <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO LIKE '%'|| UPPER(#{sVinNo}) ||'%'    --차대번호
                  </if>
                  <if test='sDstbChnCd != null and sDstbChnCd != ""'>
                    AND NVL(A.DSTB_CHN_CD, '01') = #{sDstbChnCd}       -- 채널유형
                  </if>
                  <if test='sLv2DlrOrgCd != null and sLv2DlrOrgCd != ""'>
                    AND A.LV2_DLR_ORG_CD = #{sLv2DlrOrgCd}       -- 2급딜러
                  </if>

                  ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "contractNo"'>A.CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grpContractNo"'>A.GRP_CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractDt"'>A.CONTRACT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractStatCd"'>A.CONTRACT_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractCustNo"'>B1.CUST_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custNm"'>B1.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "telNo1"'>B1.TEL_NO1 <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "saleEmpNo"'>A.SALE_EMP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineNm"'>A.CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelNm"'>A.MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnNm"'>A.OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "extColorNm"'>A.EXT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "intColorNm"'>A.INT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "realPayAmt"'>A.REAL_PAY_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dcLvlCd"'>A.DC_LVL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "lv2DlrOrgCd"'>A.LV2_DLR_ORG_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dstbChnCd"'>DSTB_CHN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>

	<!-- 목록 갯수  -->
	<select id="selectContractResByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
		SELECT COUNT(*)
          FROM SA_0201T A    --계약헤더
          LEFT OUTER JOIN SA_0202T B1               /* 계약고객 */
            ON A.DLR_CD = B1.DLR_CD
           and A.CONTRACT_NO = B1.CONTRACT_NO
           and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
          LEFT OUTER JOIN SA_0205T C          /* 중고차 */
            ON A.DLR_CD = C.DLR_CD
           AND A.CONTRACT_NO = C.CONTRACT_NO
          LEFT OUTER JOIN SA_0221T F          /* 보험 헤더 */
            ON A.DLR_CD = F.DLR_CD
           AND A.CONTRACT_NO = F.CONTRACT_NO
          LEFT OUTER JOIN SA_0223T G          /* 금융 */
            ON A.DLR_CD = G.DLR_CD
           AND A.CONTRACT_NO = G.CONTRACT_NO
          WHERE 1 = 1
          <if test='sDlrCd != null and sDlrCd != ""'>
            AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
          </if>
          <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
            AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
          </if>
          <if test='sContractCustNo != null and sContractCustNo != ""'>
            AND B1.CUST_CD = #{sContractCustNo}   -- 고객코드
          </if>
          <if test='sContractCustNm != null and sContractCustNm != ""'>
            AND  B1.CUST_NM LIKE '%'||#{sContractCustNm}||'%'    -- 고객명
          </if>
          <if test='sContractTp != null and sContractTp != ""'>
            AND A.CONTRACT_TP = #{sContractTp}        -- 계약유형
          </if>
          <if test='sContractNo != null and sContractNo != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
              <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
            </when>
            <otherwise>
                AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
            </otherwise>
          </choose>
          </if>
          <if test='savedContractNo != null and savedContractNo != ""'>
            AND A.CONTRACT_NO = #{savedContractNo}        -- 계약번호
          </if>
          <if test='sContractStatCd != null and sContractStatCd != ""'>
            AND A.CONTRACT_STAT_CD = #{sContractStatCd}      -- 계약상태
          </if>
          <if test='sStartContractDt != null'>
            AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ >= ]]> #{sStartContractDt}
          </if>
          <if test='sEndContractDt != null'>
            AND NVL(A.CONTRACT_DT, SYSDATE-1) <![CDATA[ < ]]> TRUNC(#{sEndContractDt},'DD')+1
          </if>
          <if test='sCarlineCd != null and sCarlineCd != ""'>
            AND A.CARLINE_CD = #{sCarlineCd}      -- 차종코드
          </if>
          <if test='sModelCd != null and sModelCd != ""'>
            AND A.MODEL_CD = #{sModelCd}          -- 모델코드
          </if>
          <if test='sOcnCd != null and sOcnCd != ""'>
            AND A.OCN_CD = #{sOcnCd}              -- OCN
          </if>
          <if test='sVinNo != null and sVinNo != ""'>
            AND A.VIN_NO LIKE '%'|| UPPER(#{sVinNo}) ||'%'    --차대번호
          </if>
          <if test='sDstbChnCd != null and sDstbChnCd != ""'>
            AND NVL(A.DSTB_CHN_CD, '01') = #{sDstbChnCd}       -- 채널유형
          </if>
          <if test='sLv2DlrOrgCd != null and sLv2DlrOrgCd != ""'>
            AND A.LV2_DLR_ORG_CD = #{sLv2DlrOrgCd}       -- 2급딜러
          </if>
	</select>

    <!-- 계약화면 목록 갯수 조회 -->
    <select id="selectContractMntsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0201T A                     /* 계약헤더 */
          LEFT OUTER JOIN SA_0202T B1         /* 계약고객 */
            ON A.DLR_CD = B1.DLR_CD
           and A.CONTRACT_NO = B1.CONTRACT_NO
           and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
          WHERE 1 = 1
            <if test='sDlrCd != null and sDlrCd != ""'>
              AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
            </if>
            <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
              AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
            </if>
            <if test='sContractCustNo != null and sContractCustNo != ""'>
              AND B1.CUST_CD = #{sContractCustNo}  -- 고객코드
            </if>
            <if test='sContractCustNm != null and sContractCustNm != ""'>
              AND  B1.CUST_NM LIKE '%'||#{sContractCustNm}||'%'    -- 고객명
            </if>
            <if test='sContractNo != null and sContractNo != ""'>
            <choose>
              <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
                <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                  AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
              </when>
              <otherwise>
                  AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
              </otherwise>
            </choose>
            </if>
            <if test='savedContractNo != null and savedContractNo != ""'>
                AND A.CONTRACT_NO = #{savedContractNo}          -- 계약번호
            </if>
            <if test='sCntTp != null and sCntTp != ""'>
              <choose>
                <when test=' sCntTp != "2" '>
                  AND A.CONTRACT_STAT_CD <![CDATA[ < ]]> '20'
                </when>
                <otherwise>
                  AND A.CONTRACT_STAT_CD = '20'
                </otherwise>
              </choose>
            </if>
            <if test='sVinNo != null and sVinNo != ""'>
               AND  A.VIN_NO LIKE '%'||UPPER(#{sVinNo})||'%'
            </if>
            <if test='sDstbChnCd != null and sDstbChnCd != ""'>
              AND NVL(A.DSTB_CHN_CD, '01') = #{sDstbChnCd}       -- 채널유형
            </if>
            <if test='sLv2DlrOrgCd != null and sLv2DlrOrgCd != ""'>
              AND A.LV2_DLR_ORG_CD = #{sLv2DlrOrgCd}       -- 2급딜러
            </if>
    </select>

    <!-- 계약화면 조회 -->
    <select id="selectContractMntsByCondition" parameterType="ContractReSearchVO" resultType="ContractReVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                 , FN_GET_CARLINE_NM_NC(T1.CARLINE_CD) AS CARLINE_NM
                 , CASE WHEN T1.MODEL_CD IS NULL THEN T1.FSC_CD
                        ELSE FN_GET_MODEL_TP_CD(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_CD
                 , CASE WHEN T1.MODEL_CD IS NULL THEN FN_GET_FSC_NM(T1.CARLINE_CD, T1.FSC_CD)
                        ELSE FN_GET_MODEL_TP_NM(T1.MODEL_CD, T1.OCN_CD)
                    END FSC_NM
                 , FN_GET_OCN_NM_NC(T1.MODEL_CD, T1.OCN_CD) AS OCN_NM
                 , FN_GET_EXT_COLOR_NM_NC(T1.EXT_COLOR_CD) AS EXT_COLOR_NM
                 , FN_GET_INT_COLOR_NM_NC(T1.INT_COLOR_CD) AS INT_COLOR_NM
                 , T1.*
              FROM (
                    SELECT A.DLR_CD                    --딜러코드
                         , A.CONTRACT_NO               --계약번호
                         , A.CONTRACT_CUST_NO          --계약고객번호
                         , B1.CUST_NM                  --고객명
                         , A.GRP_CONTRACT_NO           --그룹계약번호
                         , A.BEFORE_NO                 --예약판매번호
                         , A.BEFORE_IMPLY_YN           --예판수납생성여부
                         , A.CONTRACT_TP               --계약유형
                         , ( SELECT Z1.CMM_CD_NM
                               FROM (SELECT A.CMM_CD
                                          , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                      FROM CM_0303T A
                                      LEFT OUTER JOIN CM_0304T B
                                            ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                           AND A.CMM_CD = B.CMM_CD
                                           AND B.LANG_CD = #{sLangCd}
                                     WHERE A.CMM_GRP_CD = 'SAL003'   /*계약유형*/
                                       AND A.USE_YN = 'Y'
                                     ) Z1
                             WHERE A.CONTRACT_TP = Z1.CMM_CD
                           ) AS CONTRACT_TP_NM

                         , A.CONTRACT_STAT_CD          --계약상태코드
                         , ( SELECT Z1.CMM_CD_NM
                               FROM (SELECT A.CMM_CD
                                          , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                      FROM CM_0303T A
                                      LEFT OUTER JOIN CM_0304T B
                                            ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                           AND A.CMM_CD = B.CMM_CD
                                           AND B.LANG_CD = #{sLangCd}
                                     WHERE A.CMM_GRP_CD = 'SAL002'   /*계약상태*/
                                       AND A.USE_YN = 'Y'
                                     ) Z1
                             WHERE A.CONTRACT_STAT_CD = Z1.CMM_CD
                           ) AS CONTRACT_STAT_NM
                         , A.CONTRACT_DT               --계약일자
                         , A.CARLINE_CD                --차종코드
                         , A.FSC_CD
                         , A.MODEL_CD                  --모델코드
                         , A.OCN_CD                    --OCN코드
                         , A.EXT_COLOR_CD              --외장색상코드
                         , A.INT_COLOR_CD              --내장색상코드
                         , A.SALE_EMP_NO               --판매사원번호
                         , (
                            SELECT USR_NM
                              FROM CM_0801T
                             WHERE USR_ID = A.SALE_EMP_NO
                           ) AS SALE_EMP_NM            --판매사원명
                         , A.PAY_TP                    --지불유형
                         , ( SELECT Z1.CMM_CD_NM
                               FROM (SELECT A.CMM_CD
                                          , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                      FROM CM_0303T A
                                      LEFT OUTER JOIN CM_0304T B
                                            ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                           AND A.CMM_CD = B.CMM_CD
                                           AND B.LANG_CD = #{sLangCd}
                                     WHERE A.CMM_GRP_CD = 'SAL071'   /*지불유형*/
                                       AND A.USE_YN = 'Y'
                                     ) Z1
                             WHERE A.PAY_TP = Z1.CMM_CD
                           ) AS PAY_TP_NM
                         , A.WHSL_AMT                  --도매금액
                         , A.RETL_AMT                  --소매금액
                         , A.RESERV_CONT_AMT
                         , A.REAL_CAR_AMT              --실제차량금액
                         , A.REAL_PAY_AMT               --실제지불금액
                         , A.VIN_NO
                         , A.LV2_DLR_YN
                         , A.LV2_DLR_ORG_CD
                         , ( SELECT Z1.CMM_CD_NM
                               FROM ( SELECT T.SDLR_CD
                                           , T.SDLR_NM
                                           , '['||T.SDLR_CD||']' || T.SDLR_NM AS CMM_CD_NM
                                        FROM CM_0101T S
                                           , SA_0504T T
                                       WHERE S.DLR_CD = T.DLR_CD
                                         AND T.DLR_CD = #{sDlrCd}
                                         AND T.SDLR_TP IN ('EW', 'WX')
                                     ) Z1
                             WHERE Z1.SDLR_CD = A.LV2_DLR_ORG_CD
                           ) AS LV2_DLR_ORG_NM
                         , A.DC_LVL_CD
                         , NVL(A.DSTB_CHN_CD, '01') AS DSTB_CHN_CD
                         , ( SELECT Z1.CMM_CD_NM
                               FROM (SELECT A.CMM_CD
                                          , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                      FROM CM_0303T A
                                      LEFT OUTER JOIN CM_0304T B
                                            ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                           AND A.CMM_CD = B.CMM_CD
                                           AND B.LANG_CD = #{sLangCd}
                                     WHERE A.CMM_GRP_CD = 'COM072'   /*채널유형*/
                                       AND A.USE_YN = 'Y'
                                     ) Z1
                             WHERE NVL(A.DSTB_CHN_CD, '01') = Z1.CMM_CD
                           ) AS DSTB_CHN_NM
                    FROM SA_0201T A                     /* 계약헤더 */
                    LEFT OUTER JOIN SA_0202T B1         /* 계약고객 */
                      ON A.DLR_CD = B1.DLR_CD
                     and A.CONTRACT_NO = B1.CONTRACT_NO
                     and B1.PARTNER_TP = 'C'   -- 계약자   : SAL028
                    WHERE 1 = 1
                      <if test='sDlrCd != null and sDlrCd != ""'>
                        AND A.DLR_CD = #{sDlrCd}                       -- 딜러코드
                      </if>
                      <if test='sSaleEmpNo != null and sSaleEmpNo != ""'>
                        AND A.SALE_EMP_NO = #{sSaleEmpNo}     -- 판매사원번호
                      </if>
                      <if test='sContractCustNo != null and sContractCustNo != ""'>
                        AND B1.CUST_CD = #{sContractCustNo}    -- 고객코드
                      </if>
                      <if test='sContractCustNm != null and sContractCustNm != ""'>
                        AND  B1.CUST_NM LIKE '%'||#{sContractCustNm}||'%'    -- 고객명
                      </if>
                      <if test='sContractNo != null and sContractNo != ""'>
                      <choose>
                        <when test='@org.apache.commons.lang3.StringUtils@contains(sContractNo,"*")'>
                          <bind name='sContractNo' value='@org.apache.commons.lang3.StringUtils@replace(sContractNo, "*", "%")' />
                            AND A.CONTRACT_NO LIKE #{sContractNo}       -- 계약번호
                        </when>
                        <otherwise>
                            AND A.CONTRACT_NO = #{sContractNo}          -- 계약번호
                        </otherwise>
                      </choose>
                      </if>
                      <if test='savedContractNo != null and savedContractNo != ""'>
                          AND A.CONTRACT_NO = #{savedContractNo}          -- 계약번호
                      </if>
                      <if test='sCntTp != null and sCntTp != ""'>
                        <choose>
                          <when test=' sCntTp != "2" '>
                            AND A.CONTRACT_STAT_CD <![CDATA[ < ]]> '20'
                          </when>
                          <otherwise>
                            AND A.CONTRACT_STAT_CD = '20'
                          </otherwise>
                        </choose>
                      </if>
                      <if test='sVinNo != null and sVinNo != ""'>
                        AND A.VIN_NO LIKE '%'||UPPER(#{sVinNo})||'%'
                      </if>
                      <if test='sDstbChnCd != null and sDstbChnCd != ""'>
                        AND NVL(A.DSTB_CHN_CD, '01') = #{sDstbChnCd}       -- 채널유형
                      </if>
                      <if test='sLv2DlrOrgCd != null and sLv2DlrOrgCd != ""'>
                        AND A.LV2_DLR_ORG_CD = #{sLv2DlrOrgCd}       -- 2급딜러
                      </if>
              ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "contractNo"'>A.CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractCustNo"'>A.CONTRACT_CUST_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custNm"'>B1.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grpContractNo"'>A.GRP_CONTRACT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractTpNm"'>CONTRACT_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractStatNm"'>CONTRACT_STAT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "contractDt"'>A.CONTRACT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineCd"'>A.CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineNm"'>A.CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "fscCd"'>A.FSC_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "fscNm"'>A.FSC_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelCd"'>A.MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelNm"'>A.MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnCd"'>A.OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnNm"'>A.OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "extColorCd"'>A.EXT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "extColorNm"'>A.EXT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "intColorCd"'>A.INT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "intColorNm"'>A.INT_COLOR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "saleEmpNm"'>SALE_EMP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "payTpNm"'>PAY_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "whslAmt"'>A.WHSL_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "retlAmt"'>A.RETL_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "realCarAmt"'>A.REAL_CAR_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "realPayAmt"'>A.REAL_PAY_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "vinNo"'>A.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "lv2DlrYn"'>A.LV2_DLR_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "lv2DlrOrgNm"'>LV2_DLR_ORG_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dcLvlCd"'>A.DC_LVL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dstbChnNm"'>DSTB_CHN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>

                                <otherwise>
                                    <choose>
                                      <when test=' sCntTp != "2" '>
                                         A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                                      </when>
                                      <otherwise>
                                         A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                                      </otherwise>
                                    </choose>
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        <choose>
                          <when test=' sCntTp != "2" '>
                             A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                          </when>
                          <otherwise>
                             A.CONTRACT_DT DESC, A.CONTRACT_NO DESC, A.CONTRACT_STAT_CD ASC NULLS LAST
                          </otherwise>
                        </choose>
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 계약 헤더에 저장한다.  -->
    <insert id="insertContract" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.insertContract] */
        INSERT INTO SA_0201T    --계약헤더
        (
              DLR_CD                     --딜러코드
             ,CONTRACT_NO                --계약번호
             ,CONTRACT_TP                --계약유형
             ,CONTRACT_STAT_CD           --계약상태코드
             ,CONTRACT_DT                --계약일자
             ,SALE_EMP_NO                --판매사원번호
             ,CONTRACT_CUST_NO           --계약고객번호
             ,REAL_DRIVER_CUST_NO        --실제운전자고객번호
             ,REAL_DRIVER_SAME_YN        --실제운전자동일여부
             ,SALES_MNG_NO               --영업관리번호
             ,PAY_TP                     --지불유형
             ,CARLINE_CD                 --차종코드
             ,FSC_CD                     --차관코드
             ,MODEL_CD                   --모델코드
             ,OCN_CD                     --OCN코드
             ,EXT_COLOR_CD               --외장색상코드
             ,INT_COLOR_CD               --내장색상코드
             ,CONS_TP                    --탁송유형
             ,WHSL_AMT                   --도매금액
             ,RETL_AMT                   --소매금액
             ,PROMOTION_AMT              --프로모션금액
             ,CORP_PROMOTION_AMT         --법인프로모션금액
             ,DLR_PROMOTION_AMT          --딜러프로모션금액
             ,SBST_AMT                   --치환금액
             ,GOODS_AMT                  --용품금액
             ,CONS_AMT                   --탁송금액
             ,INC_AMT                    --보험금액
             ,AAP_AMT                    --대행금액
             ,VAT_AMT                    --부가가치세금액
             ,REAL_CAR_AMT               --실제차량금액
             ,ETC_SUM_AMT                --기타합계금액
             ,REAL_PAY_AMT               --실제지불금액
             ,CONTRACT_PDPST_NM          --계약입금자명
             ,CONTRACT_RCPT_NO           --계약영수증번호
             ,CONTRACT_RCPT_AMT          --계약영수증금액
             ,CONTRACT_RCPT_ID           --계약영수증ID
             ,CONTRACT_RCPT_DT           --계약영수증일자
             ,REG_TP                     --등록유형
             ,REG_AMT                    --등록금액
             ,REG_FEE_AMT                --등록수수료금액
             ,INC_AAP_TP                 --보험대행유형
             ,INC_FEE_AMT                --보험수수료금액
             ,FINC_REQ_YN                --금융요청여부
             ,FINC_FEE_AMT               --금융수수료금액
             ,UATC_CAR_PURC_YN           --중고차량구매여부
             ,DL_REQ_DT                  --인도요청일자
             ,REAL_DL_DT                 --실제인도일자
             ,DSTB_CHN_CD                --유통채널코드
             ,RETL_TP                    --소매유형
             ,CANC_DT                    --취소일자
             ,CANC_REASON_CD             --취소사유코드
             ,FILE_DOC_ID                --파일문서ID
             ,REMARK                     --비고
             ,REMARK1                    --비고1
             ,LV2_DLR_YN                 --2급딜러여부
             ,LV2_DLR_ORG_CD             --2급딜러조직
             ,SALE_OPPT_NO               --판매기회번호
             ,INTRO_DLR_CD               --소개딜러코드
             ,GOODS_CONTRACT_NO          --용품계약번호
             ,GRP_CONTRACT_NO            --그룹계약번호
             ,BEFORE_NO                  --예약판매번호
             ,BEFORE_IMPLY_YN            --예판수납생성여부
             ,REG_USR_ID                 --등록자ID
             ,REG_DT                     --등록일자
             ,UPDT_USR_ID                --수정자ID
             ,UPDT_DT                    --수정일자
             ,DC_LVL_CD                  --할인레벨코드
             ,DC_APPROVE_YN              --할인승인여부
             <if test='dcLvlCd != null and dcLvlCd != ""'>
             ,DC_APPROVE_DT              --할인승인일자
             </if>
             ,VIN_NO                     --차대번호
             ,CAR_RETL_AMT               --차량소매금액
             ,POINT_AMT                  --포인트금액
             ,BLUE_MEMBERSHIP_POINT_VAL  --BM포인트금액
             ,BLUE_POINT_APPLY_RATE      --BM포인트적용율
             ,RESERV_CONT_AMT            --예약판매금액
        )
        VALUES
        (
              #{dlrCd}                     --딜러코드
             ,#{contractNo}                --계약번호
             ,#{contractTp}                --계약유형
             ,#{contractStatCd}            --계약상태코드
             ,#{contractDt}                --계약일자
             ,#{saleEmpNo}                 --판매사원번호
             ,#{contractCustNo}            --계약고객번호
             ,#{realDriverCustNo}          --실제운전자고객번호
             ,#{realDriverSameYn}          --실제운전자동일여부
             ,#{salesMngNo}                --영업관리번호
             ,#{payTp}                     --지불유형
             ,#{carlineCd}                 --차종코드
             ,#{fscCd}                     --차관코드
             ,#{modelCd}                   --모델코드
             ,#{ocnCd}                     --OCN코드
             ,#{extColorCd}                --외장색상코드
             ,#{intColorCd}                --내장색상코드
             ,#{consTp}                    --탁송유형
             ,#{whslAmt}                   --도매금액
             ,#{retlAmt}                   --소매금액
             ,#{promotionAmt}              --프로모션금액
             ,#{corpPromotionAmt}          --법인프로모션금액
             ,#{dlrPromotionAmt}           --딜러프로모션금액
             ,#{sbstAmt}                   --치환금액
             ,#{goodsAmt}                  --용품금액
             ,#{consAmt}                   --탁송금액
             ,#{incAmt}                    --보험금액
             ,#{aapAmt}                    --대행금액
             ,#{vatAmt}                    --부가가치세금액
             ,#{realCarAmt}                --실제차량금액
             ,#{etcSumAmt}                 --기타합계금액
             ,#{realPayAmt}                --실제지불금액
             ,#{contractPdpstNm}           --계약입금자명
             ,#{contractRcptNo}            --계약영수증번호
             ,#{contractRcptAmt}           --계약영수증금액
             ,#{contractRcptId}            --계약영수증ID
             ,#{contractRcptDt}            --계약영수증일자
             ,#{regTp}                     --등록유형
             ,#{realRegAmt}                --등록금액
             ,#{regFeeAmt}                 --등록수수료금액
             ,#{incAapTp}                  --보험대행유형
             ,#{incFeeAmt}                 --보험수수료금액
             ,#{fincReqYn}                 --금융요청여부
             ,#{fincFeeAmt}                --금융수수료금액
             ,#{uatcCarPurcYn}             --중고차량구매여부
             ,#{dlReqDt}                   --인도요청일자
             ,''                           --실제인도일자
             ,#{dstbChnCd}                 --유통채널코드
             ,#{retlTp}                    --소매유형
             ,''                           --취소일자
             ,#{cancReasonCd}              --취소사유코드
             ,#{fileDocId}                 --파일문서ID
             ,#{remark}                    --비고
             ,#{remark1}                   --비고1
             ,#{lv2DlrYn}                  --2급딜러여부
             ,#{lv2DlrOrgCd}               --2급딜러조직
             ,#{saleOpptNo}                --판매기회번호
             ,''                           --소개딜러코드
             ,#{goodsContractNo}           --용품계약번호
             ,#{grpContractNo}             --그룹계약번호
             ,#{beforeNo}                  --예약판매번호
             ,#{beforeImplyYn}             --예판수납생성여부
             ,#{regUsrId}                  --등록자ID
             ,SYSDATE
             ,#{updtUsrId}                 --수정자ID
             ,SYSDATE
             ,#{dcLvlCd}                   --할인레벨코드
             ,#{dcApproveYn}               --할인승인여부
           <if test='dcLvlCd != null and dcLvlCd != ""'>
             ,SYSDATE
           </if>
             ,#{vinNo}                     --차대번호
             ,#{carRetlAmt}                --차량소매금액
             ,#{pointAmt}                  --포인트금액
             ,#{blueMembershipPointVal}    --BM포인트금액
             ,#{bluePointApplyRate}        --BM포인트적용율
             ,#{reservContAmt}             --예약판매금액
      )
    </insert>

    <!-- SA_0202 : 실운전자 저장 -->
    <insert id="insertContractCustomer" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.insertContractCustomer] */
       INSERT INTO SA_0202T    --계약고객상세
        (
          DLR_CD                --딜러코드
         ,CONTRACT_NO           --계약번호
         ,PARTNER_TP            --파트너유형
         ,CUST_CD               --고객코드
         ,CUST_TP               --고객유형
         ,CUST_NM               --고객명
         ,TEL_NO1               --전화번호1
         ,TEL_NO2               --전화번호2
         ,EMAIL_NM              --이메일명
         ,SSN_CRN_NO            --신분증번호
         ,ZIP_CD                --우편번호
         ,REG_USR_ID            --등록자ID
         ,REG_DT                --등록일자
         ,UPDT_USR_ID           --수정자ID
         ,UPDT_DT               --수정일자
         ,SSN_CRN_TP            --신분증유형
         ,SUNG_CD               --성코드
         ,CITY_CD               --도시코드
         ,DIST_CD               --지역코드
         ,SUNG_NM               --성명
         ,CITY_NM               --도시명
         ,DIST_NM               --지역명
         ,ADDR_NM               --주소명
         ,ADDR_DETL_CONT        --주소상세내용
         ,ADDR_TP               --주소유형
         ,TAX_PAY_NO            --납세번호
         ,PURC_MNG_NM           --구매담당자(법인)
        )
        VALUES
        (
          #{dlrCd}                --딜러코드
         ,#{contractNo}           --계약번호
         ,#{partnerTp}            --파트너유형
         ,#{custCd}               --고객코드
         ,#{custTp}               --고객유형
         ,#{custNm}               --고객명
         ,#{telNo1}               --전화번호1
         ,#{telNo2}               --전화번호2
         ,#{emailNm}              --이메일명
         ,#{ssnCrnNo}             --신분증번호
         ,#{zipCd}                --우편번호
         ,#{regUsrId}             --등록자ID
         ,SYSDATE
         ,#{updtUsrId}            --수정자ID
         ,SYSDATE
         ,#{ssnCrnTp}             --신분증유형
         ,#{sungCd}               --성코드
         ,#{cityCd}               --도시코드
         ,#{distCd}               --지역코드
         ,#{sungNm}               --성명
         ,#{cityNm}               --도시명
         ,#{distNm}               --지역명
         ,#{addrNm}               --주소명
         ,#{addrDetlCont}         --주소상세내용
         ,#{addrTp}               --주소유형
         ,#{taxPayNo}             --납세번호
         ,#{purcMngNm}            --구매담당자(법인)
        )
    </insert>

    <!-- 계약고객 유효성 체크 -->
    <select id="selectContractCustomersChkByConditionCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectContractCustomersByConditionCnt] */
        SELECT COUNT(*)
          FROM SA_0202T
          WHERE DLR_CD         = #{dlrCd}                --딜러코드
            AND CONTRACT_NO    = #{contractNo}           --계약번호
            AND PARTNER_TP     = #{partnerTp}            --파트너유형
    </select>

    <!-- 계약 저장된 내역 확인 -->
    <select id="selectContractUpdtCheck" parameterType="ContractReSearchVO" resultType="String">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectContractUpdtCheck] */
        SELECT TO_CHAR(NVL(UPDT_DT, REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM SA_0201T
         WHERE DLR_CD      = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>

    <!-- SA_0205 : 중고차 저장 -->
    <insert id="insertUsedCar" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.insertUsedCar] */
        INSERT
          INTO SA_0205T    --계약중고차
        (
              DLR_CD             --딜러코드
             ,CONTRACT_NO        --계약번호
             ,VIN_NO             --차대번호
             ,SBST_AMT           --치환금액
             ,PURC_NO            --매입번호
             ,REG_USR_ID         --등록자ID
             ,REG_DT             --등록일자
             ,UPDT_USR_ID        --수정자ID
             ,UPDT_DT            --수정일자
             ,SBUS_TP
             ,SUBSIDY_AMT
        )VALUES(
              #{dlrCd}             --딜러코드
             ,#{contractNo}        --계약번호
             ,#{usrVinNo}          --차대번호
             ,#{usrSbstAmt}        --치환금액
             ,#{purcNo}            --매입번호
             ,#{regUsrId}
             ,SYSDATE
             ,#{updtUsrId}
             ,SYSDATE
             ,#{sbusTp}
             ,#{subsidyAmt}
        )
    </insert>


    <!-- 계약 헤더에 수정한다.  -->
    <update id="updateContract" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateContract] */
        UPDATE SA_0201T    --계약헤더
           SET CONTRACT_TP         = #{contractTp}                --계약유형
             , CONTRACT_STAT_CD    = #{contractStatCd}            --계약상태코드
             , CONTRACT_DT         = #{contractDt}                --계약일자
             , SALE_EMP_NO         = #{saleEmpNo}                 --판매사원번호
             , CONTRACT_CUST_NO    = #{contractCustNo}            --계약고객번호
             , REAL_DRIVER_CUST_NO = #{realDriverCustNo}          --실제운전자고객번호
             , REAL_DRIVER_SAME_YN = #{realDriverSameYn}          --실제운전자동일여부
             , SALES_MNG_NO        = #{salesMngNo}                --영업관리번호
             , PAY_TP              = #{payTp}                     --지불유형
             , CARLINE_CD          = #{carlineCd}                 --차종코드
             , FSC_CD              = #{fscCd}                     --차관코드
             , MODEL_CD            = #{modelCd}                   --모델코드
             , OCN_CD              = #{ocnCd}                     --OCN코드
             , EXT_COLOR_CD        = #{extColorCd}                --외장색상코드
             , INT_COLOR_CD        = #{intColorCd}                --내장색상코드
             , CONS_TP             = #{consTp}                    --탁송유형
             , WHSL_AMT            = #{whslAmt}                   --도매금액
             , RETL_AMT            = #{retlAmt}                   --소매금액
             , PROMOTION_AMT       = #{promotionAmt}              --프로모션금액
             , CORP_PROMOTION_AMT  = #{corpPromotionAmt}          --법인프로모션금액
             , DLR_PROMOTION_AMT   = #{dlrPromotionAmt}           --딜러프로모션금액
             , SBST_AMT            = #{sbstAmt}                   --치환금액
             , GOODS_AMT           = #{goodsAmt}                  --용품금액
             , CONS_AMT            = #{consAmt}                   --탁송금액
             , INC_AMT             = #{incAmt}                    --보험금액
             , AAP_AMT             = #{aapAmt}                    --대행금액
             , VAT_AMT             = #{vatAmt}                    --부가가치세금액
             , REAL_CAR_AMT        = #{realCarAmt}                --실제차량금액
             , ETC_SUM_AMT         = #{etcSumAmt}                 --기타합계금액
             , REAL_PAY_AMT        = #{realPayAmt}                --실제지불금액
             , CONTRACT_PDPST_NM   = #{contractPdpstNm}           --계약입금자명
             , CONTRACT_RCPT_NO    = #{contractRcptNo}            --계약영수증번호
             , CONTRACT_RCPT_AMT   = #{contractRcptAmt}           --계약영수증금액
             , CONTRACT_RCPT_ID    = #{contractRcptId}            --계약영수증ID
             , CONTRACT_RCPT_DT    = #{contractRcptDt}            --계약영수증일자
             , REG_TP              = #{regTp}                     --등록유형
             , REG_AMT             = #{realRegAmt}                    --등록금액
             , REG_FEE_AMT         = #{regFeeAmt}                 --등록수수료금액
             , INC_AAP_TP          = #{incAapTp}                  --보험대행유형
             , INC_FEE_AMT         = #{incFeeAmt}                 --보험수수료금액
             , FINC_REQ_YN         = #{fincReqYn}                 --금융요청여부
             , FINC_FEE_AMT        = #{fincFeeAmt}                --금융수수료금액
             , UATC_CAR_PURC_YN    = #{uatcCarPurcYn}             --중고차량구매여부
             , DL_REQ_DT           = #{dlReqDt}                   --인도요청일자
             , DSTB_CHN_CD         = #{dstbChnCd}                 --유통채널코드
             , RETL_TP             = #{retlTp}                    --소매유형

             , CANC_REASON_CD      = #{cancReasonCd}              --취소사유코드
             , FILE_DOC_ID         = #{fileDocId}                 --파일문서ID
             , REMARK              = #{remark}                    --비고
             , REMARK1             = #{remark1}                   --비고1
             , LV2_DLR_YN          = #{lv2DlrYn}                  --2급딜러여부
             , LV2_DLR_ORG_CD      = #{lv2DlrOrgCd}               --2급딜러조직

             , SALE_OPPT_NO        = #{saleOpptNo}                --판매기회일련번호

             , GOODS_CONTRACT_NO   = ''
             , GRP_CONTRACT_NO     = #{grpContractNo}             --그룹계약번호
             , BEFORE_NO           = #{beforeNo}                  --예약판매번호
             , BEFORE_IMPLY_YN     = #{beforeImplyYn}             --예판수납생성여부

             , UPDT_USR_ID         = #{updtUsrId}                 --수정자ID
             , UPDT_DT             = SYSDATE
             , DC_LVL_CD           = #{dcLvlCd}                   --할인레벨코드
             , DC_APPROVE_YN       = #{dcApproveYn}               --할인승인여부
             , VIN_NO              = #{vinNo}                     -- 차대번호
             , CAR_RETL_AMT        = #{carRetlAmt}                -- 차량소매금액
             , POINT_AMT           = #{pointAmt}                       --포인트금액
             , BLUE_MEMBERSHIP_POINT_VAL = #{blueMembershipPointVal}   --BM포인트 금액
             , BLUE_POINT_APPLY_RATE     = #{bluePointApplyRate}       --BM포인트적용율
             , RESERV_CONT_AMT     = #{reservContAmt}
         WHERE 1 = 1
           AND DLR_CD              = #{dlrCd}                     --딜러코드
           AND CONTRACT_NO         = #{contractNo}                --계약번호
    </update>

    <!-- SA_0201 : 계약헤더 컬럼개별 update시 -->
    <update id="updateContractEach" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateContractEach] */
        UPDATE SA_0201T    --계약헤더
           SET UPDT_USR_ID         = #{updtUsrId}                 --수정자ID
             , UPDT_DT             = SYSDATE
           <if test='uatcCarPurcYn != null and uatcCarPurcYn != ""'>
             , UATC_CAR_PURC_YN    = #{uatcCarPurcYn}             --중고차량구매여부
           </if>
           <if test='goodsAmt != null and goodsAmt != ""'>
             , GOODS_AMT     = #{goodsAmt}                        --용품금액
           </if>
           <if test='fincFeeAmt != null and fincFeeAmt != ""'>
             , FINC_FEE_AMT  = #{fincFeeAmt}                      -- 금융수수료금액
           </if>
           <if test='sbstAmt != null and sbstAmt != ""'>
             , SBST_AMT            = #{sbstAmt}                   --치환금액
           </if>
           <if test='realPayAmt != null and realPayAmt != ""'>
             , REAL_PAY_AMT        = #{realPayAmt}                --실제지불금액
           </if>
           <if test='vinNo != null and vinNo != ""'>
             , VIN_NO              = #{vinNo}                     -- 임시 vin
           </if>
           <if test='saleOpptSeq != null and saleOpptSeq != ""'>
             , SALE_OPPT_SEQ       = #{saleOpptSeq}               -- 판매기회 일련번호
           </if>
         WHERE 1 = 1
           AND DLR_CD              = #{dlrCd}                     --딜러코드
           AND CONTRACT_NO         = #{contractNo}                --계약번호
    </update>

    <!-- SA_0202 : 실운전자 수정 -->
    <update id="updateContractCustomer" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateContractCustomer] */
        UPDATE SA_0202T    --계약고객상세
           SET CUST_CD        = #{custCd}               --고객코드
             , CUST_TP        = #{custTp}               --고객유형
             , CUST_NM        = #{custNm}               --고객명
             , TEL_NO1        = #{telNo1}               --전화번호1
             , TEL_NO2        = #{telNo2}               --전화번호2
             , EMAIL_NM       = #{emailNm}              --이메일명
             , SSN_CRN_NO     = #{ssnCrnNo}             --신분증번호
             , SSN_CRN_TP     = #{ssnCrnTp}             --신분증유형
             , ZIP_CD         = #{zipCd}                --우편번호
             , SUNG_CD        = #{sungCd}               --성코드
             , CITY_CD        = #{cityCd}               --도시코드
             , DIST_CD        = #{distCd}               --지역코드
             , SUNG_NM        = #{sungNm}               --성명
             , CITY_NM        = #{cityNm}               --도시명
             , DIST_NM        = #{distNm}               --지역명
             , ADDR_NM        = #{addrNm}               --주소명
             , ADDR_DETL_CONT = #{addrDetlCont}         --주소상세내용
             , ADDR_TP        = #{addrTp}               --주소유형
             , TAX_PAY_NO     = #{taxPayNo}             --납세번호
             , PURC_MNG_NM    = #{purcMngNm}            --구매담당자(법인)
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
           AND PARTNER_TP     = #{partnerTp}            --파트너유형
    </update>

    <!-- SA_0202 : 계약고객 주소정보 수정 -->
    <update id="updateContractCustomerAddr" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateContractCustomerAddr] */
        UPDATE SA_0202T    --계약고객상세
           SET ZIP_CD         = #{zipCd}                --우편번호
             , SUNG_CD        = #{sungCd}               --성코드
             , CITY_CD        = #{cityCd}               --도시코드
             , DIST_CD        = #{distCd}               --지역코드
             , SUNG_NM        = #{sungNm}               --성명
             , CITY_NM        = #{cityNm}               --도시명
             , DIST_NM        = #{distNm}               --지역명
             , ADDR_NM        = #{addrNm}               --주소명
             , ADDR_DETL_CONT = #{addrDetlCont}         --주소상세내용
             , ADDR_TP        = #{addrTp}               --주소유형
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
           AND PARTNER_TP     = #{partnerTp}            --파트너유형
    </update>

    <!-- SA_0205 : 중고차 수정 -->
    <update id="updateUsedCar" parameterType="ContractReVO">
        /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateUsedCar] */
        UPDATE SA_0205T    --계약중고차
           SET VIN_NO      = #{usrVinNo}          --차대번호
             , SBST_AMT    = #{usrSbstAmt}        --치환금액
             , PURC_NO     = #{purcNo}            --매입번호
             , SBUS_TP     = #{sbusTp}
             , SUBSIDY_AMT = #{subsidyAmt}
             , UPDT_USR_ID = #{updtUsrId}         --수정자ID
             , UPDT_DT     = SYSDATE
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
    </update>

    <!-- SA_0205T : 중고차 저장된 갯수 확인 -->
    <select id="selectUsedCarCnt" parameterType="ContractReVO" resultType="int">
        /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectUsedCarCnt] */
        SELECT COUNT(*)
          FROM SA_0205T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>
    <!-- SA_0205T : 중고차의 내역을 삭제 -->
    <delete id="deleteUsedCar" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.deleteUsedCar] */
        DELETE
          FROM SA_0205T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0220T : 번호판 수정 -->
    <update id="updateReg" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateReg] */
        UPDATE SA_0220T         --계약번호판등록서비스
           SET REG_PRE_AMT       = #{regPreAmt}               --등록선수금액
             , REAL_REG_AMT      = #{realRegAmt}              --실제등록금액
             , REG_FEE_AMT       = #{regFeeAmt}               --등록수수료금액
             <if test='regDistCd != null and regDistCd != ""'>
             , REG_DIST_CD       = #{regDistCd}               --등록지역코드
             </if>
             , REG_EXPC_DT       = #{regExpcDt}               --등록예상일자
             , PURC_TAX_PRE_AMT  = #{purcTaxPreAmt}           --구입세금선수금액
             , REAL_PURC_TAX_AMT = #{realPurcTaxAmt}          --실제구입세금액
             , UPDT_USR_ID       = #{updtUsrId}               --수정자ID
             , UPDT_DT           = SYSDATE
         WHERE 1 = 1
           AND DLR_CD            = #{dlrCd}                   --딜러코드
           AND CONTRACT_NO       = #{contractNo}              --계약번호
    </update>

    <!-- SA_0220T : 번호판 저장된 갯수 확인 -->
    <select id="selectRegCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectRegCnt] */
        SELECT COUNT(*)
          FROM SA_0220T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0220T : 번호판의 내역을 삭제 -->
    <delete id="deleteReg" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.deleteReg] */
        DELETE
          FROM SA_0220T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0221T : 보험헤더 수정 -->
    <update id="updateIncHead" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateIncHead] */
        UPDATE SA_0221T    --계약보험서비스헤더
           SET INC_CMP_CD    = #{incCmpCd}            --보험회사코드
             , INC_PROFIT_NM = #{incProfitNm}         --보험수혜자명
             , INC_JOIN_DT   = #{incJoinDt}           --보험가입일자
             , INC_EXPC_AMT  = #{incExpcAmt}          --보험예상금액
             , REAL_INC_AMT  = #{realIncAmt}          --실보험금액
             , INC_FEE_AMT   = #{incFeeAmt}           --보험수수료금액
             , REMARK        = #{incRemark}           --비고
             , IMPLY_YN      = #{implyYn}             --총금액포함여부
             , FIN_IMPLY_YN  = #{finImplyYn}          --재무수납포함여부
             , INC_CUST_NM   = #{incCustNm}           --피보험인
             , INC_CUST_TEL_NO      = #{incCustTelNo}       --피보험인 전화번호
             , INC_PCON_CUST_NM     = #{incPconCustNm}      --연계인
             , INC_PCON_CUST_TEL_NO = #{incPconCustTelNo}   --연계인 전화번호
             , FRC_INC_AMT   = #{frcIncAmt}           --강제보험금액
             , BUS_INC_AMT   = #{busIncAmt}           --상업보험금액
             , TRANS_TAX_AMT = #{transIncTaxAmt}      --차량선박세
             , UPDT_USR_ID   = #{updtUsrId}           --수정자ID
             , UPDT_DT       = SYSDATE
         WHERE 1 = 1
           AND DLR_CD        = #{dlrCd}               --딜러코드
           AND CONTRACT_NO   = #{contractNo}          --계약번호
    </update>

    <!-- SA_0221T : 보험헤더 저장된 갯수 확인 -->
    <select id="selectIncHeadCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectIncHeadCnt] */
        SELECT COUNT(*)
          FROM SA_0221T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0221T : 보험헤더 저장된 내역 확인 -->
    <select id="selectIncHead" parameterType="ContractReSearchVO" resultType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectIncHead] */
        SELECT TO_CHAR(NVL(UPDT_DT, REG_DT), 'YYYYMMDDHH24MISS') AS INC_UPDT_DT_STR
          FROM SA_0221T
         WHERE DLR_CD      = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>

    <!-- SA_0221T : 보험헤더의 내역을 삭제 -->
    <delete id="deleteIncHead" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.deleteIncHead] */
        DELETE
          FROM SA_0221T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0222T : 보험 아이템을 삭제한다. -->
    <delete id="deleteIncAll" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.deleteIncAll] */
        DELETE
          FROM SA_0222T    --계약보험서비스아이템
         WHERE DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
    </delete>

    <!-- SA_0223T : 금융 서비스 수정 -->
    <update id="updateFinc" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateFinc] */
        UPDATE SA_0223T    --계약금융정보
           SET FINC_CMP_CD    = #{fincCmpCd}            --금융회사코드
             , FINC_ITEM_CD   = #{fincItemCd}           --금융품목코드
             , FINC_REQ_DT    = #{fincReqDt}            --금융요청일자
             , FINC_REQ_AMT   = #{fincReqAmt}           --금융요청금액
             , FINC_END_DT    = #{fincEndDt}            --금융만기일자
             , FINC_FEE_AMT   = #{fincFeeAmt}           --금융수수료금액
             , FINC_RPAY_PRID = #{fincRpayPrid}         --금융상환기간
             , FINC_LOAD_RATE = #{fincLoadRate}         --금융대출비율
             , INST_INTR_RATE = #{instIntrRate}         --할부이자율
             , GRTE_INC_AMT   = #{grteIncAmt}           --보증보험금액
             , FINC_BURD_AMT  = #{fincBurdAmt}          --자기금액
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
    </update>

    <!-- SA_0223T : 금융 서비스 저장된 갯수 확인 -->
    <select id="selectFincCnt" parameterType="ContractReVO" resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectFincCnt] */
        SELECT COUNT(*)
          FROM SA_0223T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </select>

    <!-- SA_0223T : 금융 서비스의 내역을 삭제 -->
    <delete id="deleteFinc" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.deleteFinc] */
        DELETE
          FROM SA_0223T
         WHERE DLR_CD      = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </delete>

    <!-- SA_0223T : 금융 서비스 수정 -->
    <update id="updateFincReverse" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateFincReverse] */
        UPDATE SA_0223T    --계약금융정보
           SET FINC_CMP_CD    = #{fincCmpCd}            --금융회사코드
             , FINC_ITEM_CD   = #{fincItemCd}           --금융품목코드
             , FINC_REQ_DT    = #{fincReqDt}            --금융요청일자
             , FINC_REQ_AMT   = #{fincReqAmt}           --금융요청금액
             , FINC_END_DT    = #{fincEndDt}            --금융만기일자
             , FINC_FEE_AMT   = #{fincFeeAmt}           --금융수수료금액
             , FINC_RPAY_PRID = #{fincRpayPrid}         --금융상환기간
             , FINC_LOAD_RATE = #{fincLoadRate}         --금융대출비율
             , FINC_BURD_AMT  = #{fincBurdAmt}          --자기금액
             , UPDT_USR_ID    = #{updtUsrId}            --수정자ID
             , UPDT_DT        = SYSDATE
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
    </update>

    <!-- 계약된 보험내역 조회 -->
    <select id="selectIncListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0222T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
        <if test='sIncTp != null and sIncTp != ""'>
           AND INC_TP = #{sIncTp}
        </if>
    </select>
    <select id="selectIncListsByCondition" parameterType="ContractReSearchVO" resultType="ContractReIncVO">
        SELECT DLR_CD
             , CONTRACT_NO
             , INC_TP
             , INC_EXPC_AMT
             , REAL_INC_AMT
             , INC_PRID
             , INC_START_DT
             , INC_END_DT
             , REMARK
             , VAL_REC_AMT
          FROM SA_0222T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>

    <!-- 계약된 보험내역 저장 -->
    <insert id="insertInc" parameterType="ContractReIncVO">
        INSERT INTO SA_0222T    --계약보험서비스아이템
        (
          DLR_CD              --딜러코드
         ,CONTRACT_NO         --계약번호
         ,INC_TP              --보험유형
         ,INC_EXPC_AMT        --보험예상금액
         ,REAL_INC_AMT        --실보험금액
         ,INC_PRID            --보험기간
         ,INC_START_DT        --보험시작일자
         ,INC_END_DT          --보험종료일자
         ,REMARK              --비고
         ,VAL_REC_AMT         --수령액
         ,REG_USR_ID          --등록자ID
         ,REG_DT              --등록일자
         ,UPDT_USR_ID         --수정자ID
         ,UPDT_DT             --수정일자
        )
        VALUES
        (
          #{dlrCd}              --딜러코드
         ,#{contractNo}         --계약번호
         ,#{incTp}              --보험유형
         ,#{incExpcAmt}         --보험예상금액
         ,#{realIncAmt}         --실보험금액
         ,#{incPrid}            --보험기간
         ,#{incStartDt}         --보험시작일자
         ,#{incEndDt}           --보험종료일자
         ,#{remark}             --비고
         ,#{valRecAmt}          --수령액
         ,#{regUsrId}           --등록자ID
         ,SYSDATE
         ,#{updtUsrId}          --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약된 보험내역 수정 -->
    <update id="updateInc" parameterType="ContractReIncVO">
        UPDATE SA_0222T    --계약보험서비스아이템
           SET INC_TP       = #{incTp}              --보험유형
             , INC_EXPC_AMT = #{incExpcAmt}         --보험예상금액
             , REAL_INC_AMT = #{realIncAmt}         --실보험금액
             , INC_PRID     = #{incPrid}            --보험기간
             , INC_START_DT = #{incStartDt}         --보험시작일자
             , INC_END_DT   = #{incEndDt}           --보험종료일자
             , REMARK       = #{remark}             --비고
             , VAL_REC_AMT  = #{valRecAmt}          --수령액
             , UPDT_USR_ID  = #{updtUsrId}          --수정자ID
             , UPDT_DT      = SYSDATE
         WHERE 1 = 1
           AND DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
           AND INC_TP       = #{incTp}              --보험유형
    </update>

    <!-- 계약된 보험내역 삭제 -->
    <delete id="deleteInc" parameterType="ContractReIncVO">
        DELETE FROM SA_0222T    --계약보험서비스아이템
         WHERE DLR_CD       = #{dlrCd}              --딜러코드
           AND CONTRACT_NO  = #{contractNo}         --계약번호
           AND INC_TP       = #{incTp}              --보험유형
    </delete>

    <!-- 계약된 용품내역 조회 -->
    <select id="selectGoodsListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0204T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>
    <select id="selectGoodsListsByCondition" parameterType="ContractReSearchVO" resultType="ContractReGoodsVO">
        SELECT A.DLR_CD
             , A.CONTRACT_NO
             , A.SEQ
             , A.GOODS_CD
             , NVL(A.GOODS_NM, B.ITEM_NM) AS GOODS_NM
             , A.GOODS_CNT
             , A.GOODS_UNIT_CD
             , A.GOODS_PRC
             , A.DC_RATE
             , A.GOODS_AMT
             , A.REAL_GOODS_AMT      -- 실제용품금액(총금액)
             , A.PKG_ITEM_CD
             , A.GR_STRGE_CD
             , A.GI_STRGE_CD
             , A.DC_AMT
             , A.REF_DOC_NO
             , A.REF_DOC_LINE_NO
             , A.MVT_DOC_YY_MM
             , A.MVT_DOC_NO
             , A.MVT_DOC_LINE_NO
             , A.EXPC_GI_END_DT
             , A.EQIP_PRSN_ID
             , A.REAL_DL_DT
             , A.EQIP_COST_AMT
             , A.TOT_AMT
             , A.EXPC_EQIP_DT
             , A.EQIP_END_DT
             , A.STAT_CD
             , TO_CHAR(NVL(A.UPDT_DT, A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM SA_0204T A
          LEFT OUTER JOIN PT_0201T B    /* 품목마스터 */
            ON A.DLR_CD = B.DLR_CD
           AND A.GOODS_CD = B.ITEM_CD
         WHERE A.DLR_CD = #{sDlrCd}
           AND A.CONTRACT_NO = #{sContractNo}
    </select>


    <!-- 계약 용품내역 저장 -->
    <insert id="insertGoods" parameterType="ContractReGoodsVO">
        INSERT
          INTO SA_0204T    --계약용품내역
        (
              DLR_CD                --딜러코드
             ,CONTRACT_NO           --계약번호
             ,SEQ                   --일련번호
             ,REG_USR_ID            --등록자ID
             ,REG_DT                --등록일자
             ,UPDT_USR_ID           --수정자ID
             ,UPDT_DT               --수정일자
             ,GOODS_CD              --용품코드
             ,GOODS_NM              --용품명
             ,GOODS_CNT             --용품수
             ,GOODS_UNIT_CD         --용품단위
             ,GOODS_PRC             --용품단가
             ,DC_RATE               --할인율
             ,DC_AMT                --할인금액
             ,GOODS_AMT             --용품금액
             ,REAL_GOODS_AMT        --실제용품금액
             ,EQIP_COST_AMT         --설치금액
             ,EQIP_PRSN_ID          --설치담당자
             ,TOT_AMT               --총금액
             ,PKG_ITEM_CD           --패키지품목코드
             ,GR_STRGE_CD           --입고창고코드
             ,GI_STRGE_CD           --출고창고코드
             ,STAT_CD
             ,REF_DOC_NO            --참조문서번호
             ,REF_DOC_LINE_NO       --참조문서라인번호
             ,MVT_DOC_YY_MM         --수불문서년월일자
             ,MVT_DOC_NO            --수불문서번호
             ,MVT_DOC_LINE_NO       --수불문서라인번호
             ,EXPC_GI_END_DT
             ,REAL_DL_DT
             ,EXPC_EQIP_DT
             ,EQIP_END_DT
        )
        VALUES
        (
              #{dlrCd}                --딜러코드
             ,#{contractNo}           --계약번호
             ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0204T WHERE DLR_CD = #{dlrCd} AND CONTRACT_NO = #{contractNo})
             ,#{regUsrId}             --등록자ID
             ,SYSDATE
             ,#{updtUsrId}            --수정자ID
             ,SYSDATE
             ,#{goodsCd}              --용품코드
             ,#{goodsNm}              --용품명
             ,#{goodsCnt}             --용품수
             ,#{goodsUnitCd}          --용품단위
             ,#{goodsPrc}             --용품단가
             ,#{dcRate}               --할인율
             ,#{dcAmt}                --할인금액
             ,#{goodsAmt}             --용품금액
             ,#{realGoodsAmt}         --실제용품금액
             ,#{eqipCostAmt}          --설치금액
             ,#{eqipPrsnId}           --설치담당자
             ,#{totAmt}               --총금액
             ,#{pkgItemCd}            --패키지품목코드
             ,#{grStrgeCd}            --입고창고코드
             ,#{giStrgeCd}            --출고창고코드
             ,#{statCd}
             ,#{refDocNo}            --참조문서번호
             ,#{refDocLineNo}       --참조문서라인번호
             ,#{mvtDocYyMm}         --수불문서년월일자
             ,#{mvtDocNo}            --수불문서번호
             ,#{mvtDocLineNo}       --수불문서라인번호
             ,#{expcGiEndDt}
             ,#{realDlDt}
             ,#{expcEqipDt}
             ,#{eqipEndDt}
        )
    </insert>

    <!-- 계약 용품내역 수정 -->
    <update id="updateGoods" parameterType="ContractReGoodsVO">
       UPDATE SA_0204T       /* 계약용품정보 */
          SET UPDT_USR_ID     = #{updtUsrId}            --수정자ID
            , UPDT_DT         = SYSDATE
            , GOODS_CD        = #{goodsCd}              --용품코드
            , GOODS_NM        = #{goodsNm}              --용품명
            , GOODS_CNT       = #{goodsCnt}             --용품수
            , GOODS_UNIT_CD   = #{goodsUnitCd}          --용품단위
            , GOODS_PRC       = #{goodsPrc}             --용품단가
            , DC_RATE         = #{dcRate}               --할인율
            , DC_AMT          = #{dcAmt}                --할인금액
            , GOODS_AMT       = #{goodsAmt}             --용품금액
            , REAL_GOODS_AMT  = #{realGoodsAmt}         --실제용품금액
            , EQIP_COST_AMT   = #{eqipCostAmt}
            , EQIP_PRSN_ID    = #{eqipPrsnId}
            , TOT_AMT         = #{totAmt}               --총금액
            , PKG_ITEM_CD     = #{pkgItemCd}            --패키지품목코드
            , GR_STRGE_CD     = #{grStrgeCd}            --입고창고코드
            , GI_STRGE_CD     = #{giStrgeCd}            --출고창고코드
            , STAT_CD         = #{statCd}               --상태
            , REF_DOC_NO      = #{refDocNo}             --참조문서번호
            , REF_DOC_LINE_NO = #{refDocLineNo}         --참조문서라인번호
            , MVT_DOC_YY_MM   = #{mvtDocYyMm}           --수불문서년월일자
            , MVT_DOC_NO      = #{mvtDocNo}             --수불문서번호
            , MVT_DOC_LINE_NO = #{mvtDocLineNo}         --수불문서라인번호
            , EXPC_GI_END_DT  = #{expcGiEndDt}
            , REAL_DL_DT      = #{realDlDt}
            , EXPC_EQIP_DT    = #{expcEqipDt}
            , EQIP_END_DT     = #{eqipEndDt}
         WHERE 1 = 1
           AND DLR_CD         = #{dlrCd}                --딜러코드
           AND CONTRACT_NO    = #{contractNo}           --계약번호
           AND SEQ            = #{seq}                  --일련번호
    </update>

    <!-- 계약 용품내역 삭제 -->
    <delete id="deleteGoods" parameterType="ContractReGoodsVO">
        DELETE FROM SA_0204T    --계약용품정보
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND CONTRACT_NO = #{contractNo}        --계약번호
           AND SEQ         = #{seq}               --일련번호
    </delete>

    <!-- 계약된 대행업무내역 조회 -->
    <select id="selectAapsListsByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0217T
         WHERE DLR_CD = #{sDlrCd}
           AND CONTRACT_NO = #{sContractNo}
    </select>
    <select id="selectAapsListsByCondition" parameterType="ContractReSearchVO" resultType="AapInfoVO">
        SELECT A.DLR_CD
             , A.CONTRACT_NO
             , A.AAP_WORK_TP
             , A.REAL_AAP_AMT
             , A.AAP_IMPLY_YN
             , A.RMK
          FROM SA_0217T A
         WHERE A.DLR_CD = #{sDlrCd}
           AND A.CONTRACT_NO = #{sContractNo}
    </select>

    <!-- 계약 번호판 등록 -->
    <insert id="insertReg" parameterType="ContractReVO">
        INSERT
          INTO SA_0220T    --계약번호판등록서비스
        (
              DLR_CD                   --딜러코드
             ,CONTRACT_NO              --계약번호
             ,REG_PRE_AMT              --등록선수금액
             ,REAL_REG_AMT             --실제등록금액
             ,REG_FEE_AMT              --등록수수료금액
             ,REG_DIST_CD              --등록지역코드
             ,REG_EXPC_DT              --등록예상일자
             ,PURC_TAX_PRE_AMT         --구입세금선수금액
             ,REAL_PURC_TAX_AMT        --실제구입세금액
             ,REG_USR_ID               --등록자ID
             ,REG_DT                   --등록일자
             ,UPDT_USR_ID              --수정자ID
             ,UPDT_DT                  --수정일자
        )VALUES(
              #{dlrCd}                   --딜러코드
             ,#{contractNo}              --계약번호
             ,#{regPreAmt}               --등록선수금액
             ,#{realRegAmt}              --실제등록금액
             ,#{regFeeAmt}               --등록수수료금액
             ,#{regDistCd}               --등록지역코드
             ,#{regExpcDt}               --등록예상일자
             ,#{purcTaxPreAmt}           --구입세금선수금액
             ,#{realPurcTaxAmt}          --실제구입세금액
             ,#{regUsrId}                --등록자ID
             ,SYSDATE
             ,#{updtUsrId}               --수정자ID
             ,SYSDATE
        )
    </insert>

    <!-- 계약 보험헤더 등록 -->
    <insert id="insertIncHead" parameterType="ContractReVO">
        INSERT
          INTO SA_0221T    --계약보험서비스헤더
        (
          DLR_CD               --딜러코드
         ,CONTRACT_NO          --계약번호
         ,INC_CMP_CD           --보험회사코드
         ,INC_PROFIT_NM        --보험수혜자명
         ,INC_JOIN_DT          --보험가입일자
         ,INC_EXPC_AMT         --보험예상금액
         ,REAL_INC_AMT         --실보험금액
         ,INC_FEE_AMT          --보험수수료금액
         ,REMARK               --비고
         ,IMPLY_YN             --총금액포함여부
         ,FIN_IMPLY_YN         --재무수납포함여부
         ,INC_CUST_NM          --피보험인
         ,INC_CUST_TEL_NO      --피보험인 전화번호
         ,INC_PCON_CUST_NM     --연계인
         ,INC_PCON_CUST_TEL_NO --연계인 전화번호
         ,FRC_INC_AMT          --강제보험금액
         ,BUS_INC_AMT          --상업보험금액
         ,TRANS_TAX_AMT        --차량선박세
         ,REG_USR_ID           --등록자ID
         ,REG_DT               --등록일자
         ,UPDT_USR_ID          --수정자ID
         ,UPDT_DT              --수정일자
        )
        VALUES
        (
          #{dlrCd}               --딜러코드
         ,#{contractNo}          --계약번호
         ,#{incCmpCd}            --보험회사코드
         ,#{incProfitNm}         --보험수혜자명
         ,#{incJoinDt}           --보험가입일자
         ,#{incExpcAmt}          --보험예상금액
         ,#{realIncAmt}          --실보험금액
         ,#{incFeeAmt}           --보험수수료금액
         ,#{incRemark}           --비고
         ,#{implyYn}
         ,#{finImplyYn}
         ,#{incCustNm}
         ,#{incCustTelNo}
         ,#{incPconCustNm}
         ,#{incPconCustTelNo}
         ,#{frcIncAmt}
         ,#{busIncAmt}
         ,#{transIncTaxAmt}
         ,#{regUsrId}            --등록자ID
         ,SYSDATE
         ,#{updtUsrId}           --수정자ID
         ,SYSDATE
        )
    </insert>

    <!-- 계약된 금융서비스 등록 -->
    <insert id="insertFinc" parameterType="ContractReVO">
        INSERT INTO SA_0223T    --계약금융정보
        (
              DLR_CD                --딜러코드
             ,CONTRACT_NO           --계약번호
             ,FINC_CMP_CD           --금융회사코드
             ,FINC_ITEM_CD          --금융품목코드
             ,FINC_REQ_DT           --금융요청일자
             ,FINC_REQ_AMT          --금융요청금액
             ,FINC_END_DT           --금융만기일자
             ,FINC_FEE_AMT          --금융수수료금액
             ,FINC_RPAY_PRID        --금융상환기간
             ,FINC_LOAD_RATE        --금융대출비율
             ,INST_INTR_RATE
             ,GRTE_INC_AMT
             ,FINC_BURD_AMT         --자기금액
             ,REG_USR_ID            --등록자ID
             ,REG_DT                --등록일자
             ,UPDT_USR_ID           --수정자ID
             ,UPDT_DT               --수정일자
        ) VALUES (
              #{dlrCd}                --딜러코드
             ,#{contractNo}           --계약번호
             ,#{fincCmpCd}            --금융회사코드
             ,#{fincItemCd}           --금융품목코드
             ,#{fincReqDt}            --금융요청일자
             ,#{fincReqAmt}           --금융요청금액
             ,#{fincEndDt}            --금융만기일자
             ,#{fincFeeAmt}           --금융수수료금액
             ,#{fincRpayPrid}         --금융상환기간
             ,#{fincLoadRate}         --금융대출비율
             ,#{instIntrRate}         --할부이자율
             ,#{grteIncAmt}           --보증보험금액
             ,#{fincBurdAmt}          --자기금액
             ,#{regUsrId}             --등록자ID
             ,SYSDATE
             ,#{updtUsrId}            --수정자ID
             ,SYSDATE
        )
    </insert>


    <!-- 딜러 프로모션에 대한 할인 레벨을 조회한다. -->
    <select id="selectDlrDcLevel2" parameterType="ContractReSearchVO" resultType="ContractReVO">
     SELECT CASE WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  0 THEN ''
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT1 THEN '01'
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT2 THEN '02'
                 WHEN NVL(C.PROMOTION_AMT, 0) <![CDATA[ <= ]]>  B.CAR_DC_AMT3 THEN '03'
                 ELSE '04'
             END AS DC_LVL_CD
          , C.PROMOTION_AMT
          , A.PRC_NREG_YN
       FROM SA_0119T A
          , SA_0120T B
          , (
              SELECT DLR_CD
                   , CONTRACT_NO
                   , SUM(PROMOTION_AMT) AS PROMOTION_AMT
                FROM SA_0203T
               WHERE PROMOTION_OWN_CD = '02'  -- 딜러
                 AND USE_YN = 'Y'
                 AND CONTRACT_NO = #{sContractNo}
                 AND DLR_Cd = #{sDlrCd}
               GROUP BY DLR_CD, CONTRACT_NO
            ) C
      WHERE A.DLR_CD = B.DLR_CD
        AND A.DLR_CD = C.DLR_CD(+)
        AND B.MODEL_CD = #{sModelCd}
        AND B.OCN_CD =  #{sOcnCd}
        AND B.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
        AND B.END_DT <![CDATA[ >= ]]> #{sStartContractDt}

        AND A.DC_APPLY_YN = 'Y'
        AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
        AND A.end_dt <![CDATA[ >= ]]> #{sStartContractDt}
        AND A.DLR_Cd = #{sDlrCd}
    </select>

    <select id="selectDlrDcLevelCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
           FROM (
               SELECT 'A' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  #{sOcnCd}
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'X' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'Z' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = 'ALL'
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

                ORDER BY ETC DESC           -- ALL 우선 적용
             ) A
        WHERE ROWNUM = 1                    -- 다중건일시 한건만 처리
    </select>


    <select id="selectDlrDcLevel" parameterType="ContractReSearchVO" resultType="ContractReVO">
        SELECT A.DC_LVL_CD
             , A.PRC_NREG_YN
           FROM (
               SELECT 'A' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  #{sOcnCd}
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'X' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = #{sModelCd}
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

               UNION

               SELECT 'Z' AS ETC
                    , CASE WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= 0 ]]> THEN ''
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT1 THEN '01'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT2 THEN '02'
                           WHEN NVL(#{sPromotionAmt}, 0) <![CDATA[ <= ]]> A.CAR_DC_AMT3 THEN '03'
                           ELSE '04'
                      END AS DC_LVL_CD
                    , A.PRC_NREG_YN
                 FROM SA_0120T A
                where A.CARLINE_CD = #{sCarlineCd}
                  and A.MODEL_CD = 'ALL'
                  AND A.OCN_CD =  'ALL'
                  AND A.START_DT <![CDATA[ <= ]]> #{sStartContractDt}
                  AND A.END_DT   <![CDATA[ >= ]]> #{sStartContractDt}
                  AND A.DLR_Cd = #{sDlrCd}

                ORDER BY ETC DESC           -- ALL 우선 적용
             ) A
        WHERE ROWNUM = 1                    -- 다중건일시 한건만 처리
    </select>

    <!-- 계약 승인확정한다.(상태만 변경)  -->
    <update id="approval" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '20'
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약을 삭제한다.(상태만 변경)  -->
    <update id="deleteContract" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '90'
             , VIN_NO              = NULL
             , CNCL_DT             = SYSDATE
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약을 삭제한다.(상태만 변경)  -->
    <update id="cancelContract" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET CONTRACT_STAT_CD = '91'
             , VIN_NO              = NULL
             , CNCL_DT             = SYSDATE
             , UPDT_USR_ID         = #{updtUsrId}   --수정자ID
             , UPDT_DT             = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약의 예판번호를 지워준다. -->
    <update id="updateContractBefore" parameterType="ContractReVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.updateContractBefore] */
        UPDATE SA_0201T
           SET UPDT_USR_ID     = #{updtUsrId}
             , UPDT_DT         = SYSDATE
             , BEFORE_NO       = #{beforeNo}
             , BEFORE_IMPLY_YN = #{beforeImplyYn}
             , RESERV_CONT_AMT = #{reservContAmt}
             , REAL_PAY_AMT    = #{realPayAmt}
         WHERE 1 = 1
           AND DLR_CD          = #{dlrCd}
           AND CONTRACT_NO     = #{contractNo}
    </update>


    <!--계약 미배정 차량조회 -->
    <select id="selectContractReVinNosByConditionCnt" parameterType="ContractReSearchVO" resultType="int">
        SELECT COUNT(*)
          FROM SA_0121T A
         WHERE 1 = 1
         <if test='sCarlineCd != null and sCarlineCd != ""'>
           AND A.CARLINE_CD = #{sCarlineCd}
         </if>
         <if test='sModelCd != null and sModelCd != ""'>
           AND A.MODEL_CD = #{sModelCd}
         </if>
         <if test='sOcnCd != null and sOcnCd != ""'>
           AND A.OCN_CD = #{sOcnCd}
         </if>
         <if test='sExtColorCd != null and sExtColorCd != ""'>
           AND A.EXT_COLOR_CD = #{sExtColorCd}
         </if>
         <if test='sIntColorCd != null and sIntColorCd != ""'>
           AND A.INT_COLOR_CD = #{sIntColorCd}
         </if>
         <if test='sVinNo != null and sVinNo != ""'>
           AND A.VIN_NO LIKE '%'|| UPPER(#{sVinNo}) ||'%'
         </if>
          <if test='sVinNo1 != null and sVinNo1 != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo1,"*")'>
              <bind name='sVinNo1' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo1, "*", "%")' />
                AND A.VIN_NO1 LIKE UPPER(#{sVinNo1})
            </when>
            <otherwise>
                AND A.VIN_NO1 = UPPER(#{sVinNo1})
            </otherwise>
          </choose>
          </if>
          <if test='sVinNo2 != null and sVinNo2 != ""'>
          <choose>
            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo2,"*")'>
              <bind name='sVinNo2' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo2, "*", "%")' />
                AND A.VIN_NO2 LIKE UPPER(#{sVinNo2})
            </when>
            <otherwise>
                AND A.VIN_NO2 = UPPER(#{sVinNo2})
            </otherwise>
          </choose>
          </if>
          <if test='sFscCd != null and sFscCd != ""'>
            AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
          </if>
           AND A.NCAR_DSTIN_CD = 'N'
           AND A.CONTRACT_NO IS NULL
           --AND NVL(A.OWN_STAT_CD, 'O') = 'O'
           AND A.CAR_STAT_CD IN ('60')
           AND A.ORD_DLR_CD = #{sDlrCd}
           ORDER BY A.RETL_PRC DESC, A.CAR_STAT_CD ASC
    </select>
    <select id="selectContractReVinNosByCondition" parameterType="ContractReSearchVO" resultType="VehicleMasterVO">
        SELECT X.*
             , Z.WH_PRC
             , Z.MS_PRC
          FROM (
                SELECT ROWNUM AS RNUM
                     , FN_GET_CARLINE_NM(T1.CARLINE_CD) AS CARLINE_NM
                     , FN_GET_MODEL_TP_CD(T1.MODEL_CD, T1.OCN_CD) AS FSC_CD
                     , FN_GET_MODEL_TP_NM(T1.MODEL_CD, T1.OCN_CD) AS FSC_NM
                     , FN_GET_OCN_NM(T1.MODEL_CD, T1.OCN_CD) AS OCN_NM
                     , FN_GET_EXT_COLOR_NM(T1.EXT_COLOR_CD) AS EXT_COLOR_NM
                     , FN_GET_INT_COLOR_NM(T1.INT_COLOR_CD) AS INT_COLOR_NM
                     , T1.*
                  FROM (
                        SELECT A.CAR_ID
                             , A.VIN_NO
                             , A.CAR_STAT_CD
                             , NVL( TRUNC(MONTHS_BETWEEN(SYSDATE, A.CAR_VIN_ALLOC_DT), 0) , 0) AS MM_CNT
                             , NVL(A.RETL_PRC, 0) AS RETL_PRC
                             , A.CARLINE_CD                --차종코드
                             , A.MODEL_CD                  --모델코드
                             , A.OCN_CD                    --OCN코드
                             , A.EXT_COLOR_CD              --외장색상코드
                             , A.INT_COLOR_CD              --내장색상코드
                             , A.BLOCK_YN
                             , A.BLOCK_SALE_ADV_NO
                             , NVL(A.DAMAGE_CD, '02') AS DAMAGE_CD
                             , NVL(A.OWN_STAT_CD, 'O') as OWN_STAT_CD
                             , CASE WHEN SA0421.REQ_STAT_CD = 'Y' AND SA0421.APPROVE_YN = 'Y' THEN 'Y'
                               ELSE 'N' END AS EXP_APR_YN
                             , SA0201.CONTRACT_NO
                             , (SELECT CUST_NM FROM CR_0101T
                                 WHERE DLR_CD = SA0201.DLR_CD
                                   AND CUST_NO = SA0201.CONTRACT_CUST_NO
                                ) AS CUST_NM
                          FROM SA_0121T A
                             , (SELECT * FROM SA_0201T
                                 WHERE CONTRACT_STAT_CD NOT IN ('90', '91')
                                ) SA0201
                             , (
                                 SELECT A.*
                                   FROM SA_0421T A
                                      , (
                                          SELECT DLR_CD, VIN_NO1, VIN_NO2, MAX(SEQ) AS SEQ
                                            FROM SA_0421T
                                           GROUP BY DLR_CD, VIN_NO1, VIN_NO2
                                        )B
                                  WHERE A.DLR_CD = B.DLR_CD
                                    AND A.VIN_NO1 = B.VIN_NO1
                                    AND A.VIN_NO2 = B.VIN_NO2
                                 ) SA0421
                         WHERE 1 = 1
                           AND A.ORD_DLR_CD = SA0201.DLR_CD(+)
                           AND A.VIN_NO = SA0201.VIN_NO(+)
                           AND A.ORD_DLR_CD = SA0421.DLR_CD(+)
                           AND A.VIN_NO1 = SA0421.VIN_NO1(+)
                           AND A.VIN_NO2 = SA0421.VIN_NO2(+)
                           AND A.CONTRACT_NO = SA0421.CONTRACT_NO(+)

                         <if test='sCarlineCd != null and sCarlineCd != ""'>
                           AND A.CARLINE_CD = #{sCarlineCd}
                         </if>
                         <if test='sModelCd != null and sModelCd != ""'>
                           AND A.MODEL_CD = #{sModelCd}
                         </if>
                         <if test='sOcnCd != null and sOcnCd != ""'>
                           AND A.OCN_CD = #{sOcnCd}
                         </if>
                         <if test='sExtColorCd != null and sExtColorCd != ""'>
                           AND A.EXT_COLOR_CD = #{sExtColorCd}
                         </if>
                         <if test='sIntColorCd != null and sIntColorCd != ""'>
                           AND A.INT_COLOR_CD = #{sIntColorCd}
                         </if>
                         <if test='sVinNo != null and sVinNo != ""'>
                           AND A.VIN_NO LIKE '%'|| UPPER(#{sVinNo}) ||'%'
                         </if>
                          <if test='sVinNo1 != null and sVinNo1 != ""'>
                          <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo1,"*")'>
                              <bind name='sVinNo1' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo1, "*", "%")' />
                                AND A.VIN_NO1 LIKE UPPER(#{sVinNo1})
                            </when>
                            <otherwise>
                                AND A.VIN_NO1 = UPPER(#{sVinNo1})
                            </otherwise>
                          </choose>
                          </if>
                          <if test='sVinNo2 != null and sVinNo2 != ""'>
                          <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sVinNo2,"*")'>
                              <bind name='sVinNo2' value='@org.apache.commons.lang3.StringUtils@replace(sVinNo2, "*", "%")' />
                                AND A.VIN_NO2 LIKE UPPER(#{sVinNo2})
                            </when>
                            <otherwise>
                                AND A.VIN_NO2 = UPPER(#{sVinNo2})
                            </otherwise>
                          </choose>
                          </if>
                          <if test='sFscCd != null and sFscCd != ""'>
                              AND (SELECT X.FSCP_MODTP_CD FROM SA_0105T X WHERE X.MODEL_CD = A.MODEL_CD AND X.OCN_CD = A.OCN_CD)  = #{sFscCd}
                          </if>
                           AND A.NCAR_DSTIN_CD = 'N'
                           AND A.CONTRACT_NO IS NULL
                           --AND NVL(A.OWN_STAT_CD, 'O') = 'O'
                           AND A.CAR_STAT_CD IN ('60')
                           AND A.ORD_DLR_CD = #{sDlrCd}
                           ORDER BY A.RETL_PRC DESC, A.CAR_STAT_CD ASC
                    ) T1
                WHERE 1 = 1
                <if test='firstIndex != -1 and lastIndex != -1'>
                  AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
             ) X
            ,(
               SELECT MODEL_CD
                    , OCN_CD
                    , MAX(WH_PRC) AS WH_PRC
                    , MAX(MS_PRC) AS MS_PRC
                 FROM SA_0110T
                where USE_YN = 'Y'
                  AND START_DT <![CDATA[<=]]> SYSDATE   -- 시작일
                  AND END_DT   <![CDATA[>=]]> SYSDATE   -- 종료일
                GROUP BY MODEL_CD, OCN_CD
             ) Z
        WHERE 1 = 1
          AND X.MODEL_CD = Z.MODEL_CD(+)
          AND X.OCN_CD   = Z.OCN_CD(+)
          <if test='firstIndex != -1 and lastIndex != -1'>
            AND RNUM <![CDATA[>]]> #{firstIndex}
          </if>
    </select>

    <!-- 기타업무 [완성]상태 조회 -->
    <select id="selectContractEtcWorkCheck" parameterType="map" resultType="ContractReVO">
        SELECT A.CONTRACT_NO
             , CASE WHEN A.CONTRACT_STAT_CD != '20' THEN 'N'
                    ELSE 'Y'
                END AS CONTRACT_YN
             , A.CONTRACT_STAT_CD
             , CASE WHEN B.INC_NO IS NULL THEN 'Y'
                    WHEN B.INC_NO IS NOT NULL AND B.INC_STAT != '20' THEN 'N'
                    ELSE 'Y'
                END AS INC_YN
             , B.INC_STAT
             , CASE WHEN C.GOODS_CONTRACT_NO IS NULL THEN 'Y'
                    WHEN C.GOODS_CONTRACT_NO IS NOT NULL AND C.CONTRACT_STAT_CD != '40' THEN 'N'
                    ELSE 'Y'
                END AS GOODS_YN
             , C.CONTRACT_STAT_CD
             , CASE WHEN D.FINC_NO IS NULL THEN 'Y'
                    WHEN D.FINC_NO IS NOT NULL AND D.FINC_STAT_CD != '04' THEN 'N'
                    ELSE 'Y'
                END AS FINC_YN
             , D.FINC_STAT_CD
             , CASE WHEN NVL(A.UATC_CAR_PURC_YN, 'N') = 'N' THEN 'Y'
                    WHEN E.PURC_NO IS NULL THEN 'Y'
                    WHEN E.PURC_NO IS NOT NULL AND E.PURC_STAT_CD != '04' THEN 'N'
                END AS USE_YN
             , E.PURC_STAT_CD
             , CASE WHEN F.FIN_DOC_NO IS NULL THEN 'Y'
                    WHEN F.FIN_DOC_NO IS NOT NULL AND F.PAYMENT_TP != '02' AND G.ALLOW_CONTRACT_SALE_YN = 'Y' THEN 'N'
                    ELSE 'Y'
                END AS PAY_YN
             , F.PAYMENT_TP
          FROM SA_0201T A             -- 계약
         LEFT OUTER JOIN SA_0216T B   -- 보험
            ON A.DLR_CD = B.DLR_CD
           AND A.CONTRACT_NO = B.CONTRACT_NO
         LEFT OUTER JOIN SA_0261T C   -- 용품
           ON A.DLR_CD = C.DLR_CD
          AND A.CONTRACT_NO = C.SALE_CONTRACT_NO
         LEFT OUTER JOIN SA_0233T D   -- 금융
           ON A.DLR_CD = D.DLR_CD
          AND A.CONTRACT_NO = D.CONTRACT_NO
         LEFT OUTER JOIN SA_0241T E   -- 중고차
           ON A.DLR_CD = E.DLR_CD
          AND A.CONTRACT_NO = E.CONTRACT_NO
         LEFT OUTER JOIN SA_0451T F   -- 수납
           ON A.DLR_CD = F.DLR_CD
          AND A.CONTRACT_NO = F.JOB_CONTRACT_NO
          AND F.JOB_TP = 'C'
         LEFT OUTER JOIN CM_0101T G   -- 딜러정보
           ON A.DLR_CD = G.DLR_CD
          WHERE A.DLR_CD = #{dlrCd}
            AND A.CONTRACT_NO = #{contractNo}
    </select>

    <!-- 계약삭제,취소 가능상태 조회 -->
    <select id="selectContractCancelEtcWorkCheck" parameterType="map" resultType="ContractReVO">
        SELECT A.CONTRACT_NO
             , A.VIN_NO
             , CASE WHEN A.VIN_NO IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END AS VIN_YN
             , CASE WHEN  B.INC_STAT = '20' THEN 'Y'
                    ELSE 'N'
                END AS INC_YN
             , B.INC_STAT
             , CASE WHEN C.CONTRACT_STAT_CD = '20' THEN 'Y'
                    WHEN C.CONTRACT_STAT_CD = '30' THEN 'Y'
                    WHEN C.CONTRACT_STAT_CD = '40' THEN 'Y'
                    ELSE 'N'
                END AS GOODS_YN
             , C.CONTRACT_STAT_CD
             , CASE WHEN D.FINC_STAT_CD = '04' THEN 'Y'
                    ELSE 'N'
                END AS FINC_YN
             , D.FINC_STAT_CD
             , CASE WHEN E.PURC_STAT_CD = '01' THEN 'Y'
                    WHEN E.PURC_STAT_CD = '04' THEN 'Y'
                    ELSE 'N'
                END AS USE_YN
             , E.PURC_STAT_CD
             , CASE WHEN F.PAYMENT_TP = '02'  THEN 'Y'
                    WHEN F.TOT_PAY_AMT > 0    THEN 'Y'
                    ELSE 'N'
                END AS PAY_YN
             , F.PAYMENT_TP
          FROM SA_0201T A             -- 계약
         LEFT OUTER JOIN SA_0216T B   -- 보험
            ON A.DLR_CD = B.DLR_CD
           AND A.CONTRACT_NO = B.CONTRACT_NO
         LEFT OUTER JOIN SA_0261T C   -- 용품
           ON A.DLR_CD = C.DLR_CD
          AND A.CONTRACT_NO = C.SALE_CONTRACT_NO
         LEFT OUTER JOIN SA_0233T D   -- 금융
           ON A.DLR_CD = D.DLR_CD
          AND A.CONTRACT_NO = D.CONTRACT_NO
         LEFT OUTER JOIN SA_0241T E   -- 중고차
           ON A.DLR_CD = E.DLR_CD
          AND A.CONTRACT_NO = E.CONTRACT_NO
         LEFT OUTER JOIN SA_0451T F   -- 수납
           ON A.DLR_CD = F.DLR_CD
          AND A.CONTRACT_NO = F.JOB_CONTRACT_NO
          AND F.JOB_TP = 'C'
         LEFT OUTER JOIN CM_0101T G   -- 딜러정보
           ON A.DLR_CD = G.DLR_CD
          WHERE A.DLR_CD = #{dlrCd}
            AND A.CONTRACT_NO = #{contractNo}
    </select>


    <!-- 임시배정(상태변경) -->
    <update id="updateCarAssign" parameterType="VehicleMasterVO">
         UPDATE SA_0121T
            SET OWN_STAT_CD = #{ownStatCd}
              , UPDT_USR_ID = #{regUsrId}
              , UPDT_DT     = SYSDATE
         WHERE ORD_DLR_CD = #{dlrCd}
           AND VIN_NO = #{vinNo}
    </update>


    <!--계약 상태 조회 (출고 처리시 조회) -->
    <select id="selectContractStatCd" parameterType="ContractSearchVO" resultType="java.lang.String">
        SELECT CONTRACT_STAT_CD
          FROM SA_0201T
          WHERE DLR_CD = #{sDlrCd}
            AND CONTRACT_NO = #{sContractNo}
    </select>


    <!-- 품목리스트(판매단가용)-계약 용품를 조회한다. -->
    <select id="selectItemSalePrcPopupByConditionCnt" parameterType="ContractReSearchVO"  resultType="int">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectItemSalePrcPopupByConditionCnt] */
            SELECT  COUNT(*) AS VALUE
              FROM   PT_0201T A
                       LEFT OUTER JOIN (
                                  SELECT   DLR_CD
                                          ,ITEM_CD
                                          ,MAX(PRC_TP) AS PRC_TP
                                          ,MAX(LINE_NO) AS LINE_NO
                                          ,MAX(NVL(RETL_PRC,0)) AS RETL_PRC
                                    FROM   PT_0214T
                                   WHERE   DLR_CD = #{sDlrCd}
                                     AND   DEL_YN != 'Y'
                                  GROUP BY DLR_CD, ITEM_CD
                               ) B
                              ON A.DLR_CD  = B.DLR_CD
                             AND A.ITEM_CD = B.ITEM_CD
                        LEFT OUTER JOIN PT_0301T C
                           ON A.DLR_CD      = C.DLR_CD
                          AND A.GI_STRGE_CD = C.STRGE_CD
                          AND A.ITEM_CD     = C.ITEM_CD
             WHERE   A.DLR_CD  = #{sDlrCd}
               <if test='sItemCd      != null and sItemCd         != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                     <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                       AND A.ITEM_CD LIKE #{sItemCd}
                   </when>
                   <otherwise>
                     AND A.ITEM_CD = #{sItemCd}
                   </otherwise>
                 </choose>
               </if>
               <if test='sItemNm      != null and sItemNm         != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemNm,"*")'>
                     <bind name='sItemNm' value='@org.apache.commons.lang3.StringUtils@replace(sItemNm, "*", "%")' />
                       AND A.ITEM_NM LIKE #{sItemNm}
                   </when>
                   <otherwise>
                     AND A.ITEM_NM = #{sItemNm}
                   </otherwise>
                 </choose>
               </if>
               <if test='sCarlineCd   != null and sCarlineCd      != ""'> AND A.CARLINE_CD       = #{sCarlineCd}     </if>        --차종
               AND   A.END_YN  != 'Y'
               AND   A.ITEM_DSTIN_CD in ('02','05')     -- 02부품, 05악세사리
    </select>

    <!-- 품목리스트(판매단가용)-계약 용품를 조회한다. -->
    <select id="selectItemSalePrcPopupByCondition" parameterType="ContractReSearchVO" resultType="ContractReGoodsVO">
    /* [chn.bhmc.dms.sal.cnt.service.dao.ContractMntDAO.selectItemSalePrcPopupByCondition] */
     SELECT   RNUM
             ,DLR_CD                     --딜러코드
             ,ITEM_CD                    --품목코드
             ,ITEM_NM                    --품목명
             ,STOCK_UNIT_CD              --재고단위
             ,PRC_TP                     --구매단가유형
             ,SALE_PRC_AMT               --판매단가
             ,CARLINE_CD                 --차종
             ,FN_GET_CARLINE_NM(CARLINE_CD) AS CARLINE_NM
             ,PURC_LEAD_HM               --구매리드타임
             ,NVL(GR_STRGE_CD,' ') AS GR_STRGE_CD              --입고창고
             ,NVL(GI_STRGE_CD,' ') AS GI_STRGE_CD              --출고창고
             ,NVL(AVLB_STOCK_QTY, 0) AS AVLB_STOCK_QTY         --가용재고
       FROM
     (
      SELECT  ROWNUM AS RNUM
             ,T1.DLR_CD                     --딜러코드
             ,T1.ITEM_CD                    --품목코드
             ,T1.ITEM_NM                    --품목명
             ,T1.STOCK_UNIT_CD              --재고단위
             ,T1.PRC_TP                     --구매단가유형
             ,T1.SALE_PRC_AMT
             ,T1.ABC_IND                    --ABC CLASS
             ,T1.CARLINE_CD                 --차종
             ,T1.PURC_LEAD_HM               --구매리드타임
             ,T1.GR_STRGE_CD                --입고창고
             ,T1.GI_STRGE_CD                --출고창고
             ,T1.AVLB_STOCK_QTY             --가용재고
       FROM
       (
            SELECT   A.DLR_CD
                    ,A.ITEM_CD
                    ,A.ITEM_NM
                    ,A.STOCK_UNIT_CD
                    ,B.PRC_TP
                    ,NVL(B.RETL_PRC, 0) AS SALE_PRC_AMT
                    ,A.ABC_IND
                    ,A.CARLINE_CD
                    ,A.PURC_LEAD_HM
                    ,A.GR_STRGE_CD
                    ,A.GI_STRGE_CD
                    ,C.AVLB_STOCK_QTY
              FROM   PT_0201T A
                     LEFT OUTER JOIN (
                                  SELECT   DLR_CD
                                          ,ITEM_CD
                                          ,MAX(PRC_TP) AS PRC_TP
                                          ,MAX(LINE_NO) AS LINE_NO
                                          ,MAX(NVL(RETL_PRC,0)) AS RETL_PRC
                                    FROM   PT_0214T
                                   WHERE   DLR_CD = #{sDlrCd}
                                     AND   DEL_YN != 'Y'
                                  GROUP BY DLR_CD, ITEM_CD
                                ) B
                              ON A.DLR_CD = B.DLR_CD
                             AND A.ITEM_CD= B.ITEM_CD
                         LEFT OUTER JOIN PT_0301T C
                           ON A.DLR_CD      = C.DLR_CD
                          AND NVL(#{sStrgeCd}, A.GI_STRGE_CD) = C.STRGE_CD
                          AND A.ITEM_CD     = C.ITEM_CD
             WHERE   A.DLR_CD  = #{sDlrCd}
               <if test='sItemCd      != null and sItemCd         != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                     <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                       AND A.ITEM_CD LIKE #{sItemCd}
                   </when>
                   <otherwise>
                     AND A.ITEM_CD = #{sItemCd}
                   </otherwise>
                 </choose>
               </if>
               <if test='sItemNm      != null and sItemNm         != ""'>
                 <choose>
                   <when test='@org.apache.commons.lang3.StringUtils@contains(sItemNm,"*")'>
                     <bind name='sItemNm' value='@org.apache.commons.lang3.StringUtils@replace(sItemNm, "*", "%")' />
                       AND A.ITEM_NM LIKE #{sItemNm}
                   </when>
                   <otherwise>
                     AND A.ITEM_NM = #{sItemNm}
                   </otherwise>
                 </choose>
               </if>
               <if test='sCarlineCd   != null and sCarlineCd      != ""'> AND A.CARLINE_CD       = #{sCarlineCd}     </if>        --차종
               AND   A.END_YN  != 'Y'
               AND   A.ITEM_DSTIN_CD in ('02','05')
             ORDER BY
             <choose>
                 <when test='sort != null'>
                     <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                         <choose>
                             <when test='item.field == "itemCd"'>             ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                             <when test='item.field == "itemNm"'>             ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                             <otherwise>
                               DLR_CD ASC
                             ,ITEM_CD ASC
                             </otherwise>
                         </choose>
                     </foreach>
                 </when>
                 <otherwise>
                   DLR_CD ASC
                 ,ITEM_CD ASC
                 </otherwise>
             </choose>
           ) T1
       <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
       </where>
     )
     <where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
     </where>
    </select>

    <!-- 계약상태변경시 : EAI호출로 DCS의 Data보정 -->
    <insert id="procDlrRetailContract" parameterType="ContractReVO" statementType="CALLABLE">
        {CALL SP_SAL_DMS_P_0201T_IF(
              'SAL068'
            , #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{contractNo, mode=IN, jdbcType=VARCHAR}
            , ''
            , ''
        )}
    </insert>

    <!-- 계약 가격 내역 변경 -->
    <update id="updateContractPrice" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET RETL_AMT      = #{retlAmt}
             , PROMOTION_AMT = #{promotionAmt}
             , SBST_AMT      = #{sbstAmt}
             , GOODS_AMT     = #{goodsAmt}
             , REAL_CAR_AMT  = #{realCarAmt}
             , ETC_SUM_AMT   = #{etcSumAmt}
             , REAL_PAY_AMT  = #{realPayAmt}
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 계약 용품 수정을 위한 삭제 -->
    <delete id="deleteContractGoods" parameterType="ContractReSearchVO">
        DELETE FROM SA_0204T    --계약용품정보
         WHERE 1 = 1
           AND DLR_CD      = #{sDlrCd}             --딜러코드
           AND CONTRACT_NO = #{sContractNo}        --계약번호
    </delete>

    <!-- 계약 가격 내역 변경(대행업무) -->
    <update id="updateContractAapMngPrice" parameterType="ContractReVO">
        UPDATE SA_0201T
           SET SBST_AMT      = #{sbstAmt}
             , GOODS_AMT     = #{goodsAmt}
             , INC_AMT       = #{incAmt}
             , AAP_AMT       = #{aapAmt}
             , REAL_CAR_AMT  = #{realCarAmt}
             , REAL_PAY_AMT  = #{realPayAmt}
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>


    <!-- 사용자의 채널유형 조회  -->
    <select id="selectSaleEmpChannelTupeSearch" parameterType="ContractReSearchVO" resultType="ChnInfoVO">
        SELECT T.TSK_CD
             , T.TSK_DETL
             , T.DSTB_CHN_CD
             , ( SELECT Z4.CMM_CD_NM
                   FROM (SELECT A.CMM_CD
                              , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                          FROM CM_0303T A
                          LEFT OUTER JOIN CM_0304T B
                                ON A.CMM_GRP_CD = B.CMM_GRP_CD
                               AND A.CMM_CD = B.CMM_CD
                               AND B.LANG_CD = #{sLangCd}
                         WHERE A.CMM_GRP_CD = 'COM072'   /*판매고문 채널유형*/
                           AND A.USE_YN = 'Y'
                         ) Z4
                 WHERE T.DSTB_CHN_CD = Z4.CMM_CD
               ) AS DSTB_CHN_NM
         FROM (
                SELECT A.TSK_CD
                     , A.TSK_DETL
                     , CASE WHEN A.TSK_CD = 'B40' AND A.TSK_DETL IS NOT NULL
                                                  THEN ( SELECT Z.REMARK1
                                                           FROM CM_0303T Z
                                                          WHERE Z.CMM_GRP_CD = 'COM071'   /* 판매고문 세부직무*/
                                                            AND Z.USE_YN = 'Y'
                                                            AND Z.CMM_CD = A.TSK_DETL
                                                        )
                             ELSE '01'      -- 전시장
                        END AS DSTB_CHN_CD
                  FROM CM_0801T A
                 WHERE A.USR_ID = #{sSaleEmpNo}
               ) T
    </select>

    <!-- 딜러의 2급딜러를 조회한다. -->
    <select id="selectlvTwoDlrOrgsByCondition" parameterType="String" resultType="ChnInfoVO">
        SELECT T.SDLR_CD
             , T.SDLR_NM
             , '['||T.SDLR_CD||']' || T.SDLR_NM AS SDLR_NMS
             , T.SDLR_TP
          FROM CM_0101T S
             , SA_0504T T
         WHERE S.DLR_CD = T.DLR_CD
           AND T.DLR_CD = #{sDlrCd}
           AND T.SDLR_TP IN ('EW', 'WX') -- EW 2급, WX 위성
           ORDER BY T.SDLR_CD ASC
   </select>
</mapper>