<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chn.bhmc.dms.sal.usc.service.dao.PurcEvalDAO">

    <!-- 조회 목록 - 중고차량평가목록  -->
    <select id="selectPurcByCondition" parameterType="PurcEvalSearchVO" resultType="PurcEvalVO">

        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                  SELECT A.DLR_CD
                        ,A.PURC_NO
                        ,A.PURC_CUST_NO
                        ,( SELECT CUST_NM
                             FROM CR_0101T
                            WHERE DLR_CD  = A.DLR_CD
                              AND CUST_NO = PURC_CUST_NO
                         ) AS PURC_CUST_NM
                        ,A.TEL_NO1
                        ,A.EXCH_YN
                        ,A.PURC_STAT_CD
                        ,A.PURC_REG_DT
                        ,A.CAR_BRAND_CD
                        ,A.CAR_BRAND_NM
                        ,A.CORP_CAR_DSTIN_CD
                        ,A.CARLINE_CD
                        ,A.CARLINE_NM
                        ,A.MODEL_CD
                        ,A.MODEL_NM
                        ,A.MODEL_YEAR
                        ,A.OCN_CD
                        ,A.OCN_NM
                        ,A.EXT_COLOR_CD
                        ,A.EXT_COLOR_NM
                        ,A.INT_COLOR_CD
                        ,A.CAR_DISP_QTY
                        ,A.MANUFACT_YY_MM_DT
                        ,A.VIN_NO
                        ,A.PC_DSTIN_CD
                        ,A.CAR_RUN_DIST_VAL
                        ,A.FUEL_CD
                        ,A.DRV_MTH_CD
                        ,A.NO_SALE_YN
                        ,A.PLAT_NO
                        ,A.PLAT_AMT
                        ,A.RETL_DT
                        ,A.LAST_OWNER_NM
                        ,A.EVAL_MTH_CD
                        ,A.EVAL_PRSN_NM
                        ,A.EVAL_DT
                        ,A.EVAL_REMARK
                        ,NVL(B.CAR_STAT_CD , A.CAR_STAT_CD ) AS CAR_STAT_CD
                        ,A.LAST_OWNER_TEL
                        ,A.EVAL_AMT_FR
                        ,A.EVAL_AMT_TO
                        ,A.SALE_RGST_EMP
                        ,A.VEHICLE_INSPEC_DT
                        ,NVL(A.EVAL_AMT,0) AS EVAL_AMT         --평가금액
                        ,NVL(A.LAST_AMT,0) AS LAST_AMT         --구입가격
                        ,NVL(B.SALE_AMT,0) AS SALE_AMT         --판매가격
                        ,NVL(A.PURC_TOT_AMT,0) AS PURC_TOT_AMT -- 구매총금액
                        ,NVL(A.EVAL_AMT_FR,0)||'~'||NVL(A.EVAL_AMT_TO,0) AS EVAL_AMT_ALL
                        ,CASE WHEN NVL(B.SALE_AMT,0) > 0
                              THEN (NVL(B.SALE_AMT,0) - NVL(A.PURC_TOT_AMT,0))
                              ELSE 0 END  AS PAY_THE_DIFF
                        ,A.REG_DT
                        ,B.CAR_ID
                        ,(SELECT CAR_ID FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS VIN_CAR_ID
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DEL_YN = 'N') AS REG_USR_NM
                    FROM SA_0241T A LEFT OUTER JOIN SA_0128T B
                      ON A.DLR_CD  = B.DLR_CD
                     AND A.PURC_NO = B.PURC_NO
                   WHERE A.DLR_CD = #{sDlrCd}
                     <if test='sPurcNo != null and sPurcNo != ""'>
                       AND A.PURC_NO  = #{sPurcNo}
                     </if>
                     <if test='sPurcCustNo != null and sPurcCustNo != ""'>
                       AND A.PURC_CUST_NO = #{sPurcCustNo}
                     </if>
                     <if test='sVinNo != null and sVinNo != ""'>
                       AND A.VIN_NO LIKE '%' || #{sVinNo} || '%'
                     </if>
                     <if test='sPurcRegStartDt != null'>
                       AND A.REG_DT <![CDATA[>=]]> TRUNC(#{sPurcRegStartDt},'DD')
                     </if>
                     <if test='sPurcRegEndDt != null'>
                       AND A.REG_DT <![CDATA[<]]> TRUNC(#{sPurcRegEndDt},'DD')+1
                     </if>
                     <if test='sPlatNo != null and sPlatNo != ""'>
                       AND A.PLAT_NO LIKE '%' || #{sPlatNo} || '%'
                     </if>
                     <if test='sContractNo != null and sContractNo != ""'>
                       AND A.CONTRACT_NO = #{sContractNo}
                     </if>
                     <if test='sCarBrandCd != null and sCarBrandCd != ""'>
                       AND A.CAR_BRAND_CD = #{sCarBrandCd}
                     </if>
                     <if test='sCarlineCd != null and sCarlineCd != ""'>
                       AND A.CARLINE_CD = #{sCarlineCd}
                     </if>
                     <if test='sModelCd != null and sModelCd != ""'>
                       AND A.MODEL_CD = #{sModelCd}
                     </if>
                     <if test='sExtColorCd != null and sExtColorCd != ""'>
                       AND A.EXT_COLOR_CD = #{sExtColorCd}
                     </if>
                     <if test='sPurcStatCd != null and sPurcStatCd != ""'>
                       AND A.PURC_STAT_CD = #{sPurcStatCd}
                     </if>
                     <if test='sContSearch != null and sContSearch == "Y"'>
                       AND A.PURC_STAT_CD = '04'
                       AND A.CONTRACT_NO IS NULL
                       AND A.EXCH_YN = 'Y'
                     </if>
                ORDER BY A.REG_DT DESC NULLS LAST
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
                <if test='sPurcCustNm != null and sPurcCustNm != ""'>
                 AND T1.PURC_CUST_NM LIKE '%' || #{sPurcCustNm} || '%'
                </if>
                <if test='sContSearch != null and sContSearch == "Y"'>
                   AND T1.CAR_STAT_CD = '60'
                 </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 목록 갯수 - 중고차량평가목록  -->
    <select id="selectPurcByConditionCnt" parameterType="PurcEvalSearchVO" resultType="int">

            SELECT COUNT(T1.PURC_NO) AS VALUE FROM (
                  SELECT A.DLR_CD
                        ,A.PURC_NO
                        ,A.PURC_CUST_NO
                        ,( SELECT CUST_NM
                             FROM CR_0101T
                            WHERE DLR_CD  = A.DLR_CD
                              AND CUST_NO = PURC_CUST_NO
                         ) AS PURC_CUST_NM
                    FROM SA_0241T A LEFT OUTER JOIN SA_0128T B
                      ON A.DLR_CD  = B.DLR_CD
                     AND A.PURC_NO = B.PURC_NO
                   WHERE A.DLR_CD = #{sDlrCd}
                     <if test='sPurcNo != null and sPurcNo != ""'>
                       AND A.PURC_NO  = #{sPurcNo}
                     </if>
                     <if test='sPurcCustNo != null and sPurcCustNo != ""'>
                       AND A.PURC_CUST_NO = #{sPurcCustNo}
                     </if>
                     <if test='sVinNo != null and sVinNo != ""'>
                       AND A.VIN_NO LIKE '%' || #{sVinNo} || '%'
                     </if>
                     <if test='sPurcRegStartDt != null'>
                       AND A.REG_DT <![CDATA[>=]]> TRUNC(#{sPurcRegStartDt},'DD')
                     </if>
                     <if test='sPurcRegEndDt != null'>
                       AND A.REG_DT <![CDATA[<]]> TRUNC(#{sPurcRegEndDt},'DD')+1
                     </if>
                     <if test='sPlatNo != null and sPlatNo != ""'>
                       AND A.PLAT_NO LIKE '%' || #{sPlatNo} || '%'
                     </if>
                     <if test='sContractNo != null and sContractNo != ""'>
                       AND A.CONTRACT_NO = #{sContractNo}
                     </if>
                     <if test='sCarBrandCd != null and sCarBrandCd != ""'>
                       AND A.CAR_BRAND_CD = #{sCarBrandCd}
                     </if>
                     <if test='sCarlineCd != null and sCarlineCd != ""'>
                       AND A.CARLINE_CD = #{sCarlineCd}
                     </if>
                     <if test='sModelCd != null and sModelCd != ""'>
                       AND A.MODEL_CD = #{sModelCd}
                     </if>
                     <if test='sExtColorCd != null and sExtColorCd != ""'>
                       AND A.EXT_COLOR_CD = #{sExtColorCd}
                     </if>
                     <if test='sPurcStatCd != null and sPurcStatCd != ""'>
                       AND A.PURC_STAT_CD = #{sPurcStatCd}
                     </if>
                     <if test='sContSearch != null and sContSearch == "Y"'>
                       AND A.PURC_STAT_CD IN ('01', '02', '03', '04')
                       AND A.CONTRACT_NO IS NULL
                       AND A.EXCH_YN = 'Y'
                     </if>
                ORDER BY A.REG_DT DESC NULLS LAST
            ) T1
            <where>
                <if test='sPurcCustNm != null and sPurcCustNm != ""'>
                  T1.PURC_CUST_NM LIKE '%' || #{sPurcCustNm} || '%'
                </if>
            </where>

    </select>

    <!-- 중고차평가매입정보 조회 (단건) -->
    <select id="selectPurcEvalInfo" parameterType="PurcEvalSearchVO" resultType="PurcEvalVO">
          SELECT
                A.DLR_CD                   --딜러코드
               ,A.PURC_NO                  --매입번호
               ,A.PURC_REG_DT              --매입등록일자
               ,A.PURC_STAT_CD             --매입상태코드
               ,A.EXCH_YN                  --치환여부
               ,A.CONTRACT_NO              --계약번호
               ,A.PURC_CUST_NO             --구매고객번호
               ,A.TEL_NO1                  --전화번호1
               ,A.CORP_CAR_DSTIN_CD        --자사차량구분코드
               ,A.CAR_BRAND_CD             --차량브랜드코드
               ,A.CARLINE_CD               --차종코드
               ,A.MODEL_CD                 --모델코드
               ,A.OCN_CD                   --OCN코드
               ,A.EXT_COLOR_CD             --외장색상코드
               ,A.INT_COLOR_CD             --내장색상코드
               ,A.CAR_DISP_QTY             --차량배기량
               ,A.VIN_NO                   --차대번호
               ,A.CAR_RUN_DIST_VAL         --차량주행거리값
               ,A.MANUFACT_YY_MM_DT        --제작년월일자
               ,A.PC_DSTIN_CD              --승상용구분코드
               ,A.FUEL_CD                  --연료코드
               ,A.DRV_MTH_CD               --구동방식코드
               ,A.CAR_LMT_VAL              --차량정원값
               ,A.PURC_TOT_AMT             --매입총금액
               ,A.PURC_AMT                 --매입금액
               ,A.EXCH_AMT                 --치환금액
               ,A.RECOM_SALE_AMT           --추천판매금액
               ,A.DLR_PROMOTION_AMT        --딜러프로모션금액
               ,A.CAR_USE_AMT              --차량사용금액
               ,A.NO_SALE_YN               --번호판매여부
               ,A.PLAT_NO                  --번호판번호
               ,A.PLAT_AMT                 --번호판금액
               ,TO_CHAR(TO_DATE(A.FCE_INC_PRID,'YYYYMM'),'YYYY-MM') AS FCE_INC_PRID --강제보험기간
               ,TO_CHAR(TO_DATE(A.CAR_TAX_PRID,'YYYYMM'),'YYYY-MM') AS CAR_TAX_PRID --차량세금기간
               ,TO_CHAR(TO_DATE(A.YY_TEST_PRID,'YYYYMM'),'YYYY-MM') AS YY_TEST_PRID --년검사기간
               ,TO_CHAR(TO_DATE(A.CMC_INC_PRID,'YYYYMM'),'YYYY-MM') AS CMC_INC_PRID --상업보험기간
               ,A.EVAL_MTH_CD              --평가방법코드
               ,A.EVAL_PRSN_NM             --평가담당자명
               ,A.EVAL_DT                  --평가일자
               ,A.EVAL_REMARK              --평가비고
               ,A.CUST_HOPE_AMT            --고객희망금액
               ,A.EVAL_AMT                 --평가금액
               ,A.LAST_AMT                 --최종금액
               ,A.CAR_REG_AMT              --차량등록금액
               ,A.CAR_STAT_CD              --차량상태코드
               ,A.RETL_DT                  --소매일자
               ,A.LAST_OWNER_NM            --최종소유자명
               ,A.SALE_RGST_EMP            --판매고문
               ,A.LAST_OWNER_TEL           --연계인전화번호
               ,A.EVAL_AMT_FR              --평가금액구간시작
               ,A.EVAL_AMT_FR||'~'||A.EVAL_AMT_TO AS EVAL_AMT_ALL
               ,(NVL(A.PURC_TOT_AMT,0) - NVL(A.LAST_AMT,0)) AS PAY_THE_DIFF
               ,A.EVAL_AMT_TO              --평가금액구간종료
               ,A.VEHICLE_INSPEC_DT        --차량검증일자
               ,A.CAR_BRAND_NM             --브랜드명
               ,A.CARLINE_NM               --차종명
               ,A.MODEL_NM                 --모델명
               ,A.MODEL_YEAR               --모델년식
               ,B.CUST_NM AS PURC_CUST_NM
               ,A.EXT_COLOR_NM
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DEL_YN = 'N') AS REG_USR_NM
          FROM SA_0241T A LEFT OUTER JOIN CR_0101T B
            ON A.DLR_CD  = B.DLR_CD
           AND A.PURC_CUST_NO = B.CUST_NO
          WHERE A.DLR_CD = #{sDlrCd}
           <if test='sPurcNo != null and sPurcNo != ""'>
           AND A.PURC_NO = #{sPurcNo}
           </if>
    </select>


    <!-- 중고차평가정보 - 경매(위탁) 조회 (단건) -->
    <select id="selectAuctInfo" parameterType="map" resultType="PurcEvalVO">
        SELECT *
          FROM SA_0242T SA0242
         WHERE 1=1
        <if test='purcNo != null and purcNo != ""'>
           AND SA0242.PURC_NO = #{purcNo}
        </if>
        <if test='sDlrCd != null and sDlrCd != ""'>
           AND SA0242.DLR_CD = #{sDlrCd}
         </if>
    </select>

    <!-- 조회 목록 - 중고차량평가목록  -->
    <select id="selectAuctInfoByCondition" parameterType="PurcEvalSearchVO" resultType="PurcEvalVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT SA0242.*
                     , SA0242.DLR_CD || SA0242.PURC_NO AS AUCT_PK
                  FROM SA_0242T SA0242
                 WHERE 1=1
                 <if test='sPurcNo != null and sPurcNo != ""'>
                   AND SA0242.PURC_NO  = #{sPurcNo}
                 </if>
                 <if test='sDlrCd != null and sDlrCd != ""'>
                   AND SA0242.DLR_CD = #{sDlrCd}
                 </if>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
         ORDER BY
         <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "auctCd"'>AUCT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "auctPlaceNm"'>AUCT_PLACE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "auctAmt"'>AUCT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "goodsDetlCont"'>GOODS_DETL_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "carDlYn"'>CAR_DL_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "scheConfirmDt"'>SCHE_CONFIRM_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "remark"'>REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <otherwise>
                            SEQ DESC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                SEQ DESC
            </otherwise>
        </choose>
    </select>

    <!-- 목록 갯수 - 중고차량평가목록  -->
    <select id="selectAuctInfoByConditionCnt" parameterType="PurcEvalSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0242T SA0242
         WHERE 1=1
         <if test='sPurcNo != null and sPurcNo != ""'>
           AND SA0242.PURC_NO  = #{sPurcNo}
         </if>
         <if test='sDlrCd != null and sDlrCd != ""'>
           AND SA0242.DLR_CD = #{sDlrCd}
         </if>
    </select>


    <!-- 중고차평가매입 정보를 삽입  -->
    <insert id="insertPurcEvalMng" parameterType="PurcEvalVO">

    INSERT INTO SA_0241T(
         DLR_CD
        ,PURC_NO
        ,PURC_CUST_NO
        ,TEL_NO1
        ,EXCH_YN
        ,CONTRACT_NO
        ,PURC_STAT_CD
        ,PURC_REG_DT
        ,PURC_TOT_AMT
        ,CAR_BRAND_CD
        ,CAR_BRAND_NM
        ,CORP_CAR_DSTIN_CD
        ,CARLINE_CD
        ,CARLINE_NM
        ,MODEL_CD
        ,MODEL_NM
        ,MODEL_YEAR
        ,OCN_CD
        ,OCN_NM
        ,EXT_COLOR_CD
        ,EXT_COLOR_NM
        ,INT_COLOR_CD
        ,CAR_DISP_QTY
        ,MANUFACT_YY_MM_DT
        ,VIN_NO
        ,PC_DSTIN_CD
        ,CAR_RUN_DIST_VAL
        ,FUEL_CD
        ,DRV_MTH_CD
        ,PURC_AMT
        ,EXCH_AMT
        ,RECOM_SALE_AMT
        ,NO_SALE_YN
        ,PLAT_NO
        ,PLAT_AMT
        ,FCE_INC_PRID
        ,CAR_TAX_PRID
        ,YY_TEST_PRID
        ,CMC_INC_PRID
        ,REG_USR_ID
        ,REG_DT
        ,RETL_DT
        ,LAST_OWNER_NM
        ,EVAL_MTH_CD
        ,EVAL_PRSN_NM
        ,EVAL_DT
        ,EVAL_REMARK
        ,CAR_STAT_CD
        ,CUST_HOPE_AMT
        ,EVAL_AMT
        ,LAST_AMT
        ,CAR_REG_AMT
        ,LAST_OWNER_TEL
        ,EVAL_AMT_FR
        ,EVAL_AMT_TO
        ,SALE_RGST_EMP
        ,VEHICLE_INSPEC_DT
    )VALUES(
         #{dlrCd}
        ,#{purcNo}
        ,#{purcCustNo}
        ,#{telNo1}
        ,#{exchYn}
        ,#{contractNo}
        ,#{purcStatCd}
        ,SYSDATE
        ,#{purcTotAmt}
        ,#{carBrandCd}
        ,#{carBrandNm}
        ,#{corpCarDstinCd}
        ,#{carlineCd}
        ,#{carlineNm}
        ,#{modelCd}
        ,#{modelNm}
        ,#{modelYear}
        ,#{ocnCd}
        ,#{ocnNm}
        ,#{extColorCd}
        ,#{extColorNm}
        ,#{intColorCd}
        ,#{carDispQty}
        ,#{manufactYyMmDt}
        ,#{vinNo}
        ,#{pcDstinCd}
        ,#{carRunDistVal}
        ,#{fuelCd}
        ,#{drvMthCd}
        ,#{purcAmt}
        ,#{exchAmt}
        ,#{recomSaleAmt}
        ,#{noSaleYn}
        ,#{platNo}
        ,#{platAmt}
        ,#{fceIncPrid}
        ,#{carTaxPrid}
        ,#{yyTestPrid}
        ,#{cmcIncPrid}
        ,#{regUsrId}
        ,SYSDATE
        ,#{retlDt}
        ,#{lastOwnerNm}
        ,#{evalMthCd}
        ,#{evalPrsnNm}
        ,#{evalDt}
        ,#{evalRemark}
        ,#{carStatCd}
        ,#{custHopeAmt}
        ,#{evalAmt}
        ,#{lastAmt}
        ,#{carRegAmt}
        ,#{lastOwnerTel}
        ,#{evalAmtFr}
        ,#{evalAmtTo}
        ,#{saleRgstEmp}
        ,#{vehicleInspecDt}
    )
    </insert>


    <!-- 중고차평가매입 정보를 수정 -->
    <insert id="updatePurcEvalMng" parameterType="PurcEvalVO">

        UPDATE SA_0241T
          SET
             UPDT_USR_ID = #{updtUsrId}
            ,UPDT_DT = SYSDATE
            <if test='purcCustNo != null and purcCustNo !="" ' >
            ,PURC_CUST_NO       = #{purcCustNo}
            </if>
            <if test='telNo1 != null and telNo1 !="" ' >
            ,TEL_NO1            = #{telNo1}
            </if>
            <if test='exchYn !=null and exchYn != "" '>
            ,EXCH_YN            = #{exchYn}
            </if>
            <if test='contractNo != null and contractNo !="" ' >
            ,CONTRACT_NO        = #{contractNo}
            </if>
            <if test='purcStatCd != null and purcStatCd !="" ' >
            ,PURC_STAT_CD       = #{purcStatCd}
            </if>
            <if test='purcTotAmt != null and purcTotAmt !="" ' >
            ,PURC_TOT_AMT       = #{purcTotAmt}
            </if>
            <if test='carBrandCd != null and carBrandCd !="" ' >
            ,CAR_BRAND_CD       = #{carBrandCd}
            </if>
            <if test='carBrandNm != null and carBrandNm !="" ' >
            ,CAR_BRAND_NM       = #{carBrandNm}
            </if>
            <if test='corpCarDstinCd != null and corpCarDstinCd !="" ' >
            ,CORP_CAR_DSTIN_CD  = #{corpCarDstinCd}
            </if>
            <if test='carlineCd != null and carlineCd !="" ' >
            ,CARLINE_CD         = #{carlineCd}
            </if>
            <if test='carlineNm != null and carlineNm !="" ' >
            ,CARLINE_NM         = #{carlineNm}
            </if>
            <if test='modelCd != null and modelCd !="" ' >
            ,MODEL_CD           = #{modelCd}
            </if>
            <if test='modelNm != null and modelNm !="" ' >
            ,MODEL_NM           = #{modelNm}
            </if>
            <if test='modelYear != null and modelYear !="" ' >
            ,MODEL_YEAR           = #{modelYear}
            </if>
            <if test='ocnCd != null and ocnCd !="" ' >
            ,OCN_CD             = #{ocnCd}
            </if>
            <if test='ocnNm != null and ocnNm !="" ' >
            ,OCN_NM             = #{ocnNm}
            </if>
            <if test='extColorCd != null and extColorCd !="" ' >
            ,EXT_COLOR_CD       = #{extColorCd}
            </if>
            <if test='extColorNm != null and extColorNm !="" ' >
            ,EXT_COLOR_NM       = #{extColorNm}
            </if>
            <if test='intColorCd != null and intColorCd !="" ' >
            ,INT_COLOR_CD       = #{intColorCd}
            </if>
            <if test='carDispQty != null and carDispQty !="" ' >
            ,CAR_DISP_QTY       = #{carDispQty}
            </if>
            <if test='manufactYyMmDt != null ' >
            ,MANUFACT_YY_MM_DT  = #{manufactYyMmDt}
            </if>
            <if test='vinNo != null and vinNo !="" ' >
            ,VIN_NO             = #{vinNo}
            </if>
            <if test='pcDstinCd != null and pcDstinCd !="" ' >
            ,PC_DSTIN_CD        = #{pcDstinCd}
            </if>
            <if test='carRunDistVal != null and carRunDistVal !="" ' >
            ,CAR_RUN_DIST_VAL   = #{carRunDistVal}
            </if>
            <if test='fuelCd != null and fuelCd !="" ' >
            ,FUEL_CD            = #{fuelCd}
            </if>
            <if test='drvMthCd != null and drvMthCd !="" ' >
            ,DRV_MTH_CD         = #{drvMthCd}
            </if>
            <if test='purcAmt != null and purcAmt !="" ' >
            ,PURC_AMT           = #{purcAmt}
            </if>
            <if test='exchAmt != null and exchAmt !="" ' >
            ,EXCH_AMT           = #{exchAmt}
            </if>
            <if test='recomSaleAmt != null and recomSaleAmt !="" ' >
            ,RECOM_SALE_AMT     = #{recomSaleAmt}
            </if>
            <if test='noSaleYn != null and noSaleYn !="" ' >
            ,NO_SALE_YN         = #{noSaleYn}
            </if>
            <if test='platNo != null and platNo !="" ' >
            ,PLAT_NO            = #{platNo}
            </if>
            <if test='platAmt != null and platAmt !="" ' >
            ,PLAT_AMT           = #{platAmt}
            </if>
            <if test='fceIncPrid != null and fceIncPrid !="" ' >
            ,FCE_INC_PRID       = #{fceIncPrid}
            </if>
            <if test='carTaxPrid != null and carTaxPrid !="" ' >
            ,CAR_TAX_PRID       = #{carTaxPrid}
            </if>
            <if test='yyTestPrid != null and yyTestPrid !="" ' >
            ,YY_TEST_PRID       = #{yyTestPrid}
            </if>
            <if test='cmcIncPrid != null and cmcIncPrid !="" ' >
            ,CMC_INC_PRID       = #{cmcIncPrid}
            </if>
            <if test='retlDt != null   ' >
            ,RETL_DT            = #{retlDt}
            </if>
            <if test='lastOwnerNm != null and lastOwnerNm !="" ' >
            ,LAST_OWNER_NM      = #{lastOwnerNm}
            </if>
            <if test='evalMthCd != null and evalMthCd !="" ' >
            ,EVAL_MTH_CD        = #{evalMthCd}
            </if>
            <if test='evalPrsnNm != null and evalPrsnNm !="" ' >
            ,EVAL_PRSN_NM       = #{evalPrsnNm}
            </if>
            <if test='evalDt != null ' >
            ,EVAL_DT            = #{evalDt}
            </if>
            <if test='evalRemark != null and evalRemark !="" ' >
            ,EVAL_REMARK        = #{evalRemark}
            </if>
            <if test='carStatCd != null and carStatCd !="" ' >
            ,CAR_STAT_CD        = #{carStatCd}
            </if>
            <if test='custHopeAmt != null and custHopeAmt !="" ' >
            ,CUST_HOPE_AMT      = #{custHopeAmt}
            </if>
            <if test='evalAmt != null and evalAmt !="" ' >
            ,EVAL_AMT           = #{evalAmt}
            </if>
            <if test='lastAmt != null and lastAmt !="" ' >
            ,LAST_AMT           = #{lastAmt}
            </if>
            <if test='carRegAmt != null and carRegAmt !="" ' >
            ,CAR_REG_AMT        = #{carRegAmt}
            </if>
            <if test='lastOwnerTel != null and lastOwnerTel !="" ' >
            ,LAST_OWNER_TEL     = #{lastOwnerTel}
            </if>
            <if test='evalAmtFr != null and evalAmtFr !="" ' >
            ,EVAL_AMT_FR        = #{evalAmtFr}
            </if>
            <if test='evalAmtTo != null and evalAmtTo !="" ' >
            ,EVAL_AMT_TO        = #{evalAmtTo}
            </if>
            <if test='saleRgstEmp != null and saleRgstEmp !="" ' >
            ,SALE_RGST_EMP      = #{saleRgstEmp}
            </if>
            <if test='vehicleInspecDt != null   ' >
            ,VEHICLE_INSPEC_DT  = #{vehicleInspecDt}
            </if>
       WHERE DLR_CD  = #{dlrCd}
         AND PURC_NO = #{purcNo}

    </insert>

    <!-- 중고차평가를 업데이트 -->
    <update id="updatePurcEvalMng2ndTab" parameterType="PurcEvalVO">
        UPDATE SA_0241T
           SET EVAL_MTH_CD   = #{evalMthCd}
             , EVAL_PRSN_NM  = #{evalPrsnNm}
             , EVAL_DT       = #{evalDt}
             , EVAL_REMARK   = #{evalRemark}
             , CAR_STAT_CD   = #{carStatCd}
             , CUST_HOPE_AMT = #{custHopeAmt}
             , EVAL_AMT      = #{evalAmt}
             , LAST_AMT      = #{lastAmt}
             , CAR_REG_AMT   = #{carRegAmt}
             , UPDT_USR_ID   = #{updtUsrId}
             , UPDT_DT       = SYSDATE
        WHERE DLR_CD         = #{dlrCd}
          AND PURC_NO        = #{purcNo}
    </update>

    <!-- 중고차평가 정보를 조회한다. -->
    <select id="selectAuctInfoByKey" parameterType="PurcEvalVO" resultType="PurcEvalVO">
        SELECT * FROM SA_0242T
        WHERE DLR_CD = #{dlrCd}
          AND PURC_NO = #{purcNo}
          AND SEQ = #{seq}
    </select>


    <!-- 중고차평가  - 경매정보를 등록한다. -->
    <insert id="insertAuctInfo" parameterType="PurcEvalVO">
        INSERT INTO SA_0242T(
               DLR_CD
              ,PURC_NO
              ,SEQ
              ,AUCT_CD
              ,AUCT_PLACE_NM
              ,AUCT_AMT
              ,GOODS_DETL_CONT
              ,CAR_DL_YN
              ,SCHE_CONFIRM_DT
              ,REMARK
              ,REG_USR_ID
              ,REG_DT
              ,UPDT_USR_ID
              ,UPDT_DT
        )VALUES(
               #{dlrCd}
              ,#{purcNo}
              ,(SELECT NVL(MAX(SEQ),0)+1 FROM SA_0242T WHERE DLR_CD = #{dlrCd} AND PURC_NO = #{purcNo})
              ,#{auctCd}
              ,#{auctPlaceNm}
              ,#{auctAmt}
              ,#{goodsDetlCont}
              ,#{carDlYn}
              ,#{scheConfirmDt}
              ,#{remark}
              ,#{regUsrId}
              ,SYSDATE
              ,#{regUsrId}
              ,SYSDATE
        )
    </insert>



    <!-- 중고차평가 - 경매정보를 수정한다. -->
    <update id="updateAuctInfo" parameterType="PurcEvalVO">
        UPDATE SA_0242T SET
               AUCT_CD = #{auctCd}
              ,AUCT_PLACE_NM = #{auctPlaceNm}
              ,AUCT_AMT = #{auctAmt}
              ,GOODS_DETL_CONT = #{goodsDetlCont}
              ,CAR_DL_YN = #{carDlYn}
              ,SCHE_CONFIRM_DT = #{scheConfirmDt}
              ,REMARK = #{remark}
              ,UPDT_USR_ID = #{updtUsrId}
              ,UPDT_DT = SYSDATE
        WHERE 1=1
          AND DLR_CD = #{dlrCd}
          AND PURC_NO = #{purcNo}
          AND SEQ = #{seq}
    </update>

    <!-- 중고차평가 - 경매정보를 삭제한다. -->
    <delete id="deleteAuctInfo" parameterType="PurcEvalVO">
        DELETE SA_0242T
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
           AND SEQ = #{seq}
    </delete>

    <!-- 중고차평가 이미지 팝업 조회 -->
    <select id="selectImageEvalVal" parameterType="PurcEvalSearchVO" resultType="PurcEvalImageVO">

         SELECT A.DLR_CD                      --딜러코드
               ,NVL(B.DLR_NM ,(SELECT DLR_NM FROM CM_0101T WHERE DLR_CD = A.DLR_CD) ) AS DLR_NM
               ,A.PURC_NO                     --매입번호
               ,A.PURC_REG_DT                 --매입등록일자
               ,A.PURC_CUST_NO                --구매고객번호
               ,NVL(B.CUST_NM , (SELECT CUST_NM FROM CR_0101T WHERE DLR_CD = A.DLR_CD AND  CUST_NO = A.PURC_CUST_NO)) AS CUST_NM
               ,B.TEL_NO                      --전화번호
               ,NVL(B.CAR_NO , A.PLAT_NO ) CAR_NO --차량번호
               ,A.CAR_BRAND_CD                --차량브랜드코드
               ,A.CARLINE_CD                  --차종코드
               ,A.MODEL_CD                    --모델코드
               ,A.EXT_COLOR_CD                --외장색상코드
               ,A.INT_COLOR_CD                --내장색상코드
               ,NVL(B.CAR_DISP_QTY ,A.CAR_DISP_QTY ) AS CAR_DISP_QTY --차량배기량
               ,A.VIN_NO                      --차대번호
               ,B.ENGIN_NO                    --엔진번호
               ,NVL(B.IMS_NM ,A.CAR_BRAND_NM ) AS IMS_NM --브랜드명
               ,NVL(B.CAR_MODEL_CD ,A.CARLINE_NM )AS CARLINE_NM                  --차종명
               ,A.MODEL_NM                    --모델명
               ,A.OCN_NM                      --OCN명
               ,NVL(B.EXT_COLOR_NM , A.EXT_COLOR_NM ) AS EXT_COLOR_NM --외장색상명
               ,B.INT_COLOR_NM                --내장색상명
               ,A.CAR_RUN_DIST_VAL            --차량주행거리값
               ,A.MANUFACT_YY_MM_DT           --제작년월일자
               ,A.PURC_TOT_AMT                --매입총금액
               ,A.PURC_AMT                    --매입금액
               ,A.RECOM_SALE_AMT              --추천판매금액
               ,A.DLR_PROMOTION_AMT           --딜러프로모션금액
               ,A.CAR_USE_AMT                 --차량사용금액
               ,A.PLAT_NO                     --번호판번호
               ,A.FCE_INC_PRID                --강제보험기간
               ,A.CAR_TAX_PRID                --차량세금기간
               ,A.CMC_INC_PRID                --상업보험기간
               ,A.EVAL_MTH_CD                 --평가방법코드
               ,A.EVAL_PRSN_NM                --평가담당자명
               ,A.EVAL_DT                     --평가일자
               ,A.EVAL_REMARK                 --평가비고
               ,A.EVAL_AMT                    --평가금액
               ,A.LAST_AMT                    --최종금액
               ,A.CAR_REG_AMT                 --차량등록금액
               ,A.CAR_STAT_CD                 --차량상태코드
               ,A.RETL_DT                     --소매일자
               ,B.CAR_OWNER_NM                --최종소유자명
               ,A.SALE_RGST_EMP               --판매고문
               ,A.LAST_OWNER_TEL              --연계인전화번호
               ,A.REG_DT                      --등록일자
               ,B.GI_DT                       --출고일자
               ,B.CAR_REG_DT                  --차량등록일자
               ,B.CAR_OWN_CHG_HIS_DT          --차량명의변경이력일자
               ,B.NCAR_PLT_GUIDE_PRC          --신차량공장지도가격
               ,B.NCAR_MARKET_PRC             --신차량시장가격
               ,NVL(B.CUST_HOPE_PRC , A.CUST_HOPE_AMT ) AS CUST_HOPE_PRC --고객희망가격
               ,A.EVAL_AMT_FR                 --평가금액구간시작
               ,A.EVAL_AMT_TO                 --평가금액구간종료
               ,B.EVAL_CMP_EST_PRC            --평가사견적가격
               ,B.LAST_CONTRACT_PRC           --최종계약가격
               ,B.DRV_MTH_CD                  --구동방식코드
               ,B.TRMS_TP                     --변속기유형
               ,B.FUEL_CD                     --연료코드
               ,B.CAR_USE_TP                  --차량용도유형
               ,B.SRF_DSTIN_CD                --썬루프구분코드
               ,B.AIRCON_TP                   --에어컨유형
               ,B.AIRBACK_QTY                 --에어백수량
               ,B.SEAT_TP                     --시트유형
               ,B.STC_TP                      --시동유형
               ,B.ELEC_SEAT_YN                --전동시트여부
               ,B.HEAT_SEAT_YN                --열선시트여부
               ,B.AIR_SEAT_YN                 --통풍시트여부
               ,B.DVD_YN                      --DVD여부
               ,B.NAVI_YN                     --네비게이션여부
               ,B.RCAM_YN                     --후방카메라여부
               ,B.AUTO_HLGT_YN                --오토헤드라이트여부
               ,B.HID_HLAMP_YN                --HID헤드램프여부
               ,B.HALO_LAMP_YN                --할로겐램프여부
               ,B.REG_CERT_YN                 --등록증여부
               ,B.RUN_CERT_YN                 --주행증여부
               ,B.PURC_TAX_CERT_YN            --구매세금증명서여부
               ,B.PURC_CERT_YN                --구매증명서여부
               ,B.OWN_CHG_RCPT_YN             --명의변경영수증여부
               ,B.COMM_INS_YN                 --상업보험여부
               ,B.SPC_INS_YN                  --교강보험여부
               ,B.ENV_PRTC_LABEL_YN           --환경보호라벨여부
               ,CASE WHEN LENGTH(B.COMM_INS_VALID_YY_MM) > 4
                     THEN SUBSTR(B.COMM_INS_VALID_YY_MM ,1,4) ELSE '' END  AS COMM_INS_VALID_DT_YEAR   --상업보험유효년
               ,CASE WHEN LENGTH(B.COMM_INS_VALID_YY_MM) >= 6
                     THEN SUBSTR(B.COMM_INS_VALID_YY_MM ,5,2) ELSE '' END AS COMM_INS_VALID_DT_MONTH  --상업보험유효월
               ,CASE WHEN LENGTH(B.SPC_INC_VALID_YY_MM ) > 4
                     THEN SUBSTR(B.SPC_INC_VALID_YY_MM,1,4) ELSE '' END AS SPC_INC_VALID_DT_YEAR    --교강보험유효년
               ,CASE WHEN LENGTH(B.SPC_INC_VALID_YY_MM )  > 4
                     THEN SUBSTR(B.SPC_INC_VALID_YY_MM,5,2) ELSE '' END AS SPC_INC_VALID_DT_MONTH   --교강보험유효월
               ,B.ETC_CONT                    --기타내용
               ,B.EXT_CONT                    --외장내용
               ,B.INT_CONT                    --내장내용
               ,B.VIN_CONT                    --차대내용
               ,B.MECH_CONT                   --기계내용
               ,B.STAT_CONT                   --상태내용
               ,B.TOT_EVAL_CONT               --종합평가내용
               ,B.CAR_ACC_CONT                --차량악세서리내용
               ,B.REMARK                      --비고
          FROM SA_0241T A LEFT OUTER JOIN SA_0252T B
            ON A.DLR_CD  = B.DLR_CD
           AND A.PURC_NO = B.PURC_NO
         WHERE A.DLR_CD  = #{sDlrCd}
           AND A.PURC_NO = #{sPurcNo}
    </select>

    <!-- 목록 갯수 - 중고차매입/평가관리 - 평가용 이미지 데이터 조회.  -->
    <select id="selectImageEvalValCnt" parameterType="PurcEvalSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0252T SA0252
         WHERE 1=1
           AND SA0252.DLR_CD = #{sDlrCd}
           AND SA0252.PURC_NO = #{sPurcNo}
    </select>

    <!-- 중고차매입/평가관리 - 평가용 이미지의 평가데이터를 등록. -->
    <insert id="insertImageEval" parameterType="PurcEvalImageVO">
        INSERT INTO SA_0252T(
               DLR_CD
              ,PURC_NO
              ,DLR_NM
              ,CUST_NM
              ,IMS_NM
              ,CAR_MODEL_CD
              ,TEL_NO
              ,CAR_NO
              ,GI_DT
              ,CAR_REG_DT
              ,CAR_OWNER_NM
              ,CAR_OWN_CHG_HIS_DT
              ,VIN_NO
              ,ENGIN_NO
              ,CAR_DISP_QTY
              ,EXT_COLOR_NM
              ,INT_COLOR_NM
              ,DRV_MTH_CD
              ,TRMS_TP
              ,FUEL_CD
              ,CAR_USE_TP
              ,SRF_DSTIN_CD
              ,AIRBACK_QTY
              ,SEAT_TP
              ,AIRCON_TP
              ,STC_TP
              ,ELEC_SEAT_YN
              ,HEAT_SEAT_YN
              ,AIR_SEAT_YN
              ,DVD_YN
              ,NAVI_YN
              ,RCAM_YN
              ,AUTO_HLGT_YN
              ,HID_HLAMP_YN
              ,HALO_LAMP_YN
              ,REG_CERT_YN
              ,RUN_CERT_YN
              ,PURC_TAX_CERT_YN
              ,PURC_CERT_YN
              ,OWN_CHG_RCPT_YN
              ,COMM_INS_YN
              ,SPC_INS_YN
              ,ENV_PRTC_LABEL_YN
              ,COMM_INS_VALID_YY_MM
              ,SPC_INC_VALID_YY_MM
              ,ETC_CONT
              ,EXT_CONT
              ,INT_CONT
              ,VIN_CONT
              ,MECH_CONT
              ,STAT_CONT
              ,TOT_EVAL_CONT
              ,CAR_ACC_CONT
              ,REMARK
              ,NCAR_PLT_GUIDE_PRC
              ,NCAR_MARKET_PRC
              ,CUST_HOPE_PRC
              ,EVAL_CMP_EST_PRC
              ,LAST_CONTRACT_PRC
              ,REG_USR_ID
              ,REG_DT
              ,UPDT_USR_ID
              ,UPDT_DT
        )VALUES(
               #{dlrCd}
              ,#{purcNo}
              ,#{dlrNm}
              ,#{custNm}
              ,#{imsNm}
              ,#{carlineNm}
              ,#{telNo}
              ,#{carNo}
              ,#{giDt}
              ,#{carRegDt}
              ,#{carOwnerNm}
              ,#{carOwnChgHisDt}
              ,#{vinNo}
              ,#{enginNo}
              ,#{carDispQty}
              ,#{extColorNm}
              ,#{intColorNm}
              ,#{drvMthCd}
              ,#{trmsTp}
              ,#{fuelCd}
              ,#{carUseTp}
              ,#{srfDstinCd}
              ,#{airbackQty}
              ,#{seatTp}
              ,#{airconTp}
              ,#{stcTp}
              ,#{elecSeatYn}
              ,#{heatSeatYn}
              ,#{airSeatYn}
              ,#{dvdYn}
              ,#{naviYn}
              ,#{rcamYn}
              ,#{autoHlgtYn}
              ,#{hidHlampYn}
              ,#{haloLampYn}
              ,#{regCertYn}
              ,#{runCertYn}
              ,#{purcTaxCertYn}
              ,#{purcCertYn}
              ,#{ownChgRcptYn}
              ,#{commInsYn}
              ,#{spcInsYn}
              ,#{envPrtcLabelYn}
              ,#{commInsValidDtYear} || #{commInsValidDtMonth}
              ,#{spcIncValidDtYear} || #{spcIncValidDtMonth}
              ,#{etcCont}
              ,#{extCont}
              ,#{intCont}
              ,#{vinCont}
              ,#{mechCont}
              ,#{statCont}
              ,#{totEvalCont}
              ,#{carAccCont}
              ,#{remark}
              ,#{ncarPltGuidePrc}
              ,#{ncarMarketPrc}
              ,#{custHopePrc}
              ,#{evalCmpEstPrc}
              ,#{lastContractPrc}
              ,#{regUsrId}
              ,SYSDATE
              ,#{regUsrId}
              ,SYSDATE
        )
    </insert>



    <!-- 중고차매입/평가관리 - 평가용 이미지의 평가데이터를 수정. -->
    <update id="updateImageEval" parameterType="PurcEvalImageVO">
        UPDATE SA_0252T
           SET DLR_CD = #{dlrCd}
             , PURC_NO = #{purcNo}
             , DLR_NM = #{dlrNm}
             , CUST_NM = #{custNm}
             , IMS_NM = #{imsNm}
             , CAR_MODEL_CD = #{carlineNm}
             , TEL_NO = #{telNo}
             , CAR_NO = #{carNo}
             , GI_DT = #{giDt}
             , CAR_REG_DT = #{carRegDt}
             , CAR_OWNER_NM = #{carOwnerNm}
             , CAR_OWN_CHG_HIS_DT = #{carOwnChgHisDt}
             , VIN_NO = #{vinNo}
             , ENGIN_NO = #{enginNo}
             , CAR_DISP_QTY = #{carDispQty}
             , EXT_COLOR_NM = #{extColorNm}
             , INT_COLOR_NM = #{intColorNm}
             , DRV_MTH_CD = #{drvMthCd}
             , TRMS_TP = #{trmsTp}
             , FUEL_CD = #{fuelCd}
             , CAR_USE_TP = #{carUseTp}
             , SRF_DSTIN_CD = #{srfDstinCd}
             , AIRBACK_QTY = #{airbackQty}
             , SEAT_TP = #{seatTp}
             , AIRCON_TP = #{airconTp}
             , STC_TP = #{stcTp}
             , ELEC_SEAT_YN = #{elecSeatYn}
             , HEAT_SEAT_YN = #{heatSeatYn}
             , AIR_SEAT_YN = #{airSeatYn}
             , DVD_YN = #{dvdYn}
             , NAVI_YN = #{naviYn}
             , RCAM_YN = #{rcamYn}
             , AUTO_HLGT_YN = #{autoHlgtYn}
             , HID_HLAMP_YN = #{hidHlampYn}
             , HALO_LAMP_YN = #{haloLampYn}
             , REG_CERT_YN = #{regCertYn}
             , RUN_CERT_YN = #{runCertYn}
             , PURC_TAX_CERT_YN = #{purcTaxCertYn}
             , PURC_CERT_YN = #{purcCertYn}
             , OWN_CHG_RCPT_YN = #{ownChgRcptYn}
             , COMM_INS_YN = #{commInsYn}
             , SPC_INS_YN = #{spcInsYn}
             , ENV_PRTC_LABEL_YN = #{envPrtcLabelYn}
             , COMM_INS_VALID_YY_MM = #{commInsValidDtYear} || #{commInsValidDtMonth}
             , SPC_INC_VALID_YY_MM = #{spcIncValidDtYear} || #{spcIncValidDtMonth}
             , ETC_CONT = #{etcCont}
             , EXT_CONT = #{extCont}
             , INT_CONT = #{intCont}
             , VIN_CONT = #{vinCont}
             , MECH_CONT = #{mechCont}
             , STAT_CONT = #{statCont}
             , TOT_EVAL_CONT = #{totEvalCont}
             , CAR_ACC_CONT = #{carAccCont}
             , REMARK = #{remark}
             , NCAR_PLT_GUIDE_PRC = #{ncarPltGuidePrc}
             , NCAR_MARKET_PRC = #{ncarMarketPrc}
             , CUST_HOPE_PRC = #{custHopePrc}
             , EVAL_CMP_EST_PRC = #{evalCmpEstPrc}
             , LAST_CONTRACT_PRC = #{lastContractPrc}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </update>

    <!-- 치환이 아닌경우 폐기로 상태로 업데이트 -->
    <update id="updateScrapVehicle" parameterType="PurcEvalVO">
        UPDATE SA_0128T
           SET
               CAR_STAT_CD  = #{carStatCd}
             , UPDT_USR_ID  = #{updtUsrId}
             , UPDT_DT = SYSDATE
        WHERE VIN_NO   = #{vinNo}
    </update>

    <!-- 중고차헤더 정보 등록  -->
    <insert id="insertPurcEvalMaster" parameterType="PurcEvalVO">

        INSERT INTO SA_0128T(
            CAR_ID
           ,VIN_NO
           ,VIN_NO1
           ,VIN_NO2
           ,CAR_STAT_CD
           ,DLR_CD
           ,MANUFACT_YY_MM_DT
           ,CORP_CAR_DSTIN_CD
           ,CUST_SALE_DT
           ,CUST_SALE_CANC_DT
           ,CAR_BRAND_CD
           ,CAR_BRAND_NM
           ,CAR_NM
           ,CAR_DISP_QTY
           ,OPEN_YN
           ,CAR_RUN_DIST_VAL
           ,PURC_PATH_NM
           ,REG_USR_ID
           ,REG_DT
           ,CARLINE_CD
           ,CARLINE_NM
           ,MODEL_CD
           ,MODEL_NM
           ,OCN_CD
           ,EXT_COLOR_CD
           ,EXT_COLOR_NM
           ,INT_COLOR_CD
           ,PURC_NO
        )
        SELECT #{carId} AS CAR_ID
              ,#{vinNo} AS VIN_NO
              ,SUBSTR(#{vinNo},1,11) AS VIN_NO1
              ,SUBSTR(#{vinNo},12,6) AS VIN_NO2
              ,#{carStatCd}          AS CAR_STAT_CD
              ,DLR_CD
              ,MANUFACT_YY_MM_DT
              ,CORP_CAR_DSTIN_CD
              ,RETL_DT               AS CUST_SALE_DT
              ,#{custSaleCancDt}     AS CUST_SALE_CANC_DT
              ,CAR_BRAND_CD
              ,CAR_BRAND_NM
              ,#{carlineNm}          AS CAR_NM
              ,CAR_DISP_QTY
              ,'Y'                   AS OPEN_YN
              ,CAR_RUN_DIST_VAL
              ,'02'                  AS PURC_PATH_NM
              ,#{regUsrId}           AS REG_USR_ID
              ,SYSDATE               AS REG_DT
              ,CARLINE_CD
              ,CARLINE_NM
              ,MODEL_CD
              ,MODEL_NM
              ,OCN_CD
              ,EXT_COLOR_CD
              ,EXT_COLOR_NM
              ,INT_COLOR_CD
              ,#{purcNo}             AS PURC_NO
          FROM SA_0241T
         WHERE DLR_CD  = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </insert>

    <!-- 중고차헤더 정보 수정  -->
    <update id="updatePurcEvalMaster" parameterType="PurcEvalVO">

        UPDATE SA_0128T
           SET
               UPDT_USR_ID       = #{updtUsrId}
              ,UPDT_DT           = SYSDATE
              <if test=' carStatCd != null and carStatCd != "" '>
              ,CAR_STAT_CD       = #{carStatCd}
              </if>
              <if test=' strgeCd != null and strgeCd != "" '>
              ,STRGE_CD          = #{strgeCd}
              </if>
              <if test=' locCd != null and locCd != "" '>
              ,LOC_CD            = #{locCd}
              </if>
              <if test=' saleTp != null and saleTp != "" '>
              ,SALE_TP           = #{saleTp}
              </if>
              <if test=' contractNo != null and contractNo != "" '>
              ,CONTRACT_NO       = #{contractNo}
              </if>
              <if test=' manufactYyMmDt != null and manufactYyMmDt != "" '>
              ,MANUFACT_YY_MM_DT = #{manufactYyMmDt}
              </if>
              <if test=' corpCarDstinCd != null and corpCarDstinCd != "" '>
              ,CORP_CAR_DSTIN_CD = #{corpCarDstinCd}
              </if>
              <if test=' custSaleDt != null and custSaleDt != "" '>
              ,CUST_SALE_DT      = #{custSaleDt}
              </if>
              <if test=' custSaleCancDt != null and custSaleCancDt != "" '>
              ,CUST_SALE_CANC_DT = #{custSaleCancDt}
              </if>
              <if test=' carBrandCd != null and carBrandCd != "" '>
              ,CAR_BRAND_CD      = #{carBrandCd}
              </if>
              <if test=' carNm != null and carNm != "" '>
              ,CAR_NM            = #{carNm}
              </if>
              <if test=' carDispQty != null and carDispQty != "" '>
              ,CAR_DISP_QTY      = #{carDispQty}
              </if>
              ,OPEN_YN           = 'Y'
              <if test=' carRunDistVal != null and carRunDistVal != "" '>
              ,CAR_RUN_DIST_VAL  = #{carRunDistVal}
              </if>
              ,PURC_PATH_NM      = '02'
              <if test=' remark != null and remark != "" '>
              ,REMARK            = #{remark}
              </if>
              <if test=' temp1 != null and temp1 != "" '>
              ,TEMP1             = #{temp1}
              </if>
              <if test=' temp2 != null and temp2 != "" '>
              ,TEMP2             = #{temp2}
              </if>
              <if test=' temp3 != null and temp3 != "" '>
              ,TEMP3             = #{temp3}
              </if>
              <if test=' temp4 != null and temp4 != "" '>
              ,TEMP4             = #{temp4}
              </if>
              <if test=' temp5 != null and temp5 != "" '>
              ,TEMP5             = #{temp5}
              </if>
              <if test=' carlineCd != null and carlineCd != "" '>
              ,CARLINE_CD        = #{carlineCd}
              </if>
              <if test=' carlineNm != null and carlineNm != "" '>
              ,CARLINE_NM        = #{carlineNm}
              </if>
              <if test=' modelCd != null and modelCd != "" '>
              ,MODEL_CD          = #{modelCd}
              </if>
              <if test=' modelNm != null and modelNm != "" '>
              ,MODEL_NM          = #{modelNm}
              </if>
              <if test=' ocnCd != null and ocnCd != "" '>
              ,OCN_CD            = #{ocnCd}
              </if>
              <if test=' extColorCd != null and extColorCd != "" '>
              ,EXT_COLOR_CD      = #{extColorCd}
              </if>
              <if test=' extColorNm != null and extColorNm != "" '>
              ,EXT_COLOR_NM      = #{extColorNm}
              </if>
              <if test=' intColorCd != null and intColorCd != "" '>
              ,INT_COLOR_CD      = #{intColorCd}
              </if>
         WHERE DLR_CD            = #{dlrCd}
           AND PURC_NO           = #{purcNo}

    </update>

    <!-- 중고차매입테이블중복체크  -->
    <select id="selectPurcNoDupChecking" parameterType="PurcEvalVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0241T
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO  = #{purcNo}
    </select>

    <!-- 중고차매입번호채번  -->
    <select id="selectPurcNoNumbering" parameterType="PurcEvalVO" resultType="String">
        SELECT 'TR' || TO_CHAR(SYSDATE,'YYYY') || DECODE(MAX(PURC_NO),'',LPAD(NVL(MAX(PURC_NO),0)+1,14,0),LPAD(TO_NUMBER(SUBSTR(MAX(PURC_NO),7))+1,14,0))
          FROM SA_0241T
         WHERE DLR_CD = #{dlrCd}
    </select>

    <!-- 계약-치환내역수정 -->
    <update id="updateContractNoPurcEval" parameterType="PurcEvalVO">
        UPDATE SA_0241T
           SET UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
           <if test='exchYn != null and exchYn != ""'>
             , EXCH_YN = #{exchYn}
           </if>
           <if test='vinNo != null or vinNo != ""'>
             , VIN_NO = #{vinNo}
           </if>
           <if test='purcTotAmt != null or purcTotAmt != ""'>
             <!-- , PURC_TOT_AMT = #{purcTotAmt} -->
           </if>
           <if test='contractNo != null or contractNo != ""'>
             , CONTRACT_NO = #{contractNo}
           </if>
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </update>


    <!-- 계약-치환내역수정 -->
    <update id="updateNonContractNoPurcEval" parameterType="PurcEvalVO">
        UPDATE SA_0241T
           SET UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
             , CONTRACT_NO = #{contractNo}
           <if test='exchYn != null and exchYn != ""'>
             , EXCH_YN = #{exchYn}
           </if>
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </update>

    <!-- 계약-치환내역초기화 -->
    <update id="deleteContractPurcEval" parameterType="PurcEvalVO">
        UPDATE SA_0241T
           SET CONTRACT_NO = null
           <if test='exchYn != null and exchYn != ""'>
             , EXCH_YN = #{exchYn}
           </if>
         WHERE DLR_CD = #{dlrCd}
           AND CONTRACT_NO = #{contractNo}
    </update>

    <!-- 저장되는 빈의 중복체크 -->
    <select id="checkingVinNoDupWhether" parameterType="PurcEvalSearchVO" resultType="String">
        SELECT CASE WHEN MAX(VIN_NO) IS NULL
                     THEN  'N' ELSE 'Y'
                    END AS CHK_FLAG
          FROM SA_0241T
         WHERE DLR_CD = #{sDlrCd}
           AND VIN_NO = #{sVinNo}
           AND PURC_STAT_CD IN ('01','04')
           <if test=' sPurcNo != null and sPurcNo != "" '>
            AND PURC_NO NOT IN (#{sPurcNo})
           </if>
    </select>

    <!-- 매입취소건의 계약연결 유무체크 -->
    <select id="checkingContract" parameterType="PurcEvalSearchVO" resultType="String">
        SELECT DECODE(MAX(CONTRACT_NO), NULL, 'T', 'F') AS CONT_CONTINUITY
          FROM SA_0241T
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </select>

    <update id="purchaseCancelHeader" parameterType="PurcEvalVO">
        UPDATE SA_0241T
           SET PURC_STAT_CD = '06'
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </update>

    <update id="purchaseCancelStock" parameterType="PurcEvalVO">
        UPDATE SA_0128T
           SET CAR_STAT_CD = ''
         WHERE DLR_CD = #{dlrCd}
           AND PURC_NO = #{purcNo}
    </update>

</mapper>