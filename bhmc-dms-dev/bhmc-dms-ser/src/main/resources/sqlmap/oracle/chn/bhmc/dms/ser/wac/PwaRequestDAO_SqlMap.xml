<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : PwaRequestDAO_SqlMap.xml
    Description : PWA 요청 에 관한 데이터처리
    author Kwon Ki Hyun
    since 2016. 02. 29.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 02. 29.  Kwon Ki Hyun     최초 생성
-->


<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO">

    <!-- PWA 요청 상세 등록 -->
    <insert id="insertPwaRequests" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertPwaRequests] */
        INSERT INTO SE_0730T         --PWA신청
        (
          DLR_CD                     --딜러코드
         ,VIN_NO                     --차대번호
         ,PWA_DOC_NO                 --PWA문서번호
         ,PWA_STAT_CD                --PWA상태코드
         ,CAU_OPER_ATC_CD            --원인작업항목코드
         ,CAU_ITEM_CD                --원인품목코드
         ,CAU_CD                     --원인코드
         ,CAU_NM                     --원인명
         ,PHEN_CD                    --현상코드
         ,PHEN_NM                    --현상명
         ,RUN_DIST_VAL               --주행거리값
         ,ERR_PHEN_CONT              --고장현상내용
         ,RPIR_MTD_CONT              --수리방법내용
         ,PWA_TP_CD1                 --PWA유형코드1
         ,PWA_TP_CD2                 --PWA유형코드2
         ,CRE_DT                     --생산일자
         ,WART_DT                    --보증일자
         ,FILE_KEY_NM                --첨부파일키명
         ,LBR_OCCR_AMT               --공임발생금액
         ,ITEM_OCCR_AMT              --품목발생금액
         ,SUB_LBR_OCCR_AMT           --외주공임발생금액
         ,DLR_SIGN_REQ_DT            --딜러결재요청일자
         ,PWA_WRTR_ID                --PWA작성자ID
         ,PWA_WRTR_NM                --PWA작성자명
         ,ENGIN_NO                   --엔진번호
         ,CAR_REG_NO                 --차량번호
         ,CAR_OWNER_ID               --소유자 ID
         ,CAR_OWNER_NM               --소유자명
         ,CAR_OWNER_TEL_NO           --소유자 전화번호
         ,APPROVE_REASON_CONT        --승인사유내용
         ,RETURN_APPROVE_NO          --반품승인번호
         ,PWA_REQUI_NO               --关联申请单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
         ,CALC_DOC_NO                --服务结算单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
         ,REG_USR_ID                 --등록자ID
         ,REG_DT                     --등록일자
         ,UPDT_USR_ID                --수정자ID
         ,UPDT_DT                    --수정일자
        )
        VALUES
        (
          #{dlrCd}                     --딜러코드
         ,#{vinNo}                     --차대번호
         ,#{pwaDocNo}                  --PWA문서번호
         ,#{pwaStatCd}                 --PWA상태코드
         ,#{cauOperAtcCd}              --원인작업항목코드
         ,#{cauItemCd}                 --원인품목코드
         ,#{cauCd}                     --원인코드
         ,#{cauNm}                     --원인명
         ,#{phenCd}                    --현상코드
         ,#{phenNm}                    --현상명
         ,NVL(#{runDistVal} ,0)        --주행거리값
         ,#{errPhenCont}               --고장현상내용
         ,#{rpirMtdCont}               --수리방법내용
         ,#{pwaTpCd1}                  --PWA유형코드1
         ,#{pwaTpCd2}                  --PWA유형코드2
         ,#{creDt}                     --생산일자
         ,#{wartDt}                    --보증일자
         ,#{fileKeyNm}                 --첨부파일키명
         ,NVL(#{lbrOccrAmt} ,0)        --공임발생금액
         ,NVL(#{itemOccrAmt},0)        --품목발생금액
         ,NVL(#{subLbrOccrAmt},0)      --외주공임발생금액
         ,#{dlrSignReqDt}              --딜러결재요청일자
         ,#{pwaWrtrId}                 --PWA작성자ID
         ,#{pwaWrtrNm}                 --PWA작성자명
         ,#{enginNo}                   --엔진번호
         ,#{carRegNo}                  --차량번호
         ,#{carOwnerId}                --소유자 ID
         ,#{carOwnerNm}                --소유자명
         ,#{carOwnerTelNo}             --소유자 전화번호
         ,#{approveReasonCont}         --승인사유내용
         ,#{returnApproveNo}           --반품승인번호
         ,#{pwaRequiNo}                --关联申请单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
         ,#{calcDocNo}                 --服务结算单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
         ,#{regUsrId}                  --등록자ID
         ,sysdate                      --등록일자
         ,#{updtUsrId}                 --수정자ID
         ,sysdate                      --수정일자
        )

    </insert>

    <!-- PWA 공임 정보 등록 -->
    <insert id="insertPwaRequestLabor" parameterType="PwaLbrVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertPwaRequestLabor] */

        INSERT INTO DMSDB.SE_0732T    --PWA 공임
        (
          DLR_CD             --딜러코드
         ,PWA_DOC_NO         --PWA문서번호
         ,LINE_NO             --라인번호
         ,LBR_CD             --공임코드
         ,LBR_NM             --공임명
         ,LBR_QTY            --공임수량
         ,LBR_HM             --시간당금액
         ,LBR_PRC            --공임단가
         ,LBR_AMT            --공임금액
         ,CAU_LBR_YN         --원인공임
         ,DSTIN_CD           --공임구분코드
         ,REG_USR_ID         --등록자ID
         ,REG_DT             --등록일자
        )
        VALUES
        (
          #{dlrCd}             --딜러코드
         ,#{pwaDocNo}          --PWA문서번호
         ,(SELECT NVL(MAX(LINE_NO),0) +1
             FROM SE_0732T
            WHERE DLR_CD = #{dlrCd}
              AND PWA_DOC_NO = #{pwaDocNo}
          )                     --라인번호
         ,#{lbrCd}             --공임코드
         ,#{lbrNm}             --공임명
         ,#{lbrQty}            --공임수량
         ,#{lbrHm}             --시간당금액
         ,#{lbrPrc}            --공임단가
         ,#{lbrAmt}            --공임금액
         ,#{cauLbrYn}          --원인공임
         ,#{dstinCd}          --공임구분코드
         ,#{regUsrId}          --등록자ID
         ,SYSDATE              --등록일자
        )

    </insert>

    <!-- PWA 부품 정보 등록 -->
    <insert id="insertPwaRequestPart" parameterType="PwaPartVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertPwaRequestPart] */

       INSERT INTO SE_0731T    --PWA부품
        (
          DLR_CD              --딜러코드
         ,PWA_DOC_NO          --PWA문서번호
         ,LINE_NO             --라인번호
         ,ITEM_CD             --품목코드
         ,ITEM_NM             --품목명
         ,REQ_QTY             --요청수량
         ,SALE_UNIT_CD        --판매단위코드
         ,ITEM_PRC            --품목단가
         ,SALE_PRC_AMT
         ,ITEM_AMT            --품목금액
         ,CAU_ITEM_YN         --원인부품
         ,NPNP_MAX_AMT        --NPN PART MAX AMT
         ,NPNP_YN             --NPN PART YN
         ,REG_USR_ID          --등록자ID
         ,REG_DT              --등록일자
        )
        VALUES
        (
          #{dlrCd}              --딜러코드
         ,#{pwaDocNo}           --PWA문서번호
         ,(SELECT NVL(MAX(LINE_NO),0) +1
             FROM SE_0731T
            WHERE DLR_CD = #{dlrCd}
              AND PWA_DOC_NO = #{pwaDocNo}
          )                     --라인번호
         ,#{itemCd}             --품목코드
         ,#{itemNm}             --품목명
         ,#{reqQty}             --요청수량
         ,#{saleUnitCd}         --판매단위코드
         ,#{itemPrc}            --품목단가
         ,#{salePrcAmt}
         ,#{itemAmt}            --품목금액
         ,#{cauItemYn}
         ,#{npnpMaxAmt}         --NPN PART MAX AMT
         ,#{npnpYn}             --NPN PART YN
         ,#{regUsrId}           --등록자ID
         ,SYSDATE               --등록일자
        )

    </insert>

    <!-- PWA 요청 상세 수정 -->
    <update id="updatePwaRequests" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.updatePwaRequests] */

    UPDATE SE_0730T    --PWA신청
      SET
           UPDT_USR_ID         = #{updtUsrId}                 --수정자ID
          ,UPDT_DT             = sysdate                      --수정일자
          <if test=' pwaStatCd != null and pwaStatCd != "" ' >
          ,PWA_STAT_CD         = #{pwaStatCd}                 --PWA상태코드
           </if>
          <if test=' cauOperAtcCd != null and cauOperAtcCd != "" ' >
          ,CAU_OPER_ATC_CD     = #{cauOperAtcCd}              --원인작업항목코드
          </if>
          <if test=' cauItemCd != null and cauItemCd != "" ' >
          ,CAU_ITEM_CD         = #{cauItemCd}                 --원인품목코드
          </if>
          <if test=' cauCd != null and cauCd != "" ' >
          ,CAU_CD              = #{cauCd}                     --원인코드
          </if>
          <if test=' cauNm != null and cauNm != "" ' >
          ,CAU_NM              = #{cauNm}                     --원인명
          </if>
          <if test=' phenCd != null and phenCd != "" ' >
          ,PHEN_CD             = #{phenCd}                    --현상코드
          </if>
          <if test=' phenNm != null and phenNm != "" ' >
          ,PHEN_NM             = #{phenNm}                    --현상명
          </if>
          <if test=' runDistVal != null and runDistVal != "" ' >
          ,RUN_DIST_VAL        = #{runDistVal}                --주행거리값
          </if>
          <if test=' errPhenCont != null and errPhenCont != "" ' >
          ,ERR_PHEN_CONT       = #{errPhenCont}               --고장현상내용
          </if>
          <if test=' rpirMtdCont != null and rpirMtdCont != "" ' >
          ,RPIR_MTD_CONT       = #{rpirMtdCont}               --수리방법내용
          </if>
          <!-- <if test=' pwaTpCd1 != null and pwaTpCd1 != "" ' > -->
          ,PWA_TP_CD1          = #{pwaTpCd1}                  --PWA유형코드1
          <!-- </if> -->
          <!-- <if test=' pwaTpCd2 != null and pwaTpCd2 != "" ' > -->
          ,PWA_TP_CD2          = #{pwaTpCd2}                  --PWA유형코드2
          <!-- </if> -->
          <if test=' lbrOccrAmt != null ' >
          ,LBR_OCCR_AMT        = NVL(#{lbrOccrAmt} ,0)        --공임발생금액
          </if>
          <if test=' itemOccrAmt != null ' >
          ,ITEM_OCCR_AMT       = NVL(#{itemOccrAmt} ,0)       --품목발생금액
          </if>
          <!-- <if test=' subLbrOccrAmt != null ' > -->
          ,SUB_LBR_OCCR_AMT    = NVL(#{subLbrOccrAmt},0)      --외주공임발생금액
          <!-- </if> -->
          <if test=' pwaWrtrId != null and pwaWrtrId != "" ' >
          ,PWA_WRTR_ID         = #{pwaWrtrId}                 --PWA작성자ID
          </if>
          <if test=' pwaWrtrNm != null and pwaWrtrNm != "" ' >
          ,PWA_WRTR_NM         = #{pwaWrtrNm}                 --PWA작성자명
          </if>
          <if test=' fileKeyNm != null and fileKeyNm != "" ' >
          ,FILE_KEY_NM         = #{fileKeyNm}                 --첨부파일키명
          </if>
          <if test=' carRegNo != null and carRegNo != "" ' >
          ,CAR_REG_NO          = #{carRegNo}                  --차량번호
          </if>
          <if test=' enginNo != null and enginNo != "" ' >
          ,ENGIN_NO            = #{enginNo}                   --엔진번호
          </if>
          <if test=' carOwnerId != null and carOwnerId != "" ' >
          ,CAR_OWNER_ID        = #{carOwnerId}                --소유자 ID
          </if>
          <if test=' carOwnerNm != null and carOwnerNm != "" ' >
          ,CAR_OWNER_NM        = #{carOwnerNm}                --소유자명
          </if>
          <if test=' carOwnerTelNo != null and carOwnerTelNo != "" ' >
          ,CAR_OWNER_TEL_NO    = #{carOwnerTelNo}             --소유자 전화번호
          </if>
          ,RETURN_APPROVE_NO   = #{returnApproveNo }          --반품승인번호
          ,PWA_REQUI_NO        = #{pwaRequiNo}                --关联申请单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
          ,CALC_DOC_NO         = #{calcDocNo}                 --服务结算单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
     WHERE 1 = 1
       AND DLR_CD              = #{dlrCd}                     --딜러코드
       AND VIN_NO              = #{vinNo}                     --차대번호
       AND PWA_DOC_NO          = #{pwaDocNo}                  --PWA문서번호
    </update>

    <!-- PWA 요청 요청/취소 -->
    <update id="updatePwaRequestStat" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.updatePwaRequestStat] */

    UPDATE SE_0730T    --PWA신청
      SET
           PWA_STAT_CD         = #{pwaStatCd}                 --PWA상태코드
           <if test='pwaStatCd !=null and pwaStatCd !="" '>
            <choose>
               <when test='pwaStatCd == "Q" '>
                    ,DLR_SIGN_REQ_DT      = SYSDATE               --딜러결재요청일자
                    ,DLR_SIGN_REQ_CNT     = NVL(DLR_SIGN_REQ_CNT,0) + 1  --딜러결재요청횟수
               </when>
               <otherwise>
                  ,DLR_SIGN_REQ_DT      = null                     --딜러결재요청일자
                  ,DLR_SIGN_REQ_CNT     = CASE WHEN DLR_SIGN_REQ_CNT > 0 THEN (DLR_SIGN_REQ_CNT - 1) ELSE 0 END     --딜러결재요청횟수
               </otherwise>
            </choose>
          </if>
          ,PWA_REQUI_NO        = #{pwaRequiNo}                --关联申请单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
          ,CALC_DOC_NO         = #{calcDocNo}                 --服务结算单号 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
          ,UPDT_USR_ID         = #{updtUsrId}               --수정자ID
          ,UPDT_DT             = SYSDATE                    --수정일자
     WHERE 1 = 1
       AND DLR_CD              = #{dlrCd}                     --딜러코드
       AND VIN_NO              = #{vinNo}                     --차대번호
       AND PWA_DOC_NO          = #{pwaDocNo}                  --PWA문서번호
    </update>

    <!-- PWA 공임 정보 수정 -->
    <update id="updatePwaRequestLabor" parameterType="PwaLbrVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.updatePwaRequestLabor] */

        UPDATE SE_0732T                           --PWA 공임
          SET
               LBR_QTY     = #{lbrQty}            --공임수량
              ,LBR_HM      = #{lbrHm}             --시간당금액
              ,LBR_PRC     = #{lbrPrc}            --공임단가
              ,LBR_AMT     = #{lbrAmt}            --공임금액
              ,CAU_LBR_YN  = #{cauLbrYn}
              ,UPDT_USR_ID = #{updtUsrId}         --수정자ID
              ,UPDT_DT     = #{updtDt}            --수정일자
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND PWA_DOC_NO  = #{pwaDocNo}          --PWA문서번호
           AND LBR_CD      = #{lbrCd}             --공임코드
           AND LINE_NO     = #{lineNo}            --LINE NO

    </update>

    <!-- PWA 부품 정보 수정 -->
    <update id="updatePwaRequestPart" parameterType="PwaPartVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.updatePwaRequestPart] */

        UPDATE SE_0731T    --PWA부품
          SET
               REQ_QTY      = #{reqQty}             --요청수량
              ,SALE_UNIT_CD = #{saleUnitCd}         --판매단위코드
              ,ITEM_PRC     = #{itemPrc}            --품목단가
              ,ITEM_AMT     = #{itemAmt}            --품목금액
              ,CAU_ITEM_YN  = #{cauItemYn}
              ,UPDT_USR_ID  = #{updtUsrId}          --수정자ID
              ,UPDT_DT      = #{updtDt}             --수정일자
         WHERE 1 = 1
           AND DLR_CD       = #{dlrCd}              --딜러코드
           AND PWA_DOC_NO   = #{pwaDocNo}           --PWA문서번호
           AND LINE_NO      = #{lineNo}             --라인번호
           AND ITEM_CD      = #{itemCd}             --품목코드


    </update>

    <!-- PWA 요청 상세 삭제 -->
    <delete id="deletePwaRequests" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deletePwaRequests] */

    DELETE FROM SE_0730T
     WHERE 1 = 1
       AND DLR_CD              = #{dlrCd}                     --딜러코드
       AND VIN_NO              = #{vinNo}                     --차대번호
       AND PWA_DOC_NO          = #{pwaDocNo}                  --PWA문서번호

    </delete>

    <!-- PWA 공임 정보 전체 삭제 -->
    <delete id="deletePwaRequestLaborAll" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deletePwaRequestLaborAll] */

     DELETE FROM SE_0732T
      WHERE 1 = 1
        AND DLR_CD      = #{dlrCd}             --딜러코드
        AND PWA_DOC_NO  = #{pwaDocNo}          --PWA문서번호
    </delete>

    <!-- PWA 부품 정보 삭제 -->
    <delete id="deletePwaRequestPartAll" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deletePwaRequestPartAll] */

    DELETE FROM SE_0731T
      WHERE 1 = 1
        AND DLR_CD       = #{dlrCd}              --딜러코드
        AND PWA_DOC_NO   = #{pwaDocNo}           --PWA문서번호

    </delete>
    <!-- PWA 공임 정보 전체 삭제 -->
    <delete id="deletePwaRequestLabor" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deletePwaRequestLabor] */

       DELETE FROM SE_0732T
         WHERE 1 = 1
           AND DLR_CD      = #{dlrCd}             --딜러코드
           AND PWA_DOC_NO  = #{pwaDocNo}          --PWA문서번호
           AND LBR_CD      = #{lbrCd}             --공임코드
           AND LINE_NO     = #{lineNo}            --LINE NO
    </delete>

    <!-- PWA 부품 정보 삭제 -->
    <delete id="deletePwaRequestPart" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deletePwaRequestPart] */

    DELETE FROM SE_0731T
      WHERE 1 = 1
       AND DLR_CD       = #{dlrCd}              --딜러코드
       AND PWA_DOC_NO   = #{pwaDocNo}           --PWA문서번호
       AND LINE_NO      = #{lineNo}             --라인번호
       AND ITEM_CD      = #{itemCd}             --품목코드

    </delete>


   <!-- PWA 요청 인터페이스 정보  등록 -->
    <insert id="insertIfPwaRequests" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertIfPwaRequests] */

           INSERT INTO SE_0730I (
                     DLR_CD
                    ,VIN_NO
                    ,PWA_DOC_NO
                    ,PWA_STAT_CD
                    ,CAU_OPER_ATC_CD
                    ,CAU_ITEM_CD
                    ,CAU_CD
                    ,CAU_NM
                    ,PHEN_CD
                    ,PHEN_NM
                    ,RUN_DIST_VAL
                    ,ERR_PHEN_CONT
                    ,RPIR_MTD_CONT
                    ,RETURN_REASON_CONT
                    ,PWA_TP_CD1
                    ,PWA_TP_CD2
                    ,CRE_DT
                    ,WART_DT
                    ,FILE_KEY_NM
                    ,LBR_OCCR_AMT
                    ,ITEM_OCCR_AMT
                    ,SUB_LBR_OCCR_AMT
                    ,DLR_SIGN_REQ_DT
                    ,PWA_APPROVE_NO
                    ,HQ_APPROVE_DT
                    ,LBR_APPROVE_AMT
                    ,ITEM_APPROVE_AMT
                    ,SUB_LBR_APPROVE_AMT
                    ,PWA_WRTR_ID
                    ,PWA_WRTR_NM
                    ,HQ_APPROVE_NM
                    ,RO_DOC_NO
                    ,APPROVE_REASON_CONT
                    ,RETURN_APPROVE_NO
                    ,REG_USR_ID
                    ,REG_DT
                    ,UPDT_USR_ID
                    ,UPDT_DT
                    ,HQ_APPROVE_ID
                    ,CAR_REG_NO
                    ,ENGIN_NO
                    ,CAR_OWNER_ID
                    ,CAR_OWNER_NM
                    ,CAR_OWNER_TEL_NO
                    ,DLR_SIGN_REQ_CNT
                    ,IFRESULT
                   )
                  SELECT DLR_CD
                        ,VIN_NO
                        ,PWA_DOC_NO
                        ,PWA_STAT_CD
                        ,CAU_OPER_ATC_CD
                        ,CAU_ITEM_CD
                        ,CAU_CD
                        ,CAU_NM
                        ,PHEN_CD
                        ,PHEN_NM
                        ,RUN_DIST_VAL
                        ,ERR_PHEN_CONT
                        ,RPIR_MTD_CONT
                        ,RETURN_REASON_CONT
                        ,PWA_TP_CD1
                        ,PWA_TP_CD2
                        ,CRE_DT
                        ,WART_DT
                        ,FILE_KEY_NM
                        ,LBR_OCCR_AMT
                        ,ITEM_OCCR_AMT
                        ,SUB_LBR_OCCR_AMT
                        ,DLR_SIGN_REQ_DT
                        ,PWA_APPROVE_NO
                        ,HQ_APPROVE_DT
                        ,LBR_APPROVE_AMT
                        ,ITEM_APPROVE_AMT
                        ,SUB_LBR_APPROVE_AMT
                        ,PWA_WRTR_ID
                        ,PWA_WRTR_NM
                        ,HQ_APPROVE_NM
                        ,RO_DOC_NO
                        ,APPROVE_REASON_CONT
                        ,RETURN_APPROVE_NO
                        ,REG_USR_ID
                        ,REG_DT
                        ,UPDT_USR_ID
                        ,UPDT_DT
                        ,HQ_APPROVE_ID
                        ,CAR_REG_NO
                        ,ENGIN_NO
                        ,CAR_OWNER_ID
                        ,CAR_OWNER_NM
                        ,CAR_OWNER_TEL_NO
                        ,DLR_SIGN_REQ_CNT
                        ,'N'
                    FROM SE_0730T
                   WHERE 1 = 1
                     AND DLR_CD      = #{dlrCd}                     --딜러코드
                     AND VIN_NO      = #{vinNo}                     --차대번호
                     AND PWA_DOC_NO  = #{pwaDocNo}                  --PWA문서번호

    </insert>

   <!-- PWA 요청 인터페이스 정보  부품 등록 -->
    <insert id="insertIfPwaRequestParts" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertIfPwaRequestParts] */

           INSERT INTO SE_0731I (
                  DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,CALC_TP
                ,ITEM_CD
                ,ITEM_NM
                ,REQ_QTY
                ,SALE_UNIT_CD
                ,ITEM_PRC
                ,ITEM_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_ITEM_YN
                ,IFRESULT
               )
          SELECT DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,CALC_TP
                ,ITEM_CD
                ,ITEM_NM
                ,REQ_QTY
                ,SALE_UNIT_CD
                ,ITEM_PRC
                ,ITEM_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_ITEM_YN
                ,'N'
              FROM SE_0731T
             WHERE 1 = 1
               AND DLR_CD      = #{dlrCd}                     --딜러코드
               AND PWA_DOC_NO  = #{pwaDocNo}                  --PWA문서번호

    </insert>

   <!-- PWA 요청 인터페이스 정보  공임 등록 -->
    <insert id="insertIfPwaRequestLabors" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.insertIfPwaRequestLabors] */

           INSERT INTO SE_0732I (
                 DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,LBR_CD
                ,LBR_QTY
                ,HM_AMT
                ,LBR_PRC
                ,LBR_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_LBR_YN
                ,LBR_NM
                ,IFRESULT
               )
          SELECT DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,LBR_CD
                ,LBR_QTY
                ,LBR_HM
                ,LBR_PRC
                ,LBR_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_LBR_YN
                ,LBR_NM
                ,'N'
              FROM SE_0732T
             WHERE 1 = 1
               AND DLR_CD      = #{dlrCd}             --딜러코드
               AND PWA_DOC_NO  = #{pwaDocNo}          --PWA문서번호

    </insert>

   <!-- PWA 요청 인터페이스 정보  삭제 -->
    <delete id="deleteIfPwaRequests" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deleteIfPwaRequests] */

    DELETE FROM SE_0730I
     WHERE 1 = 1
       AND DLR_CD              = #{dlrCd}                     --딜러코드
       AND VIN_NO              = #{vinNo}                     --차대번호
       AND PWA_DOC_NO          = #{pwaDocNo}                  --PWA문서번호

    </delete>

    <!-- PWA 공임 인터페이스 정보 전체 삭제 -->
    <delete id="deleteIfPwaRequestLabor" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deleteIfPwaRequestLabor] */

     DELETE FROM SE_0732I
     WHERE 1 = 1
       AND DLR_CD      = #{dlrCd}             --딜러코드
       AND PWA_DOC_NO  = #{pwaDocNo}          --PWA문서번호

    </delete>

    <!-- PWA 부품 인터페이스 정보 삭제 -->
    <delete id="deleteIfPwaRequestPart" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.deleteIfPwaRequestPart] */

    DELETE FROM SE_0731I
      WHERE 1 = 1
       AND DLR_CD       = #{dlrCd}              --딜러코드
       AND PWA_DOC_NO   = #{pwaDocNo}           --PWA문서번호

    </delete>

    <!-- PWA 요청 인터페이스 전송 여부 정보 -->
    <select id="selectPwaRequestIfSendByConditionCnt" parameterType="PwaVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestIfSendByConditionCnt] */

        SELECT COUNT(PWA_DOC_NO) AS VALUE
          FROM SE_0730I
         WHERE DLR_CD = #{dlrCd}
           AND VIN_NO = #{vinNo}
           AND PWA_DOC_NO = #{pwaDocNo}
           <if test ='ifResltYn != null and ifResltYn != ""'>
           AND IFRESULT = #{ifResltYn}
           </if>


    </select>


    <!-- PWA 요청  목록수를 조회  -->
    <select id="selectPwaRequestMainsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestMainsByConditionCnt] */

           SELECT COUNT(PWA_DOC_NO) VALUE
             FROM SE_0730T
             WHERE DLR_CD = #{sDlrCd}
             <if test='sPwaStatCd != null and sPwaStatCd != "" '>
                AND PWA_STAT_CD = #{sPwaStatCd}
             </if>
             <if test='sPwaDocNo != null and sPwaDocNo != "" '>
                AND PWA_DOC_NO = #{sPwaDocNo}
             </if>
             <if test='sVinNo != null and sVinNo != "" '>
                <choose>
                    <when test='sVinLength == 17 '>
                        AND VIN_NO = #{sVinNo}
                    </when>
                    <otherwise>
                        AND VIN_NO LIKE '%'|| #{sVinNo} ||'%'
                    </otherwise>
                </choose>
             </if>
             <if test='sFromDt !=null'>
               AND REG_DT <![CDATA[>=]]> #{sFromDt}
             </if>
             <if test='sToDt !=null'>
               AND REG_DT <![CDATA[<=]]> #{sToDt}+1
             </if>

    </select>

    <!-- PWA 요청 목록 조회  -->
    <select id="selectPwaRequestMainsByCondition" parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestMainsByCondition] */

        SELECT *
          FROM (
              SELECT ROWNUM AS RNUM , T1.*
                FROM (
                SELECT
                        DLR_CD                     --딜러코드
                       ,VIN_NO                     --차대번호
                       ,PWA_DOC_NO                 --PWA문서번호
                       ,PWA_STAT_CD                --PWA상태코드
                       ,(SELECT CMM_CD_TXT
                         FROM CM_0304T
                        WHERE LANG_CD = NVL(#{sLangCd},'zh')
                          AND CMM_GRP_CD ='SER102'
                          AND CMM_CD = PWA_STAT_CD ) PWA_STAT_NM
                       ,CAU_OPER_ATC_CD            --원인작업항목코드
                       ,CAU_ITEM_CD                --원인품목코드
                       ,CAU_CD                     --원인코드
                       ,CAU_NM                     --원인명
                       ,PHEN_CD                    --현상코드
                       ,PHEN_NM                    --현상명
                       ,RUN_DIST_VAL               --주행거리값
                       ,ERR_PHEN_CONT              --고장현상내용
                       ,RPIR_MTD_CONT              --수리방법내용
                       ,RETURN_REASON_CONT         --반송사유내용
                       ,PWA_TP_CD1                 --PWA유형코드1
                       ,PWA_TP_CD2                 --PWA유형코드2
                       ,CRE_DT                     --생산일자
                       ,WART_DT                    --보증일자
                       ,FILE_KEY_NM                --첨부파일키명
                       ,LBR_OCCR_AMT               --공임발생금액
                       ,ITEM_OCCR_AMT              --품목발생금액
                       ,SUB_LBR_OCCR_AMT           --외주공임발생금액
                       ,DLR_SIGN_REQ_DT            --딜러결재요청일자
                       ,PWA_APPROVE_NO             --PWA승인번호
                       ,CASE WHEN PWA_STAT_CD = 'A'
                                  THEN HQ_APPROVE_DT
                             WHEN PWA_STAT_CD = 'R'
                                  THEN RETURN_DT
                             WHEN PWA_STAT_CD = 'C'
                                  THEN REJECT_DT
                             END AS HQ_APPROVE_DT  --심사일자
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN LBR_OCCR_AMT  ELSE LBR_APPROVE_AMT END AS LBR_APPROVE_AMT   --공임승인금액
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN ITEM_OCCR_AMT ELSE ITEM_APPROVE_AMT END AS ITEM_APPROVE_AMT --품목승인금액
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN SUB_LBR_OCCR_AMT ELSE SUB_LBR_APPROVE_AMT END AS SUB_LBR_APPROVE_AMT --외주공임승인금액
                       ,PWA_WRTR_ID                --PWA작성자ID
                       ,PWA_WRTR_NM                --PWA작성자명
                       ,RO_DOC_NO                  --RO일련번호
                       ,APPROVE_REASON_CONT        --승인사유내용
                       ,RETURN_APPROVE_NO          --반품승인번호
                       ,REG_USR_ID                 --등록자ID
                       ,REG_DT                     --등록일자
                       ,UPDT_USR_ID                --수정자ID
                       ,UPDT_DT                    --수정일자
                       ,HQ_APPROVE_ID              --본사승인ID
                       ,HQ_APPROVE_NM              --본부승인명
                       ,CAR_REG_NO                 --차량등록번호
                       ,ENGIN_NO                   --엔진번호
                       ,CAR_OWNER_ID               --차량소유자ID
                       ,CAR_OWNER_NM               --차량소유자명
                       ,CAR_OWNER_TEL_NO           --차량소유자전화번호
                       ,DLR_SIGN_REQ_CNT           --딜러결재요청횟수
                       ,PWA_SEQ                    --PWA일련번호
                       ,RETURN_CNT                 --리턴 횟수
                       ,PWA_REQUI_NO               --关联申请单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26 
                       ,CALC_DOC_NO                --服务结算单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
                  FROM SE_0730T
                 WHERE DLR_CD = #{sDlrCd}
                  <if test='sPwaStatCd != null and sPwaStatCd != "" '>
                   AND PWA_STAT_CD = #{sPwaStatCd}
                  </if>
                  <if test='sPwaDocNo != null and sPwaDocNo != "" '>
                   AND PWA_DOC_NO = #{sPwaDocNo}
                  </if>
                  <if test='sVinNo != null and sVinNo != "" '>
                      <choose>
                          <when test='sVinLength == 17 '>
                              AND VIN_NO = #{sVinNo}
                          </when>
                          <otherwise>
                              AND VIN_NO LIKE '%'|| #{sVinNo} ||'%'
                          </otherwise>
                      </choose>
                  </if>
                  <if test='sFromDt !=null'>
                  AND REG_DT <![CDATA[>=]]> #{sFromDt}
                  </if>
                  <if test='sToDt !=null'>
                  AND REG_DT <![CDATA[<=]]> #{sToDt}+1
                  </if>
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "pwaStatCd"'>PWA_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    REG_DT DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        REG_DT DESC
                    </otherwise>
                </choose>
              ) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>

    </select>

    <!-- 获取PWA 系数  需求 4，弹框 延保索赔申请类型的PWA申请单，查询 并用是已经承认 状态的 csr清单 　62 贾明 2020-3-25  -->
    <select id="selectPwaRelateRequiMainsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRelateRequiMainsByConditionCnt] */
        
           SELECT COUNT(PWA_DOC_NO) VALUE
             FROM SE_0730T
             WHERE DLR_CD = #{sDlrCd}
                   AND PWA_STAT_CD = 'A'  --PWA 状态 A代表承认
                   AND PWA_TP_CD1 = 'A'  --10代表 PWA类型1 选择是 延保索赔申请   CSR 76	DMS pwa申请功能  A  延保索赔申请 10 作废 C  延保索赔结算 11 作废 贾明 2020-4-19 
             <if test='sVinNo != null and sVinNo != "" '>
                   AND VIN_NO = #{sVinNo}
             </if>
               AND PWA_DOC_NO NOT IN (
                        SELECT PWA_REQUI_NO FROM SE_0730T WHERE PWA_TP_CD1 = 'C' AND  PWA_REQUI_NO IS NOT NULL   --CSR 76	DMS pwa申请功能  A  延保索赔申请 10 作废 C  延保索赔结算 11 作废 贾明 2020-4-19 
               )
    </select>
    
    <!-- 获取PWA 系数  需求 4，弹框 延保索赔申请类型的PWA申请单，查询 并用是已经承认 状态的 csr清单 　62 贾明 2020-3-25  -->
    <select id="selectPwaRelateRequiMainsByCondition" parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRelateRequiMainsByCondition] */

        SELECT *
          FROM (
              SELECT ROWNUM AS RNUM , T1.*
                FROM (
                SELECT
                        DLR_CD                     --딜러코드
                       ,VIN_NO                     --차대번호
                       ,PWA_DOC_NO                 --PWA문서번호
                       ,PWA_STAT_CD                --PWA상태코드
                       ,(SELECT CMM_CD_TXT
                         FROM CM_0304T
                        WHERE LANG_CD = NVL(#{sLangCd},'zh')
                          AND CMM_GRP_CD ='SER102'
                          AND CMM_CD = PWA_STAT_CD ) PWA_STAT_NM
                       ,CAU_OPER_ATC_CD            --원인작업항목코드
                       ,CAU_ITEM_CD                --원인품목코드
                       ,CAU_CD                     --원인코드
                       ,CAU_NM                     --원인명
                       ,PHEN_CD                    --현상코드
                       ,PHEN_NM                    --현상명
                       ,RUN_DIST_VAL               --주행거리값
                       ,ERR_PHEN_CONT              --고장현상내용
                       ,RPIR_MTD_CONT              --수리방법내용
                       ,RETURN_REASON_CONT         --반송사유내용
                       ,PWA_TP_CD1                 --PWA유형코드1
                       ,PWA_TP_CD2                 --PWA유형코드2
                       ,CRE_DT                     --생산일자
                       ,WART_DT                    --보증일자
                       ,FILE_KEY_NM                --첨부파일키명
                       ,LBR_OCCR_AMT               --공임발생금액
                       ,ITEM_OCCR_AMT              --품목발생금액
                       ,SUB_LBR_OCCR_AMT           --외주공임발생금액
                       ,DLR_SIGN_REQ_DT            --딜러결재요청일자
                       ,PWA_APPROVE_NO             --PWA승인번호
                       ,CASE WHEN PWA_STAT_CD = 'A'
                                  THEN HQ_APPROVE_DT
                             WHEN PWA_STAT_CD = 'R'
                                  THEN RETURN_DT
                             WHEN PWA_STAT_CD = 'C'
                                  THEN REJECT_DT
                             END AS HQ_APPROVE_DT  --심사일자
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN LBR_OCCR_AMT  ELSE LBR_APPROVE_AMT END AS LBR_APPROVE_AMT   --공임승인금액
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN ITEM_OCCR_AMT ELSE ITEM_APPROVE_AMT END AS ITEM_APPROVE_AMT --품목승인금액
                       ,CASE WHEN PWA_APPROVE_NO IS NULL THEN SUB_LBR_OCCR_AMT ELSE SUB_LBR_APPROVE_AMT END AS SUB_LBR_APPROVE_AMT --외주공임승인금액
                       ,PWA_WRTR_ID                --PWA작성자ID
                       ,PWA_WRTR_NM                --PWA작성자명
                       ,RO_DOC_NO                  --RO일련번호
                       ,APPROVE_REASON_CONT        --승인사유내용
                       ,RETURN_APPROVE_NO          --반품승인번호
                       ,REG_USR_ID                 --등록자ID
                       ,REG_DT                     --등록일자
                       ,UPDT_USR_ID                --수정자ID
                       ,UPDT_DT                    --수정일자
                       ,HQ_APPROVE_ID              --본사승인ID
                       ,HQ_APPROVE_NM              --본부승인명
                       ,CAR_REG_NO                 --차량등록번호
                       ,ENGIN_NO                   --엔진번호
                       ,CAR_OWNER_ID               --차량소유자ID
                       ,CAR_OWNER_NM               --차량소유자명
                       ,CAR_OWNER_TEL_NO           --차량소유자전화번호
                       ,DLR_SIGN_REQ_CNT           --딜러결재요청횟수
                       ,PWA_SEQ                    --PWA일련번호
                       ,RETURN_CNT                 --리턴 횟수
                  FROM SE_0730T
                 WHERE DLR_CD = #{sDlrCd}
                       AND PWA_STAT_CD = 'A'   --PWA 状态 A代表承认
                       AND PWA_TP_CD1 = 'A'   --10代表 PWA类型1 选择是 延保索赔申请 CSR 76	DMS pwa申请功能  A  延保索赔申请 10 作废 C  延保索赔结算 11 作废 贾明 2020-4-19 
                       <if test='sVinNo != null and sVinNo != "" '>
                           AND VIN_NO = #{sVinNo}
                      </if>
                         AND PWA_DOC_NO NOT IN (
                            SELECT PWA_REQUI_NO FROM SE_0730T WHERE PWA_TP_CD1 = 'C' AND  PWA_REQUI_NO IS NOT NULL  --CSR 76	DMS pwa申请功能  A  延保索赔申请 10 作废 C  延保索赔结算 11 作废 贾明 2020-4-19 
                        )
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "pwaStatCd"'>PWA_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    HQ_APPROVE_DT DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        HQ_APPROVE_DT DESC
                    </otherwise>
                </choose>
              ) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>

    </select>
    <!-- 获取PWA弹框 延保索赔申请类型的PWA申请单，查询 并用是已经承认 状态的 csr清单 　62 贾明 2020-3-27 -->
    <!-- 保存时  结算单关联过延保索赔结算类型的PWA单据；则提示  结算单已关联过PWA申请，请修改 -->
    <!-- 延保索赔结算单保存时,查询是否延保申请单有没有被其他 延保索赔结算单关联过. -->
    <select id="selectPwaRelateRequiByCondition" parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRelateRequiByCondition] */
          SELECT  
                VIN_NO
               ,PWA_DOC_NO,
               PWA_STAT_CD,
               PWA_REQUI_NO 
               FROM SE_0730T 
             WHERE DLR_CD = #{sDlrCd}
                  AND PWA_REQUI_NO = #{sPwaRequiNo}
        
    </select>

	<select id="selectSpecialCarWarrantyEndInfo" parameterType="String" resultType="Integer">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectSpecialCarWarrantyEndInfo] */
       SELECT 
       NORM_WARR_PER  
       FROM SE_1151T
       WHERE 1=1
       AND VIN_NO = #{vinNo}
    </select>
	<select id="selectCarWarrantyEndDtByKey" parameterType="PwaVO" resultType="java.util.Date">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectCarWarrantyEndDtByKey] */
          SELECT ADD_MONTHS( #{wartDt} - 1 ,CASE WHEN (SELECT CAR_DSTIN_CD FROM SA_0121T WHERE VIN_NO = #{vinNo} ) ='P' THEN LMT_MM ELSE TAXI_LMT_MM END )  AS GRTE_END_DT
            FROM (
            SELECT CASE WHEN LMT_MM IS NULL THEN A_LMT_MM ELSE LMT_MM END LMT_MM
                  ,CASE WHEN TAXI_LMT_MM IS NULL THEN A_TAXI_LMT_MM ELSE TAXI_LMT_MM END TAXI_LMT_MM
              FROM (
              SELECT MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN LMT_MM END)                AS LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN LMT_RUN_DIST_VAL END)      AS LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN TAXI_LMT_RUN_DIST_VAL END) AS TAXI_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN TAXI_LMT_MM END)           AS TAXI_LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN LMT_MM END)                          AS A_LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN LMT_RUN_DIST_VAL END)                AS A_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN TAXI_LMT_RUN_DIST_VAL END)           AS A_TAXI_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN TAXI_LMT_MM END)                     AS A_TAXI_LMT_MM
                FROM SE_1120T A
               WHERE (A.LTS_MODEL_CD = #{ltsModelCd} OR LTS_MODEL_CD ='ALL' )
                AND TO_DATE( TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') BETWEEN APPLY_START_DT AND APPLY_END_DT
                AND WART_RPIR_TP ='W'
             )
           )
    </select>
    <!-- PWA 상세정보 -->
    <select id="selectPwaRequestByKey" parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestByKey] */

    SELECT DLR_CD , VIN_NO , PWA_DOC_NO , PWA_STAT_CD , CAU_OPER_ATC_CD
          ,( SELECT
                    <choose>
                        <when test='sLangCd == "ko"' >LBR_EN_NM</when>
                        <otherwise>LBR_CHN_NM</otherwise>
                    </choose>
                FROM SE_1060T
               WHERE DSTIN_CD ='H'
                 AND DLR_CD   ='A07AA'
                 AND LBR_CD   = CAU_OPER_ATC_CD) CAU_OPER_ATC_NM
          ,CAU_ITEM_CD
          ,(SELECT
                 <choose>
                    <when test='sLangCd == "ko"' >ITEM_EN_NM</when>
                    <otherwise>ITEM_NM</otherwise>
                 </choose>
             FROM PT_0201T
            WHERE DLR_CD  = #{sDlrCd}
              AND SPYR_CD = '01'
              AND ITEM_CD = CAU_ITEM_CD
              AND ROWNUM = 1 ) AS CAU_ITEM_NM
          ,CAU_CD
          ,CAU_NM
          ,PHEN_CD
          ,PHEN_NM
          ,RUN_DIST_VAL
          ,ERR_PHEN_CONT
          ,RPIR_MTD_CONT
          ,RETURN_REASON_CONT
          ,PWA_TP_CD1
          ,PWA_TP_CD2
          ,CRE_DT
          ,WART_DT
          ,FILE_KEY_NM
          ,LBR_OCCR_AMT , ITEM_OCCR_AMT , SUB_LBR_OCCR_AMT
          ,(LBR_OCCR_AMT + ITEM_OCCR_AMT + SUB_LBR_OCCR_AMT) AS TOT_OCCR_AMT
          ,DLR_SIGN_REQ_DT , PWA_APPROVE_NO , HQ_APPROVE_DT
          ,LBR_APPROVE_AMT , ITEM_APPROVE_AMT , SUB_LBR_APPROVE_AMT
          ,(LBR_APPROVE_AMT + ITEM_APPROVE_AMT + SUB_LBR_APPROVE_AMT ) AS TOT_APPROVE_AMT
          ,PWA_WRTR_ID , PWA_WRTR_NM , HQ_APPROVE_ID , HQ_APPROVE_NM , RO_DOC_NO
          ,APPROVE_REASON_CONT , RETURN_APPROVE_NO
          ,#{sLtsModelCd} AS LTS_MODEL_CD
          ,FN_SER_LTS_MODEL_NM(#{sLtsModelCd} , #{sLangCd}) AS LTS_MODEL_NM
          ,CAR_REG_NO
          ,ENGIN_NO
          ,CAR_OWNER_ID
          ,CAR_OWNER_NM
          ,CAR_OWNER_TEL_NO
          ,(SELECT CARLINE_CD
              FROM SA_0121T
            WHERE VIN_NO = A.VIN_NO
              AND ROWNUM = 1) AS CARLINE_CD
           ,CALC_DOC_NO      --服务结算单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26
           ,PWA_REQUI_NO     --关联申请单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-3-26 
     FROM SE_0730T A
     WHERE DLR_CD = #{sDlrCd}
       <if test='sVinNo != null and sVinNo != "" '>
       AND VIN_NO = #{sVinNo}
       </if>
       <if test='sPwaDocNo != null and sPwaDocNo != "" '>
       AND PWA_DOC_NO = #{sPwaDocNo}
        </if>

    </select>

    <!-- PWA 요청 공임 갯수 정보 -->
    <select id="selectPwaRequestLbrsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestLbrsByConditionCnt] */

        SELECT COUNT(LBR_CD) AS VALUE
          FROM SE_0732T
         WHERE DLR_CD = #{sDlrCd}
           AND PWA_DOC_NO = #{sPwaDocNo}

    </select>

    <!-- PWA 요청 공임 정보 -->
    <select id="selectPwaRequestLbrsByCondition" parameterType="PwaSearchVO" resultType="PwaLbrVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestLbrsByCondition] */

          SELECT ROWNUM AS RNUM ,T1.*
            FROM (
                SELECT LINE_NO
                      ,DLR_CD
                      ,PWA_DOC_NO
                      ,LBR_CD
                      ,LBR_NM
                      ,LBR_QTY
                      ,LBR_HM
                      ,LBR_PRC
                      ,LBR_AMT
                      ,CAU_LBR_YN
                      ,DSTIN_CD
                      ,(SELECT LBR_TP FROM SE_1060T WHERE DSTIN_CD = A.DSTIN_CD AND DLR_CD = DECODE(A.DSTIN_CD, 'H', 'A07AA', A.DLR_CD) AND LBR_CD = A.LBR_CD) AS LBR_TP
                      ,(SELECT LBR_CD_TP FROM SE_1060T WHERE DSTIN_CD = A.DSTIN_CD AND DLR_CD = DECODE(A.DSTIN_CD, 'H', 'A07AA', A.DLR_CD) AND LBR_CD = A.LBR_CD) AS LBR_CD_TP
                      ,(
                        SELECT 'N'
                          FROM SE_1140T
                         WHERE LTS_MODEL_CD = #{sLtsModelCd}
                           AND TO_DATE(TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') BETWEEN APPLY_START_DT AND APPLY_END_DT
                           AND SUB_LBR_CD = A.LBR_CD
                      ) AS REL_CAU_LBR_YN
                  FROM SE_0732T A
                 WHERE DLR_CD     = #{sDlrCd}
                   AND PWA_DOC_NO = #{sPwaDocNo}
                   ORDER BY LINE_NO ASC
              ) T1

    </select>

    <!-- RO 공임 목록수 조회. -->
    <select id="selectRoLaborsByConditionCnt" parameterType="TabInfoSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectRoLaborsByConditionCnt] */

      SELECT COUNT(A.LBR_CD) AS VALUE
        FROM SE_0170T A
       WHERE A.DLR_CD  = #{sDlrCd}
        <if test='sPreFixId != null and sPreFixId != ""'>
         AND A.PREFIX_ID = 'RO'
        </if>
        <if test='sDocNo != null and sDocNo != ""'>
         AND A.DOC_NO    = #{sDocNo}
        </if>
        ORDER BY
        <choose>
            <when test='sort != null'>
            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                <choose>
                    <when test='item.field == "dlrCd"'>           DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "preFixId"'>        PREFIX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                    <when test='item.field == "docNo"'>           DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lineNo"'>          LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrCd"'>           LBR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrNm"'>           LBR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrPrc"'>          LBR_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrQty"'>          LBR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrHm"'>           LBR_HM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrTotAmt"'>       LBR_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <otherwise>
                        DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
                    </otherwise>
                </choose>
            </foreach>
            </when>
            <otherwise>
                DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
            </otherwise>
        </choose>
    </select>


    <!-- RO 공임 목록 조회. -->
    <select id="selectRoLaborsByCondition" parameterType="TabInfoSearchVO" resultType="PwaLbrVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectRoLaborsByCondition] */
      SELECT
            A.DLR_CD                                  --딜러코드
           ,'' AS PWA_DOC_NO
           ,A.LBR_CD                                  --공임코드
           ,A.LBR_NM                                  --공임명
           ,A.LBR_TP                                  --增加工时类型 JiaMing 2019-4-24 
           ,NVL(A.LBR_QTY,1) AS LBR_QTY               --공임수량
           ,A.LBR_HM                                  --공임시간
           ,NVL(A.LBR_PRC,0) AS LBR_PRC               --공임단가
           ,NVL(A.LBR_TOT_AMT,0) AS LBR_AMT           --공임금액
           ,A.DSTIN_CD
           ,NVL(                                      --외주공임이 없을때 모두 보조업무, 있을때 ZZ공임이 아닌 공임 중 하나만 주업무
               (SELECT 'N'
                  FROM DUAL
                 WHERE 'ZZ' NOT IN (SELECT SUBSTR(B.LBR_CD,-2,2)
                                      FROM SE_0170T B
                                     WHERE B.DLR_CD  = #{sDlrCd}
                                      <if test='sPreFixId != null and sPreFixId != ""'>
                                       AND B.PREFIX_ID = 'RO'
                                      </if>
                                      <if test='sDocNo != null and sDocNo != ""'>
                                       AND B.DOC_NO    = #{sDocNo}
                                      </if>
                                   )
               )
               ,DECODE(A.LBR_CD,(SELECT C.LBR_CD
                                   FROM SE_0170T C
                                  WHERE C.DLR_CD  = #{sDlrCd}
                                   <if test='sPreFixId != null and sPreFixId != ""'>
                                    AND C.PREFIX_ID = 'RO'
                                   </if>
                                   <if test='sDocNo != null and sDocNo != ""'>
                                    AND C.DOC_NO    = #{sDocNo}
                                   </if>
                                    AND SUBSTR(C.LBR_CD,-2,2) != 'ZZ'
                                    AND ROWNUM = 1
                                ),'Y','N')
           ) AS CAU_LBR_YN
           ,(
              SELECT 'N'
                FROM SE_1140T
               WHERE LTS_MODEL_CD = #{sLtsModelCd}
                 AND TO_DATE(TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') BETWEEN APPLY_START_DT AND APPLY_END_DT
                 AND SUB_LBR_CD   = A.LBR_CD
             ) AS REL_CAU_LBR_YN
           ,D.CAU_ITEM_CD
           ,D.CAU_ITEM_NM
           ,D.CAU_CD
           ,D.CAU_NM
           ,D.PHEN_CD
           ,D.PHEN_NM
        FROM SE_0170T A LEFT OUTER JOIN SE_1072T D
            ON A.DLR_CD = D.DLR_CD
            AND A.CR_NO = D.CR_NO
            AND A.LBR_CD = D.LBR_CD
       WHERE A.DLR_CD  = #{sDlrCd}
        <if test='sPreFixId != null and sPreFixId != ""'>
         AND A.PREFIX_ID = 'RO'
        </if>
        <if test='sDocNo != null and sDocNo != ""'>
         AND A.DOC_NO    = #{sDocNo}
        </if>
        ORDER BY
        <choose>
            <when test='sort != null'>
            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                <choose>
                    <when test='item.field == "dlrCd"'>           DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "preFixId"'>        PREFIX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                    <when test='item.field == "docNo"'>           DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lineNo"'>          LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrCd"'>           LBR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrNm"'>           LBR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrPrc"'>          LBR_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrQty"'>          LBR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrHm"'>           LBR_HM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrTotAmt"'>       LBR_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "lbrTp"'>           LBR_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <otherwise>
                        DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
                    </otherwise>
                </choose>
            </foreach>
            </when>
            <otherwise>
                DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
            </otherwise>
        </choose>
    </select>



    <!-- PWA 요청 상태 정보 -->
    <select id="selectPwaRequestStatChkByKey" parameterType="PwaVO" resultType="string" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestStatChkByKey] */

        SELECT PWA_STAT_CD
          FROM SE_0730T
         WHERE DLR_CD     = #{dlrCd}
           AND PWA_DOC_NO = #{pwaDocNo}

    </select>

    <!-- PWA 요청 부품 갯수 정보 -->
    <select id="selectPwaRequestPartsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestPartsByConditionCnt] */

         SELECT COUNT(ITEM_CD) AS VALUE
          FROM SE_0731T
         WHERE DLR_CD     = #{sDlrCd}
           AND PWA_DOC_NO = #{sPwaDocNo}

    </select>

    <!-- PWA 요청 부품 정보 -->
    <select id="selectPwaRequestPartsByCondition" parameterType="PwaSearchVO" resultType="PwaPartVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestPartsByCondition] */

          SELECT ROWNUM AS RNUM ,T1.*
            FROM (
                 SELECT DLR_CD
                       ,PWA_DOC_NO
                       ,LINE_NO
                       ,ITEM_CD
                       ,ITEM_NM
                       ,REQ_QTY
                       ,SALE_UNIT_CD
                       ,ITEM_PRC
                       ,SALE_PRC_AMT
                       ,ITEM_AMT
                       ,CAU_ITEM_YN
                       ,NVL(NPNP_MAX_AMT,0) AS NPNP_MAX_AMT
                       ,NVL(NPNP_YN,'N')    AS NPNP_YN
                       ,( 1 + FN_GET_VAT(null,'ALL')) AS TAX_RATE <!-- 税率 贾明 2019-3-25 为计算pwa申请配件项目 配件金额-->
                       ,(
                            SELECT
                                TB.PTUP_DUMP AS MARK_UP
                            FROM(
                                SELECT
                                    TRIM(T1.APCP_PART_NO) AS APCP_PART_NO
                                    ,T1.APCP_APPLY_DATE
                                    ,T1.APCP_PRICE_NAT_AMT
                                FROM PT_0216I T1
                                INNER JOIN(
                                SELECT
                                    TRIM(APCP_PART_NO) AS APCP_PART_NO
                                    ,MAX(APCP_APPLY_DATE) AS APCP_APPLY_DATE
                                FROM PT_0216I
                                GROUP BY APCP_PART_NO
                                ) T2 ON T1.APCP_PART_NO = T2.APCP_PART_NO AND T1.APCP_APPLY_DATE = T2.APCP_APPLY_DATE
                            )TA LEFT JOIN (
                                SELECT
                                    TRIM(PTUP_PART_NO) AS PTUP_PART_NO
                                    ,MAX(PTUP_CDAT) AS PTUP_CDAT
                                    ,MAX(PTUP_DUMP) AS PTUP_DUMP
                                    ,'Y' AS MARKUP_USE_YN
                                FROM PT_0215I
                                GROUP BY PTUP_PART_NO
                            )TB ON TA.APCP_PART_NO = TB.PTUP_PART_NO
                            WHERE TA.APCP_PART_NO = A.ITEM_CD
                        ) AS ITEM_MARKUP
                  FROM SE_0731T A
                 WHERE DLR_CD     = #{sDlrCd}
                   AND PWA_DOC_NO = #{sPwaDocNo}
                   ORDER BY LINE_NO ASC
              ) T1

    </select>

    <!-- RO 부품 목록수 조회 . -->
    <select id="selectRoPartsByConditionCnt" parameterType="TabInfoSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectRoPartsByConditionCnt] */

      SELECT COUNT(ITEM_CD) AS VALUE
        FROM SE_0160T
        <where>
            <if test='sDlrCd != null and sDlrCd != ""'>
                AND DLR_CD = #{sDlrCd}
            </if>
            <if test='sPreFixId != null and sPreFixId != ""'>
                AND PREFIX_ID = #{sPreFixId}
            </if>
            <if test='sDocNo != null and sDocNo != ""'>
                AND DOC_NO = #{sDocNo}
            </if>
            <if test='sGiQtyExist != null and sGiQtyExist != ""'>
                AND GI_QTY > 0
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND ITEM_CD = #{sItemCd}
            </if>
            <if test='sLineNo != null and sLineNo != 0'>
                AND LINE_NO = #{sLineNo}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "dlrCd"'>           DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "preFixId"'>        PREFIX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                        <when test='item.field == "docNo"'>           DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "roTp"'>            RO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                        <when test='item.field == "itemCd"'>          ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                        <when test='item.field == "itemPrc"'>         ITEM_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                        <when test='item.field == "itemQty"'>         ITEM_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                        <when test='item.field == "itemSalePrc"'>     ITEM_SALE_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "itemSaleAmt"'>     ITEM_SALE_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "calcUnitCd"'>      CALC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <when test='item.field == "calcUnitNm"'>      CALC_UNIT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <when test='item.field == "reqQty"'>          REQ_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                        <when test='item.field == "giQty"'>           GI_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "itemTotAmt"'>      ITEM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <otherwise>
                            DLR_CD ASC
                            ,DOC_NO DESC
                            ,LINE_NO ASC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                DLR_CD ASC
                ,DOC_NO DESC
                ,LINE_NO ASC
            </otherwise>
        </choose>
    </select>

    <select id="selectRoPartsByCondition" parameterType="TabInfoSearchVO" resultType="PwaPartVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectRoPartsByCondition] */

     SELECT DLR_CD                                 --딜러코드
           ,ITEM_CD                                --품목코드
           ,ITEM_NM                                --품목명
           ,NVL(ITEM_QTY,0 )AS REQ_QTY             --품목수량
           ,NVL(ITEM_SALE_PRC,0) AS ITEM_PRC            --품목단가
           ,NVL(CALC_UNIT_CD,'EA')AS SALE_UNIT_CD  --계산단위코드
           ,NVL(ITEM_PRC,0) AS SALE_PRC_AMT   --품목판매금액
           ,NVL(ITEM_TOT_AMT,0) AS ITEM_AMT        --품목합계금액
           ,CALC_UNIT_NM                           --계산단위명
           ,'N' AS CAU_ITEM_YN
           ,0   AS NPNP_MAX_AMT
           ,'N' AS NPNP_YN
           ,(
                SELECT
                    TB.PTUP_DUMP AS MARK_UP
                FROM(
                    SELECT
                        TRIM(T1.APCP_PART_NO) AS APCP_PART_NO
                        ,T1.APCP_APPLY_DATE
                        ,T1.APCP_PRICE_NAT_AMT
                    FROM PT_0216I T1
                    INNER JOIN(
                    SELECT
                        TRIM(APCP_PART_NO) AS APCP_PART_NO
                        ,MAX(APCP_APPLY_DATE) AS APCP_APPLY_DATE
                    FROM PT_0216I
                    GROUP BY APCP_PART_NO
                    ) T2 ON T1.APCP_PART_NO = T2.APCP_PART_NO AND T1.APCP_APPLY_DATE = T2.APCP_APPLY_DATE
                )TA LEFT JOIN (
                    SELECT
                        TRIM(PTUP_PART_NO) AS PTUP_PART_NO
                        ,MAX(PTUP_CDAT) AS PTUP_CDAT
                        ,MAX(PTUP_DUMP) AS PTUP_DUMP
                        ,'Y' AS MARKUP_USE_YN
                    FROM PT_0215I
                    GROUP BY PTUP_PART_NO
                )TB ON TA.APCP_PART_NO = TB.PTUP_PART_NO
                WHERE TA.APCP_PART_NO = A.ITEM_CD
            ) AS ITEM_MARKUP
        FROM SE_0160T A
        <where>
            <if test='sDlrCd != null and sDlrCd != ""'>
                AND DLR_CD = #{sDlrCd}
            </if>
            <if test='sPreFixId != null and sPreFixId != ""'>
                AND PREFIX_ID = #{sPreFixId}
            </if>
            <if test='sDocNo != null and sDocNo != ""'>
                AND DOC_NO = #{sDocNo}
            </if>
            <if test='sGiQtyExist != null and sGiQtyExist != ""'>
                AND GI_QTY > 0
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND ITEM_CD = #{sItemCd}
            </if>
            <if test='sLineNo != null and sLineNo != 0'>
                AND LINE_NO = #{sLineNo}
            </if>
        </where>
        ORDER BY
        <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "dlrCd"'>           DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "preFixId"'>        PREFIX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                        <when test='item.field == "docNo"'>           DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "roTp"'>            RO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                        <when test='item.field == "itemCd"'>          ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                        <when test='item.field == "itemPrc"'>         ITEM_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                        <when test='item.field == "itemQty"'>         ITEM_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                        <when test='item.field == "itemSalePrc"'>     ITEM_SALE_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "itemSaleAmt"'>     ITEM_SALE_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "calcUnitCd"'>      CALC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <when test='item.field == "calcUnitNm"'>      CALC_UNIT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <when test='item.field == "reqQty"'>          REQ_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                        <when test='item.field == "giQty"'>           GI_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                        <when test='item.field == "itemTotAmt"'>      ITEM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                        <otherwise>
                            DLR_CD ASC
                            ,DOC_NO DESC
                            ,LINE_NO ASC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                DLR_CD ASC
                ,DOC_NO DESC
                ,LINE_NO ASC
            </otherwise>
        </choose>
    </select>


    <!-- PWA 요청 MAX DOC NO-->
    <select id="selectPwaRequestMaxDocNoByCondition" parameterType="map" resultType="string" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectPwaRequestMaxDocNoByCondition] */

          SELECT NVL(MAX(PWA_DOC_NO),0) +1 AS  PWA_DOC_NO
            FROM SE_0730T
           WHERE DLR_CD = #{dlrCd}
    </select>

    <!-- PWA 승인 사용  -->
    <update id="updatePwaApproveNoInClaim" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.updatePwaApproveNoInClaim] */

        UPDATE SE_0730T                                       --PWA승인
          SET
               UPDT_USR_ID     = #{updtUsrId}                 --수정자ID
              ,UPDT_DT         = sysdate                      --수정일자
            <choose>
               <when test='pwaUseYn !=null and pwaUseYn !="" '>
                   <if test=' pwaUseYn == "Y" '>
                   ,RO_DOC_NO  = #{roDocNo}                   --RO일련번호
                   </if>
                   <if test=' pwaUseYn == "N" '>
                   ,RO_DOC_NO  = ''                           --RO일련번호
                   </if>
               </when>
               <otherwise>
                   ,RO_DOC_NO  = ''                           --RO일련번호
               </otherwise>
            </choose>
         WHERE 1 = 1
           AND DLR_CD          = #{dlrCd}                     --딜러코드
           AND VIN_NO          = #{vinNo}                     --차대번호
           AND PWA_APPROVE_NO  = #{pwaApproveNo}              --PWA 승인번호
    </update>


    <!-- PWA데이타 TEMP로 전송. : 프로시져  -->
    <insert id="updatePwaRequestRollBack" parameterType="PwaVO" statementType="CALLABLE">
        {CALL SP_SER_PWA_STAT_ROLLBACK_UPDATE(
              #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{vinNo, mode=IN, jdbcType=VARCHAR}
            , #{pwaDocNo, mode=IN, jdbcType=VARCHAR}
            , #{pwaStatCd, mode=IN, jdbcType=VARCHAR}
        )}
    </insert>

    <!-- PWA데이타 TEMP로 전송. : 프로시져  -->
    <insert id="insertPwaRequestToIf" parameterType="PwaVO" statementType="CALLABLE">
        {CALL SP_SER_PWA_REQ_INFO(
              #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{vinNo, mode=IN, jdbcType=VARCHAR}
            , #{pwaDocNo, mode=IN, jdbcType=VARCHAR}
        )}
    </insert>

</mapper>