<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ClaimInvoiceRecDAO_SqlMap.xml
    Description : 索赔发票收款SqlMap
    author lixinfei
    since 2021. 04. 12.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2021. 04. 12.  lixinfei             索赔发票收款SqlMap
-->

<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO">
    <!-- 结算主单查询 数量 -->
    <select id="selectClaimInvoiceRecSettlementByConditionCnt" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="long">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecSettlementByConditionCnt] */
        SELECT COUNT(1) AS VALUE
        FROM SE_0930T D         -- D 结算单主表
        LEFT JOIN SE_0960T A    -- A 结算单信息表
          ON A.DLR_CD = D.DLR_CD    --经销商代码
          AND A.INVC_NO = D.INVC_NO --索赔结算单信息
        <where>
                A.CANCEL_YN = 'N'      --只查询未被取消的结算单
            <if test='sInvcNo != null and sInvcNo != ""'>
                AND A.INVC_NO LIKE '%' || #{sInvcNo} || '%'
            </if>
            <if test='sPaymTp != null and sPaymTp != ""'>
                AND A.PAYM_TP = #{sPaymTp}
            </if>
            <if test='sInvcStartDt != null' >
                AND D.INVC_DT <![CDATA[>=]]> TRUNC(#{sInvcStartDt},'DD')    --报表结算年月start
            </if>
            <if test='sInvcEndDt != null' >
                AND D.INVC_DT <![CDATA[<]]> TRUNC(#{sInvcEndDt},'DD')     --报表结算年月end
            </if>
        </where>
    </select>
    
    <!-- 结算主单查询  -->
    <select id="selectClaimInvoiceRecSettlementByCondition" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="ClaimInvoiceRecSettlementVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecSettlementByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT 
                     A.DLR_CD              --经销商代码
	                ,A.INVC_NO             --索赔结算单信息
	                ,A.PAYM_TP             --汇款状态
	                ,A.RCV_CPLT_DT         --收款日期
	                ,D.INVC_DT             --结算报表年月
	                ,D.CONFIRM_TOT_AMT     --确定合计金额
	                ,D.DDCT_TOT_AMT        --扣减合计金额
	                ,D.INVC_CLAIM_TOT_AMT  --索赔合计金额（结算金额）
		        FROM SE_0930T D         -- D 结算单主表
		        LEFT JOIN SE_0960T A    -- A 结算单信息表
		          ON D.DLR_CD = A.DLR_CD    --经销商代码
		          AND D.INVC_NO = A.INVC_NO --索赔结算单信息
                <where>
                        A.CANCEL_YN = 'N'      --只查询未被取消的结算单
	                <if test='sInvcNo != null and sInvcNo != ""'>
		                AND A.INVC_NO LIKE '%' || #{sInvcNo} || '%'
		            </if>
		            <if test='sPaymTp != null and sPaymTp != ""'>
		                AND A.PAYM_TP = #{sPaymTp}
		            </if>
		            <if test='sInvcStartDt != null' >
		                AND D.INVC_DT <![CDATA[>=]]> TRUNC(#{sInvcStartDt},'DD')    --报表结算年月start
		            </if>
		            <if test='sInvcEndDt != null' >
		                AND D.INVC_DT <![CDATA[<]]> TRUNC(#{sInvcEndDt},'DD')     --报表结算年月end
		            </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "invcNo"'>            D.INVC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "paymTp"'>            A.PAYM_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "rcvCpltDt"'>         A.RCV_CPLT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "invcDt"'>            D.INVC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                <when test='item.field == "confirmTotAmt"'>    D.CONFIRM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "ddctTotAmt"'>        D.DDCT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "invcClaimTotAmt"'>  D.INVC_CLAIM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <otherwise>
                                A.INVC_NO
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                    A.INVC_NO
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>
            
    <!-- 结算单发票查询 数量。以SE_0930T结算单主表为准查询数据-->
    <select id="selectClaimInvoiceRecByConditionCnt" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="long">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecByConditionCnt] */
        SELECT COUNT(1) AS VALUE
        FROM SA_0502T A         -- A 发票信息表
          RIGHT JOIN SE_0930T D  -- D 结算单主表
             ON A.DLR_CD = D.DLR_CD
            AND A.SETTLEMENT_NO = D.INVC_NO  --索赔结算单信息
          LEFT JOIN SE_0960T C  -- C 结算单信息表
             ON A.DLR_CD = C.DLR_CD
            AND A.SETTLEMENT_NO = C.INVC_NO  --索赔结算单信息
         WHERE
             A.DLR_CD = #{sDlrCd}
         AND A.SETTLEMENT_NO = #{sInvcNo}
    </select>
        
    <!-- 结算单发票查询。以SE_0930T结算单主表为准查询数据   -->
    <select id="selectClaimInvoiceRecByCondition" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="ClaimInvoiceRecVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT 
                       A.RECEIPT_NO         --发票号
                      ,A.RECEIPT_CD         --发票代码
                      ,A.BUY_NM             --发票抬头
                      ,A.TAXPAYER_ID_CD     --纳税人识别号
                      ,A.SCAN_SUM_AMT       --发票金额
                      ,A.REG_DT             --发票日期
                      ,A.REMARK             --备注
                  FROM SA_0502T A       -- A 发票信息表
                  RIGHT JOIN SE_0930T D  -- D 结算单主表
                     ON A.DLR_CD = D.DLR_CD
                    AND A.SETTLEMENT_NO = D.INVC_NO --索赔结算单信息字段
                  LEFT JOIN SE_0960T C  -- C 结算单信息表
                     ON A.DLR_CD = C.DLR_CD
                    AND A.SETTLEMENT_NO = C.INVC_NO  --索赔结算单信息字段
                  WHERE
                       A.DLR_CD = #{sDlrCd}
                   AND A.SETTLEMENT_NO = #{sInvcNo}
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "receiptNo"'>     A.RECEIPT_NO  <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "receiptCd"'>     A.RECEIPT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                <when test='item.field == "buyNm"'>          A.BUY_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "taxpayerIdCd"'>  A.TAXPAYER_ID_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <when test='item.field == "scanSumAmt"'>    A.SCAN_SUM_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "regDt"'>          A.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <otherwise>
                                A.RECEIPT_NO
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                    A.RECEIPT_NO
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>
    
    <!-- 查询单条索赔主表汇款状态，返回当前索赔单对象 -->
    <select id="selectClaimInvoiceRecSettlementPaymTpByCondition" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="ClaimInvoiceRecSettlementISVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecSettlementPaymTpByCondition] */
         SELECT 
             C.DLR_CD          --经销商ID  
			,C.INVC_NO         --索赔结算单信息 
			,C.RECEIPT_TP      --开票状态
			,C.EXPS_CMP_NM     --快递公司 
			,C.TRSF_TP         --快递状态  
			,C.TRSF_NO         --快递单号   
			,C.REMARK          --快递备注
			,C.SENDER_NM       --寄件人
			,C.RECIP_NM        --收件人 
			,C.SENDER_TELNO    --寄件人联系电话 
			,C.RECIP_TELNO     --收件人联系电话 
			,C.SENDER_ADDR     --寄件人地址
			,C.RECIP_ADDR      --收件人地址
			,C.PAYM_TP         --汇(收)款状态
			,C.PAYM_DT         --汇款日期
			,C.RCV_CPLT_DT     --收款日期 
			,C.FAIL_CNT        --退票次数  
			,C.FAIL_MSG        --退票原因    
			,C.FAIL_REMARK     --退票备注
			,C.REG_DT          --录入日期
			,C.REG_USR_ID      --录入人 
         FROM SE_0960T C        -- C 结算单信息表
         RIGHT JOIN SE_0930T D  -- D 结算单主表
            ON C.DLR_CD = D.DLR_CD    
           AND C.INVC_NO = D.INVC_NO  --索赔结算单信息字段
         WHERE C.DLR_CD = #{sDlrCd} 
           AND C.INVC_NO = #{sInvcNo}
           AND C.CANCEL_YN = 'N'      --只查询未被取消的结算单
    </select>
    
    <!-- 更新SE_0960T索赔主表收款状态操作 -->
    <update id="updateClaimInvoiceRecPaymTp" parameterType="ClaimInvoiceRecSettlementVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.updateClaimInvoiceByInvcNo] */
        UPDATE SE_0960T
          SET PAYM_TP = #{paymTp}          --收款状态
            , RCV_CPLT_DT = SYSDATE        --收款时间
            , UPDT_USR_ID = #{updtUsrId}   --更新用户
            , UPDT_DT = SYSDATE            --更新时间
         WHERE DLR_CD = #{dlrCd} 
          AND INVC_NO = #{invcNo}
    </update>
    
   <!-- 添加一条主单记录到接口表SE_0960IS，数据取自SE_0960T -->
    <insert id="insertClaimInvoiceRecSettlementToInterfaceTable" parameterType="ClaimInvoiceRecSettlementISVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.insertClaimInvoiceRecSettlementToInterfaceTable] */
      INSERT INTO SE_0960IS(
             BAT_ID          --自增序列ID
            ,DLR_CD          --经销商ID  
            ,INVC_NO         --索赔结算单信息 
            ,RECEIPT_TP      --开票状态
            ,EXPS_CMP_NM     --快递公司 
            ,TRSF_TP         --快递状态  
            ,TRSF_NO         --快递单号   
            ,REMARK          --快递备注
            ,SENDER_NM       --寄件人
            ,RECIP_NM        --收件人 
            ,SENDER_TELNO    --寄件人联系电话 
            ,RECIP_TELNO     --收件人联系电话 
            ,SENDER_ADDR     --寄件人地址
            ,RECIP_ADDR      --收件人地址
            ,PAYM_TP         --汇(收)款状态
            ,PAYM_DT         --汇款日期
            ,RCV_CPLT_DT     --收款日期 
            ,FAIL_CNT        --退票次数  
            ,FAIL_MSG        --退票原因    
            ,FAIL_REMARK     --退票备注
            ,REG_DT          --录入日期
            ,REG_USR_ID      --录入人 
            ,IFRESULT        --发送状态（默认'N'）
            ,CREATEDATE      --创建日期字符串
         )VALUES(
            SEQ_SE_0960IS.NEXTVAL
            ,#{dlrCd}
            ,#{invcNo}
            ,#{receiptTp}
            ,#{expsCmpNm}
            ,#{trsfTp}
            ,#{trsfNo}
            ,#{remark}
            ,#{senderNm}
            ,#{recipNm}
            ,#{senderTelno}
            ,#{recipTelno}
            ,#{senderAddr}
            ,#{recipAddr}
            ,#{paymTp}
            ,#{paymDt}
            ,#{rcvCpltDt}
            ,#{failCnt}
            ,#{failMsg}
            ,#{failRemark}
            ,#{regDt}
            ,#{regUsrId}
            ,'N'
            ,to_char(sysdate,'yyyymmddhh24miss')
         )
    </insert>
        
        
    <!-- Excel下载 查询。以SE_0930T结算单主表为准查询数据 -->
    <select id="selectClaimInvoiceRecByConditionForExcelDownload" parameterType="ClaimInvoiceRecSettlementSearchVO" resultType="ClaimInvoiceRecExcelDownloadVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRecDAO.selectClaimInvoiceRecByCondition] */
		SELECT 
			 C.INVC_NO            --索赔主单编码（结算报表号）
			,A.RECEIPT_NO         --发票号
			,A.RECEIPT_CD         --发票代码
			,A.BUY_NM             --发票抬头
			,A.TAXPAYER_ID_CD     --纳税人识别号
			,D.CONFIRM_TOT_AMT    --确定合计金额
			,D.DDCT_TOT_AMT       --扣减合计金额
			,D.INVC_CLAIM_TOT_AMT --索赔合计金额（结算金额）
			,A.SCAN_SUM_AMT       --发票金额
			,A.REG_DT             --发票日期
			,A.REMARK             --备注
		  FROM SA_0502T A       -- A 发票信息表
		  RIGHT JOIN SE_0930T D  -- D 结算单主表
		     ON A.DLR_CD = D.DLR_CD
		    AND A.SETTLEMENT_NO = D.INVC_NO --索赔结算单信息字段
		  LEFT JOIN SE_0960T C  -- C 结算单信息表
		     ON A.DLR_CD = C.DLR_CD
		    AND A.SETTLEMENT_NO = C.INVC_NO  --索赔结算单信息字段
		   <where>
             <if test='sInvcNo != null and sInvcNo != ""'>
                 AND A.SETTLEMENT_NO LIKE '%' || #{sInvcNo} || '%'
             </if>
             <if test='sPaymTp != null and sPaymTp != ""'>
                 AND C.PAYM_TP = #{sPaymTp}
             </if>
             <if test='sInvcStartDt != null' >
                 AND D.INVC_DT <![CDATA[>=]]> TRUNC(#{sInvcStartDt},'DD')    --报表结算年月start
             </if>
             <if test='sInvcEndDt != null' >
                 AND D.INVC_DT <![CDATA[<]]> TRUNC(#{sInvcEndDt},'DD')     --报表结算年月end
             </if>
	        </where>
		ORDER BY 
		  C.INVC_NO
    </select>
    
    
    
</mapper>