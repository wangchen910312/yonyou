<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : CalculateDAO_SqlMap.xml
    Description : 정산에 관한 데이터처리
    author KyungMok Kim
    since 2016. 04. 18.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 18.  KyungMok Kim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.ser.cal.service.dao.CalculateDAO">

    <!-- 정산 등록. -->
    <insert id="insertCalculate" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.insertCalculate] */
        INSERT INTO SE_0500T
        (
            DLR_CD                          --딜러코드
            ,CALC_DOC_NO                     --정산문서번호
            ,RO_TP                           --RO유형
            ,RO_DOC_NO                       --RO문서번호
            ,RO_GRP_NO                       --RO그룹번호
            ,RESV_DOC_NO                     --예약문서번호
            ,DIAG_DOC_NO                     --사전점검번호
            ,PRE_CHK_DT                      --사전점검일자
            ,BASE_RO_NO                      --원RO번호
            ,INC_REQ_NO                      --보험신청번호
            ,VIN_NO                          --차대번호
            ,CAR_REG_NO                      --차량등록번호
            ,ENGIN_NO                 --엔진시리얼번호
            ,CAR_OWNER_ID                      --차량소유자ID
            ,CAR_OWNER_NM                      --차량소유자명
            ,DRIVER_ID                       --운전자ID
            ,DRIVER_NM                       --운전자명
            ,RESV_DT                         --예약일자
            ,RUN_DIST_VAL                    --주행거리값
            ,LBR_CALC_AMT                    --공임정산금액
            ,LBR_DC_RATE                     --공임할인율
            ,LBR_DC_AMT                      --공임할인금액
            ,LBR_BM_POINT_USE_AMT            --공임BM포인트사용금액
            ,LBR_POINT_USE_AMT               --공임포인트사용금액
            ,LBR_ETC_DC_AMT                  --공임기타할인금액
            ,LBR_CALC_SUM_AMT                --공임정산합계금액
            ,PAR_CALC_AMT                    --부품정산금액
            ,PAR_DC_RATE                     --부품할인율
            ,PAR_DC_AMT                      --부품할인금액
            ,PAR_BM_POINT_USE_AMT            --부품BM포인트사용금액
            ,PAR_POINT_USE_AMT               --부품포인트사용금액
            ,PAR_ETC_DC_AMT                  --부품기타할인금액
            ,PAR_CALC_SUM_AMT                --부품정산합계금액
            ,ETC_CALC_AMT                    --기타정산금액
            ,ETC_DC_RATE                     --기타할인율
            ,ETC_DC_AMT                      --기타할인금액
            ,ETC_BM_POINT_USE_AMT            --기타BM포인트사용금액
            ,ETC_POINT_USE_AMT               --기타포인트사용금액
            ,ETC_OTHER_DC_AMT                --기타다른할인금액
            ,ETC_CALC_SUM_AMT                --기타정산합계금액
            ,CALC_TOT_AMT                    --정산총금액
            ,DC_TOT_RATE                     --할인총율
            ,DC_TOT_AMT                      --할인총금액
            ,BM_POINT_TOT_AMT                --BM포인트총금액
            ,POINT_TOT_AMT                   --포인트총금액
            ,ETC_TOT_AMT                     --기타총금액
            ,LAST_CALC_TOT_AMT               --최종정산총금액
            ,CALC_STAT_CD                    --정산상태코드
            ,CALC_REMARK                     --정산비고
            ,OPN_REMARK                      --의견비고
            ,VSIT_CANC_CAU_CONT              --방문취소원인내용
            ,CALC_CANC_YN                    --정산취소여부
            ,CALC_CANC_DT                    --정산취소일자
            ,CALC_CANC_ID                    --정산취소ID
            ,VSIT_CAR_RECEIVE_DT             --방문차량수량일자
            ,VSIT_CAR_RECEIVE_IF_NM          --방문차량수령연계인명
            ,VSIT_CAR_RECEIVE_CTNO_NO        --방문차량수령연락처번호
            ,VSIT_CAR_RECEIVE_ADDR_NM        --방문차량수령주소명
            ,CAR_RECEIVE_DT                  --차량수령일자
            ,VSIT_DL_IF_NM                   --방문인도연계인명
            ,VSIT_DL_CTNO_NO                 --방문인도연락처번호
            ,VSIT_DL_ADDR_NM                 --방문인도주소명
            ,VSIT_DT                         --방문일자
            ,VSIT_IF_NM                      --방문연계인명
            ,VSIT_CTNO_NO                    --방문연락처번호
            ,VSIT_ADDR_NM                    --방문주소명
            ,REG_USR_ID                      --등록자ID
            ,REG_DT                          --등록일자
            ,EXPC_CHK_DT                     --예정점검일자
            ,EXPC_CHK_RUN_DIST_VAL           --예정점검주행거리값
            ,MAIN_CTNO_TP                    --메인연락유형
            ,MAIN_CTNO_DT_TP                 --예정점검일자
            ,CAU_CD1                  --원인코드1
            ,CAU_NM1                  --원인명1
            ,PHEN_CD1                 --현상코드1
            ,PHEN_NM1                 --현상명1
            ,CAU_CD2                  --원인코드2
            ,CAU_NM2                  --원인명2
            ,PHEN_CD2                 --현상코드2
            ,PHEN_NM2                 --현상명2
            ,SA_ID
            ,SA_NM
            ,SER_PAR_DSTIN_CD
            ,CUST_TP
            ,ETC_DC_CD
            ,ETC_DC_SEQ
            ,LBR_BM_CUPN_USE_AMT
            ,PAR_BM_CUPN_USE_AMT
            ,ETC_BM_CUPN_USE_AMT
            ,BM_CUPN_TOT_AMT
            ,LAN_BIN_CARD_NO          	--卡券编号
            ,LAN_BIN_CARD_TYPE  		--卡券类型
			,LAN_BIN_USE_NOTICE  		--使用须知
			,LAN_BIN_CARD_NAME  		--卡券名称
			,LAN_BIN_CARD_AMOUNT  		--卡券面额
			,LAN_BIN_COUPON_ClAIM  		--结算金额即索赔金额
			,LAN_BIN_COUPON_ADJU  		--调整金额
			,CARD_ADJUST  				--调整项
			,LAN_BIN_CARD_EFFE_DT 		--截止日期
			,COUPON_WRITE  				--卡券是否已核销
			,COUPON_VOID 				--卡券是否已反核销
        )
        VALUES
        (
            #{dlrCd}                          --딜러코드
            ,#{calcDocNo}                      --정산문서번호
            ,#{roTp}                           --RO유형
            ,#{roDocNo}                        --RO문서번호
            ,#{roGrpNo}                        --RO그룹번호
            ,#{resvDocNo}                      --예약문서번호
            ,#{diagDocNo}                      --사전점검번호
            ,#{preChkDt}                       --사전점검일자
            ,#{baseRoNo}                       --원RO번호
            ,#{incReqNo}                       --보험신청번호
            ,#{vinNo}                          --차대번호
            ,#{carRegNo}                       --차량등록번호
            ,#{enginNo}                  --엔진시리얼번호
            ,#{carOwnerId}                       --차량소유자ID
            ,#{carOwnerNm}                       --차량소유자명
            ,#{driverId}                       --운전자ID
            ,#{driverNm}                       --운전자명
            ,#{resvDt}                         --예약일자
            ,#{runDistVal}                     --주행거리값
            ,#{lbrCalcAmt}                     --공임정산금액
            ,#{lbrDcRate}                      --공임할인율
            ,#{lbrDcAmt}                       --공임할인금액
            ,#{lbrBmPointUseAmt}               --공임BM포인트사용금액
            ,#{lbrPointUseAmt}                 --공임포인트사용금액
            ,#{lbrEtcDcAmt}                    --공임기타할인금액
            ,#{lbrCalcSumAmt}                  --공임정산합계금액
            ,#{parCalcAmt}                     --부품정산금액
            ,#{parDcRate}                      --부품할인율
            ,#{parDcAmt}                       --부품할인금액
            ,#{parBmPointUseAmt}               --부품BM포인트사용금액
            ,#{parPointUseAmt}                 --부품포인트사용금액
            ,#{parEtcDcAmt}                    --부품기타할인금액
            ,#{parCalcSumAmt}                  --부품정산합계금액
            ,#{etcCalcAmt}                     --기타정산금액
            ,#{etcDcRate}                      --기타할인율
            ,#{etcDcAmt}                       --기타할인금액
            ,#{etcBmPointUseAmt}               --기타BM포인트사용금액
            ,#{etcPointUseAmt}                 --기타포인트사용금액
            ,#{etcOtherDcAmt}                  --기타다른할인금액
            ,#{etcCalcSumAmt}                  --기타정산합계금액
            ,#{calcTotAmt}                     --정산총금액
            ,#{dcTotRate}                      --할인총율
            ,#{dcTotAmt}                       --할인총금액
            ,#{bmPointTotAmt}                  --BM포인트총금액
            ,#{pointTotAmt}                    --포인트총금액
            ,#{etcTotAmt}                      --기타총금액
            ,#{lastCalcTotAmt}                 --최종정산총금액
            ,#{calcStatCd}                     --정산상태코드
            ,#{calcRemark}                     --정산비고
            ,#{opnRemark}                      --의견비고
            ,#{vsitCancCauCont}                --방문취소원인내용
            ,'N'                               --정산취소여부
            ,#{calcCancDt}                     --정산취소일자
            ,#{calcCancId}                     --정산취소ID
            ,#{vsitCarReceiveDt}               --방문차량수량일자
            ,#{vsitCarReceiveIfNm}             --방문차량수령연계인명
            ,#{vsitCarReceiveCtnoNo}           --방문차량수령연락처번호
            ,#{vsitCarReceiveAddrNm}           --방문차량수령주소명
            ,#{carReceiveDt}                   --차량수령일자
            ,#{vsitDlIfNm}                     --방문인도연계인명
            ,#{vsitDlCtnoNo}                   --방문인도연락처번호
            ,#{vsitDlAddrNm}                   --방문인도주소명
            ,#{vsitDt}                         --방문일자
            ,#{vsitIfNm}                       --방문연계인명
            ,#{vsitCtnoNo}                     --방문연락처번호
            ,#{vsitAddrNm}                     --방문주소명
            ,#{regUsrId}                       --등록자ID
            ,SYSDATE                           --등록일자
            ,#{expcChkDt}                      --예정점검일자
            ,#{expcChkRunDistVal}                 --정비예정 주행거리
            ,#{mainCtnoTp}                     --메인연락방식
            ,#{mainCtnoDtTp}                     --메인연락시간
            ,#{cauCd1}                  --원인코드1
            ,#{cauNm1}                  --원인명1
            ,#{phenCd1}                 --현상코드1
            ,#{phenNm1}                 --현상명1
            ,#{cauCd2}                  --원인코드2
            ,#{cauNm2}                  --원인명2
            ,#{phenCd2}                 -- 현상코드2
            ,#{phenNm2}                 -- 현상명2
            ,#{saId}
            ,#{saNm}
            ,#{serParDstinCd}
            ,#{custTp}
            ,#{etcDcCd}
            ,#{etcDcSeq}
            ,#{lbrBmCupnUseAmt}
            ,#{parBmCupnUseAmt}
            ,#{etcBmCupnUseAmt}
            ,#{bmCupnTotAmt}
            ,#{cardNo}                         --卡券编号
            ,#{cardTp}                         --卡券类型
            ,#{cardUseNoti}                    --使用须知
            ,#{cardNm}                         --卡券名称
            ,#{cardDeno}                   	   --卡券面额
            ,#{claimAmo}                       --结算金额即索赔金额
            ,#{cupnChangeAmt}                  --调整金额
            ,#{cardAdjust}                     --调整项
			,#{expirationDate}                 --截止日期
			,#{couponWrite}                    --卡券是否已核销
			,#{couponVoid}                     --卡券是否已反核销
        )
    </insert>
     <!-- 更新卡券信息 贾明 2020-6-3 -->
    <update id="updateCalculateCardInfo" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updateCalculateCardInfo] */
        UPDATE SE_0500T SET
          LAN_BIN_CARD_NO = ''
         ,LAN_BIN_CARD_TYPE = ''
         ,LAN_BIN_USE_NOTICE = ''
         ,LAN_BIN_CARD_NAME = ''
         ,LAN_BIN_CARD_AMOUNT = ''
         ,LAN_BIN_COUPON_ClAIM = ''
         ,LAN_BIN_COUPON_ADJU = ''
         ,CARD_ADJUST  = ''
         ,LAN_BIN_CARD_EFFE_DT = ''
         ,COUPON_WRITE = ''
         ,COUPON_VOID  = 'Y'
       WHERE CALC_DOC_NO  = #{calcDocNo}
          AND DLR_CD      = #{dlrCd} 
          AND RO_TP       = #{roTp} 
    </update>
    <!-- 정산  수정. -->
    <update id="updateCalculate" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updateCalculate] */
        UPDATE SE_0500T SET
             INC_REQ_NO               = #{incReqNo}                       --보험신청번호
            ,RUN_DIST_VAL             = #{runDistVal}                     --주행거리값
            ,LBR_CALC_AMT             = #{lbrCalcAmt}                     --공임정산금액
            ,LBR_DC_RATE              = #{lbrDcRate}                      --공임할인율
            ,LBR_DC_AMT               = #{lbrDcAmt}                       --공임할인금액
            ,LBR_BM_POINT_USE_AMT     = #{lbrBmPointUseAmt}               --공임BM포인트사용금액
            ,LBR_POINT_USE_AMT        = #{lbrPointUseAmt}                 --공임포인트사용금액
            ,LBR_ETC_DC_AMT           = #{lbrEtcDcAmt}                    --공임기타할인금액
            ,LBR_CALC_SUM_AMT         = #{lbrCalcSumAmt}                  --공임정산합계금액
            ,PAR_CALC_AMT             = #{parCalcAmt}                     --부품정산금액
            ,PAR_DC_RATE              = #{parDcRate}                      --부품할인율
            ,PAR_DC_AMT               = #{parDcAmt}                       --부품할인금액
            ,PAR_BM_POINT_USE_AMT     = #{parBmPointUseAmt}               --부품BM포인트사용금액
            ,PAR_POINT_USE_AMT        = #{parPointUseAmt}                 --부품포인트사용금액
            ,PAR_ETC_DC_AMT           = #{parEtcDcAmt}                    --부품기타할인금액
            ,PAR_CALC_SUM_AMT         = #{parCalcSumAmt}                  --부품정산합계금액
            ,ETC_CALC_AMT             = #{etcCalcAmt}                     --기타정산금액
            ,ETC_DC_RATE              = #{etcDcRate}                      --기타할인율
            ,ETC_DC_AMT               = #{etcDcAmt}                       --기타할인금액
            ,ETC_BM_POINT_USE_AMT     = #{etcBmPointUseAmt}               --기타BM포인트사용금액
            ,ETC_POINT_USE_AMT        = #{etcPointUseAmt}                 --기타포인트사용금액
            ,ETC_OTHER_DC_AMT         = #{etcOtherDcAmt}                  --기타다른할인금액
            ,ETC_CALC_SUM_AMT         = #{etcCalcSumAmt}                  --기타정산합계금액
            ,CALC_TOT_AMT             = #{calcTotAmt}                     --정산총금액
            ,DC_TOT_RATE              = #{dcTotRate}                      --할인총율
            ,DC_TOT_AMT               = #{dcTotAmt}                       --할인총금액
            ,BM_POINT_TOT_AMT         = #{bmPointTotAmt}                  --BM포인트총금액
            ,POINT_TOT_AMT            = #{pointTotAmt}                    --포인트총금액
            ,ETC_TOT_AMT              = #{etcTotAmt}                      --기타총금액
            ,LAST_CALC_TOT_AMT        = #{lastCalcTotAmt}                 --최종정산총금액
            ,CALC_DT                  = CASE WHEN #{calcStatCd} = '00' THEN SYSDATE
                                             ELSE NULL END                --정산일자
            ,CALC_STAT_CD             = #{calcStatCd}                     --정산상태코드
            ,CALC_REMARK              = #{calcRemark}                     --정산비고
            ,OPN_REMARK               = #{opnRemark}                      --의견비고
            ,VSIT_CANC_CAU_CONT       = #{vsitCancCauCont}                --방문취소원인내용
            ,CALC_CANC_DT             = #{calcCancDt}                     --정산취소일자
            ,CALC_CANC_ID             = #{calcCancId}                     --정산취소ID
            ,VSIT_CAR_RECEIVE_DT      = #{vsitCarReceiveDt}               --방문차량수량일자
            ,VSIT_CAR_RECEIVE_IF_NM   = #{vsitCarReceiveIfNm}             --방문차량수령연계인명
            ,VSIT_CAR_RECEIVE_CTNO_NO = #{vsitCarReceiveCtnoNo}           --방문차량수령연락처번호
            ,VSIT_CAR_RECEIVE_ADDR_NM = #{vsitCarReceiveAddrNm}           --방문차량수령주소명
            ,CAR_RECEIVE_DT           = #{carReceiveDt}                   --차량수령일자
            ,VSIT_DL_IF_NM            = #{vsitDlIfNm}                     --방문인도연계인명
            ,VSIT_DL_CTNO_NO          = #{vsitDlCtnoNo}                   --방문인도연락처번호
            ,VSIT_DL_ADDR_NM          = #{vsitDlAddrNm}                   --방문인도주소명
            ,VSIT_DT                  = #{vsitDt}                         --방문일자
            ,VSIT_IF_NM               = #{vsitIfNm}                       --방문연계인명
            ,VSIT_CTNO_NO             = #{vsitCtnoNo}                     --방문연락처번호
            ,VSIT_ADDR_NM             = #{vsitAddrNm}                     --방문주소명
            ,UPDT_USR_ID              = #{updtUsrId}                      --수정자ID
            ,UPDT_DT                  = SYSDATE                           --수정일자
            ,EXPC_CHK_DT              = #{expcChkDt}                      --수정자ID
            ,EXPC_CHK_RUN_DIST_VAL    = #{expcChkRunDistVal}                      --수정자ID
            ,MAIN_CTNO_TP             = #{mainCtnoTp}                      --수정자ID
            ,MAIN_CTNO_DT_TP          = #{mainCtnoDtTp}                      --수정자ID
            ,CAU_CD1                  = #{cauCd1}
            ,CAU_NM1                  = #{cauNm1}
            ,PHEN_CD1                 = #{phenCd1}
            ,PHEN_NM1                 = #{phenNm1}
            ,CAU_CD2                  = #{cauCd2}
            ,CAU_NM2                  = #{cauNm2}
            ,PHEN_CD2                 = #{phenCd2}
            ,PHEN_NM2                 = #{phenNm2}
            ,SER_PAR_DSTIN_CD         = #{serParDstinCd}
            ,CUST_TP                  = #{custTp}
            ,ETC_DC_CD                = #{etcDcCd}
            ,ETC_DC_SEQ               = #{etcDcSeq}
            ,CALC_COMP_USR_ID         = #{calcCompUsrId}
            ,CALC_COMP_USR_NM         = #{calcCompUsrNm}
            ,LBR_BM_CUPN_USE_AMT      = #{lbrBmCupnUseAmt}
            ,PAR_BM_CUPN_USE_AMT      = #{parBmCupnUseAmt}
            ,ETC_BM_CUPN_USE_AMT      = #{etcBmCupnUseAmt}
            ,BM_CUPN_TOT_AMT          = #{bmCupnTotAmt}
            ,LAN_BIN_CARD_NO          = #{cardNo}	   			--卡券编号
            ,LAN_BIN_CARD_TYPE  	  = #{cardTp}  				--卡券类型
			,LAN_BIN_USE_NOTICE  	  = #{cardUseNoti}  		--使用须知
			,LAN_BIN_CARD_NAME        = #{cardNm} 				--卡券名称
			,LAN_BIN_CARD_AMOUNT  	  = #{cardDeno}  			--卡券面额
			,LAN_BIN_COUPON_ClAIM     = #{claimAmo}				--结算金额即索赔金额
			,LAN_BIN_COUPON_ADJU  	  = #{cupnChangeAmt}		--调整金额
			,CARD_ADJUST  			  = #{cardAdjust}			--调整项
			,LAN_BIN_CARD_EFFE_DT 	  = #{expirationDate}		--截止日期
			,COUPON_WRITE  			  = #{couponWrite}			--卡券是否已核销
			,COUPON_VOID 			  = #{couponVoid}			--卡券是否已反核销
        WHERE CALC_DOC_NO = #{calcDocNo}
          AND DLR_CD      = #{dlrCd} --딜러코드
          AND RO_TP       = #{roTp}  --RO유형

    </update>

    <!-- 정산  출력 일자 수정. -->
    <update id="updateCalculatePrint" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updateCalculatePrint] */
        UPDATE SE_0500T SET
               CALC_PRINT_DT = SYSDATE
         WHERE CALC_DOC_NO = #{calcDocNo}
           AND DLR_CD      = #{dlrCd} --딜러코드
           AND RO_TP       = #{roTp}  --RO유형

    </update>
    <!-- 정산  취소. -->
    <update id="cancelCalculate" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.cancelCalculate] */
        UPDATE SE_0500T SET
               CALC_CANC_YN             = 'Y'
              ,CALC_CANC_DT             = SYSDATE
              ,CALC_CANC_ID             = #{calcCancId}
              ,CALC_CANC_REASON_CONT    = #{calcCancReasonCont}
              ,CALC_CANC_REASON_CD      = #{calcCancReasonCd}
              ,UPDT_USR_ID              = #{calcCancId}                     --수정자ID
              ,UPDT_DT                  = SYSDATE                           --수정일자
              ,LAN_BIN_CARD_NO          = ''                             --结算取消时进行 贾明 2020-6-5 start
			  ,LAN_BIN_CARD_TYPE        = ''
			  ,LAN_BIN_USE_NOTICE       = ''
			  ,LAN_BIN_CARD_NAME        = ''
			  ,LAN_BIN_CARD_AMOUNT      = ''
			  ,LAN_BIN_COUPON_CLAIM     = ''
			  ,LAN_BIN_COUPON_ADJU      = ''
			  ,CARD_ADJUST              = ''
			  ,LAN_BIN_CARD_EFFE_DT     = null
			  ,COUPON_WRITE             = ''
			  ,COUPON_VOID              = 'Y'                             --结算取消时进行 贾明 2020-6-5 start
         WHERE CALC_DOC_NO = #{calcDocNo}
           AND DLR_CD      = #{dlrCd} --딜러코드
           AND RO_TP       = #{roTp}  --RO유형

    </update>

    <!-- 정산 삭제. -->
    <delete id="deleteCalculate" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculatePartDAO.deleteCalculatePart] */
        DELETE FROM SE_0500T
        WHERE CALC_DOC_NO = #{calcDocNo}
    </delete>

    <!-- 정산 목록 조회. -->
    <select id="selectCalculateByCondition" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.*
                      ,B.RO_DT
                      ,B.RO_STAT_CD
                      ,B.GOODWILL_YN
                      ,B.PDI_YN
                      ,(SELECT CAR_ID
                          FROM SA_0121T
                         WHERE VIN_NO = A.VIN_NO
                          AND ROWNUM = 1
                       ) AS CAR_ID
                      ,(SELECT CAR_RUN_DIST_VAL FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CAR_RUN_DIST_VAL
                      ,(SELECT FN_GET_CARLINE_NM(CARLINE_CD) AS CARLINE_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CARLINE_NM
                      ,(SELECT FN_GET_MODEL_NM(MODEL_CD) AS MODEL_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS MODEL_NM
                      ,( SELECT RCV_DOC_NO
                           FROM SE_0550T
                          WHERE DLR_CD      = A.DLR_CD
                            AND CALC_DOC_NO = A.CALC_DOC_NO
                            AND ROWNUM = 1
                        )AS RCV_DOC_NO
                       ,ROW_NUMBER() OVER(PARTITION BY A.DLR_CD , A.RO_DOC_NO , A.CALC_DOC_NO ORDER BY A.CALC_DOC_NO) AS RN
                  FROM SE_0500T A
                INNER JOIN SE_0300T B
                 ON A.RO_DOC_NO = B.RO_DOC_NO
                AND A.DLR_CD    = B.DLR_CD
                LEFT OUTER JOIN SE_0550T C
                 ON A.RO_DOC_NO = C.RO_DOC_NO
                AND A.DLR_CD    = C.DLR_CD
                AND A.CALC_DOC_NO = C.CALC_DOC_NO
                WHERE 1=1
                <if test='sRcvStatCd != null and sRcvStatCd != ""'>
                    AND C.RCV_STAT_CD = #{sRcvStatCd}
                </if>
                <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                    AND A.CALC_STAT_CD = #{sCalcStatCd}
                </if>
                <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                    AND A.CALC_CANC_YN = #{sCalcCancYn}
                </if>
                <if test='sRoStatCd != null and sRoStatCd != ""'>
                    AND B.RO_STAT_CD = #{sRoStatCd}
                </if>
                <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                    AND A.CALC_DOC_NO = #{sCalcDocNo}
                </if>
                <if test='sRoDocNo != null and sRoDocNo != ""'>
                    AND A.RO_DOC_NO = #{sRoDocNo}
                </if>
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}
                </if>
                <if test='sCarRegNo != null and sCarRegNo != ""'>
                    AND A.CAR_REG_NO = #{sCarRegNo}
                </if>
                <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO = #{sVinNo}
                </if>
                <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                    AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                </if>
                <if test='sDriverNm != null and sDriverNm != ""'>
                    AND A.DRIVER_NM LIKE  '%'|| #{sDriverNm}||'%'
                </if>
                <if test='sCalcFromDt != null'>
                    AND A.REG_DT <![CDATA[>=]]> #{sCalcFromDt}
                </if>
                <if test='sCalcToDt != null'>
                    AND A.REG_DT <![CDATA[<=]]> #{sCalcToDt} + 1
                </if>
                <if test='sRoFromDt != null'>
                    AND B.RO_DT <![CDATA[>=]]> #{sRoFromDt}
                </if>
                <if test='sRoToDt != null'>
                    AND B.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
                </if>
                <if test='sRoTp != null and sRoTp != ""'>
                    AND A.RO_TP =  #{sRoTp}
                </if>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "calDocNo"'>                   A.CALC_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "roDocNo"'>                    A.RO_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "vinNo"'>                      A.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                     </when>
                                <when test='item.field == "carRegNo"'>                   A.CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "driverId"'>                   A.DRIVER_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "driverNm"'>                   A.DRIVER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "calcDt"'>                     A.CALC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                    </when>
                                <otherwise>
                                ,A.CALC_DOC_NO DESC
                                ,A.DLR_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                    A.CALC_DOC_NO DESC
                    ,A.DLR_CD ASC
                    </otherwise>
                </choose>
            ) T1
            WHERE RN = 1
            <if test='firstIndex != -1 and lastIndex != -1'>
              AND ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 정산 목록수를 조회. -->
    <select id="selectCalculateByConditionCnt" parameterType="CalculateSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.selectCalculateByConditionCnt] */

      SELECT COUNT(CALC_DOC_NO) AS VALUE
        FROM (
        SELECT A.CALC_DOC_NO
              ,ROW_NUMBER() OVER(PARTITION BY A.DLR_CD , A.RO_DOC_NO , A.CALC_DOC_NO ORDER BY A.CALC_DOC_NO) AS RN
         FROM SE_0500T A
        INNER JOIN SE_0300T B
         ON A.RO_DOC_NO = B.RO_DOC_NO
        AND A.DLR_CD    = B.DLR_CD
        LEFT OUTER JOIN SE_0550T C
         ON A.RO_DOC_NO = C.RO_DOC_NO
        AND A.DLR_CD    = C.DLR_CD
        AND A.CALC_DOC_NO = C.CALC_DOC_NO
        WHERE 1=1
        <if test='sRcvStatCd != null and sRcvStatCd != ""'>
            AND C.RCV_STAT_CD = #{sRcvStatCd}
        </if>
        <if test='sCalcCancYn != null and sCalcCancYn != ""'>
            AND A.CALC_CANC_YN = #{sCalcCancYn}
        </if>
        <if test='sCalcStatCd != null and sCalcStatCd != ""'>
            AND A.CALC_STAT_CD = #{sCalcStatCd}
        </if>
        <if test='sRoStatCd != null and sRoStatCd != ""'>
            AND B.RO_STAT_CD = #{sRoStatCd}
        </if>
        <if test='sCalcDocNo != null and sCalcDocNo != ""'>
            AND A.CALC_DOC_NO = #{sCalcDocNo}
        </if>
        <if test='sRoDocNo != null and sRoDocNo != ""'>
            AND A.RO_DOC_NO = #{sRoDocNo}
        </if>
        <if test='sDlrCd != null and sDlrCd != ""'>
            AND A.DLR_CD = #{sDlrCd}
        </if>
        <if test='sCarRegNo != null and sCarRegNo != ""'>
            AND A.CAR_REG_NO = #{sCarRegNo}
        </if>
        <if test='sVinNo != null and sVinNo != ""'>
            AND A.VIN_NO = #{sVinNo}
        </if>
        <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
            AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
        </if>
        <if test='sDriverNm != null and sDriverNm != ""'>
            AND A.DRIVER_NM LIKE  '%'|| #{sDriverNm}||'%'
        </if>
        <if test='sCalcFromDt != null'>
            AND A.REG_DT <![CDATA[>=]]> #{sCalcFromDt}
        </if>
        <if test='sCalcToDt != null'>
            AND A.REG_DT <![CDATA[<=]]> #{sCalcToDt} + 1
        </if>
        <if test='sRoFromDt != null'>
            AND B.RO_DT <![CDATA[>=]]> #{sRoFromDt}
        </if>
        <if test='sRoToDt != null'>
            AND B.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
        </if>
        <if test='sRoTp != null and sRoTp != ""'>
            AND A.RO_TP =  #{sRoTp}
        </if>
      )WHERE RN = 1
    </select>

    <!-- 정산현황 조회 -->
    <select id="selectCalculateListByCondition" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateListByCondition] */

        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                   ,T3.* FROM (
                SELECT T2.*
                  FROM (
                    SELECT T1.*
                          ,FN_CMM_CD_NM('COM020',T1.PAYM_YN , #{sLangCd} ,'N') AS PAYM_YN_NM
                          ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = T1.RO_USR_ID AND DLR_CD = T1.DLR_CD) AS RO_USR_NM
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAYM_AMT - REAL_RCV_AMT,0)
                                ELSE NVL(REAL_PAYM_AMT - REAL_RCV_AMT,0) END AS NPAY_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_CALC_SUM_AMT,0)
                                ELSE NVL(REAL_LBR_CALC_SUM_AMT,0) END AS LBR_CALC_SUM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_CALC_SUM_AMT,0)
                                ELSE NVL(REAL_PAR_CALC_SUM_AMT,0) END AS PAR_CALC_SUM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_ETC_CALC_AMT,0)
                                ELSE NVL(REAL_ETC_CALC_AMT,0) END AS ETC_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_DC_AMT,0)
                                ELSE NVL(REAL_LBR_DC_AMT,0) END AS LBR_DC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_DC_AMT,0)
                                ELSE NVL(REAL_PAR_DC_AMT,0) END AS PAR_DC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_POINT_TOT_AMT,0)
                                ELSE NVL(REAL_POINT_TOT_AMT,0) END AS POINT_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_BM_POINT_TOT_AMT,0)
                                ELSE NVL(REAL_BM_POINT_TOT_AMT,0) END AS BM_POINT_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_BM_CUPN_TOT_AMT,0)
                                ELSE NVL(REAL_BM_CUPN_TOT_AMT,0) END AS BM_CUPN_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_ETC_TOT_AMT,0)
                                ELSE NVL(REAL_ETC_TOT_AMT,0) END AS ETC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_CALC_TOT_AMT,0)
                                ELSE NVL(REAL_CALC_TOT_AMT,0) END AS CALC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_WON_UNIT_CUT_AMT,0)
                                ELSE NVL(REAL_WON_UNIT_CUT_AMT,0) END AS WON_UNIT_CUT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_DEMIC_POINT_CUT_AMT,0)
                                ELSE NVL(REAL_DEMIC_POINT_CUT_AMT,0) END AS DEMIC_POINT_CUT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAYM_AMT,0)
                                ELSE NVL(REAL_PAYM_AMT,0) END AS PAYM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_RCV_AMT,0)
                                ELSE NVL(REAL_RCV_AMT,0) END AS RCV_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LAST_CALC_TOT_AMT,0)
                                ELSE NVL(REAL_LAST_CALC_TOT_AMT,0) END AS LAST_CALC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_CALC_AMT,0)
                                ELSE NVL(REAL_LBR_CALC_AMT,0) END AS LBR_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_CALC_AMT,0)
                                ELSE NVL(REAL_PAR_CALC_AMT,0) END AS PAR_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(CUPN_AMT,0)
                                ELSE NVL(CUPN_AMT,0) END AS BM_CUPN_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(CUPN_CHANGE_AMT,0)
                                ELSE NVL(CUPN_CHANGE_AMT,0) END AS BM_CUPN_CHANGE_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(MOVING_AVG_PRC,0)
                                ELSE NVL(MOVING_AVG_PRC,0) END AS MOVING_AVG_AMT
                      FROM (
                        SELECT F1.*, NVL(F2.MOVING_AVG_AMT, 0) AS MOVING_AVG_PRC FROM (
                             SELECT A.DLR_CD                          --딜러코드
                                   ,A.CALC_DOC_NO                     --정산문서번호
                                   ,A.RO_TP                           --RO유형
                                   ,FN_CMM_CD_NM('SER031',A.RO_TP, #{sLangCd} ,'N') AS RO_TP_NM
                                   ,A.RO_DOC_NO                       --RO문서번호
                                   ,A.RO_GRP_NO                       --RO그룹번호
                                   ,A.RESV_DOC_NO                     --예약문서번호
                                   ,A.DIAG_DOC_NO                     --진단문서번호
                                   ,A.PRE_CHK_DT                      --사전점검일자
                                   ,A.BASE_RO_NO                      --원RO번호
                                   ,A.INC_REQ_NO                      --보험신청번호
                                   ,A.VIN_NO                          --차대번호
                                   ,A.CAR_REG_NO                      --차량등록번호
                                   ,A.ENGIN_NO                        --엔진번호
                                   ,A.CAR_OWNER_ID                    --차량소유자ID
                                   ,A.CAR_OWNER_NM                    --차량소유자명
                                   ,A.DRIVER_ID                       --운전자ID
                                   ,A.DRIVER_NM                       --운전자명
                                   ,B.RUN_DIST_VAL                    --주행거리값
                                   ,A.LBR_CALC_AMT AS REAL_LBR_CALC_AMT                    --공임정산금액
                                   ,A.LBR_DC_RATE                     --공임할인율
                                   ,A.LBR_DC_AMT AS REAL_LBR_DC_AMT                     --공임할인금액
                                   ,A.LBR_BM_POINT_USE_AMT            --공임BM포인트사용금액
                                   ,A.LBR_BM_CUPN_USE_AMT             --공임BM쿠폰사용금액
                                   ,A.LBR_POINT_USE_AMT               --공임포인트사용금액
                                   ,A.LBR_ETC_DC_AMT                  --공임기타할인금액
                                   ,A.LBR_CALC_SUM_AMT AS REAL_LBR_CALC_SUM_AMT           --공임정산합계금액
                                   ,A.PAR_CALC_AMT AS REAL_PAR_CALC_AMT                   --부품정산금액
                                   ,A.PAR_DC_RATE                     --부품할인율
                                   ,A.PAR_DC_AMT AS REAL_PAR_DC_AMT                      --부품할인금액
                                   ,A.PAR_BM_POINT_USE_AMT            --부품BM포인트사용금액
                                   ,A.PAR_BM_CUPN_USE_AMT             --부품BM쿠폰사용금액
                                   ,A.PAR_POINT_USE_AMT               --부품포인트사용금액
                                   ,A.PAR_ETC_DC_AMT                  --부품기타할인금액
                                   ,A.PAR_CALC_SUM_AMT AS REAL_PAR_CALC_SUM_AMT           --부품정산합계금액
                                   ,A.ETC_CALC_AMT AS REAL_ETC_CALC_AMT               --기타정산금액
                                   ,A.ETC_DC_RATE                     --기타할인율
                                   ,A.ETC_DC_AMT                      --기타할인금액
                                   ,A.ETC_BM_POINT_USE_AMT            --기타BM포인트사용금액
                                   ,A.ETC_BM_CUPN_USE_AMT             --기타BM쿠폰사용금액
                                   ,A.ETC_POINT_USE_AMT               --기타포인트사용금액
                                   ,A.ETC_OTHER_DC_AMT                --기타다른할인금액
                                   ,A.ETC_CALC_SUM_AMT                --기타정산합계금액
                                   ,A.CALC_TOT_AMT AS REAL_CALC_TOT_AMT
                                   ,A.DC_TOT_RATE                     --할인총율
                                   ,A.DC_TOT_AMT                      --할인총금액
                                   ,A.BM_POINT_TOT_AMT AS REAL_BM_POINT_TOT_AMT               --BM포인트총금액
                                   ,A.BM_CUPN_TOT_AMT AS REAL_BM_CUPN_TOT_AMT                 --BM쿠폰총금액
                                   ,A.POINT_TOT_AMT AS REAL_POINT_TOT_AMT                   --포인트총금액
                                   ,A.ETC_TOT_AMT AS REAL_ETC_TOT_AMT                     --기타총금액
                                   ,A.LAST_CALC_TOT_AMT AS REAL_LAST_CALC_TOT_AMT
                                   ,A.CALC_DT                         --정산일자
                                   ,A.CALC_STAT_CD                    --정산상태코드
                                   ,FN_CMM_CD_NM('SER030',A.CALC_STAT_CD, #{sLangCd} ,'N') AS CALC_STAT_NM
                                   ,A.CALC_PRINT_DT                   --정산출력일자
                                   ,A.CALC_CANC_DT                    --정산취소일자
                                   ,A.CALC_CANC_ID                    --정산취소자
                                   ,A.CALC_CANC_REASON_CD             --정산취소원인코드
                                   ,FN_CMM_CD_NM('SER025',A.CALC_CANC_REASON_CD, #{sLangCd} ,'N') AS CALC_CANC_REASON_NM
                                   ,A.CALC_CANC_REASON_CONT           --정산취소내용
                                   ,A.REG_USR_ID                      --등록자ID
                                   ,A.REG_DT                          --등록일자
                                   ,A.UPDT_USR_ID                     --수정자ID
                                   ,A.UPDT_DT                         --수정일자
                                   ,A.CALC_REMARK
                                   ,A.ETC_DC_CD
                                   ,A.CALC_COMP_USR_ID
                                   ,A.CALC_COMP_USR_NM
                                   ,A.MAIN_CTNO_TP                    --메인연락방법
                                   ,FN_CMM_CD_NM('CRM038',A.MAIN_CTNO_TP, #{sLangCd} ,'N') AS MAIN_CTNO_TP_NM
                                   ,A.MAIN_CTNO_DT_TP                 --메인연락시간
                                   ,FN_CMM_CD_NM('CRM027',A.MAIN_CTNO_DT_TP, #{sLangCd} ,'N') AS MAIN_CTNO_DT_TP_NM
                                   ,B.RO_DT
                                   ,B.PDI_YN
                                   ,B.RO_STAT_CD
                                   ,B.REG_USR_ID AS RO_USR_ID
                                   ,B.DLR_RO_TP                       --자체RO유형
                                   ,FN_CMM_CD_NM('SER044',B.DLR_RO_TP, #{sLangCd} ,'N') AS DLR_RO_TP_NM
                                   ,(SELECT SUM(NVL(WON_UNIT_CUT_AMT,0))
                                      FROM SE_0530T
                                     WHERE DLR_CD = A.DLR_CD
                                       AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_WON_UNIT_CUT_AMT
                                   ,(SELECT SUM(NVL(DEMIC_POINT_CUT_AMT,0))
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_DEMIC_POINT_CUT_AMT
                                   ,(SELECT SUM(NVL(PAYM_AMT,0))
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_PAYM_AMT
                                   ,NVL((SELECT CUPN_NO
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND CUPN_NO IS NOT NULL
                                        AND ROWNUM = 1), A.LAN_BIN_CARD_NO) AS BM_CUPN_NO
                                   ,NVL((SELECT CUPN_NM
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND CUPN_NM IS NOT NULL
                                        AND ROWNUM = 1), A.LAN_BIN_CARD_NAME) AS BM_CUPN_NM 
                                   ,NVL((SELECT ATVT_TP
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ATVT_TP IS NOT NULL
                                        AND ROWNUM = 1), A.LAN_BIN_CARD_TYPE) AS BM_ATVT_TP
                                   ,(SELECT CUPN_AMT
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND CUPN_AMT IS NOT NULL
                                        AND ROWNUM = 1) AS CUPN_AMT
                                   ,(SELECT CUPN_CHANGE_AMT
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND CUPN_CHANGE_AMT IS NOT NULL
                                        AND ROWNUM = 1) AS CUPN_CHANGE_AMT
                                   ,( SELECT CASE WHEN SUM(NVL(D.RCV_AMT,0)) = SUM(NVL(D.PAYM_AMT,0)) THEN 'Y' ELSE 'N' END AS PAYM_YN
                                        FROM SE_0550T C , SE_0560T D
                                       WHERE C.DLR_CD      = D.DLR_CD
                                         AND C.RCV_DOC_NO  = D.RCV_DOC_NO
                                         AND C.DLR_CD      = A.DLR_CD
                                         AND C.CALC_DOC_NO = A.CALC_DOC_NO
                                    ) AS PAYM_YN
                                   ,NVL(( SELECT SUM(NVL(D.RCV_AMT,0))
                                        FROM SE_0550T C , SE_0560T D
                                       WHERE C.DLR_CD      = D.DLR_CD
                                         AND C.RCV_DOC_NO  = D.RCV_DOC_NO
                                         AND C.DLR_CD      = A.DLR_CD
                                         AND C.CALC_DOC_NO = A.CALC_DOC_NO
                                    ),0) AS REAL_RCV_AMT
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CALC_CANC_ID AND DLR_CD = A.DLR_CD) AS CALC_CANC_NM
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.UPDT_USR_ID AND DLR_CD = A.DLR_CD) AS UPDT_USR_NM
                                   ,(SELECT CAR_RUN_DIST_VAL FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CAR_RUN_DIST_VAL
                                   ,(SELECT FN_GET_CARLINE_NM(CARLINE_CD) AS CARLINE_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CARLINE_NM
                                   ,(SELECT FN_GET_MODEL_NM(MODEL_CD) AS MODEL_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS MODEL_NM
                                   ,B.GI_RUN_DIST_VAL
                                   ,A.SER_PAR_DSTIN_CD
                                   ,A.EXPC_CHK_DT
                                   ,A.EXPC_CHK_RUN_DIST_VAL
                                   ,A.LAN_BIN_CARD_NO  --卡券号  贾明 2020-6-3
                                   ,A.COUPON_WRITE     --卡券是否已 核销 Y 代表 已核销 贾明 2020-6-3
                                   ,A.LAN_BIN_CARD_EFFE_DT --卡券是有效日期 贾明 2020-6-3
                               FROM SE_0500T A, SE_0300T B
                              WHERE A.DLR_CD    = B.DLR_CD
                                AND A.RO_DOC_NO = B.RO_DOC_NO
                                AND A.RO_TP     = B.RO_TP
                                AND A.DLR_CD    =  #{sDlrCd}
                            <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                                AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                            </if>
                            <if test='sRoDocNo != null and sRoDocNo != ""'>
                                AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                            </if>
                            <if test='sRoTp != null and sRoTp != ""'>
                                AND A.RO_TP =  #{sRoTp}
                            </if>
                            <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                               <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                            <if test='sCarRegNo != null and sCarRegNo != ""'>
                                AND A.CAR_REG_NO LIKE UPPER('%'|| #{sCarRegNo}||'%')
                            </if>
                            <if test='sVinNo != null and sVinNo != ""'>
                                AND A.VIN_NO = UPPER(#{sVinNo})
                            </if>
                            <if test='sDriverNm != null and sDriverNm != ""'>
                                AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                            </if>
                            <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                                AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                            </if>
                            <if test='sCalcFromDt != null'>
                                AND A.CALC_DT <![CDATA[>=]]> #{sCalcFromDt}
                            </if>
                            <if test='sCalcToDt != null'>
                                AND A.CALC_DT <![CDATA[<]]> #{sCalcToDt} + 1
                            </if>
                            <if test='sCalcRegFromDt != null'>
                                AND A.REG_DT <![CDATA[>=]]> #{sCalcRegFromDt}
                            </if>
                            <if test='sCalcRegToDt != null'>
                                AND A.REG_DT <![CDATA[<]]> #{sCalcRegToDt} + 1
                            </if>
                            <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                                AND A.CALC_STAT_CD = #{sCalcStatCd}
                            </if>
                            <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                                AND A.CALC_CANC_YN = #{sCalcCancYn}
                            </if>
                            <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                                AND B.DLR_RO_TP =  #{sDlrRoTp}
                            </if>
                            AND A.VIN_NO IS NOT NULL
                            <choose>
                                <when test='sScreenGb != null and sScreenGb != "" and sScreenGb == "C"'>
                                    AND A.CALC_STAT_CD NOT IN ('03')
                                </when>
                                <otherwise>
                                    AND A.CALC_STAT_CD NOT IN ('03', '04')
                                </otherwise>
                            </choose>
                        ) F1 LEFT OUTER JOIN
                        (SELECT (POS_AMT - NEG_AMT) AS MOVING_AVG_AMT, DLR_CD, RO_DOC_NO
                           FROM (
                               SELECT NVL(SUM(DECODE(PAR_REQ_STAT_CD, 02, T2.MOVING_AVG_AMT)), 0) AS POS_AMT
                                      , NVL(SUM(DECODE(PAR_REQ_STAT_CD, 03, ABS(T2.MOVING_AVG_AMT))), 0) AS NEG_AMT
                                      , T2.DLR_CD, T2.RO_DOC_NO
                                 FROM SE_0160T T1
                                INNER JOIN PT_0502T T2
                                   ON T1.DLR_CD = T2.DLR_CD
                                  AND T1.DOC_NO = T2.RO_DOC_NO
                                  AND T1.LINE_NO = T2.RO_LINE_NO
                                  AND T1.ITEM_CD = T2.ITEM_CD
                                WHERE T1.DLR_CD = #{sDlrCd}
                                  AND PREFIX_ID = 'RO'
                                  AND PAR_GI_TP = 'RO'
                                  GROUP BY T2.DLR_CD, T2.RO_DOC_NO
                               )
                        ) F2
                       ON F1.DLR_CD = F2.DLR_CD
                      AND F1.RO_DOC_NO = F2.RO_DOC_NO
                <where>
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND F1.REG_USR_NM = #{sRegUsrNm}
                    </if>
                    <if test='sRoFromDt != null'>
                        AND F1.RO_DT <![CDATA[>=]]> #{sRoFromDt}
                    </if>
                    <if test='sRoToDt != null'>
                        AND F1.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
                    </if>
                </where>
                      ) T1
                  ) T2
                <where>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND T2.RO_USR_NM  LIKE  '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "carRegNo"'>             T2.CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "vinNo"'>                T2.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                     </when>
                                <when test='item.field == "carOwnerNm"'>           T2.CAR_OWNER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "driverNm"'>             T2.DRIVER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "carlineNm"'>            T2.CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "modelNm"'>              T2.MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "runDistVal"'>           T2.RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "giRunDistVal"'>         T2.GI_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "calcStatNm"'>           T2.CALC_STAT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcDocNo"'>            T2.CALC_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "regDtFormat"'>          T2.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                     </when>
                                <when test='item.field == "regUsrNm"'>             T2.REG_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "calcPrintDtFormat"'>    T2.CALC_PRINT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "calcCancDtFormat"'>     T2.CALC_CANC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcCancNm"'>           T2.CALC_CANC_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcCancReasonNm"'>     T2.CALC_CANC_REASON_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "calcDtFormat"'>         T2.CALC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                    </when>
                                <when test='item.field == "calcCompUsrNm"'>        T2.CALC_COMP_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "roDocNo"'>              T2.RO_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "roTpNm"'>               T2.RO_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "dlrRoTpNm"'>            T2.DLR_RO_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "roDtFormat"'>           T2.RO_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                      </when>
                                <when test='item.field == "roUsrNm"'>              T2.RO_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "paymYnNm"'>             T2.PAYM_YN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "calcRemark"'>           T2.CALC_REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "lbrCalcAmt"'>           T2.LBR_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "parCalcAmt"'>           T2.PAR_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "etcCalcAmt"'>           T2.ETC_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "lbrDcAmt"'>             T2.LBR_DC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "parDcAmt"'>             T2.PAR_DC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "pointTotAmt"'>          T2.POINT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "bmPointTotAmt"'>        T2.BM_POINT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "bmCupnTotAmt"'>         T2.BM_CUPN_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "etcTotAmt"'>            T2.ETC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "lastCalcTotAmt"'>       T2.LAST_CALC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "wonUnitCutAmt"'>        T2.WON_UNIT_CUT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "demicPointCutAmt"'>     T2.DEMIC_POINT_CUT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "paymAmt"'>              T2.PAYM_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "rcvAmt"'>               T2.RCV_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                    </when>
                                <when test='item.field == "npayAmt"'>              T2.NPAY_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "carRunDistVal"'>        T2.CAR_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "expcChkDtFormat"'>      T2.EXPC_CHK_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "expcChkRunDistVal"'>    T2.EXPC_CHK_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "movingAvgAmt"'>         T2.MOVING_AVG_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                <when test='item.field == "bmCupnNo"'>             T2.BM_CUPN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmCupnNm"'>             T2.BM_CUPN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmAtvtTp"'>             T2.BM_ATVT_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmCupnAmt"'>            T2.BM_CUPN_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "bmCupnChangeAmt"'>      T2.BM_CUPN_CHANGE_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "mainCtnoDtTpNm"'>       T2.MAIN_CTNO_DT_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "mainCtnoTpNm"'>         T2.MAIN_CTNO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <otherwise>
                                    T2.CALC_DOC_NO DESC
                                    ,T2.REG_DT DESC
                                    ,T2.DLR_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        T2.CALC_DOC_NO DESC
                        ,T2.REG_DT DESC
                        ,T2.DLR_CD ASC
                    </otherwise>
                </choose>
                ) T3
                <where>
                    <if test='firstIndex != -1 and lastIndex != -1'>
                        ROWNUM <![CDATA[<=]]> #{lastIndex}
                    </if>
                </where>
            )
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM > #{firstIndex}
                </if>
            </where>
    </select>

    <!-- 정산 현황 목록수를 조회. -->
    <select id="selectCalculateListByConditionCnt" parameterType="CalculateSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.selectCalculateListByConditionCnt] */
             SELECT COUNT(*) FROM (
                 SELECT A.*
                        ,(SELECT RO_DT
                           FROM SE_0300T
                          WHERE DLR_CD    = A.DLR_CD
                            AND RO_DOC_NO = A.RO_DOC_NO
                            AND RO_TP     = A.RO_TP
                        )AS RO_DT
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = B.DLR_CD) AS RO_USR_NM
                        ,B.DLR_RO_TP
                   FROM SE_0500T A , SE_0300T B
                  WHERE A.RO_DOC_NO = B.RO_DOC_NO
                    AND A.RO_TP     = B.RO_TP
                    AND A.DLR_CD    = B.DLR_CD
                    AND A.DLR_CD    = #{sDlrCd}
                <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                    AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                </if>
                <if test='sRoTp != null and sRoTp != ""'>
                    AND A.RO_TP =  #{sRoTp}
                </if>
                <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                   <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                       #{item}
                   </foreach>
                </if>
                <if test='sRoDocNo != null and sRoDocNo != ""'>
                    AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                </if>
                <if test='sCarRegNo != null and sCarRegNo != ""'>
                    AND A.CAR_REG_NO LIKE UPPER('%'|| #{sCarRegNo}||'%')
                </if>
                <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO = UPPER(#{sVinNo})
                </if>
                <if test='sDriverNm != null and sDriverNm != ""'>
                    AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                </if>
                <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                    AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                </if>
                <if test='sCalcFromDt != null'>
                    AND A.CALC_DT <![CDATA[>=]]> #{sCalcFromDt}
                </if>
                <if test='sCalcToDt != null'>
                    AND A.CALC_DT <![CDATA[<]]> #{sCalcToDt} + 1
                </if>
                <if test='sCalcRegFromDt != null'>
                    AND A.REG_DT <![CDATA[>=]]> #{sCalcRegFromDt}
                </if>
                <if test='sCalcRegToDt != null'>
                    AND A.REG_DT <![CDATA[<]]> #{sCalcRegToDt} + 1
                </if>
                <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                    AND A.CALC_STAT_CD = #{sCalcStatCd}
                </if>
                <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                    AND A.CALC_CANC_YN = #{sCalcCancYn}
                </if>
                <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                    AND B.DLR_RO_TP =  #{sDlrRoTp}
                </if>
                AND A.VIN_NO IS NOT NULL
                <choose>
                    <when test='sScreenGb != null and sScreenGb != "" and sScreenGb == "C"'>
                        AND A.CALC_STAT_CD NOT IN ('03')
                    </when>
                    <otherwise>
                        AND A.CALC_STAT_CD NOT IN ('03', '04')
                    </otherwise>
                </choose>
                ) T1
                <where>
                    <if test='sRoFromDt != null'>
                        AND T1.RO_DT <![CDATA[>=]]> #{sRoFromDt}
                    </if>
                    <if test='sRoToDt != null'>
                        AND T1.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
                    </if>
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND T1.REG_USR_NM = #{sRegUsrNm}
                    </if>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND T1.RO_USR_NM  LIKE  '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
    </select>

    <!-- 정산접수 상세 조회. -->
    <select id="selectCalculateByKey" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateByKey] */
        SELECT A.*
              ,B.RO_DT
              ,B.RO_STAT_CD
              ,B.QT_TEST_MTH_CD
              ,B.QT_TEST_STAT_CD
              ,B.GOODWILL_YN
              ,B.PDI_YN
              ,C.RCV_DOC_NO
              ,C.RCV_STAT_CD
              ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
              ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = B.DLR_CD) AS RO_USR_NM
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_HM_CD
                       AND CMM_GRP_CD ='SER126'
                       AND LANG_CD ='zh') ,'6') AS NEXT_FREE_MONTH
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_RUN_DIST_VAL_CD
                       AND CMM_GRP_CD ='SER127'
                       AND LANG_CD ='zh'),'5000') AS NEXT_FREE_RUN_DIST_VAL
              ,B.GI_RUN_DIST_VAL
              ,B.COM_ITEM_YN
          FROM SE_0500T A
         LEFT OUTER JOIN SE_0300T B
           ON A.DLR_CD    = B.DLR_CD
          AND A.RO_DOC_NO = B.RO_DOC_NO
          AND B.RO_STAT_CD != '06'
         LEFT JOIN SE_0550T C
          ON A.DLR_CD      = C.DLR_CD
         AND A.RO_DOC_NO   = C.RO_DOC_NO
         AND A.CALC_DOC_NO = C.CALC_DOC_NO
        WHERE A.CALC_STAT_CD != '07'
        <if test='sDlrCd != null and sDlrCd != ""'>
          AND A.DLR_CD = #{sDlrCd}
        </if>
        <if test='sRoDocNo != null and sRoDocNo != ""'>
          AND A.RO_DOC_NO = #{sRoDocNo}
          AND A.CALC_CANC_YN = 'N'
        </if>
        <if test='sCalcDocNo != null and sCalcDocNo != ""'>
          AND A.CALC_DOC_NO = #{sCalcDocNo}
        </if>
        <if test='sSerHistYn != null and sSerHistYn != ""'>
          AND A.CALC_STAT_CD = '00'
        </if>
    </select>

    <!-- 정산(부품)접수 상세 조회. -->
    <select id="selectCalculatePartByKey" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculatePartByKey] */
        SELECT A.*
              ,C.RCV_DOC_NO
              ,C.RCV_STAT_CD
              ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_HM_CD
                       AND CMM_GRP_CD ='SER126'
                       AND LANG_CD ='zh') ,'6') AS NEXT_FREE_MONTH
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_RUN_DIST_VAL_CD
                       AND CMM_GRP_CD ='SER127'
                       AND LANG_CD ='zh'),'5000') AS NEXT_FREE_RUN_DIST_VAL
          FROM SE_0500T A
               LEFT JOIN SE_0550T C
               ON A.DLR_CD       = C.DLR_CD
               AND A.RO_DOC_NO   = C.RO_DOC_NO
               AND A.CALC_DOC_NO = C.CALC_DOC_NO
         WHERE A.DLR_CD      = #{sDlrCd}
           AND A.CALC_DOC_NO = #{sCalcDocNo}
    </select>

    <!-- 수납관리에 등록된 목록수를 조회. -->
    <select id="selectServiceReceiveByCalcCnt" parameterType="CalculateSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.selectServiceReceiveByCalcCnt] */
        SELECT COUNT(RCV_DOC_NO) AS VALUE
          FROM SE_0550T A
         WHERE 1=1
         <if test='sDlrCd != null and sDlrCd != ""'>
             AND A.DLR_CD = #{sDlrCd}
         </if>
         <if test='sRoDocNo != null and sRoDocNo != ""'>
             AND A.RO_DOC_NO = #{sRoDocNo}
         </if>
    </select>

    <!-- 수납관리 등록-->
    <insert id="insertServiceReceiveByCalc" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.insertServiceReceiveByCalc] */
        INSERT INTO SE_0550T    --수납관리
            (
              DLR_CD                      --딜러코드
             ,RCV_DOC_NO                  --수납문서번호
             ,RO_TP                       --RO유형
             ,RO_DOC_NO                   --RO문서번호
             ,RO_GRP_NO                   --RO그룹번호
             ,RESV_DOC_NO                 --예약문서번호
             ,DIAG_DOC_NO                  --사전점검번호
             ,PRE_CHK_DT                  --사전점검일자
             ,BASE_RO_NO                  --원RO번호
             ,INC_REQ_NO                  --보험신청번호
             ,VIN_NO                      --차대번호
             ,CAR_REG_NO                  --차량등록번호
             ,ENGIN_NO             --엔진시리얼번호
             ,CAR_OWNER_ID                  --차량소유자ID
             ,CAR_OWNER_NM                  --차량소유자명
             ,DRIVER_ID                   --운전자ID
             ,DRIVER_NM                   --운전자명
             ,RESV_DT                     --예약일자
             ,RUN_DIST_VAL                --주행거리값
             ,LBR_CALC_AMT                --공임정산금액
             ,LBR_DC_RATE                 --공임할인율
             ,LBR_DC_AMT                  --공임할인금액
             ,LBR_BM_POINT_USE_AMT        --공임BM포인트사용금액
             ,LBR_POINT_USE_AMT           --공임포인트사용금액
             ,LBR_ETC_DC_AMT              --공임기타할인금액
             ,LBR_CALC_SUM_AMT            --공임정산합계금액
             ,PAR_CALC_AMT                --부품정산금액
             ,PAR_DC_RATE                 --부품할인율
             ,PAR_DC_AMT                  --부품할인금액
             ,PAR_BM_POINT_USE_AMT        --부품BM포인트사용금액
             ,PAR_POINT_USE_AMT           --부품포인트사용금액
             ,PAR_ETC_DC_AMT              --부품기타할인금액
             ,PAR_CALC_SUM_AMT            --부품정산합계금액
             ,ETC_CALC_AMT                --기타정산금액
             ,ETC_DC_RATE                 --기타할인율
             ,ETC_DC_AMT                  --기타할인금액
             ,ETC_BM_POINT_USE_AMT        --기타BM포인트사용금액
             ,ETC_POINT_USE_AMT           --기타포인트사용금액
             ,ETC_OTHER_DC_AMT            --기타다른할인금액
             ,ETC_CALC_SUM_AMT            --기타정산합계금액
             ,CALC_TOT_AMT                --정산총금액
             ,DC_TOT_RATE                 --할인총율
             ,DC_TOT_AMT                  --할인총금액
             ,BM_POINT_TOT_AMT            --BM포인트총금액
             ,POINT_TOT_AMT               --포인트총금액
             ,ETC_TOT_AMT                 --기타총금액
             ,LAST_CALC_TOT_AMT           --최종정산총금액
             ,CALC_DT                     --정산일자
             ,CALC_STAT_CD                --정산상태코드
             ,REG_USR_ID                  --등록자ID
             ,REG_DT                      --등록일자
             ,CALC_DOC_NO                 --정산번호
             ,RCV_STAT_CD                 --수납상태
             ,CALC_PRSN_ID                --정산담당자ID
             ,CALC_PRSN_NM                --정산담당자명
             ,SER_PAR_DSTIN_CD            --정비부품구분코드
             ,CUST_TP                     --고객유형
            )
            VALUES
            (
              #{dlrCd}                      --딜러코드
             ,#{rcvDocNo}                   --수납문서번호
             ,#{roTp}                       --RO유형
             ,#{roDocNo}                    --RO문서번호
             ,#{roGrpNo}                    --RO그룹번호
             ,#{resvDocNo}                  --예약문서번호
             ,#{diagDocNo}                   --사전점검번호
             ,#{preChkDt}                   --사전점검일자
             ,#{baseRoNo}                   --원RO번호
             ,#{incReqNo}                   --보험신청번호
             ,#{vinNo}                      --차대번호
             ,#{carRegNo}                   --차량등록번호
             ,#{enginNo}                    --엔진시리얼번호
             ,#{carOwnerId}                 --차량소유자ID
             ,#{carOwnerNm}                 --차량소유자명
             ,#{driverId}                   --운전자ID
             ,#{driverNm}                   --운전자명
             ,#{resvDt}                     --예약일자
             ,#{runDistVal}                 --주행거리값
             ,#{lbrCalcAmt}                 --공임정산금액
             ,#{lbrDcRate}                  --공임할인율
             ,#{lbrDcAmt}                   --공임할인금액
             ,#{lbrBmPointUseAmt}           --공임BM포인트사용금액
             ,#{lbrPointUseAmt}             --공임포인트사용금액
             ,#{lbrEtcDcAmt}                --공임기타할인금액
             ,#{lbrCalcSumAmt}              --공임정산합계금액
             ,#{parCalcAmt}                 --부품정산금액
             ,#{parDcRate}                  --부품할인율
             ,#{parDcAmt}                   --부품할인금액
             ,#{parBmPointUseAmt}           --부품BM포인트사용금액
             ,#{parPointUseAmt}             --부품포인트사용금액
             ,#{parEtcDcAmt}                --부품기타할인금액
             ,#{parCalcSumAmt}              --부품정산합계금액
             ,#{etcCalcAmt}                 --기타정산금액
             ,#{etcDcRate}                  --기타할인율
             ,#{etcDcAmt}                   --기타할인금액
             ,#{etcBmPointUseAmt}           --기타BM포인트사용금액
             ,#{etcPointUseAmt}             --기타포인트사용금액
             ,#{etcOtherDcAmt}              --기타다른할인금액
             ,#{etcCalcSumAmt}              --기타정산합계금액
             ,#{calcTotAmt}                 --정산총금액
             ,#{dcTotRate}                  --할인총율
             ,#{dcTotAmt}                   --할인총금액
             ,#{bmPointTotAmt}              --BM포인트총금액
             ,#{pointTotAmt}                --포인트총금액
             ,#{etcTotAmt}                  --기타총금액
             ,#{lastCalcTotAmt}             --최종정산총금액
             ,SYSDATE                       --정산일자
             ,'00'                          --정산상태코드
             ,#{regUsrId}                   --등록자ID
             ,SYSDATE                       --등록일자
             ,#{calcDocNo}                  --정산번호
             ,'O'
             ,#{regUsrId}                   --정산담당자ID
             ,(SELECT USR_NM FROM CM_0801T WHERE DLR_CD = #{dlrCd} AND USR_ID = #{regUsrId})
             ,#{serParDstinCd}
             ,#{custTp}
            )
    </insert>

    <!-- 수납관리 수정 -->
    <update id="updateServiceReceiveByCalc" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.updateServiceReceive] */
        UPDATE SE_0550T    --수납관리
          SET
               UPDT_USR_ID          = #{updtUsrId}                  --수정자ID
              ,UPDT_DT              = SYSDATE                       --수정일자
              <if test='lbrCalcAmt != null and lbrCalcAmt != ""'>
              ,LBR_CALC_AMT         = #{lbrCalcAmt}                 --공임정산금액
              </if>
              <if test='lbrDcRate != null and lbrDcRate != ""'>
              ,LBR_DC_RATE          = #{lbrDcRate}                  --공임할인율
              </if>
              <if test='lbrDcAmt != null and lbrDcAmt != ""'>
              ,LBR_DC_AMT           = #{lbrDcAmt}                   --공임할인금액
              </if>
              <if test='lbrBmPointUseAmt != null and lbrBmPointUseAmt != ""'>
              ,LBR_BM_POINT_USE_AMT = #{lbrBmPointUseAmt}           --공임BM포인트사용금액
              </if>
              <if test='lbrPointUseAmt != null and lbrPointUseAmt != ""'>
              ,LBR_POINT_USE_AMT    = #{lbrPointUseAmt}             --공임포인트사용금액
              </if>
              <if test='lbrEtcDcAmt != null and lbrEtcDcAmt != ""'>
              ,LBR_ETC_DC_AMT       = #{lbrEtcDcAmt}                --공임기타할인금액
              </if>
              <if test='lbrCalcSumAmt != null and lbrCalcSumAmt != ""'>
              ,LBR_CALC_SUM_AMT     = #{lbrCalcSumAmt}              --공임정산합계금액
              </if>
              <if test='parCalcAmt != null and parCalcAmt != ""'>
              ,PAR_CALC_AMT         = #{parCalcAmt}                 --부품정산금액
              </if>
              <if test='parDcRate != null and parDcRate != ""'>
              ,PAR_DC_RATE          = #{parDcRate}                  --부품할인율
              </if>
              <if test='parDcAmt != null and parDcAmt != ""'>
              ,PAR_DC_AMT           = #{parDcAmt}                   --부품할인금액
              </if>
              <if test='parBmPointUseAmt != null and parBmPointUseAmt != ""'>
              ,PAR_BM_POINT_USE_AMT = #{parBmPointUseAmt}           --부품BM포인트사용금액
              </if>
              <if test='parPointUseAmt != null and parPointUseAmt != ""'>
              ,PAR_POINT_USE_AMT    = #{parPointUseAmt}             --부품포인트사용금액
              </if>
              <if test='parEtcDcAmt != null and parEtcDcAmt != ""'>
              ,PAR_ETC_DC_AMT       = #{parEtcDcAmt}                --부품기타할인금액
              </if>
              <if test='parCalcSumAmt != null and parCalcSumAmt != ""'>
              ,PAR_CALC_SUM_AMT     = #{parCalcSumAmt}              --부품정산합계금액
              </if>
              <if test='etcCalcAmt != null and etcCalcAmt != ""'>
              ,ETC_CALC_AMT         = #{etcCalcAmt}                 --기타정산금액
              </if>
              <if test='etcDcRate != null and etcDcRate != ""'>
              ,ETC_DC_RATE          = #{etcDcRate}                  --기타할인율
              </if>
              <if test='etcDcAmt != null and etcDcAmt != ""'>
              ,ETC_DC_AMT           = #{etcDcAmt}                   --기타할인금액
              </if>
              <if test='etcBmPointUseAmt != null and etcBmPointUseAmt != ""'>
              ,ETC_BM_POINT_USE_AMT = #{etcBmPointUseAmt}           --기타BM포인트사용금액
              </if>
              <if test='etcPointUseAmt != null and etcPointUseAmt != ""'>
              ,ETC_POINT_USE_AMT    = #{etcPointUseAmt}             --기타포인트사용금액
              </if>
              <if test='etcOtherDcAmt != null and etcOtherDcAmt != ""'>
              ,ETC_OTHER_DC_AMT     = #{etcOtherDcAmt}              --기타다른할인금액
              </if>
              <if test='etcCalcSumAmt != null and etcCalcSumAmt != ""'>
              ,ETC_CALC_SUM_AMT     = #{etcCalcSumAmt}              --기타정산합계금액
              </if>
              <if test='calcTotAmt != null and calcTotAmt != ""'>
              ,CALC_TOT_AMT         = #{calcTotAmt}                 --정산총금액
              </if>
              <if test='dcTotRate != null and dcTotRate != ""'>
              ,DC_TOT_RATE          = #{dcTotRate}                  --할인총율
              </if>
              <if test='dcTotAmt != null and dcTotAmt != ""'>
              ,DC_TOT_AMT           = #{dcTotAmt}                   --할인총금액
              </if>
              <if test='bmPointTotAmt != null and bmPointTotAmt != ""'>
              ,BM_POINT_TOT_AMT     = #{bmPointTotAmt}              --BM포인트총금액
              </if>
              <if test='pointTotAmt != null and pointTotAmt != ""'>
              ,POINT_TOT_AMT        = #{pointTotAmt}                --포인트총금액
              </if>
              <if test='etcTotAmt != null and etcTotAmt != ""'>
              ,ETC_TOT_AMT          = #{etcTotAmt}                  --기타총금액
              </if>
              <if test='lastCalcTotAmt != null and lastCalcTotAmt != ""'>
              ,LAST_CALC_TOT_AMT    = #{lastCalcTotAmt}             --최종정산총금액
              </if>
              <if test='calcDt != null'>
              ,CALC_DT              = SYSDATE                     --정산일자
              </if>
              <if test='rcvStatCd != null and rcvStatCd != ""'>
              ,RCV_STAT_CD          = #{rcvStatCd}                  --수납상태
              </if>
              <if test='custTp != null and custTp != ""'>
              ,CUST_TP          = #{custTp}                         --고객유형
              </if>
         WHERE 1 = 1
           AND DLR_CD               = #{dlrCd}                      --딜러코드
           AND RO_DOC_NO            = #{roDocNo}                    --수납문서번호
    </update>

    <!-- 수납관리 삭제 -->
    <delete id="deleteServiceReceiveByCalc" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.deleteServiceReceiveByCalc] */
        DELETE FROM SE_0550T
        WHERE  DLR_CD    = #{dlrCd}                --딜러코드
        AND RO_DOC_NO    = #{roDocNo}             --수납문서번호
    </delete>

    <!-- 정산접수 상세 조회. -->
    <select id="selectRcvOnlyByKey" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateOnlyByKey] */
        SELECT RCV_DOC_NO
          FROM SE_0550T
         WHERE DLR_CD = #{sDlrCd}
           AND RO_DOC_NO = #{sRoDocNo}
    </select>

    <!-- 정산 취소등록. -->
    <insert id="insertCancelCalculate" parameterType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.insertCancelCalculate] */
        INSERT INTO SE_0500T
        SELECT
            DLR_CD
            ,CALC_DOC_NO
            ,RO_TP
            ,RO_DOC_NO
            ,RO_GRP_NO
            ,RESV_DOC_NO
            ,DIAG_DOC_NO
            ,PRE_CHK_DT
            ,BASE_RO_NO
            ,INC_REQ_NO
            ,VIN_NO
            ,CAR_REG_NO
            ,ENGIN_NO
            ,CAR_OWNER_ID
            ,CAR_OWNER_NM
            ,DRIVER_ID
            ,DRIVER_NM
            ,RESV_DT
            ,RUN_DIST_VAL
            ,LBR_CALC_AMT
            ,LBR_DC_RATE
            ,LBR_DC_AMT
            ,LBR_BM_POINT_USE_AMT
            ,LBR_POINT_USE_AMT
            ,LBR_ETC_DC_AMT
            ,LBR_CALC_SUM_AMT
            ,PAR_CALC_AMT
            ,PAR_DC_RATE
            ,PAR_DC_AMT
            ,PAR_BM_POINT_USE_AMT
            ,PAR_POINT_USE_AMT
            ,PAR_ETC_DC_AMT
            ,PAR_CALC_SUM_AMT
            ,ETC_CALC_AMT
            ,ETC_DC_RATE
            ,ETC_DC_AMT
            ,ETC_BM_POINT_USE_AMT
            ,ETC_POINT_USE_AMT
            ,ETC_OTHER_DC_AMT
            ,ETC_CALC_SUM_AMT
            ,CALC_TOT_AMT
            ,DC_TOT_RATE
            ,DC_TOT_AMT
            ,BM_POINT_TOT_AMT
            ,POINT_TOT_AMT
            ,ETC_TOT_AMT
            ,LAST_CALC_TOT_AMT
            ,SYSDATE
            ,'07'
            ,CALC_REMARK
            ,OPN_REMARK
            ,VSIT_CANC_CAU_CONT
            ,'Y'
            ,CALC_CANC_DT
            ,CALC_CANC_ID
            ,VSIT_CAR_RECEIVE_DT
            ,VSIT_CAR_RECEIVE_IF_NM
            ,VSIT_CAR_RECEIVE_CTNO_NO
            ,VSIT_CAR_RECEIVE_ADDR_NM
            ,CAR_RECEIVE_DT
            ,VSIT_DL_IF_NM
            ,VSIT_DL_CTNO_NO
            ,VSIT_DL_ADDR_NM
            ,VSIT_DT
            ,VSIT_IF_NM
            ,VSIT_CTNO_NO
            ,VSIT_ADDR_NM
            ,#{calcCancId}
            ,SYSDATE
            ,#{calcCancId}
            ,SYSDATE
            ,EXPC_CHK_DT
            ,EXPC_CHK_RUN_DIST_VAL
            ,MAIN_CTNO_TP
            ,MAIN_CTNO_DT_TP
            ,CAU_CD1
            ,CAU_NM1
            ,PHEN_CD1
            ,PHEN_NM1
            ,CAU_CD2
            ,CAU_NM2
            ,PHEN_CD2
            ,PHEN_NM2
            ,SA_ID
            ,SA_NM
            ,PRSN_ID
            ,PRSN_NM
            ,SER_PAR_DSTIN_CD
            ,CUST_TP
            ,ETC_DC_CD
            ,ETC_DC_SEQ
            ,CALC_PRINT_DT
            ,CALC_CANC_REASON_CONT
            ,CALC_CANC_REASON_CD
            ,CALC_COMP_USR_ID
            ,CALC_COMP_USR_NM
            ,LBR_BM_CUPN_USE_AMT
            ,PAR_BM_CUPN_USE_AMT
            ,ETC_BM_CUPN_USE_AMT
            ,BM_CUPN_TOT_AMT
            ,LAN_BIN_CARD_NO    --结算取消时，粉丝数据  贾明  2020-6-5 start
			,LAN_BIN_CARD_TYPE
			,LAN_BIN_USE_NOTICE 
			,LAN_BIN_CARD_NAME 
			,LAN_BIN_CARD_AMOUNT 
			,LAN_BIN_COUPON_CLAIM 
			,LAN_BIN_COUPON_ADJU 
			,CARD_ADJUST
			,LAN_BIN_CARD_EFFE_DT
			,COUPON_WRITE 
			,COUPON_VOID  --结算取消时，粉丝数据  贾明  2020-6-5 start
        FROM SE_0500T
        WHERE DLR_CD = #{dlrCd}
        AND CALC_DOC_NO = #{calcDocNo}
    </insert>

    <!-- 정산현황 토탈금액 조회 -->
    <select id="selectCalculateAmtByCondition" parameterType="CalculateSearchVO" resultType="CalculateVO">
        SELECT CALC_AMT, CALC_CANC_TOT_AMT, (CALC_AMT - CALC_CANC_TOT_AMT) AS CALC_TOT_AMT
          FROM (
            SELECT NVL(SUM(CASE WHEN CALC_STAT_CD != '07' THEN PAYM_AMT END), 0) AS CALC_AMT
                    ,NVL(SUM(CASE WHEN CALC_STAT_CD = '07' THEN PAYM_AMT END), 0) AS CALC_CANC_TOT_AMT
              FROM (
                    SELECT PAYM_AMT, REG_USR_NM, RO_DT, CALC_STAT_CD
                      FROM (
                        SELECT
                           (SELECT SUM(NVL(PAYM_AMT,0))
                              FROM SE_0530T
                             WHERE DLR_CD = A.DLR_CD
                               AND CALC_DOC_NO = A.CALC_DOC_NO ) AS PAYM_AMT
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = A.DLR_CD) AS RO_USR_NM
                            ,B.RO_DT
                            ,A.CALC_STAT_CD
                        FROM SE_0500T A, SE_0300T B
                        WHERE A.DLR_CD    = B.DLR_CD
                        AND A.RO_DOC_NO = B.RO_DOC_NO
                        AND A.RO_TP     = B.RO_TP
                        AND A.DLR_CD    =  #{sDlrCd}
                        <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                            AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                        </if>
                        <if test='sRoDocNo != null and sRoDocNo != ""'>
                            AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                        </if>
                        <if test='sRoTp != null and sRoTp != ""'>
                            AND A.RO_TP =  #{sRoTp}
                        </if>
                        <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                           <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                               #{item}
                           </foreach>
                        </if>
                        <if test='sCarRegNo != null and sCarRegNo != ""'>
                            AND A.CAR_REG_NO LIKE '%'|| #{sCarRegNo}||'%'
                        </if>
                        <if test='sVinNo != null and sVinNo != ""'>
                            AND A.VIN_NO = #{sVinNo}
                        </if>
                        <if test='sDriverNm != null and sDriverNm != ""'>
                            AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                        </if>
                        <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                            AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                        </if>
                        <if test='sCalcFromDt != null'>
                            AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcFromDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcToDt != null'>
                            AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcToDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcRegFromDt != null'>
                            AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcRegFromDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcRegToDt != null'>
                            AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcRegToDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                            AND A.CALC_STAT_CD = #{sCalcStatCd}
                        </if>
                        <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                            AND A.CALC_CANC_YN = #{sCalcCancYn}
                        </if>
                        <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                            AND B.DLR_RO_TP =  #{sDlrRoTp}
                        </if>
                        AND A.VIN_NO IS NOT NULL
                        AND A.CALC_STAT_CD NOT IN ('03', '04')
                ) F1
                <where>
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND F1.REG_USR_NM = #{sRegUsrNm}
                    </if>
                    <if test='sRoFromDt != null'>
                        AND TO_CHAR(F1.RO_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sRoFromDt}, 'YYYYMMDD')
                    </if>
                    <if test='sRoToDt != null'>
                        AND TO_CHAR(F1.RO_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sRoToDt}, 'YYYYMMDD')
                    </if>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND F1.RO_USR_NM LIKE '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
            ) F2
        ) F3
    </select>

     <!-- 부품판매 정보를 정산처리한다. -->
    <update id="updateCalculateInfo" parameterType="CalculatePartsSaleOrdVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updateCalculateInfo] */
        UPDATE DMSDB.PT_0521T A    --부품판매헤더정보
          SET  CALC_DOC_NO        = #{calcDocNo}        --정산번호
              ,ORD_STAT_CD        = #{ordStatCd}        --상태
              ,UPDT_USR_ID        = #{regUsrId}         --수정자ID
              ,UPDT_DT            = sysdate
         WHERE DLR_CD             = #{dlrCd}            --딜러코드
           AND PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </update>

    <!-- 부품판매 부품 정보(DC_RATE)를 수정한다. -->
    <update id="updatePartsSaleOrdItemDcRate" parameterType="ServicePartVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updatePartsSaleOrdItemDcRate] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               DC_RATE           = round(NVL(#{dcRate},0),2)  --할인율
              ,DC_AMT            = round(NVL(#{dcAmt},0),2)   --할인금액
              ,UPDT_USR_ID       = #{regUsrId}  --수정자ID
              ,UPDT_DT           = sysdate      --수정일자
         WHERE DLR_CD            = #{dlrCd}     --딜러코드
           AND PAR_SALE_ORD_NO  = #{purcOrdNo}  --구매오더번호
           AND GI_STRGE_CD      = #{giStrgeCd}  --출고창고
           AND ITEM_CD          = #{itemCd}     --품목번호
    </update>

    <!-- 부품판매 부품 정보(DC_RATE)를 전체 수정한다.(취소 시  할인율 0) -->
    <update id="updatePartsSaleOrdItemDcRateCancel" parameterType="CalculatePartsSaleOrdVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updatePartsSaleOrdItemDcRateCancel] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               DC_RATE           = 0  --할인율
              ,DC_AMT            = 0  --할인금액
              ,UPDT_USR_ID       = #{regUsrId}  --수정자ID
              ,UPDT_DT           = sysdate      --수정일자
         WHERE DLR_CD            = #{dlrCd}     --딜러코드
           AND PAR_SALE_ORD_NO  = #{parSaleOrdNo}  --구매오더번호
    </update>

    <!-- 부품판매 부품 정보(DC_RATE)를 전체 수정한다.(취소 시  할인율 0) -->
    <update id="updateReturnPartsSaleOrdItemDcRateCancel" parameterType="CalculatePartsSaleOrdVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.updateReturnPartsSaleOrdItemDcRateCancel] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               DC_RATE           = 0  --할인율
              ,DC_AMT            = 0  --할인금액
              ,UPDT_USR_ID       = #{regUsrId}  --수정자ID
              ,UPDT_DT           = sysdate      --수정일자
         WHERE DLR_CD            = #{dlrCd}     --딜러코드
           AND REF_DOC_NO        = #{parSaleOrdNo}  --구매오더번호
    </update>
    
    <!-- 查询结算单及卡券信息进行卡券核销操作 -->
    <select id="selectFmsCardInfoById" parameterType="calculateVO" resultType="CalculateFmsCardVO">
    /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO."selectFmsCardInfoById"] */
    SELECT LAN_BIN_CARD_NO 		 	--卡券编号
    ,DLR_CD 						--经销商id
    ,VIN_NO                         --vin_no
    ,RO_DOC_NO        				--维修委托单号
    ,CALC_DOC_NO                    --服务结算单
    ,COUPON_WRITE					--是否已核销  "Y" 是  null 否
    FROM SE_0500T 
    WHERE DLR_CD        =  #{dlrCd}
    AND CALC_DOC_NO 	=  #{calcDocNo}
    </select>
    
    <!-- 卡券核销修改状态 -->
    <update id="UpdateCouponWrite" parameterType="CalculatePartsSaleOrdVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.UpdateCouponWrite] */
        UPDATE DMSDB.SE_0500T
          SET
               COUPON_WRITE      = #{couponWrite}
              ,UPDT_DT           = SYSDATE      
         WHERE DLR_CD            = #{dlrCd}    
           AND RO_DOC_NO         = #{roDocNo}
           AND CALC_DOC_NO 	     = #{calcDocNo}
    </update>
</mapper>