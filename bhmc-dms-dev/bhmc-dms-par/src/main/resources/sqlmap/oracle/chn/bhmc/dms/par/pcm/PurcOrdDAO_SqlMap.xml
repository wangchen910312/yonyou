<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : PurcOrdDAO_SqlMap.xml
    Description : 구매요청.
    author In Bo Shim
    since 2016. 1. 29.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 01. 29.     In Bo Shim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO">

    <!-- 구매오더 헤더 정보를 추가한다. -->
    <insert id="insertPurcOrd" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.insertPurcOrd] */
        INSERT INTO DMSDB.PT_0421T    --구매오더헤더정보
        (
          DLR_CD                  --딜러코드
         ,PURC_ORD_NO             --구매오더정보
         ,PURC_ORD_TP             --구매오더유형
         ,TRSF_TP                 --운송유형
         ,PURC_ORD_STAT_CD        --구매오더상태코드
         ,PLT_CD                  --센터코드
         ,BP_CD                   --거래처코드
         ,DLR_ORD_NO
         ,BMP_ORD_NO
         ,PURC_REG_DT             --구매등록일자
         ,REMARK                  --비고
         ,REG_USR_ID              --등록자ID
         ,REG_DT                  --등록일자
         ,UPDT_USR_ID
         ,UPDT_DT
         ,CO_PACK
        )
        VALUES
        (
          #{dlrCd}                  --딜러코드
         ,#{purcOrdNo}              --구매오더정보
         ,#{purcOrdTp}              --구매오더유형
         ,#{trsfTp}                 --운송유형
         ,#{purcOrdStatCd}          --구매오더상태코드
         ,#{pltCd}                  --센터코드
         ,#{bpCd}                   --거래처코드
         ,#{dlrOrdNo}              --딜러구매번호
         ,#{bmpOrdNo}             --아모스구매번호
         ,sysdate                   --구매등록일자
         ,#{remark}                 --비고
         ,#{regUsrId}               --등록자ID
         ,sysdate                   --등록일자
         ,#{regUsrId}               --등록자ID
         ,sysdate                   --등록일자
         ,#{coPack}
        )
    </insert>

    <!-- 구매오더 부품 정보를 추가한다. -->
    <insert id="insertPurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.insertPurcOrdItem] */
        INSERT INTO DMSDB.PT_0422T    --구매오더품목정보
            (
              DLR_CD                   --딜러코드
             ,PURC_ORD_NO              --구매오더번호
             ,PURC_ORD_LINE_NO         --구매오더라인번호
             ,PURC_ORD_LINE_DETL_NO   --구매오더라인 구분자
             ,PURC_ITEM_STAT_CD        --구매품목상태코드
             ,PURC_ITEM_TP             --구매품목유형
             ,DEL_YN                   --삭제여부
             ,GR_END_YN                --입고완료여부
             ,ITEM_CD                  --품목코드
             ,PURC_QTY                 --구매수량
             ,CONFIRM_QTY              --확정수량
             ,RESV_QTY                 --예약수량
             ,PURC_UNIT_CD             --구매단위코드
             ,PRC_TP                   --가격유형
             ,PURC_PRC                 --구매단가
             ,PURC_AMT                 --구매금액
             ,PURC_REQ_DT              --구매요청일자
             ,GR_STRGE_CD              --입고창고코드
             ,PURC_REQ_NO               --참조문서번호
             ,PURC_REQ_LINE_NO          --참조문서라인번호
             ,BMP_ORD_NO
             ,BMP_ORD_LINE_NO
             ,BMP_ORD_LINE_DETL_NO
             ,TAX_DDCT_PRC
             ,TAX_DDCT_AMT
             ,TAX_AMT
             ,REG_USR_ID               --등록자ID
             ,REG_DT                   --등록일자
             ,UPDT_USR_ID
             ,UPDT_DT
            )
            VALUES
            (
              #{dlrCd}                   --딜러코드
             ,#{purcOrdNo}               --구매오더번호
             ,LPAD(#{purcOrdLineNo},4,'0')           --구매오더라인번호
             ,#{purcOrdLineDetlNo}      --구매오더라인구분자
             ,#{purcItemStatCd}          --구매품목상태코드
             ,#{purcItemTp}              --구매품목유형
             ,#{delYn}                   --삭제여부
             ,#{grEndYn}                 --입고완료여부
             ,#{itemCd}                  --품목코드
             ,#{purcQty}                 --구매수량
             ,#{confirmQty}              --확정수량
             ,#{resvQty}                 --예약수량
             ,#{purcUnitCd}              --구매단위코드
             ,#{prcTp}                   --가격유형
             ,round(#{purcPrc},2)        --구매단가
             ,round(#{purcAmt},2)        --구매금액
             ,#{purcReqDt}               --구매요청일자
             ,#{grStrgeCd}               --입고창고코드
             ,#{purcReqNo}               --구매요청번호
             ,#{purcReqLineNo}           --구매요청라인번호
             ,#{bmpOrdNo}                --아모스 구매오더번호
             ,LPAD(#{bmpOrdLineNo},4,'0')   --아모스구매라인번호
             ,#{bmpOrdLineDetlNo}           --아모스구매구분자
             ,round(nvl(#{taxDdctPrc},0),2) --구매단가(세금제외)
             ,round(nvl(#{taxDdctAmt},0),2) --구매금액(세금제외)
             ,round(nvl(#{taxAmt},0),2)  --세금액
             ,#{regUsrId}                --등록자ID
             ,sysdate                    --등록일자
             ,#{regUsrId}                --등록자ID
             ,sysdate                    --등록일자
            )
    </insert>

    <!-- 구매오더 반품 부품 정보를 추가한다. -->
    <insert id="insertReturnPurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.insertReturnPurcOrdItem] */
        INSERT INTO DMSDB.PT_0424T    --로컬구매오더반품정보
        (
          DLR_CD                       --딜러코드
         ,PURC_ORD_NO                  --구매오더번호
         ,PURC_ORD_LINE_NO             --구매오더라인번호
         ,PURC_ORD_LINE_DETL_NO        --구매오더라인상세번호
         ,BP_CD                        --거래처코드
         ,DEL_YN                       --삭제여부
         ,ITEM_CD                      --품목코드
         ,PURC_QTY                     --구매수량
         ,PURC_UNIT_CD                 --구매단위코드
         ,PURC_PRC                     --구매단가
         ,PURC_TAX_INCL_PRC            --구매세금포함단가
         ,PURC_AMT                     --구매금액
         ,PURC_TAX_INCL_AMT            --구매세금포함금액
         ,PURC_REG_DT                  --구매등록일자
         ,PURC_RETURN_DT               --반품일자
         ,RETURN_QTY                   --반품수량
         ,REMARK                       --비고
         ,REG_USR_ID                   --등록자ID
         ,REG_DT                       --등록일자
        )
        VALUES
        (
          #{dlrCd}                       --딜러코드
         ,#{purcOrdNo}                   --구매오더번호
         ,#{purcOrdLineNo}               --구매오더라인번호
         ,#{purcOrdLineDetlNo}           --구매오더라인상세번호
         ,#{bpCd}                        --거래처코드
         ,#{delYn}                       --삭제여부
         ,#{itemCd}                      --품목코드
         ,#{purcQty}                     --구매수량
         ,#{purcUnitCd}                  --구매단위코드
         ,round(#{purcPrc},2)            --구매단가
         ,round(#{taxDdctPrc},2)         --구매세금제외단가
         ,round(#{purcAmt},2)            --구매금액
         ,round(#{taxDdctAmt},2)         --구매세금제외금액
         ,#{purcRegDt}                   --구매등록일자
         ,sysdate                        --구매반품일자
         ,#{returnQty}                   --반품수량
         ,#{remark}                      --비고
         ,#{regUsrId}                    --등록자ID
         ,sysdate                        --등록일자
        )
    </insert>

    <!-- 구매오더 반품 부품 정보를 수정한다. -->
    <update id="updateReturnPurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.updateReturnPurcOrdItem] */
        UPDATE DMSDB.PT_0424T    --로컬구매오더반품정보
        SET
               RETURN_QTY        = #{returnQty}              --반품수량
              ,REMARK            = #{remark}                 --비고
              ,UPDT_USR_ID       = #{regUsrId}               --수정자ID
              ,UPDT_DT           = sysdate
       WHERE   DLR_CD            = #{dlrCd}                  --딜러코드
         AND   PURC_ORD_NO       = #{purcOrdNo}              --구매오더번호
         AND   PURC_ORD_LINE_NO  = #{purcOrdLineNo}          --구매오더라인번호
         AND   BP_CD             = #{bpCd}                   --거래처코드
    </update>

    <!-- 구매오더 반품 부품 정보를 삭제한다. -->
    <delete id="deleteReturnPurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.deleteReturnPurcOrdItem] */
      DELETE FROM DMSDB.PT_0424T    --로컬구매오더반품정보
       WHERE   DLR_CD            = #{dlrCd}                  --딜러코드
         AND   PURC_ORD_NO       = #{purcOrdNo}              --구매오더번호
         AND   PURC_ORD_LINE_NO  = #{purcOrdLineNo}          --구매오더라인번호
         AND   BP_CD             = #{bpCd}                   --거래처코드
    </delete>

    <!-- 구매오더 헤더 정보를 수정한다. -->
    <update id="updatePurcOrd" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.updatePurcOrd] */
        UPDATE DMSDB.PT_0421T    --구매오더헤더정보
          SET
               TRSF_TP          = #{trsfTp}                --운송유형
              ,TOT_PURC_AMT     = #{totPurcAmt}            --총구매금액
              ,REMARK           = #{remark}                --비고
              ,UPDT_USR_ID      = #{regUsrId}              --수정자ID
              ,UPDT_DT          = sysdate
                <if test='coPack!=null and coPack!="" and coPack!=" "'>
                     ,CO_PACK  = #{coPack}
                </if>
                <if test='coPack == ""'>
                     ,CO_PACK  = NULL
                </if>
         WHERE DLR_CD           = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO      = #{purcOrdNo}              --구매오더정보
    </update>

    <!-- 구매오더 부품 정보를 수정한다. -->
    <update id="updatePurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.updatePurcOrdItem] */
        UPDATE DMSDB.PT_0422T    --구매오더품목정보
          SET
               PURC_QTY          = #{purcQty}                 --구매수량
              ,RESV_QTY          = #{resvQty}                 --예약수량
              ,PRC_TP            = #{prcTp}                   --가격유형
              ,PURC_PRC          = round(#{purcPrc},2)        --구매단가
              ,PURC_AMT          = round(#{purcAmt},2)        --구매금액
              ,TAX_DDCT_PRC      = round(#{taxDdctPrc},2)     --구매금액
              ,TAX_DDCT_AMT      = round(#{taxDdctAmt},2)     --구매금액
              ,TAX_AMT           = round(#{taxAmt},2)         --구매금액
              ,PURC_REQ_DT       = #{purcReqDt}               --납품요청일자
              ,GR_STRGE_CD       = #{grStrgeCd}               --입고창고코드
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PURC_ORD_NO       = #{purcOrdNo}               --구매오더번호
           AND PURC_ORD_LINE_NO  = #{purcOrdLineNo}           --구매오더라인번호
           AND NVL(TRIM(PURC_ORD_LINE_DETL_NO),'-999')  = NVL(TRIM(#{purcOrdLineDetlNo}),'-999')           --구매오더라인번호
    </update>

    <!-- 구매오더헤더를 전송한다. -->
    <update id="sendPurcOrd" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.sendPurcOrd] */
        UPDATE DMSDB.PT_0421T    --구매오더헤더정보
          SET
               PURC_ORD_STAT_CD = #{purcOrdStatCd}          --구매오더상태코드
              ,SEND_DT          = sysdate                   --전송일자
              ,REMARK           = #{remark}                 --비고
              ,UPDT_USR_ID      = #{regUsrId}               --수정자ID
              ,UPDT_DT          = sysdate
         WHERE DLR_CD           = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO      = #{purcOrdNo}              --구매오더정보
    </update>

    <!-- 구매오더 부품 정보를 전송한다.(해당 구매번호의 모든 부품을 한번에 상태변경한다) -->
    <update id="sendPurcOrdItem" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.sendPurcOrdItem] */
        UPDATE DMSDB.PT_0422T    --구매오더품목정보
          SET
               PURC_ITEM_STAT_CD = #{purcItemStatCd}          --구매품목상태코드
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PURC_ORD_NO       = #{purcOrdNo}               --구매오더번호
    </update>

    <!-- 구매오더헤더를 취소한다.(구매취소 시 헤더만 수정한다.) -->
    <update id="cancelPurcOrd" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.cancelPurcOrd] */
        UPDATE DMSDB.PT_0421T    --구매오더헤더정보
          SET
               PURC_ORD_STAT_CD = #{purcOrdStatCd}          --구매오더상태코드
              ,CANC_DT          = sysdate                   --취소일자
              ,REMARK           = #{remark}                 --비고
              ,UPDT_USR_ID      = #{regUsrId}               --수정자ID
              ,UPDT_DT          = sysdate
         WHERE DLR_CD           = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO      = #{purcOrdNo}              --구매오더정보
           AND PURC_ORD_STAT_CD IN ('01', '03')              --확정상태의 구매오더
    </update>

    <!-- 구매오더 부품 정보를 삭제한다. -->
    <delete id="deletePurcOrdItem" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.deletePurcOrdItem] */
        DELETE FROM DMSDB.PT_0422T    --구매오더품목정보
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PURC_ORD_NO       = #{purcOrdNo}               --구매오더번호
           AND PURC_ORD_LINE_NO  = #{purcOrdLineNo}           --구매오더라인번호
           AND NVL(TRIM(PURC_ORD_LINE_DETL_NO),'-999')  = NVL(TRIM(#{purcOrdLineDetlNo}),'-999')           --구매오더라인번호
    </delete>

    <!-- 구매오더헤더를 확정한다. -->
    <update id="confirmPurcOrd" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.confirmPurcOrd] */
        UPDATE DMSDB.PT_0421T    --구매오더헤더정보
          SET
               PURC_ORD_STAT_CD = #{purcOrdStatCd}          --구매오더상태코드
              ,CONFIRM_DT       = sysdate                   --확정일자
              ,REMARK           = #{remark}                 --비고
              ,UPDT_USR_ID      = #{regUsrId}               --수정자ID
              ,UPDT_DT          = sysdate
         WHERE DLR_CD           = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO      = #{purcOrdNo}              --구매오더정보
    </update>

    <!-- 구매오더 부품 정보를 확정한다.(해당 구매번호의 모든 부품을 한번에 상태변경한다) -->
    <update id="confirmPurcOrdItem" parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.confirmPurcOrdItem] */
        UPDATE DMSDB.PT_0422T    --구매오더품목정보
          SET
               PURC_ITEM_STAT_CD = '03'          --구매품목상태코드
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PURC_ORD_NO       = #{purcOrdNo}               --구매오더번호
           AND PURC_ITEM_STAT_CD = '01'                       --저장 상태의 구매오더
    </update>

     <!-- 로컬구매오더헤더를 완료한다. -->
    <update id="invcRegLocalPurcOrd"  parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.invcRegLocalPurcOrd] */
        UPDATE DMSDB.PT_0421T    --구매오더헤더정보
          SET
               PURC_ORD_STAT_CD = '04'          --구매오더상태코드
              ,END_DT           = sysdate                   --완료일자
              ,UPDT_USR_ID      = #{regUsrId}               --수정자ID
              ,UPDT_DT          = sysdate
         WHERE DLR_CD           = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO      = #{purcOrdNo}              --구매오더정보
           AND BP_CD            = #{bpCd}                   --업체
           AND PURC_ORD_STAT_CD = '03'                      --확정 상태의 구매오더
    </update>

     <!-- 로컬구매오더품목정보를 완료한다. -->
    <update id="invcRegLocalPurcOrdItem"  parameterType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.invcRegLocalPurcOrdItem] */
        UPDATE DMSDB.PT_0422T    --구매오더헤더정보
          SET
               PURC_ITEM_STAT_CD = '04'         --구매오더상태코드
              ,UPDT_USR_ID       = #{regUsrId}               --수정자ID
              ,UPDT_DT           = sysdate
         WHERE DLR_CD            = #{dlrCd}                  --딜러코드
           AND PURC_ORD_NO       = #{purcOrdNo}              --구매오더정보
           AND PURC_ITEM_STAT_CD = '03'                      --구매오더상태코드
    </update>


    <!-- 구매오더 헤더 정보를 조회한다. -->
    <select id="selectPurcOrdByKey" parameterType="PurcOrdSearchVO" resultType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdByKey] */
        SELECT
                A.DLR_CD                  --딜러코드
               ,A.PURC_ORD_NO             --구매오더정보
               ,A.PURC_ORD_TP             --구매오더유형
               ,A.TRSF_TP                 --운송유형
               ,A.PURC_ORD_STAT_CD        --구매오더상태코드
               ,A.PLT_CD                  --센터코드
               ,A.BP_CD                   --거래처코드
               ,B.BP_NM                   --거래처명
               ,B.BP_TP                   --거래처유형
               ,A.PURC_REG_DT             --구매등록일자
               ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN A.TOT_PURC_AMT
                ELSE C.ITEM_AMT
                END TOT_PURC_AMT            --총구매금액
               ,C.ITEM_TAX_DDCT_AMT AS TOT_TAX_DDCT_AMT --총구매금액
               ,A.SEND_DT                 --전송일자
               ,A.CONFIRM_DT              --확정일자
               ,A.END_DT                  --완료일자
               ,A.CANC_DT                 --취소일자
               ,A.REMARK                  --비고
               ,NVL(A.PURC_PAR_CNT,C.ITEM_CNT) AS PURC_PAR_CNT
               ,NVL(A.PURC_PAR_QTY,C.ITEM_QTY) AS PURC_PAR_QTY
               ,NVL(A.PURC_PAR_AMT,C.ITEM_AMT) AS PURC_PAR_AMT
               --,NVL(C.ITEM_AMT,0) AS TOT_PURC_AMT
               --,NVL(C.ITEM_TAX_DDCT_AMT,0) AS TOT_TAX_DDCT_AMT
               ,A.CONFIRM_PAR_CNT
               ,A.CONFIRM_PAR_QTY
               ,A.CONFIRM_PAR_AMT
               ,A.PGSS_PAR_CNT
               ,A.PGSS_PAR_QTY
               ,A.PGSS_PAR_AMT
               ,A.CANC_PAR_CNT
               ,A.CANC_PAR_QTY
               ,A.CANC_PAR_AMT
               ,A.BO_PAR_CNT
               ,A.BO_PAR_QTY
               ,A.BO_PAR_AMT
               ,A.SHIP_PAR_CNT
               ,A.SHIP_PAR_QTY
               ,A.SHIP_PAR_AMT
               ,A.REG_USR_ID              --등록자ID
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
               ,A.REG_DT                  --등록일자
               ,A.UPDT_USR_ID             --수정자ID
               ,A.UPDT_DT                 --수정일자
               ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
               ,A.CO_PACK
          FROM DMSDB.PT_0421T A    --구매오더헤더정보
               INNER JOIN DMSDB.PT_0211T B
                 ON A.DLR_CD = B.DLR_CD
                AND A.BP_CD  = B.BP_CD
               LEFT OUTER JOIN (
                     SELECT   DLR_CD
                             ,PURC_ORD_NO
                             ,COUNT(*) AS ITEM_CNT
                             ,SUM(NVL(PURC_QTY,0)) AS ITEM_QTY
                             ,SUM(NVL(TAX_DDCT_AMT,0)) AS ITEM_TAX_DDCT_AMT
                             ,SUM(NVL(PURC_AMT,0)) AS ITEM_AMT
                       FROM   DMSDB.PT_0422T
                      WHERE   DLR_CD = #{sDlrCd}
                        AND   PURC_ITEM_STAT_CD != '05'
                        AND   DEL_YN != 'Y'
                      GROUP BY DLR_CD
                              ,PURC_ORD_NO
                 ) C
                 ON A.DLR_CD      = C.DLR_CD
                AND A.PURC_ORD_NO = C.PURC_ORD_NO
         WHERE A.DLR_CD           = #{sDlrCd}        --딜러코드
           AND A.PURC_ORD_NO      = #{sPurcOrdNo}    --구매오더정보
    </select>

    <!-- 구매오더 부품 정보를 조회한다. -->
    <select id="selectPurcOrdItemByKey" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdItemByKey] */
        SELECT
            T1.*
        FROM (
            SELECT
                B.DLR_CD                   --딜러코드
                ,B.PURC_ORD_NO              --구매오더번호
                ,B.PURC_ORD_LINE_NO         --구매오더라인번호
                ,B.BMP_ORD_NO               --BMP구매오더번호
                ,B.BMP_ORD_LINE_NO              --구매오더라인번호
                ,B.PURC_ITEM_STAT_CD        --구매품목상태코드
                ,B.PURC_ITEM_TP             --생성유형
                ,B.DEL_YN                   --삭제여부
                ,B.GR_END_YN                --입고완료여부
                ,B.ITEM_CD                  --품목코드
                ,C.ITEM_NM                  --품목명
                ,B.PURC_QTY                 --구매수량
                ,NVL(B.RESV_QTY,0) AS RESV_QTY  --예약수량
                ,B.PURC_UNIT_CD             --구매단위코드
                ,B.PRC_TP                   --가격유형
                ,B.PURC_PRC                 --구매단가
                ,B.PURC_AMT                 --구매금액
                ,B.TAX_DDCT_PRC             --구매단가(세전)
                ,B.TAX_DDCT_AMT             --구매금액(세전)
                ,B.PURC_REQ_DT              --납기요청일자
                ,B.GR_STRGE_CD              --입고창고코드
                ,B.GR_QTY                   --입고수량
                ,B.PURC_REQ_NO              --구매요청번호
                ,B.PURC_REQ_LINE_NO         --구매요청라인번호
                ,B.BMP_ORD_NO               --BMP오더번호
                ,B.BMP_CHK_QTY              --BMP확인수량
                ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0
                         THEN CASE WHEN A.PURC_ORD_STAT_CD = '05'
                             THEN B.PURC_QTY
                             ELSE 0 END
                         ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY                --취소수량
                ,C.PURC_LEAD_HM            --구매리드타임
                ,D.REG_USR_ID AS PURC_REQ_REG_USR_ID              --구매요청등록자ID
                ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = D.REG_USR_ID) AS PURC_REQ_REG_USR_NM   --구매요청등록자명
                ,NVL(D.PURC_REQ_QTY,0) AS PURC_REQ_QTY
                ,NVL(C.MIN_PACK_QTY,1) AS MIN_PACK_QTY         --최소포장수량
                ,CASE WHEN NVL(C.MIN_PURC_QTY,1) = 0 THEN 1 ELSE NVL(C.MIN_PURC_QTY,1) END  MIN_PURC_QTY         --최소구매수량
                ,NVL(E.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY     --가용재고
                ,NVL(E.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY     --예류재고
                ,NVL(E.BORROW_QTY,0) AS BORROW_QTY             --차입
                ,NVL(E.RENT_QTY,0) AS RENT_QTY                 --대여수량
                ,NVL(E.AVLB_STOCK_QTY,0) + NVL(E.RESV_STOCK_QTY,0) - NVL(E.BORROW_QTY,0) + NVL(E.RENT_QTY,0) AS STOCK_QTY
                ,TO_CHAR(B.REG_DT,'YYYY-MM-DD HH24:MI:SS') AS PURC_REG_DTTM_STR
                ,TO_CHAR(A.SEND_DT,'YYYY-MM-DD HH24:MI:SS') AS PURC_SEND_DTTM_STR
                ,B.EDIT_CD
                ,NVL(C.PAR_SPEC_CD,' ') AS PAR_SPEC_CD
                ,NVL(C.SUC_CD,' ') as SUC_CD
            FROM DMSDB.PT_0421T A --구매오더헤더정보
            INNER JOIN DMSDB.PT_0422T B ON A.DLR_CD = B.DLR_CD AND A.PURC_ORD_NO = B.PURC_ORD_NO --구매오더품목정보
            INNER JOIN DMSDB.PT_0201T C ON B.DLR_CD = C.DLR_CD AND B.ITEM_CD = C.ITEM_CD --품목정보
            LEFT JOIN PT_0411T D ON B.DLR_CD = D.DLR_CD AND B.PURC_REQ_NO = D.PURC_REQ_NO AND B.ITEM_CD = D.ITEM_CD --구매요청정보
            LEFT JOIN PT_0301T E ON B.DLR_CD = E.DLR_CD AND B.ITEM_CD = E.ITEM_CD AND B.GR_STRGE_CD = E.STRGE_CD
            WHERE B.DLR_CD = #{sDlrCd} --딜러코드
            AND B.PURC_ORD_NO = #{sPurcOrdNo}    --구매오더번호
        ) T1
        ORDER BY
        <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "purcOrdLineNo"'> T1.PURC_ORD_LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "itemCd"'> T1.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "itemNm"'> T1.ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcQty"'> T1.PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcPrc"'> T1.PURC_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "taxDdctPrc"'> T1.TAX_DDCT_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcAmt"'> T1.PURC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "taxDdctAmt"'> T1.TAX_DDCT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "minPurcQty"'> T1.MIN_PACK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcUnitCd"'> T1.PURC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "cancQty"'> T1.CANC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "stockQty"'> T1.STOCK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "avlbStockQty"'> T1.AVLB_STOCK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "resvStockQty"'> T1.RESV_STOCK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "rentQty"'> T1.RENT_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "borrowQty"'> T1.BORROW_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcRegDttmStr"'> T1.PURC_REG_DTTM_STR <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcSendDttmStr"'> T1.PURC_SEND_DTTM_STR <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "editCd"'> T1.EDIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                T1.DLR_CD ASC
                ,T1.PURC_ORD_NO ASC
                ,T1.PURC_ORD_LINE_NO ASC
            </otherwise>
        </choose>
    </select>

    <!-- 구매오더 반품 부품 정보를 조회한다. -->
    <select id="selectReturnPurcOrdItemByKey" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectReturnPurcOrdItemByKey] */
         SELECT
                A.DLR_CD                       --딜러코드
               ,A.PURC_ORD_NO                  --구매오더번호
               ,A.PURC_ORD_LINE_NO             --구매오더라인번호
               ,A.PURC_ORD_LINE_DETL_NO        --구매오더라인상세번호
               ,A.BP_CD                        --거래처코드
               ,A.DEL_YN                       --삭제여부
               ,A.ITEM_CD                      --품목코드
               ,B.ITEM_NM                      --품목명
               ,A.PURC_QTY                     --구매수량
               ,A.PURC_UNIT_CD                 --구매단위코드
               ,A.PURC_PRC                     --구매단가
               ,A.PURC_TAX_INCL_PRC AS TAX_DDCT_AMT           --구매세금제외
               ,A.PURC_AMT                     --구매금액
               ,A.PURC_TAX_INCL_AMT AS TAX_DDCT_AMT            --구매금액세금제외
               ,A.PURC_REG_DT                  --구매등록일자
               ,A.PURC_RETURN_DT               --구매반품일자
               ,A.RETURN_QTY                   --반품수량
               ,A.REMARK                       --비고
               ,A.REG_USR_ID                   --등록자ID
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
               ,A.REG_DT                       --등록일자
               ,A.UPDT_USR_ID                  --수정자ID
               ,A.UPDT_DT                      --수정일자
          FROM DMSDB.PT_0424T A    --로컬구매오더반품정보
               INNER JOIN  DMSDB.PT_0201T B    --품목정보
                     ON A.DLR_CD  = B.DLR_CD
                    AND A.ITEM_CD = B.ITEM_CD
          WHERE  A.DLR_CD            = #{sDlrCd}        --딜러코드
            AND  A.PURC_ORD_NO       = #{sPurcOrdNo}    --구매오더번호
            AND  A.DEL_YN != 'Y'
         ORDER BY
                  A.DLR_CD ASC
                 ,A.PURC_ORD_NO ASC
                 ,A.PURC_ORD_LINE_NO ASC
    </select>

    <!-- 구매오더 부품 정보를 조회한다. -->
    <select id="selectPurcOrdItemCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdItemCondition] */
             SELECT B.DLR_CD                   --딜러코드
                   ,B.PURC_ORD_NO              --구매오더번호
                   ,B.PURC_ORD_LINE_NO         --구매오더라인번호
                   ,A.BP_CD                    --공급처
                   ,B.PURC_ITEM_STAT_CD        --구매품목상태코드
                   ,B.PURC_ITEM_TP             --생성유형
                   ,B.DEL_YN                   --삭제여부
                   ,B.GR_END_YN                --입고완료여부
                   ,B.ITEM_CD                  --품목코드
                   ,C.ITEM_NM                  --품목명
                   ,B.PURC_QTY                 --구매수량
                   ,B.RESV_QTY                 --예약수량
                   ,B.PURC_UNIT_CD             --구매단위코드
                   ,B.PRC_TP                   --가격유형
                   ,B.PURC_PRC                  --구매단가
                   ,B.PURC_AMT                 --구매금액
                   ,B.TAX_DDCT_PRC             --구매단가(세전)
                   ,B.TAX_DDCT_AMT             --구매금액(세전)
                   ,A.PURC_REG_DT              --구매신청일자
                   ,B.PURC_REQ_DT              --납기요청일자
                   ,B.GR_STRGE_CD              --입고창고코드
                   ,B.GR_QTY                   --입고수량
                   ,B.PURC_REQ_NO              --구매요청번호
                   ,B.PURC_REQ_LINE_NO         --구매요청라인번호
                   ,B.BMP_ORD_NO               --BMP오더번호
                   ,B.BMP_CHK_QTY              --BMP확인수량
                   ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0
                           THEN CASE WHEN A.PURC_ORD_STAT_CD = '05'
                                       THEN B.PURC_QTY
                                     ELSE 0 END
                         ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY                --취소수량
                   ,C.PURC_LEAD_HM            --구매리드타임
                   ,A.REG_USR_ID              --구매등록자ID
                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
                   ,D.REG_USR_ID AS PURC_REQ_REG_USR_ID              --구매요청등록자ID
                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = D.REG_USR_ID) AS PURC_REQ_REG_USR_NM   --등록자명
                   ,D.PURC_REQ_QTY
                   ,C.MIN_PURC_QTY             --최소구매수량
                   ,NVL(E.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY     --가용재고
                   ,NVL(E.BORROW_QTY,0) AS BORROW_QTY             --차입
                   ,NVL(E.RENT_QTY,0) AS RENT_QTY                 --대여수량
                   ,NVL(E.AVLB_STOCK_QTY,0) + NVL(E.RESV_STOCK_QTY,0) - NVL(E.BORROW_QTY,0) + NVL(E.RENT_QTY,0) AS STOCK_QTY
              FROM  DMSDB.PT_0421T A                  --구매오더헤더정보
                      INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                         ON A.DLR_CD      = B.DLR_CD
                        AND A.PURC_ORD_NO = B.PURC_ORD_NO
                      INNER JOIN  DMSDB.PT_0201T C    --품목정보
                         ON B.DLR_CD  = C.DLR_CD
                        AND B.ITEM_CD = C.ITEM_CD
                      LEFT OUTER JOIN PT_0411T D      --구매요청정보
                         ON B.DLR_CD           = D.DLR_CD
                        AND B.PURC_REQ_NO      = D.PURC_REQ_NO
                        AND B.ITEM_CD          = D.ITEM_CD
                      LEFT OUTER JOIN PT_0301T E
                         ON B.DLR_CD           = E.DLR_CD
                        AND B.ITEM_CD          = E.ITEM_CD
                        AND B.GR_STRGE_CD      = E.STRGE_CD
             WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
               AND  B.DEL_YN != 'Y'
                   <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                       AND A.PURC_ORD_NO = #{sPurcOrdNo}
                   </if>        --구매오더정보
                   <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                       AND A.PURC_ORD_TP = #{sPurcOrdTp}
                   </if>        --구매오더유형
                   <if test='sTrsfTp != null and sTrsfTp != ""'>
                       AND A.TRSF_TP = #{sTrsfTp}
                   </if>        --운송유형
                   <if test='sBpCd != null and sBpCd != ""'>
                       AND A.BP_CD = #{sBpCd}
                   </if>        --운송유형
                   <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                       AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                   </if>        --구매오더상태코드
                   <if test='sPurcOrdStatLst  != null and !sPurcOrdStatLst.isEmpty'>
                       AND A.PURC_ORD_STAT_CD IN
                       <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                          #{item}
                       </foreach>
                   </if>        --구매오더상태코드
                   <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                       AND A.BP_CD IN
                       <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                          #{item}
                       </foreach>
                   </if>        --거래처코드
                   <if test='sPurcRegDtFr != null'>
                        AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                   </if>
                   <if test='sPurcRegDtTo != null'>
                        AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                   </if>
                   <if test='sRegUsrId != null and sRegUsrId != ""'>
                   AND A.REG_USR_ID = #{sRegUsrId}
                   </if>        --구매신청자
                   <if test='sReturnYn != null and sReturnYn = "Y"'>
                        AND (B.PURC_ORD_NO, B.PURC_ORD_LINE_NO) NOT IN (
                            SELECT   PURC_ORD_NO
                                    ,PURC_ORD_LINE_NO
                              FROM   PT_0424T
                             WHERE   DLR_CD  = #{sDlrCd}
                        )
                   </if>        --조회화면이 반품화면인 경우
          ORDER BY  B.DLR_CD ASC
                   ,B.PURC_ORD_NO ASC
                   ,B.PURC_ORD_LINE_NO ASC
    </select>

    <!-- 구매오더 부품 정보를 Count한다. -->
    <select id="selectPurcOrdItemConditionCnt" parameterType="PurcOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdItemConditionCnt] */
             SELECT COUNT(*)
              FROM  DMSDB.PT_0421T A                  --구매오더헤더정보
                      INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                         ON A.DLR_CD      = B.DLR_CD
                        AND A.PURC_ORD_NO = B.PURC_ORD_NO
                      INNER JOIN  DMSDB.PT_0201T C    --품목정보
                         ON B.DLR_CD  = C.DLR_CD
                        AND B.ITEM_CD = C.ITEM_CD
                      LEFT OUTER JOIN PT_0411T D      --구매요청정보
                         ON B.DLR_CD           = D.DLR_CD
                        AND B.PURC_REQ_NO      = D.PURC_REQ_NO
                        AND B.ITEM_CD          = D.ITEM_CD
                      LEFT OUTER JOIN PT_0301T E
                         ON B.DLR_CD           = E.DLR_CD
                        AND B.ITEM_CD          = E.ITEM_CD
                        AND B.GR_STRGE_CD      = E.STRGE_CD
             WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
               AND  B.DEL_YN != 'Y'
                   <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                       AND A.PURC_ORD_NO = #{sPurcOrdNo}
                   </if>        --구매오더정보
                   <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                       AND A.PURC_ORD_TP = #{sPurcOrdTp}
                   </if>        --구매오더유형
                   <if test='sTrsfTp != null and sTrsfTp != ""'>
                       AND A.TRSF_TP = #{sTrsfTp}
                   </if>        --운송유형
                   <if test='sBpCd != null and sBpCd != ""'>
                       AND A.BP_CD = #{sBpCd}
                   </if>        --운송유형
                   <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                       AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                   </if>        --구매오더상태코드
                   <if test='sPurcOrdStatLst  != null and !sPurcOrdStatLst.isEmpty'>
                       AND A.PURC_ORD_STAT_CD IN
                       <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                          #{item}
                       </foreach>
                   </if>        --구매오더상태코드
                   <if test='sBpCdList            != null and !sBpCdList.isEmpty'>
                       AND A.BP_CD IN
                       <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                          #{item}
                       </foreach>
                   </if>        --거래처코드
                   <if test='sPurcRegDtFr != null'>
                       AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                   </if>
                   <if test='sPurcRegDtTo != null'>
                       AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                   </if>
                   <if test='sRegUsrId != null and sRegUsrId != ""'>
                       AND A.REG_USR_ID = #{sRegUsrId}
                   </if>        --구매신청자
    </select>

    <!-- 반품 구매오더 부품 정보를 조회한다. -->
    <select id="selectReturnPurcOrdItemCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectReturnPurcOrdItemCondition] */
             SELECT
                        A.DLR_CD                       --딜러코드
                       ,A.PURC_ORD_NO                  --구매오더번호
                       ,A.PURC_ORD_LINE_NO             --구매오더라인번호
                       ,A.PURC_ORD_LINE_DETL_NO        --구매오더라인상세번호
                       ,A.BP_CD                        --거래처코드
                       ,C.BP_NM                        --거래처코드
                       ,A.DEL_YN                       --삭제여부
                       ,A.ITEM_CD                      --품목코드
                       ,B.ITEM_NM                      --품목코드
                       ,A.PURC_QTY                     --구매수량
                       ,A.PURC_UNIT_CD                 --구매단위코드
                       ,A.PURC_PRC                     --구매단가
                       ,A.PURC_TAX_INCL_PRC AS TAX_DDCT_PRC            --구매세금제외단가
                       ,A.PURC_AMT                     --구매금액
                       ,A.PURC_TAX_INCL_AMT AS TAX_DDCT_AMT            --구매세금제외금액
                       ,A.PURC_REG_DT                  --구매등록일자
                       ,A.PURC_RETURN_DT                  --구매등록일자
                       ,A.RETURN_QTY                   --반품수량
                       ,A.REMARK                       --비고
                       ,A.REG_USR_ID                   --등록자ID
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
                       ,A.REG_DT                       --등록일자
                       ,A.UPDT_USR_ID                  --수정자ID
                       ,A.UPDT_DT                      --수정일자
                       ,NVL(D.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY           --가용재고
                       ,NVL(D.BORROW_QTY,0) AS BORROW_QTY               --차입
                       ,NVL(D.RENT_QTY,0) AS RENT_QTY                 --대여수량
                       ,NVL(D.AVLB_STOCK_QTY,0) + NVL(D.RESV_STOCK_QTY,0) - NVL(D.BORROW_QTY,0) + NVL(D.RENT_QTY,0) AS STOCK_QTY
                  FROM DMSDB.PT_0424T A    --로컬구매오더반품정보
                      INNER JOIN  DMSDB.PT_0201T B    --품목정보
                         ON A.DLR_CD  = B.DLR_CD
                        AND A.ITEM_CD = B.ITEM_CD
                      INNER JOIN DMSDB.PT_0211T C
                         ON A.DLR_CD = C.DLR_CD
                        AND A.BP_CD  = C.BP_CD
                      LEFT OUTER JOIN PT_0301T D
                         ON B.DLR_CD           = D.DLR_CD
                        AND B.ITEM_CD          = D.ITEM_CD
                        AND B.GR_STRGE_CD      = D.STRGE_CD
             WHERE  B.DLR_CD = #{sDlrCd}        --딜러코드
                   <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                       AND A.PURC_ORD_NO = #{sPurcOrdNo}
                   </if>        --구매오더정보
                   <if test='sBpCd != null and sBpCd != ""'>
                       AND A.BP_CD = #{sBpCd}
                   </if>        --운송유형
                   <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                       AND A.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                           #{item}
                        </foreach>
                   </if>        --거래처코드
                   <if test='sPurcRegDtFr != null'>
                        AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                   </if>
                   <if test='sPurcRegDtTo != null'>
                        AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                   </if>
                   <if test='sRegUsrId != null and sRegUsrId        != ""'>
                       AND A.REG_USR_ID = #{sRegUsrId}
                   </if>        --구매신청자
          ORDER BY  A.DLR_CD ASC
                   ,A.PURC_ORD_NO ASC
                   ,A.PURC_ORD_LINE_NO ASC
    </select>

    <!-- 반품구매오더 부품 정보를 Count한다. -->
    <select id="selectReturnPurcOrdItemConditionCnt" parameterType="PurcOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectReturnPurcOrdItemCondition] */
             SELECT COUNT(*)
              FROM DMSDB.PT_0424T A    --로컬구매오더반품정보
                      INNER JOIN  DMSDB.PT_0201T B    --품목정보
                         ON A.DLR_CD  = B.DLR_CD
                        AND A.ITEM_CD = B.ITEM_CD
                      INNER JOIN DMSDB.PT_0211T C
                         ON A.DLR_CD = C.DLR_CD
                        AND A.BP_CD  = C.BP_CD
                      LEFT OUTER JOIN PT_0301T D
                         ON B.DLR_CD           = D.DLR_CD
                        AND B.ITEM_CD          = D.ITEM_CD
                        AND B.GR_STRGE_CD      = D.STRGE_CD
             WHERE  B.DLR_CD = #{sDlrCd}        --딜러코드
                   <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                       AND A.PURC_ORD_NO = #{sPurcOrdNo}
                   </if>        --구매오더정보
                   <if test='sBpCd != null and sBpCd != ""'>
                       AND A.BP_CD = #{sBpCd}
                   </if>        --운송유형
                   <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                       AND A.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                           #{item}
                        </foreach>
                   </if>        --거래처코드
                   <if test='sPurcRegDtFr != null'>
                        AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                   </if>
                   <if test='sPurcRegDtTo != null'>
                        AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                   </if>
                   <if test='sRegUsrId != null and sRegUsrId != ""'>
                       AND A.REG_USR_ID = #{sRegUsrId}
                   </if>        --구매신청자
    </select>

    <!-- 구매오더 엑셀업로드 정보를 조회한다. -->
    <select id="selectPurcOrdItemExcelUploadByKey" parameterType="PurcOrdItemVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdItemExcelUploadByKey] */
            SELECT   A.DLR_CD
                    ,A.ITEM_CD
                    ,A.ITEM_NM
                    ,'03' AS PURC_ITEM_TP
                    ,'01' AS PURC_ITEM_STAT_CD
                    ,A.GR_STRGE_CD
                    ,A.PURC_UNIT_CD
                    ,NVL(A.PURC_QTY,0) AS PURC_QTY
                    ,A.PURC_EXCEL_QTY
                    ,0 AS RESV_QTY
                    ,NVL(A.PURC_PRC, 0) AS PURC_PRC
                    ,ROUND(NVL(A.PURC_QTY, 0) * NVL(A.PURC_PRC, 0),2) AS PURC_AMT
                    ,ROUND((NVL(A.PURC_PRC, 0) - (NVL(A.PURC_PRC, 0) * FN_GET_VAT(null,'ALL')))) AS TAX_DDCT_PRC                 --구매단가(세전)
                    ,ROUND((NVL(A.PURC_PRC, 0) * NVL(A.PURC_QTY, 0)) - ((NVL(A.PURC_PRC, 0) * NVL(A.PURC_QTY, 0)) * FN_GET_VAT(null,'ALL')),2) AS TAX_DDCT_AMT                 --구매금액(세전)
                    ,'01' AS PRC_TP
                    ,'N' AS DEL_YN
                    ,'N' AS GR_END_YN
                    ,A.PURC_REQ_DT
                    ,A.BP_CD
                    ,A.PURC_LEAD_HM
                    ,A.STOCK_QTY
                    ,A.RESV_STOCK_QTY
                    ,A.BORROW_QTY
                    ,A.RENT_QTY
                    ,A.AVLB_STOCK_QTY
                    ,A.GR_SCHE_QTY
                    ,A.MIN_PACK_QTY         --최소포장수량
                    ,CASE WHEN A.MIN_PURC_QTY = 0 THEN 1 ELSE A.MIN_PURC_QTY END  MIN_PURC_QTY         --최소구매수량
                    ,A.SPYR_CD
                    ,A.PAR_SPEC_CD
                    ,A.SUC_CD
             FROM
                  (
                    SELECT   A.DLR_CD
                            ,A.ITEM_CD
                            ,A.ITEM_NM
                            ,A.GR_STRGE_CD
                            ,A.STOCK_UNIT_CD AS PURC_UNIT_CD
                            ,NVL(ROUND(${purcExcelQty}), 0) AS PURC_QTY
                            ,NVL(ROUND(DECODE(${purcExcelQty},'-999','0',${purcExcelQty}),0), 0) AS PURC_EXCEL_QTY
                            --,B.BMP_PURC_PRC
                            ,CASE WHEN NVL(B.BMP_PURC_PRC,0) <![CDATA[>]]> 0
                                    THEN B.BMP_PURC_PRC
                                  ELSE NVL((SELECT NVL(ROUND(LPR_LST_PRC * ( 1 + FN_GET_VAT(null,'ALL')),2),0)
                                          FROM PT_0214I T2
                                         WHERE (LPR_PNO,LPR_APL_DT) IN (
                                                    SELECT LPR_PNO,
                                                           MAX(LPR_APL_DT) AS LPR_APL_DT
                                                      FROM PT_0214I T3
                                                     WHERE TRIM(T3.LPR_PNO) = A.ITEM_CD
                                                  GROUP BY LPR_PNO))
                                           ,(SELECT NVL(ROUND(T.APCP_PRICE_NAT_AMT * (1 + FN_GET_VAT(null,'ALL')),2),0)
                                               FROM PT_0216I T
                                              WHERE (APCP_PART_NO,APCP_APPLY_DATE) IN (
                                                  SELECT APCP_PART_NO,
                                                         MAX(APCP_APPLY_DATE) AS APCP_APPLY_DATE
                                                    FROM PT_0216I I
                                                   WHERE I.APCP_PART_NO = A.ITEM_CD
                                                GROUP BY APCP_PART_NO )
                                            )
                             ) END PURC_PRC
                            ,SYSDATE + NVL(A.PURC_LEAD_HM, 0) AS PURC_REQ_DT
                            ,A.BP_CD
                            ,A.PURC_LEAD_HM
                            ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                            ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                            ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                            ,NVL(C.RENT_QTY,0) AS RENT_QTY
                            ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                            ,NVL(C.GR_SCHE_QTY,0) AS GR_SCHE_QTY
                            ,NVL(A.MIN_PACK_QTY,1) AS MIN_PACK_QTY         --최소포장수량
                            ,NVL(A.MIN_PURC_QTY,1) AS MIN_PURC_QTY         --최소구매수량
                            ,A.SPYR_CD
                            ,NVL(A.PAR_SPEC_CD,' ') AS PAR_SPEC_CD
                            ,NVL(A.SUC_CD,' ') as SUC_CD
                      FROM   DMSDB.PT_0201T A
                             LEFT OUTER JOIN (
                                  SELECT   DLR_CD
                                          ,ITEM_CD
                                          ,MAX(PRC_TP) AS PRC_TP
                                          ,MAX(LINE_NO) AS LINE_NO
                                          ,MAX(NVL(SALE_PRC_AMT,0)) AS BMP_PURC_PRC
                                    FROM   PT_0214T
                                   WHERE   DLR_CD = #{dlrCd}
                                     AND   DEL_YN != 'Y'
                                  GROUP BY DLR_CD, ITEM_CD) B
                               ON A.DLR_CD = B.DLR_CD
                              AND A.ITEM_CD= B.ITEM_CD
                             LEFT JOIN
                                (
                                    SELECT
                                        DLR_CD
                                        ,ITEM_CD
                                        ,SUM(NVL(AVLB_STOCK_QTY,0)) AS AVLB_STOCK_QTY
                                        ,SUM(NVL(BORROW_QTY,0)) AS BORROW_QTY
                                        ,SUM(NVL(RENT_QTY,0)) AS RENT_QTY
                                        ,SUM(NVL(CLAM_STOCK_QTY,0)) AS CLAM_STOCK_QTY
                                        ,SUM(NVL(RESV_STOCK_QTY,0)) AS RESV_STOCK_QTY
                                        ,SUM(NVL(GR_SCHE_QTY,0)) AS GR_SCHE_QTY
                                        ,SUM(NVL(GI_SCHE_QTY,0)) AS GI_SCHE_QTY
                                    FROM PT_0301T
                                    GROUP BY DLR_CD ,ITEM_CD
                                ) C ON A.DLR_CD  = C.DLR_CD AND A.ITEM_CD = C.ITEM_CD
                    ) A
            WHERE  A.DLR_CD   = #{dlrCd}        --딜러코드
              AND  A.ITEM_CD  = #{itemCd}       --부품번호
    </select>

    <!-- 구매오더 정보 목록을 조회한다. -->
    <select id="selectPurcOrdsByCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdsByCondition] */
        SELECT
            A.*
        FROM(
            SELECT
                ROWNUM AS RNUM
                ,T1.*
            FROM(
                SELECT
                    F.*
                FROM(
                    SELECT
                        A.DLR_CD                    <!-- 딜러코드 -->
                        ,A.PURC_ORD_NO              <!-- 구매오더정보 -->
                        ,A.PURC_ORD_TP              <!-- 구매오더유형 -->
                        ,A.TRSF_TP                  <!-- 운송유형 -->
                        ,A.PURC_ORD_STAT_CD         <!-- 구매오더상태코드 -->
                        ,A.PLT_CD                   <!-- 센터코드 -->
                        ,A.BP_CD                    <!-- 거래처코드 -->
                        ,B.BP_NM                    <!-- 거래처명 -->
                        ,A.PURC_REG_DT              <!-- 구매등록일자 -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN NVL(C.TOT_PURC_AMT, 0) <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 총구매금액 -->
                              WHEN A.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_AMT* (1 + FN_GET_VAT(null,'ALL'))
                         ELSE A.TOT_PURC_AMT* (1 + FN_GET_VAT(null,'ALL'))   <!-- 구매오더상태 그외 구매오더헤더 세금포함 총구매금액, 수정일시 : 20170706-->
                         END CALC_PURC_AMT           <!-- 총구매금액(세금포함) -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN NVL(C.TOT_TAX_DDCT_AMT, 0)        <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 세금공제금액 -->
                              WHEN A.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_AMT   <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 금액 -->
                         ELSE A.TOT_PURC_AMT        <!-- 총구매금액(세금미포함) , 수정일시 : 20170706-->
                         END CALC_TAX_DDCT_AMT       <!-- 총구매수량 -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN NVL(C.TOT_PURC_QTY, 0)    <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 수량 -->
                              WHEN A.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_QTY ELSE A.PURC_PAR_QTY <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 수량 -->
                         END CALC_CONFIRM_QTY          <!-- 총수량 , 수정일시 : 20170706-->
                        ,A.BMP_ORD_NO
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN NVL(C.ITEM_CNT, 0)    <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 건수 -->
                              WHEN A.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_CNT ELSE A.PURC_PAR_CNT <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 건수 -->
                         END ITEM_CNT               <!-- 총건수 , 수정일시 : 20170706-->
                        ,A.SEND_DT                 <!-- 전송일자 -->
                        ,A.CONFIRM_DT              <!-- 확정일자 -->
                        ,TO_DATE(A.ARRV_DT) AS ARRV_DATE<!-- 아모스전송일자 -->
                        ,A.END_DT                  <!-- 완료일자 -->
                        ,A.CANC_DT                 <!-- 취소일자 -->
                        ,A.REMARK                  <!-- 비고 -->
                        ,A.REG_USR_ID              <!-- 등록자ID -->
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   <!-- 등록자명 -->
                        ,A.REG_DT                  <!-- 등록일자 -->
                        ,A.UPDT_USR_ID             <!-- 수정자ID -->
                        ,A.UPDT_DT                 <!-- 수정일자 -->
                        ,'' as MOBIS_INVC_NO       <!-- 모비스 송장번호 -->
                        ,NVL(C.TOT_PURC_QTY, 0) AS TOT_PURC_QTY
                        ,NVL(C.TOT_PURC_AMT, 0) AS TOT_PURC_AMT
                        ,NVL(C.TOT_TAX_DDCT_AMT, 0) AS TOT_TAX_DDCT_AMT
                        ,NVL(C.BO_QTY,0) AS BO_QTY   ----liuxueying add ------
                        ,NVL(C.BO_CNT,0) AS BO_CNT   ----liuxueying add ------
                    FROM PT_0421T A<!-- 구매오더헤더정보 -->
                    INNER JOIN PT_0211T B ON A.DLR_CD = B.DLR_CD AND A.BP_CD = B.BP_CD
                    LEFT OUTER JOIN (
                        SELECT
                            A.DLR_CD
                            ,A.PURC_ORD_NO
                            --,SUM(PURC_QTY) AS TOT_PURC_QTY
                            ,COUNT(*) AS ITEM_CNT
                            --,SUM(PURC_AMT) AS TOT_PURC_AMT
                            ,SUM(CALC_CONFIRM_QTY) TOT_PURC_QTY
                            ,SUM(CALC_PURC_AMT) TOT_PURC_AMT
                            ,SUM(CALC_TAX_DDCT_AMT) AS TOT_TAX_DDCT_AMT
                            ,SUM(A.BO_QTY) AS BO_QTY ----liuxueying add--------------
                            ,SUM(CASE WHEN NVL(A.BO_QTY,0) > 0 THEN 1 ELSE 0 END) AS BO_CNT----liuxueying add--------------
                        FROM (SELECT A.DLR_CD
                                    ,A.PURC_ORD_NO
                                    ,A.ITEM_CD
                                    ,PURC_QTY
                                    ,PURC_AMT
                                    ,CASE WHEN B.PURC_ORD_STAT_CD IN ('01','02') THEN A.PURC_QTY     -- 신규생성 일때 : 오더수량을 그대로 보여줌
                                          WHEN B.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                                          ELSE
                                              CASE WHEN A.PURC_PGSS_CD IN ('C','D','Y') THEN
                                                    CASE WHEN A.CONFIRM_QTY <![CDATA[>]]> 0 THEN A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0) ELSE 0 END
                                              WHEN A.PURC_PGSS_CD IN ('X','Z') THEN NVL(NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0),0)
                                              ELSE A.CONFIRM_QTY END
                                          END CALC_CONFIRM_QTY
                                    ,CASE WHEN b.PURC_ORD_STAT_CD IN ('01','02') THEN A.PURC_AMT
                                          WHEN B.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                                          ELSE
                                            CASE WHEN A.PURC_PGSS_CD IN ('C','D','Y') THEN
                                                  CASE WHEN A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0) <![CDATA[>]]> 0 THEN ROUND((A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0)) * A.PURC_PRC,2) ELSE 0 END
                                                 WHEN A.PURC_PGSS_CD IN ('X','Z') THEN
                                                  CASE WHEN NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0) <![CDATA[>]]> 0
                                                      THEN ROUND(A.PURC_PRC * (NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0)),2)
                                                    ELSE 0 END
                                              ELSE A.PURC_AMT END
                                      END CALC_PURC_AMT
                                    ,CASE WHEN B.PURC_ORD_STAT_CD IN ('01','02') THEN A.TAX_DDCT_AMT
                                          WHEN B.PURC_ORD_STAT_CD IN ('05') THEN 0     -- 취소 일때 : 0
                                        ELSE
                                            CASE WHEN A.PURC_PGSS_CD IN ('C','D','Y') THEN
                                                CASE WHEN A.CONFIRM_QTY - A.CANC_QTY <![CDATA[>]]> 0 THEN ROUND((A.CONFIRM_QTY - A.CANC_QTY) * A.TAX_DDCT_PRC,2) ELSE 0 END -- 전체 취소 경우 : 0 , 부분 취소 : 계산된(커런트) 수량 * 단가
                                            WHEN A.PURC_PGSS_CD IN ('X','Z') THEN CASE WHEN NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0) <![CDATA[>]]> 0 THEN ROUND(A.TAX_DDCT_PRC * (NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0)),2) ELSE 0 END -- CHECK 수량이 있으면 : 단가*체크수량 , 없으면 : 0
                                            ELSE A.TAX_DDCT_AMT END
                                        END CALC_TAX_DDCT_AMT
                                        ,A.BO_QTY-----liuxueying add ----
                                FROM PT_0422T A
                                       INNER JOIN PT_0421T B
                                         ON A.DLR_CD = B.DLR_CD
                                        AND A.PURC_ORD_NO = B.PURC_ORD_NO
                               WHERE  A.DEL_YN !=   'Y') A
                        INNER JOIN PT_0201T B ON A.DLR_CD  = B.DLR_CD AND A.ITEM_CD = B.ITEM_CD
                        WHERE 1=1
                        <!-- AND  A.DEL_YN != 'Y' -->  <!-- 구매오더목록에 전체취소건도 보여져야 함 -->
                        <if test='sItemCd != null and sItemCd != ""'>
                            AND A.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                        </if>
                        <if test='sItemNm != null and sItemNm != ""'>
                            AND B.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                        </if>
                        <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                            AND B.ITEM_DSTIN_CD = #{sItemDstinCd}
                        </if>
                        GROUP BY A.DLR_CD ,A.PURC_ORD_NO
                    ) C ON A.DLR_CD = C.DLR_CD AND A.PURC_ORD_NO = C.PURC_ORD_NO
                    WHERE A.DLR_CD = #{sDlrCd}
                    <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                        AND A.PURC_ORD_NO LIKE '%'||#{sPurcOrdNo}||'%'
                    </if><!-- 구매오더정보 -->
                    <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                        AND A.PURC_ORD_TP = #{sPurcOrdTp}
                    </if><!-- 구매오더유형 -->
                    <if test='sTrsfTp != null and sTrsfTp != ""'>
                        AND A.TRSF_TP = #{sTrsfTp}
                    </if><!-- 운송유형 -->
                    <if test='sBpCd != null and sBpCd != ""'>
                        AND B.BP_CD = #{sBpCd}
                    </if><!-- 운송유형 -->
                    <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                        AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                    </if><!-- 구매오더상태코드 -->
                    <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                        AND A.PURC_ORD_STAT_CD IN
                        <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if><!-- 구매오더상태코드 -->
                    <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                        AND B.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if><!-- -거래처코드 -->
                    <if test='sPurcRegDtFr != null'>
                        AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                    </if>
                    <if test='sArrvDtFr != null'>
                        AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
                    </if>
                    <if test='sArrvDtTo != null'>
                        AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
                    </if>
                    <if test='sCancelImplYn != null and sCancelImplYn != ""'>
                        AND A.UPDT_USR_ID = #{sCancelImplYn}
                    </if><!-- 취소포함여부 -->
                    <if test='sGrImplYn != null and sGrImplYn != ""'>
                        AND A.UPDT_DT = #{sGrImplYn}
                    </if><!-- 입고완료포함여부 -->
                    <if test='sTotPurcAmt != null and sTotPurcAmt != ""'>
                        AND A.TOT_PURC_AMT <![CDATA[>=]]> #{sTotPurcAmt}
                    </if><!-- 총구매금액 -->
                    <if test='sTotPurcAmtFr != null and sTotPurcAmtFr != ""'>
                        AND A.TOT_PURC_AMT <![CDATA[>=]]> #{sTotPurcAmtFr}
                    </if><!-- 총구매금액 -->
                    <if test='sTotPurcAmtTo != null and sTotPurcAmtTo != ""'>
                       AND A.TOT_PURC_AMT <![CDATA[<=]]> #{sTotPurcAmtTo}
                    </if><!-- 총구매금액 -->
                    <if test='sRegUsrId != null and sRegUsrId != ""'>
                       AND A.REG_USR_ID = #{sRegUsrId}
                    </if><!-- 구매신청자 -->
                ) F
                WHERE 1=1
                <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                    AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
                </if><!-- 구매신청자 -->
                ORDER BY
                <choose>
                <when test='sort != null'>
                    <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                        <choose>
                        <when test='item.field == "purcOrdNo"'> F.PURC_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "bmpOrdNo"'> F.BMP_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcOrdTp"'> F.PURC_ORD_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "trsfTp"'> F.TRSF_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcOrdStatCd"'> F.PURC_ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                        <when test='item.field == "bpNm"'> F.BP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "itemCnt"'> F.ITEM_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "purcRegDt"'> F.PURC_REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "totPurcQty"'> F.TOT_PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "totPurcAmt"'> F.TOT_PURC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "totTaxDdctAmt"'> F.TOT_TAX_DDCT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "arrvDate"'> F.ARRV_DATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "confirmDt"'> F.CONFIRM_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "regUsrNm"'> F.REG_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "mobisInvcNo"'> F.MOBIS_INVC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        <when test='item.field == "remark"'> F.REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                        </choose>
                    </foreach>
                </when>
                <otherwise>
                    F.DLR_CD ASC ,TO_CHAR(F.PURC_REG_DT,'YYYY-MM-DD') DESC ,F.ARRV_DATE DESC
                </otherwise>
                </choose>
            ) T1
        ) A
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex} AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 구매오더 정보 카운트를 조회한다. -->
    <select id="selectPurcOrdsByConditionCnt" parameterType="PurcOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdsByConditionCnt] */
            SELECT
                COUNT(*)
            FROM(
                SELECT
                    F.*
                FROM(
                    SELECT
                        A.DLR_CD                    <!-- 딜러코드 -->
                        ,A.PURC_ORD_NO              <!-- 구매오더정보 -->
                        ,A.PURC_ORD_TP              <!-- 구매오더유형 -->
                        ,A.TRSF_TP                  <!-- 운송유형 -->
                        ,A.PURC_ORD_STAT_CD         <!-- 구매오더상태코드 -->
                        ,A.PLT_CD                   <!-- 센터코드 -->
                        ,A.BP_CD                    <!-- 거래처코드 -->
                        ,B.BP_NM                    <!-- 거래처명 -->
                        ,A.PURC_REG_DT              <!-- 구매등록일자 -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN C.TOT_PURC_AMT <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 총구매금액 -->
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_AMT* (1 + FN_GET_VAT(null,'ALL'))
                         ELSE A.TOT_PURC_AMT * (1 + FN_GET_VAT(null,'ALL'))   <!-- 구매오더상태 그외 구매오더헤더 세금포함 총구매금액, 수정일시 : 20170706-->
                         END CALC_PURC_AMT           <!-- 총구매금액(세금포함) -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN C.TOT_TAX_DDCT_AMT        <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 세금공제금액 -->
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_AMT   <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 금액 -->
                         ELSE A.TOT_PURC_AMT        <!-- 총구매금액(세금미포함) , 수정일시 : 20170706-->
                         END TOT_TAX_DDCT_AMT       <!-- 총구매수량 -->
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN C.TOT_PURC_QTY    <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 수량 -->
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_QTY ELSE A.PURC_PAR_QTY <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 수량 -->
                         END CALC_CONFIRM_QTY          <!-- 총수량 , 수정일시 : 20170706-->
                        ,A.BMP_ORD_NO
                        ,CASE WHEN A.PURC_ORD_STAT_CD IN ('01','02') THEN C.ITEM_CNT    <!-- 구매오더상태 신규생성:01, 발송:02 일때 구매요청상세 건수 -->
                              WHEN A.PURC_ORD_STAT_CD = '03' AND A.TOT_PURC_AMT = 0 THEN A.CONFIRM_PAR_CNT ELSE A.PURC_PAR_CNT <!-- 구매오더상태 처리:03 일고 헤더 금액이 0 일때, 헤더 확정 건수 -->
                         END ITEM_CNT               <!-- 총건수 , 수정일시 : 20170706-->
                        ,A.SEND_DT                 <!-- 전송일자 -->
                        ,A.CONFIRM_DT              <!-- 확정일자 -->
                        ,TO_DATE(A.ARRV_DT) AS ARRV_DATE<!-- 아모스전송일자 -->
                        ,A.END_DT                  <!-- 완료일자 -->
                        ,A.CANC_DT                 <!-- 취소일자 -->
                        ,A.REMARK                  <!-- 비고 -->
                        ,A.REG_USR_ID              <!-- 등록자ID -->
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   <!-- 등록자명 -->
                        ,A.REG_DT                  <!-- 등록일자 -->
                        ,A.UPDT_USR_ID             <!-- 수정자ID -->
                        ,A.UPDT_DT                 <!-- 수정일자 -->
                        ,'' as MOBIS_INVC_NO       <!-- 모비스 송장번호 -->
                        ,C.TOT_PURC_QTY
                        ,C.TOT_PURC_AMT
                    FROM PT_0421T A<!-- 구매오더헤더정보 -->
                    INNER JOIN PT_0211T B ON A.DLR_CD = B.DLR_CD AND A.BP_CD = B.BP_CD
                    LEFT OUTER JOIN (
                        SELECT
                            A.DLR_CD
                            ,A.PURC_ORD_NO
                            --,SUM(PURC_QTY) AS TOT_PURC_QTY
                            ,COUNT(*) AS ITEM_CNT
                            --,SUM(PURC_AMT) AS TOT_PURC_AMT
                            ,SUM(CALC_CONFIRM_QTY) TOT_PURC_QTY
                            ,SUM(CALC_PURC_AMT) TOT_PURC_AMT
                            ,SUM(TAX_DDCT_AMT) AS TOT_TAX_DDCT_AMT
                        FROM (SELECT A.DLR_CD
                                    ,A.PURC_ORD_NO
                                    ,A.ITEM_CD
                                    ,PURC_QTY
                                    ,PURC_AMT
                                    ,CASE WHEN B.PURC_ORD_STAT_CD IN ('01','02') THEN A.PURC_QTY     -- 신규생성 일때 : 오더수량을 그대로 보여줌
                                          ELSE
                                              CASE WHEN A.PURC_PGSS_CD IN ('C','D','Y') THEN
                                                    CASE WHEN A.CONFIRM_QTY <![CDATA[>]]> 0 THEN A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0) ELSE 0 END
                                              WHEN A.PURC_PGSS_CD IN ('X','Z') THEN NVL(NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0),0)
                                              ELSE A.CONFIRM_QTY END
                                          END CALC_CONFIRM_QTY
                                    ,CASE WHEN b.PURC_ORD_STAT_CD IN ('01','02') THEN A.PURC_AMT
                                          ELSE
                                            CASE WHEN A.PURC_PGSS_CD IN ('C','D','Y') THEN
                                                  CASE WHEN A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0) <![CDATA[>]]> 0 THEN ROUND((A.CONFIRM_QTY - NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0 THEN CASE WHEN B.PURC_ORD_STAT_CD = '05' THEN A.PURC_QTY ELSE 0 END ELSE NVL(A.CANC_QTY,0) END,0)) * A.PURC_PRC,2) ELSE 0 END
                                                 WHEN A.PURC_PGSS_CD IN ('X','Z') THEN
                                                  CASE WHEN NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0) <![CDATA[>]]> 0
                                                      THEN ROUND(A.PURC_PRC * (NVL(A.SHIP_QTY,0) + NVL(A.ODR_ALC_QT,0) + NVL(A.ODR_OPIC_QT,0) + NVL(A.ODR_PAKD_QT,0) + NVL(A.ODR_INV_QT,0)),2)
                                                    ELSE 0 END
                                              ELSE A.PURC_AMT END
                                      END CALC_PURC_AMT
                                    ,TAX_DDCT_AMT
                                FROM PT_0422T A
                                       INNER JOIN PT_0421T B
                                         ON A.DLR_CD = B.DLR_CD
                                        AND A.PURC_ORD_NO = B.PURC_ORD_NO
                               WHERE  A.DEL_YN !=   'Y') A
                        INNER JOIN PT_0201T B ON A.DLR_CD  = B.DLR_CD AND A.ITEM_CD = B.ITEM_CD
                        WHERE 1=1
                        <!-- AND  A.DEL_YN != 'Y' -->  <!-- 구매오더목록에 전체취소건도 보여져야 함 -->
                        <if test='sItemCd != null and sItemCd != ""'>
                            AND A.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                        </if>
                        <if test='sItemNm != null and sItemNm != ""'>
                            AND B.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                        </if>
                        <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                            AND B.ITEM_DSTIN_CD = #{sItemDstinCd}
                        </if>
                        GROUP BY A.DLR_CD ,A.PURC_ORD_NO
                    ) C ON A.DLR_CD = C.DLR_CD AND A.PURC_ORD_NO = C.PURC_ORD_NO
                    WHERE A.DLR_CD = #{sDlrCd}
                    <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                        AND A.PURC_ORD_NO LIKE '%'||#{sPurcOrdNo}||'%'
                    </if><!-- 구매오더정보 -->
                    <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                        AND A.PURC_ORD_TP = #{sPurcOrdTp}
                    </if><!-- 구매오더유형 -->
                    <if test='sTrsfTp != null and sTrsfTp != ""'>
                        AND A.TRSF_TP = #{sTrsfTp}
                    </if><!-- 운송유형 -->
                    <if test='sBpCd != null and sBpCd != ""'>
                        AND B.BP_CD = #{sBpCd}
                    </if><!-- 운송유형 -->
                    <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                        AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                    </if><!-- 구매오더상태코드 -->
                    <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                        AND A.PURC_ORD_STAT_CD IN
                        <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if><!-- 구매오더상태코드 -->
                    <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                        AND B.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if><!-- -거래처코드 -->
                    <if test='sPurcRegDtFr != null'>
                        AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                    </if>
                    <if test='sArrvDtFr != null'>
                        AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
                    </if>
                    <if test='sArrvDtTo != null'>
                        AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
                    </if>
                    <if test='sCancelImplYn != null and sCancelImplYn != ""'>
                        AND A.UPDT_USR_ID = #{sCancelImplYn}
                    </if><!-- 취소포함여부 -->
                    <if test='sGrImplYn != null and sGrImplYn != ""'>
                        AND A.UPDT_DT = #{sGrImplYn}
                    </if><!-- 입고완료포함여부 -->
                    <if test='sTotPurcAmt != null and sTotPurcAmt != ""'>
                        AND A.TOT_PURC_AMT <![CDATA[>=]]> #{sTotPurcAmt}
                    </if><!-- 총구매금액 -->
                    <if test='sTotPurcAmtFr != null and sTotPurcAmtFr != ""'>
                        AND A.TOT_PURC_AMT <![CDATA[>=]]> #{sTotPurcAmtFr}
                    </if><!-- 총구매금액 -->
                    <if test='sTotPurcAmtTo != null and sTotPurcAmtTo != ""'>
                       AND A.TOT_PURC_AMT <![CDATA[<=]]> #{sTotPurcAmtTo}
                    </if><!-- 총구매금액 -->
                    <if test='sRegUsrId != null and sRegUsrId != ""'>
                       AND A.REG_USR_ID = #{sRegUsrId}
                    </if><!-- 구매신청자 -->
                ) F
                WHERE 1=1
                <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                    AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
                </if><!-- 구매신청자 -->
            ) T1
    </select>

    <!-- 구매등록 정보 Max 라인번호를 조회한다. -->
    <select id="selectPurcOrdMaxLineNo" parameterType="PurcOrdVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdMaxLineNo] */
        SELECT NVL(max(A.PURC_ORD_LINE_NO),0) + 1
          FROM DMSDB.PT_0422T A    --구매오더부품정보
         WHERE A.DLR_CD           = #{dlrCd}                 --딜러코드
           AND A.PURC_ORD_NO      = #{purcOrdNo}
    </select>

    <!-- 구매등록 정보 총 구매 금액을 조회한다. -->
    <select id="selectPurcOrdTotPurcAmt" parameterType="PurcOrdVO" resultType="double">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdTotPurcAmt] */
          SELECT   NVL(SUM(PURC_AMT), 0)
            FROM   PT_0422T A
                   INNER JOIN PT_0421T B
                      ON A.DLR_CD = B.DLR_CD
                     AND A.PURC_ORD_NO = B.PURC_ORD_NO
           WHERE   A.DLR_CD       = #{dlrCd}
             AND   A.PURC_ORD_NO  = #{purcOrdNo}
             AND   A.DEL_YN      != 'Y'
    </select>

    <!-- 구매등록 정보 총 구매(세전) 금액을 조회한다. -->
    <select id="selectPurcOrdTotTaxDdctAmt" parameterType="PurcOrdVO" resultType="double">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdTotTaxDdctAmt] */
          SELECT   NVL(SUM(TAX_DDCT_AMT), 0)
            FROM   PT_0422T A
                   INNER JOIN PT_0421T B
                      ON A.DLR_CD = B.DLR_CD
                     AND A.PURC_ORD_NO = B.PURC_ORD_NO
           WHERE   A.DLR_CD       = #{dlrCd}
             AND   A.PURC_ORD_NO  = #{purcOrdNo}
             AND   A.DEL_YN      != 'Y'
    </select>

     <!-- 송장등록을 위한 구매오더 부품 정보를 조회한다. -->
    <select id="selectInvcItemsByCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcItemsByCondition] */
        SELECT   ROWNUM AS RNUM
                   , T1.*
              FROM (
                 SELECT B.DLR_CD                   --딜러코드
                       ,B.PURC_REQ_DT              --입고예정일
                       ,A.BP_CD
                       ,D.BP_NM
                       ,A.PURC_ORD_TP
                       ,B.PURC_ITEM_STAT_CD        --구매품목상태코드
                       ,B.PURC_ORD_NO              --구매오더번호
                       ,B.PURC_ORD_LINE_NO         --구매오더라인번호
                       ,B.ITEM_CD                  --품목코드
                       ,C.ITEM_NM                  --품목명
                       ,B.PURC_QTY                 --구매수량
                       ,B.RESV_QTY                 --예약수량
                       ,(NVL(B.GR_QTY,0) + NVL(E.INVC_QTY, 0)) AS GR_QTY                  --입고수량(입고완료수량 + 입고 등록 수량)
                       ,B.PURC_UNIT_CD             --구매단위코드
                       ,B.PRC_TP                   --가격유형
                       ,B.PURC_PRC                 --구매단가
                       ,B.PURC_AMT                 --구매금액
                       ,B.TAX_DDCT_PRC             --구매단가(세전)
                       ,B.TAX_DDCT_AMT             --구매금액(세전)
                       ,B.PURC_ITEM_TP             --생성유형
                       ,B.DEL_YN                   --삭제여부
                       ,B.GR_END_YN                --입고완료여부
                       ,B.GR_STRGE_CD              --입고창고코드
                       ,B.PURC_REQ_NO              --구매요청번호
                       ,B.PURC_REQ_LINE_NO         --구매요청라인번호
                       ,B.BMP_ORD_NO               --BMP오더번호
                       ,B.BMP_CHK_QTY              --BMP확인수량
                       ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0
                                   THEN CASE WHEN A.PURC_ORD_STAT_CD = '05'
                                               THEN B.PURC_QTY
                                             ELSE 0 END
                                 ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY                --취소수량
                  FROM  DMSDB.PT_0421T A                  --구매오더헤더정보
                          INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                             ON A.DLR_CD      = B.DLR_CD
                            AND A.PURC_ORD_NO = B.PURC_ORD_NO
                          INNER JOIN  DMSDB.PT_0201T C    --품목정보
                             ON B.DLR_CD  = C.DLR_CD
                            AND B.ITEM_CD = C.ITEM_CD
                          LEFT OUTER JOIN PT_0211T D      --공급업체정보
                             ON A.DLR_CD     = D.DLR_CD
                            AND A.BP_CD      = D.BP_CD
                          LEFT OUTER JOIN (
                                SELECT   A.DLR_CD
                                        ,A.PURC_ORD_NO
                                        ,A.PURC_ORD_LINE_NO
                                        ,A.INVC_QTY
                                  FROM   PT_0432T A      --송장품목정보
                                         INNER JOIN PT_0431T B
                                            ON A.DLR_CD      = B.DLR_CD
                                           AND A.INVC_DOC_NO = B.INVC_DOC_NO
                                           AND B.INVC_TP     = '01'
                                           AND B.INVC_STAT_CD IN ('01' ,'02')
                                           AND B.CANC_YN    != 'Y'
                                ) E
                             ON B.DLR_CD           = E.DLR_CD
                            AND B.PURC_ORD_NO      = E.PURC_ORD_NO
                            AND B.PURC_ORD_LINE_NO = E.PURC_ORD_LINE_NO
                 WHERE  A.DLR_CD = #{sDlrCd}
                 <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                 AND A.PURC_ORD_TP = #{sPurcOrdTp}
                 </if>        --구매오더유형
                 <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                 AND A.PURC_ORD_NO = #{sPurcOrdNo}
                 </if>        --구매오더정보
                 <if test='sBpCd != null and sBpCd != ""'>
                 AND A.BP_CD = #{sBpCd}
                 </if>        --거래처코드
                 <if test='sPurcReqDtFr != null'>
                     AND B.PURC_REQ_DT <![CDATA[>=]]> #{sPurcReqDtFr}
                 </if>
                 <if test='sPurcReqDtTo != null'>
                     AND B.PURC_REQ_DT <![CDATA[<=]]> #{sPurcReqDtTo} + 1
                 </if>
                 <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                     AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                 </if>        --구매오더상태코드
                   AND  B.PURC_QTY <![CDATA[>]]> (NVL(B.GR_QTY,0) + NVL(E.INVC_QTY, 0))
                   AND  B.DEL_YN  != 'Y'
               ORDER BY
                 <choose>
                     <when test='sort != null'>
                         <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                             <choose>
                                 <when test='item.field == "purcOrdNo"'> A.PURC_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "purcOrdTp"'> A.PURC_ORD_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "trsfTp"'> A.TRSF_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "purcOrdStatCd"'> A.PURC_ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "bpCd"'> A.BP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "purcReqDt"'> B.PURC_REQ_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "purcOrdLineNo"'> B.PURC_ORD_LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "itemCd"'> B.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "itemNm"'> C.ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "purcQty"'> B.PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <when test='item.field == "grQty"'> (NVL(B.GR_QTY,0) + NVL(E.INVC_QTY, 0)) <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                 <otherwise>
                                   B.DLR_CD ASC
                                  ,B.PURC_ORD_NO DESC
                                  ,B.PURC_ORD_LINE_NO ASC
                                 </otherwise>
                             </choose>
                         </foreach>
                     </when>
                     <otherwise>
                       B.DLR_CD ASC
                      ,B.PURC_ORD_NO DESC
                      ,B.PURC_ORD_LINE_NO ASC
                     </otherwise>
                 </choose>
             ) T1
    </select>

    <!-- 송장등록을 위한 구매오더 부품 정보 Count를 조회한다. -->
    <select id="selectInvcItemsByConditionCnt" parameterType="InvcSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcItemsByConditionCnt] */
         SELECT COUNT(*)
          FROM  DMSDB.PT_0421T A                  --구매오더헤더정보
                  INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                     ON A.DLR_CD      = B.DLR_CD
                    AND A.PURC_ORD_NO = B.PURC_ORD_NO
                  INNER JOIN  DMSDB.PT_0201T C    --품목정보
                     ON B.DLR_CD  = C.DLR_CD
                    AND B.ITEM_CD = C.ITEM_CD
                  LEFT OUTER JOIN PT_0211T D      --공급업체정보
                     ON A.DLR_CD     = D.DLR_CD
                    AND A.BP_CD      = D.BP_CD
                  LEFT OUTER JOIN (
                        SELECT   A.DLR_CD
                                ,A.PURC_ORD_NO
                                ,A.PURC_ORD_LINE_NO
                                ,A.INVC_QTY
                          FROM   PT_0432T A      --송장품목정보
                                 INNER JOIN PT_0431T B
                                    ON A.DLR_CD      = B.DLR_CD
                                   AND A.INVC_DOC_NO = B.INVC_DOC_NO
                                   AND B.INVC_TP     = '01'
                                   AND B.INVC_STAT_CD IN ('01' ,'02')
                                   AND B.CANC_YN    != 'Y'
                        ) E
                     ON B.DLR_CD           = E.DLR_CD
                    AND B.PURC_ORD_NO      = E.PURC_ORD_NO
                    AND B.PURC_ORD_LINE_NO = E.PURC_ORD_LINE_NO
         WHERE  A.DLR_CD = #{sDlrCd}
         <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
             AND A.PURC_ORD_TP = #{sPurcOrdTp}
         </if>        --구매오더유형
         <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
             AND A.PURC_ORD_NO = #{sPurcOrdNo}
         </if>        --구매오더정보
         <if test='sBpCd != null and sBpCd != ""'>
             AND A.BP_CD = #{sBpCd}
         </if>        --거래처코드
         <if test='sPurcReqDtFr != null'>
             AND B.PURC_REQ_DT <![CDATA[>=]]> #{sPurcReqDtFr}
         </if>
         <if test='sPurcReqDtTo != null'>
             AND B.PURC_REQ_DT <![CDATA[<=]]> #{sPurcReqDtTo} + 1
         </if>
         <if test='sPurcOrdStatCd   != null and sPurcOrdStatCd   != ""'>
             AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
         </if>        --구매오더상태코드
         AND  B.PURC_QTY <![CDATA[>]]> (NVL(B.GR_QTY,0) + NVL(E.INVC_QTY, 0))
         AND  B.DEL_YN  != 'Y'
    </select>

      <!-- 입고 확정 시 구매 품목 정보를 수정한다.(Only 입고 수량) -->
    <update id="updatePurcOrdCnfmItemByReceive" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.updatePurcOrdCnfmItemByReceive] */
        UPDATE DMSDB.PT_0422T A    --구매오더품목정보
          SET  A.GR_QTY             = NVL(A.GR_QTY, 0) + NVL(#{grQty}, 0)  --입고확정수량
              ,A.UPDT_USR_ID        = #{regUsrId}                          --수정자ID
              ,A.UPDT_DT            = sysdate
         WHERE A.DLR_CD             = #{dlrCd}                  --딜러코드
           AND A.PURC_ORD_NO        = #{purcOrdNo}              --구매오더번호
           AND A.PURC_ORD_LINE_NO   = #{purcOrdLineNo}          --구매오더라인번호
           AND NVL(TRIM(A.PURC_ORD_LINE_DETL_NO),'-999')  = NVL(TRIM(#{purcOrdLineDetlNo}),'-999')           --구매오더라인번호
           AND A.GR_END_YN != 'Y'
    </update>

      <!-- 입고 확정 시 구매 품목 정보를 수정한다.(BMP체크 수량(확정수량) == 기 입고확정 수량  + 입고 확정 수량) -->
    <update id="updatePurcOrdCnfmEndItemByReceive" parameterType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.updatePurcOrdCnfmEndItemByReceive] */
        UPDATE DMSDB.PT_0422T A    --구매오더품목정보
          SET  A.GR_END_YN          = 'Y'
              ,A.GR_QTY             = NVL(A.GR_QTY, 0) + NVL(#{grQty}, 0)  --입고확정수량
              ,A.UPDT_USR_ID        = #{regUsrId}                --수정자ID
              ,A.UPDT_DT            = sysdate
         WHERE A.DLR_CD             = #{dlrCd}                  --딜러코드
           AND A.PURC_ORD_NO        = #{purcOrdNo}              --구매오더번호
           AND A.PURC_ORD_LINE_NO   = #{purcOrdLineNo}          --구매오더라인번호
           AND NVL(TRIM(A.PURC_ORD_LINE_DETL_NO),'-999')  = NVL(TRIM(#{purcOrdLineDetlNo}),'-999')           --구매오더라인번호
           AND A.GR_END_YN != 'Y'
    </update>

    <!-- 구매오더번호, 라인번호에 의한 구매오더 부품 정보를 조회한다. -->
    <select id="selectItemInfoByPurcOrderInfo" parameterType="PurcOrdItemVO" resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectItemInfoByPurcOrderInfo] */
             SELECT A.DLR_CD                   --딜러코드
                   ,A.PURC_REQ_DT              --입고예정일
                   ,A.PURC_ITEM_STAT_CD        --구매품목상태코드
                   ,A.PURC_ORD_NO              --구매오더번호
                   ,A.PURC_ORD_LINE_NO         --구매오더라인번호
                   ,A.ITEM_CD                  --품목코드
                   ,B.ITEM_NM                  --품목명
                   ,A.PURC_QTY                 --구매수량
                   ,A.RESV_QTY                 --예약수량
                   ,A.GR_QTY                   --입고수량
                   ,A.PURC_UNIT_CD             --구매단위코드
                   ,A.PRC_TP                   --가격유형
                   ,A.PURC_PRC                 --구매단가
                   ,A.PURC_AMT                 --구매금액
                   ,A.TAX_DDCT_PRC             --구매단가(세전)
                   ,A.TAX_DDCT_AMT             --구매금액(세전)
                   ,A.PURC_ITEM_TP             --생성유형
                   ,A.DEL_YN                   --삭제여부
                   ,A.GR_END_YN                --입고완료여부
                   ,A.GR_STRGE_CD              --입고창고코드
                   ,A.PURC_REQ_NO              --구매요청번호
                   ,A.PURC_REQ_LINE_NO         --구매요청라인번호
                   ,A.BMP_ORD_NO               --BMP오더번호
                   ,A.BMP_CHK_QTY              --BMP확인수량
                   ,NVL(CASE WHEN NVL(A.CANC_QTY,0) = 0
                               THEN CASE WHEN C.PURC_ORD_STAT_CD = '05'
                                           THEN A.PURC_QTY
                                         ELSE 0 END
                             ELSE NVL(A.CANC_QTY,0) END,0) AS CANC_QTY                --취소수량
              FROM  DMSDB.PT_0422T A    --구매오더품목정보
                      INNER JOIN  DMSDB.PT_0201T B    --품목정보
                         ON A.DLR_CD  = B.DLR_CD
                        AND A.ITEM_CD = B.ITEM_CD
                      INNER JOIN DMSDB.PT_0421T C
                         ON A.DLR_CD      = C.DLR_CD
                        AND A.PURC_ORD_NO = C.PURC_ORD_NO
             WHERE  A.DLR_CD              = #{dlrCd}
               AND  A.PURC_ORD_NO         = #{purcOrdNo}
               AND  A.PURC_ORD_LINE_NO    = #{purcOrdLineNo}
               AND NVL(TRIM(A.PURC_ORD_LINE_DETL_NO),'-999')  = NVL(TRIM(#{purcOrdLineDetlNo}),'-999')           --구매오더라인번호
    </select>

    <!-- 구매현황 데이타 정보를 조회한다.. -->
    <select id="selectPurcOrdStatusByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusByCondition] */
        SELECT A.*
            FROM
            (
            SELECT
                ROWNUM AS RNUM
                , T1.*
            FROM (
                SELECT
                    F.DLR_CD                               <!-- 딜러코드 -->
                    ,F.BMP_ORD_NO                          <!-- BMP오더번호 -->
                    ,F.PURC_ORD_NO                         <!-- 구매오더번호 -->
                    ,F.PURC_ORD_LINE_NO                    <!-- 구매오더라인번호 -->
                    ,F.ITEM_CD                             <!-- 품목코드 -->
                    ,F.ITEM_NM                             <!-- 품목명 -->
                    ,F.CONFIRM_PAR_NO
                    ,F.CONFIRM_PAR_NM
                    ,F.PURC_REG_DT                         <!-- 구매요청일자 -->
                    ,F.SEND_DT                             <!-- 전송일자 -->
                    ,F.PURC_ORD_TP                         <!-- 구매오더유형 -->
                    ,F.BP_CD                               <!-- 거래처코드 -->
                    ,F.BP_NM                               <!-- 거래처명 -->
                    ,F.TRSF_TP                             <!-- 운송방식 -->
                    ,F.TRSF_USR_ID                         <!-- 운송자 -->
                    ,F.PURC_ITEM_STAT_CD                   <!-- 구매품목상태코드 -->
                    ,F.PURC_UNIT_CD                        <!-- 구매단위코드 -->
                    ,F.PURC_QTY                            <!-- 구매수량 -->
                    ,F.BMP_CHK_QTY                         <!-- BMP확인수량 -->
                    ,F.CONFIRM_QTY                         <!-- 확정수량 -->
                    ,F.BO_QTY                              <!-- B/O수량 -->
                    ,F.ODR_ALC_QT                          <!-- 할당수량 -->
                    ,F.ODR_OPIC_QT                         <!-- 피킹중수량 -->
                    ,F.ODR_OPAC_QT                         <!-- 포장중수량 -->
                    ,F.ODR_PAKD_QT                         <!-- 포장완료수량 -->
                    ,F.ODR_INV_QT                          <!-- 인보이스수량(SHIP_QTY + ODR_INV_QT) -->
                    ,F.GR_QTY                              <!-- 입고수량 -->
                    ,F.CANC_QTY                            <!-- 취소수량 -->
                    ,F.GR_STRGE_CD                         <!-- 입고창고코드 -->
                    ,F.PURC_PRC                            <!-- 구매단가 -->
                    ,F.PURC_AMT                            <!-- 구매금액 -->
                    ,F.TAX_DDCT_PRC                        <!-- 구매단가(세전) -->
                    ,F.TAX_DDCT_AMT                        <!-- 구매금액(세전) -->
                    ,F.PURC_PGSS_CD                        <!-- 진행상태 -->
                    ,F.EDIT_CD
                    ,F.REG_USR_ID                          <!-- 등록자ID -->
                    ,F.REG_USR_NM                          <!-- 등록자명 -->
                    ,F.PURC_REQ_REG_USR_ID                 <!-- 구매요청등록자ID -->
                    ,F.PURC_REQ_REG_USR_NM                 <!-- 등록자명 -->
                    ,F.MOBIS_INVC_NO
                    ,F.MOBIS_INVC_LINE_NO
                    ,F.BOX_NO
                    ,F.INVC_DT                             <!-- 발송일자 -->
                    ,F.ARRV_DT                             <!-- 도착일자(도착예정일자) -->
                    ,F.AVLB_STOCK_QTY                      <!-- 가용재고 -->
                    ,F.BORROW_QTY                          <!-- 차입 -->
                    ,F.RENT_QTY                            <!-- 대여수량 -->
                    ,F.RESV_STOCK_QTY                      <!-- 예류수량 -->
                    ,F.STOCK_QTY
                    ,F.DEL_YN
                    ,F.DL_DIST_CD                          <!-- lixinfei：仓库 筛选字段 -->
                    ,F.CANC_REQ_QTY
                    ,CASE WHEN F.PURC_PGSS_CD IN ('C','D','Y') THEN
                        CASE WHEN F.CONFIRM_QTY > 0 THEN F.CONFIRM_QTY - F.CANC_QTY ELSE 0 END
                        WHEN F.PURC_PGSS_CD IN ('X','Z') THEN NVL(F.CHECK_QTY,0)
                        ELSE F.CONFIRM_QTY
                        END CALC_CONFIRM_QTY
                    ,F.CONFIRM_DT
                    ,F.GI_EXPC_DT
                    ,F.BMP_PURC_PRC
                    ,F.CO_PACK        <!-- lixinfei: 新加字段CO-PACK -->
                    FROM (
                        SELECT
                            B.DLR_CD
                            ,A.BMP_ORD_NO
                            ,B.PURC_ORD_NO
                            ,B.PURC_ORD_LINE_NO
                            ,B.ITEM_CD
                            ,C.ITEM_NM
                            ,B.CONFIRM_PAR_NO
                            ,F.ITEM_NM AS CONFIRM_PAR_NM
                            ,A.PURC_REG_DT
                            ,A.SEND_DT
                            ,A.PURC_ORD_TP
                            ,A.BP_CD
                            ,D.BP_NM
                            ,A.TRSF_TP
                            ,'' AS TRSF_USR_ID
                            ,B.PURC_ITEM_STAT_CD
                            ,B.PURC_UNIT_CD
                            ,B.PURC_QTY
                            ,B.BMP_CHK_QTY
                            ,B.CONFIRM_QTY
                            ,B.BO_QTY
                            ,B.ODR_ALC_QT
                            ,B.ODR_OPIC_QT
                            ,B.ODR_OPAC_QT
                            ,B.ODR_PAKD_QT
                            ,NVL(B.SHIP_QTY,0)+NVL(B.ODR_INV_QT,0) AS ODR_INV_QT
                            ,B.GR_QTY
                            ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0 THEN
                                CASE WHEN A.PURC_ORD_STAT_CD = '05' THEN B.PURC_QTY ELSE 0 END
                                ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY
                            ,B.GR_STRGE_CD
                            ,B.PURC_PRC
                            ,B.PURC_AMT
                            ,B.TAX_DDCT_PRC
                            ,B.TAX_DDCT_AMT
                            ,B.PURC_PGSS_CD
                            ,B.EDIT_CD
                            ,A.REG_USR_ID
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM
                            ,E.REG_USR_ID AS PURC_REQ_REG_USR_ID
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.REG_USR_ID) AS PURC_REQ_REG_USR_NM
                            ,G.MOBIS_INVC_NO
                            ,G.MOBIS_INVC_LINE_NO
                            ,G.BOX_NO
                            ,G.INVC_DT
                            ,G.ARRV_DT
                            ,NVL(I.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                            ,NVL(I.BORROW_QTY,0) AS BORROW_QTY
                            ,NVL(I.RENT_QTY,0) AS RENT_QTY
                            ,NVL(I.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                            ,NVL(I.AVLB_STOCK_QTY,0) + NVL(I.RESV_STOCK_QTY,0) - NVL(I.BORROW_QTY,0) + NVL(I.RENT_QTY,0) AS STOCK_QTY
                            ,B.DEL_YN
                            ,CASE WHEN NVL(B.BMP_ORD_NO,'-999') = '-999' THEN ' ' WHEN SUBSTR(B.BMP_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') THEN J.DL_DIST_CD ELSE 'PD'||SUBSTR(B.BMP_ORD_NO,6,1) END DL_DIST_CD       <!-- lixinfei：仓库 筛选字段 -->
                            ,CASE WHEN B.PURC_ITEM_STAT_CD = '05' AND B.DEL_YN = 'Y' AND B.BMP_ORD_NO IS NOT NULL
                                    THEN NVL(B.CANC_QTY,0)
                                  ELSE NVL(B.CANC_REQ_QTY,0)
                              END  CANC_REQ_QTY
                            ,NVL(B.SHIP_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0) AS CHECK_QTY
                                                                      <!-- 선적수량, ALLOCATION 수량, ON_PICK 수량, PAKD 수량, INVOCED 수량 -->
                            ,A.ARRV_DT AS CONFIRM_DT                  <!-- B/O에 있는 전송일자 20170707 -->
                            ,B.GI_EXPC_DT
                            ,CASE WHEN NVL(K.BMP_PURC_PRC,0) <![CDATA[>]]> 0
                                    THEN K.BMP_PURC_PRC
                                  ELSE NVL((SELECT NVL(ROUND(T.APCP_PRICE_NAT_AMT * (1 + FN_GET_VAT(null,'ALL')),2),0)
                                          FROM PT_0216I T
                                         WHERE (APCP_PART_NO,APCP_APPLY_DATE) IN (
                                                  SELECT APCP_PART_NO,
                                                         MAX(APCP_APPLY_DATE) AS APCP_APPLY_DATE
                                                    FROM PT_0216I I
                                                   WHERE I.APCP_PART_NO = B.ITEM_CD
                                                GROUP BY APCP_PART_NO )
                                       ),
                                       (SELECT NVL(ROUND(LPR_LST_PRC * ( 1 + FN_GET_VAT(null,'ALL')),2),0)
                                          FROM PT_0214I T2
                                         WHERE (LPR_PNO,LPR_APL_DT) IN (
                                                    SELECT LPR_PNO,
                                                           MAX(LPR_APL_DT) AS LPR_APL_DT
                                                      FROM PT_0214I T3
                                                     WHERE TRIM(T3.LPR_PNO) = B.ITEM_CD
                                                  GROUP BY LPR_PNO))
                              ) END  BMP_PURC_PRC
                              ,A.CO_PACK        --lixinfei: 新加字段CO-PACK
                        FROM DMSDB.PT_0421T A              <!-- 구매오더헤더정보 -->
                        INNER JOIN DMSDB.PT_0422T B        <!-- 구매오더품목정보 -->
                            ON A.DLR_CD = B.DLR_CD
                            AND A.PURC_ORD_NO = B.PURC_ORD_NO
                        INNER JOIN DMSDB.PT_0201T C        <!-- 품목정보 -->
                            ON B.DLR_CD  = C.DLR_CD
                            AND B.ITEM_CD = C.ITEM_CD
                        LEFT OUTER JOIN PT_0211T D          <!-- 공급업체정보 -->
                            ON A.DLR_CD  = D.DLR_CD
                            AND A.BP_CD   = D.BP_CD
                        LEFT OUTER JOIN PT_0411T E          <!-- 구매요청정보 -->
                            ON B.DLR_CD           = E.DLR_CD
                            AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                            AND B.ITEM_CD          = E.ITEM_CD
                        LEFT OUTER JOIN  DMSDB.PT_0201T F   <!-- 확정품목정보 -->
                            ON B.DLR_CD         = F.DLR_CD
                            AND B.CONFIRM_PAR_NO = F.ITEM_CD
                        LEFT OUTER JOIN (
                            SELECT
                                A.DLR_CD
                                ,B.PURC_ORD_NO
                                ,B.PURC_ORD_LINE_NO
                                ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                                ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                                ,MAX(B.BOX_NO) AS BOX_NO
                                ,MAX(A.INVC_DT) AS INVC_DT     <!-- 발송일자 -->
                                ,MAX(A.ARRV_DT) AS ARRV_DT     <!-- 도착일자(도착예정일자) -->
                            FROM PT_0431T A
                            INNER JOIN PT_0432T B
                                ON A.DLR_CD      = B.DLR_CD
                                AND A.INVC_DOC_NO = B.INVC_DOC_NO
                            GROUP BY A.DLR_CD, B.PURC_ORD_NO, B.PURC_ORD_LINE_NO
                        ) G
                            ON B.DLR_CD           = G.DLR_CD
                            AND B.PURC_ORD_NO      = G.PURC_ORD_NO
                            AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
                        LEFT OUTER JOIN PT_0701T H
                            ON A.DLR_CD = H.DLR_CD
                        LEFT OUTER JOIN PT_0301T I
                            ON C.DLR_CD           = I.DLR_CD
                            AND C.ITEM_CD          = I.ITEM_CD
                            AND C.GR_STRGE_CD      = I.STRGE_CD
                        LEFT OUTER JOIN PT_0701T J
                          ON A.DLR_CD = J.DLR_CD
                         LEFT JOIN
                        (
                            SELECT
                                DLR_CD
                                ,ITEM_CD
                                ,MAX(PRC_TP) AS PRC_TP
                                ,MAX(LINE_NO) AS LINE_NO
                                ,MAX(NVL(SALE_PRC_AMT,0)) AS BMP_PURC_PRC
                            FROM PT_0214T
                            WHERE DLR_CD = #{sDlrCd}
                            AND NVL(DEL_YN,'N') != 'Y'
                            GROUP BY DLR_CD, ITEM_CD
                        ) K ON B.DLR_CD = K.DLR_CD AND B.ITEM_CD = K.ITEM_CD
                    WHERE  B.DLR_CD  = #{sDlrCd}        <!-- 딜러코드 -->
                    <if test='sDelYn != null and sDelYn != ""'>
                        AND  (B.DEL_YN !=   'Y' or (B.DEL_YN =   'Y' AND B.BMP_ORD_NO IS NOT NULL))
                    </if>
                    <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                        AND A.PURC_ORD_NO LIKE '%'|| #{sPurcOrdNo} ||'%'
                    </if>        <!-- 구매오더정보 -->
                    <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                        AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
                    </if>        <!-- bmp오더정보 -->
                    <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                        AND A.PURC_ORD_TP = #{sPurcOrdTp}
                    </if>        <!-- 구매오더유형 -->
                    <if test='sTrsfTp != null and sTrsfTp != ""'>
                        AND A.TRSF_TP = #{sTrsfTp}
                    </if>        <!-- 운송유형 -->
                    <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                        AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                    </if>        <!-- 구매오더상태코드 -->
                    <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                        AND A.PURC_ORD_STAT_CD IN
                        <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if>        <!-- 구매오더상태코드 -->
                    <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                        AND A.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                           #{item}
                        </foreach>
                    </if>        <!-- 거래처코드 -->
                    <if test='sPurcRegDtFr != null'>
                         AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                    </if>
                    <if test='sPurcRegDtTo != null'>
                         AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                    </if>
                    <if test='sArrvDtFr != null'>
                         AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
                    </if>
                    <if test='sArrvDtTo != null'>
                         AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
                    </if>
                    <if test='sSendDtFr != null'>
                         AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
                    </if>
                    <if test='sSendDtTo != null'>
                         AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
                    </if>
                    <if test='sRegUsrId != null and sRegUsrId != ""'>
                        AND A.REG_USR_ID = #{sRegUsrId}
                    </if>        <!-- 등록자ID -->
                    <if test='sBpCd != null and sBpNm != ""'>
                        AND A.BP_CD = #{sBpCd}
                    </if>        <!-- 거래처코드 -->
                    <if test='sGrEndYn != null and sGrEndYn != ""'>
                        AND B.GR_END_YN = #{sGrEndYn}
                    </if>        <!-- 입고완료여부 -->
                    <if test='sItemCd != null and sItemCd != ""'>
                        AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                    </if>        <!-- 품목명 -->
                    <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                        AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
                    </if>        <!-- 품목구분코드 -->
                    <if test='sAbcInd != null and sAbcInd != ""'>
                        AND C.ABC_IND = #{sAbcInd}
                    </if>        <!-- ABC CLASS -->
                    <if test='sCarlineCd != null and sCarlineCd != ""'>
                        AND C.CARLINE_CD = #{sCarlineCd}
                    </if>        <!-- 차종코드 -->
                    <if test='sItemNm != null and sItemNm != ""'>
                        AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                    </if>        <!-- 품목명 -->
                    <if test='sBoYn != null and sBoYn != ""'>
                        AND B.BO_QTY <![CDATA[>]]> 0
                    </if>        <!-- 운송유형 -->
                    ) F
                WHERE 1=1
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
                    </if>
                    <if test='sDlDistCd != null and sDlDistCd != ""'>   <!-- lixinfei：仓库 筛选字段 -->
                        AND F.DL_DIST_CD = #{sDlDistCd}
                    </if>
                    <if test='sConfirmFr != null'>
                         AND TO_DATE(F.CONFIRM_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
                    </if>
                    <if test='sConfirmTo != null'>
                         AND TO_DATE(F.CONFIRM_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
                    </if>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "purcRegDt"'> F.PURC_REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdTp"'> F.PURC_ORD_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bpCd"'> F.BP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regUsrId"'> F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdNo"'> F.PURC_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdLineNo"'> F.PURC_ORD_LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcItemStatCd"'> F.PURC_ITEM_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "itemCd"'> F.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcUnitCd"'> F.PURC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcQty"'> F.PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bmpChkQty"'> F.BMP_CHK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grQty"'> F.GR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "cancQty"'> F.CANC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grStrgeCd"'> F.GR_STRGE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcPrc"'> F.PURC_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcAmt"'> F.PURC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "itemNm"'> F.ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bpNm"'> F.BP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcReqRegUsrId"'> F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "confirmDt"'> F.CONFIRM_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    F.DLR_CD ASC
                                    ,F.PURC_REG_DT DESC
                                    ,F.PURC_ORD_NO DESC
                                    ,F.PURC_ORD_LINE_NO ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        F.DLR_CD ASC
                        ,F.PURC_REG_DT DESC
                        ,F.PURC_ORD_NO DESC
                        ,F.PURC_ORD_LINE_NO ASC
                    </otherwise>
                </choose>
            ) T1
        ) A
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 구매현황 데이타 정보를 조회한다.. -->
    <select id="selectPurcOrdStatusSummary" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusSummary] */
        SELECT SUM(BMP_CHK_CNT) AS BMP_CHK_CNT
              ,SUM(BMP_CHK_QTY) AS BMP_CHK_QTY
              ,SUM(BMP_CHK_AMT) AS BMP_CHK_AMT
              ,SUM(CALC_CONFIRM_CNT) AS CALC_CONFIRM_CNT
              ,SUM(CALC_CONFIRM_QTY) AS CALC_CONFIRM_QTY
              ,SUM(CALC_CONFIRM_AMT) AS CALC_CONFIRM_AMT
              ,SUM(ODR_ALC_QT_CNT) AS ODR_ALC_CNT
              ,SUM(ODR_ALC_QT) AS ODR_ALC_QTY
              ,SUM(ODR_ALC_AMT) AS ODR_ALC_AMT
              ,SUM(BO_CNT) AS BO_CNT
              ,SUM(BO_QTY) AS BO_QTY
              ,SUM(BO_AMT) AS BO_AMT
              ,SUM(ODR_OPIC_CNT) AS ODR_OPIC_CNT
              ,SUM(ODR_OPIC_QT) AS ODR_OPIC_QTY
              ,SUM(ODR_OPIC_AMT) AS ODR_OPIC_AMT
              ,SUM(ODR_OPAC_CNT) AS ODR_OPAC_CNT
              ,SUM(ODR_OPAC_QT) AS ODR_OPAC_QTY
              ,SUM(ODR_OPAC_AMT) AS ODR_OPAC_AMT
              ,SUM(ODR_OPAC_CNT) AS ODR_PAKD_CNT
              ,SUM(ODR_OPAC_QT) AS ODR_PAKD_QTY
              ,SUM(ODR_OPAC_AMT) AS ODR_PAKD_AMT
              ,SUM(ODR_INV_CNT) AS ODR_INV_CNT
              ,SUM(ODR_INV_QT) AS ODR_INV_QTY
              ,SUM(ODR_INV_AMT) AS ODR_INV_AMT
              ,SUM(ODR_DLR_BO_CNT) AS ODR_DLR_BO_CNT
              ,SUM(ODR_DLR_BO_QTY) AS ODR_DLR_BO_QTY
              ,SUM(ODR_DLR_BO_AMT) AS ODR_DLR_BO_AMT
        FROM
        (
        SELECT   CASE WHEN  NVL(A.BMP_CHK_QTY,0) > 0 THEN 1 ELSE 0 END BMP_CHK_CNT
                ,A.BMP_CHK_QTY
                ,A.PURC_PRC * A.BMP_CHK_QTY AS BMP_CHK_AMT
                ,CASE WHEN  NVL(A.CALC_CONFIRM_QTY,0) > 0 THEN 1 ELSE 0 END CALC_CONFIRM_CNT
                ,A.CALC_CONFIRM_QTY
                ,A.PURC_PRC * A.CALC_CONFIRM_QTY AS CALC_CONFIRM_AMT
                ,CASE WHEN  NVL(A.ODR_ALC_QT,0) > 0 THEN 1 ELSE 0 END ODR_ALC_QT_CNT
                ,A.ODR_ALC_QT
                ,A.PURC_PRC * A.ODR_ALC_QT AS ODR_ALC_AMT
                ,CASE WHEN  NVL(A.BO_QTY,0) > 0 THEN 1 ELSE 0 END BO_CNT
                ,A.BO_QTY
                ,A.PURC_PRC * A.BO_QTY AS BO_AMT
                ,CASE WHEN  NVL(A.ODR_OPIC_QT,0) > 0 THEN 1 ELSE 0 END ODR_OPIC_CNT
                ,A.ODR_OPIC_QT
                ,A.PURC_PRC * A.ODR_OPIC_QT AS ODR_OPIC_AMT
                ,CASE WHEN  NVL(A.ODR_OPAC_QT,0) > 0 THEN 1 ELSE 0 END ODR_OPAC_CNT
                ,A.ODR_OPAC_QT
                ,A.PURC_PRC * A.ODR_OPAC_QT AS ODR_OPAC_AMT
                ,CASE WHEN  NVL(A.ODR_PAKD_QT,0) > 0 THEN 1 ELSE 0 END ODR_PAKD_CNT
                ,A.ODR_PAKD_QT
                ,A.PURC_PRC * A.ODR_PAKD_QT AS ODR_PAKD_AMT
                ,CASE WHEN  NVL(A.ODR_INV_QT,0) > 0 THEN 1 ELSE 0 END ODR_INV_CNT
                ,A.ODR_INV_QT
                ,A.PURC_PRC * A.ODR_INV_QT AS ODR_INV_AMT
                ,CASE WHEN  NVL(A.ODR_DLR_BO_QTY,0) > 0 THEN 1 ELSE 0 END ODR_DLR_BO_CNT
                ,A.ODR_DLR_BO_QTY
                ,A.PURC_PRC * A.ODR_DLR_BO_QTY AS ODR_DLR_BO_AMT
          FROM
        (
        SELECT   B.DLR_CD
                ,A.BMP_ORD_NO
                ,B.PURC_ORD_NO
                ,B.PURC_ORD_LINE_NO
                ,B.ITEM_CD
                ,C.ITEM_NM
                ,B.CONFIRM_PAR_NO
                ,F.ITEM_NM AS CONFIRM_PAR_NM
                ,A.PURC_REG_DT
                ,A.SEND_DT
                ,A.PURC_ORD_TP
                ,A.BP_CD
                ,D.BP_NM
                ,A.TRSF_TP
                ,'' AS TRSF_USR_ID
                ,B.PURC_ITEM_STAT_CD
                ,B.PURC_UNIT_CD
                ,B.PURC_QTY
                ,NVL(B.BMP_CHK_QTY,0) AS BMP_CHK_QTY
                ,NVL(B.CONFIRM_QTY,0) AS CONFIRM_QTY
                ,CASE WHEN B.PURC_PGSS_CD IN ('C','D','Y') THEN
                        CASE WHEN NVL(B.CONFIRM_QTY,0) > 0 THEN NVL(B.CONFIRM_QTY,0) - (NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0 THEN
                                                                                     CASE WHEN A.PURC_ORD_STAT_CD = '05' THEN NVL(B.PURC_QTY,0) ELSE 0 END
                                                                                   ELSE NVL(B.CANC_QTY,0) END,0))
                             ELSE 0
                        END
                      WHEN B.PURC_PGSS_CD IN ('X','Z') THEN NVL((NVL(B.SHIP_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0)),0)
                      ELSE B.CONFIRM_QTY
                 END CALC_CONFIRM_QTY
                ,NVL(B.BO_QTY,0) AS BO_QTY
                ,NVL(B.ODR_ALC_QT,0) AS ODR_ALC_QT
                ,NVL(B.ODR_OPIC_QT,0) AS ODR_OPIC_QT
                ,NVL(B.ODR_OPAC_QT,0) AS ODR_OPAC_QT
                ,NVL(B.ODR_PAKD_QT,0) AS ODR_PAKD_QT
                ,NVL(B.SHIP_QTY,0)+NVL(B.ODR_INV_QT,0) AS ODR_INV_QT
                ,NVL(B.GR_QTY,0) AS GR_QTY
                ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0 THEN
                    CASE WHEN A.PURC_ORD_STAT_CD = '05' THEN NVL(B.PURC_QTY,0) ELSE 0 END
                    ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY
                ,B.GR_STRGE_CD
                ,NVL(B.PURC_PRC,0) AS PURC_PRC
                ,B.PURC_AMT
                ,B.TAX_DDCT_PRC
                ,B.TAX_DDCT_AMT
                ,B.PURC_PGSS_CD
                ,B.EDIT_CD
                ,A.REG_USR_ID
                ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM
                ,E.REG_USR_ID AS PURC_REQ_REG_USR_ID
                ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.REG_USR_ID) AS PURC_REQ_REG_USR_NM
                ,G.MOBIS_INVC_NO
                ,G.MOBIS_INVC_LINE_NO
                ,G.BOX_NO
                ,G.INVC_DT
                ,G.ARRV_DT
                ,NVL(I.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                ,NVL(I.BORROW_QTY,0) AS BORROW_QTY
                ,NVL(I.RENT_QTY,0) AS RENT_QTY
                ,NVL(I.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                ,NVL(I.AVLB_STOCK_QTY,0) + NVL(I.RESV_STOCK_QTY,0) - NVL(I.BORROW_QTY,0) + NVL(I.RENT_QTY,0) AS STOCK_QTY
                ,B.DEL_YN
                ,CASE WHEN NVL(B.BMP_ORD_NO,'-999') = '-999' THEN ' ' WHEN SUBSTR(B.BMP_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') THEN J.DL_DIST_CD ELSE 'PD'||SUBSTR(B.BMP_ORD_NO,6,1) END DL_DIST_CD
                ,NVL(B.CANC_REQ_QTY,0) AS CANC_REQ_QTY
                ,NVL(B.SHIP_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0) AS CHECK_QTY
                ,NVL(B.BO_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_OPAC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0) AS ODR_DLR_BO_QTY
                ,A.ARRV_DT AS CONFIRM_DT
                ,B.GI_EXPC_DT
            FROM DMSDB.PT_0421T A
            INNER JOIN DMSDB.PT_0422T B
                ON A.DLR_CD = B.DLR_CD
                AND A.PURC_ORD_NO = B.PURC_ORD_NO
            INNER JOIN DMSDB.PT_0201T C
                ON B.DLR_CD  = C.DLR_CD
                AND B.ITEM_CD = C.ITEM_CD
            LEFT OUTER JOIN PT_0211T D
                ON A.DLR_CD  = D.DLR_CD
                AND A.BP_CD   = D.BP_CD
            LEFT OUTER JOIN PT_0411T E
                ON B.DLR_CD           = E.DLR_CD
                AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                AND B.ITEM_CD          = E.ITEM_CD
            LEFT OUTER JOIN  DMSDB.PT_0201T F
                ON B.DLR_CD         = F.DLR_CD
                AND B.CONFIRM_PAR_NO = F.ITEM_CD
            LEFT OUTER JOIN (
                SELECT
                    A.DLR_CD
                    ,B.PURC_ORD_NO
                    ,B.PURC_ORD_LINE_NO
                    ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                    ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                    ,MAX(B.BOX_NO) AS BOX_NO
                    ,MAX(A.INVC_DT) AS INVC_DT
                    ,MAX(A.ARRV_DT) AS ARRV_DT
                FROM PT_0431T A
                INNER JOIN PT_0432T B
                    ON A.DLR_CD      = B.DLR_CD
                    AND A.INVC_DOC_NO = B.INVC_DOC_NO
                GROUP BY A.DLR_CD, B.PURC_ORD_NO, B.PURC_ORD_LINE_NO
            ) G
                ON B.DLR_CD           = G.DLR_CD
                AND B.PURC_ORD_NO      = G.PURC_ORD_NO
                AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
            LEFT OUTER JOIN PT_0701T H
                ON A.DLR_CD = H.DLR_CD
            LEFT OUTER JOIN PT_0301T I
                ON C.DLR_CD           = I.DLR_CD
                AND C.ITEM_CD          = I.ITEM_CD
                AND C.GR_STRGE_CD      = I.STRGE_CD
            LEFT OUTER JOIN PT_0701T J
              ON A.DLR_CD = J.DLR_CD
        WHERE  B.DLR_CD  = #{sDlrCd}        <!-- 딜러코드 -->
             <if test='sDelYn != null and sDelYn != ""'>
                AND  B.DEL_YN !=   'Y'
            </if>
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND A.PURC_ORD_NO LIKE '%'|| #{sPurcOrdNo} ||'%'
            </if>        <!-- 구매오더정보 -->
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
            </if>        <!-- bmp오더정보 -->
            <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                AND A.PURC_ORD_TP = #{sPurcOrdTp}
            </if>        <!-- 구매오더유형 -->
            <if test='sTrsfTp != null and sTrsfTp != ""'>
                AND A.TRSF_TP = #{sTrsfTp}
            </if>        <!-- 운송유형 -->
            <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
            </if>        <!-- 구매오더상태코드 -->
            <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                AND A.PURC_ORD_STAT_CD IN
                <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>        <!-- 구매오더상태코드 -->
            <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                AND A.BP_CD IN
                <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                   #{item}
                </foreach>
            </if>        <!-- 거래처코드 -->
            <if test='sPurcRegDtFr != null'>
                 AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
            </if>
            <if test='sPurcRegDtTo != null'>
                 AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
            </if>
            <if test='sArrvDtFr != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
            </if>
            <if test='sArrvDtTo != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
            </if>
            <if test='sSendDtFr != null'>
                 AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
            </if>
            <if test='sSendDtTo != null'>
                 AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
            </if>
            <if test='sRegUsrId != null and sRegUsrId != ""'>
                AND A.REG_USR_ID = #{sRegUsrId}
            </if>        <!-- 등록자ID -->
            <if test='sBpCd != null and sBpNm != ""'>
                AND A.BP_CD = #{sBpCd}
            </if>        <!-- 거래처코드 -->
            <if test='sGrEndYn != null and sGrEndYn != ""'>
                AND B.GR_END_YN = #{sGrEndYn}
            </if>        <!-- 입고완료여부 -->
            <if test='sItemCd != null and sItemCd != ""'>
                AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
            </if>        <!-- 품목명 -->
            <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
            </if>        <!-- 품목구분코드 -->
            <if test='sAbcInd != null and sAbcInd != ""'>
                AND C.ABC_IND = #{sAbcInd}
            </if>        <!-- ABC CLASS -->
            <if test='sCarlineCd != null and sCarlineCd != ""'>
                AND C.CARLINE_CD = #{sCarlineCd}
            </if>        <!-- 차종코드 -->
            <if test='sItemNm != null and sItemNm != ""'>
                AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
            </if>        <!-- 품목명 -->
            <if test='sBoYn != null and sBoYn != ""'>
                AND B.BO_QTY <![CDATA[>]]> 0
            </if>        <!-- 운송유형 -->
        )  A
        WHERE 1=1
        <if test='sRegUsrNm != null and sRegUsrNm != ""'>
            AND A.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
        </if>
        <if test='sConfirmFr != null'>
             AND TO_DATE(A.CONFIRM_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
        </if>
        <if test='sConfirmTo != null'>
             AND TO_DATE(A.CONFIRM_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
        </if>
        ) A
    </select>

      <!-- 구매현황 데이타 총 갯수를 조회한다. -->
    <select id="selectPurcOrdStatusByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusByConditionCnt] */
    SELECT COUNT(*) FROM (
        SELECT
            A.*
            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
            ,CASE WHEN NVL(B.BMP_ORD_NO,'-999') = '-999' 
				THEN ' ' 
				WHEN SUBSTR(B.BMP_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') 
				THEN H.DL_DIST_CD 
				ELSE 'PD'||SUBSTR(B.BMP_ORD_NO,6,1) 
				END DL_DIST_CD       <!-- lixinfei：仓库 筛选字段 -->
        FROM DMSDB.PT_0421T A                      --구매오더헤더정보
        INNER JOIN DMSDB.PT_0422T B    --구매오더품목정보
           ON A.DLR_CD      = B.DLR_CD
          AND A.PURC_ORD_NO = B.PURC_ORD_NO
        INNER JOIN  DMSDB.PT_0201T C    --품목정보
                     ON B.DLR_CD  = C.DLR_CD
                    AND B.ITEM_CD = C.ITEM_CD
        LEFT OUTER JOIN PT_0211T D      --공급업체정보
                     ON A.DLR_CD  = D.DLR_CD
                    AND A.BP_CD   = D.BP_CD
        LEFT OUTER JOIN PT_0411T E      --구매요청정보
                     ON B.DLR_CD           = E.DLR_CD
                    AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                    AND B.ITEM_CD          = E.ITEM_CD
        LEFT OUTER JOIN  DMSDB.PT_0201T F    --확정품목정보
                     ON B.DLR_CD         = F.DLR_CD
                    AND B.CONFIRM_PAR_NO = F.ITEM_CD
        LEFT OUTER JOIN (
            SELECT A.DLR_CD
                   ,B.PURC_ORD_NO
                   ,B.PURC_ORD_LINE_NO
                   ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                   ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                   ,MAX(B.BOX_NO) AS BOX_NO
                   ,MAX(A.INVC_DT) AS INVC_DT                             --발송일자
                   ,MAX(A.ARRV_DT) AS ARRV_DT                             --도착일자(도착예정일자)
            FROM PT_0431T A
            INNER JOIN PT_0432T B
               ON A.DLR_CD      = B.DLR_CD
              AND A.INVC_DOC_NO = B.INVC_DOC_NO
            GROUP BY A.DLR_CD
                     ,B.PURC_ORD_NO
                     ,B.PURC_ORD_LINE_NO) G
               ON B.DLR_CD           = G.DLR_CD
              AND B.PURC_ORD_NO      = G.PURC_ORD_NO
              AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
        LEFT OUTER JOIN PT_0701T H
                     ON A.DLR_CD = H.DLR_CD
        WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
        <if test='sDelYn != null and sDelYn != ""'>
            AND  (B.DEL_YN !=   'Y' or (B.DEL_YN =   'Y' AND B.BMP_ORD_NO IS NOT NULL))
        </if>
        <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
            AND A.PURC_ORD_NO like '%'|| #{sPurcOrdNo} ||'%'
        </if>        --구매오더정보
        <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
            AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
        </if>        --구매오더정보
        <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
            AND A.PURC_ORD_TP = #{sPurcOrdTp}
        </if>        --구매오더유형
        <if test='sTrsfTp != null and sTrsfTp != ""'>
            AND A.TRSF_TP = #{sTrsfTp}
        </if>        --운송유형
        <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
            AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
        </if>        --구매오더상태코드
        <if test='sPurcOrdStatLst  != null and !sPurcOrdStatLst.isEmpty'>
            AND A.PURC_ORD_STAT_CD IN
            <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>        --구매오더상태코드
        <if test='sBpCdList != null and !sBpCdList.isEmpty'>
            AND A.BP_CD IN
            <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>        --거래처코드
        <if test='sPurcRegDtFr != null'>
             AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
        </if>
        <if test='sPurcRegDtTo != null'>
             AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
        </if>
        <if test='sArrvDtFr != null'>
             AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
        </if>
        <if test='sArrvDtTo != null'>
             AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
        </if>
        <if test='sSendDtFr != null'>
             AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
        </if>
        <if test='sSendDtTo != null'>
             AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
        </if>
        <if test='sRegUsrId != null and sRegUsrId != ""'>
            AND A.REG_USR_ID = #{sRegUsrId}
        </if>        --등록자ID
        <if test='sBpCd != null and sBpNm != ""'>
            AND A.BP_CD = #{sBpCd}
        </if>        --거래처코드
        <if test='sGrEndYn != null and sGrEndYn != ""'>
            AND B.GR_END_YN = #{sGrEndYn}
        </if>        --입고완료여부
        <if test='sItemCd != null and sItemCd != ""'>
            AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
        </if>  --품목명
        <if test='sItemDstinCd != null and sItemDstinCd != ""'>
            AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
        </if>        --품목구분코드
        <if test='sAbcInd != null and sAbcInd != ""'>
            AND C.ABC_IND = #{sAbcInd}
        </if>        --ABC CLASS
        <if test='sCarlineCd != null and sCarlineCd != ""'>
            AND C.CARLINE_CD       = #{sCarlineCd}
        </if>        --차종코드
        <if test='sItemNm != null and sItemNm != ""'>
            AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
        </if>  --품목명
        <if test='sBoYn != null and sBoYn != ""'>
            AND B.BO_QTY <![CDATA[>]]> 0
        </if>        --운송유형
        ) F
        WHERE 1=1
        <if test='sRegUsrNm != null and sRegUsrNm != ""'>
            AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
        </if>
        <if test='sDlDistCd != null and sDlDistCd != ""'>   <!-- lixinfei：仓库 筛选字段 -->
            AND F.DL_DIST_CD = #{sDlDistCd}
        </if>
        <if test='sConfirmFr != null'>  <!-- 구매오더상태 전송일자 : 0421T의 ARRV_DT , 20170713  -->
            AND TO_DATE(F.ARRV_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
        </if>
        <if test='sConfirmTo != null'>
            AND TO_DATE(F.ARRV_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
        </if>
    </select>

    <!-- 구매현황 데이타 정보를 조회한다.. -->
    <select id="selectPurcOrdStatusByConditionForPurcOrdSummary" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusByConditionForPurcOrdSummary] */
       SELECT A.*
          FROM
            (
            SELECT   ROWNUM AS RNUM
                   , T1.*
              FROM (
                   SELECT
                       F.DLR_CD                               --딜러코드
                       ,F.BMP_ORD_NO                          --BMP오더번호
                       ,F.PURC_ORD_NO                         --구매오더번호
                       ,F.PURC_ORD_LINE_NO                    --구매오더라인번호
                       ,F.ITEM_CD                             --품목코드
                       ,F.ITEM_NM                             --품목명
                       ,F.CONFIRM_PAR_NO
                       ,F.CONFIRM_PAR_NM
                       ,F.PURC_REG_DT                         --구매요청일자
                       ,F.SEND_DT                             --전송일자
                       ,F.PURC_ORD_TP                         --구매오더유형
                       ,F.BP_CD                               --거래처코드
                       ,F.BP_NM                               --거래처명
                       ,F.TRSF_TP                             --운송방식
                       ,F.TRSF_USR_ID                         --운송자
                       ,F.PURC_ITEM_STAT_CD                   --구매품목상태코드
                       ,F.PURC_UNIT_CD                        --구매단위코드
                       ,F.PURC_QTY                            --구매수량
                       ,F.BMP_CHK_QTY                         --BMP확인수량
                       ,F.CONFIRM_QTY                         --확정수량
                       ,F.BO_QTY                              --B/O수량
                       ,F.ODR_ALC_QT                          --할당수량
                       ,F.ODR_OPIC_QT                         --피킹중수량
                       ,F.ODR_OPAC_QT                         --포장중수량
                       ,F.ODR_PAKD_QT                         --포장완료수량
                       ,F.ODR_INV_QT                          --인보이스수량(SHIP_QTY + ODR_INV_QT)
                       ,F.GR_QTY                              --입고수량
                       ,F.CANC_QTY                            --취소수량
                       ,F.GR_STRGE_CD                         --입고창고코드
                       ,F.PURC_PRC                            --구매단가
                       ,F.PURC_AMT                            --구매금액
                       ,F.TAX_DDCT_PRC                        --구매단가(세전)
                       ,F.TAX_DDCT_AMT                        --구매금액(세전)
                       ,F.PURC_PGSS_CD                        --진행상태
                       ,F.EDIT_CD                             --진행상태
                       ,F.REG_USR_ID                          --등록자ID
                       ,F.REG_USR_NM                          --등록자명
                       ,F.PURC_REQ_REG_USR_ID   --구매요청등록자ID
                       ,F.PURC_REQ_REG_USR_NM                 --등록자명
                       ,F.DL_DIST_CD
                       ,F.AVLB_STOCK_QTY                      --가용재고
                       ,F.BORROW_QTY                          --차입
                       ,F.RENT_QTY                            --대여수량
                       ,F.RESV_STOCK_QTY                      --예류수량
                       ,F.STOCK_QTY
                       ,F.DEL_YN
                       ,CASE WHEN F.PURC_ORD_STAT_CD IN ('01','02') THEN F.PURC_QTY     -- 신규생성 일때 : 오더수량을 그대로 보여줌
                             WHEN F.PURC_ORD_STAT_CD IN ('05') THEN 0 --취소일때:0
                        ELSE
                            CASE WHEN F.PURC_PGSS_CD IN ('C','D','Y') THEN
                                CASE WHEN F.CONFIRM_QTY > 0 THEN F.CONFIRM_QTY - F.CANC_QTY ELSE 0 END
                            WHEN F.PURC_PGSS_CD IN ('X','Z') THEN NVL(F.CHECK_QTY,0)
                            ELSE F.CONFIRM_QTY END
                        END CALC_CONFIRM_QTY                 <!-- CURRENT 수량 -->
                       ,CASE WHEN F.PURC_ORD_STAT_CD IN ('01','02') THEN F.PURC_AMT
                             WHEN F.PURC_ORD_STAT_CD IN ('05') THEN 0 --취소일때:0
                        ELSE
                            CASE WHEN F.PURC_PGSS_CD IN ('C','D','Y') THEN
                                CASE WHEN F.CONFIRM_QTY - F.CANC_QTY > 0 THEN ROUND((F.CONFIRM_QTY - F.CANC_QTY) * F.PURC_PRC,2) ELSE 0 END -- 전체 취소 경우 : 0 , 부분 취소 : 계산된(커런트) 수량 * 단가
                            WHEN F.PURC_PGSS_CD IN ('X','Z') THEN CASE WHEN F.CHECK_QTY > 0 THEN ROUND(F.PURC_PRC * F.CHECK_QTY,2) ELSE 0 END -- CHECK 수량이 있으면 : 단가*체크수량 , 없으면 : 0
                            ELSE F.PURC_AMT END
                        END CALC_PURC_AMT                     <!-- CURRENT 금액 -->
                       ,CASE WHEN F.PURC_ORD_STAT_CD IN ('01','02') THEN F.TAX_DDCT_AMT
                             WHEN F.PURC_ORD_STAT_CD IN ('05') THEN 0 --취소일때:0
                        ELSE
                            CASE WHEN F.PURC_PGSS_CD IN ('C','D','Y') THEN
                                CASE WHEN F.CONFIRM_QTY - F.CANC_QTY > 0 THEN ROUND((F.CONFIRM_QTY - F.CANC_QTY) * F.TAX_DDCT_PRC,2) ELSE 0 END -- 전체 취소 경우 : 0 , 부분 취소 : 계산된(커런트) 수량 * 단가
                            WHEN F.PURC_PGSS_CD IN ('X','Z') THEN CASE WHEN F.CHECK_QTY > 0 THEN ROUND(F.TAX_DDCT_PRC * F.CHECK_QTY,2) ELSE 0 END -- CHECK 수량이 있으면 : 단가*체크수량 , 없으면 : 0
                            ELSE F.TAX_DDCT_AMT END
                        END CALC_TAX_DDCT_AMT                 <!-- CURRENT 세전 금액 -->
                       ,F.PURC_ORD_STAT_CD                    <!-- 구매오더상태 -->
                   FROM (
                       SELECT   B.DLR_CD                              --딜러코드
                               ,A.BMP_ORD_NO                          --BMP오더번호
                               ,B.PURC_ORD_NO                         --구매오더번호
                               ,B.PURC_ORD_LINE_NO                    --구매오더라인번호
                               ,B.ITEM_CD                             --품목코드
                               ,C.ITEM_NM                             --품목명
                               ,B.CONFIRM_PAR_NO
                               ,F.ITEM_NM AS CONFIRM_PAR_NM
                               ,A.PURC_REG_DT                         --구매요청일자
                               ,A.SEND_DT                             --전송일자
                               ,A.PURC_ORD_TP                         --구매오더유형
                               ,A.BP_CD                               --거래처코드
                               ,D.BP_NM                               --거래처명
                               ,A.TRSF_TP                             --운송방식
                               ,'' AS TRSF_USR_ID                     --운송자
                               ,B.PURC_ITEM_STAT_CD                   --구매품목상태코드
                               ,B.PURC_UNIT_CD                        --구매단위코드
                               ,B.PURC_QTY                            --구매수량
                               ,B.BMP_CHK_QTY                         --BMP확인수량
                               ,B.CONFIRM_QTY                         --확정수량
                               ,B.BO_QTY                              --B/O수량
                               ,B.ODR_ALC_QT                          --할당수량
                               ,B.ODR_OPIC_QT                         --피킹중수량
                               ,B.ODR_OPAC_QT                         --포장중수량
                               ,B.ODR_PAKD_QT                         --포장완료수량
                               ,NVL(B.SHIP_QTY,0)+NVL(B.ODR_INV_QT,0) AS ODR_INV_QT    --인보이스수량(SHIP_QTY + ODR_INV_QT)
                               ,B.GR_QTY                              --입고수량
                               ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0
                                           THEN CASE WHEN A.PURC_ORD_STAT_CD = '05'
                                                       THEN B.PURC_QTY
                                                     ELSE 0 END
                                         ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY                --취소수량
                               ,B.GR_STRGE_CD                         --입고창고코드
                               ,B.PURC_PRC                            --구매단가
                               ,B.PURC_AMT                            --구매금액
                               ,B.TAX_DDCT_PRC                        --구매단가(세전)
                               ,B.TAX_DDCT_AMT                        --구매금액(세전)
                               ,B.PURC_PGSS_CD                        --진행상태
                               ,B.EDIT_CD                             --진행상태
                               ,A.REG_USR_ID                          --등록자ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
                               ,E.REG_USR_ID AS PURC_REQ_REG_USR_ID  --구매요청등록자ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.REG_USR_ID) AS PURC_REQ_REG_USR_NM   --등록자명
                               ,H.DL_DIST_CD
                               ,NVL(I.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY           --가용재고
                               ,NVL(I.BORROW_QTY,0) AS BORROW_QTY               --차입
                               ,NVL(I.RENT_QTY,0) AS RENT_QTY                 --대여수량
                               ,NVL(I.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY                 --예류수량
                               ,NVL(I.AVLB_STOCK_QTY,0) + NVL(I.RESV_STOCK_QTY,0) - NVL(I.BORROW_QTY,0) + NVL(I.RENT_QTY,0) AS STOCK_QTY
                               ,B.DEL_YN
                               ,NVL(B.SHIP_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0) AS CHECK_QTY --선적수량, ALLOCATION 수량, ON_PICK 수량, PAKD 수량, INVOCED 수량
                               ,A.PURC_ORD_STAT_CD
                          FROM  DMSDB.PT_0421T A                      --구매오더헤더정보
                                  INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                                     ON A.DLR_CD      = B.DLR_CD
                                    AND A.PURC_ORD_NO = B.PURC_ORD_NO
                                  INNER JOIN  DMSDB.PT_0201T C    --품목정보
                                     ON B.DLR_CD  = C.DLR_CD
                                    AND B.ITEM_CD = C.ITEM_CD
                                  LEFT OUTER JOIN PT_0211T D      --공급업체정보
                                     ON A.DLR_CD  = D.DLR_CD
                                    AND A.BP_CD   = D.BP_CD
                                  LEFT OUTER JOIN PT_0411T E      --구매요청정보
                                     ON B.DLR_CD           = E.DLR_CD
                                    AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                                    AND B.ITEM_CD          = E.ITEM_CD
                                  LEFT OUTER JOIN  DMSDB.PT_0201T F    --확정품목정보
                                     ON B.DLR_CD         = F.DLR_CD
                                    AND B.CONFIRM_PAR_NO = F.ITEM_CD
                                 LEFT OUTER JOIN PT_0701T H
                                   ON A.DLR_CD = H.DLR_CD
                                 LEFT OUTER JOIN PT_0301T I
                                   ON C.DLR_CD           = I.DLR_CD
                                  AND C.ITEM_CD          = I.ITEM_CD
                                  AND C.GR_STRGE_CD      = I.STRGE_CD
                         WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
                         <if test='sDelYn != null and sDelYn != ""'>
                             AND  B.DEL_YN !=   'Y'
                         </if>
                         <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                             AND A.PURC_ORD_NO LIKE '%'|| #{sPurcOrdNo} ||'%'
                         </if>        --구매오더정보
                         <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                            AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
                         </if>        --구매오더정보
                         <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                            AND A.PURC_ORD_TP = #{sPurcOrdTp}
                         </if>        --구매오더유형
                         <if test='sTrsfTp != null and sTrsfTp != ""'>
                             AND A.TRSF_TP = #{sTrsfTp}
                         </if>        --운송유형
                         <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                             AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                         </if>        --구매오더상태코드
                         <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                             AND A.PURC_ORD_STAT_CD IN
                             <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                                 #{item}
                             </foreach>
                         </if>        --구매오더상태코드
                         <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                             AND A.BP_CD IN
                             <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                                #{item}
                             </foreach>
                         </if>        --거래처코드
                         <if test='sPurcRegDtFr != null'>
                              AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                         </if>
                         <if test='sPurcRegDtTo != null'>
                              AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                         </if>
                         <if test='sArrvDtFr != null'>
                              AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
                         </if>
                         <if test='sArrvDtTo != null'>
                              AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
                         </if>
                         <if test='sSendDtFr != null'>
                              AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
                         </if>
                         <if test='sSendDtTo != null'>
                              AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
                         </if>
                         <if test='sRegUsrId != null and sRegUsrId != ""'>
                             AND A.REG_USR_ID = #{sRegUsrId}
                         </if>        --등록자ID
                         <if test='sBpCd != null and sBpNm != ""'>
                             AND A.BP_CD = #{sBpCd}
                         </if>        --거래처코드
                         <if test='sGrEndYn != null and sGrEndYn != ""'>
                             AND B.GR_END_YN = #{sGrEndYn}
                         </if>        --입고완료여부
                         <if test='sItemCd != null and sItemCd != ""'>
                             AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                         </if>  --품목명
                         <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                             AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
                         </if>        --품목구분코드
                         <if test='sAbcInd != null and sAbcInd != ""'>
                             AND C.ABC_IND = #{sAbcInd}
                         </if>        --ABC CLASS
                         <if test='sCarlineCd != null and sCarlineCd != ""'>
                             AND C.CARLINE_CD = #{sCarlineCd}
                         </if>        --차종코드
                         <if test='sItemNm != null and sItemNm != ""'>
                             AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                         </if>  --품목명
                         <if test='sBoYn != null and sBoYn != ""'>
                             AND B.BO_QTY <![CDATA[>]]> 0
                         </if>        --운송유형
                      ) F
                      WHERE 1=1
                      <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                          AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
                      </if>
                      ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "purcRegDt"'>         F.PURC_REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "purcOrdTp"'>         F.PURC_ORD_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "bpCd"'>              F.BP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                     <when test='item.field == "regUsrId"'>          F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "purcOrdNo"'>         F.PURC_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "purcOrdLineNo"'>     F.PURC_ORD_LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                     <when test='item.field == "purcItemStatCd"'>    F.PURC_ITEM_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                     <when test='item.field == "itemCd"'>            F.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                     <when test='item.field == "purcUnitCd"'>        F.PURC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                     <when test='item.field == "purcQty"'>           F.PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                     <when test='item.field == "bmpChkQty"'>         F.BMP_CHK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "grQty"'>             F.GR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                     <when test='item.field == "cancQty"'>           F.CANC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                     <when test='item.field == "grStrgeCd"'>         F.GR_STRGE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "purcPrc"'>           F.PURC_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                     <when test='item.field == "purcAmt"'>           F.PURC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                     <when test='item.field == "itemNm"'>            F.ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                     <when test='item.field == "bpNm"'>              F.BP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                     <when test='item.field == "purcReqRegUsrId"'>   F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "purcReqRegUsrNm"'>   F.PURC_REQ_REG_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "regUsrNm"'>          F.REG_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <otherwise>
                                      F.DLR_CD ASC
                                     ,F.PURC_REG_DT DESC
                                     ,F.PURC_ORD_NO DESC
                                     ,F.PURC_ORD_LINE_NO ASC
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                          F.DLR_CD ASC
                         ,F.PURC_REG_DT DESC
                         ,F.PURC_ORD_NO DESC
                         ,F.PURC_ORD_LINE_NO ASC
                         </otherwise>
                     </choose>
                ) T1
              ) A
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
            </where>
    </select>

      <!-- 구매현황 데이타 총 갯수를 조회한다. -->
    <select id="selectPurcOrdStatusByConditionForPurcOrdSummaryCnt" parameterType="PurcOrdSearchVO"  resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusByConditionForPurcOrdSummaryCnt] */
        SELECT COUNT(*) FROM (
        SELECT A.*
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
          FROM  DMSDB.PT_0421T A                      --구매오더헤더정보
                  INNER JOIN  DMSDB.PT_0422T B    --구매오더품목정보
                     ON A.DLR_CD      = B.DLR_CD
                    AND A.PURC_ORD_NO = B.PURC_ORD_NO
                  INNER JOIN  DMSDB.PT_0201T C    --품목정보
                     ON B.DLR_CD  = C.DLR_CD
                    AND B.ITEM_CD = C.ITEM_CD
                  LEFT OUTER JOIN PT_0211T D      --공급업체정보
                     ON A.DLR_CD  = D.DLR_CD
                    AND A.BP_CD   = D.BP_CD
                  LEFT OUTER JOIN PT_0411T E      --구매요청정보
                     ON B.DLR_CD           = E.DLR_CD
                    AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                    AND B.ITEM_CD          = E.ITEM_CD
                  LEFT OUTER JOIN  DMSDB.PT_0201T F    --확정품목정보
                     ON B.DLR_CD         = F.DLR_CD
                    AND B.CONFIRM_PAR_NO = F.ITEM_CD
                 LEFT OUTER JOIN PT_0701T H
                   ON A.DLR_CD = H.DLR_CD
         WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
         <if test='sDelYn != null and sDelYn != ""'>
             AND  B.DEL_YN !=   'Y'
         </if>
         <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
             AND A.PURC_ORD_NO like '%'|| #{sPurcOrdNo} ||'%'
         </if>        --구매오더정보
         <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
             AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
         </if>        --구매오더정보
         <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
             AND A.PURC_ORD_TP = #{sPurcOrdTp}
         </if>        --구매오더유형
         <if test='sTrsfTp != null and sTrsfTp != ""'>
             AND A.TRSF_TP = #{sTrsfTp}
         </if>        --운송유형
         <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
             AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
         </if>        --구매오더상태코드
         <if test='sPurcOrdStatLst  != null and !sPurcOrdStatLst.isEmpty'>
             AND A.PURC_ORD_STAT_CD IN
             <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                 #{item}
             </foreach>
         </if>        --구매오더상태코드
         <if test='sBpCdList != null and !sBpCdList.isEmpty'>
             AND A.BP_CD IN
              <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                 #{item}
              </foreach>
         </if>        --거래처코드
         <if test='sPurcRegDtFr != null'>
              AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
         </if>
         <if test='sPurcRegDtTo != null'>
              AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
         </if>
         <if test='sArrvDtFr != null'>
              AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
         </if>
         <if test='sArrvDtTo != null'>
              AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
         </if>
         <if test='sSendDtFr != null'>
              AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
         </if>
         <if test='sSendDtTo != null'>
              AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
         </if>
         <if test='sRegUsrId != null and sRegUsrId != ""'>
             AND A.REG_USR_ID = #{sRegUsrId}
         </if>        --등록자ID
         <if test='sBpCd != null and sBpNm != ""'>
             AND A.BP_CD = #{sBpCd}
         </if>        --거래처코드
         <if test='sGrEndYn != null and sGrEndYn != ""'>
             AND B.GR_END_YN = #{sGrEndYn}
         </if>        --입고완료여부
         <if test='sItemCd != null and sItemCd != ""'>
             AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
         </if>  --품목명
         <if test='sItemDstinCd != null and sItemDstinCd != ""'>
             AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
         </if>        --품목구분코드
         <if test='sAbcInd != null and sAbcInd != ""'>
             AND C.ABC_IND = #{sAbcInd}
         </if>        --ABC CLASS
         <if test='sCarlineCd != null and sCarlineCd != ""'>
             AND C.CARLINE_CD       = #{sCarlineCd}
         </if>        --차종코드
         <if test='sItemNm != null and sItemNm != ""'>
             AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
         </if>  --품목명
         <if test='sBoYn != null and sBoYn != ""'>
             AND B.BO_QTY <![CDATA[>]]> 0
         </if>        --운송유형
         ) F
         WHERE 1=1
         <if test='sRegUsrNm != null and sRegUsrNm != ""'>
             AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
         </if>
    </select>

    <!-- B/O SUMMARY 데이타 정보를 조회한다.. -->
    <select id="selectPurcOrdStatusListSummary" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusListSummary] */
        SELECT
            F.DLR_CD
            ,COUNT(F.BMP_ORD_NO) AS BO_TOTAL_CNT
            ,SUM(F.BO_QTY) AS BO_TOTAL_QTY
            ,SUM(NVL(F.PURC_PRC,0) * NVL(F.BO_QTY,0)) AS BO_TOTAL_PRC
            FROM (
                SELECT
                    B.DLR_CD
                    ,A.BMP_ORD_NO
                    ,B.BO_QTY
                    ,B.PURC_PRC
                FROM DMSDB.PT_0421T A              <!-- 구매오더헤더정보 -->
                INNER JOIN DMSDB.PT_0422T B        <!-- 구매오더품목정보 -->
                    ON A.DLR_CD = B.DLR_CD
                    AND A.PURC_ORD_NO = B.PURC_ORD_NO
                INNER JOIN DMSDB.PT_0201T C        <!-- 품목정보 -->
                    ON B.DLR_CD  = C.DLR_CD
                    AND B.ITEM_CD = C.ITEM_CD
                LEFT OUTER JOIN PT_0211T D          <!-- 공급업체정보 -->
                    ON A.DLR_CD  = D.DLR_CD
                    AND A.BP_CD   = D.BP_CD
                LEFT OUTER JOIN PT_0411T E          <!-- 구매요청정보 -->
                    ON B.DLR_CD           = E.DLR_CD
                    AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                    AND B.ITEM_CD          = E.ITEM_CD
                LEFT OUTER JOIN  DMSDB.PT_0201T F   <!-- 확정품목정보 -->
                    ON B.DLR_CD         = F.DLR_CD
                    AND B.CONFIRM_PAR_NO = F.ITEM_CD
                LEFT OUTER JOIN (
                    SELECT
                        A.DLR_CD
                        ,B.PURC_ORD_NO
                        ,B.PURC_ORD_LINE_NO
                        ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                        ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                        ,MAX(B.BOX_NO) AS BOX_NO
                        ,MAX(A.INVC_DT) AS INVC_DT     <!-- 발송일자 -->
                        ,MAX(A.ARRV_DT) AS ARRV_DT     <!-- 도착일자(도착예정일자) -->
                    FROM PT_0431T A
                    INNER JOIN PT_0432T B
                        ON A.DLR_CD      = B.DLR_CD
                        AND A.INVC_DOC_NO = B.INVC_DOC_NO
                    GROUP BY A.DLR_CD, B.PURC_ORD_NO, B.PURC_ORD_LINE_NO
                ) G
                    ON B.DLR_CD           = G.DLR_CD
                    AND B.PURC_ORD_NO      = G.PURC_ORD_NO
                    AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
                LEFT OUTER JOIN PT_0701T H
                    ON A.DLR_CD = H.DLR_CD
                LEFT OUTER JOIN PT_0301T I
                    ON C.DLR_CD           = I.DLR_CD
                    AND C.ITEM_CD          = I.ITEM_CD
                    AND C.GR_STRGE_CD      = I.STRGE_CD
            WHERE  B.DLR_CD  = #{sDlrCd}        <!-- 딜러코드 -->
            <if test='sDelYn != null and sDelYn != ""'>
                AND B.DEL_YN != 'Y'
            </if>
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND A.PURC_ORD_NO LIKE '%'|| #{sPurcOrdNo} ||'%'
            </if>        <!-- 구매오더정보 -->
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
            </if>        <!-- bmp오더정보 -->
            <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                AND A.PURC_ORD_TP = #{sPurcOrdTp}
            </if>        <!-- 구매오더유형 -->
            <if test='sTrsfTp != null and sTrsfTp != ""'>
                AND A.TRSF_TP = #{sTrsfTp}
            </if>        <!-- 운송유형 -->
            <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
            </if>        <!-- 구매오더상태코드 -->
            <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                AND A.PURC_ORD_STAT_CD IN
                <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>        <!-- 구매오더상태코드 -->
            <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                AND A.BP_CD IN
                <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                   #{item}
                </foreach>
            </if>        <!-- 거래처코드 -->
            <if test='sPurcRegDtFr != null'>
                 AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
            </if>
            <if test='sPurcRegDtTo != null'>
                 AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
            </if>
            <if test='sArrvDtFr != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
            </if>
            <if test='sArrvDtTo != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
            </if>
            <if test='sSendDtFr != null'>
                 AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
            </if>
            <if test='sSendDtTo != null'>
                 AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
            </if>
            <if test='sConfirmFr != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
            </if>
            <if test='sConfirmTo != null'>
                 AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
            </if>
            <if test='sRegUsrId != null and sRegUsrId != ""'>
                AND A.REG_USR_ID = #{sRegUsrId}
            </if>        <!-- 등록자ID -->
            <if test='sBpCd != null and sBpNm != ""'>
                AND A.BP_CD = #{sBpCd}
            </if>        <!-- 거래처코드 -->
            <if test='sGrEndYn != null and sGrEndYn != ""'>
                AND B.GR_END_YN = #{sGrEndYn}
            </if>        <!-- 입고완료여부 -->
            <if test='sItemCd != null and sItemCd != ""'>
                AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
            </if>        <!-- 품목명 -->
            <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
            </if>        <!-- 품목구분코드 -->
            <if test='sAbcInd != null and sAbcInd != ""'>
                AND C.ABC_IND = #{sAbcInd}
            </if>        <!-- ABC CLASS -->
            <if test='sCarlineCd != null and sCarlineCd != ""'>
                AND C.CARLINE_CD = #{sCarlineCd}
            </if>        <!-- 차종코드 -->
            <if test='sItemNm != null and sItemNm != ""'>
                AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
            </if>        <!-- 품목명 -->
            <if test='sBoYn != null and sBoYn != ""'>
                AND B.BO_QTY <![CDATA[>]]> 0
            </if>        <!-- 운송유형 -->
            ) F
        WHERE 1=1
            <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
            </if>
        GROUP BY F.DLR_CD
    </select>

     <!-- 부품구매 헤더 정보를 조회한다. -->
    <select id="selectPurcOrdUpdtDtByKey" parameterType="PurcOrdVO" resultType="String">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdUpdtDtByKey] */
        SELECT TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM DMSDB.PT_0421T A    --부품구매헤더정보
         WHERE A.DLR_CD           = #{dlrCd}        --딜러코드
           AND A.PURC_ORD_NO      = #{purcOrdNo}    --구매오더정보
    </select>

    <!-- 구매오더 정보 카운트를 조회한다. -->
    <select id="selectMobilePurcOrdsByConditionCnt" parameterType="PurcOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectMobilePurcOrdsByConditionCnt] */
        SELECT
            COUNT(*)
        FROM PT_0421T
        WHERE DLR_CD = #{sDlrCd}
        <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
           AND PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
        </if>
    </select>

    <!-- 合格证申请修改弹出配件选择窗口 add by lyy 2018-09-07 -->
    <select id="selectPurcOrdByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdByCondition] */
        SELECT A.*
            FROM
            (
            SELECT
                ROWNUM AS RNUM
                , T1.*
            FROM (
                SELECT
                    F.DLR_CD                               <!-- 딜러코드 -->
                    ,F.BMP_ORD_NO                          <!-- BMP오더번호 -->
                    ,F.PURC_ORD_NO                         <!-- 구매오더번호 -->
                    ,F.PURC_ORD_LINE_NO                    <!-- 구매오더라인번호 -->
                    ,F.ITEM_CD                             <!-- 품목코드 -->
                    ,F.ITEM_NM                             <!-- 품목명 -->
                    ,F.CONFIRM_PAR_NO
                    ,F.CONFIRM_PAR_NM
                    ,F.PURC_REG_DT                         <!-- 구매요청일자 -->
                    ,F.SEND_DT                             <!-- 전송일자 -->
                    ,F.PURC_ORD_TP                         <!-- 구매오더유형 -->
                    ,F.BP_CD                               <!-- 거래처코드 -->
                    ,F.BP_NM                               <!-- 거래처명 -->
                    ,F.TRSF_TP                             <!-- 운송방식 -->
                    ,F.TRSF_USR_ID                         <!-- 운송자 -->
                    ,F.PURC_ITEM_STAT_CD                   <!-- 구매품목상태코드 -->
                    ,F.PURC_UNIT_CD                        <!-- 구매단위코드 -->
                    ,F.PURC_QTY                            <!-- 구매수량 -->
                    ,F.BMP_CHK_QTY                         <!-- BMP확인수량 -->
                    ,F.CONFIRM_QTY                         <!-- 확정수량 -->
                    ,F.BO_QTY                              <!-- B/O수량 -->
                    ,F.ODR_ALC_QT                          <!-- 할당수량 -->
                    ,F.ODR_OPIC_QT                         <!-- 피킹중수량 -->
                    ,F.ODR_OPAC_QT                         <!-- 포장중수량 -->
                    ,F.ODR_PAKD_QT                         <!-- 포장완료수량 -->
                    ,F.ODR_INV_QT                          <!-- 인보이스수량(SHIP_QTY + ODR_INV_QT) -->
                    ,F.GR_QTY                              <!-- 입고수량 -->
                    ,F.CANC_QTY                            <!-- 취소수량 -->
                    ,F.GR_STRGE_CD                         <!-- 입고창고코드 -->
                    ,F.PURC_PRC                            <!-- 구매단가 -->
                    ,F.PURC_AMT                            <!-- 구매금액 -->
                    ,F.TAX_DDCT_PRC                        <!-- 구매단가(세전) -->
                    ,F.TAX_DDCT_AMT                        <!-- 구매금액(세전) -->
                    ,F.PURC_PGSS_CD                        <!-- 진행상태 -->
                    ,F.EDIT_CD
                    ,F.REG_USR_ID                          <!-- 등록자ID -->
                    ,F.REG_USR_NM                          <!-- 등록자명 -->
                    ,F.PURC_REQ_REG_USR_ID                 <!-- 구매요청등록자ID -->
                    ,F.PURC_REQ_REG_USR_NM                 <!-- 등록자명 -->
                    ,F.MOBIS_INVC_NO
                    ,F.MOBIS_INVC_LINE_NO
                    ,F.BOX_NO
                    ,F.INVC_DT                             <!-- 발송일자 -->
                    ,F.ARRV_DT                             <!-- 도착일자(도착예정일자) -->
                    ,F.AVLB_STOCK_QTY                      <!-- 가용재고 -->
                    ,F.BORROW_QTY                          <!-- 차입 -->
                    ,F.RENT_QTY                            <!-- 대여수량 -->
                    ,F.RESV_STOCK_QTY                      <!-- 예류수량 -->
                    ,F.STOCK_QTY
                    ,F.DEL_YN
                    ,F.DL_DIST_CD
                    ,F.CANC_REQ_QTY
                    ,CASE WHEN F.PURC_PGSS_CD IN ('C','D','Y') THEN
                        CASE WHEN F.CONFIRM_QTY > 0 THEN F.CONFIRM_QTY - F.CANC_QTY ELSE 0 END
                        WHEN F.PURC_PGSS_CD IN ('X','Z') THEN NVL(F.CHECK_QTY,0)
                        ELSE F.CONFIRM_QTY
                        END CALC_CONFIRM_QTY
                    ,F.CONFIRM_DT
                    ,F.GI_EXPC_DT
                    ,F.BMP_PURC_PRC
                    FROM (
                        SELECT
                            B.DLR_CD
                            ,A.BMP_ORD_NO
                            ,B.PURC_ORD_NO
                            ,B.PURC_ORD_LINE_NO
                            ,B.ITEM_CD
                            ,C.ITEM_NM
                            ,B.CONFIRM_PAR_NO
                            ,F.ITEM_NM AS CONFIRM_PAR_NM
                            ,A.PURC_REG_DT
                            ,A.SEND_DT
                            ,A.PURC_ORD_TP
                            ,A.BP_CD
                            ,D.BP_NM
                            ,A.TRSF_TP
                            ,'' AS TRSF_USR_ID
                            ,B.PURC_ITEM_STAT_CD
                            ,B.PURC_UNIT_CD
                            ,B.PURC_QTY
                            ,B.BMP_CHK_QTY
                            ,B.CONFIRM_QTY
                            ,B.BO_QTY
                            ,B.ODR_ALC_QT
                            ,B.ODR_OPIC_QT
                            ,B.ODR_OPAC_QT
                            ,B.ODR_PAKD_QT
                            ,NVL(B.SHIP_QTY,0)+NVL(B.ODR_INV_QT,0) AS ODR_INV_QT
                            ,B.GR_QTY
                            ,NVL(CASE WHEN NVL(B.CANC_QTY,0) = 0 THEN
                                CASE WHEN A.PURC_ORD_STAT_CD = '05' THEN B.PURC_QTY ELSE 0 END
                                ELSE NVL(B.CANC_QTY,0) END,0) AS CANC_QTY
                            ,B.GR_STRGE_CD
                            ,B.PURC_PRC
                            ,B.PURC_AMT
                            ,B.TAX_DDCT_PRC
                            ,B.TAX_DDCT_AMT
                            ,B.PURC_PGSS_CD
                            ,B.EDIT_CD
                            ,A.REG_USR_ID
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM
                            ,E.REG_USR_ID AS PURC_REQ_REG_USR_ID
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.REG_USR_ID) AS PURC_REQ_REG_USR_NM
                            ,G.MOBIS_INVC_NO
                            ,G.MOBIS_INVC_LINE_NO
                            ,G.BOX_NO
                            ,G.INVC_DT
                            ,G.ARRV_DT
                            ,NVL(I.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                            ,NVL(I.BORROW_QTY,0) AS BORROW_QTY
                            ,NVL(I.RENT_QTY,0) AS RENT_QTY
                            ,NVL(I.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                            ,NVL(I.AVLB_STOCK_QTY,0) + NVL(I.RESV_STOCK_QTY,0) - NVL(I.BORROW_QTY,0) + NVL(I.RENT_QTY,0) AS STOCK_QTY
                            ,B.DEL_YN
                            ,CASE WHEN NVL(B.BMP_ORD_NO,'-999') = '-999' THEN ' ' WHEN SUBSTR(B.BMP_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') THEN J.DL_DIST_CD ELSE 'PD'||SUBSTR(B.BMP_ORD_NO,6,1) END DL_DIST_CD
                            ,CASE WHEN B.PURC_ITEM_STAT_CD = '05' AND B.DEL_YN = 'Y' AND B.BMP_ORD_NO IS NOT NULL
                                    THEN NVL(B.CANC_QTY,0)
                                  ELSE NVL(B.CANC_REQ_QTY,0)
                              END  CANC_REQ_QTY
                            ,NVL(B.SHIP_QTY,0) + NVL(B.ODR_ALC_QT,0) + NVL(B.ODR_OPIC_QT,0) + NVL(B.ODR_PAKD_QT,0) + NVL(B.ODR_INV_QT,0) AS CHECK_QTY
                                                                      <!-- 선적수량, ALLOCATION 수량, ON_PICK 수량, PAKD 수량, INVOCED 수량 -->
                            ,A.ARRV_DT AS CONFIRM_DT                  <!-- B/O에 있는 전송일자 20170707 -->
                            ,B.GI_EXPC_DT
                            ,CASE WHEN NVL(K.BMP_PURC_PRC,0) <![CDATA[>]]> 0
                                    THEN K.BMP_PURC_PRC
                                  ELSE NVL((SELECT NVL(ROUND(T.APCP_PRICE_NAT_AMT * (1 + FN_GET_VAT(null,'ALL')),2),0)
                                          FROM PT_0216I T
                                         WHERE (APCP_PART_NO,APCP_APPLY_DATE) IN (
                                                  SELECT APCP_PART_NO,
                                                         MAX(APCP_APPLY_DATE) AS APCP_APPLY_DATE
                                                    FROM PT_0216I I
                                                   WHERE I.APCP_PART_NO = B.ITEM_CD
                                                GROUP BY APCP_PART_NO )
                                       ),
                                       (SELECT NVL(ROUND(LPR_LST_PRC * ( 1 + FN_GET_VAT(null,'ALL')),2),0)
                                          FROM PT_0214I T2
                                         WHERE (LPR_PNO,LPR_APL_DT) IN (
                                                    SELECT LPR_PNO,
                                                           MAX(LPR_APL_DT) AS LPR_APL_DT
                                                      FROM PT_0214I T3
                                                     WHERE TRIM(T3.LPR_PNO) = B.ITEM_CD
                                                  GROUP BY LPR_PNO))
                              ) END  BMP_PURC_PRC
                        FROM DMSDB.PT_0421T A              <!-- 구매오더헤더정보 -->
                        INNER JOIN DMSDB.PT_0422T B        <!-- 구매오더품목정보 -->
                            ON A.DLR_CD = B.DLR_CD
                            AND A.PURC_ORD_NO = B.PURC_ORD_NO
                        INNER JOIN DMSDB.PT_0201T C        <!-- 품목정보 -->
                            ON B.DLR_CD  = C.DLR_CD
                            AND B.ITEM_CD = C.ITEM_CD
                        LEFT OUTER JOIN PT_0211T D          <!-- 공급업체정보 -->
                            ON A.DLR_CD  = D.DLR_CD
                            AND A.BP_CD   = D.BP_CD
                        LEFT OUTER JOIN PT_0411T E          <!-- 구매요청정보 -->
                            ON B.DLR_CD           = E.DLR_CD
                            AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                            AND B.ITEM_CD          = E.ITEM_CD
                        LEFT OUTER JOIN  DMSDB.PT_0201T F   <!-- 확정품목정보 -->
                            ON B.DLR_CD         = F.DLR_CD
                            AND B.CONFIRM_PAR_NO = F.ITEM_CD
                        LEFT OUTER JOIN (
                            SELECT
                                A.DLR_CD
                                ,B.PURC_ORD_NO
                                ,B.PURC_ORD_LINE_NO
                                ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                                ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                                ,MAX(B.BOX_NO) AS BOX_NO
                                ,MAX(A.INVC_DT) AS INVC_DT     <!-- 발송일자 -->
                                ,MAX(A.ARRV_DT) AS ARRV_DT     <!-- 도착일자(도착예정일자) -->
                            FROM PT_0431T A
                            INNER JOIN PT_0432T B
                                ON A.DLR_CD      = B.DLR_CD
                                AND A.INVC_DOC_NO = B.INVC_DOC_NO
                            GROUP BY A.DLR_CD, B.PURC_ORD_NO, B.PURC_ORD_LINE_NO
                        ) G
                            ON B.DLR_CD           = G.DLR_CD
                            AND B.PURC_ORD_NO      = G.PURC_ORD_NO
                            AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
                        LEFT OUTER JOIN PT_0701T H
                            ON A.DLR_CD = H.DLR_CD
                        LEFT OUTER JOIN PT_0301T I
                            ON C.DLR_CD           = I.DLR_CD
                            AND C.ITEM_CD          = I.ITEM_CD
                            AND C.GR_STRGE_CD      = I.STRGE_CD
                        LEFT OUTER JOIN PT_0701T J
                          ON A.DLR_CD = J.DLR_CD
                         LEFT JOIN
                        (
                            SELECT
                                DLR_CD
                                ,ITEM_CD
                                ,MAX(PRC_TP) AS PRC_TP
                                ,MAX(LINE_NO) AS LINE_NO
                                ,MAX(NVL(SALE_PRC_AMT,0)) AS BMP_PURC_PRC
                            FROM PT_0214T
                            WHERE DLR_CD = #{sDlrCd}
                            AND NVL(DEL_YN,'N') != 'Y'
                            GROUP BY DLR_CD, ITEM_CD
                        ) K ON B.DLR_CD = K.DLR_CD AND B.ITEM_CD = K.ITEM_CD
                    WHERE  B.DLR_CD  = #{sDlrCd}        <!-- 딜러코드 -->
                    <if test='sDelYn != null and sDelYn != ""'>
                        AND  (B.DEL_YN !=   'Y' or (B.DEL_YN =   'Y' AND B.BMP_ORD_NO IS NOT NULL))
                    </if>
                    <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                        AND A.PURC_ORD_NO LIKE '%'|| #{sPurcOrdNo} ||'%'
                    </if>        <!-- 구매오더정보 -->
                    <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                        AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
                    </if>        <!-- bmp오더정보 -->
                    <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
                        AND A.PURC_ORD_TP = #{sPurcOrdTp}
                    </if>        <!-- 구매오더유형 -->
                    <if test='sTrsfTp != null and sTrsfTp != ""'>
                        AND A.TRSF_TP = #{sTrsfTp}
                    </if>        <!-- 운송유형 -->
                    <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
                        AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
                    </if>        <!-- 구매오더상태코드 -->
                    <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                        AND A.PURC_ORD_STAT_CD IN
                        <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                            #{item}
                        </foreach>
                    </if>        <!-- 구매오더상태코드 -->
                    <if test='sBpCdList != null and !sBpCdList.isEmpty'>
                        AND A.BP_CD IN
                        <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                           #{item}
                        </foreach>
                    </if>        <!-- 거래처코드 -->
                    <if test='sPurcRegDtFr != null'>
                         AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
                    </if>
                    <if test='sPurcRegDtTo != null'>
                         AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
                    </if>
                    <if test='sArrvDtFr != null'>
                         AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
                    </if>
                    <if test='sArrvDtTo != null'>
                         AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
                    </if>
                    <if test='sSendDtFr != null'>
                         AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
                    </if>
                    <if test='sSendDtTo != null'>
                         AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
                    </if>
                    <if test='sRegUsrId != null and sRegUsrId != ""'>
                        AND A.REG_USR_ID = #{sRegUsrId}
                    </if>        <!-- 등록자ID -->
                    <if test='sBpCd != null and sBpNm != ""'>
                        AND A.BP_CD = #{sBpCd}
                    </if>        <!-- 거래처코드 -->
                    <if test='sGrEndYn != null and sGrEndYn != ""'>
                        AND B.GR_END_YN = #{sGrEndYn}
                    </if>        <!-- 입고완료여부 -->
                    <if test='sItemCd != null and sItemCd != ""'>
                        AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
                    </if>        <!-- 품목명 -->
                    <if test='sItemDstinCd != null and sItemDstinCd != ""'>
                        AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
                    </if>        <!-- 품목구분코드 -->
                    <if test='sAbcInd != null and sAbcInd != ""'>
                        AND C.ABC_IND = #{sAbcInd}
                    </if>        <!-- ABC CLASS -->
                    <if test='sCarlineCd != null and sCarlineCd != ""'>
                        AND C.CARLINE_CD = #{sCarlineCd}
                    </if>        <!-- 차종코드 -->
                    <if test='sItemNm != null and sItemNm != ""'>
                        AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
                    </if>        <!-- 품목명 -->
                    <if test='sBoYn != null and sBoYn != ""'>
                        AND B.BO_QTY <![CDATA[>]]> 0
                    </if>        <!-- 운송유형 -->
                    ) F
                WHERE 1=1
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
                    </if>
                    <if test='sConfirmFr != null'>
                         AND TO_DATE(F.CONFIRM_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
                    </if>
                    <if test='sConfirmTo != null'>
                         AND TO_DATE(F.CONFIRM_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
                    </if>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "purcRegDt"'> F.PURC_REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdTp"'> F.PURC_ORD_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bpCd"'> F.BP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regUsrId"'> F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdNo"'> F.PURC_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcOrdLineNo"'> F.PURC_ORD_LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcItemStatCd"'> F.PURC_ITEM_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "itemCd"'> F.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcUnitCd"'> F.PURC_UNIT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcQty"'> F.PURC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bmpChkQty"'> F.BMP_CHK_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grQty"'> F.GR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "cancQty"'> F.CANC_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grStrgeCd"'> F.GR_STRGE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcPrc"'> F.PURC_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcAmt"'> F.PURC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "itemNm"'> F.ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bpNm"'> F.BP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcReqRegUsrId"'> F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "confirmDt"'> F.CONFIRM_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    F.DLR_CD ASC
                                    ,F.PURC_REG_DT DESC
                                    ,F.PURC_ORD_NO DESC
                                    ,F.PURC_ORD_LINE_NO ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        F.DLR_CD ASC
                        ,F.PURC_REG_DT DESC
                        ,F.PURC_ORD_NO DESC
                        ,F.PURC_ORD_LINE_NO ASC
                    </otherwise>
                </choose>
            ) T1
        ) A
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 合格证申请修改弹出配件选择窗口 add by lyy 2018-09-07 -->
    <select id="selectPurcOrdByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdByConditionCnt] */
    SELECT COUNT(*) FROM (
        SELECT
            A.*
            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS REG_USR_NM   --등록자명
        FROM DMSDB.PT_0421T A                      --구매오더헤더정보
        INNER JOIN DMSDB.PT_0422T B    --구매오더품목정보
           ON A.DLR_CD      = B.DLR_CD
          AND A.PURC_ORD_NO = B.PURC_ORD_NO
        INNER JOIN  DMSDB.PT_0201T C    --품목정보
                     ON B.DLR_CD  = C.DLR_CD
                    AND B.ITEM_CD = C.ITEM_CD
        LEFT OUTER JOIN PT_0211T D      --공급업체정보
                     ON A.DLR_CD  = D.DLR_CD
                    AND A.BP_CD   = D.BP_CD
        LEFT OUTER JOIN PT_0411T E      --구매요청정보
                     ON B.DLR_CD           = E.DLR_CD
                    AND B.PURC_REQ_NO      = E.PURC_REQ_NO
                    AND B.ITEM_CD          = E.ITEM_CD
        LEFT OUTER JOIN  DMSDB.PT_0201T F    --확정품목정보
                     ON B.DLR_CD         = F.DLR_CD
                    AND B.CONFIRM_PAR_NO = F.ITEM_CD
        LEFT OUTER JOIN (
            SELECT A.DLR_CD
                   ,B.PURC_ORD_NO
                   ,B.PURC_ORD_LINE_NO
                   ,MAX(A.MOBIS_INVC_NO) AS MOBIS_INVC_NO
                   ,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                   ,MAX(B.BOX_NO) AS BOX_NO
                   ,MAX(A.INVC_DT) AS INVC_DT                             --발송일자
                   ,MAX(A.ARRV_DT) AS ARRV_DT                             --도착일자(도착예정일자)
            FROM PT_0431T A
            INNER JOIN PT_0432T B
               ON A.DLR_CD      = B.DLR_CD
              AND A.INVC_DOC_NO = B.INVC_DOC_NO
            GROUP BY A.DLR_CD
                     ,B.PURC_ORD_NO
                     ,B.PURC_ORD_LINE_NO) G
               ON B.DLR_CD           = G.DLR_CD
              AND B.PURC_ORD_NO      = G.PURC_ORD_NO
              AND B.PURC_ORD_LINE_NO = G.PURC_ORD_LINE_NO
        LEFT OUTER JOIN PT_0701T H
                     ON A.DLR_CD = H.DLR_CD
        WHERE  B.DLR_CD  = #{sDlrCd}        --딜러코드
        <if test='sDelYn != null and sDelYn != ""'>
            AND  (B.DEL_YN !=   'Y' or (B.DEL_YN =   'Y' AND B.BMP_ORD_NO IS NOT NULL))
        </if>
        <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
            AND A.PURC_ORD_NO like '%'|| #{sPurcOrdNo} ||'%'
        </if>        --구매오더정보
        <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
            AND A.BMP_ORD_NO like '%'|| #{sBmpOrdNo} ||'%'
        </if>        --구매오더정보
        <if test='sPurcOrdTp != null and sPurcOrdTp != ""'>
            AND A.PURC_ORD_TP = #{sPurcOrdTp}
        </if>        --구매오더유형
        <if test='sTrsfTp != null and sTrsfTp != ""'>
            AND A.TRSF_TP = #{sTrsfTp}
        </if>        --운송유형
        <if test='sPurcOrdStatCd != null and sPurcOrdStatCd != ""'>
            AND A.PURC_ORD_STAT_CD = #{sPurcOrdStatCd}
        </if>        --구매오더상태코드
        <if test='sPurcOrdStatLst  != null and !sPurcOrdStatLst.isEmpty'>
            AND A.PURC_ORD_STAT_CD IN
            <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>        --구매오더상태코드
        <if test='sBpCdList != null and !sBpCdList.isEmpty'>
            AND A.BP_CD IN
            <foreach item="item" index="index" collection="sBpCdList" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>        --거래처코드
        <if test='sPurcRegDtFr != null'>
             AND A.PURC_REG_DT <![CDATA[>=]]> #{sPurcRegDtFr}
        </if>
        <if test='sPurcRegDtTo != null'>
             AND A.PURC_REG_DT <![CDATA[<=]]> #{sPurcRegDtTo} + 1
        </if>
        <if test='sArrvDtFr != null'>
             AND TO_DATE(A.ARRV_DT) <![CDATA[>=]]> to_date(to_char(#{sArrvDtFr},'yyyymmdd'))
        </if>
        <if test='sArrvDtTo != null'>
             AND TO_DATE(A.ARRV_DT) <![CDATA[<=]]> to_date(to_char(#{sArrvDtTo},'yyyymmdd'))
        </if>
        <if test='sSendDtFr != null'>
             AND A.SEND_DT <![CDATA[>=]]> #{sSendDtFr}
        </if>
        <if test='sSendDtTo != null'>
             AND A.SEND_DT <![CDATA[<=]]> #{sSendDtTo} + 1
        </if>
        <if test='sRegUsrId != null and sRegUsrId != ""'>
            AND A.REG_USR_ID = #{sRegUsrId}
        </if>        --등록자ID
        <if test='sBpCd != null and sBpNm != ""'>
            AND A.BP_CD = #{sBpCd}
        </if>        --거래처코드
        <if test='sGrEndYn != null and sGrEndYn != ""'>
            AND B.GR_END_YN = #{sGrEndYn}
        </if>        --입고완료여부
        <if test='sItemCd != null and sItemCd != ""'>
            AND B.ITEM_CD LIKE '%'||#{sItemCd}||'%'
        </if>  --품목명
        <if test='sItemDstinCd != null and sItemDstinCd != ""'>
            AND C.ITEM_DSTIN_CD = #{sItemDstinCd}
        </if>        --품목구분코드
        <if test='sAbcInd != null and sAbcInd != ""'>
            AND C.ABC_IND = #{sAbcInd}
        </if>        --ABC CLASS
        <if test='sCarlineCd != null and sCarlineCd != ""'>
            AND C.CARLINE_CD       = #{sCarlineCd}
        </if>        --차종코드
        <if test='sItemNm != null and sItemNm != ""'>
            AND C.ITEM_NM LIKE '%'||#{sItemNm}||'%'
        </if>  --품목명
        <if test='sBoYn != null and sBoYn != ""'>
            AND B.BO_QTY <![CDATA[>]]> 0
        </if>        --운송유형
        ) F
        WHERE 1=1
        <if test='sRegUsrNm != null and sRegUsrNm != ""'>
            AND F.REG_USR_NM LIKE '%'||#{sRegUsrNm}||'%'
        </if>
        <if test='sConfirmFr != null'>  <!-- 구매오더상태 전송일자 : 0421T의 ARRV_DT , 20170713  -->
            AND TO_DATE(F.ARRV_DT) <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'))
        </if>
        <if test='sConfirmTo != null'>
            AND TO_DATE(F.ARRV_DT) <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'))
        </if>
    </select>    
</mapper>