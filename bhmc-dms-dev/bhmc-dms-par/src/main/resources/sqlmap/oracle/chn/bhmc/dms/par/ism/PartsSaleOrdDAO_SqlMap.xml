<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : PartsSaleOrdDAO_SqlMap.xml
    Description : 부품판매 관리.
    author In Bo Shim
    since 2016. 2. 23.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 02. 23.     Ju Won Lee     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO">

    <!-- 부품판매 헤더 정보를 추가한다. -->
    <insert id="insertPartsSaleOrd" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.insertPartsSaleOrd] */
        INSERT INTO DMSDB.PT_0521T    --부품판매헤더정보
        (
          DLR_CD                    --딜러코드
         ,PAR_SALE_ORD_NO           --부품판매오더번호
         ,ORD_STAT_CD               --오더상태코드(01)
         ,SALE_TP                   --판매유형
         ,CUST_TP                   --고객유형
         ,CUST_CD                   --고객코드    (null허용)
         ,CUST_NM                   --고객명
         ,CUST_TEL_NO               --고객전화번호(null 허용)
         ,SA_ID                     --SAID
         ,SALE_PRSN_ID              --SALE_PRSN_ID
         ,ORD_DT                    --판매일자
         ,REMARK                    --비고
         ,DC_RATE                   --할인율
         ,DC_BEF_TOT_AMT            --할인전총금액
         ,DC_AMT                    --할인금액
         ,TOT_AMT                   --총금액
         ,VAT_AMT                   --총세금
         ,REF_DOC_NO                --원판매번호
         ,REG_USR_ID                --등록자ID
         ,REG_DT                    --등록일자
         ,UPDT_USR_ID
         ,UPDT_DT
         ,car_reg_no
        )
        VALUES
        (
          #{dlrCd}                    --딜러코드
         ,#{parSaleOrdNo}             --부품판매오더번호
         ,#{ordStatCd}                --오더상태코드
         ,#{saleTp}                   --판매유형
         ,#{custTp}                   --고객유형
         ,#{custCd}                   --고객코드
         ,#{custNm}                   --고객명
         ,#{custTelNo}                --고객전화번호
         ,#{saId}                     --판매고문
         ,#{salePrsnId}               --담당자
         <choose>
             <when test='refDocNo != null'>
              ,sysdate                    --판매일자(반품일자)
             </when>
             <otherwise>
               ,sysdate
             </otherwise>
         </choose>
         ,#{remark}                   --비고
         ,round(#{dcRate},2)          --할인율
         ,round(#{dcBefTotAmt},2)     --할인전총금액
         ,round(#{dcAmt},2)           --할인금액
         ,round(#{totAmt},2)          --총금액
         ,round(#{vatAmt},2)          --총세금
         ,#{refDocNo}                 --원판매번호
         ,#{regUsrId}                 --등록자ID
         ,sysdate                     --등록일자
         ,#{regUsrId}                 --등록자ID
         ,sysdate                     --등록일자
         ,#{carRegNo}
        )
    </insert>

    <!-- 부품판매  부품 정보를 추가한다. -->
    <insert id="insertPartsSaleOrdItem" parameterType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.insertPartsSaleOrdItem] */
        INSERT INTO DMSDB.PT_0522T    --부품판매품목정보
        (
          DLR_CD                      --딜러코드
         ,PAR_SALE_ORD_NO             --부품판매오더번호
         ,PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
         ,GI_STAT_CD                  --출고상태
         ,CALC_TP_CD                  --정산유형(지불유형)
         ,ITEM_CD                     --품목코드
         ,PRINT_ITEM_NM               --품목명(인쇄용)
         ,EQIP_EXPC_DT                --설치예정일자
         ,DC_RATE                     --할인율
         ,PRC                         --단가
         ,AMT                         --금액
         ,UNIT_CD                     --단위코드
         ,ORD_QTY                     --오더수량
         ,END_QTY                     --확정수량(반품일때만 Insert시 등록됨)
         ,GI_STRGE_CD                 --출고창고
         ,GI_LOC_CD                   --출고로케이션
         ,TAX_DDCT_AMT                --세금공제금액(할인 후 금액)
         ,TAX_AMT                     --세금금액
         ,PKG_ITEM_CD                 --패키지부품번호
         ,REF_DOC_NO                  --원판매번호
         ,REF_DOC_LINE_NO             --원판매라인번호
         ,REG_USR_ID                  --등록자ID
         ,REG_DT                      --등록일자
         ,UPDT_USR_ID
         ,UPDT_DT
        )
        VALUES
        (
          #{dlrCd}                      --딜러코드
         ,#{parSaleOrdNo}               --부품판매오더번호
         ,#{parSaleOrdLineNo}           --부품판매오더라인번호
         ,#{giStatCd}                   --출고상태('01': 등록, '07': 반품)
         ,'04'                          --지불유형('04': 고객)
         ,#{itemCd}                     --품목코드
         ,#{printItemNm}                --품목명(인쇄용)
         ,#{eqipExpcDt}                 --설치예정일자
         ,round(#{dcRate},2)            --할인율
         ,round(#{prc},2)               --단가
         ,round(#{amt},2)               --금액
         ,#{unitCd}                     --단위코드
         ,#{ordQty}                     --오더수량
         ,#{endQty}                     --반품확정수량(판매확정 수량은 update시 발생)
         ,#{giStrgeCd}                  --출고창고
         ,#{giLocCd}                    --출고로케이션
         ,round(#{taxDdctAmt},2)        --세금공제금액
         ,round(#{taxAmt},2)            --세금액
         ,#{pkgItemCd}                  --패키지부품번호
         ,#{refDocNo}                   --원판매번호
         ,#{refDocLineNo}               --원판매라인번호
         ,#{regUsrId}                   --등록자ID
         ,sysdate                       --등록일자
         ,#{regUsrId}                   --등록자ID
         ,sysdate                       --등록일자
        )
    </insert>

     <!-- 부품판매 헤더 정보를 수정한다. -->
    <update id="updatePartsSaleOrd" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updatePartsSaleOrd] */
        UPDATE DMSDB.PT_0521T A    --부품판매헤더정보
          SET
               ORD_STAT_CD        = #{ordStatCd}        --상태
              ,CUST_CD            = #{custCd}           --고객코드
              ,CUST_NM            = #{custNm}           --고객명
              ,CUST_TEL_NO        = #{custTelNo}        --고객전화
              ,SALE_PRSN_ID       = #{salePrsnId}       --담당자
              ,SA_ID              = #{saId}             --고문
              ,REMARK             = #{remark}           --비고
              ,DC_RATE            = round(#{dcRate},2)       --할인률
              ,DC_BEF_TOT_AMT     = round(#{dcBefTotAmt},2)  --할인전총금액
              ,DC_AMT             = round(#{dcAmt},2)        --할인금액
              ,TOT_AMT            = round(#{totAmt},2)       --총금액
              ,VAT_AMT            = round(#{vatAmt},2)       --총세금
              ,UPDT_USR_ID        = #{regUsrId}         --수정자ID
              ,UPDT_DT            = sysdate
         WHERE DLR_CD             = #{dlrCd}            --딜러코드
           AND PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </update>

     <!-- 부품판매 부품 정보를 수정한다. -->
    <update id="updatePartsSaleOrdItem" parameterType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updatePartsSaleOrdItem] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               DC_RATE           = round(NVL(#{dcRate},0),2)  --할인율
              ,PRC               = round(#{prc},2)            --가격
              ,AMT               = round(#{amt},2)            --금액
              ,ORD_QTY           = #{ordQty}                  --수량
              ,EQIP_EXPC_DT      = #{eqipExpcDt}              --설치예정일자
              ,PRINT_ITEM_NM     = #{printItemNm}             --품목명(인쇄용)
              ,GI_STRGE_CD       = #{giStrgeCd}               --출고창고
              ,GI_LOC_CD         = #{giLocCd}                 --출고로케이션
              ,TAX_DDCT_AMT      = round(#{taxDdctAmt},2)     --세금공제금액(할인 후 금액)
              ,TAX_AMT           = round(#{taxAmt},2)         --세금금액
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --구매오더번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}           --구매오더라인번호
    </update>

     <!-- 부품판매 부품 정보(DC_RATE)를 수정한다. -->
    <update id="updatePartsSaleOrdItemDcRate" parameterType="PartCalculateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updatePartsSaleOrdItemDcRate] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               DC_RATE           = round(NVL(#{dcRate},0),2)  --할인율
              ,DC_AMT            = round(NVL(#{dcAmt},0),2)   --할인금액
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --구매오더번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}           --구매오더라인번호
    </update>

     <!-- 부품판매 부품 정보를 삭제한다.-->
    <delete id="deletePartsSaleOrdItem" parameterType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.deletePartsSaleOrdItem] */
        DELETE DMSDB.PT_0522T    --부품판매품목정보
         WHERE DLR_CD                = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --구매오더번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}           --구매오더라인번호
    </delete>


    <!-- 헤더 번호에 해당하는 모든 부품 정보를 삭제한다.-->
    <update id="cancelPartsSaleOrd" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.cancelPartsSaleOrd] */
        UPDATE DMSDB.PT_0521T    --부품판매정보
           SET ORD_STAT_CD         = '03'                       --상태('03':취소)
              ,CANC_REASON_CD      = #{cancReasonCd}
              ,CANC_REASON_REMARK  = #{cancReasonRemark}
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD                = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --구매오더번호
    </update>

     <!-- 헤더 번호에 해당하는 모든 부품 정보를 삭제한다.-->
    <update id="cancelPartsSaleOrdItem" parameterType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.cancelPartsSaleOrdItem] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
           SET GI_STAT_CD     = '03'                       --상태('03':취소)
              ,CANC_ID        = #{regUsrId}
              ,CANC_DT        = sysdate
              ,CANC_QTY       = #{ordQty}
              ,UPDT_USR_ID    = #{regUsrId}                --수정자ID
              ,UPDT_DT        = sysdate                    --수정일자
         WHERE DLR_CD                = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --판매번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}               --판매라인번호
    </update>

    <!-- 부품판매  정보 상태를 변경한다.-->
    <update id="modifyPartsSaleOrdStat" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.modifyPartsSaleOrdStat] */
        UPDATE DMSDB.PT_0521T    --부품판매정보
           SET ORD_STAT_CD       = #{ordStatCd}               --상태
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD                = #{dlrCd}               --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}        --구매오더번호
    </update>

    <!-- 부품판매  정보 를 확정한다.-->
    <update id="confirmPartsSaleOrdStat" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.confirmPartsSaleOrdStat] */
        UPDATE DMSDB.PT_0521T    --부품판매정보
           SET ORD_DT            = sysdate
              ,ORD_STAT_CD       = #{ordStatCd}        --상태
              ,CUST_NM           = #{custNm}           --고객명
              ,REMARK            = #{remark}
              ,DC_RATE           = round(#{dcRate},2)       --할인률
              ,DC_BEF_TOT_AMT    = round(#{dcBefTotAmt},2)  --할인전총금액
              ,DC_AMT            = round(#{dcAmt},2)        --할인금액
              ,TOT_AMT           = round(#{totAmt},2)       --총금액
              ,VAT_AMT           = round(#{vatAmt},2)       --총세금
              ,CUST_TEL_NO       = #{custTelNo}
              ,UPDT_USR_ID       = #{regUsrId}         --수정자ID
              ,UPDT_DT           = sysdate             --수정일자
         WHERE DLR_CD                = #{dlrCd}        --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo} --구매오더번호
    </update>

    <update id="cnfmPartsSaleOrdItem" parameterType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.cnfmPartsSaleOrdItem] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET
               END_QTY           = #{ordQty}                  --수량
              ,GI_DT             = sysdate                    --출고일자
              ,GI_STAT_CD        = '02'                       --상태('02':확정)
              ,DC_RATE           = round(NVL(#{dcRate},0),2)  --할인율
              ,PRC               = round(#{prc},2)            --가격
              ,AMT               = round(#{amt},2)            --금액
              ,EQIP_EXPC_DT      = #{eqipExpcDt}              --설치예정일자
              ,PRINT_ITEM_NM     = #{printItemNm}             --품목명(인쇄용)
              ,GI_STRGE_CD       = #{giStrgeCd}               --출고창고
              ,GI_LOC_CD         = #{giLocCd}                 --출고로케이션
              ,TAX_DDCT_AMT      = round(#{taxDdctAmt},2)     --세금공제금액(할인 후 금액)
              ,TAX_AMT           = round(#{taxAmt},2)         --세금금액
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --구매오더번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}           --구매오더라인번호
    </update>

    <!-- 판매확정 시 수불 정보를 반영한다. -->
    <update id="updateParSaleOrdItemMvtInfo" parameterType="ToolGiItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updateParSaleOrdItemMvtInfo] */
        UPDATE DMSDB.PT_0522T    --부품판매품목정보
          SET  MVT_DOC_YY_MM       = #{mvtDocYyMm}               --수불문서년월
              ,MVT_DOC_NO          = #{mvtDocNo}                 --수불문서번호
              ,MVT_DOC_LINE_NO     = #{mvtDocLineNo}             --수불문서라인번호
              ,UPDT_USR_ID         = #{regUsrId}                 --수정자ID
              ,UPDT_DT             = sysdate                     --수정일자
         WHERE DLR_CD              = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO       = #{parSaleOrdNo}               --판매번호
           AND PAR_SALE_ORD_LINE_NO  = #{parSaleOrdLineNo}           --판매라인번호
    </update>

    <!-- 판매확정 시 수불 정보를 반영한다. -->
    <update id="updateParSaleOrdMvtInfo" parameterType="ToolGiVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updateParSaleOrdMvtInfo] */
        UPDATE DMSDB.PT_0521T    --부품판매정보
          SET  MVT_DOC_YY_MM       = #{mvtDocYyMm}               --수불문서년월
              ,MVT_DOC_NO          = #{mvtDocNo}                 --수불문서번호
              ,UPDT_USR_ID         = #{regUsrId}                 --수정자ID
              ,UPDT_DT             = sysdate                     --수정일자
         WHERE DLR_CD              = #{dlrCd}                   --딜러코드
           AND PAR_SALE_ORD_NO     = #{parSaleOrdNo}               --판매번호
    </update>

     <!-- 부품판매 정보를 정산처리한다. -->
    <update id="updateCalculateInfo" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updateCalculateInfo] */
        UPDATE DMSDB.PT_0521T A    --부품판매헤더정보
          SET  CALC_DOC_NO        = #{calcDocNo}        --정산번호
              ,ORD_STAT_CD        = #{ordStatCd}        --상태
              ,UPDT_USR_ID        = #{regUsrId}         --수정자ID
              ,UPDT_DT            = sysdate
         WHERE DLR_CD             = #{dlrCd}            --딜러코드
           AND PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </update>

     <!-- 부품판매 정보를 수정일자를 수정한다. -->
    <update id="updatePartsSaleUpdateDt" parameterType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.updatePartsSaleUpdateDt] */
        UPDATE DMSDB.PT_0521T A    --부품판매헤더정보
          SET  UPDT_USR_ID        = #{regUsrId}         --수정자ID
              ,UPDT_DT            = sysdate
         WHERE DLR_CD             = #{dlrCd}            --딜러코드
           AND PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </update>

    <!-- 부품판매 헤더 정보를 조회한다. -->
    <select id="selectPartsSaleOrdByKey" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdByKey] */
        SELECT
                A.DLR_CD                    --딜러코드
               ,A.PAR_SALE_ORD_NO           --부품판매오더번호
               ,A.ORD_DT                    --오더일자
               ,A.SALE_TP                     --판매유형
               ,A.CUST_TP                   --고객유형
               ,A.CUST_CD                   --고객코드
               ,A.CUST_NM                   --고객명
               ,A.CUST_TEL_NO               --고객전화번호
               ,A.SALE_PRSN_ID          --판매담당자
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SALE_PRSN_ID) AS SALE_PRSN_NM
               ,A.SA_ID                     --SAID
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SA_ID ) AS SA_NM
               ,A.REMARK                    --비고
               ,A.DC_RATE                   --할인율
               ,A.DC_BEF_TOT_AMT            --할인전총금액
               ,A.DC_AMT                    --할인금액
               ,A.TOT_AMT                   --총금액
               ,A.VAT_AMT                   --총세금
               ,B.ITEM_CNT
               ,(B.ITEM_QTY - NVL(C.RETURN_ITEM_QTY,0)) AS ITEM_QTY
               ,(B.ITEM_AMT - NVL(C.RETURN_ITEM_AMT,0)) AS ITEM_AMT
               ,CASE WHEN NVL(C.RETURN_ITEM_QTY,0) =  NVL(B.ITEM_QTY,0) THEN '07' ELSE A.ORD_STAT_CD END ORD_STAT_CD
               ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
               ,A.CALC_DOC_NO           --정산번호
               ,A.CAR_REG_NO
          FROM DMSDB.PT_0521T A    --부품판매헤더정보
               LEFT OUTER JOIN (
                     SELECT   DLR_CD
                             ,PAR_SALE_ORD_NO
                             ,COUNT(*) AS ITEM_CNT
                             ,SUM(NVL(ORD_QTY,0)) AS ITEM_QTY
                             ,SUM(NVL(AMT,0)) AS ITEM_AMT
                       FROM   DMSDB.PT_0522T
                      WHERE   DLR_CD = #{sDlrCd}
                        AND   NVL(ITEM_STAT_CD,'01') != '03'
                      GROUP BY DLR_CD
                              ,PAR_SALE_ORD_NO
                 ) B
                 ON A.DLR_CD          = B.DLR_CD
                AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
               LEFT OUTER JOIN  (
                             SELECT   A.DLR_CD
                                     ,A.REF_DOC_NO AS RETURN_DOC_NO
                                     ,COUNT(*) AS RETURN_ITEM_CNT
                                     ,SUM(NVL(A.END_QTY,0)) AS RETURN_ITEM_QTY
                                     ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                               FROM   DMSDB.PT_0522T A
                              WHERE   A.DLR_CD        = #{sDlrCd}
                                AND   A.REF_DOC_NO    = #{sParSaleOrdNo}
                              GROUP BY  A.DLR_CD
                                       ,A.REF_DOC_NO
                       ) C    --반품판매정보
                     ON A.DLR_CD               = C.DLR_CD
                    AND A.PAR_SALE_ORD_NO      = C.RETURN_DOC_NO
         WHERE A.DLR_CD             = #{sDlrCd}
           AND A.PAR_SALE_ORD_NO    = #{sParSaleOrdNo}
    </select>

    <!-- 부품판매 부품 정보를 조회한다. -->
    <select id="selectPartsSaleOrdItemByKey" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemByKey] */
            SELECT
                        A.DLR_CD                      --딜러코드
                       ,A.PAR_SALE_ORD_NO             --부품판매오더번호
                       ,A.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                       ,A.CALC_TP_CD                  --정산유형코드
                       ,A.ITEM_CD                     --품목코드
                       ,A.ITEM_NM
                       ,NVL(A.PRINT_ITEM_NM,A.ITEM_NM) AS PRINT_ITEM_NM
                       ,A.ITEM_DSTIN_CD
                       ,A.EQIP_EXPC_DT                --설치예정일자
                       ,A.DC_RATE                     --할인율
                       ,A.PRC                         --단가
                       ,A.AMT                         --금액
                       ,A.UNIT_CD                     --단위코드
                       ,NVL(A.END_QTY,A.ORD_QTY) AS ORD_QTY --오더수량
                       ,A.END_QTY                     --종료수량
                       ,A.STOCK_QTY
                       ,A.AVLB_STOCK_QTY
                       ,A.RESV_STOCK_QTY
                       ,A.CLAM_STOCK_QTY
                       ,A.BORROW_QTY
                       ,A.RENT_QTY
                       ,A.GI_STRGE_CD
                       ,A.SALE_TP
                       ,A.GI_LOC_CD
                       ,A.DC_AMT
                       ,A.PART_COST
                       ,A.TAX_AMT
                       ,A.TAX_DDCT_AMT
                       ,A.SALE_PRSN_ID
                       ,A.SALE_PRSN_NM
                       ,A.GI_DT
                       ,A.GI_TIME
                       ,A.CANC_DT
                       ,A.CANC_TIME
                       ,A.CANC_ID
                       ,A.CANC_NM
                       ,A.CANC_QTY
                       ,A.RETURN_DT
                       ,A.RETURN_TIME
                       ,A.RETURN_ID
                       ,A.RETURN_NM
                       ,A.RETURN_QTY
                       ,A.PRE_RETURN_QTY
                       ,A.RETURN_DOC_NO
                       ,A.GI_STAT_CD
                       ,A.PKG_ITEM_CD
                       ,(SELECT PKG_ITEM_NM FROM PT_0230T WHERE DLR_CD = A.DLR_CD AND PKG_ITEM_CD = A.PKG_ITEM_CD AND ROWNUM = 1) AS PKG_ITEM_NM
                       ,A.MOVING_AVG_PRC
                       ,NVL(A.MOVING_AVG_TAX_DDCT_PRC, 0) AS MOVING_AVG_TAX_DDCT_PRC
                       ,A.MOVING_AVG_AMT
                       ,NVL(A.MOVING_AVG_TAX_DDCT_AMT, 0) AS MOVING_AVG_TAX_DDCT_AMT
              FROM (
                       SELECT   A.DLR_CD                      --딜러코드
                               ,A.PAR_SALE_ORD_NO             --부품판매오더번호
                               ,A.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                               ,A.CALC_TP_CD                  --정산유형코드
                               ,A.ITEM_CD                     --품목코드
                               ,A.PRINT_ITEM_NM
                               ,B.ITEM_NM
                               ,B.ITEM_DSTIN_CD
                               ,A.EQIP_EXPC_DT                --설치예정일자
                               ,A.DC_RATE                     --할인율
                               ,A.PRC                         --단가
                               ,A.AMT                         --금액
                               ,A.UNIT_CD                     --단위코드
                               ,A.ORD_QTY                     --오더수량
                               ,A.END_QTY                     --종료수량
                               ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                               ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                               ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                               ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                               ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                               ,NVL(C.RENT_QTY,0) AS RENT_QTY
                               ,A.GI_STRGE_CD
                               ,D.SALE_TP
                               ,NVL(A.GI_LOC_CD,' ') AS GI_LOC_CD
                               ,CASE WHEN NVL(A.DC_AMT,0) <![CDATA[>]]> 0 THEN A.DC_AMT WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END DC_AMT
                               ,(NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS PART_COST
                               ,A.TAX_AMT
                               ,A.TAX_DDCT_AMT
                               ,D.SALE_PRSN_ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = D.SALE_PRSN_ID) AS SALE_PRSN_NM
                               ,A.GI_DT
                               ,TO_CHAR(A.GI_DT, 'HH24:MI:SS') AS GI_TIME
                               ,A.CANC_DT
                               ,TO_CHAR(A.CANC_DT, 'HH24:MI:SS') AS CANC_TIME
                               ,A.CANC_ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CANC_ID) AS CANC_NM
                               ,A.CANC_QTY
                               ,E.RETURN_DT
                               ,TO_CHAR(E.RETURN_DT, 'HH24:MI:SS') AS RETURN_TIME
                               ,E.RETURN_ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                               ,0 AS RETURN_QTY
                               ,NVL(E.RETURN_QTY,0) AS PRE_RETURN_QTY
                               ,E.RETURN_DOC_NO
                               ,A.GI_STAT_CD
                               ,A.PKG_ITEM_CD
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN F.MOVING_AVG_PRC ELSE G.MOVING_AVG_PRC END MOVING_AVG_PRC
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN F.MOVING_AVG_TAX_DDCT_PRC ELSE G.MOVING_AVG_TAX_DDCT_PRC END MOVING_AVG_TAX_DDCT_PRC
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN ROUND(A.ORD_QTY * F.MOVING_AVG_PRC,2) ELSE G.MOVING_AVG_AMT END MOVING_AVG_AMT
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN ROUND(A.ORD_QTY * F.MOVING_AVG_TAX_DDCT_PRC,2) ELSE G.MOVING_AVG_TAX_DDCT_AMT END MOVING_AVG_TAX_DDCT_AMT
                           FROM DMSDB.PT_0522T A    --부품판매품목정보
                                INNER JOIN  DMSDB.PT_0521T D
                                   ON A.DLR_CD          = D.DLR_CD
                                  AND A.PAR_SALE_ORD_NO = D.PAR_SALE_ORD_NO
                                INNER JOIN  DMSDB.PT_0201T B    --품목정보
                                   ON A.DLR_CD  = B.DLR_CD
                                  AND A.ITEM_CD = B.ITEM_CD
                                LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                                   ON A.DLR_CD      = C.DLR_CD
                                  AND A.GI_STRGE_CD = C.STRGE_CD
                                  AND A.ITEM_CD     = C.ITEM_CD
                                 LEFT OUTER JOIN  (
                                       SELECT   A.DLR_CD
                                               ,A.REF_DOC_NO
                                               ,A.REF_DOC_LINE_NO
                                               ,MAX(A.PAR_SALE_ORD_NO) AS RETURN_DOC_NO
                                               ,SUM(A.ORD_QTY) AS RETURN_QTY
                                               ,MAX(B.ORD_DT) AS RETURN_DT
                                               ,MAX(B.SALE_PRSN_ID) AS RETURN_ID
                                         FROM   DMSDB.PT_0522T A
                                                INNER JOIN  DMSDB.PT_0521T B
                                                   ON A.DLR_CD          = B.DLR_CD
                                                  AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                                        WHERE   A.DLR_CD        = #{sDlrCd}
                                          AND   A.REF_DOC_NO    = #{sParSaleOrdNo}
                                        GROUP BY  A.DLR_CD
                                                 ,A.REF_DOC_NO
                                                 ,A.REF_DOC_LINE_NO
                                 ) E    --반품판매품목정보
                                   ON A.DLR_CD               = E.DLR_CD
                                  AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                                  AND A.PAR_SALE_ORD_LINE_NO = E.REF_DOC_LINE_NO
                                 LEFT OUTER JOIN PT_0208T F
                                   ON A.DLR_CD =  F.DLR_CD
                                  AND A.GI_STRGE_CD = F.STRGE_CD
                                  AND A.ITEM_CD = F.ITEM_CD
                                 LEFT OUTER JOIN PT_0312T G
                                   ON A.DLR_CD =  G.DLR_CD
                                  AND A.MVT_DOC_YY_MM = G.MVT_DOC_YY_MM
                                  AND A.MVT_DOC_NO = G.MVT_DOC_NO
                                  AND A.MVT_DOC_LINE_NO = G.MVT_DOC_LINE_NO
                          WHERE A.DLR_CD             = #{sDlrCd}
                            AND A.PAR_SALE_ORD_NO    = #{sParSaleOrdNo}
                         UNION ALL
                         SELECT
                                A.DLR_CD                      --딜러코드
                               ,A.REF_DOC_NO AS PAR_SALE_ORD_NO             --부품판매오더번호
                               ,A.REF_DOC_LINE_NO AS PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                               ,A.CALC_TP_CD                  --정산유형코드
                               ,A.ITEM_CD                     --품목코드
                               ,A.PRINT_ITEM_NM
                               ,B.ITEM_NM
                               ,B.ITEM_DSTIN_CD
                               ,A.EQIP_EXPC_DT                --설치예정일자
                               ,A.DC_RATE                     --할인율
                               ,A.PRC                         --단가
                               ,(A.AMT * -1) AS AMT           --금액
                               ,A.UNIT_CD                     --단위코드
                               ,(A.ORD_QTY * -1) AS ORD_QTY                     --오더수량
                               ,(A.END_QTY * -1) AS END_QTY                    --종료수량
                               ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                               ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                               ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                               ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                               ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                               ,NVL(C.RENT_QTY,0) AS RENT_QTY
                               ,A.GI_STRGE_CD
                               ,D.SALE_TP
                               ,NVL(A.GI_LOC_CD,' ') AS GI_LOC_CD
                               ,(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END * -1) DC_AMT
                               ,((NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) * -1) AS PART_COST
                               ,(A.TAX_AMT * -1) AS TAX_AMT
                               ,(A.TAX_DDCT_AMT * -1) AS TAX_DDCT_AMT
                               ,D.SALE_PRSN_ID
                               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = D.SALE_PRSN_ID) AS SALE_PRSN_NM
                               ,A.GI_DT
                               ,TO_CHAR(A.GI_DT, 'HH24:MI:SS') AS GI_TIME
                               ,NULL AS CANC_DT
                               ,NULL AS CANC_TIME
                               ,NULL AS CANC_ID
                               ,NULL AS CANC_NM
                               ,0 AS CANC_QTY
                               ,NULL AS RETURN_DT
                               ,NULL AS RETURN_TIME
                               ,NULL RETURN_ID
                               ,NULL AS RETURN_NM
                               ,0 AS RETURN_QTY
                               ,0 AS PRE_RETURN_QTY
                               ,NULL AS RETURN_DOC_NO
                               ,A.GI_STAT_CD
                               ,A.PKG_ITEM_CD
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN E.MOVING_AVG_PRC ELSE F.MOVING_AVG_PRC END MOVING_AVG_PRC
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN E.MOVING_AVG_TAX_DDCT_PRC ELSE F.MOVING_AVG_TAX_DDCT_PRC END MOVING_AVG_TAX_DDCT_PRC
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN ROUND(A.ORD_QTY * E.MOVING_AVG_PRC,2) ELSE F.MOVING_AVG_AMT END MOVING_AVG_AMT
                               ,CASE WHEN A.GI_STAT_CD = '01' THEN ROUND(A.ORD_QTY * E.MOVING_AVG_TAX_DDCT_PRC,2) ELSE F.MOVING_AVG_TAX_DDCT_AMT END MOVING_AVG_TAX_DDCT_AMT
                           FROM DMSDB.PT_0522T A    --부품판매품목정보
                                INNER JOIN  DMSDB.PT_0521T D
                                   ON A.DLR_CD          = D.DLR_CD
                                  AND A.PAR_SALE_ORD_NO = D.PAR_SALE_ORD_NO
                                INNER JOIN  DMSDB.PT_0201T B    --품목정보
                                   ON A.DLR_CD  = B.DLR_CD
                                  AND A.ITEM_CD = B.ITEM_CD
                                LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                                   ON A.DLR_CD      = C.DLR_CD
                                  AND A.GI_STRGE_CD = C.STRGE_CD
                                  AND A.ITEM_CD     = C.ITEM_CD
                                LEFT OUTER JOIN PT_0208T E
                                   ON A.DLR_CD =  E.DLR_CD
                                  AND A.GI_STRGE_CD = E.STRGE_CD
                                  AND A.ITEM_CD = E.ITEM_CD
                                LEFT OUTER JOIN PT_0312T F
                                   ON A.DLR_CD =  F.DLR_CD
                                  AND A.MVT_DOC_YY_MM = F.MVT_DOC_YY_MM
                                  AND A.MVT_DOC_NO = F.MVT_DOC_NO
                                  AND A.MVT_DOC_LINE_NO = F.MVT_DOC_LINE_NO
                          WHERE A.DLR_CD             = #{sDlrCd}
                            AND A.REF_DOC_NO         = #{sParSaleOrdNo}
                ) A
                ORDER BY DLR_CD, PAR_SALE_ORD_NO, PAR_SALE_ORD_LINE_NO,GI_STAT_CD, RETURN_DT
    </select>

    <!-- 부품판매 부품 정보를 조회한다.(정산용) -->
    <select id="selectPartsSaleOrdCalcItemByKey" parameterType="PartsSaleOrdSearchVO" resultType="PartCalculateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdCalcItemByKey] */
        SELECT
                        A.DLR_CD                      --딜러코드
                       ,A.ITEM_CD                     --품목코드
                       ,A.ITEM_NM
                       ,A.ITEM_PRC                     --단가
                       ,A.PART_COST                    --금액
                       ,A.EXPC_PAR_AMT                 --부품비용
                       ,A.CALC_UNIT_CD                 --단위코드
                       ,A.ITEM_QTY                     --오더수량
                       ,A.RETURN_QTY                   --오더수량
                       ,A.DC_RATE
                       ,A.DC_AMT
                       ,A.GI_STRGE_CD
                       ,A.GI_LOC_CD
                       ,A.RO_TP --RO유형(01:'일반')
                       ,A.PAYM_TP --결제유형(04:'고객')
                       ,A.PAYM_USR_NM --결제자
                       ,A.GI_STAT_CD
                       ,A.PAR_SALE_ORD_NO
                       ,A.PAR_SALE_ORD_LINE_NO
                       ,A.PKG_ITEM_CD
                       ,A.PKG_ITEM_NM
                       ,NVL(B.MOVING_AVG_PRC, 0) AS MOVING_AVG_PRC
                       ,NVL(B.MOVING_AVG_TAX_DDCT_PRC, 0) AS MOVING_AVG_TAX_DDCT_PRC
                       ,ROUND((A.ITEM_QTY - A.RETURN_QTY) * NVL(B.MOVING_AVG_PRC, 0),2) AS MOVING_AVG_AMT
                       ,ROUND((A.ITEM_QTY - A.RETURN_QTY) * NVL(B.MOVING_AVG_TAX_DDCT_PRC, 0),2) AS MOVING_AVG_TAX_DDCT_AMT
              FROM (
                     SELECT
                            A.DLR_CD                      --딜러코드
                           ,A.ITEM_CD                     --품목코드
                           ,C.ITEM_NM
                           ,A.PRC AS ITEM_PRC                         --단가
                           --,A.AMT AS EXPC_PAR_AMT                     --금액
                           ,((A.PRC * A.ORD_QTY) - CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS EXPC_PAR_AMT                     --금액
                           ,A.UNIT_CD AS CALC_UNIT_CD                 --단위코드
                           ,A.ORD_QTY AS ITEM_QTY                     --오더수량
                           ,NVL(E.RETURN_QTY, 0) AS RETURN_QTY                     --오더수량
                           ,A.DC_RATE
                           ,CASE  WHEN NVL(A.DC_AMT,0) <![CDATA[>]]> 0 THEN A.DC_AMT  WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END DC_AMT
                           ,A.GI_STRGE_CD
                           ,A.GI_LOC_CD
                           ,'01' AS RO_TP --RO유형(01:'일반')
                           ,'04' AS PAYM_TP --결제유형(04:'고객')
                           ,B.CUST_NM AS PAYM_USR_NM --결제자
                           ,A.GI_STAT_CD
                           ,A.PAR_SALE_ORD_NO
                           ,A.PAR_SALE_ORD_LINE_NO
                           ,A.PKG_ITEM_CD
                           ,(SELECT PKG_ITEM_NM FROM PT_0230T WHERE DLR_CD = A.DLR_CD AND PKG_ITEM_CD = A.PKG_ITEM_CD AND ROWNUM = 1) AS PKG_ITEM_NM
                           --,(NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS PART_COST
                           ,(A.PRC * A.ORD_QTY) AS PART_COST
                       FROM DMSDB.PT_0522T A    --부품판매품목정보
                            INNER JOIN  DMSDB.PT_0521T B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                            INNER JOIN  DMSDB.PT_0201T C    --품목정보
                               ON A.DLR_CD  = C.DLR_CD
                              AND A.ITEM_CD = C.ITEM_CD
                            LEFT OUTER JOIN  DMSDB.PT_0301T D    --재고정보
                               ON A.DLR_CD      = D.DLR_CD
                              AND C.GI_STRGE_CD = D.STRGE_CD
                              AND A.ITEM_CD     = D.ITEM_CD
                            LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO
                                           ,A.REF_DOC_LINE_NO
                                           ,SUM(A.ORD_QTY) AS RETURN_QTY
                                           ,SUM(A.AMT) AS RETURN_AMT
                                     FROM   DMSDB.PT_0522T A
                                            INNER JOIN  DMSDB.PT_0521T B
                                               ON A.DLR_CD          = B.DLR_CD
                                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                                    WHERE   A.DLR_CD        = #{sDlrCd}
                                      AND   A.REF_DOC_NO    = #{sParSaleOrdNo}
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                                             ,A.REF_DOC_LINE_NO
                             ) E    --반품판매품목정보
                               ON A.DLR_CD               = E.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                              AND A.PAR_SALE_ORD_LINE_NO = E.REF_DOC_LINE_NO
                      WHERE A.DLR_CD             = #{sDlrCd}
                        AND A.PAR_SALE_ORD_NO    = #{sParSaleOrdNo}
                    UNION ALL
                     SELECT
                            A.DLR_CD                      --딜러코드
                           ,A.ITEM_CD                     --품목코드
                           ,C.ITEM_NM
                           ,A.PRC AS ITEM_PRC                         --단가
                           --,(A.AMT * -1) AS EXPC_PAR_AMT          --금액
                           ,(((A.PRC * A.ORD_QTY) - CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) * -1) AS EXPC_PAR_AMT --금액
                           ,A.UNIT_CD AS CALC_UNIT_CD                 --단위코드
                           ,(A.END_QTY * -1) AS ITEM_QTY              --오더수량
                           ,0 AS RETURN_QTY                           --반품수량
                           ,A.DC_RATE
                           ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE (ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) * -1) END DC_AMT
                           ,A.GI_STRGE_CD
                           ,A.GI_LOC_CD
                           ,'01' AS RO_TP --RO유형(01:'일반')
                           ,'04' AS PAYM_TP --결제유형(04:'고객')
                           ,B.CUST_NM AS PAYM_USR_NM --결제자
                           ,A.GI_STAT_CD
                           ,A.REF_DOC_NO AS PAR_SALE_ORD_NO
                           ,A.REF_DOC_LINE_NO AS PAR_SALE_ORD_LINE_NO
                           ,A.PKG_ITEM_CD
                           ,(SELECT PKG_ITEM_NM FROM PT_0230T WHERE DLR_CD = A.DLR_CD AND PKG_ITEM_CD = A.PKG_ITEM_CD AND ROWNUM = 1) AS PKG_ITEM_NM
                           --,((NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) * -1) AS PART_COST
                           ,((A.PRC * A.ORD_QTY) * -1) AS PART_COST
                       FROM DMSDB.PT_0522T A    --부품판매품목정보
                            INNER JOIN  DMSDB.PT_0521T B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                            INNER JOIN  DMSDB.PT_0201T C    --품목정보
                               ON A.DLR_CD  = C.DLR_CD
                              AND A.ITEM_CD = C.ITEM_CD
                            LEFT OUTER JOIN  DMSDB.PT_0301T D    --재고정보
                               ON A.DLR_CD      = D.DLR_CD
                              AND C.GI_STRGE_CD = D.STRGE_CD
                              AND A.ITEM_CD     = D.ITEM_CD
                      WHERE A.DLR_CD             = #{sDlrCd}
                        AND A.REF_DOC_NO         = #{sParSaleOrdNo}
        ) A
        LEFT OUTER JOIN PT_0208T B
          ON A.DLR_CD = B.DLR_CD
         AND A.GI_STRGE_CD = B.STRGE_CD
         AND A.ITEM_CD = B.ITEM_CD
        ORDER BY A.DLR_CD,A.PAR_SALE_ORD_NO,A.PAR_SALE_ORD_LINE_NO, A.ITEM_CD, A.GI_STAT_CD
    </select>

    <!-- 부품판매 리스트정보를 조회한다. -->
    <select id="selectPartsSaleOrdList" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdList] */
      SELECT    A.*
        FROM
             (
          SELECT    ROWNUM AS RNUM
                   ,T1.*
            FROM
                 (
                     SELECT A.DLR_CD                    --딜러코드
                           --,A.ORD_STAT_CD               --오더상태코드
                           ,A.ORD_DT                    --오더일자
                           ,A.SALE_TP                   --판매유형
                           ,A.CUST_TP                   --고객유형
                           ,A.CUST_CD                   --고객코드
                           ,A.CUST_NM                   --고객명
                           ,A.CUST_TEL_NO               --고객전화번호
                           ,A.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,A.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,C.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,A.SA_ID                     --SAID
                           ,D.USR_NM AS SA_NM
                           ,A.REMARK                    --비고
                           --,A.DC_RATE                   --할인율
                           ,CASE WHEN ((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0)))) = 0
                                   THEN 0
                                 ELSE
                                   ROUND(((B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))/((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0))))) * 100,2)
                             END DC_RATE
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) * -1 ELSE (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) END DC_BEF_TOT_AMT --할인전총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) * -1 ELSE (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) END DC_AMT
                           --,(A.DC_AMT - NVL(E.RETURN_DC_AMT, 0)) AS DC_AMT              --할인금액
                           --,(A.TOT_AMT - NVL(E.RETURN_TOT_AMT, 0)) AS TOT_AMT           --총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - NVL(E.RETURN_TOT_AMT,0) - (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))) * -1 ELSE (A.DC_BEF_TOT_AMT - NVL(E.RETURN_TOT_AMT,0) - (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))) END TOT_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.VAT_AMT) * -1 ELSE A.VAT_AMT END VAT_AMT
                           ,A.CANC_REASON_CD            --취소사유코드
                           ,A.CANC_REASON_REMARK        --취소사유비고
                           ,A.REG_USR_ID                --등록자ID
                           ,A.REG_DT                    --등록일자
                           ,A.UPDT_USR_ID               --수정자ID
                           ,A.UPDT_DT                   --수정일자
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_CNT) * -1 ELSE B.ITEM_CNT END ITEM_CNT
                           --,(B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) AS ITEM_QTY
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_QTY) * -1 ELSE B.ITEM_QTY END ITEM_QTY
                           --,(B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) AS ITEM_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_AMT) * -1 ELSE B.ITEM_AMT END ITEM_AMT
                           --,B.ITEM_AMT
                           ,A.CALC_DOC_NO
                           ,E.RETURN_DT
                           ,E.RETURN_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                           ,F.RETURN_DOC_NO
                           ,F.RETURN_ITEM_CNT
                           ,F.RETURN_ITEM_QTY
                           ,F.RETURN_ITEM_AMT
                           ,G.CALC_DT
                           ,G.CALC_STAT_CD
                           ,G.PAR_BM_POINT_USE_AMT
                           ,G.POINT_TOT_AMT
                           ,G.PAR_ETC_DC_AMT
                           ,G.PAR_CALC_SUM_AMT
                           ,G.PAR_DC_RATE
                           ,G.PAR_DC_AMT
                           ,G.PAR_CALC_AMT
                           ,G.ETC_DC_CD
                           ,H.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(B.ITEM_QTY,0) = 0 THEN A.ORD_STAT_CD ELSE CASE WHEN NVL(F.RETURN_ITEM_QTY,0) =  NVL(B.ITEM_QTY,0) THEN '08' ELSE A.ORD_STAT_CD END END  ORD_STAT_CD
                           ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                           ,CASE WHEN A.ORD_STAT_CD = '07'
                                   THEN (B.MOVING_AVG_AMT) * -1
                                 ELSE (B.MOVING_AVG_AMT)
                             END MOVING_AVG_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07'
                                   THEN (NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                                 ELSE (NVL(B.MOVING_AVG_TAX_DDCT_AMT,0))
                             END MOVING_AVG_TAX_DDCT_AMT
                           ,A.CAR_REG_NO
                      FROM DMSDB.PT_0521T A    --부품판매헤더정보
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                         ,SUM(B.MOVING_AVG_AMT) MOVING_AVG_AMT
                                         ,SUM(NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) MOVING_AVG_TAX_DDCT_AMT
                                   FROM   DMSDB.PT_0522T A
                                          LEFT OUTER JOIN PT_0312T B
                                            ON A.DLR_CD               = B.DLR_CD
                                           AND A.PAR_SALE_ORD_NO      = B.REF_DOC_NO
                                           AND A.PAR_SALE_ORD_LINE_NO = B.REF_DOC_LINE_NO
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                    AND   A.GI_STAT_CD != '01'
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T C
                               ON A.SALE_PRSN_ID = C.USR_ID
                              --AND C.ENABLED_YN = 'Y'
                              --AND C.DEL_YN     = 'N'
                             LEFT OUTER JOIN CM_0801T D
                               ON A.SA_ID  = D.USR_ID
                              --AND D.ENABLED_YN = 'Y'
                             -- AND D.DEL_YN     = 'N'
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO
                                           ,MAX(A.ORD_DT) AS RETURN_DT
                                           ,MAX(A.REG_USR_ID) AS RETURN_ID
                                           ,SUM(A.DC_BEF_TOT_AMT) AS RETURN_DC_BEF_TOT_AMT
                                           ,SUM(A.DC_AMT) AS RETURN_DC_AMT
                                           ,SUM(A.TOT_AMT) AS RETURN_TOT_AMT
                                     FROM   DMSDB.PT_0521T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) E    --반품판매정보
                               ON A.DLR_CD               = E.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) F    --반품판매정보
                               ON A.DLR_CD               = F.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = F.RETURN_DOC_NO
                            LEFT OUTER JOIN SE_0500T G  --정산테이블
                               ON A.DLR_CD       = G.DLR_CD
                              AND A.CALC_DOC_NO  = G.CALC_DOC_NO
                              AND G.CALC_CANC_YN = 'N'
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) H
                               ON G.DLR_CD    = H.DLR_CD
                              AND G.ETC_DC_CD = H.PUBLI_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       --AND A.ORD_STAT_CD != '07'
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%'
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND G.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND G.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND A.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND A.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND D.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND A.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND C.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND A.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND B.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND B.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND B.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND A.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                     ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "parSaleOrdNo"'> A.PAR_SALE_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordStatCd"'> A.ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordDt"'> A.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custTp"'> A.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custNm"'> A.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saNm"'> C.USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saleTp"'> A.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <otherwise>
                                       A.DLR_CD ASC
                                      ,A.PAR_SALE_ORD_NO DESC
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                           A.DLR_CD ASC
                          ,A.PAR_SALE_ORD_NO DESC
                         </otherwise>
                     </choose>
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 리스트정보(팝업)를 조회한다. -->
    <select id="selectPartsSaleOrdPopList" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdPopList] */
      SELECT    A.*
        FROM
             (
          SELECT    ROWNUM AS RNUM
                   ,T1.*
            FROM
                 (
                     SELECT A.DLR_CD                    --딜러코드
                           --,A.ORD_STAT_CD               --오더상태코드
                           ,A.ORD_DT                    --오더일자
                           ,A.SALE_TP                   --판매유형
                           ,A.CUST_TP                   --고객유형
                           ,A.CUST_CD                   --고객코드
                           ,A.CUST_NM                   --고객명
                           ,A.CUST_TEL_NO               --고객전화번호
                           ,A.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,A.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,C.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,A.SA_ID                     --SAID
                           ,D.USR_NM AS SA_NM
                           ,A.REMARK                    --비고
                           --,A.DC_RATE                   --할인율
                           ,CASE WHEN ((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0)))) = 0
                                   THEN 0
                                 ELSE
                                   ROUND(((B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))/((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0))))) * 100,2)
                             END DC_RATE
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) * -1 ELSE (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) END DC_BEF_TOT_AMT --할인전총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) * -1 ELSE (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) END DC_AMT
                           --,(A.DC_AMT - NVL(E.RETURN_DC_AMT, 0)) AS DC_AMT              --할인금액
                           --,(A.TOT_AMT - NVL(E.RETURN_TOT_AMT, 0)) AS TOT_AMT           --총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) * -1 ELSE (A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) END TOT_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.VAT_AMT) * -1 ELSE A.VAT_AMT END VAT_AMT
                           ,A.CANC_REASON_CD            --취소사유코드
                           ,A.CANC_REASON_REMARK        --취소사유비고
                           ,A.REG_USR_ID                --등록자ID
                           ,A.REG_DT                    --등록일자
                           ,A.UPDT_USR_ID               --수정자ID
                           ,A.UPDT_DT                   --수정일자
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_CNT) * -1 ELSE B.ITEM_CNT END ITEM_CNT
                           --,(B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) AS ITEM_QTY
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_QTY) * -1 ELSE B.ITEM_QTY END ITEM_QTY
                           --,(B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) AS ITEM_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_AMT) * -1 ELSE B.ITEM_AMT END ITEM_AMT
                           --,B.ITEM_AMT
                           ,A.CALC_DOC_NO
                           ,E.RETURN_DT
                           ,E.RETURN_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                           ,F.RETURN_DOC_NO
                           ,F.RETURN_ITEM_CNT
                           ,F.RETURN_ITEM_QTY
                           ,F.RETURN_ITEM_AMT
                           ,G.CALC_DT
                           ,G.CALC_STAT_CD
                           ,G.PAR_BM_POINT_USE_AMT
                           ,G.POINT_TOT_AMT
                           ,G.PAR_ETC_DC_AMT
                           ,G.PAR_CALC_SUM_AMT
                           ,G.PAR_DC_RATE
                           ,G.PAR_DC_AMT
                           ,G.PAR_CALC_AMT
                           ,G.ETC_DC_CD
                           ,H.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(B.ITEM_QTY,0) = 0 THEN A.ORD_STAT_CD ELSE CASE WHEN NVL(F.RETURN_ITEM_QTY,0) =  NVL(B.ITEM_QTY,0) THEN '08' ELSE A.ORD_STAT_CD END END  ORD_STAT_CD
                           ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                      FROM DMSDB.PT_0521T A    --부품판매헤더정보
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                   FROM   DMSDB.PT_0522T A
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T C
                               ON A.SALE_PRSN_ID = C.USR_ID
                              --AND C.ENABLED_YN = 'Y'
                              --AND C.DEL_YN     = 'N'
                             LEFT OUTER JOIN CM_0801T D
                               ON A.SA_ID  = D.USR_ID
                              --AND D.ENABLED_YN = 'Y'
                             -- AND D.DEL_YN     = 'N'
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO
                                           ,MAX(A.ORD_DT) AS RETURN_DT
                                           ,MAX(A.REG_USR_ID) AS RETURN_ID
                                           ,SUM(A.DC_BEF_TOT_AMT) AS RETURN_DC_BEF_TOT_AMT
                                           ,SUM(A.DC_AMT) AS RETURN_DC_AMT
                                           ,SUM(A.TOT_AMT) AS RETURN_TOT_AMT
                                     FROM   DMSDB.PT_0521T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) E    --반품판매정보
                               ON A.DLR_CD               = E.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) F    --반품판매정보
                               ON A.DLR_CD               = F.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = F.RETURN_DOC_NO
                            LEFT OUTER JOIN SE_0500T G  --정산테이블
                               ON A.DLR_CD       = G.DLR_CD
                              AND A.CALC_DOC_NO  = G.CALC_DOC_NO
                              AND G.CALC_CANC_YN = 'N'
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) H
                               ON G.DLR_CD    = H.DLR_CD
                              AND G.ETC_DC_CD = H.PUBLI_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       --AND A.ORD_STAT_CD != '07'
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%'
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND G.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND G.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND A.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND A.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND D.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND A.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND C.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND A.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND B.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND B.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND B.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND A.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                     ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "parSaleOrdNo"'> A.PAR_SALE_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordStatCd"'> A.ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordDt"'> A.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custTp"'> A.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custNm"'> A.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saNm"'> C.USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saleTp"'> A.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <otherwise>
                                       A.DLR_CD ASC
                                      ,A.PAR_SALE_ORD_NO DESC
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                           A.DLR_CD ASC
                          ,A.PAR_SALE_ORD_NO DESC
                         </otherwise>
                     </choose>
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 리스트정보를 조회한다. -->
    <select id="selectPartsSaleOrdListCnt" parameterType="PartsSaleOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdListCnt] */
             SELECT COUNT(*)
             FROM
                 (
                     SELECT A.DLR_CD                    --딜러코드
                           --,A.ORD_STAT_CD               --오더상태코드
                           ,A.ORD_DT                    --오더일자
                           ,A.SALE_TP                   --판매유형
                           ,A.CUST_TP                   --고객유형
                           ,A.CUST_CD                   --고객코드
                           ,A.CUST_NM                   --고객명
                           ,A.CUST_TEL_NO               --고객전화번호
                           ,A.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,A.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,C.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,A.SA_ID                     --SAID
                           ,D.USR_NM AS SA_NM
                           ,A.REMARK                    --비고
                           --,A.DC_RATE                   --할인율
                           ,CASE WHEN ((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0)))) = 0
                                   THEN 0
                                 ELSE
                                   ROUND(((B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))/((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0))))) * 100,2)
                             END DC_RATE
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) * -1 ELSE (A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) END DC_BEF_TOT_AMT --할인전총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) * -1 ELSE (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) END DC_AMT
                           --,(A.DC_AMT - NVL(E.RETURN_DC_AMT, 0)) AS DC_AMT              --할인금액
                           --,(A.TOT_AMT - NVL(E.RETURN_TOT_AMT, 0)) AS TOT_AMT           --총금액
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.DC_BEF_TOT_AMT - NVL(E.RETURN_TOT_AMT,0) - (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))) * -1 ELSE (A.DC_BEF_TOT_AMT - NVL(E.RETURN_TOT_AMT,0) - (B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))) END TOT_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (A.VAT_AMT) * -1 ELSE A.VAT_AMT END VAT_AMT
                           ,A.CANC_REASON_CD            --취소사유코드
                           ,A.CANC_REASON_REMARK        --취소사유비고
                           ,A.REG_USR_ID                --등록자ID
                           ,A.REG_DT                    --등록일자
                           ,A.UPDT_USR_ID               --수정자ID
                           ,A.UPDT_DT                   --수정일자
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_CNT) * -1 ELSE B.ITEM_CNT END ITEM_CNT
                           --,(B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) AS ITEM_QTY
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_QTY) * -1 ELSE B.ITEM_QTY END ITEM_QTY
                           --,(B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) AS ITEM_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07' THEN (B.ITEM_AMT) * -1 ELSE B.ITEM_AMT END ITEM_AMT
                           --,B.ITEM_AMT
                           ,A.CALC_DOC_NO
                           ,E.RETURN_DT
                           ,E.RETURN_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                           ,F.RETURN_DOC_NO
                           ,F.RETURN_ITEM_CNT
                           ,F.RETURN_ITEM_QTY
                           ,F.RETURN_ITEM_AMT
                           ,G.CALC_DT
                           ,G.CALC_STAT_CD
                           ,G.PAR_BM_POINT_USE_AMT
                           ,G.POINT_TOT_AMT
                           ,G.PAR_ETC_DC_AMT
                           ,G.PAR_CALC_SUM_AMT
                           ,G.PAR_DC_RATE
                           ,G.PAR_DC_AMT
                           ,G.PAR_CALC_AMT
                           ,G.ETC_DC_CD
                           ,H.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(B.ITEM_QTY,0) = 0 THEN A.ORD_STAT_CD ELSE CASE WHEN NVL(F.RETURN_ITEM_QTY,0) =  NVL(B.ITEM_QTY,0) THEN '08' ELSE A.ORD_STAT_CD END END  ORD_STAT_CD
                           ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                           ,CASE WHEN A.ORD_STAT_CD = '07'
                                   THEN (B.MOVING_AVG_AMT) * -1
                                 ELSE (B.MOVING_AVG_AMT)
                             END MOVING_AVG_AMT
                           ,CASE WHEN A.ORD_STAT_CD = '07'
                                   THEN (NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                                 ELSE (NVL(B.MOVING_AVG_TAX_DDCT_AMT,0))
                             END MOVING_AVG_TAX_DDCT_AMT
                      FROM DMSDB.PT_0521T A    --부품판매헤더정보
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                         ,SUM(B.MOVING_AVG_AMT) MOVING_AVG_AMT
                                         ,SUM(NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) MOVING_AVG_TAX_DDCT_AMT
                                   FROM   DMSDB.PT_0522T A
                                          LEFT OUTER JOIN PT_0312T B
                                            ON A.DLR_CD               = B.DLR_CD
                                           AND A.PAR_SALE_ORD_NO      = B.REF_DOC_NO
                                           AND A.PAR_SALE_ORD_LINE_NO = B.REF_DOC_LINE_NO
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                    AND   A.GI_STAT_CD != '01'
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T C
                               ON A.SALE_PRSN_ID = C.USR_ID
                              --AND C.ENABLED_YN = 'Y'
                              --AND C.DEL_YN     = 'N'
                             LEFT OUTER JOIN CM_0801T D
                               ON A.SA_ID  = D.USR_ID
                              --AND D.ENABLED_YN = 'Y'
                             -- AND D.DEL_YN     = 'N'
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO
                                           ,MAX(A.ORD_DT) AS RETURN_DT
                                           ,MAX(A.REG_USR_ID) AS RETURN_ID
                                           ,SUM(A.DC_BEF_TOT_AMT) AS RETURN_DC_BEF_TOT_AMT
                                           ,SUM(A.DC_AMT) AS RETURN_DC_AMT
                                           ,SUM(A.TOT_AMT) AS RETURN_TOT_AMT
                                     FROM   DMSDB.PT_0521T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) E    --반품판매정보
                               ON A.DLR_CD               = E.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) F    --반품판매정보
                               ON A.DLR_CD               = F.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = F.RETURN_DOC_NO
                            LEFT OUTER JOIN SE_0500T G  --정산테이블
                               ON A.DLR_CD       = G.DLR_CD
                              AND A.CALC_DOC_NO  = G.CALC_DOC_NO
                              AND G.CALC_CANC_YN = 'N'
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) H
                               ON G.DLR_CD    = H.DLR_CD
                              AND G.ETC_DC_CD = H.PUBLI_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       --AND A.ORD_STAT_CD != '07'
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%'
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND G.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND G.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND A.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND A.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND D.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND A.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND C.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND A.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND B.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND B.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND B.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND A.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
    </select>

    <!-- 부품판매 리스트정보(팝업)를 조회한다. -->
    <select id="selectPartsSaleOrdPopListCnt" parameterType="PartsSaleOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdPopListCnt] */
             SELECT COUNT(*)
             FROM
                 (
                     SELECT A.DLR_CD                    --딜러코드
                           --,A.ORD_STAT_CD               --오더상태코드
                           ,A.ORD_DT                    --오더일자
                           ,A.SALE_TP                   --판매유형
                           ,A.CUST_TP                   --고객유형
                           ,A.CUST_CD                   --고객코드
                           ,A.CUST_NM                   --고객명
                           ,A.CUST_TEL_NO               --고객전화번호
                           ,A.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,A.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,C.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,A.SA_ID                     --SAID
                           ,D.USR_NM AS SA_NM
                           ,A.REMARK                    --비고
                           --,A.DC_RATE                   --할인율
                           ,CASE WHEN ((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0)))) = 0
                                   THEN 0
                                 ELSE
                                   ROUND(((B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0))/((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0))))) * 100,2)
                             END DC_RATE
                           ,(A.DC_BEF_TOT_AMT - NVL(E.RETURN_DC_BEF_TOT_AMT, 0)) AS DC_BEF_TOT_AMT --할인전총금액
                           ,(B.ITEM_DC_AMT - NVL(F.RETURN_ITEM_DC_AMT,0)) AS DC_AMT
                           --,(A.DC_AMT - NVL(E.RETURN_DC_AMT, 0)) AS DC_AMT              --할인금액
                           --,(A.TOT_AMT - NVL(E.RETURN_TOT_AMT, 0)) AS TOT_AMT           --총금액
                           ,((A.DC_BEF_TOT_AMT - B.ITEM_DC_AMT) - (NVL(E.RETURN_DC_BEF_TOT_AMT, 0) - (NVL(F.RETURN_ITEM_DC_AMT,0)))) AS TOT_AMT
                           ,A.VAT_AMT                   --부가세금액
                           ,A.CANC_REASON_CD            --취소사유코드
                           ,A.CANC_REASON_REMARK        --취소사유비고
                           ,A.REG_USR_ID                --등록자ID
                           ,A.REG_DT                    --등록일자
                           ,A.UPDT_USR_ID               --수정자ID
                           ,A.UPDT_DT                   --수정일자
                           ,B.ITEM_CNT
                           ,(B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) AS ITEM_QTY
                           ,(B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) AS ITEM_AMT
                           --,B.ITEM_AMT
                           ,A.CALC_DOC_NO
                           ,E.RETURN_DT
                           ,E.RETURN_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                           ,F.RETURN_DOC_NO
                           ,F.RETURN_ITEM_CNT
                           ,F.RETURN_ITEM_QTY
                           ,F.RETURN_ITEM_AMT
                           ,G.CALC_DT
                           ,G.CALC_STAT_CD
                           ,G.PAR_BM_POINT_USE_AMT
                           ,G.POINT_TOT_AMT
                           ,G.PAR_ETC_DC_AMT
                           ,G.PAR_CALC_SUM_AMT
                           ,G.PAR_DC_RATE
                           ,G.PAR_DC_AMT
                           ,G.PAR_CALC_AMT
                           ,G.ETC_DC_CD
                           ,H.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(F.RETURN_ITEM_QTY,0) =  NVL(B.ITEM_QTY,0) THEN '07' ELSE A.ORD_STAT_CD END ORD_STAT_CD
                           ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                      FROM DMSDB.PT_0521T A    --부품판매헤더정보
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                   FROM   DMSDB.PT_0522T A
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) B
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T C
                               ON A.SALE_PRSN_ID = C.USR_ID
                              --AND C.ENABLED_YN = 'Y'
                              --AND C.DEL_YN     = 'N'
                             LEFT OUTER JOIN CM_0801T D
                               ON A.SA_ID  = D.USR_ID
                              --AND D.ENABLED_YN = 'Y'
                             -- AND D.DEL_YN     = 'N'
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO
                                           ,MAX(A.ORD_DT) AS RETURN_DT
                                           ,MAX(A.REG_USR_ID) AS RETURN_ID
                                           ,SUM(A.DC_BEF_TOT_AMT) AS RETURN_DC_BEF_TOT_AMT
                                           ,SUM(A.DC_AMT) AS RETURN_DC_AMT
                                           ,SUM(A.TOT_AMT) AS RETURN_TOT_AMT
                                     FROM   DMSDB.PT_0521T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) E    --반품판매정보
                               ON A.DLR_CD               = E.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                             LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) F    --반품판매정보
                               ON A.DLR_CD               = F.DLR_CD
                              AND A.PAR_SALE_ORD_NO      = F.RETURN_DOC_NO
                            LEFT OUTER JOIN SE_0500T G  --정산테이블
                               ON A.DLR_CD       = G.DLR_CD
                              AND A.CALC_DOC_NO  = G.CALC_DOC_NO
                              AND G.CALC_CANC_YN = 'N'
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) H
                               ON G.DLR_CD    = H.DLR_CD
                              AND G.ETC_DC_CD = H.PUBLI_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       --AND A.ORD_STAT_CD != '07'
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%'
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND G.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND G.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND A.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND A.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND D.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND A.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND C.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND A.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND B.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND B.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND B.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (B.ITEM_QTY - NVL(F.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (B.ITEM_AMT - NVL(F.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND A.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
    </select>

    <!-- 부품판매 리스트정보(정산위주)를 조회한다. -->
    <select id="selectPartsSaleOrdForCalcList" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdForCalcList] */
      SELECT    A.*
        FROM
             (
          SELECT    ROWNUM AS RNUM
                   ,T1.*
            FROM
                 (
                     SELECT B.DLR_CD                    --딜러코드
                           ,B.ORD_DT                    --오더일자
                           ,B.SALE_TP                   --판매유형
                           ,B.CUST_TP                   --고객유형
                           ,B.CUST_CD                   --고객코드
                           ,B.CUST_NM                   --고객명
                           ,B.CUST_TEL_NO               --고객전화번호
                           ,B.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,B.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,D.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,B.SA_ID                     --SAID
                           ,E.USR_NM AS SA_NM
                           ,B.REMARK                    --비고
                           ,CASE WHEN (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) = 0
                                   THEN 0
                                 ELSE
                                   ROUND((C.ITEM_DC_AMT/(B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT)) * 100,2)
                             END DC_RATE
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN B.DC_BEF_TOT_AMT * -1 ELSE B.DC_BEF_TOT_AMT END DC_BEF_TOT_AMT --할인전총금액
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN C.ITEM_DC_AMT * -1 ELSE C.ITEM_DC_AMT END DC_AMT
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) * -1 ELSE (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) END TOT_AMT
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (B.VAT_AMT) * -1 ELSE B.VAT_AMT END VAT_AMT
                           ,B.CANC_REASON_CD            --취소사유코드
                           ,B.CANC_REASON_REMARK        --취소사유비고
                           ,B.REG_USR_ID                --등록자ID
                           ,B.REG_DT                    --등록일자
                           ,B.UPDT_USR_ID               --수정자ID
                           ,B.UPDT_DT                   --수정일자
                           ,CASE WHEN A.CALC_STAT_CD = '07' THEN (C.ITEM_CNT) * -1 ELSE C.ITEM_CNT END ITEM_CNT
                           ,CASE WHEN A.CALC_STAT_CD = '07' THEN (C.ITEM_QTY) * -1 ELSE C.ITEM_QTY END ITEM_QTY
                           ,CASE WHEN A.CALC_STAT_CD = '07' THEN (C.ITEM_AMT) * -1 ELSE C.ITEM_AMT END ITEM_AMT
                           ,A.CALC_DOC_NO
                           ,A.REG_DT AS CALC_DT
                           ,A.CALC_DT AS CALC_END_DT
                           ,A.CALC_STAT_CD
                           ,A.PAR_BM_POINT_USE_AMT
                           ,A.POINT_TOT_AMT
                           ,A.PAR_ETC_DC_AMT
                           ,CASE WHEN A.CALC_STAT_CD = '07' THEN (A.PAR_CALC_SUM_AMT) * -1 ELSE A.PAR_CALC_SUM_AMT END PAR_CALC_SUM_AMT
                           ,A.PAR_DC_RATE
                           ,A.PAR_DC_AMT
                           ,A.PAR_CALC_AMT
                           ,A.ETC_DC_CD
                           ,A.REG_USR_ID AS CALC_USR_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID) AS CALC_USR_NM   --등록자명
                           ,A.CALC_CANC_DT
                           ,A.CALC_CANC_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CALC_CANC_ID) AS CALC_CANC_NM   --등록자명
                           ,A.CALC_CANC_YN
                           ,A.CALC_COMP_USR_ID
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.calc_comp_usr_id) AS CALC_COMP_USR_NM   --등록자명
                           ,F.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(C.ITEM_QTY,0) = 0 THEN B.ORD_STAT_CD ELSE CASE WHEN NVL(G.RETURN_ITEM_QTY,0) =  NVL(C.ITEM_QTY,0) THEN '08' ELSE B.ORD_STAT_CD END END  ORD_STAT_CD
                           ,TO_CHAR(NVL(B.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                           ,CASE WHEN A.CALC_STAT_CD = '07' THEN NVL(H.PAYM_AMT,0) * -1 ELSE NVL(H.PAYM_AMT,0) END PAYM_AMT
                           ,CASE WHEN A.CALC_STAT_CD = '07'
                                   THEN (C.MOVING_AVG_AMT) * -1
                                 ELSE (C.MOVING_AVG_AMT)
                             END MOVING_AVG_AMT
                           ,CASE WHEN A.CALC_STAT_CD = '07'
                                   THEN (NVL(C.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                                 ELSE (NVL(C.MOVING_AVG_TAX_DDCT_AMT,0))
                             END MOVING_AVG_TAX_DDCT_AMT
                      FROM  SE_0500T A  --정산테이블
                             INNER JOIN DMSDB.PT_0521T B    --부품판매헤더정보
                                ON A.DLR_CD       = B.DLR_CD
                               AND A.ro_doc_no    = B.par_sale_ord_no
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                         ,SUM(B.MOVING_AVG_AMT) MOVING_AVG_AMT
                                         ,SUM(NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) MOVING_AVG_TAX_DDCT_AMT
                                   FROM   DMSDB.PT_0522T A
                                          LEFT OUTER JOIN PT_0312T B
                                            ON A.DLR_CD               = B.DLR_CD
                                           AND A.PAR_SALE_ORD_NO      = B.REF_DOC_NO
                                           AND A.PAR_SALE_ORD_LINE_NO = B.REF_DOC_LINE_NO
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                    AND   A.GI_STAT_CD != '01'
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                    AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) C
                               ON B.DLR_CD          = C.DLR_CD
                              AND B.PAR_SALE_ORD_NO = C.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T D
                               ON B.SALE_PRSN_ID = D.USR_ID
                             LEFT OUTER JOIN CM_0801T E
                               ON B.SA_ID  = E.USR_ID
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) F
                               ON A.DLR_CD    = F.DLR_CD
                              AND A.ETC_DC_CD = F.PUBLI_NO
                            LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) G    --반품판매정보
                               ON B.DLR_CD               = G.DLR_CD
                              AND B.PAR_SALE_ORD_NO      = G.RETURN_DOC_NO
                            LEFT OUTER JOIN SE_0530T H
                              ON A.DLR_CD         = H.DLR_CD
                             AND A.CALC_DOC_NO    = H.CALC_DOC_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND B.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND ((A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%') or (B.PAR_SALE_ORD_NO LIKE '%'|| #{sCalcDocNo} ||'%'))
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND B.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND B.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND A.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND A.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND B.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND B.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND B.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND B.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND E.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND B.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND D.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND B.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND B.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND C.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND C.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND C.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND B.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                     ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "calcDocNo"'> A.CALC_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "parSaleOrdNo"'> B.PAR_SALE_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordStatCd"'> B.ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "ordDt"'> B.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custTp"'> B.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "custNm"'> B.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saNm"'> D.USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <when test='item.field == "saleTp"'> B.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                     <otherwise>
                                       A.DLR_CD ASC
                                      ,B.PAR_SALE_ORD_NO DESC
                                      ,A.CALC_DOC_NO DESC
                                      ,A.CALC_STAT_CD DESC
                                      ,A.REG_DT
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                           A.DLR_CD ASC
                          ,B.PAR_SALE_ORD_NO DESC
                          ,A.CALC_DOC_NO DESC
                          ,A.CALC_STAT_CD DESC
                          ,A.REG_DT
                         </otherwise>
                     </choose>
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 리스트정보(정산정보)를 조회한다. -->
    <select id="selectPartsSaleOrdForCalcListCnt" parameterType="PartsSaleOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdForCalcListCnt] */
             SELECT COUNT(*)
             FROM
                 (
                     SELECT B.DLR_CD                    --딜러코드
                           ,B.ORD_DT                    --오더일자
                           ,B.SALE_TP                   --판매유형
                           ,B.CUST_TP                   --고객유형
                           ,B.CUST_CD                   --고객코드
                           ,B.CUST_NM                   --고객명
                           ,B.CUST_TEL_NO               --고객전화번호
                           ,B.PAR_SALE_ORD_NO           --부품판매오더번호
                           ,B.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,D.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,B.SA_ID                     --SAID
                           ,E.USR_NM AS SA_NM
                           ,B.REMARK                    --비고
                           ,CASE WHEN (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) = 0
                                   THEN 0
                                 ELSE
                                   ROUND((C.ITEM_DC_AMT/(B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT)) * 100,2)
                             END DC_RATE
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN B.DC_BEF_TOT_AMT * -1 ELSE B.DC_BEF_TOT_AMT END DC_BEF_TOT_AMT --할인전총금액
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN C.ITEM_DC_AMT * -1 ELSE C.ITEM_DC_AMT END DC_AMT
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) * -1 ELSE (B.DC_BEF_TOT_AMT - C.ITEM_DC_AMT) END TOT_AMT
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (B.VAT_AMT) * -1 ELSE B.VAT_AMT END VAT_AMT
                           ,B.CANC_REASON_CD            --취소사유코드
                           ,B.CANC_REASON_REMARK        --취소사유비고
                           ,B.REG_USR_ID                --등록자ID
                           ,B.REG_DT                    --등록일자
                           ,B.UPDT_USR_ID               --수정자ID
                           ,B.UPDT_DT                   --수정일자
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (C.ITEM_CNT) * -1 ELSE C.ITEM_CNT END ITEM_CNT
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (C.ITEM_QTY) * -1 ELSE C.ITEM_QTY END ITEM_QTY
                           ,CASE WHEN B.ORD_STAT_CD = '07' THEN (C.ITEM_AMT) * -1 ELSE C.ITEM_AMT END ITEM_AMT
                           ,B.CALC_DOC_NO
                           ,A.CALC_DT
                           ,A.CALC_STAT_CD
                           ,A.PAR_BM_POINT_USE_AMT
                           ,A.POINT_TOT_AMT
                           ,A.PAR_ETC_DC_AMT
                           ,A.PAR_CALC_SUM_AMT
                           ,A.PAR_DC_RATE
                           ,A.PAR_DC_AMT
                           ,A.PAR_CALC_AMT
                           ,A.ETC_DC_CD
                           ,A.Calc_canc_dt
                           ,A.calc_canc_id
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.calc_canc_id) AS calc_canc_NM   --등록자명
                           ,A.calc_canc_yn
                           ,A.calc_comp_usr_id
                           ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.calc_comp_usr_id) AS calc_comp_usr_NM   --등록자명
                           ,F.DC_TP AS ETC_DC_TP
                           ,CASE WHEN NVL(C.ITEM_QTY,0) = 0 THEN B.ORD_STAT_CD ELSE CASE WHEN NVL(G.RETURN_ITEM_QTY,0) =  NVL(C.ITEM_QTY,0) THEN '08' ELSE B.ORD_STAT_CD END END  ORD_STAT_CD
                           ,TO_CHAR(NVL(B.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                           ,CASE WHEN A.CALC_STAT_CD = '07'
                                   THEN (C.MOVING_AVG_AMT) * -1
                                 ELSE (C.MOVING_AVG_AMT)
                             END MOVING_AVG_AMT
                           ,CASE WHEN A.CALC_STAT_CD = '07'
                                   THEN (NVL(C.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                                 ELSE (NVL(C.MOVING_AVG_TAX_DDCT_AMT,0))
                             END MOVING_AVG_TAX_DDCT_AMT
                      FROM  SE_0500T A  --정산테이블
                             INNER JOIN DMSDB.PT_0521T B    --부품판매헤더정보
                                ON A.DLR_CD       = B.DLR_CD
                               AND A.ro_doc_no    = B.par_sale_ord_no
                             INNER JOIN (
                                 SELECT   A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                         ,COUNT(*) AS ITEM_CNT
                                         ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS ITEM_QTY
                                         ,SUM(NVL(A.AMT,0)) AS ITEM_AMT
                                         ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS ITEM_DC_AMT
                                         ,SUM(B.MOVING_AVG_AMT) MOVING_AVG_AMT
                                         ,SUM(NVL(B.MOVING_AVG_TAX_DDCT_AMT,0)) MOVING_AVG_TAX_DDCT_AMT
                                   FROM   DMSDB.PT_0522T A
                                          LEFT OUTER JOIN PT_0312T B
                                            ON A.DLR_CD               = B.DLR_CD
                                           AND A.PAR_SALE_ORD_NO      = B.REF_DOC_NO
                                           AND A.PAR_SALE_ORD_LINE_NO = B.REF_DOC_LINE_NO
                                  WHERE   A.DLR_CD = #{sDlrCd}  --딜러코드
                                    AND   A.GI_STAT_CD != '01'
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                    AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                 GROUP BY A.DLR_CD
                                         ,A.PAR_SALE_ORD_NO
                                  ) C
                               ON B.DLR_CD          = C.DLR_CD
                              AND B.PAR_SALE_ORD_NO = C.PAR_SALE_ORD_NO
                             LEFT OUTER JOIN CM_0801T D
                               ON B.SALE_PRSN_ID = D.USR_ID
                             LEFT OUTER JOIN CM_0801T E
                               ON B.SA_ID  = E.USR_ID
                            LEFT OUTER JOIN ( SELECT T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01') AS DC_TP, T2.PUBLI_NO
                                                FROM CR_0823T T1
                                                     INNER JOIN CR_0825T T2
                                                        ON T1.DLR_CD = T2.DLR_CD
                                                       AND T1.CUPN_SEQ = T2.CUPN_SEQ
                                               GROUP BY T1.DLR_CD, DECODE(T1.DC_CD, '01', '02', '01'), T2.PUBLI_NO
                                                ) F
                               ON A.DLR_CD    = F.DLR_CD
                              AND A.ETC_DC_CD = F.PUBLI_NO
                            LEFT OUTER JOIN  (
                                   SELECT   A.DLR_CD
                                           ,A.REF_DOC_NO AS RETURN_DOC_NO
                                           ,COUNT(*) AS RETURN_ITEM_CNT
                                           ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                           ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                           ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                     FROM   DMSDB.PT_0522T A
                                    WHERE   A.DLR_CD = #{sDlrCd}
                                    <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                        AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                    </if>        --부품판매오더번호
                                    GROUP BY  A.DLR_CD
                                             ,A.REF_DOC_NO
                             ) G    --반품판매정보
                               ON B.DLR_CD               = G.DLR_CD
                              AND B.PAR_SALE_ORD_NO      = G.RETURN_DOC_NO
                     WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND B.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                           AND ((A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo} ||'%') or (B.PAR_SALE_ORD_NO LIKE '%'|| #{sCalcDocNo} ||'%'))
                       </if>        --정산서번호
                       <if test='sOrdDtFr != null'>
                           AND B.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                           AND B.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND A.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND A.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND B.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND B.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND B.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND B.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND E.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND B.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND D.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                           AND B.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND B.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND C.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND C.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND C.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (C.ITEM_QTY - NVL(G.RETURN_ITEM_QTY, 0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                       <if test='sItemAmt != null and sItemAmt != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmt}
                       </if>        --판매금액
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (C.ITEM_AMT - NVL(G.RETURN_ITEM_AMT, 0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND B.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                 ) T1
                 WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
    </select>

    <!-- 부품판매 명세 정보를 조회한다. -->
    <select id="selectPartsSaleOrdItemByCondition" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemByCondition] */
        SELECT    A.*
          FROM
              (
              SELECT    ROWNUM AS RNUM
                       ,T1.*
                FROM
                     (SELECT
                        A.DLR_CD                      --딜러코드
                       ,A.PAR_SALE_ORD_NO             --부품판매오더번호
                       ,A.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                       ,A.CALC_TP_CD                  --정산유형코드
                       ,A.ITEM_CD                     --품목코드
                       ,B.ITEM_NM
                       ,B.ITEM_DSTIN_CD
                       ,A.EQIP_EXPC_DT                --설치예정일자
                       ,A.DC_RATE                     --할인율
                       ,A.PRC                         --단가
                       --,A.AMT                         --금액
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.AMT) * -1
                             ELSE (A.AMT)
                         END AMT
                       --,(NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS PART_COST
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN ((NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END)) * -1
                             ELSE (NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END)
                         END PART_COST
                       --,A.AMT - NVL(E.RETURN_TOT_AMT,0) AS TOT_AMT
                       --,A.AMT AS TOT_AMT
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.AMT) * -1
                             ELSE A.AMT
                         END TOT_AMT
                       ,A.UNIT_CD                     --단위코드
                       --,A.ORD_QTY                     --오더수량
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.ORD_QTY) * -1
                             ELSE A.ORD_QTY
                         END ORD_QTY
                       --,A.END_QTY                     --종료수량
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.END_QTY) * -1
                             ELSE A.END_QTY
                         END END_QTY
                       ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                       ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                       ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                       ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                       ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                       ,NVL(C.RENT_QTY,0) AS RENT_QTY
                       ,A.GI_STRGE_CD
                       ,D.SALE_TP
                       ,A.GI_LOC_CD
                       --,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2)  END DC_AMT
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) * -1
                             ELSE (CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END)
                         END DC_AMT
                       --,A.TAX_AMT
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.TAX_AMT) * -1
                             ELSE (A.TAX_AMT)
                         END TAX_AMT
                       --,A.TAX_DDCT_AMT
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (A.TAX_DDCT_AMT) * -1
                             ELSE (A.TAX_DDCT_AMT)
                         END TAX_DDCT_AMT
                       ,D.SALE_PRSN_ID
                       ,G.USR_NM AS SALE_PRSN_NM
                       ,A.GI_DT
                       ,TO_CHAR(A.GI_DT, 'HH24:MI:SS') AS GI_TIME
                       ,A.CANC_DT
                       ,TO_CHAR(A.CANC_DT, 'HH24:MI:SS') AS CANC_TIME
                       ,A.CANC_ID
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CANC_ID) AS CANC_NM
                       ,A.CANC_QTY
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN NULL
                             ELSE E.RETURN_DT
                         END RETURN_DT
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN ''
                             ELSE TO_CHAR(E.RETURN_DT, 'HH24:MI:SS')
                         END  RETURN_TIME
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN ''
                             ELSE E.RETURN_ID
                         END RETURN_ID
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN ''
                             ELSE (SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID)
                         END RETURN_NM
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN 0
                             ELSE NVL(E.RETURN_QTY,0)
                         END RETURN_QTY
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN 0
                             ELSE NVL(E.RETURN_TOT_AMT,0)
                         END RETURN_TOT_AMT
                       ,CASE WHEN NVL(E.RETURN_QTY,0) <![CDATA[>]]> 0 THEN '07' ELSE A.GI_STAT_CD END GI_STAT_CD
                       ,D.SA_ID
                       ,H.USR_NM AS SA_NM
                       ,A.PKG_ITEM_CD
                       ,D.ORD_STAT_CD
                       ,K.MOVING_AVG_PRC
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (K.MOVING_AVG_AMT) * -1
                             ELSE (K.MOVING_AVG_AMT)
                         END MOVING_AVG_AMT
                       ,NVL(K.MOVING_AVG_TAX_DDCT_PRC,0) AS MOVING_AVG_TAX_DDCT_PRC
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (NVL(K.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                             ELSE (NVL(K.MOVING_AVG_TAX_DDCT_AMT,0))
                         END MOVING_AVG_TAX_DDCT_AMT
                   FROM DMSDB.PT_0522T A    --부품판매품목정보
                        INNER JOIN  DMSDB.PT_0521T D
                           ON A.DLR_CD          = D.DLR_CD
                          AND A.PAR_SALE_ORD_NO = D.PAR_SALE_ORD_NO
                        INNER JOIN  DMSDB.PT_0201T B    --품목정보
                           ON A.DLR_CD  = B.DLR_CD
                          AND A.ITEM_CD = B.ITEM_CD
                        LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                           ON A.DLR_CD      = C.DLR_CD
                          AND B.GI_STRGE_CD = C.STRGE_CD
                          AND A.ITEM_CD     = C.ITEM_CD
                         LEFT OUTER JOIN  (
                               SELECT   A.DLR_CD
                                       ,A.REF_DOC_NO
                                       ,A.REF_DOC_LINE_NO
                                       ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_QTY
                                       ,SUM(A.AMT) AS RETURN_TOT_AMT
                                       ,MAX(B.ORD_DT) AS RETURN_DT
                                       ,MAX(B.SALE_PRSN_ID) AS RETURN_ID
                                 FROM   DMSDB.PT_0522T A
                                        INNER JOIN  DMSDB.PT_0521T B
                                           ON A.DLR_CD          = B.DLR_CD
                                          AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                                WHERE   A.DLR_CD = #{sDlrCd}
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                GROUP BY  A.DLR_CD
                                         ,A.REF_DOC_NO
                                         ,A.REF_DOC_LINE_NO
                         ) E    --반품판매품목정보
                           ON A.DLR_CD               = E.DLR_CD
                          AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                          AND A.PAR_SALE_ORD_LINE_NO = E.REF_DOC_LINE_NO
                         LEFT OUTER JOIN  (
                               SELECT   A.DLR_CD
                                       ,A.REF_DOC_NO AS RETURN_DOC_NO
                                       ,COUNT(*) AS RETURN_ITEM_CNT
                                       ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                       ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                       ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                 FROM   DMSDB.PT_0522T A
                                WHERE   A.DLR_CD = #{sDlrCd}
                                <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                    AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                </if>        --부품판매오더번호
                                GROUP BY  A.DLR_CD
                                         ,A.REF_DOC_NO
                         ) J    --반품판매정보
                           ON A.DLR_CD               = J.DLR_CD
                          AND A.PAR_SALE_ORD_NO      = J.RETURN_DOC_NO
                         LEFT OUTER JOIN SE_0500T F  --정산테이블
                           ON D.DLR_CD      = F.DLR_CD
                          AND D.CALC_DOC_NO = F.CALC_DOC_NO
                          AND F.CALC_CANC_YN = 'N'
                         LEFT OUTER JOIN CM_0801T G
                           ON D.SALE_PRSN_ID = G.USR_ID
                         LEFT OUTER JOIN CM_0801T H
                           ON D.SA_ID  = H.USR_ID
                         INNER JOIN (
                             SELECT   DLR_CD
                                     ,PAR_SALE_ORD_NO
                                     ,COUNT(*) AS ITEM_CNT
                                     ,SUM(NVL(END_QTY,ORD_QTY)) AS ITEM_QTY
                                     ,SUM(NVL(AMT,0)) AS ITEM_AMT
                               FROM   DMSDB.PT_0522T
                              WHERE   DLR_CD = #{sDlrCd}  --딜러코드
                              <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                  AND PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                              </if>        --부품판매오더번호
                             GROUP BY DLR_CD
                                     ,PAR_SALE_ORD_NO
                              ) P
                         ON A.DLR_CD          = P.DLR_CD
                        AND A.PAR_SALE_ORD_NO = P.PAR_SALE_ORD_NO
                      LEFT OUTER JOIN PT_0312T K
                         ON A.DLR_CD               = K.DLR_CD
                        AND A.PAR_SALE_ORD_NO      = K.REF_DOC_NO
                        AND A.PAR_SALE_ORD_LINE_NO = K.REF_DOC_LINE_NO
                  WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                    --AND D.ORD_STAT_CD != '07'
                    AND A.GI_STAT_CD != '01'
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sOrdDtFr != null'>
                            AND D.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                            AND D.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND F.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND F.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND D.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND D.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND D.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                           AND D.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                           AND H.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND D.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND G.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND D.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND D.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (D.TOT_AMT - NVL(E.RETURN_TOT_AMT,0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (D.TOT_AMT - NVL(E.RETURN_TOT_AMT,0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND P.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND P.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND P.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                     ORDER BY A.DLR_CD                      --딜러코드
                             ,A.PAR_SALE_ORD_NO DESC        --부품판매오더번호
                             ,A.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                   ) T1
                   WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 명세 정보를 Count한다. -->
    <select id="selectPartsSaleOrdItemByConditionCnt" parameterType="PartsSaleOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemByConditionCnt] */
         SELECT count(*)
          FROM
              (
              SELECT
                        A.DLR_CD                      --딜러코드
                       ,A.PAR_SALE_ORD_NO             --부품판매오더번호
                       ,A.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                       ,A.CALC_TP_CD                  --정산유형코드
                       ,A.ITEM_CD                     --품목코드
                       ,B.ITEM_NM
                       ,B.ITEM_DSTIN_CD
                       ,A.EQIP_EXPC_DT                --설치예정일자
                       ,A.DC_RATE                     --할인율
                       ,A.PRC                         --단가
                       ,A.AMT                         --금액
                       ,(NVL(A.AMT, 0) + CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS PART_COST
                       ,A.UNIT_CD                     --단위코드
                       ,A.ORD_QTY                     --오더수량
                       ,A.END_QTY                     --종료수량
                       ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                       ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                       ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                       ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                       ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                       ,NVL(C.RENT_QTY,0) AS RENT_QTY
                       ,A.GI_STRGE_CD
                       ,D.SALE_TP
                       ,A.GI_LOC_CD
                       ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2)  END DC_AMT
                       ,A.TAX_AMT
                       ,A.TAX_DDCT_AMT
                       ,D.SALE_PRSN_ID
                       ,G.USR_NM AS SALE_PRSN_NM
                       ,A.GI_DT
                       ,TO_CHAR(A.GI_DT, 'HH24:MI:SS') AS GI_TIME
                       ,A.CANC_DT
                       ,TO_CHAR(A.CANC_DT, 'HH24:MI:SS') AS CANC_TIME
                       ,A.CANC_ID
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CANC_ID) AS CANC_NM
                       ,A.CANC_QTY
                       ,E.RETURN_DT
                       ,TO_CHAR(E.RETURN_DT, 'HH24:MI:SS') AS RETURN_TIME
                       ,E.RETURN_ID
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = E.RETURN_ID) AS RETURN_NM
                       ,E.RETURN_QTY
                       ,CASE WHEN NVL(E.RETURN_QTY,0) <![CDATA[>]]> 0 THEN '07' ELSE A.GI_STAT_CD END GI_STAT_CD
                       ,D.SA_ID
                       ,H.USR_NM AS SA_NM
                       ,A.PKG_ITEM_CD
                       ,D.ORD_STAT_CD
                       ,K.MOVING_AVG_PRC
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (K.MOVING_AVG_AMT) * -1
                             ELSE (K.MOVING_AVG_AMT)
                         END MOVING_AVG_AMT
                       ,NVL(K.MOVING_AVG_TAX_DDCT_PRC,0) AS MOVING_AVG_TAX_DDCT_PRC
                       ,CASE WHEN D.ORD_STAT_CD = '07'
                               THEN (NVL(K.MOVING_AVG_TAX_DDCT_AMT,0)) * -1
                             ELSE (NVL(K.MOVING_AVG_TAX_DDCT_AMT,0))
                         END MOVING_AVG_TAX_DDCT_AMT
                   FROM DMSDB.PT_0522T A    --부품판매품목정보
                        INNER JOIN  DMSDB.PT_0521T D
                           ON A.DLR_CD          = D.DLR_CD
                          AND A.PAR_SALE_ORD_NO = D.PAR_SALE_ORD_NO
                        INNER JOIN  DMSDB.PT_0201T B    --품목정보
                           ON A.DLR_CD  = B.DLR_CD
                          AND A.ITEM_CD = B.ITEM_CD
                        LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                           ON A.DLR_CD      = C.DLR_CD
                          AND B.GI_STRGE_CD = C.STRGE_CD
                          AND A.ITEM_CD     = C.ITEM_CD
                         LEFT OUTER JOIN  (
                               SELECT   A.DLR_CD
                                       ,A.REF_DOC_NO
                                       ,A.REF_DOC_LINE_NO
                                       ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_QTY
                                       ,SUM(A.AMT) AS RETURN_TOT_AMT
                                       ,MAX(B.ORD_DT) AS RETURN_DT
                                       ,MAX(B.SALE_PRSN_ID) AS RETURN_ID
                                 FROM   DMSDB.PT_0522T A
                                        INNER JOIN  DMSDB.PT_0521T B
                                           ON A.DLR_CD          = B.DLR_CD
                                          AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                                WHERE   A.DLR_CD = #{sDlrCd}
                                  <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                      AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                  </if>        --부품판매오더번호
                                GROUP BY  A.DLR_CD
                                         ,A.REF_DOC_NO
                                         ,A.REF_DOC_LINE_NO
                         ) E    --반품판매품목정보
                           ON A.DLR_CD               = E.DLR_CD
                          AND A.PAR_SALE_ORD_NO      = E.REF_DOC_NO
                          AND A.PAR_SALE_ORD_LINE_NO = E.REF_DOC_LINE_NO
                          LEFT OUTER JOIN  (
                               SELECT   A.DLR_CD
                                       ,A.REF_DOC_NO AS RETURN_DOC_NO
                                       ,COUNT(*) AS RETURN_ITEM_CNT
                                       ,SUM(NVL(A.END_QTY,A.ORD_QTY)) AS RETURN_ITEM_QTY
                                       ,SUM(NVL(A.AMT,0)) AS RETURN_ITEM_AMT
                                       ,SUM(CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ORD_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END) AS RETURN_ITEM_DC_AMT
                                 FROM   DMSDB.PT_0522T A
                                WHERE   A.DLR_CD = #{sDlrCd}
                                <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                    AND A.REF_DOC_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                                </if>        --부품판매오더번호
                                GROUP BY  A.DLR_CD
                                         ,A.REF_DOC_NO
                         ) J    --반품판매정보
                           ON A.DLR_CD               = J.DLR_CD
                          AND A.PAR_SALE_ORD_NO      = J.RETURN_DOC_NO
                         LEFT OUTER JOIN SE_0500T F  --정산테이블
                           ON D.DLR_CD      = F.DLR_CD
                          AND D.CALC_DOC_NO = F.CALC_DOC_NO
                          AND F.CALC_CANC_YN = 'N'
                         LEFT OUTER JOIN CM_0801T G
                           ON D.SALE_PRSN_ID = G.USR_ID
                         LEFT OUTER JOIN CM_0801T H
                           ON D.SA_ID  = H.USR_ID
                         INNER JOIN (
                             SELECT   DLR_CD
                                     ,PAR_SALE_ORD_NO
                                     ,COUNT(*) AS ITEM_CNT
                                     ,SUM(NVL(END_QTY,ORD_QTY)) AS ITEM_QTY
                                     ,SUM(NVL(AMT,0)) AS ITEM_AMT
                               FROM   DMSDB.PT_0522T
                              WHERE   DLR_CD = #{sDlrCd}  --딜러코드
                              <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                                  AND PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                              </if>        --부품판매오더번호
                             GROUP BY DLR_CD
                                     ,PAR_SALE_ORD_NO
                              ) P
                        ON A.DLR_CD          = P.DLR_CD
                        AND A.PAR_SALE_ORD_NO = P.PAR_SALE_ORD_NO
                        LEFT OUTER JOIN PT_0312T K
                          ON A.DLR_CD               = K.DLR_CD
                         AND A.PAR_SALE_ORD_NO      = K.REF_DOC_NO
                         AND A.PAR_SALE_ORD_LINE_NO = K.REF_DOC_LINE_NO
                  WHERE A.DLR_CD             = #{sDlrCd}  --딜러코드
                    --AND D.ORD_STAT_CD != '07'
                    AND A.GI_STAT_CD != '01'
                       <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND D.ORD_STAT_CD IN
                           <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                           </foreach>
                       </if>        --판매오더상태코드
                       <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                           AND A.PAR_SALE_ORD_NO LIKE '%'|| #{sParSaleOrdNo} ||'%'
                       </if>        --부품판매오더번호
                       <if test='sOrdDtFr != null'>
                            AND D.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                       </if>
                       <if test='sOrdDtTo != null'>
                            AND D.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                       </if>
                       <if test='sCalcDtFr != null'>
                           AND F.CALC_DT <![CDATA[>=]]> #{sCalcDtFr}
                       </if>
                       <if test='sCalcDtTo != null'>
                           AND F.CALC_DT <![CDATA[<=]]> #{sCalcDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                           AND D.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustCd != null and sCustCd != ""'>
                           AND D.CUST_CD = #{sCustCd}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                           AND D.CUST_NM LIKE '%'|| #{sCustNm} ||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                           AND D.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                           AND H.USR_NM LIKE '%'|| #{sSaNm} ||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                           AND D.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                           AND G.USR_NM LIKE '%'|| #{sSalePrsnNm} ||'%'
                       </if>
                       <if test='sSaleTp != null and sSaleTp != ""'>
                           AND D.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sCustTelNo != null and sCustTelNo != ""'>
                           AND D.CUST_TEL_NO like  '%'|| #{sCustTelNo} ||'%'
                       </if>        --고객폰번호
                       <if test='sItemAmtFr != null and sItemAmtFr != ""'>
                           AND (D.TOT_AMT - NVL(E.RETURN_TOT_AMT,0)) <![CDATA[>=]]> #{sItemAmtFr}
                       </if>        --판매금액
                       <if test='sItemAmtTo != null and sItemAmtTo != ""'>
                           AND (D.TOT_AMT - NVL(E.RETURN_TOT_AMT,0)) <![CDATA[<=]]> #{sItemAmtTo}
                       </if>        --판매금액
                       <if test='sItemCnt != null and sItemCnt != ""'>
                           AND P.ITEM_CNT = #{sItemCnt}
                       </if>        --판매건수
                       <if test='sItemCntFr != null and sItemCntFr != ""'>
                           AND P.ITEM_CNT <![CDATA[>=]]> #{sItemCntFr}
                       </if>        --판매건수
                       <if test='sItemCntTo != null and sItemCntTo != ""'>
                           AND P.ITEM_CNT <![CDATA[<=]]> #{sItemCntTo}
                       </if>        --판매건수
                       <if test='sItemQty != null and sItemQty != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) = #{sItemQty}
                       </if>        --판매수량
                       <if test='sItemQtyFr != null and sItemQtyFr != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) <![CDATA[>=]]> #{sItemQtyFr}
                       </if>        --판매수량
                       <if test='sItemQtyTo != null and sItemQtyTo != ""'>
                           AND (P.ITEM_QTY - NVL(E.RETURN_QTY,0)) <![CDATA[<=]]> #{sItemQtyTo}
                       </if>        --판매수량
                   ) T1
                   WHERE 1 = 1
                     <if test='sOrdStatCd != null and sOrdStatCd != ""'>
                         AND T1.ORD_STAT_CD = #{sOrdStatCd}
                     </if>        --부품판매오더상태
                     <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                         AND T1.ORD_STAT_CD IN
                         <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                             #{item}
                         </foreach>
                     </if>        --판매오더상태코드

    </select>

    <!-- 부품판매 현황상세정보를 조회한다. -->
    <select id="selectPartsSaleOrdItemList" parameterType="PartsSaleOrdSearchVO" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemList] */
          SELECT    A.*
            FROM
                 (
              SELECT    ROWNUM AS RNUM
                       ,T1.*
                FROM
                     (
                        SELECT    A.DLR_CD                    --딜러코드
                                 ,A.PAR_SALE_ORD_NO           --부품판매오더번호
                                 ,A.ORD_STAT_CD               --오더상태코드
                                 ,A.ORD_DT                    --오더일자
                                 ,A.CUST_TP                   --고객유형
                                 ,A.CUST_CD                   --고객코드
                                 ,A.CUST_NM                   --고객명
                                 ,B.PAR_SALE_ORD_LINE_NO        --부품판매오더라인번호
                               --  ,B.CALC_TP_CD                  --정산유형코드
                                 ,B.ITEM_CD                     --품목코드
                                 ,C.ITEM_NM                     --품목명
                                 --,B.DC_RATE                     --할인율
                                 ,B.PRC                         --단가
                                 ,A.SA_ID                     --SAID
                                 ,A.SALE_PRSN_ID              --담당자
                                 ,A.REMARK                    --비고
                                 ,A.DC_RATE                   --할인율
                              --   ,A.DC_BEF_TOT_AMT            --할인전총금액
                                 ,A.DC_AMT                    --할인금액
                                 ,A.TOT_AMT                   --총금액
                              --   ,A.VAT_AMT                   --부가세금액
                                 ,A.SALE_TP                   --판매유형
                                 ,B.AMT                         --금액
                                 ,B.UNIT_CD                     --단위코드
                                 ,B.ORD_QTY                     --오더수량
                                 ,B.END_QTY                     --종료수량
                                 ,B.GI_STAT_CD                  --출고상태코드
                                 ,B.RECEIVE_ID                  --수령인ID
                                 ,B.GI_DT                       --출고일자
                                 ,B.RECEIVE_DT                  --수령일자
                                 ,NULL AS RETURN_ID             --반품인ID
                                 ,NULL AS RETURN_DT             --반품일자
                                 ,B.CANC_ID                     --취소인ID
                                 ,B.CANC_DT                     --취소일자
                                 ,B.TAX_DDCT_AMT                --세금공제금액
                                 ,B.TAX_AMT                     --세금액
                                 ,CASE WHEN NVL(B.DC_RATE,0) = 0 THEN 0 ELSE ROUND(NVL(B.AMT,0) - (NVL(B.AMT,0) * NVL(B.DC_RATE,0)), 2) END DC_AMT
                                 ,B.PKG_ITEM_CD
                          FROM    DMSDB.PT_0521T A    --부품판매헤더정보
                                    INNER JOIN DMSDB.PT_0522T B    --부품판매품목정보
                                       ON A.DLR_CD          = B.DLR_CD
                                      AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                                    INNER JOIN  DMSDB.PT_0201T C    --품목정보
                                       ON B.DLR_CD  = C.DLR_CD
                                      AND B.ITEM_CD = C.ITEM_CD
                         WHERE   A.DLR_CD             = #{sDlrCd}           --딜러코드
                           <if test='sSaleTp != null and sSaleTp != ""'>
                               AND A.SALE_TP = #{sSaleTp}
                           </if>        --판매유형
                           <if test='sCustTp != null and sCustTp != ""'>
                               AND A.CUST_TP = #{sCustTp}
                           </if>        --고객유형
                           <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                               AND A.PAR_SALE_ORD_NO LIKE '%'||#{sParSaleOrdNo}||'%'
                           </if>  --부품판매오더번호
                           <if test='sCustNm != null and sCustNm != ""'>
                               AND A.CUST_NM LIKE  '%'||#{sCustNm}||'%'
                           </if>  --고객명
                           <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                               AND A.ORD_STAT_CD IN
                               <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                           </if>        --판매상태코드
                          <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                              AND A.SALE_PRSN_ID = #{sSalePrsnId}
                          </if>        --담당자
                          <if test='sSaId != null and sSaId != ""'>
                              AND A.SA_ID = #{sSaId}
                          </if>        --SAID
                          <if test='sOrdDtFr != null'>
                               AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                           </if>
                           <if test='sOrdDtTo != null'>
                               AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                           </if>
                         ORDER BY
                         <choose>
                             <when test='sort != null'>
                                 <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                     <choose>
                                         <when test='item.field == "saleTp"'> A.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "parSaleOrdNo"'> A.PAR_SALE_ORD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "ordStatCd"'> A.ORD_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "ordDt"'> A.ORD_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "custTp"'> A.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "custNm"'> A.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "salePrsnId"'> A.SALE_PRSN_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "saId"'> A.SA_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "dcRate"'> A.DC_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "itemCd"'> B.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "dcRate"'> B.DC_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "prc"'> B.PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "ordQty"'> B.ORD_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "returnId"'> B.RETURN_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "returnDt"'> B.RETURN_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "cancId"'> B.CANC_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "cancDt"'> B.CANC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <when test='item.field == "taxAmt"'> B.TAX_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                         <otherwise>
                                           A.DLR_CD ASC
                                          ,A.PAR_SALE_ORD_NO ASC
                                          ,B.PAR_SALE_ORD_LINE_NO ASC
                                         </otherwise>
                                     </choose>
                                 </foreach>
                             </when>
                             <otherwise>
                              A.DLR_CD ASC
                             ,A.PAR_SALE_ORD_NO ASC
                             ,B.PAR_SALE_ORD_LINE_NO ASC
                             </otherwise>
                         </choose>
                     ) T1
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 현황상세정보 COUNT를 조회한다. -->
    <select id="selectPartsSaleOrdItemListCnt" parameterType="PartsSaleOrdSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemListCnt] */
             SELECT    COUNT(*)
               FROM    DMSDB.PT_0521T A    --부품판매헤더정보
                            INNER JOIN DMSDB.PT_0522T B    --부품판매품목정보
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.PAR_SALE_ORD_NO = B.PAR_SALE_ORD_NO
                            INNER JOIN  DMSDB.PT_0201T C    --품목정보
                               ON B.DLR_CD  = C.DLR_CD
                              AND B.ITEM_CD = C.ITEM_CD
                 WHERE   A.DLR_CD = #{sDlrCd}           --딜러코드
                   <if test='sSaleTp != null and sSaleTp != ""'>
                       AND A.SALE_TP = #{sSaleTp}
                   </if>        --판매유형
                   <if test='sCustTp != null and sCustTp != ""'>
                       AND A.CUST_TP = #{sCustTp}
                   </if>        --고객유형
                   <if test='sParSaleOrdNo != null and sParSaleOrdNo != ""'>
                       AND A.PAR_SALE_ORD_NO LIKE '%'||#{sParSaleOrdNo}||'%'
                   </if>  --부품판매오더번호
                   <if test='sCustNm != null and sCustNm != ""'>
                       AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                   </if>  --고객명
                   <if test='sOrdStatLst != null and !sOrdStatLst.isEmpty'>
                       AND A.ORD_STAT_CD IN
                       <foreach item="item" index="index" collection="sOrdStatLst" open="(" separator="," close=")">
                           #{item}
                       </foreach>
                   </if>        --판매상태코드
                   <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                       AND A.SALE_PRSN_ID = #{sSalePrsnId}
                   </if>        --담당자
                   <if test='sSaId != null and sSaId != ""'>
                   AND A.SA_ID = #{sSaId}
                   </if>        --SAID
                   <if test='sOrdDtFr != null'>
                       AND A.ORD_DT <![CDATA[>=]]> #{sOrdDtFr}
                   </if>
                   <if test='sOrdDtTo != null'>
                       AND A.ORD_DT <![CDATA[<=]]> #{sOrdDtTo} + 1
                   </if>
    </select>

    <!-- 견적Key에 의한 부품판매 헤더 정보를 가져온다. -->
    <select id="selectPartsSaleOrdByEstimateKey" parameterType="map" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdByEstimateKey] */
           SELECT   A.DLR_CD                 --딜러코드
                   ,A.STAT_CD AS ORD_STAT_CD --상태코드
                   ,SYSDATE AS ORD_DT        --오더일자
                   ,A.CUST_TP                --고객유형
                   ,A.CUST_NO AS CUST_CD     --고객번호
                   ,A.CUST_NM                --고객명
                   ,A.CUST_TEL_NO            --고객전화번호
                   ,A.SALE_PRSN_ID           --판매담당자
                   ,A.SA_ID                  --SAID
                   ,A.REMARK                 --비고
                   ,A.DC_RATE                --할인율
                   ,A.DC_BEF_TOT_AMT         --할인전총금액
                   ,A.DC_AMT                 --할인금액
                   ,A.TOT_AMT                --총금액
                   ,A.VAT_AMT                --부가가치세금액
                   ,A.SALE_TP                --판매유형
                   ,A.SALE_PRSN_ID           --판매담당자ID
              FROM DMSDB.PT_0523T A    --판매견적헤더정보
             WHERE A.DLR_CD             = #{dlrCd}
               AND A.ESTIMATE_DOC_NO    = #{estimateDocNo}
    </select>

    <!-- 견적Key에 의한 부품판매 부품 정보를 가져온다. -->
    <select id="selectPartsSaleOrdItemByEstimateKey" parameterType="map" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemByEstimateKey] */
           SELECT   A.DLR_CD                      --딜러코드
                   ,A.ITEM_STAT_CD                --품목상태코드
                   ,A.ITEM_CD                     --품목코드
                   ,B.ITEM_NM                     --품목코드
                   ,A.EQIP_EXPC_DT                --설치예정일자
                   ,A.DC_RATE                     --할인율
                   ,A.PRC                         --단가
                   ,A.AMT                         --금액
                   ,A.UNIT_CD                     --단위코드
                   ,A.ESTIMATE_QTY AS ORD_QTY     --수량
                   ,A.TAX_DDCT_AMT                --세금공제금액
                   ,A.TAX_AMT                     --세금액
                   ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(NVL(A.AMT,0) - (NVL(A.AMT,0) * NVL(A.DC_RATE,0)), 2) END DC_AMT
                   ,A.GI_STRGE_CD                 --출고창고코드
                   ,A.GI_LOC_CD                   --출고위치코드
                   ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                   ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                   ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                   ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                   ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                   ,NVL(C.RENT_QTY,0) AS RENT_QTY
                   ,A.PKG_ITEM_CD
              FROM DMSDB.PT_0524T A    --부품견적품목정보
                   INNER JOIN  DMSDB.PT_0201T B    --품목정보
                      ON A.DLR_CD  = B.DLR_CD
                     AND A.ITEM_CD = B.ITEM_CD
                   LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                     ON A.DLR_CD      = C.DLR_CD
                    AND A.GI_STRGE_CD = C.STRGE_CD
                    AND A.ITEM_CD     = C.ITEM_CD
             WHERE A.DLR_CD             = #{dlrCd}
               AND A.ESTIMATE_DOC_NO    = #{estimateDocNo}
               ORDER BY A.DLR_CD
                   ,A.ESTIMATE_DOC_NO
                   ,A.ESTIMATE_DOC_LINE_NO
    </select>

    <!-- 판매 엑셀업로드 정보를 조회한다. -->
    <select id="selectPartsSaleOrdItemExcelUploadByKey" parameterType="PartsSaleOrdItemVO" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemExcelUploadByKey] */
      SELECT   A.DLR_CD
              ,A.BP_CD
              ,A.ITEM_CD
              ,A.ITEM_NM
              ,A.ITEM_DSTIN_CD
              ,NVL(A.DC_RATE,0) AS DC_RATE
              ,A.PRC
              ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN ROUND(A.ORD_QTY * A.PRC,2)
                    ELSE ROUND((A.ORD_QTY * A.PRC) - ((A.ORD_QTY * A.PRC) * (A.DC_RATE/100)),2) END AMT
              ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0
                    ELSE ROUND((A.ORD_QTY * A.PRC) * (A.DC_RATE/100),2) END DC_AMT
              ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN ROUND((A.ORD_QTY * A.PRC) - ((A.ORD_QTY * A.PRC)/( 1 + FN_GET_VAT(null,'ALL'))),2)
                    ELSE ROUND(((A.ORD_QTY * A.PRC) - ((A.ORD_QTY * A.PRC) * (A.DC_RATE/100))) - ((A.ORD_QTY * A.PRC) - ((A.ORD_QTY * A.PRC) * (A.DC_RATE/100)))/( 1 + FN_GET_VAT(null,'ALL')),2) END TAX_AMT
              ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN ROUND((A.ORD_QTY * A.PRC)/( 1 + FN_GET_VAT(null,'ALL')),2)
                    ELSE ROUND(((A.ORD_QTY * A.PRC) - ((A.ORD_QTY * A.PRC) * (A.DC_RATE/100)))/( 1 + FN_GET_VAT(null,'ALL')),2) END TAX_DDCT_AMT
              ,NVL(A.ORD_QTY,0) AS ORD_QTY
              ,NVL(A.END_QTY,0) AS END_QTY
              ,A.UNIT_CD
              ,A.STOCK_QTY
              ,A.AVLB_STOCK_QTY
              ,A.RESV_STOCK_QTY
              ,A.CLAM_STOCK_QTY
              ,A.BORROW_QTY
              ,A.RENT_QTY
              ,A.GI_STRGE_CD
              ,A.SALE_TP
              ,A.PRC_TP
              ,NVL(B.LOC_CD, ' ') AS GI_LOC_CD
              ,NVL(B.LOC_NM, ' ') AS GI_LOC_NM
              ,A.EXCEL_QTY
              ,A.EXCEL_PRC
              ,A.EXCEL_DC_RATE
              ,A.STRGE_CD
              ,C.MOVING_AVG_PRC
              ,NVL(C.MOVING_AVG_TAX_DDCT_PRC,0) AS MOVING_AVG_TAX_DDCT_PRC
       FROM
            (
              SELECT   A.DLR_CD
                      ,A.BP_CD
                      ,A.ITEM_CD
                      ,A.ITEM_NM
                      ,A.ITEM_DSTIN_CD
                      ,NVL(ROUND(#{excelDcRate},2), 0) AS DC_RATE
                      ,NVL(ROUND(#{excelDcRate},2), 0) AS EXCEL_DC_RATE
                      ,DECODE(#{prcTp},'01',NVL(B.RETL_PRC, 0),'02',NVL(B.WHSL_PRC, 0),'03',NVL(B.INC_PRC, 0),'04',NVL(B.GRTE_PRC, 0),NVL(B.SALE_PRC_AMT, 0)) AS PRC
                      ,NVL(ROUND(#{excelQty}), 0) AS ORD_QTY
                      ,NVL(DECODE(#{excelQty},'-999','0',#{excelQty}), 0) AS EXCEL_QTY
                      ,0 AS END_QTY
                      ,A.STOCK_UNIT_CD AS UNIT_CD
                      ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
                      ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                      ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                      ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                      ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
                      ,NVL(C.RENT_QTY,0) AS RENT_QTY
                      ,NVL(#{excelStrgeCd},A.GI_STRGE_CD) AS GI_STRGE_CD
                      ,NVL(#{prcTp}, '') AS SALE_TP
                      ,NVL(#{prcTp}, '') AS PRC_TP
                      ,NVL(ROUND(DECODE(#{excelPrc},'-999','0',#{excelPrc}),2), 0) AS EXCEL_PRC
                      ,C.STRGE_CD
                FROM   DMSDB.PT_0201T A
                          LEFT OUTER JOIN (
                                  SELECT   DLR_CD
                                          ,ITEM_CD
                                          ,MAX(PRC_TP) AS PRC_TP
                                          ,MAX(LINE_NO) AS LINE_NO
                                          ,MAX(NVL(NVL(ROUND(#{excelPrc},2),RETL_PRC),0)) AS RETL_PRC
                                          ,MAX(NVL(NVL(ROUND(#{excelPrc},2),WHSL_PRC),0)) AS WHSL_PRC
                                          ,MAX(NVL(NVL(ROUND(#{excelPrc},2),SALE_PRC_AMT),0)) AS SALE_PRC_AMT
                                          ,MAX(NVL(NVL(ROUND(#{excelPrc},2),INC_PRC),0)) AS INC_PRC
                                          ,MAX(NVL(NVL(ROUND(#{excelPrc},2),GRTE_PRC),0)) AS GRTE_PRC
                                    FROM   PT_0214T
                                   WHERE   DLR_CD = #{dlrCd}
                                     AND   DEL_YN != 'Y'
                                  GROUP BY DLR_CD, ITEM_CD) B
                               ON A.DLR_CD = B.DLR_CD
                              AND A.ITEM_CD= B.ITEM_CD
                             LEFT OUTER JOIN (
                                  SELECT DLR_CD
                                        ,ITEM_CD
                                        ,STRGE_CD
                                        ,NVL(AVLB_STOCK_QTY,0) + NVL(RESV_STOCK_QTY,0) - NVL(BORROW_QTY,0) + NVL(RENT_QTY,0) AS STOCK_QTY
                                        ,NVL(AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
                                        ,NVL(BORROW_QTY,0) AS BORROW_QTY
                                        ,NVL(RENT_QTY,0) AS RENT_QTY
                                        ,NVL(CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
                                        ,NVL(RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
                                    FROM PT_0301T
                                    WHERE DLR_CD = #{dlrCd}
                                      AND ITEM_CD = #{itemCd}
                                    ) C
                               ON A.DLR_CD = C.DLR_CD
                              AND A.ITEM_CD = C.ITEM_CD
              ) A
              LEFT JOIN PT_0224T B
                 ON A.DLR_CD = B.DLR_CD AND A.GI_STRGE_CD = B.STRGE_CD AND A.ITEM_CD = B.ITEM_CD  AND B.LOC_CD != ''
              LEFT OUTER JOIN PT_0208T C
                 ON A.DLR_CD = C.DLR_CD AND A.GI_STRGE_CD = C.STRGE_CD AND A.ITEM_CD = C.ITEM_CD
               WHERE  A.DLR_CD = #{dlrCd} --딜러코드
                 AND  A.ITEM_CD = #{itemCd} --부품번호
                 AND  A.STRGE_CD = NVL(#{excelStrgeCd},A.GI_STRGE_CD)
    </select>

    <!-- 부품판매 상태변경을 위한 품목 목록을 조회한다. -->
    <select id="selectPartsSaleOrdItemRegCnt" parameterType="PartsSaleOrdVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdItemRegCnt] */
        SELECT COUNT(*)
          FROM DMSDB.PT_0522T A
         WHERE A.DLR_CD            = #{dlrCd}
           AND A.PAR_SALE_ORD_NO   =  #{parSaleOrdNo}
           AND A.GI_STAT_CD        = '01'
    </select>

       <!-- 부품판매 정보 Max 라인번호를 조회한다. -->
    <select id="selectPartsSaleOrdMaxLineNo" parameterType="PartsSaleOrdVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdMaxLineNo] */
        SELECT max(A.PAR_SALE_ORD_LINE_NO) + 1
          FROM DMSDB.PT_0522T A    --판매부품정보
         WHERE A.DLR_CD               = #{dlrCd}                 --딜러코드
           AND A.PAR_SALE_ORD_NO      = #{parSaleOrdNo}
    </select>

    <!-- 부품판매 헤더 상태 정보를 조회한다. -->
    <select id="chkStatusPartsSaleOrdByKey" parameterType="map" resultType="PartsSaleOrdVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.chkStatusPartsSaleOrdByKey] */
        SELECT A.*
          FROM DMSDB.PT_0521T A    --부품판매헤더정보
         WHERE A.DLR_CD             = #{dlrCd}
           AND A.PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </select>

    <!-- 부품판매 품목 상태 정보를 조회한다. -->
    <select id="chkStatusPartsSaleOrdItemByKey" parameterType="map" resultType="PartsSaleOrdItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.chkStatusPartsSaleOrdItemByKey] */
        SELECT A.*
          FROM DMSDB.PT_0522T A    --부품판매품목정보
         WHERE A.DLR_CD                  = #{dlrCd}
           AND A.PAR_SALE_ORD_NO         = #{parSaleOrdNo}
           AND A.PAR_SALE_ORD_LINE_NO    = #{parSaleOrdLineNo}
    </select>

    <!-- 부품판매 헤더 정보를 조회한다. -->
    <select id="selectPartsSaleOrdUpdtDtByKey" parameterType="PartsSaleOrdVO" resultType="String">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleOrdDAO.selectPartsSaleOrdUpdtDtByKey] */
        SELECT TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM DMSDB.PT_0521T A    --부품판매헤더정보
         WHERE A.DLR_CD             = #{dlrCd}
           AND A.PAR_SALE_ORD_NO    = #{parSaleOrdNo}
    </select>
</mapper>