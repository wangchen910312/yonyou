<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : PartsSaleEstimateDAO_SqlMap.xml
    Description : 부품견적 관리.
    author In Bo Shim
    since 2016. 2. 23.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 02. 23.     Ju Won Lee     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO">

    <!-- 부품판매 헤더 정보를 추가한다. -->
    <insert id="insertPartsSaleEstimate" parameterType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.insertPartsSaleEstimate] */
        INSERT INTO DMSDB.PT_0523T    --부품판매견적헤더정보
        (
          DLR_CD                    --딜러코드
         ,ESTIMATE_DOC_NO           --부품판매견적번호
         ,STAT_CD                   --상태코드(01)
         ,ESTIMATE_DT               --견적일자    (입력)
         ,SALE_TP                   --판매유형
         ,CUST_TP                   --고객유형
         ,CUST_NO                   --고객코드    (null허용)
         ,CUST_NM                   --고객명
         ,CUST_TEL_NO               --고객전화번호(null 허용)
         ,SALE_PRSN_ID              --판매담당자
         ,SA_ID                     --판매고문
         ,VIN_NO                    --VIN번호
         ,CAR_REG_NO                --차량등록번호
         ,REMARK                    --비고
         ,DC_RATE                   --할인율
         ,DC_BEF_TOT_AMT            --할인전총금액
         ,DC_AMT                    --할인금액
         ,TOT_AMT                   --총금액
         ,REG_USR_ID                --등록자ID
         ,REG_DT                    --등록일자
         ,UPDT_USR_ID
         ,UPDT_DT
        )
        VALUES
        (
          #{dlrCd}                    --딜러코드
         ,#{estimateDocNo}            --부품판매견적번호
         ,#{statCd}                   --견적상태코드
         ,sysdate                     --견적일자
         ,#{saleTp}                   --판매유형
         ,#{custTp}                   --고객유형
         ,#{custNo}                   --고객코드
         ,#{custNm}                   --고객명
         ,#{custTelNo}                --고객전화번호
         ,#{salePrsnId}               --판매담당자
         ,#{saId}                     --판매고문
         ,#{vinNo}                    --VIN번호
         ,#{carRegNo}                 --차량등록번호
         ,#{remark}                   --비고
         ,round(#{dcRate},2)          --할인율
         ,round(#{dcBefTotAmt},2)     --할인전총금액
         ,round(#{dcAmt},2)           --할인금액
         ,round(#{totAmt},2)          --총금액
         ,#{regUsrId}                 --등록자ID
         ,sysdate                     --등록일자
         ,#{regUsrId}                 --등록자ID
         ,sysdate                     --등록일자
        )
    </insert>

    <!-- 부품판매  부품 정보를 추가한다. -->
    <insert id="insertPartsSaleEstimateItem" parameterType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.insertPartsSaleEstimateItem] */
        INSERT INTO DMSDB.PT_0524T    --부품판매견적품목정보
        (
          DLR_CD                      --딜러코드
         ,ESTIMATE_DOC_NO             --부품판매견적번호
         ,ESTIMATE_DOC_LINE_NO        --부품판매견적라인번호
         ,ITEM_CD                     --품목코드
         ,EQIP_EXPC_DT                --설치예정일자
         ,DC_RATE                     --할인율
         ,PRC                         --단가
         ,AMT                         --금액
         ,UNIT_CD                     --단위코드
         ,ESTIMATE_QTY                --견적수량
         ,GI_STRGE_CD                 --출고창고
         ,GI_LOC_CD                   --출고로케이션
         ,TAX_DDCT_AMT                --세금공제금액(할인 후 금액)
         ,TAX_AMT                     --세금금액
         ,PKG_ITEM_CD                 --패키지부품번호
         ,REG_USR_ID                  --등록자ID
         ,REG_DT                      --등록일자
         ,UPDT_USR_ID
         ,UPDT_DT
        )
        VALUES
        (
          #{dlrCd}                      --딜러코드
         ,#{estimateDocNo}              --부품판매견적번호
         ,#{estimateDocLineNo}          --부품판매견적라인번호
         ,#{itemCd}                     --품목코드
         ,#{eqipExpcDt}                 --설치예정일자
         ,round(#{dcRate},2)            --할인율
         ,round(#{prc},2)               --단가
         ,round(#{amt},2)               --금액
         ,#{unitCd}                     --단위코드
         ,#{estimateQty}                --견적수량
         ,#{giStrgeCd}                  --출고창고
         ,#{giLocCd}                    --출고로케이션
         ,round(#{taxDdctAmt},2)        --세금공제금액
         ,round(#{taxAmt},2)            --세금액
         ,#{pkgItemCd}                  --패키지부품번호
         ,#{regUsrId}                   --등록자ID
         ,sysdate                       --등록일자
         ,#{regUsrId}                   --등록자ID
         ,sysdate                       --등록일자
        )
    </insert>

     <!-- 부품판매 헤더 정보를 수정한다. -->
    <update id="updatePartsSaleEstimate" parameterType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.updatePartsSaleEstimate] */
        UPDATE DMSDB.PT_0523T A    --부품판매견적헤더정보
          SET
               STAT_CD            = #{statCd}        --상태
              ,CUST_NO            = #{custNo}           --고객코드
              ,CUST_NM            = #{custNm}           --고객명
              ,CUST_TEL_NO        = #{custTelNo}        --고객전화
              ,SALE_PRSN_ID       = #{salePrsnId}       --담당자
              ,SA_ID              = #{saId}             --판매고문
              ,VIN_NO             = #{vinNo}            --VIN번호
              ,CAR_REG_NO         = #{carRegNo}         --차량등록번호
              ,REMARK             = #{remark}           --비고
              ,DC_BEF_TOT_AMT     = round(#{dcBefTotAmt},2)      --할인전총금액
              ,DC_AMT             = round(#{dcAmt},2)            --할인금액
              ,TOT_AMT            = round(#{totAmt},2)           --총금액
              ,UPDT_USR_ID        = #{regUsrId}         --수정자ID
              ,UPDT_DT            = sysdate
         WHERE DLR_CD             = #{dlrCd}            --딜러코드
           AND ESTIMATE_DOC_NO    = #{estimateDocNo}
    </update>

     <!-- 부품판매 부품 정보를 수정한다. -->
    <update id="updatePartsSaleEstimateItem" parameterType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.updatePartsSaleEstimateItem] */
        UPDATE DMSDB.PT_0524T    --부품판매견적품목정보
          SET
               ITEM_CD           = #{itemCd}                  --부품번호
              ,DC_RATE           = round(#{dcRate},2)         --할인율
              ,PRC               = round(#{prc},2)            --가격
              ,AMT               = round(#{amt},2)            --금액
              ,ESTIMATE_QTY      = #{estimateQty}             --수량
              ,EQIP_EXPC_DT      = #{eqipExpcDt}              --설치예정일자
              ,GI_STRGE_CD       = #{giStrgeCd}               --출고창고
              ,GI_LOC_CD         = #{giLocCd}                 --출고로케이션
              ,TAX_DDCT_AMT      = round(#{taxDdctAmt},2)     --세금공제금액(할인 후 금액)
              ,TAX_AMT           = round(#{taxAmt},2)         --세금금액
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD            = #{dlrCd}                   --딜러코드
           AND ESTIMATE_DOC_NO       = #{estimateDocNo}               --구매견적번호
           AND ESTIMATE_DOC_LINE_NO  = #{estimateDocLineNo}           --구매견적라인번호
    </update>

     <!-- 부품판매 부품 정보를 삭제한다.-->
    <delete id="deletePartsSaleEstimateItem" parameterType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.deletePartsSaleEstimateItem] */
        DELETE DMSDB.PT_0524T    --부품판매견적품목정보
         WHERE DLR_CD                = #{dlrCd}                   --딜러코드
           AND ESTIMATE_DOC_NO       = #{estimateDocNo}           --구매견적번호
           AND ESTIMATE_DOC_LINE_NO  = #{estimateDocLineNo}       --구매견적라인번호
    </delete>


     <!-- 헤더 번호에 해당하는 모든 부품 정보를 삭제한다.-->
    <delete id="cancelPartsSaleEstimateItem" parameterType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.cancelPartsSaleEstimateItem] */
        DELETE DMSDB.PT_0524T    --부품판매견적품목정보
         WHERE DLR_CD                = #{dlrCd}                       --딜러코드
           AND ESTIMATE_DOC_NO       = #{estimateDocNo}               --구매견적번호
    </delete>

    <!-- 부품판매  정보 상태를 변경한다.-->
    <update id="modifyPartsSaleEstimateStat" parameterType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.modifyPartsSaleEstimateStat] */
        UPDATE DMSDB.PT_0523T    --부품판매정보
           SET STAT_CD       = #{statCd}                      --상태
              ,UPDT_USR_ID       = #{regUsrId}                --수정자ID
              ,UPDT_DT           = sysdate                    --수정일자
         WHERE DLR_CD                = #{dlrCd}               --딜러코드
           AND ESTIMATE_DOC_NO       = #{estimateDocNo}       --구매견적번호
    </update>

    <!-- 부품판매 헤더 정보를 조회한다. -->
    <select id="selectPartsSaleEstimateByKey" parameterType="PartsSaleEstimateSearchVO" resultType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateByKey] */
        SELECT
                A.DLR_CD                --딜러코드
               ,A.ESTIMATE_DOC_NO       --부품판매견적번호
               ,A.STAT_CD               --견적상태코드
               ,A.ESTIMATE_DT           --견적일자
               ,A.SALE_TP               --판매유형
               ,A.CUST_TP               --고객유형
               ,A.CUST_NO               --고객코드
               ,A.CUST_NM               --고객명
               ,A.CUST_TEL_NO           --고객전화번호
               ,A.SALE_PRSN_ID          --판매담당자
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SALE_PRSN_ID AND ENABLED_YN = 'Y' AND DEL_YN = 'N') AS SALE_PRSN_NM
               ,A.VIN_NO                --VIN번호
               ,A.CAR_REG_NO            --차량등록번호
               ,A.SA_ID                 --SAID
               ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SA_ID AND ENABLED_YN = 'Y' AND DEL_YN = 'N') AS SA_NM
               ,A.REMARK                --비고
               ,A.DC_RATE               --할인율
               ,A.DC_BEF_TOT_AMT        --할인전총금액
               ,A.DC_AMT                --할인금액
               ,A.TOT_AMT               --총금액
               ,B.ITEM_CNT
               ,B.ITEM_QTY
               ,B.ITEM_AMT
               ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM DMSDB.PT_0523T A    --부품판매견적헤더정보
               LEFT OUTER JOIN (
                     SELECT   DLR_CD
                             ,ESTIMATE_DOC_NO
                             ,COUNT(*) AS ITEM_CNT
                             ,SUM(NVL(ESTIMATE_QTY,0)) AS ITEM_QTY
                             ,SUM(NVL(AMT,0)) AS ITEM_AMT
                       FROM   DMSDB.PT_0524T
                      WHERE   DLR_CD = #{sDlrCd}
                        AND   NVL(ITEM_STAT_CD,'01') != '03'
                      GROUP BY DLR_CD
                              ,ESTIMATE_DOC_NO
                 ) B
                 ON A.DLR_CD          = B.DLR_CD
                AND A.ESTIMATE_DOC_NO = B.ESTIMATE_DOC_NO
         WHERE A.DLR_CD             = #{sDlrCd}
           AND A.ESTIMATE_DOC_NO    = #{sEstimateDocNo}
           AND A.STAT_CD != '03'
    </select>

    <!-- 부품판매 부품 정보를 조회한다. -->
    <select id="selectPartsSaleEstimateItemByKey" parameterType="PartsSaleEstimateSearchVO" resultType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateItemByKey] */
         SELECT
                A.DLR_CD                      --딜러코드
               ,A.ESTIMATE_DOC_NO             --부품판매견적번호
               ,A.ESTIMATE_DOC_LINE_NO        --부품판매견적라인번호
               ,A.ITEM_CD                     --품목코드
               ,B.ITEM_NM
               ,B.ITEM_DSTIN_CD
               ,A.EQIP_EXPC_DT                --설치예정일자
               ,A.DC_RATE                     --할인율
               ,A.PRC                         --단가
               ,A.AMT                         --금액
               ,A.TAX_DDCT_AMT                --세금공제금액(할인 후 금액)
               ,A.TAX_AMT                     --세금금액
               ,CASE WHEN NVL(A.DC_RATE,0) = 0 THEN 0 ELSE ROUND(((A.ESTIMATE_QTY * A.PRC) * (NVL(A.DC_RATE,0) / 100)), 2) END DC_AMT
               ,A.UNIT_CD                     --단위코드
               ,A.ESTIMATE_QTY                --견적수량
               ,NVL(C.AVLB_STOCK_QTY,0) + NVL(C.RESV_STOCK_QTY,0) - NVL(C.BORROW_QTY,0) + NVL(C.RENT_QTY,0) AS STOCK_QTY
               ,NVL(C.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY
               ,NVL(C.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY
               ,NVL(C.CLAM_STOCK_QTY,0) AS CLAM_STOCK_QTY
               ,NVL(C.BORROW_QTY,0) AS BORROW_QTY
               ,NVL(C.RENT_QTY,0) AS RENT_QTY
               ,A.GI_STRGE_CD
               ,D.SALE_TP
               ,A.GI_LOC_CD AS GI_LOC_CD
               ,A.PKG_ITEM_CD
               ,(SELECT PKG_ITEM_NM FROM PT_0230T WHERE DLR_CD = A.DLR_CD AND PKG_ITEM_CD = A.PKG_ITEM_CD AND ROWNUM = 1) AS PKG_ITEM_NM
           FROM DMSDB.PT_0524T A    --부품판매견적품목정보
                INNER JOIN  DMSDB.PT_0523T D
                   ON A.DLR_CD          = D.DLR_CD
                  AND A.ESTIMATE_DOC_NO = D.ESTIMATE_DOC_NO
                INNER JOIN  DMSDB.PT_0201T B    --품목정보
                   ON A.DLR_CD  = B.DLR_CD
                  AND A.ITEM_CD = B.ITEM_CD
                LEFT OUTER JOIN  DMSDB.PT_0301T C    --재고정보
                   ON A.DLR_CD      = C.DLR_CD
                  AND B.GI_STRGE_CD = C.STRGE_CD
                  AND A.ITEM_CD     = C.ITEM_CD
          WHERE A.DLR_CD             = #{sDlrCd}
            AND A.ESTIMATE_DOC_NO    = #{sEstimateDocNo}
    </select>

    <!-- 부품판매 리스트정보를 조회한다. -->
    <select id="selectPartsSaleEstimateList" parameterType="PartsSaleEstimateSearchVO" resultType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateList] */
      SELECT    A.*
        FROM
             (
          SELECT    ROWNUM AS RNUM
                   ,T1.*
            FROM
                 (
                     SELECT A.DLR_CD                    --딜러코드
                           ,A.STAT_CD                   --견적상태코드
                           ,A.ESTIMATE_DT               --견적일자
                           ,A.SALE_TP                   --판매유형
                           ,A.CUST_TP                   --고객유형
                           ,A.CUST_NO                   --고객코드
                           ,A.CUST_NM                   --고객명
                           ,A.CUST_TEL_NO               --고객전화번호
                           ,A.ESTIMATE_DOC_NO           --부품판매견적번호
                           ,A.SALE_PRSN_ID              --SALE_PRSN_ID
                           ,B.USR_NM AS SALE_PRSN_NM    --SALE_PRSN_NM
                           ,A.VIN_NO                    --VIN번호
                           ,A.CAR_REG_NO                --차량등록번호
                           ,A.SA_ID                     --SAID
                           ,C.USR_NM AS SA_NM
                           ,A.REMARK                    --비고
                           ,A.DC_RATE                   --할인율
                           ,A.DC_BEF_TOT_AMT            --할인전총금액
                           ,A.DC_AMT                    --할인금액
                           ,A.TOT_AMT                   --총금액
                           ,A.VAT_AMT                   --부가세금액
                           ,A.REG_USR_ID                --등록자ID
                           ,A.REG_DT                    --등록일자
                           ,A.UPDT_USR_ID               --수정자ID
                           ,A.UPDT_DT                   --수정일자
                           ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                      FROM DMSDB.PT_0523T A    --부품판매견적헤더정보
                             LEFT OUTER JOIN CM_0801T B
                               ON B.USR_ID     = A.SALE_PRSN_ID
                              AND B.ENABLED_YN = 'Y'
                              AND B.DEL_YN     = 'N'
                             LEFT OUTER JOIN CM_0801T C
                               ON C.USR_ID     = A.SA_ID
                              AND C.ENABLED_YN = 'Y'
                              AND C.DEL_YN     = 'N'
                     WHERE A.DLR_CD = #{sDlrCd}  --딜러코드
                       <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                            AND A.ESTIMATE_DOC_NO = #{sEstimateDocNo}
                       </if>        --부품판매견적번호
                       <if test='sStatCd != null and !sStatCd.isEmpty'> AND A.STAT_CD IN
                           <foreach item="item" index="index" collection="sStatCd" open="(" separator="," close=")">
                               #{item}
                           </foreach>
                       </if>        --판매견적상태코드
                       <if test='sEstimateDtFr != null'>
                           AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
                       </if>
                       <if test='sEstimateDtTo != null'>
                           AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
                       </if>
                       <if test='sCustTp != null and sCustTp != ""'>
                            AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sCustNo != null and sCustNo != ""'>
                            AND A.CUST_NO = #{sCustNo}
                       </if>        --고객코드
                       <if test='sCustNm != null and sCustNm != ""'>
                            AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                       </if>  --고객명
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                       <if test='sSaNm != null and sSaNm != ""'>
                            AND C.USR_NM LIKE '%'||#{sSaNm}||'%'
                       </if>  --고객명
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                            AND A.SALE_PRSN_ID = #{sSasSalePrsnIdId}
                       </if>        --SAID
                       <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                            AND B.USR_NM LIKE '%'||#{sSalePrsnNm}||'%'
                       </if>  --고객명
                       <if test='sDcRate != null and sDcRate != ""'>
                            AND A.DC_RATE = #{sDcRate}
                       </if>        --할인율
                       <if test='sSaleTp != null and sSaleTp != ""'>
                            AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                     ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "estimateDocNo"'>     A.ESTIMATE_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                     <when test='item.field == "statCd"'>            A.STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                     <when test='item.field == "estimateDt"'>        A.ESTIMATE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "custTp"'>            A.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "custNm"'>            A.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "saNm"'>              B.USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "saleTp"'>            A.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <otherwise>
                                       A.DLR_CD ASC
                                      ,A.ESTIMATE_DOC_NO DESC
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                           A.DLR_CD ASC
                          ,A.ESTIMATE_DOC_NO DESC
                         </otherwise>
                     </choose>
                 ) T1
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 리스트정보를 조회한다. -->
    <select id="selectPartsSaleEstimateListCnt" parameterType="PartsSaleEstimateSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateListCnt] */
             SELECT COUNT(*)
              FROM DMSDB.PT_0523T A    --부품판매견적헤더정보
                     LEFT OUTER JOIN CM_0801T B
                       ON B.USR_ID     = A.SA_ID
                      AND B.ENABLED_YN = 'Y'
                      AND B.DEL_YN     = 'N'
             WHERE A.DLR_CD = #{sDlrCd}  --딜러코드
               <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                    AND A.ESTIMATE_DOC_NO = #{sEstimateDocNo}
               </if>        --부품판매견적번호
               <if test='sStatCd  != null and !sStatCd.isEmpty'>
                   AND A.STAT_CD IN
                   <foreach item="item" index="index" collection="sStatCd" open="(" separator="," close=")">
                       #{item}
                   </foreach>
               </if>        --판매견적상태코드
               <if test='sEstimateDtFr != null'>
                    AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
               </if>
               <if test='sEstimateDtTo != null'>
                    AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
               </if>
               <if test='sCustTp != null and sCustTp != ""'>
                    AND A.CUST_TP = #{sCustTp}
               </if>        --고객유형
               <if test='sCustNo != null and sCustNo != ""'>
                    AND A.CUST_NO = #{sCustNo}
               </if>        --고객코드
               <if test='sCustNm != null and sCustNm != ""'>
                    AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
               </if>  --고객명
               <if test='sSaId != null and sSaId != ""'>
                    AND A.SA_ID = #{sSaId}
               </if>        --SAID
               <if test='sSaNm != null and sSaNm != ""'>
                    AND C.USR_NM LIKE '%'||#{sSaNm}||'%'
               </if>  --고객명
               <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                    AND A.SALE_PRSN_ID = #{sSasSalePrsnIdId}
               </if>        --SAID
               <if test='sSalePrsnNm != null and sSalePrsnNm != ""'>
                    AND B.USR_NM LIKE '%'||#{sSalePrsnNm}||'%'
               </if>  --고객명
               <if test='sDcRate != null and sDcRate != ""'>
                    AND A.DC_RATE = #{sDcRate}
               </if>        --할인율
               <if test='sSaleTp != null and sSaleTp != ""'>
                    AND A.SALE_TP = #{sSaleTp}
               </if>        --판매유형
    </select>

    <!-- 부품판매 현황상세정보를 조회한다. -->
    <select id="selectPartsSaleEstimateItemList" parameterType="PartsSaleEstimateSearchVO" resultType="PartsSaleEstimateItemVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateItemList] */
      SELECT    A.*
        FROM
             (
          SELECT    ROWNUM AS RNUM
                   ,T1.*
            FROM
                 (
                    SELECT    A.DLR_CD                    --딜러코드
                             ,A.ESTIMATE_DOC_NO           --부품판매견적번호
                             ,A.STAT_CD                   --견적상태코드
                             ,A.ESTIMATE_DT               --견적일자
                             ,A.CUST_TP                   --고객유형
                             ,A.CUST_NO                   --고객코드
                             ,A.CUST_NM                   --고객명
                             ,B.ESTIMATE_DOC_LINE_NO      --부품판매견적라인번호
                             ,B.ITEM_CD                   --품목코드
                             ,C.ITEM_NM                   --품목명
                             --,B.DC_RATE                 --할인율
                             ,B.PRC                       --단가
                             ,A.VIN_NO                    --VIN번호
                             ,A.CAR_REG_NO                --차량등록번호
                             ,A.SA_ID                     --SAID
                             ,A.SALE_PRSN_ID              --SALE_ID
                             ,A.REMARK                    --비고
                             ,A.DC_RATE                   --할인율
                          --   ,A.DC_BEF_TOT_AMT          --할인전총금액
                             ,A.DC_AMT                    --할인금액
                             ,A.TOT_AMT                   --총금액
                          --   ,A.VAT_AMT                 --부가세금액
                             ,A.SALE_TP                   --판매유형
                             ,B.AMT                       --금액
                             ,B.UNIT_CD                   --단위코드
                             ,B.ESTIMATE_QTY              --견적수량
                             ,B.TAX_DDCT_AMT                --세금공제금액
                             ,B.TAX_AMT                     --세금액
                             ,CASE WHEN NVL(B.DC_RATE,0) = 0 THEN 0 ELSE ROUND(NVL(B.AMT,0) - (NVL(B.AMT,0) * NVL(B.DC_RATE,0)), 2) END DC_AMT
                             ,B.PKG_ITEM_CD
                      FROM    DMSDB.PT_0523T A    --부품판매견적헤더정보
                                INNER JOIN DMSDB.PT_0524T B    --부품판매견적품목정보
                                   ON A.DLR_CD          = B.DLR_CD
                                  AND A.ESTIMATE_DOC_NO = B.ESTIMATE_DOC_NO
                                INNER JOIN  DMSDB.PT_0201T C    --품목정보
                                   ON B.DLR_CD  = C.DLR_CD
                                  AND B.ITEM_CD = C.ITEM_CD
                     WHERE   A.DLR_CD = #{sDlrCd}           --딜러코드
                       <if test='sSaleTp != null and sSaleTp != ""'>
                            AND A.SALE_TP = #{sSaleTp}
                       </if>        --판매유형
                       <if test='sCustTp != null and sCustTp != ""'>
                            AND A.CUST_TP = #{sCustTp}
                       </if>        --고객유형
                       <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                            AND A.ESTIMATE_DOC_NO LIKE '%'||#{sEstimateDocNo}||'%'
                       </if>  --부품판매견적번호
                       <if test='sCustNm != null and sCustNm != ""'>
                            AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                       </if>  --고객명
                       <if test='sStatLst != null and !sStatLst.isEmpty'>
                            AND A.STAT_CD IN
                           <foreach item="item" index="index" collection="sStatLst" open="(" separator="," close=")">
                               #{item}
                           </foreach>
                       </if>        --판매상태코드
                       <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                            AND A.SALE_PRSN_ID = #{sSalePrsnId}
                       </if>        --담당자
                       <if test='sSaId != null and sSaId != ""'>
                            AND A.SA_ID = #{sSaId}
                       </if>        --SAID
                      <if test='sEstimateDtFr != null'>
                           AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
                       </if>
                       <if test='sEstimateDtTo != null'>
                           AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
                       </if>
                     ORDER BY
                     <choose>
                         <when test='sort != null'>
                             <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                 <choose>
                                     <when test='item.field == "saleTp"'>            A.SALE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "estimateDocNo"'>     A.ESTIMATE_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                     <when test='item.field == "statCd"'>            A.STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                     <when test='item.field == "estimateDt"'>        A.ESTIMATE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                     <when test='item.field == "custTp"'>            A.CUST_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "custNm"'>            A.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "salePrsnId"'>        A.SALE_PRSN_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                     <when test='item.field == "saId"'>              A.SA_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                     <when test='item.field == "dcRate"'>            A.DC_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "itemCd"'>            B.ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "dcRate"'>            B.DC_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "prc"'>               B.PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                     <when test='item.field == "estimateQty"'>       B.ESTIMATE_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <when test='item.field == "taxAmt"'>            B.TAX_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                     <otherwise>
                                       A.DLR_CD ASC
                                      ,A.ESTIMATE_DOC_NO ASC
                                      ,B.ESTIMATE_DOC_LINE_NO ASC
                                     </otherwise>
                                 </choose>
                             </foreach>
                         </when>
                         <otherwise>
                           A.DLR_CD ASC
                         ,A.ESTIMATE_DOC_NO ASC
                         ,B.ESTIMATE_DOC_LINE_NO ASC
                         </otherwise>
                     </choose>
                 ) T1
             ) A
             <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
             </where>
    </select>

    <!-- 부품판매 현황상세정보 COUNT를 조회한다. -->
    <select id="selectPartsSaleEstimateItemListCnt" parameterType="PartsSaleEstimateSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateItemListCnt] */
             SELECT    COUNT(*)
               FROM    DMSDB.PT_0523T A    --부품판매견적헤더정보
                            INNER JOIN DMSDB.PT_0524T B    --부품판매견적품목정보
                               ON A.DLR_CD          = B.DLR_CD
                              AND A.ESTIMATE_DOC_NO = B.ESTIMATE_DOC_NO
                            INNER JOIN  DMSDB.PT_0201T C    --품목정보
                               ON B.DLR_CD  = C.DLR_CD
                              AND B.ITEM_CD = C.ITEM_CD
                 WHERE  A.DLR_CD             = #{sDlrCd}           --딜러코드
                   <if test='sSaleTp != null and sSaleTp != ""'>
                        AND A.SALE_TP = #{sSaleTp}
                   </if>        --판매유형
                   <if test='sCustTp != null and sCustTp != ""'>
                        AND A.CUST_TP = #{sCustTp}
                   </if>        --고객유형
                   <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                        AND A.ESTIMATE_DOC_NO LIKE '%'||#{sEstimateDocNo}||'%'
                   </if>  --부품판매견적번호
                   <if test='sCustNm != null and sCustNm != ""'>
                        AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                   </if>  --고객명
                   <if test='sStatLst  != null and !sStatLst.isEmpty'>
                        AND A.STAT_CD IN
                       <foreach item="item" index="index" collection="sStatLst" open="(" separator="," close=")">
                           #{item}
                       </foreach>
                   </if>        --판매상태코드
                   <if test='sSalePrsnId != null and sSalePrsnId != ""'>
                        AND A.SALE_PRSN_ID = #{sSalePrsnId}
                   </if>        --담당자
                   <if test='sSaId != null and sSaId != ""'>
                        AND A.SA_ID = #{sSaId}
                   </if>        --SAID
                   <if test='sEstimateDtFr != null'>
                       AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
                   </if>
                   <if test='sEstimateDtTo != null'>
                       AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
                   </if>
    </select>

    <!-- 견적 정보 목록을 조회한다. -->
    <select id="selectEstimatesByCondition" parameterType="PartsSaleEstimateSearchVO" resultType="PartsSaleEstimateVO">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectEstimatesByCondition] */
        SELECT   A.*
          FROM (
            SELECT   ROWNUM AS RNUM
                   , T1.*
              FROM (
                SELECT
                        A.DLR_CD                    --딜러코드
                       ,A.ESTIMATE_DOC_NO           --부품판매견적번호
                       ,A.STAT_CD                   --견적상태코드
                       ,A.ESTIMATE_DT               --견적일자
                       ,A.CUST_TP                   --고객유형
                       ,A.CUST_NO                   --고객코드
                       ,A.CUST_NM                   --고객명
                       ,A.SALE_PRSN_ID                    --담당자
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SALE_PRSN_ID AND ENABLED_YN = 'Y' AND DEL_YN = 'N') AS SALE_PRSN_NM
                       ,A.SA_ID                    --SAID
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.SA_ID AND ENABLED_YN = 'Y' AND DEL_YN = 'N') AS SA_NM
                       ,A.REMARK                --비고
                       ,A.DC_RATE               --할인율
                       ,A.DC_BEF_TOT_AMT        --할인전총금액
                       ,A.DC_AMT                --할인금액
                       ,A.TOT_AMT               --총금액
                       ,A.REG_USR_ID              --등록자ID
                       ,A.REG_DT                  --등록일자
                       ,A.UPDT_USR_ID             --수정자ID
                       ,A.UPDT_DT                 --수정일자
                  FROM DMSDB.PT_0523T A    --견적헤더정보
                 WHERE A.DLR_CD           = #{sDlrCd}                 --딜러코드
                   <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                       AND A.ESTIMATE_DOC_NO like '%'|| #{sEstimateDocNo} ||'%'
                   </if>
                   <if test='sCustTp != null and sCustTp != ""'>
                       AND A.CUST_TP = #{sCustTp}
                   </if>        --고객유형
                   <if test='sCustNo != null and sCustNo != ""'>
                       AND A.CUST_NO  like '%'|| #{sCustNo} ||'%'
                   </if>        --운송유형
                   <if test='sCustNm != null and sCustNm != ""'>
                       AND A.CUST_NM  like '%'|| #{sCustNm} ||'%'
                   </if>        --운송유형
                   <if test='sEstimateDtFr != null'>
                        AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
                   </if>
                   <if test='sEstimateDtTo != null'>
                        AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
                   </if>
                 ORDER BY
                       A.DLR_CD ASC
                     ,A.ESTIMATE_DOC_NO DESC
                 ) T1
             ) A
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
                </if>
            </where>
    </select>

    <!-- 견적 정보 카운트를 조회한다. -->
    <select id="selectEstimatesByConditionCnt" parameterType="PartsSaleEstimateSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectEstimatesByConditionCnt] */
                SELECT count(*)
                  FROM DMSDB.PT_0523T A    --견적헤더정보
                 WHERE A.DLR_CD           = #{sDlrCd}                 --딜러코드
                   <if test='sEstimateDocNo != null and sEstimateDocNo != ""'>
                       AND A.ESTIMATE_DOC_NO like '%'|| #{sEstimateDocNo} ||'%'
                   </if>
                   <if test='sCustTp != null and sCustTp != ""'>
                       AND A.CUST_TP = #{sCustTp}
                   </if>        --고객유형
                   <if test='sCustNo != null and sCustNo != ""'>
                       AND A.CUST_NO  like '%'|| #{sCustNo} ||'%'
                   </if>        --운송유형
                   <if test='sEstimateDtFr != null'>
                        AND A.ESTIMATE_DT <![CDATA[>=]]> #{sEstimateDtFr}
                   </if>
                   <if test='sEstimateDtTo != null'>
                        AND A.ESTIMATE_DT <![CDATA[<=]]> #{sEstimateDtTo} + 1
                   </if>
    </select>

       <!-- 부품판매 정보 Max 라인번호를 조회한다. -->
    <select id="selectPartsSaleEstimateMaxLineNo" parameterType="PartsSaleEstimateVO" resultType="int">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateMaxLineNo] */
        SELECT max(A.ESTIMATE_DOC_LINE_NO) + 1
          FROM DMSDB.PT_0524T A    --판매부품정보
         WHERE A.DLR_CD               = #{dlrCd}                 --딜러코드
           AND A.ESTIMATE_DOC_NO      = #{estimateDocNo}
    </select>


    <!-- 부품판매 헤더 정보를 조회한다. -->
    <select id="selectPartsSaleEstimateUpdtDtByKey" parameterType="PartsSaleEstimateVO" resultType="String">
        /* [chn.bhmc.dms.par.ism.service.dao.PartsSaleEstimateDAO.selectPartsSaleEstimateUpdtDtByKey] */
        SELECT TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
          FROM DMSDB.PT_0523T A    --부품판매견적헤더정보
         WHERE A.DLR_CD             = #{dlrCd}
           AND A.ESTIMATE_DOC_NO    = #{estimateDocNo}
    </select>
</mapper>