<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.bat.sal.rcp.service.dao.BatchRcpRictVerifyDAO">

    <!-- 根据发票号码和发票代码查询机动车统一发票 -->
    <select id="selectReceipts" parameterType="java.util.Map" resultType="chn.bhmc.dms.bat.sal.rcp.vo.BatchRcpReceiptVO">
        SELECT CAR_ID, VIN_NO, RECEIPT_NO, RECEIPT_CD, RECEIPT_ISS_DT, SUM_AMT, RECEIPT_RESOURCE, RECEIPT_IN_RESOURCE, RECEIPT_STATUS, CERT_FST
        FROM SA_0501T
        <where>
            <if test="receiptNo != null and receiptNo != ''">
                AND RECEIPT_NO = #{receiptNo}
            </if>
            <if test="receiptCd != null and receiptCd != ''">
                AND RECEIPT_CD = #{receiptCd}
            </if>
        </where>
    </select>

    <!-- 批量添加验证通过的机动车统一发票数据 -->
    <insert id="insertRcpReceipts" parameterType="java.util.List">
        INSERT INTO SA_0501T (
            CAR_ID,
            VIN_NO,
            VIN_NO1,
            VIN_NO2,
            DLR_CD,
            TAXPAYER_ID_CD,
            RECEIPT_NO,
            RECEIPT_CD,
            RECEIPT_CUST_NM,
            SSN_CRN_NO,
            RECEIPT_ISS_DT,
            SCAN_VIN_NO,
            SUM_AMT,
            CERT_NO,
            ENGN_NO,
            SUM_INC_TAX,
            SUM_EXC_TAX,
            TAX_RT,
            TAX_AMT,
            MERCH_NM,
            ADDR,
            RECEIPT_IMG,
            TMR_CD,
            EVAL_RSLT_CD,
            ERR_UP_CD,
            REG_USR_ID,
            REG_DT,
            UPDT_USR_ID,
            UPDT_DT,
            SDLR_CD,
            TAX_CHK_YN,
            REMARK,
            CERT_FST,
            ORD_DLR_CD,
            TAX_SUNG_CD ,
            SDLR_TP,
            SDLR_NM,
            REMARKS,
            TEL_NO,
            UPLOAD_SHOP,
            SCAN_DT,
            RECEIPT_TYPE,
            CAR_TYPE,
            BRAND_MODEL,
            PROD_AREA,
            IMPORT_CERT_NO,
            COM_INS_NO,
            TON,
            LIMIT_NUM,
            ENT_NM,
            SEL_NM,
            SEL_TAXPAYER_ID_CD,
            SEL_ADDR,
            SEL_PHONE,
            SEL_BANK,
            SEL_BANK_NO,
            DRAWER,
            RECEIPT_RESOURCE,
            RECEIPT_IN_RESOURCE,
            RECEIPT_STATUS,
            BINDING_CAR_YN
        )
        <foreach collection="list" item="item" index="index" separator="union">
            select
                #{item.carId},
                #{item.vinNo},
                #{item.vinNo1},
                #{item.vinNo2},
                #{item.dlrCd},
                #{item.taxpayerIdCd},
                #{item.receiptNo},
                #{item.receiptCd},
                #{item.receiptCustNm},
                #{item.ssnCrnNo},
                #{item.receiptIssDt},
                #{item.scanVinNo},
                #{item.sumAmt},
                #{item.certNo},
                #{item.engnNo},
                #{item.sumIncTax},
                #{item.sumExcTax},
                #{item.taxRt},
                #{item.taxAmt},
                #{item.merchNm},
                #{item.addr},
                #{item.receiptImg},
                #{item.tmrCd},
                #{item.evalRsltCd},
                #{item.errUpCd},
                #{item.regUserId},
                #{item.regDt},
                #{item.updtUserId},
                #{item.updtDt},
                #{item.sdlrCd},
                #{item.taxChkYn},
                #{item.remark},
                #{item.certFst},
                #{item.ordDlrCd},
                #{item.taxSungCd},
                #{item.sdlrTp},
                #{item.sdlrNm},
                #{item.remarks},
                #{item.telNo},
                #{item.uploadShop},
                #{item.scanDt},
                #{item.receiptType},
                #{item.carType},
                #{item.brandModel},
                #{item.prodArea},
                #{item.importCertNo},
                #{item.comInsNo},
                #{item.ton},
                #{item.limitNum},
                #{item.entNm},
                #{item.selNm},
                #{item.selTaxpayerIdCd},
                #{item.selAddr},
                #{item.selPhone},
                #{item.selBank},
                #{item.selBankNo},
                #{item.drawer},
                #{item.receiptResource},
                #{item.receiptInResource},
                #{item.receiptStatus},
                #{item.bindingCarYn}
            from dual
        </foreach>
    </insert>

    <!-- 查询验证状态待验证，开票日期非当前日期的发票数据（SA_0501T、SA_0510T） -->
    <select id="selectVerifyList" parameterType="java.lang.String" resultType="chn.bhmc.dms.bat.sal.rcp.vo.BatchRcpRictVerifyVO">
        SELECT APP_RECEIPT_ID, RECEIPT_NO, RECEIPT_CD, RECEIPT_ISS_DT, SUM_AMT, RECEIPT_RESOURCE, RECEIPT_IN_RESOURCE, RECEIPT_STATUS, RECEIPT_IN_RESOURCE
        FROM SA_0510T
        WHERE CERT_FST = '3' AND RECEIPT_ISS_DT <![CDATA[<]]> #{VALUE}
        UNION
        SELECT CAR_ID AS APP_RECEIPT_ID, RECEIPT_NO, RECEIPT_CD, RECEIPT_ISS_DT, SUM_AMT, RECEIPT_RESOURCE, RECEIPT_IN_RESOURCE, RECEIPT_STATUS, RECEIPT_IN_RESOURCE
        FROM SA_0501T
        WHERE CERT_FST = '3' AND RECEIPT_ISS_DT <![CDATA[<]]> #{VALUE}
    </select>
    
    <!-- 批量修改APP扫码发票“验证状态、发票来源、发票状态” -->
    <update id="updateRcpAppReceiptVerifys" parameterType="java.util.List">
        MERGE INTO SA_0510T T1
        USING (
            <foreach collection="list" item="item" index="index" open="" close="" separator="UNION">
            SELECT
                #{item.certFst,jdbcType=VARCHAR} AS CERT_FST,
                #{item.receiptResource,jdbcType=VARCHAR} AS RECEIPT_RESOURCE,
                #{item.receiptStatus,jdbcType=VARCHAR} AS RECEIPT_STATUS,
                #{item.appReceiptId,jdbcType=VARCHAR} AS APP_RECEIPT_ID
            FROM DUAL
            </foreach>
        ) T2 ON (
            T1.APP_RECEIPT_ID = T2.APP_RECEIPT_ID
        )
        WHEN MATCHED THEN
            UPDATE SET
            T1.CERT_FST = T2.CERT_FST,
            T1.RECEIPT_RESOURCE = T2.RECEIPT_RESOURCE,
            T1.RECEIPT_STATUS = T2.RECEIPT_STATUS
    </update>
    
    <!-- 批量修改机动车统一发票“验证状态及新增加的字段” -->
    <update id="updateRcpReceiptVerifys" parameterType="java.util.List">
        MERGE INTO SA_0501T T1
        USING (
            <foreach collection="list" item="item" index="index" open="" close="" separator="UNION">
            SELECT
                #{item.receiptType,jdbcType=VARCHAR} AS RECEIPT_TYPE,
                #{item.carType,jdbcType=VARCHAR} AS CAR_TYPE,
                #{item.brandModel,jdbcType=VARCHAR} AS BRAND_MODEL,
                #{item.prodArea,jdbcType=VARCHAR} AS PROD_AREA,
                #{item.importCertNo,jdbcType=VARCHAR} AS IMPORT_CERT_NO,
                #{item.comInsNo,jdbcType=VARCHAR} AS COM_INS_NO,
                #{item.ton,jdbcType=VARCHAR} AS TON,
                #{item.limitNum,jdbcType=VARCHAR} AS LIMIT_NUM,
                #{item.entNm,jdbcType=VARCHAR} AS ENT_NM,
                #{item.selNm,jdbcType=VARCHAR} AS SEL_NM,
                #{item.selTaxpayerIdCd,jdbcType=VARCHAR} AS SEL_TAXPAYER_ID_CD,
                #{item.selAddr,jdbcType=VARCHAR} AS SEL_ADDR,
                #{item.selPhone,jdbcType=VARCHAR} AS SEL_PHONE,
                #{item.selBank,jdbcType=VARCHAR} AS SEL_BANK,
                #{item.selBankNo,jdbcType=VARCHAR} AS SEL_BANK_NO,
                #{item.drawer,jdbcType=VARCHAR} AS DRAWER,
                #{item.bindingCarYn,jdbcType=VARCHAR} AS BINDING_CAR_YN,
                #{item.certFst,jdbcType=VARCHAR} AS CERT_FST,
                #{item.receiptResource,jdbcType=VARCHAR} AS RECEIPT_RESOURCE,
                #{item.receiptStatus,jdbcType=VARCHAR} AS RECEIPT_STATUS,
                #{item.carId,jdbcType=VARCHAR} AS CAR_ID
            FROM DUAL
            </foreach>
        ) T2 ON (
            T1.CAR_ID = T2.CAR_ID
        )
        WHEN MATCHED THEN
            UPDATE SET
            T1.RECEIPT_TYPE = T2.RECEIPT_TYPE,
            T1.CAR_TYPE = T2.CAR_TYPE,
            T1.BRAND_MODEL = T2.BRAND_MODEL,
            T1.PROD_AREA = T2.PROD_AREA,
            T1.IMPORT_CERT_NO = T2.IMPORT_CERT_NO,
            T1.COM_INS_NO = T2.COM_INS_NO,
            T1.TON = T2.TON,
            T1.LIMIT_NUM = T2.LIMIT_NUM,
            T1.ENT_NM = T2.ENT_NM,
            T1.SEL_NM = T2.SEL_NM,
            T1.SEL_TAXPAYER_ID_CD = T2.SEL_TAXPAYER_ID_CD,
            T1.SEL_ADDR = T2.SEL_ADDR,
            T1.SEL_PHONE = T2.SEL_PHONE,
            T1.SEL_BANK = T2.SEL_BANK,
            T1.SEL_BANK_NO = T2.SEL_BANK_NO,
            T1.DRAWER = T2.DRAWER,
            T1.BINDING_CAR_YN = T2.BINDING_CAR_YN,
            T1.CERT_FST = T2.CERT_FST,
            T1.RECEIPT_RESOURCE = T2.RECEIPT_RESOURCE,
            T1.RECEIPT_STATUS = T2.RECEIPT_STATUS
    </update>
    
    <!-- 根据carId查询车辆信息 -->
    <select id="selectCarInfoByCarId" parameterType="String" resultType="chn.bhmc.dms.bat.sal.rcp.vo.BatchVehicleMasterVO">
         SELECT CAR_ID, TEMP4
         FROM SA_0121T
         WHERE CAR_ID = #{carId}
    </select>
    
    <!-- 数衍验证通过更新车辆“绑定发票标识”和“保修日期” -->
    <update id="updateCarAfterVerify" parameterType="chn.bhmc.dms.bat.sal.rcp.vo.BatchVehicleMasterVO">
        UPDATE SA_0121T
        <set>
            <if test="bindingReceiptFlag != null and bindingReceiptFlag != ''">
                BINDING_RECEIPT_FLAG = #{bindingReceiptFlag},
            </if>
            <if test="grteStartDt != null">
                GRTE_START_DT = #{grteStartDt},
            </if>
        </set>
        WHERE CAR_ID = #{carId}
    </update>

</mapper>