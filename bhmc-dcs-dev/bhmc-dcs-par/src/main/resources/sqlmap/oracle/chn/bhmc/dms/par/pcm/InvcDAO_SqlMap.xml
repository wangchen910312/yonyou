<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : InvcDAO_SqlMap.xml
    Description : 송장.
    author Ju Won Lee
    since 2016. 1. 29.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 01. 29.     Ju Won Lee     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.pcm.service.dao.InvcDAO">

    <!-- 송장 정보 목록을 조회한다. -->
    <select id="selectInvcsByCondition" parameterType="InvcSearchVO" resultType="InvcVO">
    /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcsByCondition] */
        SELECT
            A.*
        FROM (
            SELECT
                ROWNUM AS RNUM
                ,T1.*
            FROM (
                SELECT
                    A.DLR_CD               --딜러코드
                    ,F.DLR_NM               --딜러코드
                    ,A.INVC_DOC_NO          --송장문서번호
                    ,A.INVC_TP              --송장유형
                    ,A.INVC_DSTIN_CD        --송장구분코드
                    ,A.INVC_STAT_CD         --송장상태코드
                    ,A.INVC_DT              --송장일자
                    ,A.ARRV_DT              --도착일자
                    ,TO_CHAR(A.ARRV_DT, 'YYYYMMDD') AS ARRV_DT_CHAR              --등록일자
                    ,TO_CHAR(A.ARRV_DT, 'HH24MISS') AS ARRV_TM_CHAR              --등록일자
                    ,A.CONFIRM_DT           --확정일자
                    ,A.PLT_CD               --센터코드
                    ,A.BP_CD                --거래처코드
                    ,A.MOBIS_INVC_NO        --모비스송장번호
                    ,A.CURR_CD              --통화코드
                    ,E.INVC_TOT_AMT AS PURC_INC_TAX_AMT         --송장총금액
                    ,E.INVC_TOT_AMT         --송장총금액
                    ,A.VAT_CD               --부가세코드
                    ,A.VAT_AMT              --부가세금액
                    ,A.REMARK               --비고
                    ,A.CANC_YN              --취소여부
                    ,A.REG_USR_ID           --등록자ID
                    ,A.REG_DT               --등록일자
                    ,TO_CHAR(A.REG_DT, 'YYYYMMDD')  AS REG_DT_CHAR              --등록일자
                    ,A.UPDT_USR_ID          --수정자ID
                    ,A.UPDT_DT              --수정일자
                    ,A.IF_YN                --인터페이스여부
                    ,NVL(A.INVC_TOTAL_LINE, B.ITEM_CNT) AS INVC_TOTAL_LINE
                    ,NVL(A.INVC_SUM_QT, B.ITEM_QTY) AS INVC_SUM_QT
                    ,A.INVC_AMT_CUR
                    ,A.INVC_TSP_CODE
                    ,A.INVC_CSE_CNT
                    ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
                FROM DMSDB.PT_0431T A    --송장문서헤더정보
                INNER JOIN (
                    SELECT
                        A.DLR_CD
                        ,A.INVC_DOC_NO
                        ,COUNT(*) AS ITEM_CNT
                        ,SUM(A.INVC_QTY) AS ITEM_QTY
                    FROM DMSDB.PT_0432T A
                    INNER JOIN DMSDB.PT_0201T C ON A.ITEM_CD = C.ITEM_CD
                    GROUP BY A.DLR_CD, A.INVC_DOC_NO
                ) B
                ON A.DLR_CD       = B.DLR_CD
                AND A.INVC_DOC_NO  = B.INVC_DOC_NO
                INNER JOIN (
                    SELECT
                        A.DLR_CD
                        ,A.INVC_DOC_NO
                        ,SUM(A.INVC_TOT_AMT) AS INVC_TOT_AMT
                    FROM DMSDB.PT_0432T A
                    GROUP BY A.DLR_CD, A.INVC_DOC_NO
                ) E
                ON A.DLR_CD       = E.DLR_CD
                AND A.INVC_DOC_NO  = E.INVC_DOC_NO
                INNER JOIN CM_0101T F ON A.DLR_CD = F.DLR_CD
                WHERE A.CANC_YN != 'Y'
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}
                </if>
                <if test='sDlrNm != null and sDlrNm != ""'>
                    AND F.DLR_NM LIKE '%'||#{sDlrNm}||'%'
                </if>
                <if test='sInvcDtFr != null'>
                    AND A.INVC_DT <![CDATA[>=]]> #{sInvcDtFr}
                </if>
                <if test='sInvcDtTo != null'>
                    AND A.INVC_DT <![CDATA[<]]> #{sInvcDtTo} + 1
                </if>
                <if test='sConfirmDtFr != null'>
                    AND A.CONFIRM_DT <![CDATA[>=]]> #{sConfirmDtFr}
                </if>
                <if test='sConfirmDtTo != null'>
                    AND A.CONFIRM_DT <![CDATA[<]]> #{sConfirmDtFr} + 1
                </if>
                <if test='sMobisInvcNo != null and sMobisInvcNo != ""'>
                    AND A.MOBIS_INVC_NO LIKE '%'||#{sMobisInvcNo}||'%'
                </if>
                <if test='sInvcStatCd != null and sInvcStatCd != ""'>
                    AND A.INVC_STAT_CD  = #{sInvcStatCd}
                </if>
                ORDER BY A.DLR_CD ASC, A.INVC_DT DESC
            ) T1
        ) A
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 송장 정보 카운트를 조회한다. -->
    <select id="selectInvcsByConditionCnt" parameterType="InvcSearchVO" resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcsByConditionCnt] */
        SELECT
            COUNT(*)
        FROM (
            SELECT
                A.DLR_CD               --딜러코드
                ,F.DLR_NM               --딜러코드
                ,A.INVC_DOC_NO          --송장문서번호
                ,A.INVC_TP              --송장유형
                ,A.INVC_DSTIN_CD        --송장구분코드
                ,A.INVC_STAT_CD         --송장상태코드
                ,A.INVC_DT              --송장일자
                ,A.ARRV_DT              --도착일자
                ,TO_CHAR(A.ARRV_DT, 'YYYYMMDD') AS ARRV_DT_CHAR              --등록일자
                ,TO_CHAR(A.ARRV_DT, 'HH24MISS') AS ARRV_TM_CHAR              --등록일자
                ,A.CONFIRM_DT           --확정일자
                ,A.PLT_CD               --센터코드
                ,A.BP_CD                --거래처코드
                ,A.MOBIS_INVC_NO        --모비스송장번호
                ,A.CURR_CD              --통화코드
                ,E.INVC_TOT_AMT AS PURC_INC_TAX_AMT         --송장총금액
                ,E.INVC_TOT_AMT         --송장총금액
                ,A.VAT_CD               --부가세코드
                ,A.VAT_AMT              --부가세금액
                ,A.REMARK               --비고
                ,A.CANC_YN              --취소여부
                ,A.REG_USR_ID           --등록자ID
                ,A.REG_DT               --등록일자
                ,TO_CHAR(A.REG_DT, 'YYYYMMDD')  AS REG_DT_CHAR              --등록일자
                ,A.UPDT_USR_ID          --수정자ID
                ,A.UPDT_DT              --수정일자
                ,A.IF_YN                --인터페이스여부
                ,NVL(A.INVC_TOTAL_LINE, B.ITEM_CNT) AS INVC_TOTAL_LINE
                ,NVL(A.INVC_SUM_QT, B.ITEM_QTY) AS INVC_SUM_QT
                ,A.INVC_AMT_CUR
                ,A.INVC_TSP_CODE
                ,A.INVC_CSE_CNT
                ,TO_CHAR(NVL(A.UPDT_DT,A.REG_DT), 'YYYYMMDDHH24MISS') AS UPDT_DT_STR
            FROM DMSDB.PT_0431T A    --송장문서헤더정보
            INNER JOIN (
                SELECT
                    A.DLR_CD
                    ,A.INVC_DOC_NO
                    ,COUNT(*) AS ITEM_CNT
                    ,SUM(A.INVC_QTY) AS ITEM_QTY
                FROM DMSDB.PT_0432T A
                INNER JOIN DMSDB.PT_0201T C ON A.ITEM_CD = C.ITEM_CD
                GROUP BY A.DLR_CD, A.INVC_DOC_NO
            ) B
            ON A.DLR_CD       = B.DLR_CD
            AND A.INVC_DOC_NO  = B.INVC_DOC_NO
            INNER JOIN (
                SELECT
                    A.DLR_CD
                    ,A.INVC_DOC_NO
                    ,SUM(A.INVC_TOT_AMT) AS INVC_TOT_AMT
                FROM DMSDB.PT_0432T A
                GROUP BY A.DLR_CD, A.INVC_DOC_NO
            ) E
            ON A.DLR_CD       = E.DLR_CD
            AND A.INVC_DOC_NO  = E.INVC_DOC_NO
            INNER JOIN CM_0101T F ON A.DLR_CD = F.DLR_CD
            WHERE A.CANC_YN != 'Y'
            <if test='sDlrCd != null and sDlrCd != ""'>
                AND A.DLR_CD = #{sDlrCd}
            </if>
            <if test='sDlrNm != null and sDlrNm != ""'>
                AND F.DLR_NM LIKE '%'||#{sDlrNm}||'%'
            </if>
            <if test='sInvcDtFr != null'>
                AND A.INVC_DT <![CDATA[>=]]> #{sInvcDtFr}
            </if>
            <if test='sInvcDtTo != null'>
                AND A.INVC_DT <![CDATA[<]]> #{sInvcDtTo} + 1
            </if>
            <if test='sConfirmDtFr != null'>
                AND A.CONFIRM_DT <![CDATA[>=]]> #{sConfirmDtFr}
            </if>
            <if test='sConfirmDtTo != null'>
                AND A.CONFIRM_DT <![CDATA[<]]> #{sConfirmDtTo} + 1
            </if>
            <if test='sMobisInvcNo != null and sMobisInvcNo != ""'>
                AND A.MOBIS_INVC_NO LIKE '%'||#{sMobisInvcNo}||'%'
            </if>
            <if test='sInvcStatCd != null and sInvcStatCd != ""'>
                AND A.INVC_STAT_CD  = #{sInvcStatCd}
            </if>
            ORDER BY A.DLR_CD ASC, A.INVC_DT DESC
        ) T1
    </select>

    <!-- 송장 부품 정보를 조회한다. -->
    <select id="selectInvcsDetailByCondition" parameterType="InvcSearchVO" resultType="InvcItemVO">
    /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcsDetailByCondition] */
     SELECT
            A.*
        FROM (
            SELECT
                ROWNUM AS RNUM
                ,T1.*
            FROM (
                 SELECT  B.DLR_CD                          --딜러코드
                        ,B.INVC_DOC_NO                     --송장문서번호
                        ,B.INVC_DOC_LINE_NO                --송장문서라인번호
                        ,B.MOBIS_INVC_NO                   --모비스송장번호
                        ,B.MOBIS_INVC_LINE_NO              --모비스송장라인번호
                        ,B.PURC_ORD_NO                     --구매오더번호
                        ,B.INVC_IF_ORD_NO                  --I/F 구매오더번호
                        ,B.INVC_IF_ORD_LN                  --I/F 구매오더라인번호
                        ,B.PURC_ORD_LINE_NO                --구매오더라인번호
                        ,B.PURC_ORD_LINE_DETL_NO          --구매오더라인구분자
                        ,B.ITEM_CD                         --품목코드
                        ,C.ITEM_NM                         --품목명
                        ,B.INVC_QTY                        --송장수량
                        ,B.INVC_UNIT_CD                    --송장단위코드
                        ,B.INVC_PRC                        --송장단가
                        ,B.TAX_DDCT_PRC                    --세금공제단가
                        ,B.INVC_AMT                        --송장금액
                        ,B.VAT_AMT                         --부가세금액
                        ,B.INVC_TOT_AMT                    --송장총금액
                        ,to_date(to_char(D.OHR_ORD_RCVE_DT),'yyyy-mm-dd') AS PURC_REG_DT
                        ,D.OHR_ORD_TYP AS PURC_ORD_TP
                        ,(select bp_nm from pt_0211t where bp_cd = C.BP_CD and rownum = 1) as BP_CD
                        ,B.CLAIM_QTY                       --클레임 수량
                        ,B.DEBIT_CREDIT_DSTIN_CD           --차변대변구분코드
                        ,B.REF_INVC_DOC_NO                 --참조송장문서번호
                        ,B.REF_INVC_DOC_LINE_NO            --참조송장문서라인번호
                        ,B.DL_PDC_CD                       --배송PDC코드
                        ,B.GR_STRGE_CD                     --입고창고코드
                        ,B.GR_LOC_CD                       --입고위치코드
                        ,B.INVC_GR_DT                      --송장입고일자
                        --,B.REQ_CONT                        --차이사유
                        ,NVL(F.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY           --가용재고
                        ,NVL(F.BORROW_QTY,0) AS BORROW_QTY               --차입
                        ,NVL(F.RENT_QTY,0) AS RENT_QTY                 --대여수량
                        ,NVL(F.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY                 --예류수량
                        ,NVL(F.AVLB_STOCK_QTY,0) + NVL(F.RESV_STOCK_QTY,0) - NVL(F.BORROW_QTY,0) + NVL(F.RENT_QTY,0) AS STOCK_QTY
                FROM PT_0431T A
                INNER JOIN PT_0432T B ON A.DLR_CD = B.DLR_CD AND A.INVC_DOC_NO = B.INVC_DOC_NO
                INNER JOIN PT_0201T C ON B.ITEM_CD = C.ITEM_CD
                INNER JOIN PT_0421I D ON A.DLR_CD = D.OHR_DLR_CD AND B.INVC_IF_ORD_NO = D.OHR_ORD_NO
                INNER JOIN CM_0101T E ON A.DLR_CD = E.DLR_CD
                LEFT OUTER JOIN PT_0301T F
                  ON B.DLR_CD = F.DLR_CD
                 AND B.GR_STRGE_CD  = F.STRGE_CD
                 AND B.ITEM_CD = F.ITEM_CD
               WHERE 1=1
               <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}
                </if>
               <if test='sDlrNm != null and sDlrNm != ""'>
                   AND E.DLR_NM LIKE '%'|| #{sDlrNm} || '%'
               </if>
               <if test='sMobisInvcNo != null and sMobisInvcNo != ""'>
                   AND B.MOBIS_INVC_NO LIKE '%'|| #{sMobisInvcNo} || '%'
               </if>        --모비스송장번호
               <if test='sInvcDtFr != null'>
                    AND A.INVC_DT <![CDATA[>=]]> #{sInvcDtFr}
                </if>
                <if test='sInvcDtTo != null'>
                    AND A.INVC_DT <![CDATA[<]]> #{sInvcDtTo} + 1
                </if>
                <if test='sConfirmDtFr != null'>
                    AND A.CONFIRM_DT <![CDATA[>=]]> #{sConfirmDtFr}
                </if>
                <if test='sConfirmDtTo != null'>
                    AND A.CONFIRM_DT <![CDATA[<]]> #{sConfirmDtTo} + 1
                </if>
                <if test='sInvcStatCd != null and sInvcStatCd != ""'>
                    AND A.INVC_STAT_CD  = #{sInvcStatCd}
                </if>
                ORDER BY A.DLR_CD ASC, A.INVC_DOC_NO ASC, B.INVC_DOC_LINE_NO ASC
         ) T1
        ) A
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 송장 부품 정보 카운트를 조회 한다. -->
    <select id="selectInvcsDetailByConditionCnt" parameterType="InvcSearchVO" resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.InvcDAO.selectInvcsDetailByConditionCnt] */
        SELECT
        COUNT(*)
        FROM (
            SELECT
            B.DLR_CD                          --딜러코드
            ,B.INVC_DOC_NO                     --송장문서번호
            ,B.INVC_DOC_LINE_NO                --송장문서라인번호
            ,B.MOBIS_INVC_NO                   --모비스송장번호
            ,B.MOBIS_INVC_LINE_NO              --모비스송장라인번호
            ,B.PURC_ORD_NO                     --구매오더번호
            ,B.INVC_IF_ORD_NO                  --I/F 구매오더번호
            ,B.INVC_IF_ORD_LN                  --I/F 구매오더라인번호
            ,B.PURC_ORD_LINE_NO                --구매오더라인번호
            ,B.PURC_ORD_LINE_DETL_NO          --구매오더라인구분자
            ,B.ITEM_CD                         --품목코드
            ,C.ITEM_NM                         --품목명
            ,B.INVC_QTY                        --송장수량
            ,B.INVC_UNIT_CD                    --송장단위코드
            ,B.INVC_PRC                        --송장단가
            ,B.TAX_DDCT_PRC                    --세금공제단가
            ,B.INVC_AMT                        --송장금액
            ,B.VAT_AMT                         --부가세금액
            ,B.INVC_TOT_AMT                    --송장총금액
            ,to_date(to_char(D.OHR_ORD_RCVE_DT),'yyyy-mm-dd') AS PURC_REG_DT
            ,D.OHR_ORD_TYP AS PURC_ORD_TP
            --,C.BP_CD
            ,B.CLAIM_QTY                       --클레임 수량
            ,B.DEBIT_CREDIT_DSTIN_CD           --차변대변구분코드
            ,B.REF_INVC_DOC_NO                 --참조송장문서번호
            ,B.REF_INVC_DOC_LINE_NO            --참조송장문서라인번호
            ,B.DL_PDC_CD                       --배송PDC코드
            ,B.GR_STRGE_CD                     --입고창고코드
            ,B.GR_LOC_CD                       --입고위치코드
            ,B.INVC_GR_DT                      --송장입고일자
            --,B.REQ_CONT                        --차이사유
            ,NVL(F.AVLB_STOCK_QTY,0) AS AVLB_STOCK_QTY           --가용재고
            ,NVL(F.BORROW_QTY,0) AS BORROW_QTY               --차입
            ,NVL(F.RENT_QTY,0) AS RENT_QTY                 --대여수량
            ,NVL(F.RESV_STOCK_QTY,0) AS RESV_STOCK_QTY                 --예류수량
            ,NVL(F.AVLB_STOCK_QTY,0) + NVL(F.RESV_STOCK_QTY,0) - NVL(F.BORROW_QTY,0) + NVL(F.RENT_QTY,0) AS STOCK_QTY
            FROM PT_0431T A
            INNER JOIN PT_0432T B ON A.DLR_CD = B.DLR_CD AND A.INVC_DOC_NO = B.INVC_DOC_NO
            INNER JOIN PT_0201T C ON B.ITEM_CD = C.ITEM_CD
            INNER JOIN PT_0421I D ON A.DLR_CD = D.OHR_DLR_CD AND B.INVC_IF_ORD_NO = D.OHR_ORD_NO
            INNER JOIN CM_0101T E ON A.DLR_CD = E.DLR_CD
            LEFT OUTER JOIN PT_0301T F
              ON B.DLR_CD = F.DLR_CD
             AND B.GR_STRGE_CD  = F.STRGE_CD
             AND B.ITEM_CD = F.ITEM_CD
            WHERE 1=1
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD = #{sDlrCd}
                </if>
               <if test='sDlrNm != null and sDlrNm != ""'>
                   AND E.DLR_NM LIKE '%'|| #{sDlrNm} || '%'
               </if>
               <if test='sMobisInvcNo != null and sMobisInvcNo != ""'>
                   AND B.MOBIS_INVC_NO LIKE '%'|| #{sMobisInvcNo} || '%'
               </if>        --모비스송장번호
               <if test='sInvcDtFr != null'>
                    AND A.INVC_DT <![CDATA[>=]]> #{sInvcDtFr}
                </if>
                <if test='sInvcDtTo != null'>
                    AND A.INVC_DT <![CDATA[<]]> #{sInvcDtTo} + 1
                </if>
                <if test='sConfirmDtFr != null'>
                    AND A.CONFIRM_DT <![CDATA[>=]]> #{sConfirmDtFr}
                </if>
                <if test='sConfirmDtTo != null'>
                    AND A.CONFIRM_DT <![CDATA[<]]> #{sConfirmDtTo} + 1
                </if>
                <if test='sInvcStatCd != null and sInvcStatCd != ""'>
                    AND A.INVC_STAT_CD  = #{sInvcStatCd}
                </if>
        ) T1
    </select>
</mapper>