<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : PurcOrdDAO_SqlMap.xml
    Description : 구매요청.
    author In Bo Shim
    since 2016. 1. 29.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 01. 29.     In Bo Shim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO">

    <!-- 구매오더 정보 목록을 조회한다. -->
    <select id="selectPurcOrdsByCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdVO">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdsByCondition] */
        SELECT
        T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            FROM (
                SELECT
                F.*
                FROM (
                    SELECT
                    E.OHR_DLR_CD AS DLR_CD
                    ,MAX(E.DLR_NM) AS DLR_NM
                    ,E.OHR_ORD_NO AS BMP_ORD_NO
                    ,MAX(E.OHR_DLR_ORD_NO) AS PURC_ORD_NO
                    ,MAX(E.OHR_ORD_RCVE_DT) AS PURC_REG_DT
                    ,CASE WHEN MAX(E.OHR_ORD_AMT) = 0 THEN MAX(E.OHR_CFM_ITM) ELSE MAX(E.OHR_ORD_ITM) END ITEM_CNT
                    
                    ---liuxueying update 顾松dcs和dms订单总金额和订单含税金额数量不一致 start ---
                    ---,SUM(E.ODR_CFM_QT) AS TOT_PURC_QTY                 
                    ,SUM(E.CALC_CONFIRM_QTY) AS TOT_PURC_QTY
                    ---,SUM(CASE WHEN E.ODR_CFM_QT - E.ODR_XCL_QT <![CDATA[>]]> 0 THEN E.ODR_CFM_QT - E.ODR_XCL_QT ELSE E.ODR_ODR_QT END * (E.ODR_UPCE_NDP + E.ODR_VAT_AMT)) AS TOT_PURC_AMT
                    ,SUM(PURC_AMT) AS TOT_PURC_AMT
                    ---,MAX(E.OHR_CFM_AMT) AS TOT_TAX_DDCT_AMT
                    ,sum(E.CALC_TAX_DDCT_AMT) AS TOT_TAX_DDCT_AMT
                    ---liuxueying update end --------
                    
                    ,SUM(CASE WHEN E.ODR_CFM_APL_FLG = 'N' THEN 1 ELSE 0 END) AS ALL_CANC_CHK
                    ,'03' AS PURC_ORD_STAT_CD
                    ,MAX(E.OHR_ORD_TYP) AS PURC_ORD_TP
                    FROM (
                        SELECT
                        D.*
                        ,C.*
                        ,CASE WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('C','D','Y') 
                                THEN
                                     CASE WHEN ODR_CFM_QT - ODR_XCL_QT > 0 THEN ROUND((ODR_CFM_QT - ODR_XCL_QT) * Odr_Upce_Ndp,2) ELSE 0 END 
                                          WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('X','Z') 
                                           THEN CASE WHEN NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0) > 0 THEN ROUND(Odr_Upce_Ndp * (NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0)),2) ELSE 0 END -- CHECK ??? ??? : ??*???? , ??? : 0
                                          ELSE round(nvl(Odr_Upce_Ndp,0) * nvl(ODR_CFM_QT,0),2) END  CALC_TAX_DDCT_AMT
                                            
                        ,CASE WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END)  IN ('C','D','Y') 
                                THEN 
                                     CASE WHEN NVL(ODR_CFM_QT,0) > 0 THEN ODR_CFM_QT - NVL(ODR_XCL_QT,0) ELSE 0 END
                                          WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END)  IN ('X','Z') 
                                           THEN NVL(NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0),0)
                                          ELSE ODR_CFM_QT END CALC_CONFIRM_QTY
                        ,CASE WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('C','D','Y') THEN
                                               CASE WHEN ODR_CFM_QT - NVL(ODR_XCL_QT,0) > 0 
                                                 THEN ROUND((ODR_CFM_QT - 
                                                      NVL(ODR_XCL_QT,0)) * (Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)),2) ELSE 0 END
                                           WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('X','Z') THEN
                                                CASE WHEN NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0) > 0
                                                       THEN ROUND((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * (NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0)),2)
                                                    ELSE 0 END
                                              ELSE  round((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * Nvl(ODR_CFM_QT,0),2) END PURC_AMT
                        FROM (
                            SELECT
                            A.*
                            ,B.DLR_NM
                            FROM 
                             (
                                SELECT
                                *
                                FROM CM_0101T
                                WHERE DMS_USE_YN = 'Y'
                                AND OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                                <if test='sDlrCd != null and sDlrCd != ""'>
                                    AND DLR_CD = #{sDlrCd}
                                </if>
                                <if test='sDlrNm != null and sDlrNm != ""'>
                                    AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                                </if>
                            ) B INNER JOIN PT_0421I A
                            ON A.OHR_DLR_CD = B.DLR_CD
                            WHERE 1=1 
                             <if test='sPurcRegDtFr != null'>
			                    AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
			                </if>
			                <if test='sPurcRegDtTo != null'>
			                    AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
			                </if>
                            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                                AND A.OHR_ORD_NO = #{sBmpOrdNo}
                            </if>
                            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                                AND A.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                            </if>
                        ) D INNER JOIN  PT_0422I C
                        ON C.ODR_ODR_NO = D.OHR_ORD_NO
                    ) E
                    GROUP BY E.OHR_DLR_CD, E.OHR_ORD_NO
                ) F
                WHERE F.ITEM_CNT - F.ALL_CANC_CHK != 0
                <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
                    AND F.PURC_ORD_STAT_CD IN
                    <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                </if>
                <!--  <if test='sPurcRegDtFr != null'>
                    AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                </if>
                <if test='sPurcRegDtTo != null'>
                    AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                </if>-->
                ORDER BY F.DLR_CD ASC ,F.PURC_REG_DT DESC
            )T1
        )T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 구매오더 정보 카운트를 조회한다. -->
    <select id="selectPurcOrdsByConditionCnt" parameterType="PurcOrdSearchVO" resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdsByConditionCnt] */
        SELECT
        COUNT(*)
        FROM (
            SELECT
            E.OHR_DLR_CD AS DLR_CD
            ,MAX(E.DLR_NM) AS DLR_NM
            ,E.OHR_ORD_NO AS BMP_ORD_NO
            ,MAX(E.OHR_DLR_ORD_NO) AS PURC_ORD_NO
            ,MAX(E.OHR_ORD_RCVE_DT) AS PURC_REG_DT
            ,CASE WHEN MAX(E.OHR_ORD_AMT) = 0 THEN MAX(E.OHR_CFM_ITM) ELSE MAX(E.OHR_ORD_ITM) END ITEM_CNT
            ---,SUM(E.ODR_CFM_QT) AS TOT_PURC_QTY
            ---,SUM(CASE WHEN E.ODR_CFM_QT - E.ODR_XCL_QT <![CDATA[>]]> 0 THEN E.ODR_CFM_QT - E.ODR_XCL_QT ELSE E.ODR_ODR_QT END * (E.ODR_UPCE_NDP + E.ODR_VAT_AMT)) AS TOT_PURC_AMT
            ---,MAX(E.OHR_CFM_AMT) AS TOT_TAX_DDCT_AMT
            ,SUM(CASE WHEN E.ODR_CFM_APL_FLG = 'N' THEN 1 ELSE 0 END) AS ALL_CANC_CHK
            ,'03' AS PURC_ORD_STAT_CD
            FROM (
                SELECT
                D.*
                ,C.*
                FROM 
                 (
                    SELECT
                    A.*
                    ,B.DLR_NM
                    FROM 
                     (
                        SELECT
                        *
                        FROM CM_0101T
                        WHERE DMS_USE_YN = 'Y'
                        AND OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                        <if test='sDlrCd != null and sDlrCd != ""'>
                            AND DLR_CD = #{sDlrCd}
                        </if>
                        <if test='sDlrNm != null and sDlrNm != ""'>
                            AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                        </if>
                    ) B INNER JOIN PT_0421I A
                    ON A.OHR_DLR_CD = B.DLR_CD
                    WHERE 1=1
                    <if test='sPurcRegDtFr != null'>
	                    AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
	                </if>
	                <if test='sPurcRegDtTo != null'>
	                    AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
	                </if>
                    <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                        AND A.OHR_ORD_NO = #{sBmpOrdNo}
                    </if>
                    <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                        AND A.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                    </if>
                ) D INNER JOIN PT_0422I C
                ON C.ODR_ODR_NO = D.OHR_ORD_NO
            ) E
            GROUP BY E.OHR_DLR_CD, E.OHR_ORD_NO
        ) F
        WHERE F.ITEM_CNT - F.ALL_CANC_CHK != 0
        <if test='sPurcOrdStatLst != null and !sPurcOrdStatLst.isEmpty'>
            AND F.PURC_ORD_STAT_CD IN
            <foreach item="item" index="index" collection="sPurcOrdStatLst" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <!-- 구매현황 데이타 정보를 조회한다.. -->
    <select id="selectPurcOrdStatusByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusByCondition] */
        SELECT
        T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            FROM (
                SELECT
                D.OHR_DLR_CD AS DLR_CD
                ,D.DLR_NM AS DLR_NM
                ,D.OHR_ORD_NO AS BMP_ORD_NO
                ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
                ,E.ITEM_NM AS ITEM_NM
                ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
                ,C.ODR_LST_BO_QT AS BO_QTY
                ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
                ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS BMP_PURC_PRC
                ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
                ,C.ODR_ETD AS ARRV_DT
                ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
                ,'03' AS PURC_ITEM_STAT_CD
                ,C.ODR_ALC_QT
                ,C.ODR_OPIC_QT
                ,C.ODR_OPAC_QT
                ,C.ODR_PAKD_QT
                ,C.ODR_INV_QT
                FROM PT_0422I C INNER JOIN(
                    SELECT
                    A.*
                    ,B.DLR_NM
                    ,B.OPEN_DT
                    FROM PT_0421I A INNER JOIN (
                        SELECT
                        *
                        FROM CM_0101T
                        WHERE DMS_USE_YN = 'Y'
                        AND OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                        <if test='sDlrCd != null and sDlrCd != ""'>
                            AND DLR_CD = #{sDlrCd}
                        </if>
                        <if test='sDlrNm != null and sDlrNm != ""'>
                            AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                        </if>
                    ) B
                    ON A.OHR_DLR_CD = B.DLR_CD
                    
                    <where> 
                        TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD') >= CASE WHEN LENGTH(B.OPEN_DT) = 8 THEN TO_DATE(TO_CHAR(ADD_MONTHS(TO_DATE(B.OPEN_DT,'YYYY-MM-DD'),-2),'YYYYMM')||'01','YYYY-MM-DD')  else null end
                        <if test='sPurcRegDtFr != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                        <if test='sPurcRegDtTo != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                        <if test='sConfirmFr != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                        </if>
                        <if test='sConfirmTo != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                    </where>
                ) D 
                ON C.ODR_ODR_NO = D.OHR_ORD_NO
                
                LEFT JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
                WHERE C.ODR_CFM_APL_FLG != 'N'
                AND C.ODR_LST_BO_QT <![CDATA[>]]> 0
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
               ORDER BY D.OHR_DLR_CD ASC
                         ,D.OHR_ORD_RCVE_DT DESC
                         ,D.OHR_DLR_ORD_NO DESC
                         ,C.ODR_ODR_LN ASC
            ) T1 
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <select id="selectPurcOrdStatusByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
      SELECT COUNT(*) FROM PT_0422I C  INNER JOIN (
                SELECT
                A.*
                ,B.OPEN_DT
                ,B.DLR_NM
                FROM  PT_0421I A INNER JOIN (
                    SELECT
                    *
                    FROM CM_0101T
                    WHERE DMS_USE_YN = 'Y'
                    AND OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                ) B 
                ON A.OHR_DLR_CD = B.DLR_CD
                <where> 
                    TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD') >= CASE WHEN LENGTH(B.OPEN_DT) = 8 THEN TO_DATE(TO_CHAR(ADD_MONTHS(TO_DATE(B.OPEN_DT,'YYYY-MM-DD'),-2),'YYYYMM')||'01','YYYY-MM-DD')  else null end
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
            ) D 
            ON C.ODR_ODR_NO = D.OHR_ORD_NO
            
            LEFT JOIN (
                SELECT
                ITEM_CD
                ,ITEM_NM
                FROM PT_0201T
            ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
            WHERE C.ODR_CFM_APL_FLG != 'N'
            AND C.ODR_LST_BO_QT <![CDATA[>]]> 0
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
            </if>
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND D.OHR_ORD_NO = #{sBmpOrdNo}
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
            </if>
            <if test='sItemNm != null and sItemNm != ""'>
                AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
            </if>
    </select>

    <!-- 구매현황 정보 목록을 조회한다. -->
    <select id="selectPurcOrdStatusDetailByCondition" parameterType="PurcOrdSearchVO" resultType="PurcOrdItemVO">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusDetailByCondition] */
        SELECT
        T1.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,F.*
            FROM (
                SELECT
                D.OHR_ORD_TYP AS PURC_ORD_TP
                ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
                ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
                ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
                ,D.OHR_ORD_NO AS BMP_ORD_NO
                ,'A10AA001' AS BP_CD
                ,'BMP' AS BP_NM
                ,(SELECT ITEM_NM FROM PT_0201T WHERE ITEM_CD = TRIM(C.ODR_ODR_PNO)) AS ITEM_NM
                ,TRIM(C.ODR_ODR_PNO) AS ITEM_CD
                ,TRIM(C.ODR_CFM_PNO) AS CONFIRM_PAR_NO
                ,C.ODR_ODR_QT AS PURC_QTY
                ,C.ODR_CFM_QT AS CONFIRM_QTY
                ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS PURC_PRC
                ,CASE WHEN SUBSTR(D.OHR_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') THEN D.PDC ELSE 'PD'||SUBSTR(D.OHR_ORD_NO,6,1) END DL_DIST_CD
                ,CASE WHEN C.ODR_ODR_SF IN ('C','D','Y') THEN
                            CASE WHEN C.ODR_CFM_QT <![CDATA[>]]> 0 THEN C.ODR_CFM_QT - C.ODR_XCL_QT ELSE 0 END
                      WHEN C.ODR_ODR_SF IN ('X','Z') THEN NVL(C.ODR_SHP_QT,0) + NVL(C.ODR_ALC_QT,0) + NVL(C.ODR_OPIC_QT,0) + NVL(C.ODR_OPAC_QT,0) + NVL(C.ODR_PAKD_QT,0) + NVL(C.ODR_INV_QT,0)
                 ELSE C.ODR_CFM_QT
                 END CALC_CONFIRM_QTY
                ,C.ODR_XCL_QT AS CANC_REQ_QTY
                ,C.ODR_LST_AMCD AS EDIT_CD
                ,C.ODR_LST_BO_QT AS BO_QTY
                ,C.ODR_ALC_QT
                ,C.ODR_OPIC_QT
                ,C.ODR_OPAC_QT
                ,C.ODR_PAKD_QT
                ,C.ODR_INV_QT
                ,E.MOBIS_INVC_NO
                ,E.BOX_NO
                ,D.OHR_TRN_MODE AS TRSF_TP
                ,'' AS TRSF_USR_ID
                ,E.INVC_DT
                ,E.ARRV_DT
                ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
                ,C.ODR_ODR_SF
                ,CASE WHEN C.ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE C.ODR_ODR_DTL_PRC END PURC_PGSS_CD
                FROM 
                (
                    SELECT
                    A.*
                    ,B.DLR_NM
                    ,B.PDC
                    FROM 
                     (
                        SELECT
                        A.*
                        ,B.DLR_CD AS PDC_DLR_CD
                        ,B.PDC
                        FROM CM_0101T A
                        LEFT JOIN (
                            SELECT
                            TRIM(APR_DLR_CD) AS DLR_CD
                            ,TRIM(APR_PDC) AS PDC
                            FROM PT_0701I
                            GROUP BY TRIM(APR_DLR_CD), TRIM(APR_PDC)
                        ) B
                        ON A.DLR_CD = B.DLR_CD
                        WHERE A.DMS_USE_YN = 'Y'
                        AND A.OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                        <if test='sDlrCd != null and sDlrCd != ""'>
                            AND A.DLR_CD = #{sDlrCd}
                        </if>
                        <if test='sDlrNm != null and sDlrNm != ""'>
                            AND A.DLR_NM LIKE '%'||#{sDlrNm}||'%'
                        </if>
                    ) B INNER JOIN PT_0421I A
                    ON A.OHR_DLR_CD = B.DLR_CD
                    WHERE 1=1 
                    <if test='sPurcRegDtFr != null'>
		                AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		            </if>
		            <if test='sPurcRegDtTo != null'>
		                AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		            </if>
                ) D INNER JOIN PT_0422I C
                ON C.ODR_ODR_NO = D.OHR_ORD_NO
                LEFT OUTER JOIN (
                    SELECT
                        INR_DLR_CD
                        ,INR_ORD_NO
                        ,INR_ORD_LN
                        ,MAX(INR_INV_NO) AS MOBIS_INVC_NO
                        --,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                        ,MAX(TRIM(INR_GCN_BL_NO)) AS BOX_NO
                        ,MAX(INR_INV_DT) AS INVC_DT
                        ,MAX(CASE WHEN LENGTH(TRIM(INR_VND)) <![CDATA[>]]> 8 THEN SUBSTR(TRIM(INR_VND),0,7) ELSE TRIM(INR_VND) END) AS ARRV_DT
                    FROM PT_0435I
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND INR_DLR_CD = #{sDlrCd}
                    </if>
                    GROUP BY INR_DLR_CD, INR_ORD_NO, INR_ORD_LN
                ) E
                ON C.ODR_ODR_NO = E.INR_ORD_NO
                AND C.ODR_ODR_LN = E.INR_ORD_LN
                WHERE 1=1
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <!-- 구매오더상태는 DMS에서도 [처리:03]일 때만 보여주기 때문에 명세탭 조회조건에 넣지 않음. [sPurcOrdStatLst] -->
            ) F
            WHERE 1=1
            <!--  <if test='sPurcRegDtFr != null'>
                AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
            </if>
            <if test='sPurcRegDtTo != null'>
                AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
            </if>-->
        )T1
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 구매현황 정보 목록 총 갯수를 조회한다. -->
    <select id="selectPurcOrdStatusDetailByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
    /* [chn.bhmc.dms.par.pcm.service.dao.PurcOrdDAO.selectPurcOrdStatusDetailByConditionCnt] */
        SELECT
        COUNT(*)
        FROM (
            SELECT
            D.OHR_ORD_TYP AS PURC_ORD_TP
            ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
            ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
            ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
            ,D.OHR_ORD_NO AS BMP_ORD_NO
            ,'A10AA001' AS BP_CD
            ,'BMP' AS BP_NM
            ,(SELECT ITEM_NM FROM PT_0201T WHERE ITEM_CD = C.ODR_ODR_PNO) AS ITEM_NM
            ,TRIM(C.ODR_ODR_PNO) AS ITEM_CD
            ,TRIM(C.ODR_CFM_PNO) AS CONFIRM_PAR_NO
            ,C.ODR_ODR_QT AS PURC_QTY
            ,C.ODR_CFM_QT AS CONFIRM_QTY
            ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS PURC_PRC
            ,CASE WHEN SUBSTR(D.OHR_ORD_NO,6,1) NOT IN ('1','2','3','4','5','6','7','8','9') THEN D.PDC ELSE 'PD'||SUBSTR(D.OHR_ORD_NO,6,1) END DL_DIST_CD
            ,CASE WHEN C.ODR_ODR_SF IN ('C','D','Y') THEN
                        CASE WHEN C.ODR_CFM_QT <![CDATA[>]]> 0 THEN C.ODR_CFM_QT - C.ODR_XCL_QT ELSE 0 END
                  WHEN C.ODR_ODR_SF IN ('X','Z') THEN NVL(C.ODR_SHP_QT,0) + NVL(C.ODR_ALC_QT,0) + NVL(C.ODR_OPIC_QT,0) + NVL(C.ODR_OPAC_QT,0) + NVL(C.ODR_PAKD_QT,0) + NVL(C.ODR_INV_QT,0)
             ELSE C.ODR_CFM_QT
             END CALC_CONFIRM_QTY
            ,C.ODR_XCL_QT AS CANC_REQ_QTY
            ,C.ODR_LST_AMCD AS EDIT_CD
            ,C.ODR_LST_BO_QT AS BO_QTY
            ,C.ODR_ALC_QT
            ,C.ODR_OPIC_QT
            ,C.ODR_OPAC_QT
            ,C.ODR_PAKD_QT
            ,C.ODR_INV_QT
            ,E.MOBIS_INVC_NO
            ,E.BOX_NO
            ,D.OHR_TRN_MODE AS TRSF_TP
            ,'' AS TRSF_USR_ID
            ,E.INVC_DT
            ,E.ARRV_DT
            ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
            ,C.ODR_ODR_SF
            ,CASE WHEN C.ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE C.ODR_ODR_DTL_PRC END PURC_PGSS_CD
            FROM  (
                SELECT
                A.*
                ,B.DLR_NM
                ,B.PDC
                FROM (
                    SELECT
                    A.*
                    ,B.DLR_CD AS PDC_DLR_CD
                    ,B.PDC
                    FROM CM_0101T A
                    LEFT JOIN (
                        SELECT
                        TRIM(APR_DLR_CD) AS DLR_CD
                        ,TRIM(APR_PDC) AS PDC
                        FROM PT_0701I
                        GROUP BY TRIM(APR_DLR_CD), TRIM(APR_PDC)
                    ) B
                    ON A.DLR_CD = B.DLR_CD
                    WHERE A.DMS_USE_YN = 'Y'
                    AND A.OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND A.DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND A.DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                ) B INNER JOIN PT_0421I A
                ON A.OHR_DLR_CD = B.DLR_CD
                WHERE 1=1 
                <if test='sPurcRegDtFr != null'>
		            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		        </if>
		        <if test='sPurcRegDtTo != null'>
		            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		        </if>
            ) D INNER JOIN PT_0422I C
            ON C.ODR_ODR_NO = D.OHR_ORD_NO
            LEFT OUTER JOIN (
                SELECT
                    INR_DLR_CD
                    ,INR_ORD_NO
                    ,INR_ORD_LN
                    ,MAX(INR_INV_NO) AS MOBIS_INVC_NO
                    --,MAX(B.MOBIS_INVC_LINE_NO) AS MOBIS_INVC_LINE_NO
                    ,MAX(TRIM(INR_GCN_BL_NO)) AS BOX_NO
                    ,MAX(INR_INV_DT) AS INVC_DT
                    ,MAX(CASE WHEN LENGTH(TRIM(INR_VND)) <![CDATA[>]]> 8 THEN SUBSTR(TRIM(INR_VND),0,7) ELSE TRIM(INR_VND) END) AS ARRV_DT
                FROM PT_0435I
                WHERE 1=1
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND INR_DLR_CD = #{sDlrCd}
                </if>
                GROUP BY INR_DLR_CD, INR_ORD_NO, INR_ORD_LN
            ) E
            ON C.ODR_ODR_NO = E.INR_ORD_NO
            AND C.ODR_ODR_LN = E.INR_ORD_LN
            WHERE 1=1
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND D.OHR_ORD_NO = #{sBmpOrdNo}
            </if>
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
            </if>
            <!-- 구매오더상태는 DMS에서도 [처리:03]일 때만 보여주기 때문에 명세탭 조회조건에 넣지 않음. [sPurcOrdStatLst] -->
        ) F
        WHERE 1=1
        <!--  <if test='sPurcRegDtFr != null'>
            AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
        </if>
        <if test='sPurcRegDtTo != null'>
            AND TO_DATE(F.PURC_REG_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
        </if>-->
    </select>
    <!-- 事业部统计 -->
    <select id="selectPurcOrdStatisticsByCondition" parameterType="PurcOrdSearchVO" resultType="InvcStatisticsVO">
    	SELECT
	         SUM (NVL(C.ODR_ODR_QT, 0)) AS ODR_QT  ----订购数量
			,COUNT (C.ODR_ODR_PNO) AS ODR_PNO_QT   ---订购品种
			,SUM ( DECODE (NVL (C.ODR_LST_BO_QT, 0),0,0,1)) as BO_PNO_QT---缺件品种
			,SUM (NVL(C.ODR_LST_BO_QT, 0)) AS BO_QT ---缺件数量
			,H.DIVI_NM
			,H.OFF_NM
            ,CASE WHEN SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN 1 ELSE 0 END ) = 0 
				 THEN 0 
				ELSE 
				 SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN  TO_NUMBER(TO_DATE(G.INVC_DT, 'yyyyMMdd')-TO_DATE(D.OHR_ORD_RCVE_DT, 'yyyyMMdd')) ELSE 0 END)/SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL  THEN 1 ELSE 0 END ) 
				END AS AVG_DAY  --- 配件发货总时长/发货订单明细条数
		     ,COUNT(DISTINCT D.DLR_CD) DLR_CNT ----店数
		     ,CASE WHEN SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0 AND G.INVC_DT IS NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL  THEN 1 ELSE 0 END ) = 0 
		               THEN 0 
		              ELSE 
		               SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0  AND G.INVC_DT IS NULL  AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN TO_NUMBER(SYSDATE-TO_DATE(D.OHR_ORD_RCVE_DT, 'yyyyMMdd')) ELSE 0 END)/SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0  AND G.INVC_DT IS NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL   THEN 1 ELSE 0 END ) 
		              END AS BO_AVG_DAY -- 配件缺货总时长/缺货订单明细条数
		     ,SUM(NVL(PURC_AMT,0)) AS TOT_PURC_AMT --订单总金额
		     ,COUNT(DISTINCT OHR_ORD_NO) AS ODR_NO_CNT ---订单数量
	    FROM
		(
				SELECT
					A .*,
					B.DLR_CD,
					B.SDPT_CD,
					B.DIST_OFFICE_CD
				FROM
					(
						SELECT
							*
						FROM
							CM_0101T 
						WHERE DMS_USE_YN = 'Y'
							AND OPEN_DT <![CDATA[<=]]> TO_CHAR (SYSDATE, 'YYYYMMDD')
					) B
				INNER JOIN (
					SELECT
						*
					FROM
						PT_0421I
					  WHERE 1=1 
						<if test='sPurcRegDtFr != null'>
		                  AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		                </if>
		                <if test='sPurcRegDtTo != null'>
		                  AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		                </if>
				) A ON A .OHR_DLR_CD = B.DLR_CD
		) D
		INNER JOIN 
		(SELECT CASE WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('C','D','Y') THEN
                                               CASE WHEN ODR_CFM_QT - NVL(ODR_XCL_QT,0) > 0 
                                                 THEN ROUND((ODR_CFM_QT - 
                                                      NVL(ODR_XCL_QT,0)) * (Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)),2) ELSE 0 END
                                           WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('X','Z') THEN
                                                CASE WHEN NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0) > 0
                                                       THEN ROUND((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * (NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0)),2)
                                                    ELSE 0 END
                                              ELSE  round((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * Nvl(ODR_CFM_QT,0),2) END PURC_AMT
                ,ODR_ODR_QT
                ,ODR_ODR_NO
                ,ODR_ODR_PNO
                ,ODR_LST_BO_QT
                ,ODR_ODR_LN
                from PT_0422I) C ON C.ODR_ODR_NO = D .OHR_ORD_NO
		LEFT  JOIN (  SELECT * FROM (
						SELECT
							DLR_CD
						FROM
							CM_0101T
						WHERE DMS_USE_YN = 'Y'
						   AND  OPEN_DT <![CDATA[<=]]> TO_CHAR (SYSDATE, 'YYYYMMDD')
					) F INNER JOIN 
		                    (SELECT
		                        INR_DLR_CD
		                        ,INR_ORD_NO
		                        ,INR_ORD_LN
		                        ,MAX(INR_INV_NO) AS MOBIS_INVC_NO
		                        ,MAX(TRIM(INR_GCN_BL_NO)) AS BOX_NO
		                        ,MAX(INR_INV_DT) AS INVC_DT
		                    FROM PT_0435I
		                    WHERE 1=1
		                    GROUP BY INR_DLR_CD, INR_ORD_NO, INR_ORD_LN
		                ) E ON E.INR_DLR_CD = F.DLR_CD
		)G
		ON C.ODR_ODR_NO = G.INR_ORD_NO AND C.ODR_ODR_LN = G.INR_ORD_LN
		RIGHT JOIN
		(SELECT SDPT.DIVI_CD,SDPT.DIVI_NM ,OFFICE.OFF_CD,OFFICE.OFF_NM from  CM_2501T SDPT inner join CM_2601T OFFICE on SDPT.DIVI_CD = OFFICE.DIVI_CD) H 
		ON D.SDPT_CD = H.DIVI_CD  AND D.DIST_OFFICE_CD = H.OFF_CD
		WHERE 1=1 
		   <if test='sDivision != null and sDivision != ""'>
                AND H.DIVI_CD = #{sDivision}
            </if>
            <if test='sOffice != null and sOffice != ""'>
                AND H.OFF_CD = #{sOffice}
            </if>
		  GROUP BY
			  H.DIVI_NM,
			  H.OFF_NM,
		      H.DIVI_CD,
		      H.OFF_CD
    </select>
   
   <select id="selectPurcOrdStatisticsByDlr" parameterType="PurcOrdSearchVO" resultType="InvcStatisticsVO">
   	SELECT
	     SUM (NVL(C.ODR_ODR_QT, 0)) AS ODR_QT  ----订购数量
			,COUNT (C.ODR_ODR_PNO) AS ODR_PNO_QT   ---订购品种
			,SUM ( DECODE (NVL (C.ODR_LST_BO_QT, 0),0,0,1)) as BO_PNO_QT---缺件品种
			,SUM (NVL(C.ODR_LST_BO_QT, 0)) AS BO_QT ---缺件数量
			,D.DLR_NM
			,D.DLR_CD
            ,CASE WHEN SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN 1 ELSE 0 END ) = 0 
				 THEN 0 
				ELSE 
				 SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN  TO_NUMBER(TO_DATE(G.INVC_DT, 'yyyyMMdd')-TO_DATE(D.OHR_ORD_RCVE_DT, 'yyyyMMdd')) ELSE 0 END)/SUM(CASE WHEN G.INVC_DT IS NOT NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL  THEN 1 ELSE 0 END ) 
				END AS AVG_DAY  --- 配件发货总时长/发货订单明细条数
		     ,CASE WHEN SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0 AND G.INVC_DT IS NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL  THEN 1 ELSE 0 END ) = 0 
		               THEN 0 
		              ELSE 
		               SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0  AND G.INVC_DT IS NULL  AND D.OHR_ORD_RCVE_DT  IS NOT NULL THEN TO_NUMBER(SYSDATE-TO_DATE(D.OHR_ORD_RCVE_DT, 'yyyyMMdd')) ELSE 0 END)/SUM(CASE WHEN NVL (C.ODR_LST_BO_QT, 0)>0  AND G.INVC_DT IS NULL AND D.OHR_ORD_RCVE_DT  IS NOT NULL   THEN 1 ELSE 0 END ) 
		              END AS BO_AVG_DAY -- 配件缺货总时长/缺货订单明细条数
		     ,SUM(NVL(PURC_AMT,0)) AS TOT_PURC_AMT --订单总金额
		     ,COUNT(DISTINCT OHR_ORD_NO) AS ODR_NO_CNT ---订单数量
	 FROM
		(
				SELECT
					A .*,
          B.DLR_CD,
					B.DLR_NM,
					B.OPEN_DT
				FROM
					(
						SELECT *FROM CM_0101T DM
						WHERE
							DM.DMS_USE_YN = 'Y'
						AND DM.OPEN_DT <![CDATA[<=]]> TO_CHAR (SYSDATE, 'YYYYMMDD')
					) B
				INNER JOIN (
					SELECT
						*
					FROM
						PT_0421I
				    WHERE 1=1 
						<if test='sPurcRegDtFr != null'>
		                  AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		                </if>
		                <if test='sPurcRegDtTo != null'>
		                  AND TO_DATE(OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
		                </if>
				) A ON A .OHR_DLR_CD = B.DLR_CD
		) D
		INNER JOIN (SELECT CASE WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('C','D','Y') THEN
                                               CASE WHEN ODR_CFM_QT - NVL(ODR_XCL_QT,0) > 0 
                                                 THEN ROUND((ODR_CFM_QT - 
                                                      NVL(ODR_XCL_QT,0)) * (Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)),2) ELSE 0 END
                                           WHEN (CASE WHEN ODR_ODR_DTL_PRC = ' ' THEN 'P' ELSE ODR_ODR_DTL_PRC END) IN ('X','Z') THEN
                                                CASE WHEN NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0) > 0
                                                       THEN ROUND((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * (NVL(ODR_SHP_QT,0) + NVL(ODR_ALC_QT,0) + NVL(ODR_OPIC_QT,0) + NVL(ODR_PAKD_QT,0) + NVL(ODR_INV_QT,0)),2)
                                                    ELSE 0 END
                                              ELSE  round((Nvl(Odr_Upce_Ndp,0) + Nvl(Odr_Vat_Amt,0)) * Nvl(ODR_CFM_QT,0),2) END PURC_AMT
                ,ODR_ODR_QT
                ,ODR_ODR_NO
                ,ODR_ODR_PNO
                ,ODR_LST_BO_QT
                ,ODR_ODR_LN
                from PT_0422I) C ON C.ODR_ODR_NO = D .OHR_ORD_NO
		LEFT  JOIN (  SELECT * FROM (
						SELECT
							DLR_CD
						FROM
							CM_0101T DM
						WHERE
							DM.DMS_USE_YN = 'Y'
						AND DM.OPEN_DT <![CDATA[<=]]> TO_CHAR (SYSDATE, 'YYYYMMDD')
					) F INNER JOIN 
		                    (SELECT
		                        INR_DLR_CD
		                        ,INR_ORD_NO
		                        ,INR_ORD_LN
		                        ,MAX(INR_INV_NO) AS MOBIS_INVC_NO
		                        ,MAX(TRIM(INR_GCN_BL_NO)) AS BOX_NO
		                        ,MAX(INR_INV_DT) AS INVC_DT
		                    FROM PT_0435I
		                    WHERE 1=1
		                    GROUP BY INR_DLR_CD, INR_ORD_NO, INR_ORD_LN
		                ) E ON E.INR_DLR_CD = F.DLR_CD
		)G
		ON C.ODR_ODR_NO = G.INR_ORD_NO
		                   AND C.ODR_ODR_LN = G.INR_ORD_LN
		GROUP BY
			D .DLR_CD,D.DLR_NM
   </select>
   
   <!--查询配件编号对应供应商信息 jiaMing　2020-11-18  -->
    <select id="selectDBPartsAccSupVOInfo" parameterType="map" resultType="DBPartsAccSupVO">
     /* [chn.bhmc.dms.par.pcm.service.dao.selectDBPartsAccSupVOInfo] */
    　　　　　　　SELECT  * FROM PT_0105T 
              WHERE ITEM_CD = #{itemCd}
    </select>
    
    <!-- 写入 配件编号对应供应商信息  jiaMing　2020-11-18 -->
    <insert id="insertDBPartsAccSup" parameterType="DBPartsAccSupVO">
       /* [chn.bhmc.dms.par.pcm.service.dao.insertDBPartsAccSup] */
       INSERT INTO PT_0105T(
             ITEM_CD
            ,BP_NM
            ,REG_USR_ID
            ,REG_DT
       )VALUES(
           #{itemCd}
          ,#{bpNm}
          ,#{regUsrId}
          ,SYSDATE
       )
    </insert>
    <!-- 更新配件编号对应供应商信息 jiaMing 2020-11-18  -->
    <update id="updateDBPartsAccSup" parameterType="DBPartsAccSupVO">
        /* [chn.bhmc.dms.par.pcm.service.dao.updateDBPartsAccSup] */
        UPDATE PT_0105T SET
             BP_NM = #{bpNm}
            ,UPDT_USR_ID = #{updtUsrId}
            ,UPDT_DT = SYSDATE
        WHERE ITEM_CD  = #{itemCd}
    </update>
    
    <!-- 升级查询 -->
    <select id="selectOrdBoInfoByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
             SELECT
        T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            
            FROM (
                SELECT
                D.OHR_DLR_CD AS DLR_CD
                ,L.DLR_NM AS DLR_NM
                ,D.OHR_ORD_NO AS BMP_ORD_NO
                ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
                ,E.ITEM_NM AS ITEM_NM
                ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
                ,C.ODR_LST_BO_QT AS BO_QTY
                ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
                ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS BMP_PURC_PRC
                ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
                ,C.ODR_ETD AS ARRV_DT
                ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
                ,'03' AS PURC_ITEM_STAT_CD
                ,C.ODR_ALC_QT
                ,C.ODR_OPIC_QT
                ,C.ODR_OPAC_QT
                ,C.ODR_PAKD_QT
                ,C.ODR_INV_QT
                ,H.QUESTION_NO
            	,N.REPLY_LEVEL                                                                 ---处理环节
            	,M.EXPECT_ARRIVAL_DT   ---预计到达仓库时间
            	,N.REPLY_CONTENT 
            	,O.BP_CD
            	,O.BP_NM
                 FROM 
                 (SELECT * FROM PT_0425T WHERE 1=1 AND OPT_TYPE ='0') H
                  
                  INNER JOIN (
                    SELECT * FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                    
                ) L ON  H.DLR_CD = L.DLR_CD
	            <if test='sBmpAccount != null and sBmpAccount != ""'>
                INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = L.DLR_CD
                  </if>
                INNER JOIN (
                SELECT *  FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
            )D ON H.DLR_CD = D.OHR_DLR_CD
         	   AND H.BMP_ORD_NO = D.OHR_ORD_NO    
            INNER JOIN PT_0422I C 
               ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
               AND H.ORD_LINE = C.ODR_ODR_LN
               AND H.BMP_ORD_NO = C.ODR_ODR_NO 
            INNER JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
            ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
            LEFT JOIN PT_0105T O ON O.ITEM_CD = TRIM(C.ODR_CFM_PNO) 
            LEFT JOIN(   
	            SELECT 
                       EXPECT_ARRIVAL_DT     ---最新的回复预计到库时间
                       ,QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						WHERE OPT_TP IN ('0','1')--除了完结
					)
				WHERE RN = 1
              )M ON H.QUESTION_NO = M.QUESTION_NO
              LEFT JOIN(
            	SELECT * FROM (
						 SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,C.* from 
							(SELECT B.QUESTION_NO 
								 ,B.REG_DT
								 ,B.CONTENT AS REPLY_CONTENT
								 ,CASE WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '0' THEN'转办'
							             WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '1' THEN '回复-销管科'
							             WHEN B.REPLY_LEVEL = 1 THEN '回复-配件采购科'
             							 ELSE '完结' END REPLY_LEVEL
								 FROM PT_0426T B  
								LEFT JOIN PT_0425T A 
								 ON A.QUESTION_NO = B.QUESTION_NO 
								 AND A.DLR_CD = B.DLR_CD
							     WHERE A.OPT_TYPE = '0'
							
							    UNION ALL 
							
								SELECT  CASE WHEN OPT_TYPE = '1' THEN RELATE_NO ELSE QUESTION_NO END QUESTION_NO
								,REG_DT
								,'' AS REPLY_CONTENT
								,DECODE(OPT_TYPE,'1','催单','提报') AS REPLY_LEVEL FROM PT_0425t
						) C 
				) WHERE RN = 1
            )N ON H.QUESTION_NO = N.QUESTION_NO
            WHERE C.ODR_CFM_APL_FLG != 'N'
            -----AND C.ODR_LST_BO_QT <![CDATA[>]]> 0
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
            </if>
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND D.OHR_ORD_NO = #{sBmpOrdNo}
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
            </if>
            <if test='sItemNm != null and sItemNm != ""'>
                AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
            </if>
            <if test='sQuestionNo != null and sQuestionNo != ""'>
             	AND H.QUESTION_NO = #{sQuestionNo}
	        </if>
	        <if test='sBpNm != null and sBpNm != ""'>
                AND O.BP_NM = #{sBpNm}
            </if>
           <if test='sBpCd != null and sBpCd != ""'>
                AND O.BP_CD = #{sBpCd}
            </if>
            <if test='sBmpCd != null and sBmpCd != ""'>
                AND O.BMP_CD = #{sBmpCd}
            </if>
                ORDER BY H.QUESTION_NO 
            ) T1 
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 升级查询  -->
    <select id="selectOrdBoInfoByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
           SELECT COUNT(1)
           FROM  
           (SELECT * FROM PT_0425T WHERE 1=1 AND OPT_TYPE ='0') H
           INNER JOIN (
                    SELECT * FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                    
                ) L ON  H.DLR_CD = L.DLR_CD
	         <if test='sBmpAccount != null and sBmpAccount != ""'>
                   INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = L.DLR_CD
                  </if>
                 INNER JOIN 
                (
                SELECT *
                FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
            )D ON H.DLR_CD = D.OHR_DLR_CD
         	   AND H.BMP_ORD_NO = D.OHR_ORD_NO    
            INNER JOIN PT_0422I C 
               ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
               AND H.ORD_LINE = C.ODR_ODR_LN
               AND H.BMP_ORD_NO = C.ODR_ODR_NO 
            
                INNER JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
                LEFT JOIN PT_0105T O ON O.ITEM_CD = TRIM(C.ODR_CFM_PNO) 
              
                WHERE C.ODR_CFM_APL_FLG != 'N'
                -----AND C.ODR_LST_BO_QT <![CDATA[>]]> 0
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
                <if test='sQuestionNo != null and sQuestionNo != ""'>
	                AND H.QUESTION_NO = #{sQuestionNo}
	            </if>
	            <if test='sBpNm != null and sBpNm != ""'>
                    AND O.BP_NM = #{sBpNm}
                </if>
                <if test='sBpCd != null and sBpCd != ""'>
                    AND O.BP_CD = #{sBpCd}
                </if>
                <if test='sBmpCd != null and sBmpCd != ""'>
                    AND O.BMP_CD = #{sBmpCd}
                </if>
    </select>
    <!--待货提报页面数据源 -->
    <select id="selectPurcOrdBoByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        SELECT
        T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            ,G.QUESTION_NO
            ,L.REG_DT AS DEAL_DT ---处理时间
            ,L.REPLY_LEVEL   ---处理环节
            ,M.EXPECT_ARRIVAL_DT     ----预计到达仓库时间
            ,G.REPLY_STATUS
            ,G.REG_USR_ID AS APPEAL_REG_USR_ID
            ,O.BP_NM
            ,O.BMP_CD
            ,O.BP_CD
            ,CASE WHEN G.QUESTION_NO IS NULL THEN 'N'
                 ELSE 'Y' END  APPEAL_STAT 
            ,CASE WHEN TO_CHAR(M.EXPECT_ARRIVAL_DT,'yyyyMMdd') <![CDATA[<=]]> TO_CHAR(SYSDATE-7,'yyyyMMdd') THEN 'Y'
                 ELSE 'N' END AS OVER_TIME_FLG 
            FROM (
                SELECT
                D.OHR_DLR_CD AS DLR_CD
                ,D.DLR_NM AS DLR_NM
                ,D.OHR_ORD_NO AS BMP_ORD_NO
                ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
                ,E.ITEM_NM AS ITEM_NM
                ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
                ,C.ODR_LST_BO_QT AS BO_QTY
                ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
                ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS BMP_PURC_PRC
                ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
                ,C.ODR_ETD AS ARRV_DT
                ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
                ,'03' AS PURC_ITEM_STAT_CD
                ,C.ODR_ALC_QT
                ,C.ODR_OPIC_QT
                ,C.ODR_OPAC_QT
                ,C.ODR_PAKD_QT
                ,C.ODR_INV_QT
                FROM (SELECT * FROM PT_0422I WHERE ODR_CFM_APL_FLG != 'N' AND ODR_LST_BO_QT <![CDATA[>]]> 0) C
                INNER JOIN (
                    SELECT
                    A.*
                    ,B.DLR_NM
                    ,B.OPEN_DT
                    FROM PT_0421I A INNER JOIN(
                        SELECT
                        CM0101T.*
                        FROM CM_0101T CM0101T 
                        <if test='sBmpAccount != null and sBmpAccount != ""'>
		                   INNER JOIN (
		                         SELECT DLR_CD 
		                         FROM PT_0106T 
		                         WHERE BMP_USR_ID = #{sBmpAccount}
		                         )Q ON Q.DLR_CD = CM0101T.DLR_CD
		                </if>
                        WHERE CM0101T.DMS_USE_YN = 'Y'
                        AND CM0101T.OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                        <if test='sDlrCd != null and sDlrCd != ""'>
                            AND CM0101T.DLR_CD = #{sDlrCd}
                        </if>
                        <if test='sDlrNm != null and sDlrNm != ""'>
                            AND CM0101T.DLR_NM LIKE '%'||#{sDlrNm}||'%'
                        </if>
                    ) B
                    ON A.OHR_DLR_CD = B.DLR_CD
                    <where> 
                        TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD') >= CASE WHEN LENGTH(B.OPEN_DT) = 8 THEN TO_DATE(TO_CHAR(ADD_MONTHS(TO_DATE(B.OPEN_DT,'YYYY-MM-DD'),-2),'YYYYMM')||'01','YYYY-MM-DD')  ELSE NULL END
                        <if test='sPurcRegDtFr != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                        <if test='sPurcRegDtTo != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                        <if test='sConfirmFr != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                        </if>
                        <if test='sConfirmTo != null'>
                            AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                        </if>
                    </where>
                ) D 
                ON C.ODR_ODR_NO = D.OHR_ORD_NO
                INNER JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
                ----liuxueying add 区分科长，职员 start -----------
	            <if test='sUsrTp == "1"'>
		            INNER JOIN  (
		              SELECT DISTINCT V4.DLR_CD
				       FROM CM_0801T V1
				       INNER JOIN CM_3401T V2 ON V1.DEPT_CD = V2.DEPT_CD
				       INNER JOIN CM_0801T V3 ON V3.DEPT_CD = V1.DEPT_CD
				       INNER JOIN CM_0101T V4 ON V4.CS_AREA_CCBZ_ID = V3.USR_ID
				      WHERE V1.TSK_CD = '08' 
				       AND V3.TSK_CD = '09' 
				       AND V1.USR_ID = #{sCurrentUsrId}
				       AND V1.DEL_YN='N'
	                   AND V1.ENABLED_YN='Y'
	                   AND V3.DEL_YN='N'
	                   AND V3.ENABLED_YN='Y'
	                   AND V4.DMS_USE_YN = 'Y' 
				      UNION
				      
				      SELECt DISTINCT DLR_CD from CM_0101T WHERE cs_area_ccbz_id = #{sCurrentUsrId}
				    )G ON D.OHR_DLR_CD = G.DLR_CD 
		         </if>
		         <if test='sUsrTp == "2"'>
		         INNER JOIN (SELECt DISTINCT DLR_CD from CM_0101T WHERE CS_AREA_CCBZ_ID = #{sCurrentUsrId} AND DMS_USE_YN = 'Y' ) G
		     		 ON D.OHR_DLR_CD = G.DLR_CD 
			     </if>
	             ----liuxueying add 区分科长，职员 end -----------
             
                WHERE 1=1
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
                
                ORDER BY D.OHR_DLR_CD ASC
                         ,D.OHR_ORD_RCVE_DT DESC
                         ,D.OHR_DLR_ORD_NO DESC
                         ,C.ODR_ODR_LN ASC
            ) T1 
            -----20201208 王晶鑫在缺货升级提报界面，增加字段，当前处理环节，最新回复的预计到达仓库时间，申诉流水号 liuxueying add start ------  
            LEFT JOIN  (SELECT * FROM PT_0425T WHERE 1=1 AND OPT_TYPE = '0') G
                 ON  G.DLR_CD = T1.DLR_CD
                 AND G.BMP_ORD_NO = T1.BMP_ORD_NO
                 AND trim(G.PART_NO) = TRIM(T1.CONFIRM_PAR_NO) 
                 AND G.ORD_LINE = T1.PURC_ORD_LINE_NO 
                 
            LEFT JOIN(
	            SELECT 
                       EXPECT_ARRIVAL_DT
                       ,QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER ( PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
					)
				WHERE RN = 1
            )M ON G.QUESTION_NO = M.QUESTION_NO
            
            LEFT JOIN(
            	SELECT * FROM (
						 SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,C.* FROM 
							(SELECT B.QUESTION_NO 
								, B.REG_DT
								 ,CASE WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '0' THEN'转办'
							             WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '1' THEN '回复-销管科'
							             WHEN B.REPLY_LEVEL = 1 THEN '回复-配件采购科'
            							 ELSE '完结' END REPLY_LEVEL
								 FROM PT_0426T B  
							LEFT JOIN PT_0425T A 
							 ON A.QUESTION_NO = B.QUESTION_NO 
							 AND A.DLR_CD = B.DLR_CD
						WHERE A.OPT_TYPE = '0'
						
						UNION ALL 
						
						SELECT  CASE WHEN OPT_TYPE = '1' THEN RELATE_NO ELSE QUESTION_NO END QUESTION_NO
								,REG_DT
								,DECODE(OPT_TYPE,'1','催单','提报') AS REPLY_LEVEL FROM PT_0425t
						) C 
				) WHERE RN = 1
            )L ON G.QUESTION_NO = L.QUESTION_NO
            
            LEFT JOIN PT_0105T O ON O.ITEM_CD = TRIM(T1.CONFIRM_PAR_NO) 
            WHERE 1=1
            <if test='sBpNm != null and sBpNm != ""'>
                 AND O.BP_NM = #{sBpNm}
            </if>
            <if test='sBpCd != null and sBpCd != ""'>
                 AND O.BP_CD = #{sBpCd}
            </if>
            <if test='sBmpCd != null and sBmpCd != ""'>
                 AND O.BMP_CD = #{sBmpCd}
            </if>
            -----20201208 王晶鑫在缺货升级提报界面，增加字段，处理环节，预计到达仓库时间，申诉流水号 liuxueying add end ------  
            
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!--待货提报页面数据源 -->
    <select id="selectPurcOrdBoByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
        SELECT
        COUNT(*)
        FROM (
            SELECT
            D.OHR_DLR_CD AS DLR_CD
            ,D.DLR_NM AS DLR_NM
            ,D.OHR_ORD_NO AS BMP_ORD_NO
            ,D.OHR_DLR_ORD_NO AS PURC_ORD_NO
            ,E.ITEM_NM AS ITEM_NM
            ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
            ,C.ODR_LST_BO_QT AS BO_QTY
            ,D.OHR_ORD_RCVE_DT AS PURC_REG_DT
            ,C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS BMP_PURC_PRC
            ,D.OHR_ORD_RCVE_DT AS CONFIRM_DT
            ,C.ODR_ETD AS ARRV_DT
            ,C.ODR_ODR_LN AS PURC_ORD_LINE_NO
            ,'03' AS PURC_STAT_CD
            ,C.ODR_ALC_QT
            ,C.ODR_OPIC_QT
            ,C.ODR_OPAC_QT
            ,C.ODR_PAKD_QT
            ,C.ODR_INV_QT
            FROM 
            (SELECT * FROM PT_0422I WHERE ODR_CFM_APL_FLG != 'N' AND ODR_LST_BO_QT <![CDATA[>]]> 0) C
            INNER JOIN(
                SELECT
                A.*
                ,B.OPEN_DT
                ,B.DLR_NM
                FROM PT_0421I A INNER JOIN (
                    SELECT
                    CM0101T.*
                    FROM CM_0101T CM0101T
                    <if test='sBmpAccount != null and sBmpAccount != ""'>
		                   INNER JOIN (
		                         SELECT DLR_CD 
		                         FROM PT_0106T 
		                         WHERE BMP_USR_ID = #{sBmpAccount}
		                         )Q ON Q.DLR_CD = CM0101T.DLR_CD
		            </if>
                    WHERE CM0101T.DMS_USE_YN = 'Y'
                    AND CM0101T.OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND CM0101T.DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND CM0101T.DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                ) B 
                ON A.OHR_DLR_CD = B.DLR_CD
                <where> 
                    TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD') >= CASE WHEN LENGTH(B.OPEN_DT) = 8 THEN TO_DATE(TO_CHAR(ADD_MONTHS(TO_DATE(B.OPEN_DT,'YYYY-MM-DD'),-2),'YYYYMM')||'01','YYYY-MM-DD')  ELSE NULL END
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
            ) D 
            ON C.ODR_ODR_NO = D.OHR_ORD_NO
            INNER JOIN (
                SELECT
                ITEM_CD
                ,ITEM_NM
                FROM PT_0201T
            ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
            ----liuxueying add 区分科长，职员 start -----------
            <if test='sUsrTp == "1"'>
	            INNER JOIN  (
	              SELECT DISTINCT V4.DLR_CD
			       FROM CM_0801T V1
			       INNER JOIN CM_3401T V2 ON V1.DEPT_CD = V2.DEPT_CD
			       INNER JOIN CM_0801T V3 ON V3.DEPT_CD = V1.DEPT_CD
			       INNER JOIN CM_0101T V4 ON V4.CS_AREA_CCBZ_ID = V3.USR_ID
			      WHERE V1.TSK_CD = '08' 
			       AND V3.TSK_CD = '09' 
			       AND V1.USR_ID = #{sCurrentUsrId}
			       AND V1.DEL_YN='N'
                   AND V1.ENABLED_YN='Y'
                   AND V3.DEL_YN='N'
                   AND V3.ENABLED_YN='Y'
                   AND V4.DMS_USE_YN = 'Y' 
			      UNION
			      
			      SELECt DISTINCT DLR_CD from CM_0101T WHERE cs_area_ccbz_id = #{sCurrentUsrId}
			    )G ON D.OHR_DLR_CD = G.DLR_CD 
	         </if>
	         <if test='sUsrTp == "2"'>
	         INNER JOIN (SELECt DISTINCT DLR_CD from CM_0101T WHERE CS_AREA_CCBZ_ID = #{sCurrentUsrId} AND DMS_USE_YN = 'Y' ) G
	     		 ON D.OHR_DLR_CD = G.DLR_CD 
		     </if>
             ----liuxueying add 区分科长，职员 end -----------
            
            WHERE  1=1
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
            </if>
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND D.OHR_ORD_NO = #{sBmpOrdNo}
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
            </if>
            <if test='sItemNm != null and sItemNm != ""'>
                AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
            </if>
        ) T1
         LEFT JOIN PT_0105T O ON O.ITEM_CD = TRIM(T1.CONFIRM_PAR_NO) 
            WHERE 1=1
            <if test='sBpNm != null and sBpNm != ""'>
                 AND O.BP_NM = #{sBpNm}
            </if>
            <if test='sBpCd != null and sBpCd != ""'>
                 AND O.BP_CD = #{sBpCd}
            </if>
            <if test='sBmpCd != null and sBmpCd != ""'>
                 AND O.BMP_CD = #{sBmpCd}
            </if>
    </select>
    <!-- 回复下载 -->
    <select id="selectPurcOrdReplyExcelByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        SELECT T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            FROM (
                SELECT
					D.OHR_DLR_CD AS DLR_CD
	                ,L.DLR_NM AS DLR_NM
	                ,D.OHR_ORD_NO AS BMP_ORD_NO
	                ,E.ITEM_NM AS ITEM_NM
	                ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
	                ,H.QUESTION_NO                                                                 ---申诉单号
	                ,TO_CHAR(H.REG_DT,'yyyyMMdd HH24:mi:ss')  AS APPEAL_REG_DT_STR                 ---申诉时间
	                ,H.APPEAL_REG_USR_NM                                                           ---申诉人
	                ,H.CONTENT AS APPEAL_CONTENT                                                   ---申诉内容
	                ,TO_CHAR(N.REG_DT,'yyyyMMdd HH24:mi:ss') AS DEAL_DT_STR                        ---当前处理环节的处理时间
	            	,N.REPLY_LEVEL                                                                 ---处理环节
	            	,N.REPLY_CONTENT                                                               ---最新回复内容
	            	,TO_CHAR(M.SM_DEAL_DT,'yyyyMMdd HH24:mi:ss') AS SM_DEAL_DT_STR                 ---销管科最新处理的时间
	            	,TO_CHAR(P.PC_DEAL_DT,'yyyyMMdd HH24:mi:ss') AS PC_DEAL_DT_STR                 ---采购科最新处理的时间
	            	,CASE WHEN NVL(M.SM_DEAL_DT,TO_DATE('19000101','yyyyMMdd'))  > NVL(P.PC_DEAL_DT,TO_DATE('19000101','yyyyMMdd'))
	            	   THEN TO_CHAR(M.EXPECT_ARRIVAL_DT,'yyyyMMdd HH24:mi:ss') 
	            	   ELSE TO_CHAR(P.EXPECT_ARRIVAL_DT,'yyyyMMdd HH24:mi:ss') END  AS EXPECT_ARRIVAL_DT_STR  ---预计到达仓库时间
	                ,M.SM_USR_NM
	                ,P.PC_USR_NM
	                ,C.ODR_LST_BO_QT AS BO_QTY
	                ,O.BP_NM
	                ,O.BP_CD
				FROM (SELECT PT0425T.* ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = PT0425T.REG_USR_ID) AS APPEAL_REG_USR_NM 
                          FROM PT_0425T PT0425T
				        WHERE PT0425T.OPT_TYPE = '0' 
						 AND PT0425T.STATUS !='2'
                	     <if test='sHistoryFlg != "1"'>
                	     AND PT0425T.REPLY_STATUS = #{sReplyStatus} 
						 </if>
						 <if test='sHistoryFlg == "1"'>
	                       AND PT0425T.REPLY_STATUS = '2'
	                       AND (SELECT COUNT(*) FROM PT_0426T WHERE QUESTION_NO = PT0425T.QUESTION_NO) > 0
	           			 </if>
	            )H      
				INNER JOIN (
                    SELECT * FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                ) L ON  H.DLR_CD = L.DLR_CD
                INNER JOIN 
                (SELECT * FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
              )D ON H.DLR_CD = D.OHR_DLR_CD
         	      AND H.BMP_ORD_NO = D.OHR_ORD_NO    
              INNER JOIN PT_0422I C 
                 ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
                 AND H.ORD_LINE = C.ODR_ODR_LN
                 AND H.BMP_ORD_NO = C.ODR_ODR_NO 
                <if test='sBmpAccount != null and sBmpAccount != ""'>
                   INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = D.OHR_DLR_CD
                </if>
                LEFT JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
	            LEFT JOIN PT_0105T O ON O.ITEM_CD = H.PART_NO
	            LEFT JOIN(   
	            SELECT 
                       TEMP.EXPECT_ARRIVAL_DT     ---最新的回复预计到库时间
                       ,TEMP.REG_DT AS SM_DEAL_DT
                       ,(SELECT USR_NM  FROM CM_0801T WHERE USR_ID = TEMP.REG_USR_ID)AS SM_USR_NM
                       ,TEMP.QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						WHERE REPLY_LEVEL = '0'
					)TEMP
				WHERE RN = 1
              )M ON H.QUESTION_NO = M.QUESTION_NO
              LEFT JOIN(   
	            SELECT 
                       TEMP.EXPECT_ARRIVAL_DT    ---最新的回复预计到库时间 
                       ,TEMP.REG_DT AS PC_DEAL_DT
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = TEMP.REG_USR_ID) AS PC_USR_NM
                       ,TEMP.QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						WHERE REPLY_LEVEL = '1'
					)TEMP
				WHERE RN = 1
              )P ON H.QUESTION_NO = P.QUESTION_NO
              LEFT JOIN(
            	SELECT * FROM (
						 SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,C.* from 
							(SELECT B.QUESTION_NO 
								 ,B.REG_DT
								 ,B.CONTENT AS REPLY_CONTENT
								 ,CASE WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '0' THEN'转办'
							             WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '1' THEN '回复-销管科'
							             WHEN B.REPLY_LEVEL = 1 THEN '回复-配件采购科'
            							 ELSE '完结' END REPLY_LEVEL
								 FROM PT_0426T B  
								LEFT JOIN PT_0425T A 
								 ON A.QUESTION_NO = B.QUESTION_NO 
								 AND A.DLR_CD = B.DLR_CD
							     WHERE A.OPT_TYPE = '0'
							
							    UNION ALL 
							
								SELECT  CASE WHEN OPT_TYPE = '1' THEN RELATE_NO ELSE QUESTION_NO END QUESTION_NO
								,REG_DT
								,'' AS REPLY_CONTENT
								,DECODE(OPT_TYPE,'1','催单','提报') AS REPLY_LEVEL FROM PT_0425t
						) C 
				) WHERE RN = 1
            )N ON H.QUESTION_NO = N.QUESTION_NO
	            WHERE 1=1
	            <if test='sQuestionNo != null and sQuestionNo != ""'>
	                 AND H.QUESTION_NO = #{sQuestionNo}
	           	</if>
	            <if test='sBpNm != null and sBpNm != ""'>
	                 AND O.BP_NM = #{sBpNm}
	            </if>
	            <if test='sBpCd != null and sBpCd != ""'>
	                 AND O.BP_CD = #{sBpCd}
	            </if>
	            <if test='sBmpCd != null and sBmpCd != ""'>
	                 AND O.BMP_CD = #{sBmpCd}
	            </if>
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
                ORDER BY D.OHR_DLR_CD ASC
                         ,D.OHR_ORD_RCVE_DT DESC
                         ,D.OHR_DLR_ORD_NO DESC
                         ,C.ODR_ODR_LN ASC
            ) T1 
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>
    <!-- 20201216 王晶鑫升级查询下载 liuxueying add -->
    <select id="selectOrdBoInfoExcelByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
             SELECT
                D.OHR_DLR_CD AS DLR_CD
                ,L.DLR_NM AS DLR_NM
                ,D.OHR_ORD_NO AS BMP_ORD_NO
                ,E.ITEM_NM AS ITEM_NM
                ,C.ODR_CFM_PNO AS CONFIRM_PAR_NO
                ,H.QUESTION_NO                                                                 ---申诉单号
                ,TO_CHAR(H.REG_DT,'yyyyMMdd HH24:mi:ss')  AS APPEAL_REG_DT_STR                 ---申诉时间
                ,H.APPEAL_REG_USR_NM                                                           ---申诉人
                ,H.CONTENT AS APPEAL_CONTENT                                                   ---申诉内容
                ,TO_CHAR(N.REG_DT,'yyyyMMdd HH24:mi:ss') AS DEAL_DT_STR                        ---当前处理环节的处理时间
            	,N.REPLY_LEVEL                                                                 ---处理环节
            	,N.REPLY_CONTENT                                                               ---最新回复内容
            	,D.OHR_ORD_RCVE_DT    as PURC_REG_DT                                           ---订单申请时间
            	,TO_CHAR(M.SM_DEAL_DT,'yyyyMMdd HH24:mi:ss') AS SM_DEAL_DT_STR                 ---销管科最新处理的时间
            	,TO_CHAR(P.PC_DEAL_DT,'yyyyMMdd HH24:mi:ss') AS PC_DEAL_DT_STR                 ---采购科最新处理的时间
            	
            	,CASE WHEN NVL(M.SM_DEAL_DT,TO_DATE('19000101','yyyyMMdd'))  > NVL(P.PC_DEAL_DT,TO_DATE('19000101','yyyyMMdd'))
            	   THEN TO_CHAR(M.EXPECT_ARRIVAL_DT,'yyyyMMdd HH24:mi:ss') 
            	   ELSE TO_CHAR(P.EXPECT_ARRIVAL_DT,'yyyyMMdd HH24:mi:ss') END  AS EXPECT_ARRIVAL_DT_STR  ---预计到达仓库时间
                ,M.SM_USR_NM
                ,P.PC_USR_NM
                ,C.ODR_LST_BO_QT AS BO_QTY
                ,O.BP_NM
                ,O.BP_CD
                FROM 
                  (SELECT PT0425T.*,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = PT0425T.REG_USR_ID) AS APPEAL_REG_USR_NM 
                      FROM PT_0425T PT0425T WHERE PT0425T.OPT_TYPE ='0') H
                  INNER JOIN (
                    SELECT * FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                ) L ON  H.DLR_CD = L.DLR_CD
	            <if test='sBmpAccount != null and sBmpAccount != ""'>
                INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = L.DLR_CD
                  </if>
                INNER JOIN (
                SELECT *  FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
            )D ON H.DLR_CD = D.OHR_DLR_CD
         	   AND H.BMP_ORD_NO = D.OHR_ORD_NO    
            INNER JOIN PT_0422I C 
               ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
               AND H.ORD_LINE = C.ODR_ODR_LN
               AND H.BMP_ORD_NO = C.ODR_ODR_NO 
            INNER JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
            ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
            LEFT JOIN PT_0105T O ON O.ITEM_CD = TRIM(C.ODR_CFM_PNO) 
            LEFT JOIN(   
	            SELECT 
                       TEMP.EXPECT_ARRIVAL_DT     ---最新的回复预计到库时间
                       ,TEMP.REG_DT AS SM_DEAL_DT
                       ,(SELECT USR_NM  FROM CM_0801T WHERE USR_ID = TEMP.REG_USR_ID)AS SM_USR_NM
                       ,TEMP.QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						WHERE REPLY_LEVEL = '0'
					)TEMP
				WHERE RN = 1
              )M ON H.QUESTION_NO = M.QUESTION_NO
              LEFT JOIN(   
	            SELECT 
                       TEMP.EXPECT_ARRIVAL_DT    ---最新的回复预计到库时间 
                       ,TEMP.REG_DT AS PC_DEAL_DT
                       ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = TEMP.REG_USR_ID) AS PC_USR_NM
                       ,TEMP.QUESTION_NO FROM(
						SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						WHERE REPLY_LEVEL = '1'
					)TEMP
				WHERE RN = 1
              )P ON H.QUESTION_NO = P.QUESTION_NO
              LEFT JOIN(
            	SELECT * FROM (
						 SELECT ROW_NUMBER () OVER (PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,C.* from 
							(SELECT B.QUESTION_NO 
								 ,B.REG_DT
								 ,B.CONTENT AS REPLY_CONTENT
								 ,CASE WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '0' THEN'转办'
							             WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '1' THEN '回复-销管科'
							             WHEN B.REPLY_LEVEL = 1 THEN '回复-配件采购科'
            							 ELSE '完结' END REPLY_LEVEL
								 FROM PT_0426T B  
								LEFT JOIN PT_0425T A 
								 ON A.QUESTION_NO = B.QUESTION_NO 
								 AND A.DLR_CD = B.DLR_CD
							     WHERE A.OPT_TYPE = '0'
							
							    UNION ALL 
							
								SELECT  CASE WHEN OPT_TYPE = '1' THEN RELATE_NO ELSE QUESTION_NO END QUESTION_NO
								,REG_DT
								,'' AS REPLY_CONTENT
								,DECODE(OPT_TYPE,'1','催单','提报') AS REPLY_LEVEL FROM PT_0425t
						) C 
				) WHERE RN = 1
            )N ON H.QUESTION_NO = N.QUESTION_NO
            LEFT JOIN PT_0105T O ON O.ITEM_CD = H.PART_NO
            WHERE C.ODR_CFM_APL_FLG != 'N'
            -----AND C.ODR_LST_BO_QT <![CDATA[>]]> 0
            <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
            </if>
            <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                AND D.OHR_ORD_NO = #{sBmpOrdNo}
            </if>
            <if test='sItemCd != null and sItemCd != ""'>
                AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
            </if>
            <if test='sItemNm != null and sItemNm != ""'>
                AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
            </if>
            <if test='sQuestionNo != null and sQuestionNo != ""'>
             	AND H.QUESTION_NO = #{sQuestionNo}
	        </if>
	        <if test='sBpNm != null and sBpNm != ""'>
                AND O.BP_NM = #{sBpNm}
            </if>
           <if test='sBpCd != null and sBpCd != ""'>
                AND O.BP_CD = #{sBpCd}
            </if>
            <if test='sBmpCd != null and sBmpCd != ""'>
                AND O.BMP_CD = #{sBmpCd}
            </if>
            ORDER BY H.QUESTION_NO 
    </select>
    <!--20210104 回复页面数据源 liuxueying add start-->
    <!--回复页面数据源 -->
    <select id="selectPurcOrdReplyByCondition" parameterType="PurcOrdSearchVO"  resultType="PurcOrdItemVO">
        SELECT T2.*
        FROM (
            SELECT
            ROWNUM AS RNUM
            ,T1.*
            FROM (
                SELECT
					D .OHR_DLR_CD AS DLR_CD,
					CM0101T.DLR_NM AS DLR_NM,
					D .OHR_ORD_NO AS BMP_ORD_NO,
					D .OHR_DLR_ORD_NO AS PURC_ORD_NO,
					E .ITEM_NM AS ITEM_NM,
					C.ODR_CFM_PNO AS CONFIRM_PAR_NO,
					C.ODR_LST_BO_QT AS BO_QTY,
					D .OHR_ORD_RCVE_DT AS PURC_REG_DT,
					C.ODR_UPCE_NDP + C.ODR_VAT_AMT AS BMP_PURC_PRC,
					D .OHR_ORD_RCVE_DT AS CONFIRM_DT,
					C.ODR_ETD AS ARRV_DT,
					C.ODR_ODR_LN AS PURC_ORD_LINE_NO,
					'03' AS PURC_ITEM_STAT_CD,
					C.ODR_ALC_QT,
					C.ODR_OPIC_QT,
					C.ODR_OPAC_QT,
					C.ODR_PAKD_QT,
					C.ODR_INV_QT,
					H.QUESTION_NO,
					M.EXPECT_ARRIVAL_DT,
					O.BP_NM,
					O.BMP_CD,
					O.BP_CD,
					CASE WHEN TO_CHAR (M .EXPECT_ARRIVAL_DT,
					'yyyyMMdd') <![CDATA[<=]]> TO_CHAR (SYSDATE - 7, 'yyyyMMdd') THEN
					'Y'
				     ELSE
					'N' END AS OVER_TIME_FLG
				FROM (SELECT * FROM PT_0425T PT0425T
				        WHERE PT0425T.OPT_TYPE = '0' 
						 AND PT0425T.STATUS !='2'
                	     <if test='sHistoryFlg != "1"'>
                	     AND PT0425T.REPLY_STATUS = #{sReplyStatus} 
						 </if>
						 <if test='sHistoryFlg == "1"'>
	                       AND PT0425T.REPLY_STATUS = '2'
	                       AND (SELECT COUNT(*) FROM PT_0426T WHERE QUESTION_NO = PT0425T.QUESTION_NO) > 0
	           			 </if>
	            )H      
				INNER JOIN (
                    SELECT * FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                ) CM0101T ON  H.DLR_CD = CM0101T.DLR_CD
                INNER JOIN 
                (SELECT * FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
              )D ON H.DLR_CD = D.OHR_DLR_CD
         	      AND H.BMP_ORD_NO = D.OHR_ORD_NO    
              INNER JOIN PT_0422I C 
                 ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
                 AND H.ORD_LINE = C.ODR_ODR_LN
                 AND H.BMP_ORD_NO = C.ODR_ODR_NO 
                <if test='sBmpAccount != null and sBmpAccount != ""'>
                   INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = D.OHR_DLR_CD
                </if>
                LEFT JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
                
                LEFT JOIN(
		            SELECT 
	                       EXPECT_ARRIVAL_DT
	                       ,QUESTION_NO FROM(
							SELECT ROW_NUMBER () OVER ( PARTITION BY QUESTION_NO ORDER BY REG_DT DESC) AS RN,K .*	FROM PT_0426T K
						)
					WHERE RN = 1
	            )M ON H.QUESTION_NO = M.QUESTION_NO
	            LEFT JOIN PT_0105T O ON O.ITEM_CD = H.PART_NO
	            WHERE 1=1
	            <if test='sQuestionNo != null and sQuestionNo != ""'>
	                 AND H.QUESTION_NO = #{sQuestionNo}
	           	</if>
	            <if test='sBpNm != null and sBpNm != ""'>
	                 AND O.BP_NM = #{sBpNm}
	            </if>
	            <if test='sBpCd != null and sBpCd != ""'>
	                 AND O.BP_CD = #{sBpCd}
	            </if>
	            <if test='sBmpCd != null and sBmpCd != ""'>
	                 AND O.BMP_CD = #{sBmpCd}
	            </if>
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
                ORDER BY D.OHR_DLR_CD ASC
                         ,D.OHR_ORD_RCVE_DT DESC
                         ,D.OHR_DLR_ORD_NO DESC
                         ,C.ODR_ODR_LN ASC
            ) T1 
        ) T2
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[<=]]> #{lastIndex}
                AND RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>
    
    <select id="selectPurcOrdReplyByConditionCnt" parameterType="PurcOrdSearchVO"  resultType="int">
               SELECT COUNT(*) FROM (
                   SELECT * FROM PT_0425T PT0425T
                	 WHERE PT0425T.OPT_TYPE = '0' 
						 AND PT0425T.STATUS !='2'
                	     <if test='sHistoryFlg != "1"'>
                	     AND PT0425T.REPLY_STATUS = #{sReplyStatus} 
						 </if>
						 <if test='sHistoryFlg == "1"'>
	                       AND PT0425T.REPLY_STATUS = '2'
	                       AND (SELECT COUNT(*) FROM PT_0426T WHERE QUESTION_NO = PT0425T.QUESTION_NO) > 0
	           			 </if>
	           	    )H      
				INNER JOIN (
                    SELECT DLR_CD FROM CM_0101T
                    WHERE 1=1
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        AND DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sDlrNm != null and sDlrNm != ""'>
                        AND DLR_NM LIKE '%'||#{sDlrNm}||'%'
                    </if>
                    <if test='sDivision != null and sDivision != ""'>
		                AND SDPT_CD = #{sDivision}
		            </if>
		            <if test='sOffice != null and sOffice != ""'>
		                AND DIST_OFFICE_CD = #{sOffice}
		            </if>
                ) CM0101T ON  H.DLR_CD = CM0101T.DLR_CD
                INNER JOIN 
                (SELECT * FROM PT_0421I A
                <where> 1=1
                    <if test='sPurcRegDtFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sPurcRegDtFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sPurcRegDtTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sPurcRegDtTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                    <if test='sConfirmFr != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[>=]]> TO_DATE(TO_CHAR(#{sConfirmFr},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')    <!-- dms에서는 0431t의 arrv_dt로 조회한다. -->
                    </if>
                    <if test='sConfirmTo != null'>
                        AND TO_DATE(A.OHR_ORD_RCVE_DT,'YYYY-MM-DD HH24:MI:SS') <![CDATA[<=]]> TO_DATE(TO_CHAR(#{sConfirmTo},'YYYYMMDD'),'YYYY-MM-DD HH24:MI:SS')
                    </if>
                </where>
              )D ON H.DLR_CD = D.OHR_DLR_CD
         	      AND H.BMP_ORD_NO = D.OHR_ORD_NO    
              INNER JOIN PT_0422I C 
                 ON  H.PART_NO = TRIM(C.ODR_CFM_PNO) 
                 AND H.ORD_LINE = C.ODR_ODR_LN
                 AND H.BMP_ORD_NO = C.ODR_ODR_NO 
                <if test='sBmpAccount != null and sBmpAccount != ""'>
                   INNER JOIN (
                         SELECT DLR_CD 
                         FROM PT_0106T 
                         WHERE BMP_USR_ID = #{sBmpAccount}
                         )Q ON Q.DLR_CD = D.OHR_DLR_CD
                </if>
                LEFT JOIN (
                    SELECT
                    ITEM_CD
                    ,ITEM_NM
                    FROM PT_0201T
                ) E ON E.ITEM_CD = TRIM(C.ODR_CFM_PNO)
	            LEFT JOIN PT_0105T O ON O.ITEM_CD = H.PART_NO
	            WHERE 1=1
	            <if test='sQuestionNo != null and sQuestionNo != ""'>
	                 AND H.QUESTION_NO = #{sQuestionNo}
	           	</if>
	            <if test='sBpNm != null and sBpNm != ""'>
	                 AND O.BP_NM = #{sBpNm}
	            </if>
	            <if test='sBpCd != null and sBpCd != ""'>
	                 AND O.BP_CD = #{sBpCd}
	            </if>
	            <if test='sBmpCd != null and sBmpCd != ""'>
	                 AND O.BMP_CD = #{sBmpCd}
	            </if>
                <if test='sPurcOrdNo != null and sPurcOrdNo != ""'>
                    AND D.OHR_DLR_ORD_NO = #{sPurcOrdNo}
                </if>
                <if test='sBmpOrdNo != null and sBmpOrdNo != ""'>
                    AND D.OHR_ORD_NO = #{sBmpOrdNo}
                </if>
                <if test='sItemCd != null and sItemCd != ""'>
                    AND TRIM(C.ODR_CFM_PNO) = #{sItemCd}
                </if>
                <if test='sItemNm != null and sItemNm != ""'>
                    AND TRIM(E.ITEM_NM) LIKE '%'||#{sItemNm}||'%'
                </if>
    </select>
     <!--20210104 回复页面数据源 liuxueying add end-->
</mapper>