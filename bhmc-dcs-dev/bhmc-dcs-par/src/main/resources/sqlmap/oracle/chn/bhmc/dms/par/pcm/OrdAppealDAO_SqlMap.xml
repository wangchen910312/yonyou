<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : OrdAppealDAO_SqlMap.xml
-->

<mapper namespace="chn.bhmc.dms.par.pcm.service.dao.OrdAppealDAO">
    <!-- 재고 실사 정보를 추가한다. -->
    <insert id="insertOrdAppeal" parameterType="OrdAppealVO">
    INSERT INTO PT_0425T
    (
        DLR_CD
        ,QUESTION_NO                   
        ,ORD_NO                       
        ,BMP_ORD_NO                     
        ,REG_USR_ID               
        ,REG_DT
        ,CONTENT         
        ,STATUS     
        ,REPLY_STATUS
        ,PART_NO    
        ,TYPE   
        ,OPT_TYPE  
        ,ORD_LINE
        ,RELATE_NO
    )
    VALUES
    (
        #{dlrCd}
        ,#{questionNo}
        ,#{ordNo}
        ,#{bmpOrdNo}
        ,#{regUsrId}
       	,sysdate
        ,#{content}
        ,#{status}
        ,#{replyStatus}
        ,#{partNo}
        ,#{type}
        ,#{optType}
        ,#{ordLine}
        ,#{relateNo}
    )
    </insert>
    <select id="selectDealListCnt" parameterType="OrdAppealSearchVO" resultType="int">
    select COUNT(*)  from 
    (SELECT B.REG_USR_ID,B."CONTENT",B.REG_DT from PT_0426T B  
	  LEFT JOIN PT_0425T A 
	   ON A.QUESTION_NO = B.QUESTION_NO 
	   AND A.DLR_CD = B.DLR_CD
	WHERE A.OPT_TYPE = '0' AND A.QUESTION_NO = #{questionNo}
	
	UNION 
	
	SELECT A.REG_USR_ID,A."CONTENT",A.REG_DT FROM PT_0425t A 
	WHERE A.QUESTION_NO = #{questionNo} or A.RELATE_NO = #{questionNo})
	
	</select>
    <!-- 查询问题和答案列表 -->
    <select id="selectDealList" parameterType="OrdAppealSearchVO" resultType="OrdAppealVO">
    SELECT C.*,DECODE(D.USR_ID,NULL,'系统',D.USR_NM) AS REG_USR_NM from 
    (SELECT B.REG_USR_ID
       ,B."CONTENT"
       ,B.REG_DT
       ,A.TYPE
       ,B.EXPECT_ARRIVAL_DT
       ,CASE WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '0' THEN'转办'
             WHEN B.REPLY_LEVEL = 0 AND OPT_TP = '1' THEN '回复-销管科'
             WHEN B.REPLY_LEVEL = 1 THEN '回复-配件采购科'
             ELSE '完结' END REPLY_LEVEL
       FROM PT_0426T B  
	  LEFT JOIN PT_0425T A 
	   ON A.QUESTION_NO = B.QUESTION_NO 
	   AND A.DLR_CD = B.DLR_CD
	WHERE A.OPT_TYPE = '0' AND A.QUESTION_NO = #{questionNo}
	
	union all 
	
	SELECT A.REG_USR_ID
	    ,A."CONTENT"
	    ,A.REG_DT,A.TYPE
	    ,NULL AS EXPECT_ARRIVAL_DT
	    ,DECODE(A.OPT_TYPE,'1','催单','提报') AS REPLY_LEVEL FROM PT_0425t A 
	WHERE A.QUESTION_NO = #{questionNo} or A.RELATE_NO = #{questionNo}
	) C
	LEFT JOIN CM_0801T D ON D.USR_ID = C.REG_USR_ID
    ORDER BY C.REG_DT 
	</select>
	<update id="updateOrdAppeal" parameterType="OrdAppealVO" >
        UPDATE PT_0425T   
        SET UPDT_DT = SYSDATE
        <if test='status != null'>
         ,STATUS         = #{status}  
        </if>
        <if test='replyStatus != null'>
        ,REPLY_STATUS         = #{replyStatus}  
        </if>                       
        WHERE QUESTION_NO     = #{questionNo}              
    </update>
    <select id="selectAppealCnt" parameterType="OrdAppealSearchVO" resultType="int">
         SELECT COUNT(*) FROM PT_0425T A 
               WHERE 1=1
                   <if test='questionNo != null and questionNo != ""'>
	                   AND A.QUESTION_NO = #{questionNo} 
                    </if>
               		<if test='bmpOrdNo != null and bmpOrdNo != ""'>
	                   AND A.BMP_ORD_NO = #{bmpOrdNo} 
                    </if>
                    <if test='partNo != null and partNo != ""'>
                  		 AND A.PART_NO = #{partNo} 
                    </if>
                    <if test='ordLine != null and ordLine != ""'>
                  		 AND A.ORD_LINE = #{ordLine} 
                    </if>
                    <if test='dlrCd != null and dlrCd != ""'>
                  		 AND A.DLR_CD = #{dlrCd}
                    </if>
                    AND A.OPT_TYPE= '0'
    </select>
    
    <!-- 查询提报数据 -->
    <select id="selectAppealByCondition" parameterType="OrdAppealSearchVO" resultType="OrdAppealVO">
         SELECT * FROM PT_0425T A 
               WHERE 1=1
               		<if test='questionNo != null and questionNo != ""'>
	                   AND A.QUESTION_NO = #{questionNo} 
                    </if>
               		<if test='bmpOrdNo != null and bmpOrdNo != ""'>
	                   AND A.BMP_ORD_NO = #{bmpOrdNo} 
                    </if>
                    <if test='partNo != null and partNo != ""'>
                  		 AND A.PART_NO = #{partNo} 
                    </if>
                    <if test='ordLine != null and ordLine != ""'>
                  		 AND A.ORD_LINE = #{ordLine} 
                    </if>
                    <if test='dlrCd != null and dlrCd != ""'>
                  		 AND A.DLR_CD = #{dlrCd}
                    </if>
                   AND A.OPT_TYPE= '0'
    </select>
    
    <!-- 依据配件且未关闭状态的问题回复进度修改已处理状态,状态为进行中 -->
    <update id="updateAppealByPartNo" parameterType="String" >
         UPDATE PT_0425T A
           SET A.REPLY_STATUS = '2',
               A.STATUS = '1'
           WHERE A.OPT_TYPE = '0' ------申诉
             AND A.STATUS != '2'  ----未关闭
             AND A.PART_NO  = #{partNo}  
    </update>
    
</mapper>