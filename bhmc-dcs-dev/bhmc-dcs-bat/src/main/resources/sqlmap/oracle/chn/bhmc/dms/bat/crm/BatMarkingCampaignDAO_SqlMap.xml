<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : BatMarkingCampaignDAO_SqlMap.xml
    Description : 배치작업에 관한 데이터처리
    author Hyoung Jun An
    since 2016. 07. 20.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 07. 20.  Hyoung Jun An     최초 생성
-->

<mapper namespace="chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO">

    <!-- 자동으로 Batch 를 수행할 목록이 있는지 조회한다(캠페인 대상자 추출목록). -->
    <select id="selectMarkingCampaignScheduleCondition" parameterType="BatMarkingCampaignSearchVO" resultType="BatMarkingCampaignVO">
    /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.selectMarkingCampaignScheduleCondition] */
        SELECT CR_1103T.DLR_CD
               ,CR_1103T.MAK_CD
               ,CR_1103T.EXTR_DGRE_CNT
               ,CR_1103T.CUST_EXTR_TERM_NO
               ,CR_1103T.CUST_EXTR_TITLE_NM
               ,CR_1103T.CUST_EXTR_CYCLE_CONT
               ,CR_1103T.DUP_YN
               ,CR_1103T.BAT_OPER_ID
               ,CR_1103T.CUST_EXTR_CYCLE_TP
          FROM CR_1103T CR_1103T
               INNER JOIN CR_1101T CR_1101T ON CR_1103T.DLR_CD = CR_1101T.DLR_CD AND CR_1103T.MAK_CD = CR_1101T.MAK_CD
         WHERE CR_1103T.DLR_CD = #{sDlrCd}
           AND CR_1103T.USE_YN = 'Y'
           AND CR_1103T.CUST_EXTR_AUTO_YN = 'Y'
           AND CR_1103T.EXTR_STAT_CD = 'N'
           AND CR_1103T.EXTR_DT IS NULL
           AND CR_1101T.STAT_CD = '03'
           AND (
                   (
                    CR_1103T.CUST_EXTR_CYCLE_TP = 'W' AND CR_1103T.CUST_EXTR_CYCLE_CONT LIKE '%'||UPPER(to_char(#{sCurruntDt}, 'dy','NLS_DATE_LANGUAGE=ENGLISH'))||'%'
                   ) OR (
                    CR_1103T.CUST_EXTR_CYCLE_TP = 'S' AND CR_1103T.CUST_EXTR_CYCLE_CONT LIKE '%'||to_char(#{sCurruntDt}, 'YYYYMMDD')||'%'
                   ) OR (
                    CR_1103T.CUST_EXTR_CYCLE_TP = 'D'
                   )
               )
    </select>

    <!-- Batch 를 수행하여 추출한 대상자를 등록 한다. -->
    <insert id="insertBatTargetExtractSave" parameterType="BatMarkingCampaignVO">
    /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.insertBatTargetExtractSave] */
        INSERT INTO CR_1110T    --캠페인추출고객
        (
        DLR_CD                    --딜러코드
        ,MAK_CD                    --마케팅코드
        ,EXTR_DGRE_CNT             --추출차수
        ,TARG_CUST_SEQ             --대상고객일련번호
        ,CUST_NO                   --고객번호
        ,CUST_NM                   --고객명
        ,CUST_EXTR_TERM_NO         --고객추출조건번호
        ,TEL_NO                    --전화번호
        ,HP_NO                     --휴대폰번호
        ,WECHAT_ID                 --위챗ID
        ,EMAIL_NM                  --이메일명
        ,SUNG_NM                   --성명
        ,CITY_NM                   --도시명
        ,DIST_NM                   --지역명
        ,ZIP_CD                    --우편번호
        ,EXT_ZIP_CD                --확장우편번호
        ,ADDR_NM                   --주소명
        ,ADDR_DETL_CONT            --주소상세내용
        ,REG_USR_ID                --등록자ID
        ,REG_DT                    --등록일자
        )
        SELECT #{dlrCd}              --딜러코드
               ,#{makCd}             --마케팅코드
               ,#{extrDgreCnt}       --추출차수
               ,SEQ_CR_1110T.NEXTVAL --대상고객일련번호
               ,T1.CUST_NO
               ,T2.CUST_NM
               ,#{custExtrTermNo}    --추출조건번호
               ,T2.TEL_NO
               ,T2.HP_NO
               ,T2.WECHAT_ID
               ,T2.EMAIL_NM
               ,T3.SUNG_NM
               ,T3.CITY_NM
               ,T3.DIST_NM
               ,T3.ZIP_CD
               ,T3.EXT_ZIP_CD
               ,T3.ADDR_NM
               ,T3.ADDR_DETL_CONT
               ,#{regUsrId}
               ,SYSDATE
          FROM CR_1003T T1,
               CR_0101T T2,
               (SELECT *
                  FROM CR_0116T
                 WHERE REF_TABLE_NM = 'CR_0101T'
                   AND FLAG_YN = 'Y'
               ) T3
         WHERE T1.DLR_CD  = T2.DLR_CD
           AND T2.DLR_CD  = T3.DLR_CD(+)
           AND T1.CUST_NO = T2.CUST_NO
           AND T2.CUST_NO = T3.REF_KEY_NM(+)
           AND T2.DEL_YN  = 'N'
           AND T1.DLR_CD  = #{dlrCd}
           AND T1.SEQ     = #{seq}
        <if test='dupYn == "N"'>
           AND T1.CUST_NO NOT IN (SELECT CUST_NO
                                    FROM CR_1110T
                                   WHERE DLR_CD = #{dlrCd}
                                     AND MAK_CD = #{makCd}
                                 )
        </if>
    </insert>

    <!-- Batch 를 수행한 이후에 마케팅 캠페인(대상자) 정보를 수정한다.(대상자 마스터 업데이트) -->
    <update id="updateBatTargetExtractMaster" parameterType="BatMarkingCampaignVO" >
        /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.updateBatTargetExtractMaster] */
        UPDATE CR_1103T    --마케팅캠페인대상고객
        SET
         EXTR_STAT_CD         = 'Y'                           --추출상태코드
        ,EXTR_DT              = SYSDATE                       --추출일자
        ,UPDT_USR_ID          = #{updtUsrId}                  --수정자ID
        ,UPDT_DT              = SYSDATE                       --수정일자
        WHERE 1 = 1
        AND DLR_CD            = #{dlrCd}                      --딜러코드
        AND MAK_CD            = #{makCd}                      --마케팅코드
        AND EXTR_DGRE_CNT     = #{extrDgreCnt}                --추출차수
    </update>

    <!-- Batch 를 수행한 이후에 새롭게 Batch를 수행할 마케팅 캠페인(대상자) 정보를 등록한다. -->
    <insert id="insertBatTarget" parameterType="BatMarkingCampaignVO" >
        /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.insertBatTarget] */
        INSERT INTO CR_1103T    --마케팅캠페인대상고객
        (
        DLR_CD                      --딜러코드
        ,MAK_CD                      --마케팅코드
        ,EXTR_DGRE_CNT               --추출차수
        ,CUST_EXTR_TERM_NO           --고객추출조건번호
        ,CUST_EXTR_TITLE_NM          --고객추출제목명
        ,EXTR_STAT_CD                --추출상태코드
        ,USE_YN                      --사용여부
        ,REG_USR_ID                  --등록자ID
        ,REG_DT                      --등록일자
        ,CUST_EXTR_AUTO_YN           --고객추출자동여부
        ,CUST_EXTR_CYCLE_CONT        --고객추출주기내용
        ,CUST_EXTR_CYCLE_TP          --고객추출주기유형
        ,DUP_YN                      --중복여부
        )
        VALUES
        (
        #{dlrCd}                      --딜러코드
        ,#{makCd}                      --마케팅코드
        ,SEQ_CR_1103T.NEXTVAL          --추출차수
        ,#{custExtrTermNo}             --고객추출조건번호
        ,#{custExtrTitleNm}            --고객추출제목명
        ,'N'                           --추출상태코드
        ,'Y'                           --사용여부
        ,#{regUsrId}                   --등록자ID
        ,SYSDATE                       --등록일자
        ,'Y'                           --고객추출자동여부
        ,#{custExtrCycleCont}          --고객추출주기내용
        ,#{custExtrCycleTp}            --고객추출주기유형
        ,#{dupYn}                      --중복여부
        )
    </insert>

     <!-- DCS캠페인 데이터를 인터페이스 테이블에 이관처리 한다. -->
     <select id="selectMarktingCampaignDcsIfCopy" statementType="CALLABLE" parameterType="BatMarkingCampaignVO">
     /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.selectMarktingCampaignDcsIfCopy] */
         { call SP_CRM_CAMPAIGN_DCS_IF (
            #{result, mode=OUT, jdbcType=VARCHAR}
         ) }
    </select>

    <!-- DMS에서 DCS로 다시 이관된 DCS캠페인 대상자에 대한 결과치를 갱신한다.(추출대상자)-->
    <select id="updateCrmDcsTargetResult" statementType="CALLABLE" >
         { call SP_CRM_DCS_TARGET_RESULT }
    </select>

    <!-- 자동으로 Batch 를 수행할 목록이 있는지 조회한다(캠페인 대상자 추출목록). -->
    <select id="selectMarktingCampaignDataYn" resultType="string">
    /* [chn.bhmc.dms.bat.crm.mcm.service.dao.BatMarkingCampaignDAO.selectMarkingCampaignScheduleCondition] */
        SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END AS EXISTS_YN
          FROM CR_1108IS
         WHERE IFRESULT = 'N' OR IFRESULT is null
           AND ROWNUM = 1
    </select>
</mapper>