<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : TracticsDeliveryPreMonthDelDAO_SqlMap.xml
    Description : 배치작업에 관한 데이터처리
    author Kwon Ki hyun
    since 2016. 8. 26.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2017. 06. 06.  kwon kihyun     최초 생성
-->


<mapper namespace="chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO">


    <!-- 查询待发送充电桩数据  -->
	<select id="selectChargingPileList" parameterType="UpdateChargingPileVO" resultType="UpdateChargingPileVO">
         SELECT * FROM (
         SELECT NVL(T1.IF_SEQ,'') IF_SEQ,          <!-- 新增序列号唯一约束。tjx 2020-8-22 -->
         		NVL(T1.INSTALLATION_NO,'') INSTALLATION_NO,
				NVL(T1.IS_NEED,'02') IS_NEED,
				NVL(T1.SHOP_NO,'') SHOP_NO,
				NVL(T1.SHOP_NAME,'') SHOP_NAME,
				NVL(T6.DIVI_NM,'') DIVISION_NAME,
				NVL(T1.OFFICE_NAME,'') OFFICE_NAME,
				NVL(T1.CUST_CD,'') CUST_CD,
				NVL(T1.CUST_NAME,'') CUST_NAME,
				NVL(T1.CUST_PHONE,'') CUST_PHONE,
				NVL(T4.CMM_CD_TXT,'未知') GENDER,
				NVL(T1.VIN_NO,'') VIN_NO,
				<!--  NVL(T1.CAR_MODEL,'') CAR_MODEL,-->
				( SELECT   B.CARLINE_EN_NM 
                       FROM  SA_0101T B  WHERE  B.CARLINE_CD=T7.CARLINE_CD
                 ) AS CAR_MODEL ,  <!-- R19082800863 给充电桩发的接口 “车型" 改成 HDC EV 这样的车种的英文名，如图。现在是发的是 ocn代码的英文名称。 贾明 2019-8-28 -->
				NVL(T1.INSTALL_PROVINCE,'') INSTALL_PROVINCE,
				NVL(T1.INSTALL_CITY,'') INSTALL_CITY,
				NVL(T1.INSTALL_AREA,'') INSTALL_AREA,
				NVL(T1.ADDRESS,'') ADDRESS,
				NVL(TO_CHAR(T1.INVOICE_DATE,'YYYY-MM-DD HH24:MI:SS'),'') INVOICE_DATE_STA,
				NVL(T1.STATE,'') STATE,
				T1.IFRESULT,
				T1.IFFAILMSG,
				T1.CREATEDATE,
				T1.UPDATEDATE,
				T1.IF_REG_DT,
				T1.BAT_ID,
				T1.DLR_CD,
				T5.DLR_NM,
				T1.INSERT_DATE,
				T1.CAR_STATE  ,
				T1.ORD_TP,  <!-- NDMS销售的车辆信息中增加“订单类型”并且把该信息传输到充电桩平台  贾明 2019-7-19  -->
				(SELECT A.CMM_CD_NM
                 FROM CM_0303T A ,CM_0304T B
                WHERE A.CMM_GRP_CD = B.CMM_GRP_CD
                  AND A.CMM_CD = B.CMM_CD
                  AND B.LANG_CD = 'zh'
                  AND A.CMM_CD = T1.ORD_TP
                  AND A.CMM_GRP_CD = 'SAL138') AS ORD_TP_NM <!-- NDMS销售的车辆信息中增加“订单类型名称”并且把该信息传输到充电桩平台  贾明 2019-7-19  -->
		   FROM SA_0507_2IS T1
		   LEFT JOIN CR_0101T T2 ON (T1.CUST_CD = T2.CUST_NO)
		   LEFT JOIN CM_0303T T3 ON (T2.SEX_CD = T3.CMM_CD AND T3.CMM_GRP_CD = 'COM017')
		   LEFT JOIN CM_0304T T4 ON (T3.CMM_CD = T4.CMM_CD AND T4.LANG_CD = 'zh' AND T4.CMM_GRP_CD='COM017')<!-- 性别明细增加  李延勇 2019-8-9  -->
		   LEFT JOIN CM_0101T T5 ON (T1.DLR_CD = T5.DLR_CD)
		   LEFT JOIN CM_2501T T6 ON (T5.SDPT_CD = T6.DIVI_CD)
		   LEFT JOIN SA_0121T T7 ON ( T1.VIN_NO = T7.VIN_NO) <!-- R19082800863 给充电桩发的接口 “车型" 改成 HDC EV 这样的车种的英文名，如图。现在是发的是 ocn代码的英文名称。 贾明 2019-8-28 -->
		  WHERE T1.IFRESULT = 'N'
		      <!-- CRS清单42往发送充电桩数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->
		         AND T1.VIN_NO IN (
                     SELECT VIN_NO  FROM SA_0121T  WHERE  CAR_STAT_CD='70'
                 )
              <!-- CRS清单42往发送充电桩数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->
          ORDER BY IF_SEQ
		  )
	 	  WHERE ROWNUM <![CDATA[<=]]> #{limit}
	</select>
    
    <!-- 根据反馈信息修改待发送充电桩数据  -->
    <update id="updateChargingPileIs" parameterType="UpdateChargingPileVO">
    /* [chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO.updateChargingPileIs] */
        UPDATE SA_0507_2IS    --계약헤더
           SET 
	        IFRESULT = #{ifresult},
	        IFFAILMSG = #{iffailmsg},
	        UPDATEDATE = TO_CHAR(SYSDATE,'yyyymmddhh24miss')
         WHERE 1 = 1
           AND IF_SEQ              = #{ifSeq}                         --序列号
           AND INSTALLATION_NO     = #{installationNo}                --계약번호
    </update>
    
    <!-- 接收充电桩数据更新业务表  -->
    <update id="updateChargingPile" parameterType="UpdateChargingPileVO">
    /* [chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO.updateChargingPile] */
        UPDATE SA_0507T    --계약헤더
           SET 
        STATUS = #{status},
        EXEC_DATE = TO_DATE(#{execDateStr},'YYYY-MM-DD HH24:MI:SS'),
        EXEC_REMARK = #{execRemark},
        COMPANY = #{company},
        NAME = #{name},
        MOBILE = #{mobile},
        EMAIL = #{email}
         WHERE 1 = 1
           AND INSTALLATION_NO     = #{installationNo}                --계약번호
    </update>
    
    <insert id="insertChargingPile" parameterType="UpdateChargingPileVO">
        /* [chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO.insertChargingPile] */
        MERGE INTO SA_0507IS A
			USING (SELECT DLR_CD,
			      #{installationNo} INSTALLATION_NO,
			      #{status} STATUS,
			      TO_DATE(#{execDateStr},'YYYY-MM-DD HH24:MI:SS') EXEC_DATE,
			      #{execRemark} EXEC_REMARK,
			      #{company} COMPANY,
			      #{name} NAME,
			      #{mobile} MOBILE,
			      #{email} EMAIL,
			      'N' IFRESULT
			      FROM SA_0507T C
			      WHERE C.INSTALLATION_NO     = #{installationNo}
			      ) B
			ON (A.INSTALLATION_NO = B.INSTALLATION_NO)
			WHEN NOT MATCHED THEN
			  INSERT
			    (DLR_CD,
			     INSTALLATION_NO,
			     STATUS,
			     EXEC_DATE,
			     EXEC_REMARK,
			     COMPANY,
			     NAME,
			     MOBILE,
			     EMAIL,
			     IFRESULT)
			  VALUES
			    (B.DLR_CD,
			     B.INSTALLATION_NO,
			     B.STATUS,
			     B.EXEC_DATE,
			     B.EXEC_REMARK,
			     B.COMPANY,
			     B.NAME,
			     B.MOBILE,
			     B.EMAIL,
			     B.IFRESULT)
			WHEN MATCHED THEN
			  UPDATE
			     SET A.DLR_CD               = B.DLR_CD,
			         A.STATUS               = B.STATUS,
			         A.EXEC_DATE            = B.EXEC_DATE,
			         A.EXEC_REMARK          = B.EXEC_REMARK,
			         A.COMPANY              = B.COMPANY,
			         A.NAME                 = B.NAME,
			         A.MOBILE               = B.MOBILE,
			         A.EMAIL                = B.EMAIL,
			         A.IFRESULT             = B.IFRESULT

    </insert>
    
    
    <!-- 查询待发送车辆销售数据  -->
	<select id="selectSaleVehicleList" parameterType="ReceiveSaleVehicleVO" resultType="ReceiveSaleVehicleVO">
 	 SELECT * FROM (   
     SELECT T1.VIN_NO,
	       T1.LICENSE_PLATE,
	       T1.VEH_TYPE_NAME,
	       T1.SALE_TIME,
	       T1.SALE_AREA,
	       T1.OWNER_NAME,
	       T1.IDNUM,
	       T1.EPNAME,
	       T1.EPADDRESS,
	       T1.EPCODE
	  FROM SA_0509IS T1
	 WHERE T1.IFRESULT = 'N'
	       <!-- CRS清单42往送往北理工发数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->
		         AND T1.VIN_NO IN (
                     SELECT VIN_NO  FROM SA_0121T  WHERE  CAR_STAT_CD='70'
                 )
              <!-- CRS清单42往送往北理工发数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->
	 ORDER BY T1.VIN_NO
	 )
	 WHERE ROWNUM <![CDATA[<=]]> #{limit}
	</select>
	
	<!-- 根据反馈信息修改待发送北理工销售数据  -->
    <update id="updateReceiveSalesVehicleIs" parameterType="ReceiveSaleVehicleVO">
    /* [chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO.updateReceiveSalesVehicleIs] */
        UPDATE SA_0509IS    --계약헤더
           SET 
	        IFRESULT = #{ifresult},
	        IFFAILMSG = #{iffailmsg}
         WHERE 1 = 1
           AND VIN_NO     = #{vinNo}
    </update>
    
    <!-- 查询待发送监控平台数据  -->
	<select id="selectSalesMonitorList" parameterType="SalesVehicleMonitorVO" resultType="SalesVehicleMonitorVO">
 	 SELECT * FROM (   
     SELECT   T1.vin_no vin,
			  T1.sell_time,
			  T1.sell_city,
			  T1.dealer_name,
			  T1.dlr_cd dealerCode,
			  T1.car_license,
			  T1.car_license_color,
			  T1.save_city,
			  T1.save_address,
			  T1.drive_licenseno,
			  T1.license_register_date,
			  T1.license_grant_date,
			  T1.customer_type,
			  T1.private_owner_name,
			  T1.private_owner_identity,
			  T1.private_owner_phone,
			  T1.private_owner_address,
			  T1.unit_name,
			  T1.veh_use_for,
			  T1.organization_code,
			  T1.legal_person_name,
			  T1.legal_person_phone,
			  T1.legal_person_address
	  FROM SA_0506_1IS T1
	 WHERE T1.IFRESULT = 'N'
	      <!-- CRS清单42监控平台发数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->
		         AND T1.VIN_NO IN (
                     SELECT VIN_NO  FROM SA_0121T  WHERE  CAR_STAT_CD='70'
                 )
              <!-- CRS清单42监控平台发数据只发 零售即出库状态的数据 贾明 2019-12-18 start -->    
	 ORDER BY T1.VIN_NO
	 )
	 WHERE ROWNUM <![CDATA[<=]]> #{limit}
	</select>
	
	<!-- 根据反馈信息修改待发送监控平台数据  -->
    <update id="updateSalesMonitorIs" parameterType="SalesVehicleMonitorVO">
    /* [chn.bhmc.dms.bat.sal.cdz.service.dao.ChargingPileDAO.updateSalesMonitorIs] */
        UPDATE SA_0506_1IS    --계약헤더
           SET 
	        IFRESULT = #{ifresult},
	        IFFAILMSG = #{iffailmsg}
         WHERE 1 = 1
           AND VIN_NO     = #{vin}
    </update>
</mapper>