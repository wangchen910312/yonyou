<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : PwaApproveDAO_SqlMap.xml
    Description : PWA 승인 에 관한 데이터처리
    author Kwon Ki Hyun
    since 2016. 03. 14.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 03. 14.  Kwon Ki Hyun     최초 생성
-->


<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO">

    <!-- PWA 승인 수정 -->
    <update id="updateStatePwaApproves" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.updateStatePwaApproves] */

        UPDATE SE_0730T                                         --PWA
          SET
             PWA_STAT_CD         = #{pwaStatCd}                 --PWA상태코드
            <if test='pwaStatCd != null and pwaStatCd == "A" '>
            ,PWA_APPROVE_NO      = #{pwaApproveNo}              --PWA승인번호
            ,HQ_APPROVE_DT       = #{hqApproveDt}               --본사승인일자
            ,HQ_APPROVE_ID       = #{hqApproveId}               --본사승인ID
            ,HQ_APPROVE_NM       = #{hqApproveNm}               --본부승인명
            ,LBR_APPROVE_AMT     = NVL(#{lbrApproveAmt}  ,0)    --공임승인금액
            ,ITEM_APPROVE_AMT    = NVL(#{itemApproveAmt} ,0)    --품목승인금액
            ,SUB_LBR_APPROVE_AMT = NVL(#{subLbrApproveAmt},0)   --외주공임승인금액
            ,RETURN_REASON_CONT  = ''
            ,RETURN_DT           = null
            </if>
            <if test='pwaStatCd != null and pwaStatCd == "S" '>
            ,RETURN_REASON_CD    = ''                           --반송사유코드
            ,RETURN_REASON_CONT  = ''                           --반송사유내용
            ,PWA_APPROVE_NO      = ''                           --PWA승인번호
            ,HQ_APPROVE_ID       = ''                           --본사승인ID
            ,HQ_APPROVE_NM       = ''                           --본부승인명
            ,HQ_APPROVE_DT       = ''                           --본사승인일자
            ,LBR_APPROVE_AMT     = null                         --공임승인금액
            ,ITEM_APPROVE_AMT    = null                         --품목승인금액
            ,SUB_LBR_APPROVE_AMT = null                         --외주공임승인금액
            ,RETURN_DT           = null                         --반송일자
            </if>
            <if test='pwaStatCd != null and pwaStatCd == "R" '>
            ,RETURN_REASON_CD    = #{returnReasonCd}            --반송사유코드
            ,RETURN_REASON_CONT  = #{returnReasonCont}          --반송사유내용
            ,PWA_APPROVE_NO      = ''                           --PWA승인번호
            ,HQ_APPROVE_ID       = #{hqApproveId}               --본사승인ID
            ,HQ_APPROVE_NM       = #{hqApproveNm}               --본부승인명
            ,HQ_APPROVE_DT       = ''                           --본사승인일자
            ,LBR_APPROVE_AMT     = null                         --공임승인금액
            ,ITEM_APPROVE_AMT    = null                         --품목승인금액
            ,SUB_LBR_APPROVE_AMT = null                         --외주공임승인금액
            ,RETURN_CNT          = NVL(RETURN_CNT,0) + 1
            ,RETURN_DT           = sysdate                      --반송일자
            </if>
            <if test='pwaStatCd != null and pwaStatCd == "C" '>
            ,RETURN_REASON_CD    = #{returnReasonCd}            --반송사유코드
            ,RETURN_REASON_CONT  = #{returnReasonCont}          --반송사유내용
            ,PWA_APPROVE_NO      = ''                           --PWA승인번호
            ,HQ_APPROVE_ID       = #{hqApproveId}               --본사승인ID
            ,HQ_APPROVE_NM       = #{hqApproveNm}               --본부승인명
            ,HQ_APPROVE_DT       = ''                           --본사승인일자
            ,LBR_APPROVE_AMT     = null                         --공임승인금액
            ,ITEM_APPROVE_AMT    = null                         --품목승인금액
            ,SUB_LBR_APPROVE_AMT = null                         --외주공임승인금액
            ,REJECT_DT           = sysdate                      --거절일자
            </if>
            ,UPDT_USR_ID         = #{updtUsrId}                 --수정자ID
            ,UPDT_DT             = sysdate                      --수정일자
       WHERE 1 = 1
         AND DLR_CD              = #{dlrCd}                     --딜러코드
         AND VIN_NO              = #{vinNo}                     --차대번호
         AND PWA_DOC_NO          = #{pwaDocNo}                  --PWA문서번호
    </update>

    <!-- PWA 승인 사용  -->
    <update id="updatePwaApproveNoInClaim" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.updatePwaApproveForClaim] */

        UPDATE SE_0730T                                       --PWA승인
          SET
            <choose>
               <when test='pwaApproveNo !=null and pwaApproveNo !="" '>
                    RO_DOC_NO       = #{roDocNo}                   --RO일련번호
               </when>
               <otherwise>
                  RO_DOC_NO       = ''
               </otherwise>
            </choose>
              ,UPDT_USR_ID     = #{updtUsrId}                 --수정자ID
              ,UPDT_DT         = sysdate                      --수정일자
         WHERE 1 = 1
           AND DLR_CD          = #{dlrCd}                     --딜러코드
           AND VIN_NO          = #{vinNo}                     --차대번호
           AND PWA_APPROVE_NO  = #{pwaApproveNo}              --PWA 승인번호
    </update>

    <!-- PWA 반려 이력   -->
    <insert id="insertPwaReturn" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.insertPwaReturn] */

        INSERT INTO SE_0730HT (
             SEQ
            ,DLR_CD
            ,VIN_NO
            ,PWA_DOC_NO
            ,PWA_STAT_CD
            ,CAU_OPER_ATC_CD
            ,CAU_ITEM_CD
            ,CAU_CD
            ,CAU_NM
            ,PHEN_CD
            ,PHEN_NM
            ,RUN_DIST_VAL
            ,ERR_PHEN_CONT
            ,RPIR_MTD_CONT
            ,RETURN_REASON_CONT
            ,PWA_TP_CD1
            ,PWA_TP_CD2
            ,CRE_DT
            ,WART_DT
            ,FILE_KEY_NM
            ,LBR_OCCR_AMT
            ,ITEM_OCCR_AMT
            ,SUB_LBR_OCCR_AMT
            ,DLR_SIGN_REQ_DT
            ,PWA_APPROVE_NO
            ,HQ_APPROVE_DT
            ,LBR_APPROVE_AMT
            ,ITEM_APPROVE_AMT
            ,SUB_LBR_APPROVE_AMT
            ,PWA_WRTR_ID
            ,PWA_WRTR_NM
            ,HQ_APPROVE_NM
            ,RO_DOC_NO
            ,APPROVE_REASON_CONT
            ,RETURN_APPROVE_NO
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,HQ_APPROVE_ID
            ,CAR_REG_NO
            ,ENGIN_NO
            ,CAR_OWNER_ID
            ,CAR_OWNER_NM
            ,CAR_OWNER_TEL_NO
            ,DLR_SIGN_REQ_CNT
            ,PWA_SEQ
            ,RETURN_CNT
            ,RETURN_REASON_CD
            ,RETURN_DT
            ,REJECT_DT
        )
        SELECT
            #{seq} SEQ
            ,DLR_CD
            ,VIN_NO
            ,PWA_DOC_NO
            ,PWA_STAT_CD
            ,CAU_OPER_ATC_CD
            ,CAU_ITEM_CD
            ,CAU_CD
            ,CAU_NM
            ,PHEN_CD
            ,PHEN_NM
            ,RUN_DIST_VAL
            ,ERR_PHEN_CONT
            ,RPIR_MTD_CONT
            ,RETURN_REASON_CONT
            ,PWA_TP_CD1
            ,PWA_TP_CD2
            ,CRE_DT
            ,WART_DT
            ,FILE_KEY_NM
            ,LBR_OCCR_AMT
            ,ITEM_OCCR_AMT
            ,SUB_LBR_OCCR_AMT
            ,DLR_SIGN_REQ_DT
            ,PWA_APPROVE_NO
            ,HQ_APPROVE_DT
            ,LBR_APPROVE_AMT
            ,ITEM_APPROVE_AMT
            ,SUB_LBR_APPROVE_AMT
            ,PWA_WRTR_ID
            ,PWA_WRTR_NM
            ,HQ_APPROVE_NM
            ,RO_DOC_NO
            ,APPROVE_REASON_CONT
            ,RETURN_APPROVE_NO
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,HQ_APPROVE_ID
            ,CAR_REG_NO
            ,ENGIN_NO
            ,CAR_OWNER_ID
            ,CAR_OWNER_NM
            ,CAR_OWNER_TEL_NO
            ,DLR_SIGN_REQ_CNT
            ,PWA_SEQ
            ,RETURN_CNT
            ,RETURN_REASON_CD
            ,RETURN_DT
            ,REJECT_DT
         FROM SE_0730T
        WHERE DLR_CD     = #{dlrCd}
          AND PWA_DOC_NO = #{pwaDocNo}
          AND VIN_NO     = #{vinNo}
    </insert>

    <!-- PWA 반려이력 공임   -->
    <insert id="insertPwaLaborReturn" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.insertPwaLaborReturn] */


         INSERT INTO SE_0732HT(
             SEQ
            ,DLR_CD
            ,PWA_DOC_NO
            ,LINE_NO
            ,LBR_CD
            ,LBR_QTY
            ,LBR_HM
            ,LBR_PRC
            ,LBR_AMT
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,CAU_LBR_YN
            ,LBR_NM
         )
          SELECT #{seq} SEQ
                ,DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,LBR_CD
                ,LBR_QTY
                ,LBR_HM
                ,LBR_PRC
                ,LBR_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_LBR_YN
                ,LBR_NM
            FROM SE_0732T
           WHERE DLR_CD    = #{dlrCd}
            AND PWA_DOC_NO = #{pwaDocNo}

    </insert>

    <!-- PWA 반려이력 부품   -->
    <insert id="insertPwaPartReturn" parameterType="PwaVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.insertPwaPartReturn] */


         INSERT INTO SE_0731HT(
             SEQ
            ,DLR_CD
            ,PWA_DOC_NO
            ,LINE_NO
            ,CALC_TP
            ,ITEM_CD
            ,ITEM_NM
            ,REQ_QTY
            ,SALE_UNIT_CD
            ,ITEM_PRC
            ,ITEM_AMT
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,CAU_ITEM_YN
         )
         SELECT #{seq} SEQ
                ,DLR_CD
                ,PWA_DOC_NO
                ,LINE_NO
                ,CALC_TP
                ,ITEM_CD
                ,ITEM_NM
                ,REQ_QTY
                ,SALE_UNIT_CD
                ,ITEM_PRC
                ,ITEM_AMT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
                ,CAU_ITEM_YN
           FROM SE_0731T
           WHERE DLR_CD    = #{dlrCd}
            AND PWA_DOC_NO = #{pwaDocNo}

    </insert>

    <select id="selectPwaApproveMainsByConditionCnt"   parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveMainsByConditionCnt] */

           SELECT COUNT(PWA_DOC_NO) VALUE
            FROM SE_0730T A
            INNER JOIN CM_0101T B
            ON A.DLR_CD = B.DLR_CD
            INNER JOIN CM_2501T C
            ON B.SDPT_CD = C.DIVI_CD
            INNER JOIN CM_2601T D
            ON B.DIST_OFFICE_CD = D.OFF_CD
            WHERE PWA_STAT_CD != 'O'
             <if test='sDlrCd != null and sDlrCd != "" '>
                 AND A.DLR_CD LIKE '%' || #{sDlrCd} || '%'
             </if>

             <if test='sDivision != null and sDivision != "" '>
                 AND C.DIVI_CD = #{sDivision}
             </if>

             <if test='sOffice != null and sOffice != "" '>
                 AND D.OFF_CD = #{sOffice}
             </if>

             <if test='sDivisionLst != null and !sDivisionLst.isEmpty'>
                 AND C.DIVI_CD IN
                <foreach item="item" index="index" collection="sDivisionLst" open="(" separator="," close=")">
                    #{item}
                </foreach>
             </if>
             <if test='sOfficeLst != null and !sOfficeLst.isEmpty'>
                 AND D.OFF_CD IN
                <foreach item="item" index="index" collection="sOfficeLst" open="(" separator="," close=")">
                    #{item}
                </foreach>
             </if>
             <if test='sSelectTabId !=null and sSelectTabId !="" '>
                <choose>
                   <when test='sSelectTabId == "apr" '>
                       <if test='sPwaStatCd !=null and sPwaStatCd != "" '>
                         AND PWA_STAT_CD = #{sPwaStatCd}

                       </if>
                   </when>
                   <otherwise>
                       AND PWA_STAT_CD != 'A'
                       <if test='sPwaStatCd !=null and sPwaStatCd != "" '>
                           AND PWA_STAT_CD = #{sPwaStatCd}
                      </if>
                   </otherwise>
                </choose>
             </if>
               <if test='sVinNo != null and sVinNo != "" '>
                  AND VIN_NO LIKE '%' || #{sVinNo} || '%'
              </if>
              <if test='sFromDt !=null'>
                 AND DLR_SIGN_REQ_DT <![CDATA[>=]]> #{sFromDt}
             </if>
             <if test='sToDt !=null'>
                 AND DLR_SIGN_REQ_DT <![CDATA[<=]]> #{sToDt}+1
             </if>

    </select>

    <!-- PWA 요청 목록 조회  -->
    <select id="selectPwaApproveMainsByCondition"   parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveMainsByCondition] */

        SELECT *
          FROM (
              SELECT ROWNUM AS RNUM , T1.*
                FROM (
                SELECT PWA_STAT_CD  -- 상태
                      ,PWA_DOC_NO
                      ,(SELECT CMM_CD_TXT FROM CM_0304T WHERE LANG_CD = NVL( #{sLangCd},'zh') AND CMM_GRP_CD ='SER102' AND CMM_CD = PWA_STAT_CD ) PWA_STAT_NM
                      ,A.DLR_CD --딜러
                      ,(SELECT DLR_NM FROM CM_0101T WHERE DLR_CD = A.DLR_CD) AS DLR_NM  --딜러명
                      ,VIN_NO --빈번호
                      ,PWA_APPROVE_NO --PWA승인번호
                      ,CAR_OWNER_ID --차량소유자ID
                      ,(SELECT CUST_NM FROM CR_0101T WHERE DLR_CD = A.DLR_CD AND CUST_NO = CAR_OWNER_ID) AS CAR_OWNER_NM
                      ,DLR_SIGN_REQ_DT --신청일자
                      ,CASE WHEN PWA_STAT_CD = 'A'
                                  THEN HQ_APPROVE_DT
                             WHEN PWA_STAT_CD = 'R'
                                  THEN RETURN_DT
                             WHEN PWA_STAT_CD = 'C'
                                  THEN REJECT_DT
                             END AS HQ_APPROVE_DT  --심사일자
                      ,CAU_OPER_ATC_CD --주조작코드
                      ,CAU_ITEM_CD --원인부품
                      ,PWA_TP_CD1 --PWA_TP_CD1
                      ,PWA_TP_CD2 --PWA_TP_CD2
					  ,RUN_DIST_VAL --行车里程
                      ,ITEM_OCCR_AMT --부품금액
                      ,LBR_OCCR_AMT --공임금액
                      ,SUB_LBR_OCCR_AMT --외주금액
                      ,ITEM_OCCR_AMT+LBR_OCCR_AMT+SUB_LBR_OCCR_AMT AS OCCR_AMT_SUM --합계
                      ,ITEM_APPROVE_AMT --부품승인금액
                      ,LBR_APPROVE_AMT --공임승인금액
                      ,SUB_LBR_APPROVE_AMT --외주승인금액
                      ,(ITEM_APPROVE_AMT+LBR_APPROVE_AMT+SUB_LBR_APPROVE_AMT) AS APPROVE_AMT_SUM --합계
                      ,HQ_APPROVE_NM --판정자명
					  ,ERR_PHEN_CONT --故障说明
                      ,RPIR_MTD_CONT --维修方案
                      ,RETURN_REASON_CONT --미승인원인
                      ,RETURN_CNT
                  FROM SE_0730T A
                    INNER JOIN CM_0101T B
                    ON A.DLR_CD = B.DLR_CD
                    INNER JOIN CM_2501T C
                    ON B.SDPT_CD = C.DIVI_CD
                    INNER JOIN CM_2601T D
                    ON B.DIST_OFFICE_CD = D.OFF_CD
                 WHERE PWA_STAT_CD != 'O'
                 <if test='sDlrCd != null and sDlrCd != "" '>
                     AND A.DLR_CD LIKE '%' || #{sDlrCd} || '%'
                 </if>

                 <if test='sDivision != null and sDivision != "" '>
                     AND C.DIVI_CD = #{sDivision}
                 </if>

                 <if test='sOffice != null and sOffice != "" '>
                     AND D.OFF_CD = #{sOffice}
                 </if>

                 <if test='sDivisionLst != null and !sDivisionLst.isEmpty'>
                     AND C.DIVI_CD IN
                    <foreach item="item" index="index" collection="sDivisionLst" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                 </if>
                 <if test='sOfficeLst != null and !sOfficeLst.isEmpty'>
                     AND D.OFF_CD IN
                    <foreach item="item" index="index" collection="sOfficeLst" open="(" separator="," close=")">
                        #{item}
                    </foreach>
                 </if>
                 <if test='sSelectTabId !=null and sSelectTabId !="" '>
                     <choose>
                         <when test='sSelectTabId == "apr" '>
                             <if test='sPwaStatCd !=null and sPwaStatCd != "" '>
                                 AND PWA_STAT_CD = #{sPwaStatCd}
                             </if>
                         </when>
                         <otherwise>
                             AND PWA_STAT_CD != 'A'
                             <if test='sPwaStatCd !=null and sPwaStatCd != "" '>
                                 AND PWA_STAT_CD = #{sPwaStatCd}
                             </if>
                         </otherwise>
                     </choose>
                 </if>
                 <if test='sVinNo != null and sVinNo != "" '>
                     AND VIN_NO LIKE '%' || #{sVinNo} || '%'
                 </if>
                 <if test='sFromDt !=null'>
                     AND DLR_SIGN_REQ_DT <![CDATA[>=]]> #{sFromDt}
                 </if>
                 <if test='sToDt !=null'>
                     AND DLR_SIGN_REQ_DT <![CDATA[<=]]> #{sToDt}+1
                 </if>
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "pwaStatCd"'>PWA_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                       <if test='sPwaStatCd == "A" '>
                                         HQ_APPROVE_DT ASC
                                       </if>
                                       <if test='sPwaStatCd != "A" '>
                                         DLR_SIGN_REQ_DT ASC
                                       </if>
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        <if test='sPwaStatCd == "A" '>
                         HQ_APPROVE_DT ASC
                       </if>
                       <if test='sPwaStatCd != "A" '>
                         DLR_SIGN_REQ_DT ASC
                       </if>
                    </otherwise>
                </choose>
              ) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>

    </select>


    <!-- PWA 상세정보 -->
    <select id="selectPwaApproveByKey"   parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveByKey] */

    SELECT DLR_CD
          ,VIN_NO
          ,PWA_DOC_NO
          ,PWA_STAT_CD
          ,CAU_OPER_ATC_CD
          ,( SELECT
                    <choose>
                        <when test='sLangCd == "ko"' >  LBR_EN_NM</when>
                        <otherwise>LBR_CHN_NM</otherwise>
                     </choose>
                FROM SE_1060T
               WHERE DSTIN_CD ='H'
                 AND DLR_CD   ='A07AA'
                 AND LBR_CD   = CAU_OPER_ATC_CD) CAU_OPER_ATC_NM
          ,CAU_ITEM_CD
          ,(SELECT
                 <choose>
                    <when test='sLangCd == "ko"' >  ITEM_EN_NM</when>
                    <otherwise>ITEM_NM</otherwise>
                 </choose>
             FROM PT_0201T
            WHERE DLR_CD  = 'A07AA'
              AND SPYR_CD = '01'
              AND ITEM_CD = CAU_ITEM_CD ) AS CAU_ITEM_NM
          ,CAU_CD
          ,CAU_NM
          ,PHEN_CD
          ,PHEN_NM
          ,RUN_DIST_VAL
          ,ERR_PHEN_CONT
          ,RPIR_MTD_CONT
          ,RETURN_REASON_CD
          ,RETURN_REASON_CONT
          ,PWA_TP_CD1
          ,PWA_TP_CD2
          ,CRE_DT
          ,WART_DT
          ,FILE_KEY_NM
          ,LBR_OCCR_AMT
          ,ITEM_OCCR_AMT
          ,SUB_LBR_OCCR_AMT
          ,(LBR_OCCR_AMT + ITEM_OCCR_AMT + SUB_LBR_OCCR_AMT) AS TOT_OCCR_AMT
          ,DLR_SIGN_REQ_DT
          ,PWA_APPROVE_NO
          ,HQ_APPROVE_DT
          ,CASE WHEN PWA_STAT_CD = 'A' THEN LBR_APPROVE_AMT ELSE LBR_OCCR_AMT END LBR_APPROVE_AMT
          ,CASE WHEN PWA_STAT_CD = 'A' THEN ITEM_APPROVE_AMT ELSE ITEM_OCCR_AMT END ITEM_APPROVE_AMT
          ,CASE WHEN PWA_STAT_CD = 'A' THEN SUB_LBR_APPROVE_AMT ELSE SUB_LBR_OCCR_AMT END SUB_LBR_APPROVE_AMT
          ,CASE WHEN PWA_STAT_CD = 'A'
                THEN (NVL(LBR_APPROVE_AMT,0) +
                      NVL(ITEM_APPROVE_AMT ,0) +
                      NVL(SUB_LBR_APPROVE_AMT,0 )
                     )
                ELSE (NVL(LBR_OCCR_AMT,0) + NVL(ITEM_OCCR_AMT,0) + NVL(SUB_LBR_OCCR_AMT,0)) END TOT_APPROVE_AMT
          ,PWA_WRTR_ID
          ,PWA_WRTR_NM
          ,HQ_APPROVE_ID
          ,HQ_APPROVE_NM
          ,RO_DOC_NO
          ,APPROVE_REASON_CONT , RETURN_APPROVE_NO
          ,#{sLtsModelCd} AS LTS_MODEL_CD
          ,(SELECT
                 <choose>
                    <when test='sLangCd == "ko"' >  LTS_EN_NM</when>
                    <otherwise>LTS_CHN_NM</otherwise>
                 </choose>
              FROM SE_1064T
              WHERE LTS_MODEL_CD = #{sLtsModelCd} ) AS LTS_MODEL_NM
           ,CAR_REG_NO
           ,ENGIN_NO
           ,CAR_OWNER_ID
           ,CAR_OWNER_NM
           ,CAR_OWNER_TEL_NO
           ,RETURN_CNT
           ,CALC_DOC_NO      --服务结算单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-4-21
           ,PWA_REQUI_NO     --关联申请单号     PWA申请 csr 62 需求延保索赔申请类型的PWA申请单 贾明 2020-4-21 
      FROM SE_0730T
      WHERE DLR_CD = #{sDlrCd}
       <if test='sVinNo != null and sVinNo != "" '>
        AND VIN_NO = #{sVinNo}
       </if>
       <if test='sPwaDocNo != null and sPwaDocNo != "" '>
        AND PWA_DOC_NO = #{sPwaDocNo}
        </if>

    </select>
    <!-- 特殊车辆保修结束日期查询 -->
    <select id="selectSpecialCarWarrantyEndInfo" parameterType="String" resultType="Integer">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectSpecialCarWarrantyEndInfo] */
       SELECT 
       NORM_WARR_PER  
       FROM SE_1151T
       WHERE 1=1
       AND VIN_NO = #{vinNo}
    </select>
    <!--pwa车辆保修结束日期查询逻辑  -->
	<select id="selectCarWarrantyEndDtByKey" parameterType="PwaVO" resultType="java.util.Date">
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaRequestDAO.selectCarWarrantyEndDtByKey] */
          SELECT ADD_MONTHS( #{wartDt} - 1 ,CASE WHEN (SELECT CAR_DSTIN_CD FROM SA_0121T WHERE VIN_NO = #{vinNo} ) ='P' THEN LMT_MM ELSE TAXI_LMT_MM END )  AS GRTE_END_DT
            FROM (
            SELECT CASE WHEN LMT_MM IS NULL THEN A_LMT_MM ELSE LMT_MM END LMT_MM
                  ,CASE WHEN TAXI_LMT_MM IS NULL THEN A_TAXI_LMT_MM ELSE TAXI_LMT_MM END TAXI_LMT_MM
              FROM (
              SELECT MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN LMT_MM END)                AS LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN LMT_RUN_DIST_VAL END)      AS LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN TAXI_LMT_RUN_DIST_VAL END) AS TAXI_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD = #{ltsModelCd} THEN TAXI_LMT_MM END)           AS TAXI_LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN LMT_MM END)                          AS A_LMT_MM
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN LMT_RUN_DIST_VAL END)                AS A_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN TAXI_LMT_RUN_DIST_VAL END)           AS A_TAXI_LMT_RUN_DIST_VAL
                    ,MAX(CASE WHEN A.LTS_MODEL_CD ='ALL' THEN TAXI_LMT_MM END)                     AS A_TAXI_LMT_MM
                FROM SE_1120T A
               WHERE (A.LTS_MODEL_CD = #{ltsModelCd} OR LTS_MODEL_CD ='ALL' )
                AND TO_DATE( TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') BETWEEN APPLY_START_DT AND APPLY_END_DT
                AND WART_RPIR_TP ='W'
             )
           )
    </select>

    <!-- PWA 요청 공임 갯수 정보 -->
    <select id="selectPwaApproveLbrsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveLbrsByConditionCnt] */

        SELECT COUNT(LBR_CD) AS VALUE
          FROM SE_0732T
         WHERE DLR_CD = #{sDlrCd}
           AND PWA_DOC_NO = #{sPwaDocNo}

    </select>

    <!-- PWA 요청 공임 정보 -->
    <select id="selectPwaApproveLbrsByCondition" parameterType="PwaSearchVO" resultType="PwaLbrVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveLbrsByCondition] */

          SELECT ROWNUM AS RNUM ,T1.*
            FROM (
               SELECT A.*
                 FROM (
                SELECT DLR_CD
                      ,PWA_DOC_NO
                      ,LBR_CD
                      ,LBR_NM
                      ,LBR_QTY
                      ,LBR_HM
                      ,LBR_PRC
                      ,LBR_AMT
                      ,CAU_LBR_YN
                  FROM SE_0732T A
                 WHERE DLR_CD = #{sDlrCd}
                   AND PWA_DOC_NO = #{sPwaDocNo}
                )A
              ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "lbrCd"'>LBR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    LBR_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        LBR_CD ASC
                    </otherwise>
                </choose>
              ) T1

    </select>

    <!-- PWA 요청 부품 갯수 정보 -->
    <select id="selectPwaApprovePartsByConditionCnt" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApprovePartsByConditionCnt] */

         SELECT COUNT(ITEM_CD) AS VALUE
          FROM SE_0731T
         WHERE DLR_CD = #{sDlrCd}
           AND PWA_DOC_NO = #{sPwaDocNo}

    </select>

    <!-- PWA 요청 부품 정보 -->
    <select id="selectPwaApprovePartsByCondition" parameterType="PwaSearchVO" resultType="PwaPartVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApprovePartsByCondition] */

          SELECT ROWNUM AS RNUM ,T1.*
            FROM (
                 SELECT DLR_CD
                       ,PWA_DOC_NO
                       ,LINE_NO
                       ,ITEM_CD
                       ,ITEM_NM
                       ,REQ_QTY
                       ,SALE_UNIT_CD
                       ,ITEM_PRC
                       ,ITEM_AMT
                       ,CAU_ITEM_YN
                  FROM SE_0731T
                 WHERE DLR_CD = #{sDlrCd}
                   AND PWA_DOC_NO = #{sPwaDocNo}
                   ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "itemCd"'>ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "itemNm"'>ITEM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    ITEM_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        ITEM_CD ASC
                    </otherwise>
                </choose>
              ) T1

    </select>

    <!-- PWA 승인건 조회 팝업 -->
    <select id="selectPwaApproveClaimByCondition" parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaApproveClaimByCondition] */

            SELECT ROWNUM AS RNUM
                  ,A.DLR_CD
                  ,A.VIN_NO
                  ,A.PWA_DOC_NO
                  ,A.PWA_STAT_CD
                  ,A.CAU_OPER_ATC_CD
                  ,A.CAU_ITEM_CD
                  ,A.CAU_CD
                  ,A.CAU_NM
                  ,A.PHEN_CD
                  ,A.PHEN_NM
                  ,A.RUN_DIST_VAL
                  ,A.PWA_TP_CD1
                  ,A.PWA_TP_CD2
                  ,A.PWA_APPROVE_NO
                  ,A.HQ_APPROVE_DT
                  ,A.LBR_APPROVE_AMT
                  ,A.ITEM_APPROVE_AMT
                  ,A.SUB_LBR_APPROVE_AMT
                  ,( A.LBR_APPROVE_AMT
                    +A.ITEM_APPROVE_AMT
                    +A.SUB_LBR_APPROVE_AMT
                   ) TOT_APPROVE_AMT
                  ,A.HQ_APPROVE_NM
                  ,A.RO_DOC_NO
                  ,A.APPROVE_REASON_CONT
                  ,A.RETURN_APPROVE_NO
                  ,A.HQ_APPROVE_ID
              FROM SE_0730T A
               WHERE 1=1 
               AND A.VIN_NO= #{sVinNo}
               <if test='sPwaStatCd != null and sPwaStatCd !="" '>
               AND A.PWA_STAT_CD = #{sPwaStatCd}
               </if>
               AND A.RO_DOC_NO IS NULL
               AND NOT EXISTS(
                           SELECT DLR_CD, VIN_NO , PWA_APPROVE_NO
                             FROM SE_0710T B
                            WHERE DLR_CD = A.DLR_CD
                              AND CLAIM_STAT_CD != 'C'
                              AND VIN_NO = A.VIN_NO
                              AND RO_DOC_NO != #{sRoDocNo}
                              AND VIN_NO = #{sVinNo}
                              AND PWA_APPROVE_NO = A.PWA_APPROVE_NO
               )
    </select>

    <!-- PWA 반려 MAX SEQ KEY 정보 -->
    <select id="selectPwaReturnHistSeqByKey" parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaReturnHistSeqByKey] */

        SELECT NVL(MAX(SEQ),0)+1 AS VALUE
          FROM SE_0730HT
         WHERE DLR_CD     = #{dlrCd}
           AND VIN_NO     = #{vinNo}
           AND PWA_DOC_NO = #{pwaDocNo}

    </select>


    <!-- PWA 이력 그리드 갯수 정보 -->
    <select id="selectPwaHistoryByConditionCnt"   parameterType="PwaSearchVO" resultType="int" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaHistoryByConditionCnt] */

           SELECT COUNT(PWA_DOC_NO) VALUE
             FROM SE_0730HT
            WHERE PWA_STAT_CD != 'O'
              AND DLR_CD     = #{sDlrCd}
              AND PWA_DOC_NO = #{sPwaDocNo}
              AND VIN_NO     = #{sVinNo}

    </select>
     <!-- PWA 이력 목록 조회  -->
    <select id="selectPwaHistoryByCondition"   parameterType="PwaSearchVO" resultType="PwaVO" >
        /* [chn.bhmc.dms.ser.wac.service.dao.PwaApproveDAO.selectPwaHistoryByCondition] */

        SELECT *
          FROM (
              SELECT ROWNUM AS RNUM , T1.*
                FROM (
                SELECT PWA_STAT_CD  -- 상태
                      ,PWA_DOC_NO
                      ,(SELECT CMM_CD_TXT FROM CM_0304T WHERE LANG_CD = NVL(#{sLangCd},'zh') AND CMM_GRP_CD ='SER102' AND CMM_CD = PWA_STAT_CD ) PWA_STAT_NM
                      ,DLR_CD --딜러
                      ,(SELECT DLR_NM FROM CM_0101T WHERE DLR_CD = A.DLR_CD) AS DLR_NM  --딜러명
                      ,VIN_NO --빈번호
                      ,PWA_APPROVE_NO       --PWA승인번호
                      ,CAR_OWNER_ID         --차량소유자ID
                      ,(SELECT CUST_NM FROM CR_0101T WHERE DLR_CD = A.DLR_CD AND CUST_NO = CAR_OWNER_ID ) AS CAR_OWNER_NM
                      ,DLR_SIGN_REQ_DT      --신청일자
                      ,CASE WHEN PWA_STAT_CD = 'A'
                                  THEN HQ_APPROVE_DT
                             WHEN PWA_STAT_CD = 'R'
                                  THEN RETURN_DT
                             WHEN PWA_STAT_CD = 'C'
                                  THEN REJECT_DT
                             END AS HQ_APPROVE_DT  --심사일자
                      ,RETURN_DT            --반송일자
                      ,REJECT_DT            --거절일자
                      ,CAU_OPER_ATC_CD      --주조작코드
                      ,CAU_ITEM_CD          --원인부품
                      ,PWA_TP_CD1           --PWA_TP_CD1
                      ,PWA_TP_CD2           --PWA_TP_CD2
                      ,ITEM_OCCR_AMT        --부품금액
                      ,LBR_OCCR_AMT         --공임금액
                      ,SUB_LBR_OCCR_AMT     --외주금액
                      ,ITEM_OCCR_AMT+LBR_OCCR_AMT+SUB_LBR_OCCR_AMT AS OCCR_AMT_SUM --합계
                      ,ITEM_APPROVE_AMT     --부품승인금액
                      ,LBR_APPROVE_AMT      --공임승인금액
                      ,SUB_LBR_APPROVE_AMT  --외주승인금액
                      ,(ITEM_APPROVE_AMT+LBR_APPROVE_AMT+SUB_LBR_APPROVE_AMT) AS APPROVE_AMT_SUM --합계
                      ,HQ_APPROVE_NM        --판정자명
                      ,RETURN_REASON_CONT   --미승인원인
                      ,RETURN_CNT
                  FROM SE_0730HT A
                 WHERE PWA_STAT_CD != 'O'
                   AND DLR_CD     = #{sDlrCd}
                   AND PWA_DOC_NO = #{sPwaDocNo}
                   AND VIN_NO     = #{sVinNo}
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "pwaStatCd"'>PWA_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                       <if test='sPwaStatCd == "A" '>
                                         HQ_APPROVE_DT ASC
                                       </if>
                                       <if test='sPwaStatCd != "A" '>
                                         DLR_SIGN_REQ_DT ASC
                                       </if>
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        <if test='sPwaStatCd == "A" '>
                         HQ_APPROVE_DT ASC
                       </if>
                       <if test='sPwaStatCd != "A" '>
                         DLR_SIGN_REQ_DT ASC
                       </if>
                    </otherwise>
                </choose>
              ) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>

    </select>


</mapper>