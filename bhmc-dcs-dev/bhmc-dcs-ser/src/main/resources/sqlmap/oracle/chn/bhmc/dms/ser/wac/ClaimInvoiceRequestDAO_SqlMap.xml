<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ClaimInvoiceRequestServiceDao.xml
    Description : 结算单相关信息查询
    author wangc
    since 2021年4月8日
    version 1.0
-->


<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceReceptionDao">
	
	<!-- 查询结算单数量 wangc 2021年4月12日21:03:04 -->
	<select id="selectClaimInvoiceReceptionForInvoiceByInvoiceCnt" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceSearchVO" resultType="int">
     SELECT count(*)
     FROM (    
        select ROWNUM AS RNUM , T1.* 
		from(
		    select invoice.DLR_CD,(select DLR_NM from CM_0101T where DLR_CD = invoice.DLR_CD) as DLR_NM,invoice.INVC_NO,
		           invoice.RECEIPT_TP,invoice.RECIP_DT,invoice.FAIL_DT,pack.invc_Dt,pack.invc_Claim_Tot_Amt,pack.ddct_Tot_Amt,
		           pack.confirm_Tot_Amt,invoice.TRSF_NO,invoice.EXPS_CMP_NM,invoice.TRSF_TP,invoice.FAIL_MSG,invoice.SENDER_NM,
		           invoice.SENDER_TELNO,invoice.SENDER_ADDR
		    from SE_0960T invoice 
		    left join se_0930t pack on invoice.INVC_NO=pack.INVC_NO
		    where 1 = 1
		    <if test='sdlrCd != null and sdlrCd != "" '>
            AND invoice.DLR_CD = #{sdlrCd}
            </if>
            <if test='sdlrNm != null and sdlrNm != "" '>
            AND DLR_NM = #{sdlrNm}
            </if>
            <if test='sinvcNo != null and sinvcNo != "" '>
            AND invoice.INVC_NO = #{sinvcNo}
            </if>
            <if test='sinvcsFromDt !=null'>
            AND pack.invc_Dt <![CDATA[>=]]> #{sinvcsFromDt}
            </if>
            <if test='sinvcsToDt !=null'>
            AND pack.invc_Dt <![CDATA[<]]> #{sinvcsToDt}+1
            </if>
            <if test='sreceiptTp != null and sreceiptTp != "" '>
            AND invoice.RECEIPT_TP = #{sreceiptTp}
            </if>
            <if test='strsfTp != null and strsfTp != "" '>
            AND invoice.TRSF_TP = #{strsfTp}
            </if>
		    ORDER BY pack.invc_Dt desc
		) T1
		<where>
            <if test='firstIndex != -1 and lastIndex != -1'>
              AND ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
        </where>
    )<where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
    </where>
    </select>
	
	
	<!-- 查询结算单列表信息 wangc 2021年4月12日20:32:30 -->
	<select id="selectClaimInvoiceReceptionForInvoiceByInvoicel" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceSearchVO" resultType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceVO">
     SELECT *
     FROM (    
        select ROWNUM AS RNUM , T1.* 
		from(
		    select invoice.DLR_CD,(select DLR_NM from CM_0101T where DLR_CD = invoice.DLR_CD) as DLR_NM,invoice.INVC_NO,
		           invoice.RECEIPT_TP,invoice.RECIP_DT,invoice.FAIL_DT,pack.invc_Dt,pack.invc_Claim_Tot_Amt,pack.ddct_Tot_Amt,
		           pack.confirm_Tot_Amt,invoice.TRSF_NO,invoice.EXPS_CMP_NM,invoice.TRSF_TP,invoice.FAIL_MSG,invoice.FAIL_REMARK,
		           invoice.SENDER_NM,invoice.SENDER_TELNO,invoice.SENDER_ADDR,invoice.CANCEL_YN
		    from SE_0960T invoice 
		    left join se_0930t pack on invoice.INVC_NO=pack.INVC_NO
		    where 1 = 1
		    <if test='sdlrCd != null and sdlrCd != "" '>
            AND invoice.DLR_CD = #{sdlrCd}
            </if>
            <if test='sdlrNm != null and sdlrNm != "" '>
            AND DLR_NM = #{sdlrNm}
            </if>
            <if test='sinvcNo != null and sinvcNo != "" '>
            AND invoice.INVC_NO = #{sinvcNo}
            </if>
            <if test='sinvcsFromDt !=null'>
            AND pack.invc_Dt <![CDATA[>=]]> #{sinvcsFromDt}
            </if>
            <if test='sinvcsToDt !=null'>
            AND pack.invc_Dt <![CDATA[<]]> #{sinvcsToDt}+1
            </if>
            <if test='sreceiptTp != null and sreceiptTp != "" '>
            AND invoice.RECEIPT_TP = #{sreceiptTp}
            </if>
            <if test='strsfTp != null and strsfTp != "" '>
            AND invoice.TRSF_TP = #{strsfTp}
            </if>
		    ORDER BY pack.invc_Dt desc
		) T1
		<where>
            <if test='firstIndex != -1 and lastIndex != -1'>
              AND ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
        </where>
    )<where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
    </where>
    </select>
    
    	<!-- 查询发票单列表信息 wangc 2021年4月12日20:32:40 -->
    <select id="selectClaimInvoiceDetailForInvoiceByInvoicel" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceDetailSearchVO" resultType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceDetailVO">
     SELECT *
     FROM (	
    	select ROWNUM AS RNUM , T1.* 
		from(
	    	select 
			  t.RECEIPT_CD,t.BUY_NM,t.TAXPAYER_ID_CD,
			  t.RECEIPT_ISS_DT,t.SUM_AMT,t.REMARK
			from SA_0502T t
			where t.RECEIPT_STATUS = '01'
			and t.SETTLEMENT_NO = #{settlementNo}
    	) T1
    	<where>
            <if test='firstIndex != -1 and lastIndex != -1'>
              AND ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
        </where>
    )<where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
    </where>
    </select>
    
    <!-- 查询发票单数量 wangc 2021年4月12日21:02:39 -->
    <select id="selectClaimInvoiceDetailForInvoiceByInvoiceCnt" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceDetailSearchVO" resultType="int">
     SELECT count(*)
     FROM (	
    	select ROWNUM AS RNUM , T1.* 
		from(
	    	select 
			  t.RECEIPT_CD,t.BUY_NM,t.TAXPAYER_ID_CD,
			  t.RECEIPT_ISS_DT,t.SUM_AMT,t.REMARK
			from SA_0502T t
			where t.RECEIPT_STATUS = '01'
			and t.SETTLEMENT_NO = #{settlementNo}
    	) T1
    	<where>
            <if test='firstIndex != -1 and lastIndex != -1'>
              AND ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
        </where>
    )<where>
        <if test='firstIndex != -1 and lastIndex != -1'>
            RNUM > #{firstIndex}
        </if>
    </where>
    </select>
    
    <!-- 根据结算报表编号查询结算单信息 wangc 2021年4月12日20:39:57 -->
     <select id="selectClaimInvoiceReceptionByInvcNo" parameterType="String" resultType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceVO">
     	select * from  SE_0960T invoice where invoice.INVC_NO = #{sinvcNo}
     </select>
     


         <!-- 退票存储  wangc 2021年4月13日15:44:21 --> 
    <update id="updateClaimInvoiceRefund" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceVO">
    		UPDATE SE_0960T SET 
	    		RECEIPT_TP 		= #{receiptTp}
	    	  , TRSF_TP    		= #{trsfTp}
	    	  , FAIL_DT    		= SYSDATE
	    	  , FAIL_CNT   		= FAIL_CNT+1
	    	  , FAIL_MSG   		= #{failMsg}
	    	  , FAIL_REMARK 	= #{failRemark}
    		WHERE 1=1
    		AND INVC_NO 	= #{invcNo}
    </update>
    

    <!-- 收票存储 wangc 2021年4月13日15:44:28 --> 
    <update id="updateClaimInvoiceTaker" parameterType="String">
    		UPDATE SE_0960T 
    		SET RECEIPT_TP = '02' --已开票
	    	  , TRSF_TP    = '03' --车厂接收
	    	  , RECIP_DT   = SYSDATE
    		WHERE 1=1
    		AND INVC_NO = #{invcNo}
    </update>
    <!-- 导入excel的信息 -->
    <select id="selectClaimInvoiceReceptionByExcel" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceSearchVO" resultType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceExcelVO">
    	select invoices.DLR_CD, invoices.DLR_NM,invoices.INVC_NO,
		      (select CMM_CD_NM from CM_0303T where CMM_CD = invoices.RECEIPT_TP and CMM_GRP_CD='SEF004') as RECEIPT_TP,
		      invoices.RECIP_DT,invoices.FAIL_DT,invoices.invc_Dt,invoices.invc_Claim_Tot_Amt,invoices.ddct_Tot_Amt,
		      invoices.confirm_Tot_Amt,invoices.TRSF_NO,invoices.FAIL_REMARK,
		      (select CMM_CD_NM from CM_0303T where CMM_CD = invoices.EXPS_CMP_NM and CMM_GRP_CD='SEF009') as EXPS_CMP_NM,
		      (select CMM_CD_NM from CM_0303T where CMM_CD = invoices.TRSF_TP and CMM_GRP_CD='SEF005') as TRSF_TP,
		      (select CMM_CD_NM from CM_0303T where CMM_CD = invoices.FAIL_MSG and CMM_GRP_CD='SEF006') as FAIL_MSG,
		      invoices.SENDER_NM,invoices.SENDER_TELNO,invoices.SENDER_ADDR, t.RECEIPT_CD,t.BUY_NM,t.TAXPAYER_ID_CD,
		      t.RECEIPT_ISS_DT,t.SUM_AMT,t.REMARK
		from 
		(select invoice.DLR_CD,(select DLR_NM from CM_0101T where DLR_CD = invoice.DLR_CD) as DLR_NM,invoice.INVC_NO,
		        invoice.RECEIPT_TP,invoice.RECIP_DT,invoice.FAIL_DT,pack.invc_Dt,pack.invc_Claim_Tot_Amt,pack.ddct_Tot_Amt,
		        pack.confirm_Tot_Amt,invoice.TRSF_NO,invoice.EXPS_CMP_NM,invoice.TRSF_TP,invoice.FAIL_MSG,invoice.FAIL_REMARK,
		        invoice.SENDER_NM,invoice.SENDER_TELNO,invoice.SENDER_ADDR
		from SE_0960T invoice 
		left join se_0930t pack on invoice.INVC_NO=pack.INVC_NO
		where 1 = 1
		<if test='sdlrCd != null and sdlrCd != "" '>
		AND invoice.DLR_CD = #{sdlrCd}
		</if>
		<if test='sdlrNm != null and sdlrNm != "" '>
		AND DLR_NM = #{sdlrNm}
		</if>
		<if test='sinvcNo != null and sinvcNo != "" '>
		AND invoice.INVC_NO = #{sinvcNo}
		</if>
		<if test='sinvcsFromDt !=null'>
		AND pack.invc_Dt <![CDATA[>=]]> #{sinvcsFromDt}
		</if>
		<if test='sinvcsToDt !=null'>
		AND pack.invc_Dt <![CDATA[<]]> #{sinvcsToDt}+1
		</if>
		<if test='sreceiptTp != null and sreceiptTp != "" '>
        AND invoice.RECEIPT_TP = #{sreceiptTp}
		</if>
		<if test='strsfTp != null and strsfTp != "" '>
		AND invoice.TRSF_TP = #{strsfTp}
		</if>
		) invoices
		left join SA_0502T t on  t.SETTLEMENT_NO = invoices.INVC_NO
    
    
    </select>
    <!-- 下发给DMS wangc 2021年4月20日10:23:07 -->
    <update id="updateInvoiceService" parameterType="chn.bhmc.dms.ser.wac.vo.ClaimInvoiceVO">
    	MERGE INTO se_0960is in0960is
    	USING (select #{dlrCd} as DLR_CD,#{invcNo} as INVC_NO
    		   from dual) se0960is
    	ON (in0960is.INVC_NO = se0960is.INVC_NO)
    	WHEN MATCHED THEN
    	UPDATE
		SET in0960is.DLR_CD = se0960is.DLR_CD,
			in0960is.IFRESULT = 'N',
			in0960is.CREATEDATE = to_char(SYSDATE,'yyyyMMddHH24miss'),
			in0960is.IF_REG_DT = SYSDATE
    	WHEN NOT MATCHED THEN
    	INSERT (
    	in0960is.DLR_CD,in0960is.INVC_NO,in0960is.IFRESULT,in0960is.CREATEDATE,in0960is.IF_REG_DT
    	) VALUES (
    	se0960is.DLR_CD,se0960is.INVC_NO,'N',to_char(SYSDATE,'yyyyMMddHH24miss'),SYSDATE
    	)
    </update>
</mapper>