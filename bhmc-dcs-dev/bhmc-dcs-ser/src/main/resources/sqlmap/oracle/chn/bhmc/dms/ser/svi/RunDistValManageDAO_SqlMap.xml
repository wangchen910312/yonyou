<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : RunDistValManageDAO_SqlMap.xml
    Description : 주행거리 수정 에 관한 데이터처리
    author Kwon Ki Hyun
    since 2016. 02. 19.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 02. 19.  Kwon Ki Hyun     최초 생성
-->

<mapper namespace="chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO">

    <select id="selectRunDistValManagesByConditionCnt" parameterType="RunDistValSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO.selectRunDistValManagesByConditionCnt] */

             SELECT COUNT(RO_DOC_NO) AS VALUE
              FROM SE_0300T A
             <where>
                <if test=' sDlrCd != null and sDlrCd != ""' >
                   DLR_CD = #{sDlrCd}
                </if>
                <if test=' sVinNo != null and sVinNo != "" '>
                   AND VIN_NO = #{sVinNo}
                </if>
                <if test=' sRoDocNo != null and sRoDocNo != "" '>
                   AND RO_DOC_NO = #{sRoDocNo}
                </if>
             </where>
               ORDER BY DLR_CD , RO_DOC_NO , RO_DT DESC

    </select>
    <select id="selectRunDistValManagesByCondition" parameterType="RunDistValSearchVO" resultType="RunDistValManageVO">
        /* [chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO.selectRunDistValManagesByCondition] */

            SELECT A.DLR_CD
                  ,A.RO_DOC_NO
                  ,A.VIN_NO
                  ,A.RO_TP
                  ,FN_CMM_CD_NM('SER031',A.RO_TP , #{sLangCd},'N') AS RO_TP_NM
                  ,A.CAR_REG_NO
                  ,A.RUN_DIST_VAL
                  ,A.CAR_OWNER_NM
                  ,A.DRIVER_NM
                  ,A.RO_DT
                  ,(
                    SELECT CAR_RUN_DIST_VAL
                      FROM SA_0121T
                     WHERE VIN_NO = A.VIN_NO
                  )AS LAST_RUN_DIST_VAL
                  ,RO_STAT_CD
              FROM SE_0300T A
             <where>
                <if test=' sDlrCd != null and sDlrCd != ""' >
                   DLR_CD = #{sDlrCd}
                </if>
                <if test=' sVinNo != null and sVinNo != "" '>
                   AND VIN_NO = #{sVinNo}
                </if>
                <if test=' sRoDocNo != null and sRoDocNo != "" '>
                   AND RO_DOC_NO = #{sRoDocNo}
                </if>
             </where>
           ORDER BY RO_DT DESC
    </select>

    <select id="selectTargetDealerList" parameterType="RunDistValSearchVO" resultType="RunDistValManageVO">
        /* [chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO.selectTargetDealerList] */
        SELECT A.DLR_CD
          FROM SA_0303T A, CM_0101T B
         WHERE A.DLR_CD = B.DLR_CD
           AND B.OPEN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE,'YYYYMMDD')		   
           AND B.ALIVE_YN ='Y'       --tianjx 20190815 链接不上的经销商不查询
		   AND B.DMS_USE_YN='Y'      --tianjx 20191008 链接不上的经销商不查询
           AND VIN_NO = #{vinNo}
         GROUP BY A.DLR_CD
    </select>

    <insert id="insertVinRunDistVal" parameterType="RunDistValManageVO" >
        /* [chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO.insertVinRunDistVal] */

        INSERT INTO SE_2001HT(
           DLR_CD
          ,VIN_NO
          ,RO_TP
          ,RO_DOC_NO
          ,RUN_DIST_VAL
          ,CHG_DT
          ,REG_DT
          ,REG_USR_ID
        )VALUES(
           #{dlrCd}
          ,#{vinNo}
          ,#{roTp}
          ,#{roDocNo}
          ,#{runDistVal}
          ,sysdate
          ,sysdate
          ,#{regUsrId}
        )
    </insert>

    <select id="updateRunDistVal" statementType="CALLABLE" parameterType="RunDistValManageVO">
         { call SP_SER_RUN_DIST_VAL_UPDATE(
            #{dlrCd, mode=IN, jdbcType=VARCHAR}
           ,#{vinNo, mode=IN, jdbcType=VARCHAR}
           ,#{roDocNo, mode=IN, jdbcType=VARCHAR}
           ,#{runDistVal, mode=IN, jdbcType=NUMERIC}
           ,#{lastRunDistVal, mode=IN, jdbcType=NUMERIC}
           ,#{updtUsrId, mode=IN, jdbcType=VARCHAR}
         ) }
    </select>

    <update id="updateVinRunDistVal" parameterType="RunDistValManageVO" >
        /* [chn.bhmc.dms.ser.svi.service.dao.RunDistValManageDAO.updateVinRunDistVal] */

             UPDATE SA_0121T
                SET CAR_RUN_DIST_VAL = #{lastRunDistVal}
                   ,UPDT_USR_ID      = #{updtUsrId}
                   ,UPDT_DT          = sysdate
              WHERE VIN_NO           = #{vinNo}
    </update>

</mapper>