<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ClaimInvoiceRemittanceDAO_SqlMap.xml
    Description : 索赔发票汇款
    author chen shengan
    since 2021. 4. 9.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2021. 4. 9.      chen shengan        索赔发票汇款
-->

<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO">

	<!-- 查询汇款单信息 -->
	<select id="findClaimInvoiceRemittance" parameterType="FindClaimInvoiceRemittanceSearchVO" resultType="ClaimInvoiceRemittanceVO">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.findClaimInvoiceRemittance] */
    SELECT *
          FROM (
              SELECT ROWNUM AS RNUM ,T1.*
                FROM (
					SELECT 
						A.DLR_CD,
						C.DLR_NM,
						A.INVC_NO,
						B.INVC_DT,
						A.PAYM_TP,
						FN_CMM_CD_NM('SER130',A.PAYM_TP, #{sLangCd}, 'N') AS PAYM_NM,
						A.PAYM_DT,
						B.INVC_CLAIM_TOT_AMT,
						B.DDCT_TOT_AMT,
						B.CONFIRM_TOT_AMT
					FROM SE_0960T A 
					LEFT JOIN SE_0930T B ON A.DLR_CD = B.DLR_CD AND A.INVC_NO = B.INVC_NO
					LEFT JOIN CM_0101T C ON A.DLR_CD = C.DLR_CD
					WHERE 
						A.TRSF_TP = '03'
						AND A.RECEIPT_TP = '02'
					<if test="dlrCd != null and dlrCd != '' ">
						AND A.DLR_CD LIKE '%' || #{dlrCd} || '%'
					</if>
					<if test="dlrNm != null and dlrNm != '' ">
						AND C.DLR_NM LIKE '%' || #{dlrNm} || '%'
					</if>
					<if test="paymTp != null and paymTp != '' ">
						AND A.PAYM_TP = #{paymTp}
					</if>
					<if test="invcNo != null and invcNo != '' ">
						AND B.INVC_NO LIKE '%' || #{invcNo} || '%'
					</if>
					<if test="invcDtStart != null and invcDtStart != '' ">
						AND B.INVC_DT <![CDATA[ >= ]]> TO_DATE(#{invcDtStart}, 'yyyy-mm')
					</if>
					<if test="invcDtEnd != null and invcDtEnd != '' ">
						AND B.INVC_DT <![CDATA[ < ]]> ADD_MONTHS(TO_DATE(#{invcDtEnd}, 'yyyy-mm'), 1)
					</if>
					ORDER BY
	                 <choose>
	                    <when test='sort != null'>
	                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
	                            <choose>
	                                <when test='item.field == "dlrCd"'>A.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "dlrNm"'>C.DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "invcNo"'>A.INVC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "invcDt"'>B.INVC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "paymTp"'>A.PAYM_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "paymNm"'>PAYM_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "paymDt"'>A.PAYM_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "invcClaimTotAmt"'>B.INVC_CLAIM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "ddctTotAmt"'>B.DDCT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "confirmTotAmt"'>B.CONFIRM_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <otherwise>
	                                    A.DLR_CD ASC
	                                </otherwise>
	                            </choose>
	                        </foreach>
	                    </when>
	                    <otherwise>
	                        A.DLR_CD ASC
	                    </otherwise>
	                </choose>
					) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>
	
	<!-- 查询汇款单条数 -->
	<select id="findClaimInvoiceRemittanceCnt" parameterType="FindClaimInvoiceRemittanceSearchVO" resultType="int">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.findClaimInvoiceRemittanceCnt] */
		SELECT 
			COUNT(*) AS VALUE
		FROM SE_0960T A 
		LEFT JOIN SE_0930T B ON A.DLR_CD = B.DLR_CD AND A.INVC_NO = B.INVC_NO
		LEFT JOIN CM_0101T C ON A.DLR_CD = C.DLR_CD
		WHERE 
			A.TRSF_TP = '03'
			AND A.RECEIPT_TP = '02'
		<if test="dlrCd != null and dlrCd != '' ">
			AND A.DLR_CD LIKE '%' || #{dlrCd} || '%'
		</if>
		<if test="dlrNm != null and dlrNm != '' ">
			AND C.DLR_NM LIKE '%' || #{dlrNm} || '%'
		</if> 
		<if test="paymTp != null and paymTp != '' ">
			AND A.PAYM_TP = #{paymTp}
		</if>
		<if test="invcNo != null and invcNo != '' ">
			AND B.INVC_NO LIKE '%' || #{invcNo} || '%'
		</if>
		<if test="invcDtStart != null and invcDtStart != '' ">
			AND B.INVC_DT <![CDATA[ >= ]]> TO_DATE(#{invcDtStart}, 'yyyy-mm')
		</if>
		<if test="invcDtEnd != null and invcDtEnd != '' ">
			AND B.INVC_DT <![CDATA[ < ]]> ADD_MONTHS(TO_DATE(#{invcDtEnd}, 'yyyy-mm'), 1)
		</if>
	</select>
	
	<!-- 修改汇款单状态 -->
	<update id="updateClaimInvoiceRemittance">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.updateClaimInvoiceRemittance] */
		UPDATE SE_0960T
		SET PAYM_TP = '02',
			UPDT_DT = SYSDATE,
			UPDT_USR_ID = #{userId},
			PAYM_DT = SYSDATE
		WHERE INVC_NO = #{invcNo}
	</update>
	
	<!-- 查询发票信息 -->
	<select id="selectReceiptByInvcNo" parameterType="FindClaimInvoiceRemittanceSearchVO" resultType="ClaimInvoiceRemittanceReceiptVO">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.selectReceiptByInvcNo] */
		SELECT *
          FROM (
              SELECT ROWNUM AS RNUM ,T1.*
                FROM (
					SELECT 
						RECEIPT_CD,
						SETTLEMENT_NO,
						BUY_NM,
						TAXPAYER_ID_CD,
						RECEIPT_ISS_DT,
						SUM_AMT,
						REMARK 
					FROM SA_0502T
					WHERE SETTLEMENT_NO = #{invcNo}
					ORDER BY
	                 <choose>
	                    <when test='sort != null'>
	                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
	                            <choose>
	                                <when test='item.field == "receiptCd"'>RECEIPT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "buyNm"'>BUY_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "taxpayerIdCd"'>TAXPAYER_ID_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "receiptIssDt"'>RECEIPT_ISS_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "sumAmt"'>SUM_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <when test='item.field == "remark"'>REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
	                                <otherwise>
	                                    RECEIPT_CD ASC
	                                </otherwise>
	                            </choose>
	                        </foreach>
	                    </when>
	                    <otherwise>
	                        RECEIPT_CD ASC
	                    </otherwise>
	                </choose>
					) T1
              <where>
                  <if test='firstIndex != -1 and lastIndex != -1'>
                   AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                  </if>
             </where>
             )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>
	
	<!-- 查询发票信息数量 -->
	<select id="selectReceiptByInvcNoCnt" parameterType="FindClaimInvoiceRemittanceSearchVO" resultType="int">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.selectReceiptByInvcNoCnt] */
		SELECT 
			COUNT(*) AS VALUE 
		FROM SA_0502T
		WHERE SETTLEMENT_NO = #{invcNo}
	</select>
	
	<!-- 查询导出excel需要的数据 -->
	<select id="selectClaimInvoiceRemittanceExcel" parameterType="FindClaimInvoiceRemittanceSearchVO" resultType="ClaimInvoiceRemittanceVO">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.selectClaimInvoiceRemittanceExcel] */
		SELECT 
			A.DLR_CD,
			D.DLR_NM,
			A.INVC_NO,
			C.INVC_DT,
			A.PAYM_TP,
			A.PAYM_DT,
			C.INVC_CLAIM_TOT_AMT,
			C.DDCT_TOT_AMT,
			C.CONFIRM_TOT_AMT,
			B.RECEIPT_CD,
			B.BUY_NM,
			B.TAXPAYER_ID_CD,
			B.RECEIPT_ISS_DT,
			B.SUM_AMT,
			B.SETTLEMENT_NO,
			B.REMARK 
		FROM SE_0960T A
		LEFT JOIN SA_0502T B ON A.DLR_CD = B.DLR_CD AND B.SETTLEMENT_NO = A.INVC_NO
		LEFT JOIN SE_0930T C ON A.DLR_CD = C.DLR_CD AND A.INVC_NO = C.INVC_NO
		LEFT JOIN CM_0101T D ON A.DLR_CD = D.DLR_CD
		WHERE 
			A.TRSF_TP = '03'
			AND A.RECEIPT_TP = '02'
		<if test="dlrCd != null and dlrCd != '' ">
			AND A.DLR_CD LIKE '%' || #{dlrCd} || '%'
		</if>
		<if test="dlrNm != null and dlrNm != '' ">
			AND D.DLR_NM LIKE '%' || #{dlrNm} || '%'
		</if>
		<if test="paymTp != null and paymTp != '' ">
			AND A.PAYM_TP = #{paymTp}
		</if>
		<if test="invcNo != null and invcNo != '' ">
			AND C.INVC_NO LIKE '%' || #{invcNo} || '%'
		</if>
		<if test="invcDtStart != null and invcDtStart != '' ">
			AND C.INVC_DT <![CDATA[ >= ]]> TO_DATE(#{invcDtStart}, 'yyyy-mm')
		</if>
		<if test="invcDtEnd != null and invcDtEnd != '' ">
			AND C.INVC_DT <![CDATA[ < ]]> ADD_MONTHS(TO_DATE(#{invcDtEnd}, 'yyyy-mm'), 1)
		</if>
	</select>
	
	<!-- 批量修改汇款单汇款状态 -->
	<update id="updateClaimInvoiceRemittanceBatch">
	/* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceRemittanceDAO.updateClaimInvoiceRemittanceBatch] */
		UPDATE SE_0960T
		SET PAYM_TP = '02',
			UPDT_DT = SYSDATE,
			UPDT_USR_ID = #{userId},
			PAYM_DT = SYSDATE
		WHERE INVC_NO IN
		<foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item.invcNo}
        </foreach>
	</update>
	
	<!-- 插入汇款单状态下发接口表 -->
	<insert id="addClaimInvoiceRemittanceInterfaceTable">
		INSERT INTO SE_0960IS (DLR_CD, INVC_NO, IFRESULT, CREATEDATE, IF_REG_DT)
		<foreach item="item" index="index" collection="list" open="" separator="union all" close="">
            SELECT 
                #{item.dlrCd}, #{item.invcNo}, 'N', TO_CHAR(SYSDATE,'yyyymmddhh24miss'), SYSDATE
            FROM DUAL
        </foreach>
	</insert>
	
	<!-- 查询汇款单状态下发接口表信息 -->
	<select id="selectClaimInvoiceRemittanceInterfaceTable" resultType="ClaimInvoiceRemittanceVO">
		SELECT 
			DLR_CD,
			INVC_NO
		FROM SE_0960IS
	</select>
	
</mapper>