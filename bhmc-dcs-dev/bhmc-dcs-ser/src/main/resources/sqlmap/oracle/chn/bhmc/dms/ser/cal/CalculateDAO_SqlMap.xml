<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : CalculateDAO_SqlMap.xml
    Description : 정산에 관한 데이터처리
    author KyungMok Kim
    since 2016. 04. 18.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 18.  KyungMok Kim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.ser.cal.service.dao.CalculateDAO">

    <!-- 정산접수 상세 조회. -->
    <select id="selectCalculateByKey" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateByKey] */
        SELECT A.*
              ,B.RO_DT
              ,B.RO_STAT_CD
              ,B.QT_TEST_MTH_CD
              ,B.QT_TEST_STAT_CD
              ,B.GOODWILL_YN
              ,C.RCV_DOC_NO
              ,C.RCV_STAT_CD
              ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
              ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = B.DLR_CD) AS RO_USR_NM
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_HM_CD
                       AND CMM_GRP_CD ='SER126'
                       AND LANG_CD ='zh') ,'6') AS NEXT_FREE_MONTH
              ,NVL((SELECT CMM_CD_TXT
                      FROM SE_1010T A1 , CM_0304T B1
                     WHERE A1.DLR_CD = A.DLR_CD
                       AND CMM_CD = NEXT_FREE_RUN_DIST_VAL_CD
                       AND CMM_GRP_CD ='SER127'
                       AND LANG_CD ='zh'),'5000') AS NEXT_FREE_RUN_DIST_VAL
              ,B.GI_RUN_DIST_VAL
          FROM SE_0500T A
         LEFT OUTER JOIN SE_0300T B
           ON A.DLR_CD    = B.DLR_CD
          AND A.RO_DOC_NO = B.RO_DOC_NO
          AND B.RO_STAT_CD != '06'
         LEFT JOIN SE_0550T C
          ON A.DLR_CD      = C.DLR_CD
         AND A.RO_DOC_NO   = C.RO_DOC_NO
         AND A.CALC_DOC_NO = C.CALC_DOC_NO
        WHERE A.CALC_STAT_CD != '07'
        <if test='sDlrCd != null and sDlrCd != ""'>
          AND A.DLR_CD = #{sDlrCd}
        </if>
        <if test='sRoDocNo != null and sRoDocNo != ""'>
          AND A.RO_DOC_NO = #{sRoDocNo}
          AND A.CALC_CANC_YN = 'N'
        </if>
        <if test='sCalcDocNo != null and sCalcDocNo != ""'>
          AND A.CALC_DOC_NO = #{sCalcDocNo}
        </if>
        <if test='sSerHistYn != null and sSerHistYn != ""'>
          AND A.CALC_STAT_CD = '00'
        </if>
    </select>

    <!-- 정산현황 조회 -->
    <select id="selectCalculateListByCondition" parameterType="CalculateSearchVO" resultType="CalculateVO">
        /* [chn.bhmc.dms.ser.cal.service.dao.CalculateDAO.selectCalculateListByCondition] */

        SELECT * FROM (
            SELECT ROWNUM AS RNUM
                   ,T3.* FROM (
                SELECT T2.*
                  FROM (
                    SELECT T1.*
                          ,FN_CMM_CD_NM('COM020',T1.PAYM_YN , #{sLangCd} ,'N') AS PAYM_YN_NM
                          ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = T1.RO_USR_ID AND DLR_CD = T1.DLR_CD) AS RO_USR_NM
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAYM_AMT - REAL_RCV_AMT,0)
                                ELSE NVL(REAL_PAYM_AMT - REAL_RCV_AMT,0) END AS NPAY_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_CALC_SUM_AMT,0)
                                ELSE NVL(REAL_LBR_CALC_SUM_AMT,0) END AS LBR_CALC_SUM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_CALC_SUM_AMT,0)
                                ELSE NVL(REAL_PAR_CALC_SUM_AMT,0) END AS PAR_CALC_SUM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_ETC_CALC_AMT,0)
                                ELSE NVL(REAL_ETC_CALC_AMT,0) END AS ETC_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_DC_AMT,0)
                                ELSE NVL(REAL_LBR_DC_AMT,0) END AS LBR_DC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_DC_AMT,0)
                                ELSE NVL(REAL_PAR_DC_AMT,0) END AS PAR_DC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_POINT_TOT_AMT,0)
                                ELSE NVL(REAL_POINT_TOT_AMT,0) END AS POINT_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_BM_POINT_TOT_AMT,0)
                                ELSE NVL(REAL_BM_POINT_TOT_AMT,0) END AS BM_POINT_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_BM_CUPN_TOT_AMT,0)
                                ELSE NVL(REAL_BM_CUPN_TOT_AMT,0) END AS BM_CUPN_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_ETC_TOT_AMT,0)
                                ELSE NVL(REAL_ETC_TOT_AMT,0) END AS ETC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_CALC_TOT_AMT,0)
                                ELSE NVL(REAL_CALC_TOT_AMT,0) END AS CALC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_WON_UNIT_CUT_AMT,0)
                                ELSE NVL(REAL_WON_UNIT_CUT_AMT,0) END AS WON_UNIT_CUT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_DEMIC_POINT_CUT_AMT,0)
                                ELSE NVL(REAL_DEMIC_POINT_CUT_AMT,0) END AS DEMIC_POINT_CUT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAYM_AMT,0)
                                ELSE NVL(REAL_PAYM_AMT,0) END AS PAYM_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_RCV_AMT,0)
                                ELSE NVL(REAL_RCV_AMT,0) END AS RCV_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LAST_CALC_TOT_AMT,0)
                                ELSE NVL(REAL_LAST_CALC_TOT_AMT,0) END AS LAST_CALC_TOT_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_LBR_CALC_AMT,0)
                                ELSE NVL(REAL_LBR_CALC_AMT,0) END AS LBR_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(REAL_PAR_CALC_AMT,0)
                                ELSE NVL(REAL_PAR_CALC_AMT,0) END AS PAR_CALC_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(CUPN_AMT,0)
                                ELSE NVL(CUPN_AMT,0) END AS BM_CUPN_AMT
                          ,CASE WHEN CALC_STAT_CD = '07'
                                THEN -1 * NVL(CUPN_CHANGE_AMT,0)
                                ELSE NVL(CUPN_CHANGE_AMT,0) END AS BM_CUPN_CHANGE_AMT
                      FROM (
                        SELECT F1.* FROM (
                             SELECT A.DLR_CD                          --딜러코드
                                   ,A.CALC_DOC_NO                     --정산문서번호
                                   ,A.RO_TP                           --RO유형
                                   ,FN_CMM_CD_NM('SER031',A.RO_TP, #{sLangCd} ,'N') AS RO_TP_NM
                                   ,A.RO_DOC_NO                       --RO문서번호
                                   ,A.RO_GRP_NO                       --RO그룹번호
                                   ,A.RESV_DOC_NO                     --예약문서번호
                                   ,A.DIAG_DOC_NO                     --진단문서번호
                                   ,A.PRE_CHK_DT                      --사전점검일자
                                   ,A.BASE_RO_NO                      --원RO번호
                                   ,A.INC_REQ_NO                      --보험신청번호
                                   ,A.VIN_NO                          --차대번호
                                   ,A.CAR_REG_NO                      --차량등록번호
                                   ,A.ENGIN_NO                        --엔진번호
                                   ,A.CAR_OWNER_ID                    --차량소유자ID
                                   ,A.CAR_OWNER_NM                    --차량소유자명
                                   ,A.DRIVER_ID                       --운전자ID
                                   ,A.DRIVER_NM                       --운전자명
                                   ,B.RUN_DIST_VAL                    --주행거리값
                                   ,A.LBR_CALC_AMT AS REAL_LBR_CALC_AMT                    --공임정산금액
                                   ,A.LBR_DC_RATE                     --공임할인율
                                   ,A.LBR_DC_AMT AS REAL_LBR_DC_AMT                     --공임할인금액
                                   ,A.LBR_BM_POINT_USE_AMT            --공임BM포인트사용금액
                                   ,A.LBR_BM_CUPN_USE_AMT             --공임BM쿠폰사용금액
                                   ,A.LBR_POINT_USE_AMT               --공임포인트사용금액
                                   ,A.LBR_ETC_DC_AMT                  --공임기타할인금액
                                   ,A.LBR_CALC_SUM_AMT AS REAL_LBR_CALC_SUM_AMT           --공임정산합계금액
                                   ,A.PAR_CALC_AMT AS REAL_PAR_CALC_AMT                   --부품정산금액
                                   ,A.PAR_DC_RATE                     --부품할인율
                                   ,A.PAR_DC_AMT AS REAL_PAR_DC_AMT                      --부품할인금액
                                   ,A.PAR_BM_POINT_USE_AMT            --부품BM포인트사용금액
                                   ,A.PAR_BM_CUPN_USE_AMT             --부품BM쿠폰사용금액
                                   ,A.PAR_POINT_USE_AMT               --부품포인트사용금액
                                   ,A.PAR_ETC_DC_AMT                  --부품기타할인금액
                                   ,A.PAR_CALC_SUM_AMT AS REAL_PAR_CALC_SUM_AMT           --부품정산합계금액
                                   ,A.ETC_CALC_AMT AS REAL_ETC_CALC_AMT               --기타정산금액
                                   ,A.ETC_DC_RATE                     --기타할인율
                                   ,A.ETC_DC_AMT                      --기타할인금액
                                   ,A.ETC_BM_POINT_USE_AMT            --기타BM포인트사용금액
                                   ,A.ETC_BM_CUPN_USE_AMT             --기타BM쿠폰사용금액
                                   ,A.ETC_POINT_USE_AMT               --기타포인트사용금액
                                   ,A.ETC_OTHER_DC_AMT                --기타다른할인금액
                                   ,A.ETC_CALC_SUM_AMT                --기타정산합계금액
                                   ,A.CALC_TOT_AMT AS REAL_CALC_TOT_AMT
                                   ,A.DC_TOT_RATE                     --할인총율
                                   ,A.DC_TOT_AMT                      --할인총금액
                                   ,A.BM_POINT_TOT_AMT AS REAL_BM_POINT_TOT_AMT               --BM포인트총금액
                                   ,A.BM_CUPN_TOT_AMT AS REAL_BM_CUPN_TOT_AMT                 --BM쿠폰총금액
                                   ,A.POINT_TOT_AMT AS REAL_POINT_TOT_AMT                   --포인트총금액
                                   ,A.ETC_TOT_AMT AS REAL_ETC_TOT_AMT                     --기타총금액
                                   ,A.LAST_CALC_TOT_AMT AS REAL_LAST_CALC_TOT_AMT
                                   ,A.CALC_DT                         --정산일자
                                   ,A.CALC_STAT_CD                    --정산상태코드
                                   ,FN_CMM_CD_NM('SER030',A.CALC_STAT_CD, #{sLangCd} ,'N') AS CALC_STAT_NM
                                   ,A.CALC_CANC_DT                    --정산취소일자
                                   ,A.CALC_CANC_ID                    --정산취소자
                                   ,A.REG_USR_ID                      --등록자ID
                                   ,A.REG_DT                          --등록일자
                                   ,A.UPDT_USR_ID                     --수정자ID
                                   ,A.UPDT_DT                         --수정일자
                                   ,A.CALC_REMARK
                                   ,A.ETC_DC_CD
                                   ,A.CALC_COMP_USR_ID
                                   ,A.CALC_COMP_USR_NM
                                   ,A.MAIN_CTNO_TP                    --메인연락방법
                                   ,FN_CMM_CD_NM('CRM038',A.MAIN_CTNO_TP, #{sLangCd} ,'N') AS MAIN_CTNO_TP_NM
                                   ,A.MAIN_CTNO_DT_TP                 --메인연락시간
                                   ,FN_CMM_CD_NM('CRM027',A.MAIN_CTNO_DT_TP, #{sLangCd} ,'N') AS MAIN_CTNO_DT_TP_NM
                                   ,B.RO_DT
                                   ,B.RO_STAT_CD
                                   ,B.REG_USR_ID AS RO_USR_ID
                                   ,B.DLR_RO_TP                       --자체RO유형
                                   ,FN_CMM_CD_NM('SER044',B.DLR_RO_TP, #{sLangCd} ,'N') AS DLR_RO_TP_NM
                                   ,(SELECT SUM(NVL(WON_UNIT_CUT_AMT,0))
                                      FROM SE_0530T
                                     WHERE DLR_CD = A.DLR_CD
                                       AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_WON_UNIT_CUT_AMT
                                   ,(SELECT SUM(NVL(DEMIC_POINT_CUT_AMT,0))
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_DEMIC_POINT_CUT_AMT
                                   ,(SELECT SUM(NVL(PAYM_AMT,0))
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO ) AS REAL_PAYM_AMT
                                   ,(SELECT CUPN_NO
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ROWNUM = 1) AS BM_CUPN_NO
                                   ,(SELECT CUPN_NM
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ROWNUM = 1) AS BM_CUPN_NM
                                   ,(SELECT ATVT_TP
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ROWNUM = 1) AS BM_ATVT_TP
                                   ,(SELECT CUPN_AMT
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ROWNUM = 1) AS CUPN_AMT
                                   ,(SELECT CUPN_CHANGE_AMT
                                       FROM SE_0530T
                                      WHERE DLR_CD = A.DLR_CD
                                        AND CALC_DOC_NO = A.CALC_DOC_NO
                                        AND ROWNUM = 1) AS CUPN_CHANGE_AMT
                                   ,( SELECT CASE WHEN SUM(NVL(D.RCV_AMT,0)) = SUM(NVL(D.PAYM_AMT,0)) THEN 'Y' ELSE 'N' END AS PAYM_YN
                                        FROM SE_0550T C , SE_0560T D
                                       WHERE C.DLR_CD      = D.DLR_CD
                                         AND C.RCV_DOC_NO  = D.RCV_DOC_NO
                                         AND C.DLR_CD      = A.DLR_CD
                                         AND C.CALC_DOC_NO = A.CALC_DOC_NO
                                    ) AS PAYM_YN
                                   ,NVL(( SELECT SUM(NVL(D.RCV_AMT,0))
                                        FROM SE_0550T C , SE_0560T D
                                       WHERE C.DLR_CD      = D.DLR_CD
                                         AND C.RCV_DOC_NO  = D.RCV_DOC_NO
                                         AND C.DLR_CD      = A.DLR_CD
                                         AND C.CALC_DOC_NO = A.CALC_DOC_NO
                                    ),0) AS REAL_RCV_AMT
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.CALC_CANC_ID AND DLR_CD = A.DLR_CD) AS CALC_CANC_NM
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                                   ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.UPDT_USR_ID AND DLR_CD = A.DLR_CD) AS UPDT_USR_NM
                                   ,(SELECT CAR_RUN_DIST_VAL FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CAR_RUN_DIST_VAL
                                   ,(SELECT FN_GET_CARLINE_NM(CARLINE_CD) AS CARLINE_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS CARLINE_NM
                                   ,(SELECT FN_GET_MODEL_NM(MODEL_CD) AS MODEL_NM FROM SA_0121T WHERE VIN_NO = A.VIN_NO AND ROWNUM = 1) AS MODEL_NM
                                   ,B.GI_RUN_DIST_VAL
                                   ,A.SER_PAR_DSTIN_CD
                                   ,A.EXPC_CHK_DT
                                   ,A.EXPC_CHK_RUN_DIST_VAL
                               FROM SE_0500T A , SE_0300T B
                              WHERE A.DLR_CD    = B.DLR_CD
                                AND A.RO_DOC_NO = B.RO_DOC_NO
                                AND A.RO_TP     = B.RO_TP
                            <if test='sDlrCd != null and sDlrCd != ""'>
                                AND A.DLR_CD    = #{sDlrCd}
                            </if>
                            <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                                AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                            </if>
                            <if test='sRoDocNo != null and sRoDocNo != ""'>
                                AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                            </if>
                            <if test='sRoTp != null and sRoTp != ""'>
                                AND A.RO_TP =  #{sRoTp}
                            </if>
                            <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                               <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                            <if test='sCarRegNo != null and sCarRegNo != ""'>
                                AND A.CAR_REG_NO LIKE UPPER('%'|| #{sCarRegNo}||'%')
                            </if>
                            <if test='sVinNo != null and sVinNo != ""'>
                                AND A.VIN_NO = UPPER(#{sVinNo})
                            </if>
                            <if test='sDriverNm != null and sDriverNm != ""'>
                                AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                            </if>
                            <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                                AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                            </if>
                            <if test='sCalcFromDt != null'>
                                AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcFromDt}, 'YYYYMMDD')
                            </if>
                            <if test='sCalcToDt != null'>
                                AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcToDt}, 'YYYYMMDD')
                            </if>
                            <if test='sCalcRegFromDt != null'>
                                AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcRegFromDt}, 'YYYYMMDD')
                            </if>
                            <if test='sCalcRegToDt != null'>
                                AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcRegToDt}, 'YYYYMMDD')
                            </if>
                            <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                                AND A.CALC_STAT_CD = #{sCalcStatCd}
                            </if>
                            <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                                AND A.CALC_CANC_YN = #{sCalcCancYn}
                            </if>
                            <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                                AND B.DLR_RO_TP =  #{sDlrRoTp}
                            </if>
                            AND A.VIN_NO IS NOT NULL
                            <choose>
                                <when test='sScreenGb != null and sScreenGb != "" and sScreenGb == "C"'>
                                    AND A.CALC_STAT_CD NOT IN ('03')
                                </when>
                                <otherwise>
                                    AND A.CALC_STAT_CD NOT IN ('03', '04')
                                </otherwise>
                            </choose>
                        ) F1
                        <where>
                            <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                                AND F1.REG_USR_NM = #{sRegUsrNm}
                            </if>
                            <if test='sRoFromDt != null'>
                                AND F1.RO_DT <![CDATA[>=]]> #{sRoFromDt}
                            </if>
                            <if test='sRoToDt != null'>
                                AND F1.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
                            </if>
                        </where>
                      ) T1
                  ) T2
                <where>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND T2.RO_USR_NM  LIKE  '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "carRegNo"'>             T2.CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "vinNo"'>                T2.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                     </when>
                                <when test='item.field == "carOwnerNm"'>           T2.CAR_OWNER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "driverNm"'>             T2.DRIVER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "carlineNm"'>            T2.CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "modelNm"'>              T2.MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "runDistVal"'>           T2.RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "giRunDistVal"'>         T2.GI_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "calcStatNm"'>           T2.CALC_STAT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcDocNo"'>            T2.CALC_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "regDtFormat"'>          T2.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                     </when>
                                <when test='item.field == "regUsrNm"'>             T2.REG_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "calcPrintDtFormat"'>    T2.CALC_PRINT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "calcCancDtFormat"'>     T2.CALC_CANC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcCancNm"'>           T2.CALC_CANC_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "calcCancReasonNm"'>     T2.CALC_CANC_REASON_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "calcDtFormat"'>         T2.CALC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                    </when>
                                <when test='item.field == "calcCompUsrNm"'>        T2.CALC_COMP_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "roDocNo"'>              T2.RO_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "roTpNm"'>               T2.RO_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "dlrRoTpNm"'>            T2.DLR_RO_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "roDtFormat"'>           T2.RO_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                      </when>
                                <when test='item.field == "roUsrNm"'>              T2.RO_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                  </when>
                                <when test='item.field == "paymYnNm"'>             T2.PAYM_YN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "calcRemark"'>           T2.CALC_REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "lbrCalcAmt"'>           T2.LBR_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "parCalcAmt"'>           T2.PAR_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "etcCalcAmt"'>           T2.ETC_CALC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <when test='item.field == "lbrDcAmt"'>             T2.LBR_DC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "parDcAmt"'>             T2.PAR_DC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "pointTotAmt"'>          T2.POINT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "bmPointTotAmt"'>        T2.BM_POINT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "bmCupnTotAmt"'>         T2.BM_CUPN_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "etcTotAmt"'>            T2.ETC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "lastCalcTotAmt"'>       T2.LAST_CALC_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "wonUnitCutAmt"'>        T2.WON_UNIT_CUT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "demicPointCutAmt"'>     T2.DEMIC_POINT_CUT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "paymAmt"'>              T2.PAYM_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "rcvAmt"'>               T2.RCV_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                    </when>
                                <when test='item.field == "npayAmt"'>              T2.NPAY_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                   </when>
                                <when test='item.field == "carRunDistVal"'>        T2.CAR_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "expcChkDtFormat"'>      T2.EXPC_CHK_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "expcChkRunDistVal"'>    T2.EXPC_CHK_RUN_DIST_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "movingAvgAmt"'>         T2.MOVING_AVG_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                <when test='item.field == "bmCupnNo"'>             T2.BM_CUPN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmCupnNm"'>             T2.BM_CUPN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmAtvtTp"'>             T2.BM_ATVT_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                 </when>
                                <when test='item.field == "bmCupnAmt"'>            T2.BM_CUPN_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>                </when>
                                <when test='item.field == "bmCupnChangeAmt"'>      T2.BM_CUPN_CHANGE_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "mainCtnoDtTpNm"'>       T2.MAIN_CTNO_DT_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "mainCtnoTpNm"'>         T2.MAIN_CTNO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>               </when>
                                <otherwise>
                                    T2.CALC_DOC_NO DESC
                                    ,T2.DLR_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        T2.CALC_DOC_NO DESC
                        ,T2.DLR_CD ASC
                    </otherwise>
                </choose>
                ) T3
                <where>
                    <if test='firstIndex != -1 and lastIndex != -1'>
                        ROWNUM <![CDATA[<=]]> #{lastIndex}
                    </if>
                </where>
            )
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    RNUM > #{firstIndex}
                </if>
            </where>
    </select>

    <!-- 정산 현황 목록수를 조회. -->
    <select id="selectCalculateListByConditionCnt" parameterType="CalculateSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.res.service.dao.CalculateDAO.selectCalculateListByConditionCnt] */
             SELECT COUNT(T1.RO_DT) FROM (
                 SELECT A.*
                        ,(SELECT RO_DT
                           FROM SE_0300T
                          WHERE DLR_CD    = A.DLR_CD
                            AND RO_DOC_NO = A.RO_DOC_NO
                            AND RO_TP     = A.RO_TP
                        )AS RO_DT
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                        ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = B.DLR_CD) AS RO_USR_NM
                        ,B.DLR_RO_TP
                   FROM SE_0500T A , SE_0300T B
                  WHERE A.RO_DOC_NO = B.RO_DOC_NO
                    AND A.RO_TP     = B.RO_TP
                    AND A.DLR_CD    = B.DLR_CD
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.DLR_CD    = #{sDlrCd}
                </if>
                <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                    AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                </if>
                <if test='sRoTp != null and sRoTp != ""'>
                    AND A.RO_TP =  #{sRoTp}
                </if>
                <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                   <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                       #{item}
                   </foreach>
                </if>
                <if test='sRoDocNo != null and sRoDocNo != ""'>
                    AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                </if>
                <if test='sCarRegNo != null and sCarRegNo != ""'>
                    AND A.CAR_REG_NO LIKE UPPER('%'|| #{sCarRegNo}||'%')
                </if>
                <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO = UPPER(#{sVinNo})
                </if>
                <if test='sDriverNm != null and sDriverNm != ""'>
                    AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                </if>
                <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                    AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                </if>
                <if test='sCalcFromDt != null'>
                    AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcFromDt}, 'YYYYMMDD')
                </if>
                <if test='sCalcToDt != null'>
                    AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcToDt}, 'YYYYMMDD')
                </if>
                <if test='sCalcRegFromDt != null'>
                    AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcRegFromDt}, 'YYYYMMDD')
                </if>
                <if test='sCalcRegToDt != null'>
                    AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcRegToDt}, 'YYYYMMDD')
                </if>
                <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                    AND A.CALC_STAT_CD = #{sCalcStatCd}
                </if>
                <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                    AND A.CALC_CANC_YN = #{sCalcCancYn}
                </if>
                <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                    AND B.DLR_RO_TP =  #{sDlrRoTp}
                </if>
                AND A.VIN_NO IS NOT NULL
                <if test='sScreenGb != null and sScreenGb != ""'>
                <choose>
                    <when test='sScreenGb == "C"'>
                        AND A.CALC_STAT_CD NOT IN ('03')
                    </when>
                    <otherwise>
                        AND A.CALC_STAT_CD NOT IN ('03', '04')
                    </otherwise>
                </choose>
                </if>
                ) T1
                <where>
                    <if test='sRoFromDt != null'>
                        AND T1.RO_DT <![CDATA[>=]]> #{sRoFromDt}
                    </if>
                    <if test='sRoToDt != null'>
                        AND T1.RO_DT <![CDATA[<]]> #{sRoToDt} + 1
                    </if>
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND T1.REG_USR_NM = #{sRegUsrNm}
                    </if>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND T1.RO_USR_NM  LIKE  '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
    </select>

    <!-- 정산현황 토탈금액 조회 -->
    <select id="selectCalculateAmtByCondition" parameterType="CalculateSearchVO" resultType="CalculateVO">
        SELECT CALC_AMT, CALC_CANC_TOT_AMT, (CALC_AMT - CALC_CANC_TOT_AMT) AS CALC_TOT_AMT
          FROM (
            SELECT NVL(SUM(CASE WHEN CALC_STAT_CD != '07' THEN PAYM_AMT END), 0) AS CALC_AMT
                    ,NVL(SUM(CASE WHEN CALC_STAT_CD = '07' THEN PAYM_AMT END), 0) AS CALC_CANC_TOT_AMT
              FROM (
                    SELECT PAYM_AMT, REG_USR_NM, RO_DT, CALC_STAT_CD
                      FROM (
                        SELECT
                           (SELECT SUM(NVL(PAYM_AMT,0))
                              FROM SE_0530T
                             WHERE DLR_CD = A.DLR_CD
                               AND CALC_DOC_NO = A.CALC_DOC_NO ) AS PAYM_AMT
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = A.REG_USR_ID AND DLR_CD = A.DLR_CD) AS REG_USR_NM
                            ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = B.REG_USR_ID AND DLR_CD = A.DLR_CD) AS RO_USR_NM
                            ,B.RO_DT
                            ,A.CALC_STAT_CD
                        FROM SE_0500T A, SE_0300T B
                        WHERE A.DLR_CD    = B.DLR_CD
                        AND A.RO_DOC_NO = B.RO_DOC_NO
                        AND A.RO_TP     = B.RO_TP
                        AND A.DLR_CD    =  #{sDlrCd}
                        <if test='sCalcDocNo != null and sCalcDocNo != ""'>
                            AND A.CALC_DOC_NO LIKE '%'|| #{sCalcDocNo}||'%'
                        </if>
                        <if test='sRoDocNo != null and sRoDocNo != ""'>
                            AND A.RO_DOC_NO LIKE '%'|| #{sRoDocNo}||'%'
                        </if>
                        <if test='sRoTp != null and sRoTp != ""'>
                            AND A.RO_TP =  #{sRoTp}
                        </if>
                        <if test='sRoTpList != null and !sRoTpList.isEmpty'> AND A.RO_TP IN
                           <foreach item="item" index="index" collection="sRoTpList" open="(" separator="," close=")">
                               #{item}
                           </foreach>
                        </if>
                        <if test='sCarRegNo != null and sCarRegNo != ""'>
                            AND A.CAR_REG_NO LIKE '%'|| #{sCarRegNo}||'%'
                        </if>
                        <if test='sVinNo != null and sVinNo != ""'>
                            AND A.VIN_NO = #{sVinNo}
                        </if>
                        <if test='sDriverNm != null and sDriverNm != ""'>
                            AND A.DRIVER_NM LIKE '%'|| #{sDriverNm} ||'%'
                        </if>
                        <if test='sCarOwnerNm != null and sCarOwnerNm != ""'>
                            AND A.CAR_OWNER_NM LIKE  '%'|| #{sCarOwnerNm}||'%'
                        </if>
                        <if test='sCalcFromDt != null'>
                            AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcFromDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcToDt != null'>
                            AND TO_CHAR(A.CALC_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcToDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcRegFromDt != null'>
                            AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sCalcRegFromDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcRegToDt != null'>
                            AND TO_CHAR(A.REG_DT, 'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sCalcRegToDt}, 'YYYYMMDD')
                        </if>
                        <if test='sCalcStatCd != null and sCalcStatCd != ""'>
                            AND A.CALC_STAT_CD = #{sCalcStatCd}
                        </if>
                        <if test='sCalcCancYn != null and sCalcCancYn != ""'>
                            AND A.CALC_CANC_YN = #{sCalcCancYn}
                        </if>
                        <if test='sDlrRoTp != null and sDlrRoTp != ""'>
                            AND B.DLR_RO_TP =  #{sDlrRoTp}
                        </if>
                        AND A.VIN_NO IS NOT NULL
                        AND A.CALC_STAT_CD NOT IN ('03', '04')
                ) F1
                <where>
                    <if test='sRegUsrNm != null and sRegUsrNm != ""'>
                        AND F1.REG_USR_NM = #{sRegUsrNm}
                    </if>
                    <if test='sRoFromDt != null'>
                        AND TO_CHAR(F1.RO_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sRoFromDt}, 'YYYYMMDD')
                    </if>
                    <if test='sRoToDt != null'>
                        AND TO_CHAR(F1.RO_DT, 'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(#{sRoToDt}, 'YYYYMMDD')
                    </if>
                    <if test='sRoUsrNm != null and sRoUsrNm != ""'>
                        AND F1.RO_USR_NM LIKE '%'|| #{sRoUsrNm}||'%'
                    </if>
                </where>
            ) F2
        ) F3
    </select>

</mapper>