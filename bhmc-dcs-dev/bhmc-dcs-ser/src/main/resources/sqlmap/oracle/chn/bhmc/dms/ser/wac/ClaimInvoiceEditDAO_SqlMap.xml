<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ClaimInvoiceEditDAO_SqlMap.xml
    Description : 索赔发票编辑SqlMap
    author lixinfei
    since 2021. 04. 12.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2021. 04. 12.  lixinfei             索赔发票编辑SqlMap
-->

<mapper namespace="chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO">


    <!-- 索赔发票编辑 数量 -->
    <select id="selectClaimInvoiceEditByConditionCnt" parameterType="ClaimInvoiceEditSearchVO" resultType="long">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.selectClaimStatusByConditionCnt] */
        SELECT COUNT(1) AS VALUE
        FROM SA_0502T A         -- A 发票信息表
          LEFT JOIN SE_0960T C  -- C 索赔单主表
            ON A.DLR_CD = C.DLR_CD
            AND A.SETTLEMENT_NO = C.INVC_NO --索赔结算单信息
          LEFT JOIN SE_0930T D  -- D 索赔报表信息表
            ON A.SETTLEMENT_NO = D.INVC_NO  --索赔结算单信息字段
          LEFT JOIN CM_0101T B  -- B 经销商表
            ON A.DLR_CD = B.DLR_CD
        <where>
                A.CLAIM_YN = 'Y'       --本字段为Y 表示其为索赔发票
            <if test='sDlrCd != null and sDlrCd != ""'>
                AND A.DLR_CD = #{sDlrCd}
            </if>
            <if test='sDlrNm != null and sDlrNm != ""'>
                AND B.DLR_NM = #{sDlrNm}
            </if>
            <if test='sSettlementNo != null and sSettlementNo != ""'>
                AND A.SETTLEMENT_NO LIKE '%' || #{sSettlementNo} || '%'
            </if>
            <if test='sReceiptTp != null and sReceiptTp != ""'>
                AND C.RECEIPT_TP = #{sReceiptTp}
            </if>
            <if test='sReceiptNo != null and sReceiptNo != ""'>
                AND A.RECEIPT_NO = #{sReceiptNo}
            </if>
            <if test='sInvcStartDt != null' >
                AND D.INVC_DT <![CDATA[>=]]> TRUNC(#{sInvcStartDt},'DD')    --报表结算年月start
            </if>
            <if test='sInvcEndDt != null' >
                AND D.INVC_DT <![CDATA[<]]> TRUNC(#{sInvcEndDt},'DD')+1     --报表结算年月end
            </if>
        </where>
    </select>

    <!-- 索赔发票查询  -->
    <select id="selectClaimInvoiceEditByCondition" parameterType="ClaimInvoiceEditSearchVO" resultType="ClaimInvoiceEditVO">
        /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.selectClaimInvoiceEditByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.DLR_CD             --经销商代码
                      ,B.DLR_NM             --经销商名称
                      ,A.SETTLEMENT_NO      --结算单号(允许做出修改的字段)
                      ,C.RECEIPT_TP         --开票状态 编码
                      ,FN_CMM_CD_NM('SEF004',C.RECEIPT_TP, #{sLangCd}, 'N') AS RECEIPT_TP_NM    --开票状态 字符串
                      ,A.RECEIPT_NO         --发票号
                      ,A.RECEIPT_CD         --发票代码
                      ,A.RECEIPT_ID         --发票ID（接口表SA_0502_2IS的主键，可以从SA_0502T表中获取）
                      ,A.BUY_NM             --发票抬头
                      ,A.TAXPAYER_ID_CD     --纳税人识别号
                      ,A.SCAN_SUM_AMT       --发票金额
                      ,C.INVC_NO            --索赔单编号
                  FROM SA_0502T A       -- A 发票信息表
                  LEFT JOIN SE_0960T C  -- C 索赔单主表
                    ON A.DLR_CD = C.DLR_CD
                    AND A.SETTLEMENT_NO = C.INVC_NO --索赔结算单信息字段
                  LEFT JOIN SE_0930T D  -- D 索赔报表信息表
                    ON A.SETTLEMENT_NO = D.INVC_NO  --索赔结算单信息字段
                  LEFT JOIN CM_0101T B  -- B 经销商表
                    ON A.DLR_CD = B.DLR_CD
                <where>
                        A.CLAIM_YN = 'Y'       --本字段为Y 表示其为索赔发票
	                <if test='sDlrCd != null and sDlrCd != ""'>
	                    AND A.DLR_CD = #{sDlrCd}
	                </if>
	                <if test='sDlrNm != null and sDlrNm != ""'>
	                    AND B.DLR_NM = #{sDlrNm}
	                </if>
	                <if test='sSettlementNo != null and sSettlementNo != ""'>
	                    AND A.SETTLEMENT_NO LIKE '%' || #{sSettlementNo} || '%'
	                </if>
	                <if test='sReceiptTp != null and sReceiptTp != ""'>
	                    AND C.RECEIPT_TP = #{sReceiptTp}
	                </if>
	                <if test='sReceiptNo != null and sReceiptNo != ""'>
	                    AND A.RECEIPT_NO = #{sReceiptNo}
	                </if>
	                <if test='sInvcStartDt != null' >
		                AND D.INVC_DT <![CDATA[>=]]> TRUNC(#{sInvcStartDt},'DD')    --报表结算年月start
		            </if>
		            <if test='sInvcEndDt != null' >
		                AND D.INVC_DT <![CDATA[<]]> TRUNC(#{sInvcEndDt},'DD')+1     --报表结算年月end
		            </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "dlrCd"'>          A.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "dlrNm"'>          B.DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "settlementNo"'>  A.SETTLEMENT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "receiptTp"'>      C.RECEIPT_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                <when test='item.field == "receiptNo"'>      A.RECEIPT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "buyNm"'>           A.BUY_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "taxpayerIdCd"'>   A.TAXPAYER_ID_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <when test='item.field == "scanSumAmt"'>     A.SCAN_SUM_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <otherwise>
                                C.RECEIPT_TP
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                    C.RECEIPT_TP
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>
    
    <!-- 查询当前发票所在索赔单的开票状态 -->
    <select id="selectClaimInvoiceStateByCondition" parameterType="ClaimInvoiceEditSearchVO" resultType="String">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.selectClaimInvoiceStateByCondition] */
         SELECT RECEIPT_TP   
         FROM SE_0960T C       -- C 索赔单主表
         LEFT JOIN SA_0502T A  -- A 发票信息表
           ON A.DLR_CD = C.DLR_CD
           AND A.SETTLEMENT_NO = C.INVC_NO --索赔结算单信息字段
         LEFT JOIN SE_0930T D  -- D 索赔报表信息表
           ON C.INVC_NO = D.INVC_NO  --索赔结算单信息字段
         WHERE C.DLR_CD = #{sDlrCd} 
           AND C.INVC_NO = #{sInvcNo}
           AND A.RECEIPT_NO = #{sReceiptNo}  --发票号
           AND A.RECEIPT_CD = #{sReceiptCd}  --发票代码
    </select>
    
    <!-- 更新SA_0502T发票表操作 -->
    <update id="updateClaimInvoiceByInvcNo" parameterType="ClaimInvoiceEditVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.updateClaimInvoiceByInvcNo] */
        UPDATE SA_0502T
          SET SETTLEMENT_NO = #{settlementNo} --结算单号
            , UPDT_USR_ID = #{updtUsrId}   --更新用户
            , UPDT_DT = SYSDATE            --更新时间
        WHERE RECEIPT_NO = #{receiptNo}      --发票号
          AND RECEIPT_CD = #{receiptCd}      --发票代码
    </update>
    
    
    <!-- 查询当前发票信息是否在SA_0502_2IS接口表存在 -->
    <select id="selectClaimInvoiceEditIfExistByReceiptId" parameterType="ClaimInvoiceEditVO" resultType="int">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.selectClaimInvoiceEditIfExistByReceiptId] */
         SELECT count(1)   
         FROM SA_0502_2IS       --发票信息接口表
         WHERE 
            RECEIPT_ID = #{sReceiptId}      --发票ID
    </select>
    
    <!-- 更新接口表SA_0502_2IS中的发票信息 -->
    <update id="updateClaimInvoiceByReceiptId" parameterType="ClaimInvoiceEditISVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.updateClaimInvoiceByInvcNo] */
        UPDATE SA_0502_2IS
          SET 
              DLR_CD = #{dlrCd}
            , IFRESULT = 'N'
            , UPDATEDATE = #{updatedate}    --更新时间
        WHERE RECEIPT_ID = #{receiptId}     --发票ID
    </update>
    
    <!-- 对接口表SA_0502_2IS插入新的发票信息 -->
    <insert id="insertClaimInvoiceToInterfaceTable" parameterType="ClaimInvoiceEditISVO">
    /* [chn.bhmc.dms.ser.wac.service.dao.ClaimInvoiceEditDAO.insertClaimInvoiceToInterfaceTable] */
      INSERT INTO SA_0502_2IS(
          RECEIPT_ID
         ,DLR_CD
         ,IFRESULT
         ,CREATEDATE
         ,IF_REG_DT
      )VALUES(
          #{receiptId}
         ,#{dlrCd}
         ,'N'
         ,#{createdate}
         ,SYSDATE
      )
    </insert>
    
</mapper>