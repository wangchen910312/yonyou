<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ReviewWarrantyOrderDAO_SqlMap.xml
    Description : 保修工单确认审核 sqlMap.xml
    author lixinfei
    since 2021. 04. 06.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2021. 04. 06.   lixinfei      保修工单确认审核 sqlMap.xml
-->

<mapper namespace="chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO">

    <!-- 按条件查询审核工单 -->
    <select id="selectReviewWarrantyOrderByCondition" parameterType="ReviewWarrantyOrderSearchVO" resultType="WarrantyOrderMappingVO">
        /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.selectReviewWarrantyOrderByCondition] */
        SELECT ROWNUM AS RNUM, T2.* FROM
        (
        SELECT T1.* FROM
	        (
	        SELECT 
	             A.REQ_NO           --申请编码
	        	,A.DLR_CD			--经销商代码
	        	,C.DLR_NM			--经销商名称
	        	,A.CAR_REG_NO		--车牌号
	        	,A.VIN_NO			--车辆识别码
	        	,A.RO_DOC_NO		--维修委托单号
	        	,A.CAR_OWNER_NM		--车辆所有者名称
	        	,A.DRIVER_NM		--送修人名称
	        	,A.DRIVER_HP_NO		--送修人手机号
	        	,FN_CMM_CD_NM('SER031',A.RO_TP, #{sLangCd}, 'N') AS RO_TP_STR			            --维修委托类型 字符串
	        	,A.RO_TP              --维修委托类型
	        	,FN_CMM_CD_NM('SER600',A.REQ_STAT_CD, #{sLangCd}, 'N') AS REQ_STAT_CD_STR	        --状态 字符串（原:审核状态，取值SE_1162T单据状态  03拒绝 04驳回）
	        	,A.REQ_STAT_CD        --状态
	        	,FN_CMM_CD_NM('SER602',A.REQ_REASON_TP, #{sLangCd}, 'N') AS REQ_REASON_TP_STR	    --申请原因分类 字符串
	        	,A.REQ_REASON_TP      --申请原因分类
	        	,A.REQ_REASON_DESC	--申请原因
	        	,CASE
                    WHEN A.REQ_STAT_CD ='01' 
                        THEN ''
                    ELSE A.APPROVE_DESC 
                 END 
                 AS APPROVE_DESC    --厂家驳回原因\厂家拒绝原因
	        	,A.REQ_USR_ID		--申请人ID
	        	,A.REQ_USR_NM       --申请人名称
	        	,A.REQ_TSK_NM       --申请人岗位
                ,A.REQ_HP_NO        --申请人手机号
	        	,A.APPROVE_USR_NM	--判定人
	        	,A.REQ_DT			--申请日期
	        	,A.RO_DT			--维修委托日期
	        	,A.DL_CHK_DT		--交车确认日期
	        	,CASE
			        WHEN A.REQ_STAT_CD ='01' 
			            THEN ''
			        ELSE TO_CHAR(A.APPROVE_DT, 'yyyy-mm-dd hh24:mi:ss')
			     END 
			     AS APPROVE_DT			--审核日期(如果是未审核状态的信息，不展示它的审核日期)(审核日期已修改为SE_1162T的APPROVE_DT)
	        	,A.FILE_DOC_NO		--附件ID
	        FROM SE_1162T A	--特殊申请表
	        LEFT OUTER JOIN CM_0101T C	--经销商表
	        	ON A.DLR_CD = C.DLR_CD
	        <where>
	           A.REQ_STAT_CD <![CDATA[<>]]> '00'
	           AND A.REQ_STAT_CD <![CDATA[<>]]> '05'   --不查询'保存'和'未审核'状态的信息
	        	<if test='sDlrCd != null and sDlrCd != ""'>
	        		<choose>
	                    <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
	                        <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
	                        AND A.DLR_CD LIKE #{sDlrCd}
	                    </when>
	                    <otherwise>
	                         AND A.DLR_CD = #{sDlrCd}
	                    </otherwise>
	                </choose>
	        	</if>
	        	<if test='sCarRegNo != null and sCarRegNo != ""'>
	        		<choose>
	                    <when test='@org.apache.commons.lang3.StringUtils@contains(sCarRegNo,"*")'>
	                        <bind name='sCarRegNo' value='@org.apache.commons.lang3.StringUtils@replace(sCarRegNo, "*", "%")' />
	                        AND A.CAR_REG_NO LIKE #{sCarRegNo}
	                    </when>
	                    <otherwise>
	                         AND A.CAR_REG_NO = #{sCarRegNo}
	                    </otherwise>
	                </choose>
	        	</if>
	        	<if test='sApproveUsrNm != null and sApproveUsrNm != ""'>
	        		<choose>
	                    <when test='@org.apache.commons.lang3.StringUtils@contains(sApproveUsrNm,"*")'>
	                        <bind name='sApproveUsrNm' value='@org.apache.commons.lang3.StringUtils@replace(sApproveUsrNm, "*", "%")' />
	                        AND A.APPROVE_USR_NM LIKE #{sApproveUsrNm}
	                    </when>
	                    <otherwise>
	                         AND A.APPROVE_USR_NM = #{sApproveUsrNm}
	                    </otherwise>
	                </choose>
	        	</if>
	        	<if test='sDiviCd != null and sDiviCd != ""'>
                  AND C.SDPT_CD = #{sDiviCd}     --事业部
                </if>
	        	<if test='sOffCd != null and sOffCd != ""'>
                  AND C.DIST_OFFICE_CD = #{sOffCd}     --办事处
                </if>
	        	<if test='sReqStatCd != null and sReqStatCd != ""'>
	              AND A.REQ_STAT_CD = #{sReqStatCd}		--审核状态（单据状态）
	            </if>
	        	<if test='sRoStartDt != null' >
	              AND A.RO_DT <![CDATA[>=]]> TRUNC(#{sRoStartDt},'DD')		--开单start
	            </if>
	            <if test='sRoStartDt != null' >
	              AND A.RO_DT <![CDATA[<]]> TRUNC(#{sRoEndDt},'DD')+1		--开单end
	            </if>
	            <if test='sApproveDtStart != null' >
	              AND A.APPROVE_DT <![CDATA[>=]]> TRUNC(#{sApproveDtStart},'DD')	--审核start
	            </if>
	            <if test='sApproveDtEnd != null' >
	              AND A.APPROVE_DT <![CDATA[<]]> TRUNC(#{sApproveDtEnd},'DD')		--审核end
	            </if>
	        </where>
	        ORDER BY
            <choose>
               <when test='sort != null'>
                   <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                       <choose>
                           <when test='item.field == "reqNo"'>A.REQ_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "dlrCd"'>A.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "dlrNm"'>C.DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "carRegNo"'>A.CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "vinNo"'>A.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "roDocNo"'>A.RO_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "carOwnerNm"'>A.CAR_OWNER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "driverNm"'>A.DRIVER_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "driverHpNo"'>A.DRIVER_HP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "approveUsrNm"'>A.APPROVE_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "roTp"'>A.RO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqStatCd"'>A.REQ_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqReasonTp"'>A.REQ_REASON_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqReasonDesc"'>A.REQ_REASON_DESC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "approveDesc"'>A.APPROVE_DESC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqUsrId"'>A.REQ_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqUsrNm"'>A.REQ_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "approveDt"'>A.APPROVE_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "reqDt"'>A.REQ_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "roDt"'>A.RO_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <when test='item.field == "dlChkDt"'>A.DL_CHK_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                           <otherwise>
                               A.REQ_STAT_CD DESC
                           </otherwise>
                       </choose>
                    </foreach>
               </when>
               <otherwise>
                <choose>
	                <when test='sReqStatCd != null and sReqStatCd != ""'>
	                    <choose>
	                        <when test='sReqStatCd == "01"'>REQ_DT   --申请日期 </when>
	                        <otherwise>
	                            A.APPROVE_DT   --审核日期
	                        </otherwise>
	                    </choose>
	                </when>
	                <otherwise>
	                    A.APPROVE_DT   --审核日期 
	                </otherwise>
	            </choose>
               </otherwise>
           </choose>
	        ) T1
	        
		) T2
		<where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                ROWNUM <![CDATA[<=]]> #{lastIndex}
            </if>
		    <if test='firstIndex != -1 and lastIndex != -1'>
		        AND ROWNUM <![CDATA[>=]]> #{firstIndex}
		    </if>
		</where>
           
    </select>

    <!-- 按条件查询审核工单数量 -->
	<select id="selectReviewWarrantyOrderByConditionCnt" parameterType="ReviewWarrantyOrderSearchVO" resultType="long">
         /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.selectReviewWarrantyOrderByConditionCnt] */
        SELECT
            COUNT(1) AS VALUE
        FROM SE_1162T A	--特殊申请表
   	    LEFT OUTER JOIN CM_0101T C    --经销商表
            ON A.DLR_CD = C.DLR_CD
       	<where>
       	    A.REQ_STAT_CD <![CDATA[<>]]> '00'
	       	<if test='sDlrCd != null and sDlrCd != ""'>
	       		<choose>
	                   <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
	                       <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
	                       AND A.DLR_CD LIKE #{sDlrCd}
	                   </when>
	                   <otherwise>
	                        AND A.DLR_CD = #{sDlrCd}
	                   </otherwise>
	               </choose>
	       	</if>
	       	<if test='sCarRegNo != null and sCarRegNo != ""'>
	       		<choose>
	                   <when test='@org.apache.commons.lang3.StringUtils@contains(sCarRegNo,"*")'>
	                       <bind name='sCarRegNo' value='@org.apache.commons.lang3.StringUtils@replace(sCarRegNo, "*", "%")' />
	                       AND A.CAR_REG_NO LIKE #{sCarRegNo}
	                   </when>
	                   <otherwise>
	                        AND A.CAR_REG_NO = #{sCarRegNo}
	                   </otherwise>
	               </choose>
	       	</if>
	       	<if test='sApproveUsrNm != null and sApproveUsrNm != ""'>
	       		<choose>
	                   <when test='@org.apache.commons.lang3.StringUtils@contains(sApproveUsrNm,"*")'>
	                       <bind name='sApproveUsrNm' value='@org.apache.commons.lang3.StringUtils@replace(sApproveUsrNm, "*", "%")' />
	                       AND A.APPROVE_USR_NM LIKE #{sApproveUsrNm}
	                   </when>
	                   <otherwise>
	                        AND A.APPROVE_USR_NM = #{sApproveUsrNm}
	                   </otherwise>
	               </choose>
	       	</if>
	       	<if test='sDiviCd != null and sDiviCd != ""'>
              AND C.SDPT_CD = #{sDiviCd}     --事业部
            </if>
            <if test='sOffCd != null and sOffCd != ""'>
              AND C.DIST_OFFICE_CD = #{sOffCd}     --办事处
            </if>
	       	<if test='sReqStatCd != null and sReqStatCd != ""'>
	             AND A.REQ_STAT_CD = #{sReqStatCd}		--审核状态（单据状态）
	           </if>
	       	<if test='sRoStartDt != null' >
	             AND A.RO_DT <![CDATA[>=]]> TRUNC(#{sRoStartDt},'DD')		--开单start
			</if>
			<if test='sRoStartDt != null' >
			  	AND A.RO_DT <![CDATA[<]]> TRUNC(#{sRoEndDt},'DD')+1		--开单end
			</if>
			<if test='sApproveDtStart != null' >
			  	AND A.APPROVE_DT <![CDATA[>=]]> TRUNC(#{sApproveDtStart},'DD')	--审核start
			</if>
			<if test='sApproveDtEnd != null' >
			  	AND A.APPROVE_DT <![CDATA[<]]> TRUNC(#{sApproveDtEnd},'DD')		--审核end
			</if>
        </where>
    </select>
    
    <!-- 根据申请编号查询当前记录是否被审核（是否在主表中为未审核状态） -->
    <select id="selectReviewWarrantyOrderByReqNo" parameterType="WarrantyOrderVO" resultType="int">
         /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.selectReviewWarrantyOrderByReqNo] */
             SELECT COUNT( 1 ) FROM SE_1162T WHERE REQ_NO = #{reqNo} AND DLR_CD = #{dlrCd} AND (
				REQ_STAT_CD = '02' 
				OR REQ_STAT_CD = '03' 
				OR REQ_STAT_CD = '04'
			)
    </select>
    
    <!-- 修改SE_1162T表中所审核记录的状态与信息 -->
    <update id="updateReviewWarrantyOrderByReqNo" parameterType="ReviewWarrantyOrderVO">
    /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.updateReviewWarrantyOrderByReqNo] */
         UPDATE SE_1162T
           SET 
               REQ_STAT_CD  = #{reqStatCd}
             , APPROVE_DESC  = #{approveDesc}
             , APPROVE_USR_ID  = #{approveUsrId}
             , APPROVE_USR_NM  = #{approveUsrNm}
             , APPROVE_DT  = #{approveDt}       --新增字段：审核日期
             , UPDT_USR_ID  = #{approveUsrId}
             , UPDT_DT  = #{approveDt}          --这里在service只存了个审核日期，更新日期也用这个
         WHERE DLR_CD = #{dlrCd}
           AND REQ_NO = #{reqNo}
    </update>
    
    <!-- 添加一条审核记录到SE_1163T表 -->
    <insert id="insertReviewWarrantyOrder" parameterType="ReviewWarrantyOrderSaveVO">
    /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.insertReviewWarrantyOrder] */
      INSERT INTO SE_1163T(
            ID
            , REQ_NO
            , DLR_CD
            , APPROVE_STAT_CD
            , APPROVE_DESC
            , REG_USR_ID
            , REG_DT
         )VALUES(
            DMSDB.SEQ_SE_1163T.NEXTVAL
            , #{reqNo}
            , #{dlrCd}
            , #{approveStatCd}
            , #{approveDesc}
            , #{regUsrId}
            , #{regDt}
         )
    </insert>
    
    <!-- 添加一条记录到接口表SE_1163IS-->
    <insert id="insertReviewWarrantyOrderToInterfaceTable" parameterType="ReviewWarrantyOrderSaveVO">
    /* [chn.bhmc.dms.ser.svi.service.dao.ReviewWarrantyOrderDAO.insertReviewWarrantyOrder] */
      INSERT INTO SE_1163IS(
			ID
			,REQ_NO
			,DLR_CD
			,APPROVE_STAT_CD
			,APPROVE_DESC
			,REG_USR_ID
			,REG_USR_NM
			,REG_DT
			,IFRESULT
			,IFFAILMSG
			,CREATEDATE
			,IF_REG_DT
         )VALUES(
            DMSDB.SEQ_SE_1163IS.NEXTVAL
			,#{reqNo}
			,#{dlrCd}
			,#{approveStatCd}
			,#{approveDesc}
			,#{regUsrId}
			,#{regUsrNm}
			,#{regDt}
			,'N'
			,#{iffailmsg}
			,#{createdate}
			,#{regDt}
         )
    </insert>

</mapper>