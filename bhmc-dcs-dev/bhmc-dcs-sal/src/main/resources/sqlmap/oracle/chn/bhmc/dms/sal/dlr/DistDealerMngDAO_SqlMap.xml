<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.dlr.service.dao.DistDealerMngDAO">

	<!-- 지역사무소관리 - 사무소  -->
	<select id="selectDistDealerMngByCondition" parameterType="DistDealerSearchVO" resultType="DistDealerVO">
        SELECT CM0801.USR_ID
             , CM0801.USR_NM
             , CM0801.DUTY_CD
             , CM0801.DLR_CD
             , CM0801.DEPT_CD
             , V.DEPT_NM
             , DECODE(X.USR_ID, NULL, 'N', 'Y') AS DISABLED_YN
          FROM CM_0801T CM0801
          LEFT OUTER JOIN CM_3401T V ON CM0801.DEPT_CD = V.DEPT_CD AND V.CMP_TP = '20'
          LEFT OUTER JOIN (
                             SELECT A.DLR_CD
                                  , A.USR_ID
                               FROM CM_0801T A
                                  , (
                                     SELECT AREA_CCBZ_EMP_NO AS USR_ID -- 1급 지역경리사번
                                          , DLR_CD
                                       FROM CM_0101T
                                      GROUP BY AREA_CCBZ_EMP_NO, DLR_CD HAVING AREA_CCBZ_EMP_NO IS NOT NULL
                                      ORDER BY AREA_CCBZ_EMP_NO ASC
                                    ) B
                              WHERE A.USR_ID = B.USR_ID
                                AND A.ENABLED_YN = 'Y'
                              GROUP BY A.DLR_CD, A.USR_ID
                            UNION
                              SELECT DLR_CD
                                   , USR_ID
                                FROM CM_0801T
                               WHERE DLR_CD = 'A07AA'
                                 AND TSK_CD = '08'
                                 AND ENABLED_YN = 'Y'
                          ) X
            ON CM0801.DLR_CD = X.DLR_CD
           AND CM0801.USR_ID = X.USR_ID
         WHERE 1=1
           AND CM0801.DLR_CD = 'A07AA'
           AND CM0801.ENABLED_YN = 'Y'
           -- AND CM0801.DUTY_CD IN ('02','03','04')
          <if test='sUsrId != null and sUsrId != ""'>
           AND CM0801.USR_ID LIKE '%'||#{sUsrId}||'%'
          </if>
          <if test='sUsrNm != null and sUsrNm != ""'>
           AND CM0801.USR_NM LIKE '%'||#{sUsrNm}||'%'
          </if>
          <if test='sDeptCd != null and sDeptCd != ""'>
           AND CM0801.DEPT_CD = #{sDeptCd}
          </if>
         ORDER BY
         <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "usrId"'>USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "usrNm"'>USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "dutyCd"'>DUTY_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <otherwise>
                            USR_ID ASC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                USR_ID ASC
            </otherwise>
        </choose>
	</select>


	<!-- 지역사무소관리 - 사무소 목록 갯수  -->
	<select id="selectDistDealerMngByConditionCnt" parameterType="DistDealerSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM CM_0801T CM0801
         WHERE 1=1
           AND CM0801.DLR_CD = 'A07AA'
           AND CM0801.ENABLED_YN = 'Y'
           -- AND CM0801.DUTY_CD IN ('02','03','04')
          <if test='sUsrId != null and sUsrId != ""'>
           AND CM0801.USR_ID LIKE '%'||#{sUsrId}||'%'
          </if>
          <if test='sUsrNm != null and sUsrNm != ""'>
           AND CM0801.USR_NM LIKE '%'||#{sUsrNm}||'%'
          </if>
          <if test='sDeptCd != null and sDeptCd != ""'>
           AND CM0801.DEPT_CD = #{sDeptCd}
          </if>
    </select>

    <!-- 지역사무소관리 - 딜러  -->
    <select id="selectDealerByCondition" parameterType="DistDealerSearchVO" resultType="DistDealerVO">
        SELECT A.DLR_CD AS MNG_DLR_CD
             , A.DLR_NM
             , A.DIST_OFFICE_CD
             , (SELECT OFF_NM
                  FROM CM_2601T Y
                 WHERE Y.DIVI_CD = A.SDPT_CD
                   AND Y.OFF_CD  = A.DIST_OFFICE_CD
               ) AS OFFICE_NM
             , A.SDPT_CD
             , (SELECT DIVI_NM FROM CM_2501T WHERE DIVI_CD = A.SDPT_CD) AS SDPT_NM
             , DECODE(B.USR_ID, NULL, 'N', 'Y') AS CHK_YN
          FROM CM_0101T A
             , SA_0439T B
         WHERE 1=1
           AND A.DLR_CD = B.MNG_DLR_CD(+)
           AND A.DLR_CD LIKE 'D%'
           AND B.USR_ID(+) = #{sUsrId}
          <if test='sDiviCd != null and sDiviCd != ""'>
           AND A.SDPT_CD = #{sDiviCd}
          </if>
          <if test='sOffCd != null and sOffCd != ""'>
           AND A.DIST_OFFICE_CD = #{sOffCd}
          </if>
          <if test='sDlrCd != null and sDlrCd != ""'>
           AND A.DLR_CD LIKE '%'|| UPPER(#{sDlrCd}) ||'%'
          </if>
         ORDER BY
         <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "mngDlrCd"'>MNG_DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "dlrNm"'>DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <otherwise>
                            MNG_DLR_CD ASC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                MNG_DLR_CD ASC
            </otherwise>
        </choose>
    </select>


    <!-- 지역사무소관리 - 딜러 목록 갯수  -->
    <select id="selectDealerByConditionCnt" parameterType="DistDealerSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM CM_0101T A
             , SA_0439T B
         WHERE 1=1
           AND A.DLR_CD = B.MNG_DLR_CD(+)
           AND A.DLR_CD LIKE 'D%'
          <if test='sDiviCd != null and sDiviCd != ""'>
           AND A.SDPT_CD = #{sDiviCd}
          </if>
          <if test='sOffCd != null and sOffCd != ""'>
           AND A.DIST_OFFICE_CD = #{sOffCd}
          </if>
          <if test='sDlrCd != null and sDlrCd != ""'>
           AND A.DLR_CD LIKE '%'|| UPPER(#{sDlrCd}) ||'%'
          </if>
    </select>

    <!-- 지역딜러 등록  -->
    <insert id="insertDealer" parameterType="DistDealerVO" >
         MERGE INTO SA_0439T A
          USING (SELECT #{dlrCd} AS DLR_CD
                      , #{usrId} AS USR_ID
                      , '1' AS PSIT_CD      <!-- 직책코드 안넣기로 결정 -->
                      , #{mngDlrCd} AS MNG_DLR_CD
                      , #{regUsrId} AS REG_USR_ID
                      , SYSDATE AS REG_DT
                      , #{regUsrId} AS UPDT_USR_ID
                      , SYSDATE AS UPDT_DT
                   FROM DUAL ) B
          ON (A.DLR_CD = B.DLR_CD
              AND A.USR_ID = B.USR_ID
              AND A.PSIT_CD = B.PSIT_CD
              AND A.MNG_DLR_CD = B.MNG_DLR_CD
             )
          WHEN NOT MATCHED THEN
            INSERT(
                A.DLR_CD
               ,A.USR_ID
               ,A.PSIT_CD
               ,A.MNG_DLR_CD
               ,A.REG_USR_ID
               ,A.REG_DT
               ,A.UPDT_USR_ID
               ,A.UPDT_DT
            )VALUES(
                B.DLR_CD
               ,B.USR_ID
               ,B.PSIT_CD
               ,B.MNG_DLR_CD
               ,B.REG_USR_ID
               ,B.REG_DT
               ,B.UPDT_USR_ID
               ,B.UPDT_DT
            )
    </insert>

    <!-- 지역딜러 삭제  -->
    <insert id="deleteDealer" parameterType="DistDealerVO" >
        DELETE SA_0439T
         WHERE 1=1
           AND DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND PSIT_CD = '1'
           AND MNG_DLR_CD = #{mngDlrCd}
    </insert>

</mapper>