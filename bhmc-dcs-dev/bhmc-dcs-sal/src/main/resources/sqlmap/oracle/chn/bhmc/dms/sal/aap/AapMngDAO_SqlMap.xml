<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.aap.service.dao.AapMngDAO">

	<!-- 대행업무관리  -->
	<select id="selectAapMngByCondition" parameterType="AapMngSearchVO" resultType="AapMngVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT SA0209.AAP_DT,SA0209.AAP_WRK_DSTIN_CD,SA0209.SEQ,SA0209.VIN_NO
                      ,SA0209.CARLINE_CD,FN_GET_CARLINE_NM(SA0209.CARLINE_CD) AS CARLINE_NM
                      ,SA0209.MODEL_CD,FN_GET_MODEL_NM(SA0209.MODEL_CD) AS MODEL_NM
                      ,SA0209.OCN_CD,FN_GET_OCN_NM(SA0209.MODEL_CD, SA0209.OCN_CD) AS OCN_NM
                      ,SA0209.CAR_REG_NO,SA0209.AAP_EMP_NM
                      ,SA0209.CST_AMT,SA0209.PROFIT_AMT,SA0209.AAP_AMT
                      ,SA0209.REG_USR_ID,SA0209.REG_DT,SA0209.UPDT_USR_ID,SA0209.UPDT_DT
                  FROM SA_0209T SA0209
                 WHERE 1=1
                 <if test='sVinNo != null and sVinNo != ""'>
                    AND SA0209.VIN_NO LIKE '%' || #{sVinNo} || '%'
                 </if>
                 <if test='sCarRegNo != null and sCarRegNo != ""'>
                   AND SA0209.CAR_REG_NO = #{sCarRegNo}
                 </if>
                 <if test='sAapWrkDstinCd != null and sAapWrkDstinCd != ""'>
                   AND SA0209.AAP_WRK_DSTIN_CD = #{sAapWrkDstinCd}
                 </if>
                 <if test='sAapEmpNm != null and sAapEmpNm != ""'>
                     <choose>
                         <when test='@org.apache.commons.lang3.StringUtils@contains(sAapEmpNm,"*")'>
                             <bind name='sAapEmpNm' value='@org.apache.commons.lang3.StringUtils@replace(sAapEmpNm, "*", "%")' />
                             AND SA0209.AAP_EMP_NM LIKE #{sAapEmpNm}
                         </when>
                         <otherwise>
                             AND SA0209.AAP_EMP_NM = #{sAapEmpNm}
                         </otherwise>
                     </choose>
                 </if>
                 <if test='sStartDt != null'>
                     AND SA0209.AAP_DT <![CDATA[>=]]> TRUNC(#{sStartDt},'DD')
                 </if>
                 <if test='sEndDt != null'>
                     AND SA0209.AAP_DT <![CDATA[<]]> TRUNC(#{sEndDt},'DD')+1
                 </if>
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "rnum"'>RNUM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "aapWrkDstinCd"'>AAP_WRK_DSTIN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carRegNo"'>CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "cstAmt"'>CST_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "profitAmt"'>PROFIT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "aapAmt"'>AAP_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineCd"'>CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carlineNm"'>CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelCd"'>MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "modelNm"'>MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnCd"'>OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "ocnNm"'>OCN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "aapEmpNm"'>AAP_EMP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    VIN_NO DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        VIN_NO DESC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
	</select>



	<!-- 대행업무관리 목록 갯수  -->
	<select id="selectAapMngByConditionCnt" parameterType="AapMngSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0209T SA0209
         WHERE 1=1
         <if test='sVinNo != null and sVinNo != ""'>
           AND SA0209.VIN_NO LIKE '%' || #{sVinNo} || '%'
         </if>
         <if test='sCarRegNo != null and sCarRegNo != ""'>
           AND SA0209.CAR_REG_NO = #{sCarRegNo}
         </if>
         <if test='sAapWrkDstinCd != null and sAapWrkDstinCd != ""'>
           AND SA0209.APP_WRK_DSTIN_CD = #{sAapWrkDstinCd}
         </if>
         <if test='sAapEmpNm != null and sAapEmpNm != ""'>
             <choose>
                 <when test='@org.apache.commons.lang3.StringUtils@contains(sAapEmpNm,"*")'>
                     <bind name='sAapEmpNm' value='@org.apache.commons.lang3.StringUtils@replace(sAapEmpNm, "*", "%")' />
                     AND SA0209.AAP_EMP_NM LIKE #{sAapEmpNm}
                 </when>
                 <otherwise>
                     AND SA0209.AAP_EMP_NM = #{sAapEmpNm}
                 </otherwise>
             </choose>
         </if>
         <if test='sStartDt != null'>
             AND SA0209.AAP_DT <![CDATA[>=]]> TRUNC(#{sStartDt},'DD')
         </if>
         <if test='sEndDt != null'>
             AND SA0209.AAP_DT <![CDATA[<]]> TRUNC(#{sEndDt},'DD')+1
         </if>
	</select>



    <!-- 대행업무 저장.  -->
    <update id="updateAapMng" parameterType="AapMngVO">
        UPDATE SA_0209T
           SET VIN_NO = #{vinNo}
             , CAR_REG_NO = #{carRegNo}
             , CARLINE_CD = #{carlineCd}
             , AAP_WRK_DSTIN_CD = #{aapWrkDstinCd}
             , MODEL_CD = #{modelCd}
             , OCN_CD = #{ocnCd}
             , AAP_EMP_NM = #{aapEmpNm}
             , AAP_DT = #{aapDt}
             , CST_AMT = #{cstAmt}
             , PROFIT_AMT = #{profitAmt}
             , AAP_AMT = #{aapAmt}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
        WHERE SEQ = #{seq}
    </update>


    <!-- 대행업무 정보를 등록한다. -->
    <insert id="insertAapMng" parameterType="AapMngVO">
        INSERT INTO SA_0209T(
               AAP_DT
             , AAP_WRK_DSTIN_CD
             , SEQ
             , VIN_NO
             , CARLINE_CD
             , MODEL_CD
             , OCN_CD
             , CAR_REG_NO
             , AAP_EMP_NM
             , CST_AMT
             , PROFIT_AMT
             , AAP_AMT
             , REG_USR_ID
             , REG_DT
        )VALUES(
               #{aapDt}
             , #{aapWrkDstinCd}
             , (SELECT NVL(MAX(SEQ),0)+1 FROM SA_0209T)
             , #{vinNo}
             , #{carlineCd}
             , #{modelCd}
             , #{ocnCd}
             , #{carRegNo}
             , #{aapEmpNm}
             , #{cstAmt}
             , #{profitAmt}
             , #{aapAmt}
             , #{regUsrId}
             , SYSDATE
        )
    </insert>


</mapper>