<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : EvalSearchEditDAO_SqlMap.xml
    Description : 평가조회 및 수정
    author Bong
    since 2016. 5. 02.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 5. 02.       Bong              최초 생성
-->

<mapper namespace="chn.bhmc.dms.sal.lom.service.dao.EvalSearchEditDAO">

    <select id="selectEvalSearchEditConditionCnt" parameterType="EvalSearchEditSearchVO" resultType="int">
    <!-- selectEvalInfoDownloadCnt -->
        SELECT COUNT(*)
          FROM SA_0121T A
               ,(SELECT * FROM
                  (SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY UPLOAD_TIMESTAMP DESC) AS RN
                         ,UPLOAD_TIMESTAMP
                         ,VIN_NO
                    FROM SA_0425T
                ) WHERE RN = 1) B
                ,(SELECT * FROM
                  (SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY DLR_EVAL_DT DESC) AS RN
                         ,VIN_NO
                         ,DLR_EVAL_DT
                         ,DSTB_SER_EVAL_VAL
                         ,DRIVER_STSF_VAL
                         ,CAR_ISSUE_HM_VAL
                         ,CAR_ISSUE_MASS_VAL
                         ,OTHER_CONT
                     FROM SA_0426T
                ) WHERE RN = 1) C
         WHERE A.VIN_NO = B.VIN_NO(+)
           AND A.VIN_NO = C.VIN_NO
           AND A.NCAR_DSTIN_CD = 'N'
           AND A.CAR_STAT_CD IN ('60', '70')
        <if test='sDlrCd != null and sDlrCd != ""'>
            AND A.ORD_DLR_CD = #{sDlrCd}
        </if>
        <if test='sVinNo != null and sVinNo != ""'>
            AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
        </if>
        <if test='sCarStatCd != null and sCarStatCd != ""'>
            AND A.CAR_STAT_CD = #{sCarStatCd}
        </if>
        <if test='sPltGiDtS != null and sPltGiDtE != null'>
           AND A.PLT_GI_DT <![CDATA[>=]]> TRUNC(#{sPltGiDtS},'DD')
           AND A.PLT_GI_DT <![CDATA[<]]> TRUNC(#{sPltGiDtE},'DD')+1
        </if>
        <if test='sGrDtS != null and sGrDtE != null'>
           AND A.DLR_GR_DT <![CDATA[>=]]> TRUNC(#{sGrDtS},'DD')
           AND A.DLR_GR_DT <![CDATA[<]]> TRUNC(#{sGrDtE},'DD')+1
        </if>
    </select>

    <select id="selectEvalSearchEditCondition" parameterType="EvalSearchEditSearchVO" resultType="EvalInfoVO">
    <!-- selectEvalInfoDownload -->
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT A.ORD_DLR_CD AS DLR_CD
                      --,B.DSTB_CMP_NM
                      ,FN_CMM_CD_NM('SAL057',A.TRSF_CMP_CD,#{sLangCd},'N') AS DSTB_CMP_NM --物流公司只显示sap传过来的 贾明 2018-9-3
                      ,B.TRSF_CAR_NO
                      ,A.VIN_NO
                      ,A.CAR_STAT_CD
                      , ( SELECT Z2.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL001'   /*차량상태*/
                                   AND A.USE_YN = 'Y'
                                 ) Z2
                         WHERE A.CAR_STAT_CD = Z2.CMM_CD
                       ) AS CAR_STAT_NM
                      ,A.DLR_GR_DT AS GR_DT
                      ,A.PLT_GI_DT
                      ,C.DLR_EVAL_DT
                      ,C.DSTB_SER_EVAL_VAL
                      ,C.DRIVER_STSF_VAL
                      ,C.CAR_ISSUE_HM_VAL
                      , ( SELECT Z2.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL032'   /*차량교부시간*/
                                   AND A.USE_YN = 'Y'
                                 ) Z2
                         WHERE C.CAR_ISSUE_HM_VAL = Z2.CMM_CD
                       ) AS CAR_ISSUE_HM_VAL_NM
                      ,C.CAR_ISSUE_MASS_VAL
                      , ( SELECT Z2.CMM_CD_NM
                           FROM (SELECT A.CMM_CD
                                      , NVL(B.CMM_CD_TXT, A.CMM_CD_NM) AS CMM_CD_NM
                                  FROM CM_0303T A
                                  LEFT OUTER JOIN CM_0304T B
                                        ON A.CMM_GRP_CD = B.CMM_GRP_CD
                                       AND A.CMM_CD = B.CMM_CD
                                       AND B.LANG_CD = #{sLangCd}
                                 WHERE A.CMM_GRP_CD = 'SAL033'   /*차량교부질량*/
                                   AND A.USE_YN = 'Y'
                                 ) Z2
                         WHERE C.CAR_ISSUE_MASS_VAL = Z2.CMM_CD
                       ) AS CAR_ISSUE_MASS_VAL_NM
                      ,C.OTHER_CONT
                      ,NVL(B.PRE_ALRT_NTCE_CONT, '') AS PRE_ALRT_NTCE_CONT
                  FROM SA_0121T A
                       ,(SELECT * FROM
                          (SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY UPLOAD_TIMESTAMP DESC) AS RN
                                 ,UPLOAD_TIMESTAMP
                                 ,VIN_NO
                                 ,PRE_ALRT_NTCE_CONT
                                 ,DSTB_CMP_NM
                                 ,TRSF_CAR_NO
                            FROM SA_0425T
                        ) WHERE RN = 1) B
                        ,(SELECT * FROM
                          (SELECT ROW_NUMBER() OVER(PARTITION BY VIN_NO ORDER BY DLR_EVAL_DT DESC) AS RN
                                 ,VIN_NO
                                 ,DLR_EVAL_DT
                                 ,DSTB_SER_EVAL_VAL
                                 ,DRIVER_STSF_VAL
                                 ,CAR_ISSUE_HM_VAL
                                 ,CAR_ISSUE_MASS_VAL
                                 ,OTHER_CONT
                             FROM SA_0426T
                        ) WHERE RN = 1) C
                 WHERE A.VIN_NO = B.VIN_NO(+)
                   AND A.VIN_NO = C.VIN_NO
                   AND A.NCAR_DSTIN_CD = 'N'
                   AND A.CAR_STAT_CD IN ('60', '70')
                <if test='sDlrCd != null and sDlrCd != ""'>
                    AND A.ORD_DLR_CD = #{sDlrCd}
                </if>
                <if test='sVinNo != null and sVinNo != ""'>
                    AND A.VIN_NO LIKE '%'||#{sVinNo}||'%'
                </if>
                <if test='sCarStatCd != null and sCarStatCd != ""'>
                    AND A.CAR_STAT_CD = #{sCarStatCd}
                </if>
                <if test='sPltGiDtS != null and sPltGiDtE != null'>
                   AND A.PLT_GI_DT <![CDATA[>=]]> TRUNC(#{sPltGiDtS},'DD')
                   AND A.PLT_GI_DT <![CDATA[<]]> TRUNC(#{sPltGiDtE},'DD')+1
                </if>
                <if test='sGrDtS != null and sGrDtE != null'>
                   AND A.DLR_GR_DT <![CDATA[>=]]> TRUNC(#{sGrDtS},'DD')
                   AND A.DLR_GR_DT <![CDATA[<]]> TRUNC(#{sGrDtE},'DD')+1
                </if>
                 ORDER BY
                 <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "dlrCd"'>A.ORD_DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dstbCmpNm"'>B.DSTB_CMP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "trsfCarNo"'>B.TRSF_CAR_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "vinNo"'>A.VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carStatCd"'>A.CAR_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "grDt"'>A.DLR_GR_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "pltGiDt"'>A.PLT_GI_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dlrEvalDt"'>C.DLR_EVAL_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dstbSerEvalVal"'>C.DSTB_SER_EVAL_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "driverStsfVal"'>C.DRIVER_STSF_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carIssueHmVal"'>C.CAR_ISSUE_HM_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "carIssueMassVal"'>C.CAR_ISSUE_MASS_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "otherCont"'>C.OTHER_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    A.DLR_GR_DT DESC, A.ORD_DLR_CD, A.VIN_NO
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        A.DLR_GR_DT DESC, A.ORD_DLR_CD, A.VIN_NO
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 평가정보 수정  -->
    <update id="updateEvalSearchEdit" parameterType="ConfirmWearingVehiclePopupVO">
        MERGE INTO SA_0426T A
                USING(SELECT #{vinNo} AS VIN_NO
                            ,#{dlrEvalDt} AS DLR_EVAL_DT
                            ,#{dstbSerEvalVal} AS DSTB_SER_EVAL_VAL
                            ,#{driverStsfVal} AS DRIVER_STSF_VAL
                            ,#{carIssueHmVal} AS CAR_ISSUE_HM_VAL
                            ,#{carIssueMassVal} AS CAR_ISSUE_MASS_VAL
                            ,#{otherCont} AS OTHER_CONT
                            ,#{regUsrId} AS REG_USR_ID
                            ,SYSDATE AS REG_DT
                            ,#{updtUsrId} AS UPDT_USR_ID
                            ,SYSDATE AS UPDT_DT
                            ,#{dlrCd} AS DLR_CD
                        FROM DUAL) B
                        ON (A.VIN_NO = B.VIN_NO
                        AND A.DLR_EVAL_DT = SYSDATE)
        WHEN MATCHED THEN
            UPDATE SET A.DSTB_SER_EVAL_VAL  = B.DSTB_SER_EVAL_VAL
                      ,A.DRIVER_STSF_VAL    = B.DRIVER_STSF_VAL
                      ,A.CAR_ISSUE_HM_VAL   = B.CAR_ISSUE_HM_VAL
                      ,A.CAR_ISSUE_MASS_VAL = B.CAR_ISSUE_MASS_VAL
                      ,A.OTHER_CONT         = B.OTHER_CONT
                      ,A.UPDT_USR_ID        = B.UPDT_USR_ID
                      ,A.UPDT_DT            = B.UPDT_DT
                      ,A.DLR_CD             = B.DLR_CD
        WHEN NOT MATCHED THEN
            INSERT(A.VIN_NO
                  ,A.DLR_EVAL_DT
                  ,A.DSTB_SER_EVAL_VAL
                  ,A.DRIVER_STSF_VAL
                  ,A.CAR_ISSUE_HM_VAL
                  ,A.CAR_ISSUE_MASS_VAL
                  ,A.OTHER_CONT
                  ,A.REG_USR_ID
                  ,A.REG_DT
                  ,A.UPDT_USR_ID
                  ,A.UPDT_DT
                  ,A.DLR_CD
                  )VALUES(
                   B.VIN_NO
                  ,B.DLR_EVAL_DT
                  ,B.DSTB_SER_EVAL_VAL
                  ,B.DRIVER_STSF_VAL
                  ,B.CAR_ISSUE_HM_VAL
                  ,B.CAR_ISSUE_MASS_VAL
                  ,B.OTHER_CONT
                  ,B.REG_USR_ID
                  ,B.REG_DT
                  ,B.UPDT_USR_ID
                  ,B.UPDT_DT
                  ,B.DLR_CD
                  )
    </update>

</mapper>