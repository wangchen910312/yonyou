<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO">

    <!-- 차량마스터관리PopUp 리스트 -->
    <select id="selectDetlVehPopByConditionCnt" parameterType="GroupSalesReviewSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectDetlVehPopByConditionCnt] */

        SELECT COUNT(A.REQ_SEQ) AS VALUE
          FROM SA_0414T A , SA_0413T B
         WHERE A.DLR_CD   = #{sDlrCd}
           AND A.USR_ID   = #{sUsrId}
           AND A.REQ_SEQ  = #{sReqSeq}
           AND B.DLR_CD   = A.DLR_CD
           AND B.USR_ID   = A.USR_ID
           AND B.REQ_SEQ  = A.REQ_SEQ

    </select>

    <!-- 집단판매 차량정보 조회 -->
    <select id="selectDetlVehPopByCondition" parameterType="GroupSalesReviewSearchVO" resultType="GroupSalesReviewVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectDetlVehPopByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM ,T1.* FROM (
                 SELECT T.*
                       <!-- ,NVL(DECODE(C.DAMT, NULL, 0, (NVL(C.DAMT,0)+NVL(C.AAMT,0))/C.DAMT) ,0)AS DC_RATE -->
                       ,CASE WHEN C.AAMT+ABS(C.DAMT) <![CDATA[>]]> 0
                             THEN ROUND(ABS(C.DAMT)/(C.AAMT+ABS(C.DAMT))*100, 2)
                             ELSE 0 END AS DC_RATE
                       ,NVL(C.AAMT,0) AS AAMT
                   FROM (
                        SELECT A.DLR_CD
                              ,A.USR_ID
                              ,A.REQ_SEQ
                              ,A.APPROVE_CD
                              ,B.REQ_LOWER_SEQ
                              ,B.CARLINE_CD
                              ,B.MODEL_CD
                              ,B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 AS VIN_NO
                              ,B.STOCK_VIN_NO1
                              ,B.STOCK_VIN_NO2
                              ,B.FILE_DOC_ID
                              ,(
                               SELECT COUNT(FILE_NO) AS FILE_CNT
                                 FROM CM_0902T
                                 WHERE FILE_DOC_NO  = B.FILE_DOC_ID
                                   AND DEL_YN = 'N'
                              ) AS FILE_DOC_CNT
                              ,FN_GET_CARLINE_NM_NC(B.CARLINE_CD) AS CARLINE_NM
                              ,FN_GET_MODEL_TP_NM(B.MODEL_CD,B.OCN_CD) AS MODEL_NM
                              ,B.OCN_CD
                              ,FN_GET_OCN_NM_NC(B.MODEL_CD,B.OCN_CD) AS OCN_NM
                              ,B.EXT_COLOR_CD
                              ,FN_GET_EXT_COLOR_NM_NC(B.EXT_COLOR_CD) AS EXT_COLOR_NM
                              ,B.INT_COLOR_CD
                              ,FN_GET_INT_COLOR_NM_NC(B.INT_COLOR_CD) AS INT_COLOR_NM
                              ,(SELECT NVL(MAX(MS_PRC),0) FROM SA_0110T WHERE MODEL_CD = B.MODEL_CD AND OCN_CD = B.OCN_CD AND END_DT  >=  SYSDATE) AS MS_PRC
                          FROM SA_0414T A , SA_0413T B
                         WHERE A.DLR_CD   = #{sDlrCd}
                           AND A.USR_ID   = #{sUsrId}
                           AND A.REQ_SEQ  = #{sReqSeq}
                           AND B.DLR_CD   = A.DLR_CD
                           AND B.USR_ID   = A.USR_ID
                           AND B.REQ_SEQ  = A.REQ_SEQ
                       )T LEFT OUTER JOIN SA_0416T C
                       ON T.STOCK_VIN_NO1 = C.VIN_NO1
                      AND T.STOCK_VIN_NO2 = C.VIN_NO2
                      AND T.DLR_CD        = C.DLR_CD
                ) T1
        )
    </select>

    <!-- 목록 갯수  -->
    <select id="selectGroupSalesReviewByConditionCnt" parameterType="GroupSalesReviewSearchVO" resultType="int">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectGroupSalesReviewByConditionCnt] */

                SELECT COUNT(T2.REQ_SEQ) AS VALUE
                  FROM (
                    SELECT T1.*
                          ,CASE WHEN T1.LAST_APPROVE_CNT  <![CDATA[<]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='B'
                                THEN '02'
                                WHEN T1.LAST_APPROVE_CNT   =   T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '01'
                                WHEN T1.LAST_APPROVE_CNT  <![CDATA[ < ]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '02'
                                ELSE '01' END AS EVAL_YN  -- 01 : 기심사 , 02 : 미심사
                          ,CASE WHEN T1.EVAL_USR_GRDE IS NULL
                                     THEN 'N'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[<=  ]]>  T1.LAST_APPROVE_CNT AND T1.APPROVE_CD = 'D' )
                                     THEN 'Y'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[ > ]]>  T1.LAST_APPROVE_CNT AND T1.APPROVE_CD != 'D')
                                     THEN 'Y'
                                WHEN T1.APPROVE_CD != 'D' THEN 'Y'
                                     ELSE 'N' END SRC_YN
                          ,TO_CHAR(EVAL_DT, 'YYYY-MM-DD') AS EVAL_DT_XLS
                      FROM (
                            SELECT A.DLR_CD,                     --딜러
                                   A.USR_ID,                     --사용자ID
                                   A.REQ_SEQ,
                                   A.REQ_SAL_NO AS APPLY_NO,
                                   (SELECT OFF_NM
                                      FROM CM_2601T Y
                                     WHERE Y.DIVI_CD = B.SDPT_CD
                                       AND Y.OFF_CD  = B.DIST_OFFICE_CD
                                   ) AS OFFICE_NM,
                                   DLR_NM,
                                   B.SDPT_CD,            --사업부
                                   B.DIST_OFFICE_CD,     --사무소
                                   B.SALE_DLR_SUNG_CD,   --성
                                   B.SALE_DLR_CITY_CD,   --도시
                                   A.ATC_DSTIN_CD,
                                   A.CUST_NM,
                                   A.APPLY_DT,
                                   ( SELECT NVL(MAX(REQ_QTY), 0)
                                       FROM SA_0415T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS REQ_QTY,
                                   ( SELECT NVL(MAX(REQ_NO), 0)
                                       FROM SA_0412T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS REQ_NO,
                                   ( SELECT NVL(MAX(EVAL_RSLT_YN), 'N')
                                       FROM SA_0412T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS RSLT_YN,
                                   C.EVAL_DT,
                                   TO_CHAR(A.APPLY_DT, 'YYYY-MM-DD') AS APPLY_DT_XLS,
                                   A.APPROVE_CD ,
                                   A.EVAL_GRADE_CD,
                                   NVL(A.LAST_APPROVE_CNT,0) AS LAST_APPROVE_CNT,
                                   (
                                     SELECT EVAL_GRADE_CD
                                       FROM SA_0156T
                                      WHERE 1=1
                                        AND DLR_CD       = #{sApporveDlrCd}
                                        AND USR_ID       = #{sApporveUsrId}
                                        AND WRK_DSTIN_CD = #{sWrkDstinCd}
                                   )AS EVAL_USR_GRDE
                              FROM SA_0414T A , CM_0101T B
                                 , (
                                    SELECT DLR_CD, USR_ID, REQ_SEQ
                                         , MAX(EVAL_DT) AS EVAL_DT
                                      FROM SA_0412T
                                     GROUP BY DLR_CD, USR_ID, REQ_SEQ
                                   ) C
                             WHERE B.DLR_CD      = A.DLR_CD
                               AND A.DLR_CD = C.DLR_CD (+)
                               AND A.USR_ID  = C.USR_ID (+)
                               AND A.REQ_SEQ = C.REQ_SEQ (+)
                               AND A.DEL_YN      = 'N'
                               AND A.APPROVE_CD != 'A'
                             <if test='sLastStartUpdt != null' >
                               AND C.EVAL_DT <![CDATA[ >= ]]> TRUNC(#{sLastStartUpdt},'DD')
                             </if>
                             <if test='sLastEndUpdt != null' >
                               AND C.EVAL_DT <![CDATA[<]]> TRUNC(#{sLastEndUpdt},'DD')+1
                             </if>
                             <if test='sDiviCd != null and sDiviCd != ""'>
                               AND B.SDPT_CD = #{sDiviCd}
                             </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能   jiaMing 2021-2-24 start
                             <if test='sOffCd != null and sOffCd != ""'>
                               AND B.DIST_OFFICE_CD = #{sOffCd}
                             </if>
                             -->
                            <if test='sOffCdList != null and !sOffCdList.isEmpty'> AND B.DIST_OFFICE_CD IN
                               <foreach item="item" index="index" collection="sOffCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end-->
                             <if test='sSungCd != null and sSungCd != ""'>
                               AND B.SALE_DLR_SUNG_CD = #{sSungCd}
                             </if>
                             <if test='sCityCd != null and sCityCd != ""'>
                               AND B.SALE_DLR_CITY_CD = #{sCityCd}
                             </if>
                             <if test='sApplyNo != null and sApplyNo != ""'>
                               AND A.REQ_SAL_NO LIKE '%'||#{sApplyNo}||'%'
                             </if>
                             <if test='sDlrCd != null and sDlrCd != ""'>
                               AND A.DLR_CD = #{sDlrCd}
                             </if>
                             <if test='sCustNm != null and sCustNm != ""'>
                               AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                             </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 start
                             <if test='sAtcDstinCd != null and sAtcDstinCd != ""'>
                               AND A.ATC_DSTIN_CD = #{sAtcDstinCd}
                             </if>
                              -->
                              <if test='sAtcDstinCdList != null and !sAtcDstinCdList.isEmpty'> AND A.ATC_DSTIN_CD IN
                               <foreach item="item" index="index" collection="sAtcDstinCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                            <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end -->
                             <if test='sApplyDtS !=null'>
                               AND A.APPLY_DT <![CDATA[>=]]> #{sApplyDtS}
                             </if>
                             <if test='sApplyDtE !=null'>
                               AND A.APPLY_DT <![CDATA[<]]> #{sApplyDtE}+1
                             </if>
                             <if test='sApproveCd != null and sApproveCd != ""'>
                               AND A.APPROVE_CD = #{sApproveCd}
                             </if>
                               AND EXISTS (
                                   SELECT MNG_DLR_CD
                                     FROM SA_0439T
                                    WHERE DLR_CD = 'A07AA'
                                      AND USR_ID = #{sApporveUsrId}
                                      AND MNG_DLR_CD = A.DLR_CD
                               )
                               AND EXISTS (
                                    SELECT DLR_CD
                                      FROM CM_0101T
                                     WHERE DLR_CD     = A.DLR_CD
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 start -->
                                  <!--  AND DMS_USE_YN = 'Y' -->
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 end -->
                                       AND OPEN_DT <![CDATA[ <= ]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
                               )
                         )T1
                    WHERE LAST_APPROVE_CNT <![CDATA[ >= ]]>  #{sUsrEvalGrade}-1
                )T2
                WHERE SRC_YN ='Y'
                    <if test='sEvalRsltYn != null and sEvalRsltYn != ""'>
                      AND T2.EVAL_YN = #{sEvalRsltYn}
                    </if>
    </select>

    <!-- 집단판매 심사  조회 목록  -->
    <select id="selectGroupSalesReviewByCondition" parameterType="GroupSalesReviewSearchVO" resultType="GroupSalesReviewVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectGroupSalesReviewByCondition] */

        SELECT * FROM (
            SELECT ROWNUM AS RNUM,
                   T2.*
             FROM (
                    SELECT T1.*
                          ,CASE WHEN T1.LAST_APPROVE_CNT  <![CDATA[<]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='B'
                                THEN '02'
                                WHEN T1.LAST_APPROVE_CNT   =   T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '01'
                                WHEN T1.LAST_APPROVE_CNT  <![CDATA[ < ]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '02'
                                ELSE '01' END AS EVAL_YN  -- 01 : 기심사 , 02 : 미심사
                          ,CASE WHEN T1.EVAL_USR_GRDE IS NULL
                                     THEN 'N'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[<=  ]]> T1.LAST_APPROVE_CNT AND T1.APPROVE_CD = 'D' )
                                     THEN 'Y'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[ > ]]>  T1.LAST_APPROVE_CNT AND T1.APPROVE_CD != 'D')
                                     THEN 'Y'
                                WHEN T1.APPROVE_CD != 'D'
                                     THEN 'Y'
                                ELSE 'N' END SRC_YN
                         ,TO_CHAR(EVAL_DT, 'YYYY-MM-DD') AS EVAL_DT_XLS
                      FROM (
                            SELECT A.DLR_CD,                     --딜러
                                   A.USR_ID,                     --사용자ID
                                   A.REQ_SEQ,
                                   A.REQ_SAL_NO AS APPLY_NO,
                                   (SELECT OFF_NM
                                      FROM CM_2601T Y
                                     WHERE Y.DIVI_CD = B.SDPT_CD
                                       AND Y.OFF_CD  = B.DIST_OFFICE_CD
                                   ) AS OFFICE_NM,
                                   DLR_NM,
                                   B.SDPT_CD,            --사업부
                                   (SELECT DIVI_NM FROM CM_2501T WHERE DIVI_CD = B.SDPT_CD) AS SDPT_NM,
                                   B.DIST_OFFICE_CD,     --사무소
                                   B.SALE_DLR_SUNG_CD,   --성
                                   B.SALE_DLR_CITY_CD,   --도시
                                   A.ATC_DSTIN_CD,
                                   A.CUST_NM,
                                   A.APPLY_DT,
                                   ( SELECT SUM(NVL(REQ_QTY, 0))
                                       FROM SA_0415T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS REQ_QTY,
                                   ( SELECT NVL(MAX(REQ_NO), 0)
                                       FROM SA_0412T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS REQ_NO,
                                   ( SELECT NVL(MAX(EVAL_RSLT_YN), 0)
                                       FROM SA_0412T
                                      WHERE DLR_CD  = A.DLR_CD
                                        AND USR_ID  = A.USR_ID
                                        AND REQ_SEQ = A.REQ_SEQ
                                   )AS RSLT_YN,
                                   C.EVAL_DT,
                                   TO_CHAR(A.APPLY_DT, 'YYYY-MM-DD') AS APPLY_DT_XLS,
                                   A.APPROVE_CD,
                                   A.EVAL_GRADE_CD,
                                   NVL(A.LAST_APPROVE_CNT,0) AS LAST_APPROVE_CNT,
                                   (
                                     SELECT EVAL_GRADE_CD
                                       FROM SA_0156T
                                      WHERE 1=1
                                        AND DLR_CD       = #{sApporveDlrCd}
                                        AND USR_ID       = #{sApporveUsrId}
                                        AND WRK_DSTIN_CD = #{sWrkDstinCd}
                                   )AS EVAL_USR_GRDE
                              FROM SA_0414T A , CM_0101T B
                                 , (
                                    SELECT DLR_CD, USR_ID, REQ_SEQ
                                         , MAX(EVAL_DT) AS EVAL_DT
                                      FROM SA_0412T
                                     GROUP BY DLR_CD, USR_ID, REQ_SEQ
                                   ) C
                             WHERE B.DLR_CD      = A.DLR_CD
                               AND A.DLR_CD = C.DLR_CD (+)
                               AND A.USR_ID  = C.USR_ID (+)
                               AND A.REQ_SEQ = C.REQ_SEQ (+)
                               AND A.DEL_YN      = 'N'
                               AND A.APPROVE_CD != 'A'
                             <if test='sLastStartUpdt != null' >
                               AND C.EVAL_DT <![CDATA[ >= ]]> TRUNC(#{sLastStartUpdt},'DD')
                             </if>
                             <if test='sLastEndUpdt != null' >
                               AND C.EVAL_DT <![CDATA[<]]> TRUNC(#{sLastEndUpdt},'DD')+1
                             </if>
                             <if test='sDiviCd != null and sDiviCd != ""'>
                               AND B.SDPT_CD = #{sDiviCd}
                             </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能   jiaMing 2021-2-24 start
                              <if test='sOffCd != null and sOffCd != ""'>
                               AND B.DIST_OFFICE_CD = #{sOffCd}
                               </if>
                             -->
                            <if test='sOffCdList != null and !sOffCdList.isEmpty'> AND B.DIST_OFFICE_CD IN
                               <foreach item="item" index="index" collection="sOffCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end-->
                             <if test='sSungCd != null and sSungCd != ""'>
                               AND B.SALE_DLR_SUNG_CD = #{sSungCd}
                             </if>
                             <if test='sCityCd != null and sCityCd != ""'>
                               AND B.SALE_DLR_CITY_CD = #{sCityCd}
                             </if>
                             <if test='sApplyNo != null and sApplyNo != ""'>
                               AND A.REQ_SAL_NO LIKE '%'||#{sApplyNo}||'%'
                             </if>
                             <if test='sDlrCd != null and sDlrCd != ""'>
                               AND A.DLR_CD = #{sDlrCd}
                             </if>
                             <if test='sCustNm != null and sCustNm != ""'>
                               AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                             </if>
                             
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 start
                             <if test='sAtcDstinCd != null and sAtcDstinCd != ""'>
                               AND A.ATC_DSTIN_CD = #{sAtcDstinCd}
                             </if>
                              -->
                              <if test='sAtcDstinCdList != null and !sAtcDstinCdList.isEmpty'> AND A.ATC_DSTIN_CD IN
                               <foreach item="item" index="index" collection="sAtcDstinCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                            <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end -->
                            
                             <if test='sApplyDtS !=null'>
                               AND A.APPLY_DT <![CDATA[>=]]> #{sApplyDtS}
                             </if>
                             <if test='sApplyDtE !=null'>
                               AND A.APPLY_DT <![CDATA[<]]> #{sApplyDtE}+1
                             </if>
                             <if test='sApproveCd != null and sApproveCd != ""'>
                               AND A.APPROVE_CD = #{sApproveCd}
                             </if>
                               AND EXISTS (
                                   SELECT MNG_DLR_CD
                                     FROM SA_0439T
                                    WHERE DLR_CD = 'A07AA'
                                      AND USR_ID = #{sApporveUsrId}
                                      AND MNG_DLR_CD = A.DLR_CD
                               )
                               AND EXISTS (
                                    SELECT DLR_CD
                                      FROM CM_0101T
                                     WHERE DLR_CD     = A.DLR_CD
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 start -->
                                  <!--  AND DMS_USE_YN = 'Y' -->
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 end --> 
                                       AND OPEN_DT <![CDATA[ <= ]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
                               )
                         )T1
                    WHERE LAST_APPROVE_CNT <![CDATA[ >= ]]>  #{sUsrEvalGrade}-1
                    ORDER BY
                     <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "applyNo"'>APPLY_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "distCd"'>DIST_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "dlrCd"'>DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "dlrNm"'>DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "atcDstinCd"'>ATC_DSTIN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "custNm"'>CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "reqQty"'>REQ_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "assignQty"'>ASSIGN_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "applyDt"'>APPLY_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "evalDt"'>EVAL_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "approveCd"'>APPROVE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "evalRsltYn"'>EVAL_RSLT_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                       DLR_CD ASC, APPLY_DT DESC NULLS LAST, APPROVE_CD ASC, REQ_SEQ ASC
                                    </otherwise>
                                </choose>
                             </foreach>
                        </when>
                        <otherwise>
                            DLR_CD ASC, APPLY_DT DESC NULLS LAST, APPROVE_CD ASC, REQ_SEQ ASC
                        </otherwise>
                    </choose>
               ) T2
                WHERE SRC_YN ='Y'
                <if test='sEvalRsltYn != null and sEvalRsltYn != ""'>
                  AND T2.EVAL_YN = #{sEvalRsltYn}
                </if>
                <if test='firstIndex != -1 and lastIndex != -1'>
                  AND ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <select id="selectGroupSalesReviewExcelByCondition" parameterType="GroupSalesReviewSearchVO" resultType="GroupSalesReviewVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectGroupSalesReviewExcelByCondition] */
	/*2018-11-12 update by weiyingjie 集团销售下载excel里  1. 审批状态中文没有跟画面上的统一。 start */
           SELECT T2.*,
<!--                    CASE WHEN RSLT_YN = 'Y' -->
<!--                         THEN  ( -->
<!--                               SELECT MESG_TXT -->
<!--                                 FROM CM_0501T -->
<!--                                WHERE MESG_KEY ='global.btn.approval' -->
<!--                                  AND LANG_CD  =#{sLangCd} -->
<!--                               ) -->
<!--                         ELSE ( -->
<!--                             SELECT MESG_TXT -->
<!--                                FROM CM_0501T -->
<!--                               WHERE MESG_KEY = 'global.btn.nonApproval' -->
<!--                                 AND LANG_CD  = #{sLangCd} -->
<!--                          ) -->
 CASE
            WHEN
                t2.approve_cd = 'B'
            THEN
                (
                    SELECT
                        mesg_txt
                    FROM
                        cm_0501t
                    WHERE
                            mesg_key = 'global.btn.Approvaling'
                        AND
                            lang_cd = #{sLangCd}
                )
            WHEN
                t2.approve_cd = 'C'
            THEN
                (
                    SELECT
                        mesg_txt
                    FROM
                        cm_0501t
                    WHERE
                             mesg_key = 'sal.lbl.approvals'
                        AND
                            lang_cd = #{sLangCd}
                )
            ELSE
                (
                    SELECT
                        mesg_txt
                    FROM
                        cm_0501t
                    WHERE
                           mesg_key = 'sal.btn.reject'
                        AND
                            lang_cd = #{sLangCd}
                )
                   END RSLT_NM
             FROM (
                    SELECT T1.*
                          ,CASE WHEN T1.LAST_APPROVE_CNT  <![CDATA[<]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='B'
                                THEN '02'
                                WHEN T1.LAST_APPROVE_CNT   =   T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '01'
                                WHEN T1.LAST_APPROVE_CNT  <![CDATA[ < ]]>  T1.EVAL_USR_GRDE AND T1.APPROVE_CD ='C'
                                THEN '02'
                                ELSE '01' END AS EVAL_YN  -- 01 : 기심사 , 02 : 미심사
                          ,CASE WHEN T1.EVAL_USR_GRDE IS NULL
                                     THEN 'N'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[<=  ]]> T1.LAST_APPROVE_CNT AND T1.APPROVE_CD = 'D' )
                                     THEN 'Y'
                                WHEN (T1.EVAL_USR_GRDE <![CDATA[ > ]]>  T1.LAST_APPROVE_CNT AND T1.APPROVE_CD != 'D')
                                     THEN 'Y'
                                WHEN T1.APPROVE_CD != 'D'
                                     THEN 'Y'
                                ELSE 'N' END SRC_YN
                      FROM (
                            SELECT A.DLR_CD,                     --딜러
                                   A.USR_ID,                     --사용자ID
                                   A.REQ_SEQ,
                                   A.REQ_SAL_NO,
                                   (SELECT OFF_NM
                                      FROM CM_2601T Y
                                     WHERE Y.DIVI_CD = C.SDPT_CD
                                       AND Y.OFF_CD  = C.DIST_OFFICE_CD
                                   ) AS OFFICE_NM,
                                   DLR_NM,
                                   C.SDPT_CD,            --사업부
                                   (SELECT DIVI_NM
                                      FROM CM_2501T
                                     WHERE DIVI_CD = C.SDPT_CD) AS SDPT_NM,
                                   C.DIST_OFFICE_CD,     --사무소
                                   C.SALE_DLR_SUNG_CD,   --성
                                   C.SALE_DLR_CITY_CD,   --도시
                                   A.ATC_DSTIN_CD,
                                   A.CUST_NM,
                                   A.APPLY_DT,
                                   A.LAST_APPROVE_DT,
                                   D.ORD_TP,
                                   FN_CMM_CD_NM('SAL137',D.ORD_TP, #{sLangCd},'N') AS ORD_TP_NM,
                                   B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 AS VIN_NO,
                                   B.CARLINE_CD,
                                   FN_GET_CARLINE_NM(B.CARLINE_CD) AS CARLINE_NM,
                                   B.MODEL_CD,
                                   FN_GET_FSC_NM(B.CARLINE_CD , B.MODEL_CD) AS MODEL_NM,
                                   B.OCN_CD,
                                   FN_GET_OCN_NM_NC(B.MODEL_CD,B.OCN_CD) AS OCN_NM,
                                   B.EXT_COLOR_CD,
                                   FN_GET_EXT_COLOR_NM(B.EXT_COLOR_CD) AS EXT_COLOR_NM,
                                   B.INT_COLOR_CD,
                                   (SELECT NVL(MAX(MS_PRC),0)
                                      FROM SA_0110T
                                     WHERE MODEL_CD = B.MODEL_CD
                                       AND OCN_CD = B.OCN_CD
                                       AND END_DT  >=  SYSDATE) AS MS_PRC,
                                   <!-- NVL(DECODE(E.DAMT, NULL, 0, (NVL(E.DAMT,0)+NVL(E.AAMT,0))/E.DAMT) ,0)AS DC_RATE, -->
                                   CASE WHEN E.AAMT + ABS(E.DAMT) <![CDATA[>]]> 0
                                        THEN ROUND(ABS(E.DAMT)/(E.AAMT+ABS(E.DAMT))*100, 2)
                                   ELSE 0 END AS DC_RATE,
                                   E.AAMT,
                                   FN_CMM_CD_NM('SAL151',A.ATC_DSTIN_CD,#{sLangCd},'N') AS ATC_DSTIN_NM,
                                   A.PRSN_ID,
                                   A.HP_NO,
                                   A.TEL_NO,
                                   A.CAR_USE_TP,
                                   A.PRSN_DLR_CD,
                                   A.PRSN_DLR_TEL_NO,
                                   (SELECT FILE_NM
                                      FROM CM_0902T
                                    WHERE FILE_DOC_NO = A.FILE_DOC_ID
                                      AND FILE_NO     = A.CONTRACT_DOC_SEQ
                                    ) AS CONTRACT_FILE_NM,
                                   (SELECT FILE_NM
                                      FROM CM_0902T
                                     WHERE FILE_DOC_NO = A.FILE_DOC_ID
                                      AND FILE_NO     = A.CRN_DOC_SEQ
                                    ) AS BUSS_LICENCE_FILE_NM,
                                   (SELECT FILE_NM
                                      FROM CM_0902T
                                     WHERE FILE_DOC_NO = A.FILE_DOC_ID
                                       AND FILE_NO     = A.ETC_DOC_SEQ
                                    ) AS ETC_FILE_NM,
                                   (SELECT FILE_NM
                                      FROM CM_0902T
                                     WHERE FILE_DOC_NO = A.FILE_DOC_ID
                                       AND FILE_NO     = A.ADD_FILE_SEQ
                                    ) AS ADD_FILE_NM,
                                   A.APPROVE_CD,
                                   A.EVAL_GRADE_CD,
                                   NVL(A.LAST_APPROVE_CNT,0) AS LAST_APPROVE_CNT,
                                   (SELECT EVAL_GRADE_CD
                                       FROM SA_0156T
                                      WHERE 1=1
                                        AND DLR_CD       = #{sApporveDlrCd}
                                        AND USR_ID       = #{sApporveUsrId}
                                        AND WRK_DSTIN_CD = #{sWrkDstinCd}
                                   )AS EVAL_USR_GRDE,
                                   ( SELECT NVL(EVAL_RSLT_YN, 'N') AS EVAL_RSLT_YN
                                      FROM SA_0412T Z1
                                     INNER JOIN (SELECT DLR_CD, USR_ID, REQ_SEQ, MAX(REQ_NO) AS REQ_NO FROM SA_0412T GROUP BY DLR_CD, USR_ID, REQ_SEQ) Z2
                                        ON Z1.DLR_CD = Z2.DLR_CD
                                       AND Z1.USR_ID = Z2.USR_ID
                                       AND Z1.REQ_SEQ = Z2.REQ_SEQ
                                       AND Z1.REQ_NO = Z2.REQ_NO
                                     WHERE Z1.DLR_CD  = A.DLR_CD
                                       AND Z1.USR_ID  = A.USR_ID
                                       AND Z1.REQ_SEQ = A.REQ_SEQ
                                   ) AS RSLT_YN,
                                   E.ALDY
                            FROM SA_0414T A , SA_0413T B ,CM_0101T C, SA_0121T D, SA_0416T E
                               , (
                                    SELECT DLR_CD, USR_ID, REQ_SEQ
                                         , MAX(EVAL_DT) AS EVAL_DT
                                      FROM SA_0412T
                                     GROUP BY DLR_CD, USR_ID, REQ_SEQ
                                  ) F
                           WHERE C.DLR_CD = A.DLR_CD
                             AND B.DLR_CD = A.DLR_CD(+)
                             AND B.USR_ID = A.USR_ID(+)
                             AND B.REQ_SEQ = A.REQ_SEQ(+)
                            <!--
                            问题编号：R19062700418 ； 集团销售审批下载Excel中的数量和显示的数量不同；

                            原因：关联条件有有问题，应该是  B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 = D.VIN_NO1(+) 导致连接查询时多查询出记录
                             2019-07-04 update by zqh

                             修改前：AND B.STOCK_VIN_NO1 = D.VIN_NO1(+)

                             -->
                             AND B.STOCK_VIN_NO1 || B.STOCK_VIN_NO2 = D.VIN_NO1(+)
                             AND B.STOCK_VIN_NO2 = D.VIN_NO2(+)
                             AND D.VIN_NO1 = E.VIN_NO1(+)
                             AND D.VIN_NO2 = E.VIN_NO2(+)
                             AND B.DLR_CD = F.DLR_CD(+)
                             AND B.USR_ID = F.USR_ID(+)
                             AND B.REQ_SEQ = F.REQ_SEQ(+)
                             AND A.DEL_YN = 'N'
                             AND A.APPROVE_CD != 'A'
                             <if test='sDiviCd != null and sDiviCd != ""'>
                               AND C.SDPT_CD = #{sDiviCd}
                             </if>
                            
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能   jiaMing 2021-2-24 start
                              <if test='sOffCd != null and sOffCd != ""'>
                               AND C.DIST_OFFICE_CD = #{sOffCd}
                             </if>
                             -->
                            <if test='sOffCdList != null and !sOffCdList.isEmpty'> AND C.DIST_OFFICE_CD IN
                               <foreach item="item" index="index" collection="sOffCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                             <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end-->
                             <if test='sSungCd != null and sSungCd != ""'>
                               AND C.SALE_DLR_SUNG_CD = #{sSungCd}
                             </if>
                             <if test='sCityCd != null and sCityCd != ""'>
                               AND C.SALE_DLR_CITY_CD = #{sCityCd}
                             </if>
                             <if test='sApplyNo != null and sApplyNo != ""'>
                               AND A.REQ_SAL_NO LIKE '%'||#{sApplyNo}||'%'
                             </if>
                             <if test='sDlrCd != null and sDlrCd != ""'>
                               AND A.DLR_CD = #{sDlrCd}
                             </if>
                             <if test='sCustNm != null and sCustNm != ""'>
                               AND A.CUST_NM LIKE '%'||#{sCustNm}||'%'
                             </if>
                             
                              <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 start
                             <if test='sAtcDstinCd != null and sAtcDstinCd != ""'>
                               AND A.ATC_DSTIN_CD = #{sAtcDstinCd}
                             </if>
                              -->
                              <if test='sAtcDstinCdList != null and !sAtcDstinCdList.isEmpty'> AND A.ATC_DSTIN_CD IN
                               <foreach item="item" index="index" collection="sAtcDstinCdList" open="(" separator="," close=")">
                                   #{item}
                               </foreach>
                            </if>
                            <!-- Q21012900013	集团审批界面，项目类型和办事处多选功能    jiaMing 2021-2-24 end -->
                             <if test='sApplyDtS !=null'>
                               AND A.APPLY_DT <![CDATA[>=]]> #{sApplyDtS}
                             </if>
                             <if test='sApplyDtE !=null'>
                               AND A.APPLY_DT <![CDATA[<]]> #{sApplyDtE}+1
                             </if>
                             <if test='sLastStartUpdt != null' >
                               AND F.EVAL_DT <![CDATA[ >= ]]> TRUNC(#{sLastStartUpdt},'DD')
                             </if>
                             <if test='sLastEndUpdt != null' >
                               AND F.EVAL_DT <![CDATA[<]]> TRUNC(#{sLastEndUpdt},'DD')+1
                             </if>
                             <if test='sApproveCd != null and sApproveCd != ""'>
                               AND A.APPROVE_CD = #{sApproveCd}
                             </if>
                             AND EXISTS (
                                   SELECT MNG_DLR_CD
                                     FROM SA_0439T
                                    WHERE DLR_CD = 'A07AA'
                                      AND USR_ID = #{sApporveUsrId}
                                      AND MNG_DLR_CD = A.DLR_CD
                               )
                             AND EXISTS (
                                SELECT DLR_CD
                                  FROM CM_0101T
                                 WHERE DLR_CD     = A.DLR_CD
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 start -->
                                  <!--  AND DMS_USE_YN = 'Y' -->
                                 <!--20190815 集团申请已退网经销商可以查询历史记录。 业务张伟丽  update by sunzq3 end -->
                                   AND OPEN_DT <![CDATA[ <= ]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
                            )
                         )T1
                    WHERE LAST_APPROVE_CNT <![CDATA[ >= ]]>  #{sUsrEvalGrade}-1
                    ORDER BY DLR_CD ASC, APPLY_DT DESC NULLS LAST, APPROVE_CD ASC, REQ_SEQ ASC
               ) T2
                WHERE SRC_YN ='Y'
                <if test='sEvalRsltYn != null and sEvalRsltYn != ""'>
                  AND T2.EVAL_YN = #{sEvalRsltYn}
                </if>

    </select>

    <!-- 법인 - 집단판매 심사 저장 -->
    <insert id="insertGroupSalesReview" parameterType="GroupSalesReviewVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.insertGroupSalesReview] */

        INSERT
          INTO SA_0412T(
               DLR_CD
             , USR_ID
             , REQ_SEQ
             , REQ_NO
             , EVAL_RSLT_YN
             , PEVAL_ID
             , EVAL_DT
             , REMARK
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
         )VALUES(
               #{dlrCd}
             , #{usrId}
             , #{reqSeq}
             , (SELECT NVL(MAX(REQ_NO), 0) + 1 FROM SA_0412T
                 WHERE DLR_CD = #{dlrCd}
                   AND REQ_SEQ = #{reqSeq})
             , #{evalRsltYn}
             , #{regUsrId}
             , SYSDATE
             , #{remark}
             , #{regUsrId}
             , SYSDATE
             , #{updtUsrId}
             , SYSDATE
        )
       <selectKey resultType="int" keyProperty="reqNo" order="AFTER">
           SELECT MAX(REQ_NO) AS reqNo FROM SA_0412T WHERE DLR_CD = #{dlrCd} AND REQ_SEQ = #{reqSeq}
       </selectKey>
    </insert>

    <!-- 파일 미리보기   -->
    <select id="selectGroupSalesFileByCondition_back" parameterType="GroupSalesReviewSearchVO" resultType="FileItemVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectGroupSalesFileByCondition] */

        SELECT ROWNUM AS RNUM , B.*
         FROM SA_0413T A , CM_0902T B
         WHERE A.DLR_CD       = #{sDlrCd}
           AND A.USR_ID       = #{sUsrId}
           AND B.FILE_DOC_NO  = A.FILE_DOC_ID
           AND B.DEL_YN       = 'N'
           AND A.FILE_DOC_ID IS NOT NULL
           AND A.REQ_SEQ      = #{sReqSeq}
    </select>

    <select id="selectGroupSalesFileByCondition" parameterType="GroupSalesApplicationSearchVO" resultType="FileItemVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.selectGroupSalesFileByCondition] */

        SELECT ROWNUM AS RNUM , B.*
         FROM CM_0902T B
         WHERE B.DEL_YN       = 'N'
           <choose>
              <otherwise>
                <![CDATA[
                 AND B.FILE_DOC_NO IN( SELECT DISTINCT REGEXP_SUBSTR (TXT, '[^,]+', 1, LEVEL)
                                   FROM ( SELECT #{sFileDocId} AS TXT FROM DUAL)
                                 CONNECT BY LEVEL <= LENGTH(REGEXP_REPLACE (TXT, '[^,]+', '') ) + 1
                                )
                ]]>
              </otherwise>
           </choose>
    </select>


    <!-- 법인 - 집단판매 심사 확정(B:신청 , C:통과 , D:거부) -->
    <update id="updateGroupSalesReview" parameterType="GroupSalesReviewVO">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.updateGroupSalesReview] */

        UPDATE SA_0414T
           SET APPROVE_CD = #{approveCd}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
             , LAST_APPROVE_CNT = #{usrEvalGrade}
             , LAST_APPROVE_DT = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND USR_ID = #{usrId}
           AND REQ_SEQ = #{reqSeq}
    </update>



    <!-- 집단판매신청심사결과 송신 프로시져  -->
    <update id="procPackageReview" parameterType="GroupSalesReviewVO" statementType="CALLABLE">
    /* [chn.bhmc.dms.sal.svi.service.dao.GroupSalesReviewDAO.procPackageReview] */

        {CALL SP_SAL_DCS_P_0412T_IF(
              'SAL090'
            , #{dlrCd, mode=IN, jdbcType=VARCHAR}
            , #{usrId, mode=IN, jdbcType=VARCHAR}
            , #{reqSeq, mode=IN, jdbcType=NUMERIC}
          <!--   , #{reqNo, mode=IN, jdbcType=VARCHAR} -->
        )}
    </update>

</mapper>