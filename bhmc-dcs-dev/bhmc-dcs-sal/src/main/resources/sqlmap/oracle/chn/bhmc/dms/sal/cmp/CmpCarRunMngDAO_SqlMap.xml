<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="chn.bhmc.dms.sal.cmp.service.dao.CmpCarRunMngDAO">

	<!-- 회사차운행관리 목록 조회  -->
	<select id="selectCmpCarRunMngByCondition" parameterType="CmpCarRunMngSearchVO" resultType="CmpCarRunMngVO">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT SA0211.VIN_NO,SA0211.USE_START_DT,SA0211.USE_END_DT,SA0211.CAR_REG_NO
                      ,SA0211.CARLINE_CD,FN_GET_CARLINE_NM(SA0211.CARLINE_CD) AS CARLINE_NM
                      ,SA0211.MODEL_CD,FN_GET_MODEL_NM(SA0211.MODEL_CD) AS MODEL_NM
                      ,SA0211.OCN_CD,FN_GET_OCN_NM(SA0211.MODEL_CD, SA0211.OCN_CD) AS OCN_NM
                      ,SA0211.USR_ID,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = SA0211.USR_ID) AS USR_NM
                      ,SA0211.USE_START_KM_VAL,SA0211.USE_END_KM_VAL
                      ,SA0211.CMP_CAR_DSTIN_CD,SA0211.REMARK
                      ,SA0211.REG_USR_ID,SA0211.REG_DT,SA0211.UPDT_USR_ID,SA0211.UPDT_DT
                  FROM SA_0211T SA0211
                 WHERE 1=1
                 <if test='sCmpCarDstinCd != null and sCmpCarDstinCd != ""'>
                    AND SA0211.CMP_CAR_DSTIN_CD = #{sCmpCarDstinCd}
                 </if>
                 <if test='sVinNo != null and sVinNo != ""'>
                    AND SA0211.VIN_NO LIKE '%' || #{sVinNo} || '%'
                 </if>
                 <if test='sCarRegNo != null and sCarRegNo != ""'>
                   AND SA0211.CAR_REG_NO = #{sCarRegNo}
                 </if>
                 <if test='sUseStartDt != null'>
                     AND SA0211.USE_START_DT <![CDATA[>=]]> TRUNC(#{sUseStartDt},'DD')
                 </if>
                 <if test='sUseEndDt != null'>
                     AND SA0211.USE_END_DT <![CDATA[<]]> TRUNC(#{sUseEndDt},'DD')+1
                 </if>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
         ORDER BY
         <choose>
            <when test='sort != null'>
                <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                    <choose>
                        <when test='item.field == "vinNo"'>VIN_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "carRegNo"'>CAR_REG_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "cmpCarDstinCd"'>CMP_CAR_DSTIN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "usrId"'>USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "usrNm"'>USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "useStartDt"'>USE_START_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "useEndDt"'>USE_END_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "useStartKmVal"'>USE_START_KM_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "useEndKmVal"'>USE_END_KM_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "carlineCd"'>CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "carlineNm"'>CARLINE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "modelCd"'>MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "modelNm"'>MODEL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "ocnCd"'>OCN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "ocnNm"'>OCN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "remark"'>REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "regDt"'>REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <when test='item.field == "regUsrId"'>REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                        <otherwise>
                            VIN_NO DESC
                        </otherwise>
                    </choose>
                </foreach>
            </when>
            <otherwise>
                VIN_NO DESC
            </otherwise>
        </choose>
	</select>



	<!-- 회사차운행관리 목록 갯수  -->
	<select id="selectCmpCarRunMngByConditionCnt" parameterType="CmpCarRunMngSearchVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0211T SA0211
         WHERE 1=1
         <if test='sCmpCarDstinCd != null and sCmpCarDstinCd != ""'>
            AND SA0211.CMP_CAR_DSTIN_CD = #{sCmpCarDstinCd}
         </if>
         <if test='sVinNo != null and sVinNo != ""'>
            AND SA0211.VIN_NO LIKE '%' || #{sVinNo} || '%'
         </if>
         <if test='sCarRegNo != null and sCarRegNo != ""'>
           AND SA0211.CAR_REG_NO = #{sCarRegNo}
         </if>
         <if test='sUseStartDt != null'>
             AND SA0211.USE_START_DT <![CDATA[>=]]> TRUNC(#{sUseStartDt},'DD')
         </if>
         <if test='sUseEndDt != null'>
             AND SA0211.USE_END_DT <![CDATA[<]]> TRUNC(#{sUseEndDt},'DD')+1
         </if>
	</select>



    <!-- 회사차운행관리 내용을 저장.  -->
    <update id="updateCmpCarRunMng" parameterType="CmpCarRunMngVO">
        UPDATE SA_0211T
           SET USR_ID = #{usrId}
             , REMARK = #{remark}
             , UPDT_USR_ID = #{updtUsrId}
             , UPDT_DT = SYSDATE
        WHERE VIN_NO = #{vinNo}
          AND USE_START_DT = #{useStartDt}
    </update>


    <!-- 회사차운행관리 정보를 등록한다. -->
    <insert id="insertCmpCarRunMng" parameterType="CmpCarRunMngVO">
        INSERT INTO SA_0211T(
               VIN_NO
             , USE_START_DT
             , USE_END_DT
             , CAR_REG_NO
             , CARLINE_CD
             , MODEL_CD
             , OCN_CD
             , USR_ID
             , USE_START_KM_VAL
             , USE_END_KM_VAL
             , CMP_CAR_DSTIN_CD
             , REMARK
             , REG_USR_ID
             , REG_DT
        )VALUES(
               #{vinNo}
             , #{useStartDt}
             , #{useEndDt}
             , #{carRegNo}
             , #{carlineCd}
             , #{modelCd}
             , #{ocnCd}
             , #{usrId}
             , #{useStartKmVal}
             , #{useEndKmVal}
             , #{cmpCarDstinCd}
             , #{remark}
             , #{regUsrId}
             , SYSDATE
        )
    </insert>


    <!-- 시작일시 ~ 종료일시를 체크하여 중복차량 체크  -->
    <select id="selectUseDtChkCnt" parameterType="CmpCarRunMngVO" resultType="int">
        SELECT COUNT(*) AS VALUE
          FROM SA_0211T SA0211
         WHERE 1=1
           AND SA0211.VIN_NO = #{vinNo}
           AND (( #{useStartDt} BETWEEN USE_START_DT AND USE_END_DT
                  OR #{useEndDt} BETWEEN USE_START_DT AND USE_END_DT )
                  OR ( USE_START_DT BETWEEN #{useStartDt} AND #{useEndDt}))
    </select>



    <!-- 차량의 이전 종료km 가져오기  -->
    <select id="selectUseKmChkCnt" parameterType="CmpCarRunMngVO" resultType="string">
        SELECT NVL(MAX(USE_END_KM_VAL),0) AS CHK_USE_END_KM
          FROM SA_0211T SA0211
         WHERE 1=1
           AND SA0211.VIN_NO = #{vinNo}
    </select>



    <!-- 회사차운행관리 삭제  -->
    <delete id="deleteCmpCarRunMng" parameterType="CmpCarRunMngVO" >
        DELETE SA_0211T
         WHERE 1=1
           AND VIN_NO = #{vinNo}
           AND USE_START_DT = #{useStartDt}
    </delete>

</mapper>