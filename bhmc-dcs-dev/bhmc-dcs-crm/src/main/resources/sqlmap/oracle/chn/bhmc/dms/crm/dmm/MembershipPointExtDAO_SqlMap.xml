<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : MembershipPointExtDAO_SqlMap.xml
    Description : 멤버십
    author Hyun Ho Kim
    since 2016. 05. 10.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 05. 10.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO">

    <sql id="searchMembershipPointExt">
        <where>
            AND A.DLR_CD = #{sDlrCd}
            <!-- <if test='sPointExtcExpcDt != null'> -->
                <!-- AND     A.POINT_EXTC_EXPC_DT = #{sPointExtcExpcDt} -->
                AND A.POINT_EXTC_EXPC_DT <![CDATA[>=]]> #{sStartDt}
                AND A.POINT_EXTC_EXPC_DT <![CDATA[<=]]> #{sEndDt}
            <!-- </if> -->
        </where>
    </sql>

    <!-- 멤버십 카드 관리 목록수를 조회한다. -->
    <select id="selectMembershipPointExtsByConditionCnt" parameterType="MembershipPointExtSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO.selectMembershipPointExtsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0811T A LEFT OUTER JOIN CR_0801T B
                ON A.DLR_CD = B.DLR_CD
                AND A.MEMBERSHIP_NO = B.MEMBERSHIP_NO
                LEFT OUTER JOIN CR_0101T C
                ON B.DLR_CD = C.DLR_CD
                AND B.CUST_NO = C.CUST_NO
        <include refid="searchMembershipPointExt" />
    </select>

    <!-- 멤버십 카드관리 정보 목록을 조회한다. -->
    <select id="selectMembershipPointExtsByCondition" parameterType="MembershipPointExtSearchVO" resultType="MembershipPointExtVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO.selectMembershipPointExtsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,A.EXTC_SEQ
                            ,A.POINT_EXTC_EXPC_DT
                            ,A.MEMBERSHIP_NO
                            ,A.EXTC_POINT_VAL
                            ,A.RMN_POINT_VAL
                            ,A.SMS_SEND_YN
                            ,A.SMS_SEND_DT
                            ,A.REG_USR_ID
                            ,A.REG_DT
                            ,A.UPDT_USR_ID
                            ,A.UPDT_DT
                            ,B.VIN_NO
                            ,B.REG_DT AS MEMBERSHIP_REG_DT
                            ,C.HP_NO
                            ,C.CUST_NO
                            ,C.CUST_NM
                    FROM    CR_0811T A LEFT OUTER JOIN CR_0801T B
                            ON A.DLR_CD = B.DLR_CD
                            AND A.MEMBERSHIP_NO = B.MEMBERSHIP_NO
                            LEFT OUTER JOIN CR_0101T C
                            ON B.DLR_CD = C.DLR_CD
                            AND B.CUST_NO = C.CUST_NO
                    <include refid="searchMembershipPointExt" />
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "pointExtcExpcDt"'>A.POINT_EXTC_EXPC_DT     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "extcPointVal"'>A.EXTC_POINT_VAL        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "rmnPointVal"'>A.RMN_POINT_VAL    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "smsSendYn"'>A.SMS_SEND_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "smsSendDt"'>A.SMS_SEND_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        A.REG_DT DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.REG_DT DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <select id="selectMembershipPointExtTotalScore" parameterType="MembershipPointExtSearchVO" resultType="MembershipPointExtVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO.selectMembershipPointExtTotalScore] */
         SELECT COUNT(MEMBERSHIP_NO) AS POINT_EXT_USR_CNT
                ,NVL(SUM(EXTC_POINT_VAL),0) AS TOTAL_EXTC_POINT_VAL
                ,NVL(SUM(RMN_POINT_VAL),0) AS TOTAL_RMN_POINT_VAL
         FROM   CR_0811T
         WHERE  DLR_CD = #{sDlrCd}
         <if test='sPointExtcExpcDt != null'>
                <!-- AND     A.POINT_EXTC_EXPC_DT = #{sPointExtcExpcDt} -->
                AND POINT_EXTC_EXPC_DT <![CDATA[>=]]> #{sStartDt}
                AND POINT_EXTC_EXPC_DT <![CDATA[<=]]> #{sEndDt}
            </if>
    </select>

    <update id="updateMembershipPointExtSmsYn" parameterType="MembershipPointExtVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO.updateMembershipPointExtSmsYn] */
        UPDATE  CR_0811T
        SET     SMS_SEND_YN = #{smsSendYn}
                ,SMS_SEND_DT = SYSDATE
                ,UPDT_USR_ID = #{updtUsrId}
                ,UPDT_DT = SYSDATE
        WHERE   DLR_CD = #{dlrCd}
        AND     EXTC_SEQ = #{extcSeq}
    </update>

    <update id="updateMembershipPointExtSmsYnGroup" parameterType="MembershipPointExtVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipPointExtDAO.updateMembershipPointExtSmsYnGroup] */
        UPDATE  CR_0811T
        SET     SMS_SEND_YN = #{smsSendYn}
                ,SMS_SEND_DT = SYSDATE
                ,UPDT_USR_ID = #{updtUsrId}
                ,UPDT_DT = SYSDATE
        WHERE   DLR_CD = #{dlrCd}
        AND     EXTC_SEQ IN  ( SELECT REF_KEY_NM FROM CR_0104T WHERE SEQ = #{smsTmplUserSeq} )
    </update>

</mapper>