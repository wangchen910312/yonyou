<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : BlueMembershipJoinDAO_SqlMap.xml
    Description : 블루멤버십 가입
    author Hyun Ho Kim
    since 2016. 04. 06.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 06.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO">
    <sql id="searchBlueMembership">
        <if test='sCustNo != null and sCustNo != ""'>
            AND A.CUST_NO = #{sCustNo}
        </if>
        <choose>
            <when test='(sStartDt != null and sEndDt == null)'>
                AND     A.JOIN_APPROVE_DT <![CDATA[>=]]> #{sStartDt}
            </when>
            <when test='(sStartDt == null and sEndDt != null)'>
                AND     A.JOIN_APPROVE_DT <![CDATA[<=]]> #{sEndDt}
            </when>
            <otherwise>
                <if test='(sStartDt != null) and (sEndDt != null)'>
                    AND     (A.REG_DT <![CDATA[>=]]> #{sStartDt} AND A.REG_DT <![CDATA[<=]]> #{sEndDt})
                </if>
            </otherwise>
        </choose>
    </sql>

    <!-- 블루멤버십 가입 목록수를 조회한다. -->
    <select id="selectBlueMembershipJoinsByConditionCnt" parameterType="BlueMembershipJoinSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.selectBlueMembershipJoinsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0807T A INNER JOIN CR_0101T B
                ON A.DLR_CD = B.DLR_CD
                AND A.CUST_NO = B.CUST_NO
        WHERE   A.DLR_CD = #{sDlrCd}
        <include refid="searchBlueMembership" />

    </select>

    <!-- 블루멤버십 가입 정보 목록을 조회한다. -->
    <select id="selectBlueMembershipJoinsByCondition" parameterType="BlueMembershipJoinSearchVO" resultType="BlueMembershipJoinVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.selectBlueMembershipJoinsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,A.CUST_NO
                            ,A.CUST_NM
                            ,A.CUST_TP
                            ,A.CAR_OWN_YN
                            ,A.HP_NO
                            ,A.MATH_DOC_TP
                            ,A.SSN_CRN_NO
                            ,A.SUNG_NM
                            ,A.CITY_NM
                            ,A.DIST_NM
                            ,A.ZIP_CD
                            ,A.EXT_ZIP_CD
                            ,A.ADDR_NM
                            ,A.ADDR_DETL_CONT
                            ,A.JOIN_DLR_CD
                            ,A.JOIN_REQ_AGREE_YN
                            ,A.POLICY_AGREE_YN
                            ,A.JOIN_APPROVE_YN
                            ,A.JOIN_APPROVE_DT
                            ,A.REG_USR_ID
                            ,A.REG_DT
                            ,A.UPDT_USR_ID
                            ,A.UPDT_DT
                            ,B.BLUE_MEMBERSHIP_NO
                            ,B.BLUE_MEMBERSHIP_JOIN_DT
                            ,B.BLUE_MEMBERSHIP_JOIN_DLR_CD
                    FROM    CR_0807T A INNER JOIN CR_0101T B
                            ON A.DLR_CD = B.DLR_CD
                            AND A.CUST_NO = B.CUST_NO
                    WHERE   A.DLR_CD = #{sDlrCd}
                    <include refid="searchBlueMembership" />
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "blueMembershipNo"'>B.BLUE_MEMBERSHIP_NO     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "custNm"'>A.CUST_NM        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        A.JOIN_APPROVE_DT DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.JOIN_APPROVE_DT DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <insert id="insertBlueMembershipJoin" parameterType="BlueMembershipJoinVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.insertBlueMembershipJoin] */
        INSERT INTO DMSDB.CR_0807T    --블루멤버쉽가입
            (
            DLR_CD                   --딜러코드
            ,CUST_NO                  --고객번호
            ,CUST_NM                  --고객명
            ,CUST_TP                  --고객유형
            ,CAR_OWN_YN               --차량소유여부
            ,HP_NO                    --휴대폰번호
            ,MATH_DOC_TP              --주요인증문서유형
            ,SSN_CRN_NO               --주민사업자등록번호
            ,SUNG_NM                  --성명
            ,CITY_NM                  --도시명
            ,DIST_NM                  --지역명
            ,ZIP_CD                   --우편번호
            ,EXT_ZIP_CD               --확장우편번호
            ,ADDR_NM                  --주소명
            ,ADDR_DETL_CONT           --주소상세내용
            ,JOIN_DLR_CD              --가입딜러코드
            ,JOIN_REQ_AGREE_YN        --가입요청동의여부
            ,POLICY_AGREE_YN          --정책동의여부
            ,JOIN_APPROVE_YN          --가입승인여부
            ,REG_USR_ID               --등록자ID
            ,REG_DT                   --등록일자
        )VALUES(
            #{dlrCd}                   --딜러코드
            ,#{custNo}                  --고객번호
            ,#{custNm}                  --고객명
            ,#{custTp}                  --고객유형
            ,#{carOwnYn}                --차량소유여부
            ,#{hpNo}                    --휴대폰번호
            ,#{mathDocTp}               --주요인증문서유형
            ,#{ssnCrnNo}                --주민사업자등록번호
            ,#{sungNm}                  --성명
            ,#{cityNm}                  --도시명
            ,#{distNm}                  --지역명
            ,#{zipCd}                   --우편번호
            ,#{extZipCd}                --확장우편번호
            ,#{addrNm}                  --주소명
            ,#{addrDetlCont}            --주소상세내용
            ,#{joinDlrCd}               --가입딜러코드
            ,#{joinReqAgreeYn}          --가입요청동의여부
            ,#{policyAgreeYn}           --정책동의여부
            ,'N'           --가입승인여부
            ,#{regUsrId}                --등록자ID
            ,SYSDATE                   --등록일자
        )
    </insert>

    <select id="selectBlueMembershipJoinByKey" parameterType="BlueMembershipJoinSearchVO" resultType="BlueMembershipJoinVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.selectBlueMembershipJoinByKey] */
        SELECT  DLR_CD
                ,CUST_NO
                ,CUST_NM
                ,CUST_TP
                ,CAR_OWN_YN
                ,HP_NO
                ,MATH_DOC_TP
                ,SSN_CRN_NO
                ,SUNG_NM
                ,CITY_NM
                ,DIST_NM
                ,ZIP_CD
                ,EXT_ZIP_CD
                ,ADDR_NM
                ,ADDR_DETL_CONT
                ,JOIN_DLR_CD
                ,JOIN_REQ_AGREE_YN
                ,POLICY_AGREE_YN
                ,JOIN_APPROVE_YN
                ,JOIN_APPROVE_DT
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
        FROM    CR_0807T
        WHERE   DLR_CD = #{sDlrCd}
        AND     CUST_NO = #{sCustNo}
    </select>

    <update id="updateBlueMembershipApprove" parameterType="BlueMembershipJoinVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.updateBlueMembershipApprove] */
        UPDATE  CR_0807T
        SET     JOIN_APPROVE_YN = #{joinApproveYn}
                ,JOIN_APPROVE_DT = SYSDATE
                ,UPDT_USR_ID = #{updtUsrId}
                ,UPDT_DT = SYSDATE
        WHERE   DLR_CD = #{dlrCd}
        AND     CUST_NO = #{custNo}
    </update>

    <update id="updateBlueMembershipJoinAddr" parameterType="BlueMembershipJoinVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.BlueMembershipJoinDAO.updateBlueMembershipJoinAddr] */
        UPDATE  CR_0807T
        SET     HP_NO = #{hpNo}                      --휴대폰번호
                ,SUNG_NM = #{sungNm}                 --성명
                ,CITY_NM = #{cityNm}                 --도시명
                ,DIST_NM = #{distNm}                 --지역명
                ,ZIP_CD = #{zipCd}                   --우편번호
                ,EXT_ZIP_CD = #{extZipCd}            --확장우편번호
                ,ADDR_NM = #{addrNm}                 --주소명
                ,ADDR_DETL_CONT = #{addrDetlCont}    --주소상세내용
                ,UPDT_USR_ID = #{updtUsrId}
                ,UPDT_DT = SYSDATE
        WHERE   DLR_CD = #{dlrCd}
        AND     CUST_NO = #{custNo}
    </update>

</mapper>