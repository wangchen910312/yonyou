<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : MembershipCardDAO_SqlMap.xml
    Description : 멤버십 카드관리
    author Hyun Ho Kim
    since 2016. 04. 06.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 06.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO">

    <sql id="searchMembershipCard">
        <where>
            AND     DLR_CD = #{sDlrCd}
            <if test='sCardTpCd != null and sCardTpCd != ""'>
                AND     CARD_TP_CD = #{sCardTpCd}
            </if>
            <if test='sCardNo != null and sCardNo != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sCardNo,"*")'>
                        <bind name='sCardNo' value='@org.apache.commons.lang3.StringUtils@replace(sCardNo, "*", "%")' />
                        AND CARD_NO LIKE #{sCardNo}
                    </when>
                    <otherwise>
                        AND     CARD_NO = #{sCardNo}
                    </otherwise>
                </choose>
            </if>
            <choose>
                <when test='(sStartDt != null and sEndDt == null)'>
                    AND     REG_DT <![CDATA[>=]]> #{sStartDt}
                </when>
                <when test='(sStartDt == null and sEndDt != null)'>
                    <!-- AND     TO_CHAR(REG_DT,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sEndDt},'YYYYMMDD') -->
                    AND     REG_DT <![CDATA[<=]]> #{sEndDt}
                </when>
                <otherwise>
                    <if test='(sStartDt != null) and (sEndDt != null)'>
                        AND     (REG_DT <![CDATA[>=]]> #{sStartDt} AND REG_DT <![CDATA[<=]]> #{sEndDt})
                    </if>
                </otherwise>
            </choose>
        </where>
    </sql>

    <sql id="searchMembershipCardPopup">
        AND   T2.DLR_CD = #{sDlrCd}
        <if test='sCardNo != null and sCardNo != ""'>
            AND     T2.CARD_NO = #{sCardNo}
        </if>
        <if test='sCardTpCd != null and sCardTpCd != ""'>
            AND     T2.CARD_TP_CD = #{sCardTpCd}
        </if>
        <choose>
            <when test='(sStartDt != null and sEndDt == null)'>
                AND     T2.REG_DT <![CDATA[>=]]> #{sStartDt}
            </when>
            <when test='(sStartDt == null and sEndDt != null)'>
                <!-- AND     TO_CHAR(REG_DT,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sEndDt},'YYYYMMDD') -->
                AND     T2.REG_DT <![CDATA[<=]]> #{sEndDt}
            </when>
            <otherwise>
                <if test='(sStartDt != null) and (sEndDt != null)'>
                    AND     (T2.REG_DT <![CDATA[>=]]> #{sStartDt} AND T2.REG_DT <![CDATA[<=]]> #{sEndDt})
                </if>
            </otherwise>
        </choose>
    </sql>

    <!-- 멤버십 카드 관리 목록수를 조회한다. -->
    <select id="selectMembershipCardsByConditionCnt" parameterType="MembershipCardSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.selectMembershipCardsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0802T
        <include refid="searchMembershipCard" />
    </select>

    <!-- 멤버십 카드관리 정보 목록을 조회한다. -->
    <select id="selectMembershipCardsByCondition" parameterType="MembershipCardSearchVO" resultType="MembershipCardVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.selectMembershipCardsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT   DLR_CD                --딜러코드
                            ,CARD_TP_CD            --카드종류코드
                            ,CARD_NO               --카드번호
                            ,CARD_USE_DT           --카드사용기한
                            ,CARD_FORM_CD          --카드형태코드
                            ,REG_USR_ID            --등록자ID
                            ,REG_DT                --등록일자
                            ,UPDT_USR_ID           --수정자ID
                            ,UPDT_DT               --수정일자
                    FROM    CR_0802T    --멤버십 가입 카드
                    <include refid="searchMembershipCard" />
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "cardTpCd"'>CARD_TP_CD     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardNo"'>CARD_NO        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardUseDt"'>CARD_USE_DT    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardFormCd"'>CARD_FORM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        REG_DT DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            REG_DT DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>


    <insert id="insertMembershipCard"  parameterType="MembershipCardVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.insertMembershipCard] */
        INSERT INTO CR_0802T    --멤버십 가입 카드
        (
            DLR_CD                --딜러코드
            ,CARD_TP_CD            --카드종류코드
            ,CARD_NO               --카드번호
            ,CARD_USE_DT           --카드사용기한
            ,CARD_FORM_CD          --카드형태코드
            ,REG_USR_ID            --등록자ID
            ,REG_DT                --등록일자
        )
        VALUES
        (
            #{dlrCd}                 --딜러코드
            ,#{cardTpCd}             --카드종류코드
            ,#{cardNo}               --카드번호
            ,#{cardUseDt}            --카드사용기한
            ,#{cardFormCd}           --카드형태코드
            ,#{regUsrId}             --등록자ID
            ,SYSDATE                --등록일자
        )
    </insert>

    <delete id="deleteMembershipCard"  parameterType="MembershipCardVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.deleteMembershipCard] */
        DELETE  CR_0802T
        WHERE   DLR_CD         = #{dlrCd}                --딜러코드
        AND     CARD_TP_CD     = #{cardTpCd}             --일련번호
        AND     CARD_NO        = #{cardNo}               --일련번호
    </delete>

    <update id="updateMembershipCard"  parameterType="MembershipCardVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.updateMembershipCard] */
        UPDATE  CR_0802T    --멤버십 가입 카드
        SET     CARD_USE_DT    = #{cardUseDt}            --카드사용기한
                ,CARD_FORM_CD   = #{cardFormCd}           --카드형태코드
                ,UPDT_USR_ID    = #{updtUsrId}            --수정자ID
                ,UPDT_DT        = SYSDATE               --수정일자
        WHERE   DLR_CD         = #{dlrCd}                --딜러코드
        AND     CARD_TP_CD     = #{cardTpCd}             --일련번호
        AND     CARD_NO        = #{cardNo}               --일련번호
    </update>

    <!-- 카드 정보를 단일건 조회한다. -->
    <select id="selectMembershipCardByKey" parameterType="map" resultType="MembershipCardVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.selectMembershipCardByKey] */
        SELECT  DLR_CD
                ,CARD_TP_CD
                ,CARD_NO
                ,CARD_USE_DT
                ,CARD_FORM_CD
                ,REG_USR_ID
                ,REG_DT
                ,UPDT_USR_ID
                ,UPDT_DT
        FROM    CR_0802T
        WHERE   DLR_CD         = #{dlrCd}                --딜러코드
        AND     CARD_TP_CD     = #{cardTpCd}             --일련번호
        AND     CARD_NO        = #{cardNo}               --일련번호
    </select>

    <!-- 미사용 포인트 카드  목록수를 조회한다. -->
    <select id="selectMembershipCardPopupsByConditionCnt" parameterType="MembershipCardSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.selectMembershipCardPopupsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0802T T2 LEFT OUTER JOIN CR_0813T T3
                ON T2.DLR_CD = T3.DLR_CD
                AND T2.CARD_TP_CD = T3.CARD_TP_CD
                AND T2.CARD_NO = T3.CARD_NO
        WHERE   T3.MEMBERSHIP_NO IS NULL
        <include refid="searchMembershipCardPopup" />
    </select>

    <!-- 미사용 포인트 카드  목록을 조회한다. -->
    <select id="selectMembershipCardPopupsByCondition" parameterType="MembershipCardSearchVO" resultType="MembershipCardVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipCardDAO.selectMembershipCardPopupsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT   T2.DLR_CD
                            ,T2.CARD_TP_CD
                            ,T2.CARD_NO
                            ,T2.CARD_USE_DT
                            ,T2.CARD_FORM_CD
                            ,T2.REG_USR_ID
                            ,T2.REG_DT
                            ,T2.UPDT_USR_ID
                            ,T2.UPDT_DT
                            ,T3.MEMBERSHIP_NO
                    FROM    CR_0802T T2 LEFT OUTER JOIN CR_0813T T3
                            ON T2.DLR_CD = T3.DLR_CD
                            AND T2.CARD_TP_CD = T3.CARD_TP_CD
                            AND T2.CARD_NO = T3.CARD_NO
                    WHERE   T3.MEMBERSHIP_NO IS NULL
                    <include refid="searchMembershipCardPopup" />
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "cardTpCd"'>T2.CARD_TP_CD     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardNo"'>T2.CARD_NO        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardUseDt"'>T2.CARD_USE_DT    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "cardFormCd"'>T2.CARD_FORM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        T2.REG_DT DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            T2.REG_DT DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>


</mapper>