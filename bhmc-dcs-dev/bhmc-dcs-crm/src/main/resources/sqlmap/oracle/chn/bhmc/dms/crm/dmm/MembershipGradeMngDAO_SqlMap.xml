<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : MembershipGradeMngDAO_SqlMap.xml
    Description : 멤버십 카드관리
    author Hyun Ho Kim
    since 2016. 04. 06.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 06.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO">

    <sql id="searchMembershipGradeMng">
        <where>
            AND   DLR_CD = #{sDlrCd}
            <if test='(sGradeSeq != null) and (sGradeSeq != null)'>
                AND GRADE_SEQ = #{sGradeSeq}
            </if>
        </where>
    </sql>

    <!-- 멤버십 카드 관리 목록수를 조회한다. -->
    <select id="selectMembershipGradeMngsByConditionCnt" parameterType="MembershipGradeMngSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.selectMembershipGradeMngsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0805T
        <include refid="searchMembershipGradeMng" />
    </select>

    <!-- 멤버십 카드관리 정보 목록을 조회한다. -->
    <select id="selectMembershipGradeMngsByCondition" parameterType="MembershipGradeMngSearchVO" resultType="MembershipGradeMngVO">
        /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.selectMembershipGradeMngsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  DLR_CD
                            ,GRADE_SEQ
                            ,GRADE_NM
                            ,VSIT_START_CNT
                            ,VSIT_END_CNT
                            ,VSIT_TERM_CD
                            ,PURC_START_CNT
                            ,PURC_END_CNT
                            ,PURC_TERM_CD
                            ,PURC_START_AMT
                            ,PURC_END_AMT
                            ,PURC_TERM_AMT_CD
                            ,RCHG_START_AMT
                            ,RCHG_END_AMT
                            ,ACCU_RATE
                            ,STD_PRID_MONTH
                            ,GRADE_ORDER_NO
                            ,SER_LBR_DC_RATE
                            ,SER_PAR_DC_RATE
                            ,SER_TOT_DC_RATE
                            ,REG_USR_ID
                            ,REG_DT
                            ,UPDT_USR_ID
                            ,UPDT_DT
                    FROM    CR_0805T
                    <include refid="searchMembershipGradeMng" />
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "gradeOrderNo"'>GRADE_ORDER_NO     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "gradeSeq"'>GRADE_SEQ     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "gradeNm"'>GRADE_NM        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "accuRate"'>ACCU_RATE    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        GRADE_ORDER_NO ASC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            GRADE_ORDER_NO ASC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <insert id="insertMembershipGradeMng" parameterType="MembershipGradeMngVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.insertMembershipGradeMng] */
        INSERT INTO CR_0805T
            (
            DLR_CD
            ,GRADE_SEQ
            ,GRADE_NM
            ,VSIT_START_CNT
            ,VSIT_END_CNT
            ,VSIT_TERM_CD
            ,PURC_START_CNT
            ,PURC_END_CNT
            ,PURC_TERM_CD
            ,PURC_START_AMT
            ,PURC_END_AMT
            ,PURC_TERM_AMT_CD
            ,RCHG_START_AMT
            ,RCHG_END_AMT
            ,ACCU_RATE
            ,REG_USR_ID
            ,REG_DT
            ,STD_PRID_MONTH
            ,GRADE_ORDER_NO
            ,SER_LBR_DC_RATE
            ,SER_PAR_DC_RATE
            ,SER_TOT_DC_RATE
        )
        VALUES
        (
            #{dlrCd}
            ,#{gradeSeq}
            ,#{gradeNm}
            ,#{vsitStartCnt}
            ,#{vsitEndCnt}
            ,#{vsitTermCd}
            ,#{purcStartCnt}
            ,#{purcEndCnt}
            ,#{purcTermCd}
            ,#{purcStartAmt}
            ,#{purcEndAmt}
            ,#{purcTermAmtCd}
            ,#{rchgStartAmt}
            ,#{rchgEndAmt}
            ,#{accuRate}
            ,#{regUsrId}
            ,SYSDATE
            ,#{stdPridMonth}
            ,#{gradeOrderNo}
            ,#{serLbrDcRate}
            ,#{serParDcRate}
            ,#{serTotDcRate}
        )
    </insert>

    <update id="updateMembershipGradeMng" parameterType="MembershipGradeMngVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.updateMembershipGradeMng] */
        UPDATE  CR_0805T
        SET     GRADE_SEQ        = #{gradeSeq}
                ,GRADE_NM         = #{gradeNm}
                ,VSIT_START_CNT   = #{vsitStartCnt}
                ,VSIT_END_CNT     = #{vsitEndCnt}
                ,VSIT_TERM_CD     = #{vsitTermCd}
                ,PURC_START_CNT   = #{purcStartCnt}
                ,PURC_END_CNT     = #{purcEndCnt}
                ,PURC_TERM_CD     = #{purcTermCd}
                ,PURC_START_AMT   = #{purcStartAmt}
                ,PURC_END_AMT     = #{purcEndAmt}
                ,PURC_TERM_AMT_CD = #{purcTermAmtCd}
                ,RCHG_START_AMT   = #{rchgStartAmt}
                ,RCHG_END_AMT     = #{rchgEndAmt}
                ,ACCU_RATE        = #{accuRate}
                ,UPDT_USR_ID      = #{updtUsrId}
                ,UPDT_DT          = SYSDATE
                ,STD_PRID_MONTH   = #{stdPridMonth}
                ,GRADE_ORDER_NO   = #{gradeOrderNo}
                ,SER_LBR_DC_RATE  = #{serLbrDcRate}
                ,SER_PAR_DC_RATE  = #{serParDcRate}
                ,SER_TOT_DC_RATE  = #{serTotDcRate}
        WHERE   DLR_CD           = #{dlrCd}
        AND     GRADE_SEQ        = #{gradeSeq}
    </update>

    <update id="updateStdPridMonth" parameterType="MembershipGradeMngVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.updateStdPridMonth] */
        UPDATE  CR_0805T
        SET     STD_PRID_MONTH   = #{stdPridMonth}
        WHERE   DLR_CD           = #{dlrCd}
    </update>

    <delete id="deleteMembershipGradeMng" parameterType="MembershipGradeMngVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.deleteMembershipGradeMng] */
        DELETE  CR_0805T
        WHERE   DLR_CD = #{dlrCd}
        AND GRADE_SEQ = #{gradeSeq}
    </delete>

    <select id="selectStdPridMonthByKey" parameterType="MembershipGradeMngSearchVO" resultType="string">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.selectStdPridMonthByKey] */
        SELECT  STD_PRID_MONTH
        FROM    CR_0805T
        GROUP   BY DLR_CD,STD_PRID_MONTH
        HAVING  DLR_CD = #{sDlrCd}
    </select>

    <select id="selectGradeCodesByCondition" parameterType="MembershipGradeMngSearchVO" resultType="MembershipGradeMngVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.selectGradeCodesByCondition] */
        SELECT  DLR_CD
                ,GRADE_SEQ
                ,GRADE_NM
                ,VSIT_START_CNT
                ,VSIT_END_CNT
                ,VSIT_TERM_CD
                ,PURC_START_CNT
                ,PURC_END_CNT
                ,PURC_TERM_CD
                ,PURC_START_AMT
                ,PURC_END_AMT
                ,PURC_TERM_AMT_CD
                ,RCHG_START_AMT
                ,RCHG_END_AMT
                ,ACCU_RATE
                ,STD_PRID_MONTH
                ,GRADE_ORDER_NO
                ,SER_LBR_DC_RATE
                ,SER_PAR_DC_RATE
                ,SER_TOT_DC_RATE
        FROM    CR_0805T
        WHERE   DLR_CD = #{sDlrCd}
        ORDER BY GRADE_ORDER_NO ASC
    </select>

    <!-- 등급 변경 인원에 대한 조회를 한다. -->
    <select id="callProcedures" statementType="CALLABLE" parameterType="MembershipGradeMngSearchVO">
    /* [chn.bhmc.dms.crm.dmm.service.dao.MembershipGradeMngDAO.callProcedures] */
         {call SP_CRM_MEMBERSHIP_GRADE_CHG (
           #{dlrCd, mode=IN, jdbcType=VARCHAR}
         , #{stdPridMohth, mode=IN, jdbcType=VARCHAR}
         , #{regUsrId, mode=IN, jdbcType=VARCHAR}
         , #{updtUsrId, mode=IN, jdbcType=VARCHAR}
         , #{result, mode=OUT, jdbcType=VARCHAR}
         , #{cnt, mode=OUT, jdbcType=VARCHAR}
         )}
    </select>


</mapper>