<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : VisitCustomerDAO_SqlMap.xml
    Description : 내바 예약에 관한 데이터처리
    author in moon Lee
    since 2016. 01. 18.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 01. 18.     in moon Lee     최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO">

    <!-- 내방 예약 정보를 등록한다. -->
    <insert id="insertVisitCustomer" parameterType="VisitCustomerVO" >
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.insertVisitCustomer] */

        INSERT INTO DMSDB.CR_0206T          --내방정보
        (
              DLR_CD                        --딜러코드
             ,PLT_CD                        --사업장코드
             ,VSIT_NO                       --내방번호
             ,LEAD_NO                       --리드일련번호
             ,DOC_ID                        --첨부문서번호

             ,CUST_NO                       --고객번호
             ,CUST_NM                       --고객명
             ,HP_NO                         --휴대폰번호

             ,VSIT_DT                       --내방일
             ,VSIT_END_DT                   --내방종료일
             ,WITH_PRSN_CNT                 --동행자

             ,VSIT_SRC_CD                   --내방출처코드
             ,VSIT_SRC_DETL_CONT            --내방출처상세내용
             ,VSIT_GOAL_CD                  --내방목적코드
             ,VSIT_STAT_CD                  --내방상태코드

             ,RESV_DT                       --예약일자
             ,CSLT_TM_CD                    --상담시간코드
             ,COMPARE_BRAND_CD              --비교타사브랜드
             ,COMPARE_MODEL_CD              --비교타사모델

             ,SC_ID                         --SCID
             ,REMARK                        --비고
             ,REG_USR_ID                    --등록자ID
             ,REG_DT                        --등록일자
             ,TDRV_YN                       --시승여부

        )VALUES(

             #{dlrCd}                       --딜러코드
             ,#{pltCd}                      --사업장코드
             ,SEQ_CR_0206T.NEXTVAL          --내방정보
             ,#{leadNo}                     --리드일련번호
             ,#{docId}                      --첨부문서번호

             ,#{custNo}                     --고객번호
             ,#{custNm}                     --고객명
             ,#{hpNo}                       --휴대폰번호

             ,#{vsitDt}                     --내방일
             ,#{vsitEndDt}                  --내방종료일
             ,#{withPrsnCnt}                --동행자

             ,#{vsitSrcCd}                  --내방출처코드
             ,#{vsitSrcDetlCont}            --내방출처상세코드
             ,#{vsitGoalCd}                 --내방목적코드
             ,#{vsitStatCd}                 --내방상태코드

             ,#{resvDt}                     --예약일자
             ,#{csltTmCd}                   --상담시간코드
             ,#{compareBrandCd}             --비교타사브랜드
             ,#{compareModelCd}             --비교타사모델

             ,#{scId}                       --SCID
             ,#{remark}                     --비고
             ,#{regUsrId}                   --등록자ID
             ,SYSDATE                       --등록일자
             ,#{tdrvYn}                     --시승여부
        )
        <selectKey resultType="string" keyProperty="vsitNo" order="AFTER">
            SELECT SEQ_CR_0206T.currval AS vsitNo FROM DUAL
        </selectKey>
    </insert>


    <!-- 내방 예약 정보를 수정한다. -->
    <update id="updateVisitCustomer" parameterType="VisitCustomerVO" >
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.updateVisitCustomer] */
        UPDATE DMSDB.CR_0206T    --내방정보
          SET
               UPDT_DT               = SYSDATE                      --수정일자
              ,UPDT_USR_ID           = #{updtUsrId}                 --수정자ID
              ,HP_NO                 = #{hpNo}                      --휴대폰번호

              ,RESV_DT               = #{resvDt}                    --예약일자
              ,CSLT_TM_CD            = #{csltTmCd}                  --상담시간코드
              ,VSIT_SRC_CD           = #{vsitSrcCd}                 --내방출처코드

              ,VSIT_SRC_DETL_CONT    = #{vsitSrcDetlCont}           --내방출처상세코드
              ,WITH_PRSN_CNT         = #{withPrsnCnt}               --동행자수
              ,COMPARE_BRAND_CD      = #{compareBrandCd}            --비교타사브랜드
              ,COMPARE_MODEL_CD      = #{compareModelCd}            --비교타사모델

              ,SC_ID                 = #{scId}                      --SCID
              ,VSIT_STAT_CD          = #{vsitStatCd}                --내방상태코드
              ,REMARK                = #{remark}                    --비고
         WHERE VSIT_NO               = #{vsitNo}                    --내방일련번호
    </update>

    <!-- 내방 예약 정보를 취소한다. -->
    <update id="deleteVisitCustomer" parameterType="VisitCustomerVO" >
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.calcelVisitCustomer] */
        UPDATE DMSDB.CR_0206T    --내방정보
          SET
               VSIT_STAT_CD          = #{vsitStatCd}                --내방상태코드
              ,CANC_REASON_CD        = #{cancReasonCd}              --취소사유코드
              ,CANC_REASON_DETL_CONT = #{cancReasonDetlCont}        --취소사유상세내용
              ,UPDT_USR_ID           = #{updtUsrId}                 --수정자ID
              ,UPDT_DT               = SYSDATE                      --수정일자
         WHERE VSIT_NO               = #{vsitNo}                    --내방일련번호
    </update>


    <!-- 내방 예약 정보 검색조건 -->
    <sql id="searchVisitCustomer">

            <!--    전시장 유동량 관리는 등록된 고객 말고도 일반 방문자를 등록하기 때문에 고객테이블과 조인 안한다.
            INNER JOIN CR_0101T CR0101T ON CR0206T.CUST_NO = CR0101T.CUST_NO AND CR0206T.DLR_CD = CR0101T.DLR_CD AND CR0101T.DEL_YN = 'N'
            -->
            LEFT OUTER JOIN CM_0801T SCT ON CR0206T.SC_ID = SCT.USR_ID
            LEFT OUTER JOIN CM_0801T USRT ON CR0206T.REG_USR_ID = USRT.USR_ID
            LEFT OUTER JOIN CR_0203T CR0203T ON CR0206T.VSIT_NO = CR0203T.REF_KEY_NM AND CR0203T.REF_TABLE_NM = 'CR_0206T' AND CR0203T.FLAG_YN = 'Y'

        <where>

            AND CR0206T.DLR_CD = #{sDlrCd}
            AND CR0206T.PLT_CD = #{sPltCd}

            <!-- 담당 SC 검색 -->
            <if test='sScId != null and sScId != ""'>
                AND CR0206T.SC_ID = #{sScId}
            </if>

            <!-- 전시장 유동량 결과 입력에서 담당고문이 있는경우만 조회 -->
            <if test='sVsitListTp eq "R"'>
                AND CR0206T.SC_ID IS NOT NULL
            </if>

            <if test='sVsitStat == "N"'>
                AND CR0206T.VSIT_STAT_CD != '02'
            </if>

            <!-- 내방상태 -->
            <if test='sVsitStatCd != null and sVsitStatCd != ""'>
                AND CR0206T.VSIT_STAT_CD = #{sVsitStatCd}
            </if>

            <!-- 내방번호 -->
            <if test='sVsitNo != null and sVsitNo != ""'>
                AND CR0206T.VSIT_NO = #{sVsitNo}
            </if>

            <!-- 고객명 검색 -->
            <if test='sCustNm != null and sCustNm != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sCustNm,"*")'>
                        <bind name='sCustNm' value='@org.apache.commons.lang3.StringUtils@replace(sCustNm, "*", "%")' />
                            AND CR0206T.CUST_NM LIKE #{sCustNm}
                    </when>
                    <otherwise>
                        AND CR0206T.CUST_NM LIKE #{sCustNm}
                    </otherwise>
                </choose>
            </if>

            <!-- 휴대전화 검색 TODO [이인문] 휴대전화 like 검색 할것인가??-->
            <if test='sHpNo != null and sHpNo != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sHpNo,"*")'>
                        <bind name='sHpNo' value='@org.apache.commons.lang3.StringUtils@replace(sHpNo, "*", "%")' />
                            AND CR0206T.HP_NO LIKE #{sHpNo}
                    </when>
                    <otherwise>
                        AND CR0206T.HP_NO LIKE #{sHpNo}
                    </otherwise>
                </choose>
            </if>

            <!-- 내방 예약일 검색 -->
            <if test='sStartDt != null and sEndDt != null'>
                <![CDATA[
                    AND (
                            (
                                CR0206T.RESV_DT >= #{sStartDt}
                                AND CR0206T.RESV_DT < #{sEndDt}
                            ) OR (
                                CR0206T.VSIT_DT >= #{sStartDt}
                                AND CR0206T.VSIT_DT < #{sEndDt}
                            ) OR (
                                CR0206T.VSIT_END_DT >= #{sStartDt}
                                AND CR0206T.VSIT_END_DT< #{sEndDt}
                            )
                        )
                ]]>
            </if>

            <!-- 내방일 검색 -->
            <if test='sStartVsitDt != null'>
                <![CDATA[
                    AND CR0206T.VSIT_DT >= #{sStartVsitDt}
                ]]>
            </if>
            <if test='sEndVsitDt != null'>
                <![CDATA[
                    AND CR0206T.VSIT_DT < #{sEndVsitDt}
                ]]>
            </if>

            <!-- 등록일 검색 -->
            <if test='sStartRegDt != null'>
                <![CDATA[
                    AND CR0206T.REG_DT >= #{sStartRegDt}
                ]]>
            </if>
            <if test='sEndRegDt != null'>
                <![CDATA[
                    AND CR0206T.REG_DT < #{sEndRegDt}
                ]]>
            </if>

            <!-- 내방상태 -->
            <if test='sCustNo != null and sCustNo != ""'>
                AND CR0206T.CUST_NO = #{sCustNo}
            </if>

        </where>
    </sql>

    <!-- 내방 예약 정보 목록을 조회한다. -->
    <select id="selectVisitCustomersByCondition" parameterType="VisitCustomerSearchVO" resultType="VisitCustomerVO">
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.selectVisitCustomersByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT
                    CR0206T.VSIT_NO                     --내방일련번호
                   ,CR0206T.CALL_NO                     --콜일련번호
                   ,CR0206T.LEAD_NO                     --리드일련번호
                   ,CR0206T.SALE_OPPT_NO                --사업기회일련번호

                   ,CR0206T.CUST_NO                     --고객번호
                   ,CR0206T.HP_NO                       --휴대폰번호

                   ,DECODE(CR0206T.VSIT_DT, NULL, CR0206T.RESV_DT, CR0206T.VSIT_DT) AS RESV_SCH_START_DT                    -- 예약 시작일 ( 스케줄러 )
                   ,DECODE(CR0206T.VSIT_DT, NULL, CR0206T.RESV_DT+TO_NUMBER(CR0206T.CSLT_TM_CD)/24/60
                   ,DECODE(CR0206T.VSIT_END_DT, NULL, CR0206T.VSIT_DT+30/24/60, CR0206T.VSIT_END_DT)) AS RESV_SCH_END_DT    -- 예약 종료일 ( 스케줄러 )

                   ,CR0206T.VSIT_DT AS VSIT_SCH_START_DT                                                                    -- 내방 시작일 ( 스케줄러 )
                   ,DECODE(CR0206T.VSIT_END_DT, NULL, CR0206T.VSIT_DT+30/24/60, CR0206T.VSIT_END_DT) AS VSIT_SCH_END_DT     -- 내방 종료일 ( 스케줄러 )


                   ,CR0206T.RESV_DT                                                                                         -- 예약 시작일
                   ,CR0206T.VSIT_DT                                                                                         -- 내방 시작일
                   ,CR0206T.VSIT_END_DT                                                                                     -- 내방 종료일

                   ,CR0206T.CSLT_TM_CD                  --상담시간코드
                   ,CR0206T.VSIT_SRC_CD                 --내방출처코드
                   ,CR0206T.VSIT_SRC_DETL_CONT          --내방출처상세코드
                   ,CR0206T.VSIT_STAT_CD                --내방상태
                   ,CR0206T.PURC_PRID_CD                --구매시기
                   ,CR0206T.VSIT_GOAL_CD                --내방목적

                   ,CR0206T.WITH_PRSN_CNT               --동행자수
                   ,CR0206T.COMPARE_BRAND_CD            --비교타사브랜드
                   ,CR0206T.COMPARE_MODEL_CD            --비교타사모델

                   ,CR0203T.CARLINE_CD                                  -- 관심차종
                   ,FN_GET_CARLINE_NM(CR0203T.CARLINE_CD) AS CARLINE_NM -- 관심차종 이름
                   ,CR0203T.MODEL_CD                                    -- 관심모델
                   ,FN_GET_MODEL_NM(CR0203T.MODEL_CD) AS MODEL_NM       -- 관심모델 이름

                   ,CR0206T.SC_ID                       --SCID
                   ,SCT.USR_NM AS SC_NM                 -- SC 이름

                   ,CR0206T.REMARK                      --비고
                   ,CR0206T.CUST_NM                     --고객명

                   ,( SELECT MAX(CR0101T.SEX_CD) FROM CR_0101T CR0101T WHERE CR0206T.CUST_NO = CR0101T.CUST_NO ) AS SEX_CD      --성별
                   ,( SELECT MAX(CR0101T.CUST_CD) FROM CR_0101T CR0101T WHERE CR0206T.CUST_NO = CR0101T.CUST_NO ) AS CUST_CD    --잠재/보유고객

                    ,NVL2(
                      (
                        SELECT
                          MAX(CR0201T.REG_DT)
                        FROM CR_0201T CR0201T
                        WHERE 1=1
                        AND CR0201T.SALE_OPPT_STEP_CD != '06' AND CR0201T.SALE_OPPT_STEP_CD != '05'   -- 진행중
                        AND CR0206T.CUST_NO = CR0201T.CUST_NO
                        AND CR0206T.VSIT_DT >= CR0201T.REG_DT                                   -- 판매기회 등록 이후, 판매기회상태가 진행중인 상태에 방문한경우 재방문으로 인식한다.
                      ) ,'Y','N'
                    ) AS RE_VSIT_YN

                    ,NVL2(
                        (
                            SELECT
                                MAX(CR0201T.CUST_NO)
                            FROM CR_0201T CR0201T
                            WHERE CR0206T.CUST_NO = CR0201T.CUST_NO
                            -- AND CR0201T.SALE_OPPT_STEP_CD != '06' AND CR0201T.SALE_OPPT_STEP_CD != '05'
                        ) ,'Y','N'
                    ) AS SALE_OPPT_YN        -- 기회여부 -> 판매기회단계 상태 : 진행중 (실패/성공이 아닌것)
                    ,
                      (
                        SELECT
                          MAX(CR0201T.SALE_OPPT_STEP_CD)
                        FROM CR_0201T CR0201T
                        WHERE 1=1
                        AND CR0206T.CUST_NO = CR0201T.CUST_NO
                    ) AS SALE_OPPT_STEP_CD              -- 판매기회 단계

                   ,CR0206T.DOC_ID                      --문서ID
                   ,CR0206T.RESV_VIN_NO1                --예약차대번호1
                   ,CR0206T.RESV_VIN_NO2                --예약차대번호2
                   ,CR0206T.REG_USR_ID                  --등록자ID
                   ,USRT.USR_NM AS REG_USR_NM           --등록자이름
                   ,CR0206T.REG_DT                      --등록일자
                   ,CR0206T.TDRV_YN                     --시승여부
                   ,NVL2(CR0206T.VSIT_DT, 1,2) AS vsitDtOrder               -- 정렬조건을 위한 임시값
                   ,NVL2(CR0206T.VSIT_END_DT, 1,2) AS vsitEndDtOrder        -- 정렬조건을 위한 임시값
                   ,NVL2(CR0206T.RESV_DT, 1,2) AS resvStartDtOrder          -- 정렬조건을 위한 임시값
                FROM CR_0206T CR0206T
                <include refid="searchVisitCustomer" />
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "vsitResult"'>
                                      vsitEndDtOrder DESC
                                    , CR0206T.VSIT_END_DT DESC
                                    , vsitDtOrder ASC
                                    , CR0206T.VSIT_DT DESC
                                    , CR0206T.VSIT_NO DESC
                                </when>
                                <when test='item.field == "vsitMgmt"'>
                                    resvStartDtOrder asc
                                    , resv_Dt desc
                                </when>
                                <when test='item.field == "vsitDt"'>            CR0206T.VSIT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "vsitEndDt"'>         CR0206T.VSIT_END_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "custNm"'>            CR0206T.CUST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "sexcd"'>             CR0101T.SEX_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "custCd"'>            CR0101T.CUST_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "hpNo"'>              CR0206T.HP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                <when test='item.field == "vsitSrcCd"'>         CR0206T.VSIT_SRC_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "vsitGoalCd"'>        CR0206T.VSIT_GOAL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "carlineNm"'>         CR0203T.CARLINE_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "modelNm"'>           CR0203T.MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "compareBrandCd"'>    CR0206T.COMPARE_BRAND_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "compareModelCd"'>    CR0206T.COMPARE_MODEL_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "scId"'>              CR0206T.SC_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                <when test='item.field == "saleOpptYn"'>        SALE_OPPT_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "saleOpptStepCd"'>    SALE_OPPT_STEP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "regDt"'>             CR0206T.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>

                                <when test='item.field == "dlrCd"'>             CR0206T.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "pltCd"'>             CR0206T.PLT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "vsitNo"'>            CR0206T.VSIT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "callNo"'>            CR0206T.CALL_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "leadNo"'>            CR0206T.LEAD_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "saleOpptNo"'>        CR0206T.SALE_OPPT_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "resvDt"'>            CR0206T.RESV_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "csltTmCd"'>          CR0206T.CSLT_TM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "vsitSrcDetlCont"'>   CR0206T.VSIT_SRC_DETL_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "purcPridCd"'>        CR0206T.PURC_PRID_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "remark"'>            CR0206T.REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "withPrsnCnt"'>       CR0206T.WITH_PRSN_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "vsitStatCd"'>        CR0206T.VSIT_STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "docId"'>             CR0206T.DOC_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "resvVinNo1"'>        CR0206T.RESV_VIN_NO1 <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "resvVinNo2"'>        CR0206T.RESV_VIN_NO2 <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "regUsrId"'>          CR0206T.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "updtUsrId"'>         CR0206T.UPDT_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "updtDt"'>            CR0206T.UPDT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <otherwise>
                                    CR0206T.VSIT_NO DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                          CR0206T.VSIT_NO DESC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 내방 예약 정보 목록수를 조회한다. -->
    <select id="selectVisitCustomersByConditionCnt" parameterType="VisitCustomerSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.selectVisitCustomersByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CR_0206T CR0206T
        <include refid="searchVisitCustomer" />
    </select>


    <!-- 전시장 유동량 관리 / 결과 정보 수정한다. -->
    <update id="updateVisitCustomerMgmt" parameterType="VisitCustomerVO" >
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.updateVisitCustomerMgmt] */
        UPDATE DMSDB.CR_0206T    --내방정보
          SET
               UPDT_DT              = SYSDATE                   --수정일자
              ,UPDT_USR_ID          = #{updtUsrId}              --수정자ID
              ,LEAD_NO              = #{leadNo}                 --리드번호
              ,DOC_ID               = #{docId}                  --리드번호
              ,HP_NO                = #{hpNo}                   --휴대폰번호
              ,CUST_NM              = #{custNm}                 --고객명
              ,VSIT_DT              = #{vsitDt}                 --내방일자
              ,VSIT_END_DT          = #{vsitEndDt}              --내방종료일
              ,WITH_PRSN_CNT        = #{withPrsnCnt}            --동행자수
              ,VSIT_SRC_CD          = #{vsitSrcCd}              --내방출처코드
              ,VSIT_SRC_DETL_CONT   = #{vsitSrcDetlCont}        --내방출처상세코드
              ,VSIT_GOAL_CD         = #{vsitGoalCd}             --내방목적코드
              ,VSIT_STAT_CD         = #{vsitStatCd}             --내방상태코드

              ,RESV_DT              = #{resvDt}                 --예약일자
              ,COMPARE_BRAND_CD     = #{compareBrandCd}         --비교타사브랜드
              ,COMPARE_MODEL_CD     = #{compareModelCd}         --비교타사모델

              ,SC_ID                = #{scId}                   --SCID
              ,REMARK               = #{remark}                 --비고
              ,TDRV_YN                = #{tdrvYn}               --시승여부
         WHERE VSIT_NO              = #{vsitNo}                 --내방일련번호
    </update>

    <!-- 내방 예약 상세 정보를 조회한다. -->
    <select id="selectVisitCustomerMgmtByKey" parameterType="VisitCustomerSearchVO" resultType="VisitCustomerVO">
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.selectVisitCustomerMgmtByKey] */
        SELECT
            CR0206T.VSIT_NO                     --내방일련번호
           ,CR0206T.CALL_NO                     --콜일련번호
           ,CR0206T.LEAD_NO                     --리드일련번호
           ,CR0206T.SALE_OPPT_NO                --사업기회일련번호
           ,CR0206T.DOC_ID                      --첨부문서번호

           ,CR0206T.CUST_NO                     --고객번호
           ,CR0206T.CUST_NM                     --고객명
           ,CR0206T.HP_NO                       --휴대폰번호

           ,CR0206T.RESV_DT                                                             -- 예약 시작일
           ,DECODE(VSIT_DT,NULL, CR0206T.RESV_DT+TO_NUMBER(CSLT_TM_CD)/24/60
           ,DECODE(VSIT_END_DT, NULL, VSIT_DT+30/24/60, VSIT_END_DT)) AS RESV_END_DT    -- 예약 종료일
           ,CR0206T.VSIT_DT                                                             -- 내방 시작일
           ,CR0206T.VSIT_END_DT                                                         -- 내방 종료일


           ,CR0206T.WITH_PRSN_CNT               --동행자수

           ,CR0206T.VSIT_SRC_CD                 --내방출처코드
           ,CR0206T.VSIT_SRC_DETL_CONT          --내방출처상세코드
           ,CR0206T.VSIT_GOAL_CD                --내방목적코드
           ,CR0206T.VSIT_STAT_CD                --내방상태코드

           ,CR0206T.CSLT_TM_CD                  --상담시간코드
           ,CR0206T.COMPARE_BRAND_CD            --비교타사브랜드
           ,CR0206T.COMPARE_MODEL_CD            --비교타사모델

           ,CR0206T.SC_ID                       --SCID
           ,SCT.USR_NM AS SC_NM                 --SCNM

           ,CR0206T.REMARK                      --비고
           ,CR0206T.REG_USR_ID                  --등록자ID
           ,USRT.USR_NM AS REG_USR_NM           --등록자이름
           ,CR0206T.REG_DT                      --등록일자
           ,CR0206T.TDRV_YN                     --시승여부

           ,( SELECT MAX(CR0101T.SEX_CD) FROM CR_0101T CR0101T WHERE CR0206T.CUST_NO = CR0101T.CUST_NO ) AS SEX_CD      --성별
           ,( SELECT MAX(CR0101T.CUST_CD) FROM CR_0101T CR0101T WHERE CR0206T.CUST_NO = CR0101T.CUST_NO ) AS CUST_CD    --잠재/보유고객

           ,CR0203T.CARLINE_CD                                  -- 관심차종
           ,FN_GET_CARLINE_NM(CR0203T.CARLINE_CD) AS CARLINE_NM -- 관심차종 이름
           ,CR0203T.MODEL_CD                                    -- 관심모델
           ,FN_GET_MODEL_NM(CR0203T.MODEL_CD) AS MODEL_NM       -- 관심모델 이름

            ,NVL2(
              (
                SELECT
                  MAX(CR0201T.REG_DT)
                FROM CR_0201T CR0201T
                WHERE 1=1
                AND CR0201T.SALE_OPPT_STEP_CD != '06' AND CR0201T.SALE_OPPT_STEP_CD != '05'   -- 진행중
                AND CR0206T.CUST_NO = CR0201T.CUST_NO
                AND CR0206T.VSIT_DT >= CR0201T.REG_DT                                   -- 판매기회 등록 이후, 판매기회상태가 진행중인 상태에 방문한경우 재방문으로 인식한다.
              ) ,'Y','N'
            ) AS RE_VSIT_YN

            ,NVL2(
              (
                SELECT
                  MAX(CR0201T.CUST_NO)
                FROM CR_0201T CR0201T
                WHERE 1=1
                AND CR0206T.CUST_NO = CR0201T.CUST_NO
              ) ,'Y','N'
            ) AS SALE_OPPT_YN                   -- 판매기회 여부

            ,
              (
                SELECT
                  MAX(CR0201T.SALE_OPPT_STEP_CD)
                FROM CR_0201T CR0201T
                WHERE 1=1
                AND CR0206T.CUST_NO = CR0201T.CUST_NO
            ) AS SALE_OPPT_STEP_CD              -- 판매기회 단계



        FROM CR_0206T CR0206T
        <!--    전시장 유동량 관리는 등록된 고객 말고도 일반 방문자를 등록하기 때문에 고객테이블과 조인 안한다.
        INNER JOIN CR_0101T CR0101T ON CR0206T.CUST_NO = CR0101T.CUST_NO AND CR0206T.DLR_CD = CR0101T.DLR_CD AND CR0101T.DEL_YN = 'N'
         -->
        LEFT OUTER JOIN CM_0801T SCT ON CR0206T.SC_ID = SCT.USR_ID
        LEFT OUTER JOIN CM_0801T USRT ON CR0206T.REG_USR_ID = USRT.USR_ID
        LEFT OUTER JOIN CR_0203T CR0203T ON CR0206T.VSIT_NO = CR0203T.REF_KEY_NM AND CR0203T.REF_TABLE_NM = 'CR_0206T' AND CR0203T.FLAG_YN = 'Y'
        WHERE CR0206T.PLT_CD = #{sPltCd}
        AND CR0206T.DLR_CD = #{sDlrCd}
        AND CR0206T.VSIT_NO = #{sVsitNo}

    </select>


    <!-- 내방 정보 수정 ( 고객번호 생성후 수정 ) -->
    <update id="updateCustNo" parameterType="VisitCustomerVO" >
        /* [chn.bhmc.dms.crm.cfw.service.dao.VisitCustomerDAO.updateCustNo] */
        UPDATE DMSDB.CR_0206T    --내방정보
          SET
               UPDT_DT          =       SYSDATE             --수정일자
              ,UPDT_USR_ID      =       #{updtUsrId}        --수정자ID
              ,CUST_NO          =       #{custNo}           --휴대폰번호
         WHERE VSIT_NO          =       #{vsitNo}           --내방일련번호
         AND PLT_CD             =       #{pltCd}            --
         AND DLR_CD             =       #{dlrCd}            --
    </update>


</mapper>