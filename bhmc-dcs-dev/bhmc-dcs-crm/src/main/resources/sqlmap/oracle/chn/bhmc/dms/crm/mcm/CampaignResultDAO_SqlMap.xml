<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : CampaignResultDAO_SqlMap.xml
    Description : 캠페인결과에 관한 데이터처리
    author hyoung jun an
    since 2016. 03. 04.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016.03.04     hyoung jun an    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO">

    <sql id="searchCampaignResult">

        INNER JOIN (SELECT DLR_CD,
                         MAK_CD,
                         MAX(TEL_CSLT_CNT)    AS TEL_CSLT_CNT,
                         MAX(VISIT_CNT)       AS VISIT_CNT,
                         MAX(RECORD_SAVE_CNT) AS RECORD_SAVE_CNT,
                         MAX(SALES_OPPT_CNT)  AS SALES_OPPT_CNT,
                         MAX(VEN_CNT)         AS VEN_CNT,
                         MAX(VEN_AMT)         AS VEN_AMT,
                         MAX(SMS_SUCCESS_CNT) AS SMS_SUCCESS_CNT,
                         MAX(VISIT_RESV_CNT)  AS VISIT_RESV_CNT,
                         MAX(SER_COMP_CNT)    AS SER_COMP_CNT
                    FROM (
                          SELECT DLR_CD,
                                 MAK_CD,
                                 DECODE(TARG_CD,'01',TARG_RSLT_VAL,NULL) AS TEL_CSLT_CNT,
                                 DECODE(TARG_CD,'02',TARG_RSLT_VAL,NULL) AS VISIT_CNT,
                                 DECODE(TARG_CD,'03',TARG_RSLT_VAL,NULL) AS RECORD_SAVE_CNT,
                                 DECODE(TARG_CD,'04',TARG_RSLT_VAL,NULL) AS SALES_OPPT_CNT,
                                 DECODE(TARG_CD,'05',TARG_RSLT_VAL,NULL) AS VEN_CNT,
                                 DECODE(TARG_CD,'06',TARG_RSLT_VAL,NULL) AS VEN_AMT,
                                 DECODE(TARG_CD,'08',TARG_RSLT_VAL,NULL) AS SMS_SUCCESS_CNT,
                                 DECODE(TARG_CD,'09',TARG_RSLT_VAL,NULL) AS VISIT_RESV_CNT,
                                 DECODE(TARG_CD,'10',TARG_RSLT_VAL,NULL) AS SER_COMP_CNT
                            FROM CR_1111T
                           WHERE TARG_CD IS NOT NULL
                         )
                   GROUP BY DLR_CD, MAK_CD
                 ) CR_1111T
                 ON CR_1101T.DLR_CD = CR_1111T.DLR_CD AND CR_1101T.MAK_CD = CR_1111T.MAK_CD
        LEFT OUTER JOIN CM_0304T HOST_NM ON HOST_NM.CMM_GRP_CD = 'CRM708' AND HOST_NM.LANG_CD = #{langCd} AND HOST_NM.CMM_CD = CR_1101T.HOST_CD
        LEFT OUTER JOIN CM_0304T MAK_TP_NM ON MAK_TP_NM.CMM_GRP_CD = 'CRM702' AND MAK_TP_NM.LANG_CD = #{langCd} AND MAK_TP_NM.CMM_CD = CR_1101T.MAK_TP_CD
        LEFT OUTER JOIN (SELECT B.CMM_GRP_CD, B.CMM_CD, B.CMM_CD_TXT, B.LANG_CD, A.REMARK1
                         FROM CM_0303T A
                              INNER JOIN CM_0304T B ON A.CMM_GRP_CD = B.CMM_GRP_CD AND A.CMM_CD = B.CMM_CD
                      ) MAK_TP_SUB_TP_NM ON MAK_TP_SUB_TP_NM.CMM_GRP_CD IN ('CRM703','CRM704','CRM705')
                                        AND MAK_TP_SUB_TP_NM.LANG_CD = #{langCd}
                                        AND MAK_TP_SUB_TP_NM.CMM_CD = CR_1101T.MAK_SUB_TP_CD
                                        AND MAK_TP_SUB_TP_NM.REMARK1 = CR_1101T.MAK_TP_CD
        LEFT OUTER JOIN CM_0304T STAT_NM ON STAT_NM.CMM_GRP_CD = 'CRM701' AND STAT_NM.LANG_CD = #{langCd} AND STAT_NM.CMM_CD = CR_1101T.STAT_CD

        <where>
            AND CR_1101T.DEL_YN = 'N'

            AND CR_1101T.DLR_CD = #{sDlrCd}

            <if test='sMakNm != null and sMakNm != ""'>
                AND CR_1101T.MAK_NM LIKE '%' || #{sMakNm} || '%'
            </if>

            <if test='sMakCd != null and sMakCd != ""'>
                AND CR_1101T.MAK_CD LIKE '%' || #{sMakCd} || '%'
            </if>

            <if test='sHostCd != null and sHostCd != ""'>
                AND CR_1101T.HOST_CD = #{sHostCd}
            </if>

            <if test='sHostTeamCd != null and sHostTeamCd != ""'>
                AND CR_1101T.HOST_TEAM_CD = #{sHostTeamCd}
            </if>

            <if test='sMakTpCd != null and sMakTpCd != ""'>
                AND CR_1101T.MAK_TP_CD = #{sMakTpCd}
            </if>

            <if test='sMakSubTpCd != null and sMakSubTpCd != ""'>
                AND CR_1101T.MAK_SUB_TP_CD = #{sMakSubTpCd}
            </if>

            <if test='sStatCd != null and sStatCd != ""'>
                AND CR_1101T.STAT_CD = #{sStatCd}
            </if>

            <if test='sStartDt != null and sEndDt != null'>
                AND CR_1101T.END_DT <![CDATA[>=]]> #{sStartDt}
                AND CR_1101T.START_DT <![CDATA[<=]]> #{sEndDt}
            </if>
        </where>

    </sql>

    <!-- 캠페인결과 정보 목록수를 조회한다. -->
    <select id="selectCampaignResultsByConditionCnt" parameterType="CampaignResultSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.mcm.service.dao.MarketingCampaignDAO.selectCampaignResultsByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CR_1101T CR_1101T
        <include refid="searchCampaignResult" />
    </select>

    <!-- 캠페인결과 정보 목록을 조회한다. -->
    <select id="selectCampaignResultsByCondition" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.selectCampaignResultsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
              SELECT F.*
                    ,(SELECT CMM_CD_TXT FROM CM_0304T WHERE CMM_GRP_CD = 'CRM701' AND LANG_CD = #{langCd} AND CMM_CD = F.STAT_CD) AS STAT_NM
                  FROM (
                SELECT
                      CR_1101T.DLR_CD                    --딜러코드
                     ,CR_1101T.MAK_CD                    --마케팅코드
                     ,CR_1101T.MAK_NM                    --마케팅명
                     ,CR_1101T.HOST_CD                   --주최코드
                     ,HOST_NM.CMM_CD_TXT AS HOST_NM      --주최명
                     ,CR_1101T.HOST_TEAM_CD              --주최팀코드
                     ,CR_1101T.MAK_TP_CD                 --마케팅유형코드
                     ,CR_1101T.MAK_SUB_TP_CD             --마케팅서브유형코드
                     ,MAK_TP_NM.CMM_CD_TXT || '/' || MAK_TP_SUB_TP_NM.CMM_CD_TXT AS MAK_TP_SUB_TP_NM --마케팅유형/마케팅서브유형명
                     ,CR_1101T.RCPE_NM                   --대상자명
                     ,CR_1101T.START_DT                  --시작일자
                     ,CR_1101T.END_DT                    --종료일자
                     ,CR_1101T.PRID                      --기간
                     ,CR_1101T.PLACE_NM                  --장소명
                     ,CR_1101T.RCPE_AUTO_YN              --대상자자동추출여부
                     ,CR_1101T.AAP_CMP_NM                --대행업체명
                     ,CR_1101T.BUDGET_AMT                --예산금액
                     ,(CASE WHEN CR_1101T.END_DT <![CDATA[<]]> SYSDATE THEN '06' ELSE CR_1101T.STAT_CD END) AS STAT_CD    --상태코드
                     ,CR_1101T.TARG_CUST_CNT             --목표고객수
                     ,CR_1101T.PGSS_RATE                 --진도율
                     ,CR_1101T.ACTIVE_NM                 --활동명
                     ,CR_1101T.ACTIVE_CONT               --활동내용
                     ,CR_1101T.ACTIVE_FILE_DOC_NO        --활동첨부문서번호[CM_0901T]
                     ,CR_1101T.AD_INVT_HM                --광고투자시간
                     ,CR_1101T.AD_MEDIA_CD               --광고매체코드
                     ,CR_1101T.AD_COST_AMT               --광고비용금액
                     ,CR_1101T.AD_START_DT               --광고시작일자
                     ,CR_1101T.AD_END_DT                 --광고종료일자
                     ,CR_1101T.APPR_DOC_NO               --결재문서번호[CM_1001T]
                     ,CR_1101T.DEL_YN                    --삭제여부
                     ,CR_1101T.TALK_PLAN                 --화술방안
                     ,NVL(CR_1101T.ACT_TOT_AMT, 0) AS ACT_TOT_AMT
                     ,(SELECT USR_NM FROM CM_0801T WHERE USR_ID = CR_1101T.REG_USR_ID) AS REG_USR_ID --등록자ID
                     ,CR_1101T.REG_DT                    --등록일자
                     ,CR_1101T.UPDT_USR_ID               --수정자ID
                     ,CR_1101T.UPDT_DT                   --수정일자
                     ,CR_1111T.TEL_CSLT_CNT
                     ,CR_1111T.VISIT_CNT
                     ,CR_1111T.RECORD_SAVE_CNT
                     ,CR_1111T.SALES_OPPT_CNT
                     ,CR_1111T.VEN_CNT
                     ,CR_1111T.VEN_AMT
                     ,CR_1111T.VISIT_RESV_CNT
                     ,CR_1111T.SMS_SUCCESS_CNT
                     ,CR_1111T.SER_COMP_CNT
                FROM CR_1101T CR_1101T
                <include refid="searchCampaignResult" />
               ) F
               ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "makCd"'>             F.MAK_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "makNm"'>             F.MAK_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "regDtFormat"'>       F.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "hostCd"'>            F.HOST_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "hostNm"'>            F.HOST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "hostTeamCd"'>        F.HOST_TEAM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "makTpCd"'>           F.MAK_TP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "makSubTpCd"'>        F.MAK_SUB_TP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "makTpSubTpNm"'>      F.MAK_TP_SUB_TP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "rcpeNm"'>            F.RCPE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "startDtFormat"'>     F.START_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "endDtFormat"'>       F.END_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "prid"'>              F.PRID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>              </when>
                                <when test='item.field == "placeNm"'>           F.PLACE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "aapCmpNm"'>          F.AAP_CMP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "budgetAmt"'>         F.BUDGET_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "statCd"'>            F.STAT_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "statNm"'>            F.STAT_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "targCustCnt"'>       F.TARG_CUST_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "pgssRate"'>          F.PGSS_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "activeNm"'>          F.ACTIVE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "activeCont"'>        F.ACTIVE_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "activeFileDocNo"'>   F.ACTIVE_FILE_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "adInvtHm"'>          F.AD_INVT_HM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "adMediaCd"'>         F.AD_MEDIA_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "adCostAmt"'>         F.AD_COST_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "adStartDt"'>         F.AD_START_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "adEndDt"'>           F.AD_END_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "apprDocNo"'>         F.APPR_DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "delYn"'>             F.DEL_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "telCsltCnt"'>        F.TEL_CSLT_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "visitCnt"'>          F.VISIT_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "recordSaveCnt"'>     F.RECORD_SAVE_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                <when test='item.field == "salesOpptCnt"'>      F.SALES_OPPT_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <when test='item.field == "venCnt"'>            F.VEN_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "venAmt"'>            F.VEN_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "visitResvCnt"'>      F.VISIT_RESV_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <when test='item.field == "regUsrId"'>          F.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "actTotAmt"'>         F.ACT_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <otherwise>
                                    F.REG_DT DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        F.REG_DT DESC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 캠페인결과(목표) 정보 목록을 조회한다. -->
    <select id="selectGoalResultsByCondition" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.selectGoalResultsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT
                       CR_1111T.DLR_CD               --딜러코드
                      ,CR_1111T.MAK_CD               --마케팅코드
                      ,CR_1111T.SEQ                  --일련번호
                      ,CR_1111T.TARG_CD              --목표코드
                      ,CR_1111T.TARG_NM              --목표명
                      ,CR_1111T.TARG_CNT_VAL         --목표수치값
                      ,CR_1111T.TARG_RSLT_VAL        --목표결과값
                      ,CR_1111T.REG_USR_ID           --등록자ID
                      ,CR_1111T.REG_DT               --등록일자
                      ,CR_1111T.UPDT_USR_ID          --수정자ID
                      ,CR_1111T.UPDT_DT              --수정일자
                 FROM CR_1111T CR_1111T    --마케팅캠페인목표
                <where>
                    AND CR_1111T.DLR_CD = #{sDlrCd}    --딜러코드
                    AND CR_1111T.MAK_CD = #{sMakCd}
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "dlrCd"'>        CR_1111T.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "makCd"'>        CR_1111T.MAK_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "seq"'>          CR_1111T.SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "targCd"'>       CR_1111T.TARG_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "targNm"'>       CR_1111T.TARG_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <when test='item.field == "targCntVal"'>   CR_1111T.TARG_CNT_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                <when test='item.field == "targRsltVal"'>  CR_1111T.TARG_RSLT_VAL <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regUsrId"'>     CR_1111T.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>   </when>
                                <when test='item.field == "regDt"'>        CR_1111T.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "updtUsrId"'>    CR_1111T.UPDT_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "updtDt"'>       CR_1111T.UPDT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                                <otherwise>
                                     CR_1111T.TARG_CNT_VAL DESC
                                    ,CR_1111T.SEQ ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                         CR_1111T.TARG_CNT_VAL DESC
                        ,CR_1111T.SEQ ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM <![CDATA[>]]> #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 캠페인결과(목표) 정보 목록수를 조회한다. -->
    <select id="selectGoalResultsByConditionCnt" parameterType="CampaignResultSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.selectGoalResultsByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CR_1111T CR_1111T                      --마케팅캠페인목표
        <where>
            AND CR_1111T.DLR_CD = #{sDlrCd}               --딜러코드
            AND CR_1111T.MAK_CD = #{sMakCd}
        </where>
    </select>

    <!-- 캠페인결과(목표) 정보를 수정한다. -->
    <update id="updateGoalResult" parameterType="CampaignResultVO" >
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.updateGoalResult] */
        UPDATE CR_1111T                   --마케팅캠페인목표
           SET
               TARG_RSLT_VAL = #{targRsltVal}         --목표결과값
              ,UPDT_USR_ID   = #{updtUsrId}           --수정자ID
              ,UPDT_DT       = SYSDATE                --수정일자
         WHERE 1 = 1
           AND DLR_CD        = #{dlrCd}               --딜러코드
           AND MAK_CD        = #{makCd}               --마케팅코드
           AND SEQ           = #{seq}                 --일련번호
    </update>





    <!-- Key에 해당하는 설문조사 key 정보를 조회한다. -->
    <select id="selectSurveyByKey" parameterType="map" resultType="CampaignResultVO">
        SELECT  DLR_CD
                ,SEQ
                ,SUBY_TMPL_SEQ
        FROM    CR_0901T
        WHERE   SEQ = ${sSeq}
        AND     DLR_CD = #{sDlrCd}
    </select>

    <!-- 설문 키에 해당하는 마케팅캠페인코드 정보를 조회한다. -->
    <select id="selectSurveyMakCdByKey" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        SELECT T2.MAK_CD, T1.STSF_IVST_SEQ, T1.SUBY_TMPL_SEQ
          FROM CR_0905T T1 INNER JOIN CR_1112T T2
            ON T1.DLR_CD = T2.DLR_CD
           AND T1.STSF_IVST_RSLT_SEQ = T2.STSF_IVST_RSLT_SEQ
           AND T1.EMP_ID = T2.EMP_ID
           AND T2.IVST_TP = #{sIvstTp}
           AND T2.DLR_CD = #{sDlrCd}
           AND T2.MAK_CD = #{sMakCd}
           AND T2.EMP_ID = #{sEmpId}
    </select>

    <!-- 설문 키에 해당하는 설문 질문 정보를 조회한다. -->
    <select id="selectSurveyQuestionByCondition" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        SELECT  A.DLR_CD
                ,A.SUBY_TMPL_SEQ
                ,B.SUBY_TMPL_QEST_SEQ
                ,A.SUBY_TMPL_NM
                ,B.QEST_CONT
                ,B.QEST_WGT_VAL
                ,B.QEST_TP_CD
                ,B.ANSW_SEL_CNT
        FROM    CR_0902T A LEFT OUTER JOIN CR_0903T B
                ON A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                AND A.DLR_CD = B.DLR_CD
        WHERE   A.SUBY_TMPL_SEQ  = #{sSubyTmplSeq}
        AND     A.DLR_CD = #{sDlrCd}              --딜러코드
        ORDER BY B.SORT_ORDER, B.SUBY_TMPL_QEST_SEQ ASC
    </select>

    <!-- 설문 키에 해당하는 설문 답변 정보를 조회한다. -->
    <select id="selectSurveyAnswerByCondition" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        SELECT  A.DLR_CD
                ,A.SUBY_TMPL_SEQ
                ,B.SUBY_TMPL_QEST_SEQ
                ,C.ITEM_SEQ
                ,ROW_NUMBER()OVER (PARTITION BY B.SUBY_TMPL_QEST_SEQ ORDER BY B.SORT_ORDER, C.SORT_ORDER) AS QEST_NUM
                ,C.ANSW_CONT
                ,C.ANSW_SCORE_VAL
                ,D.ANSW_SEQ
                ,D.SBJV_ANSW_CONT
                ,D.CMPL_REASON_CONT
                ,D.STSF_IVST_YN
        FROM    CR_0902T A LEFT OUTER JOIN (SELECT * FROM CR_0903T WHERE QEST_TP_CD != '03') B
                ON A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                AND A.DLR_CD = B.DLR_CD
                LEFT OUTER JOIN CR_0904T C
                ON B.SUBY_TMPL_SEQ = C.SUBY_TMPL_SEQ
                AND B.SUBY_TMPL_QEST_SEQ = C.SUBY_TMPL_QEST_SEQ
                AND B.DLR_CD = C.DLR_CD
                LEFT OUTER JOIN (
                                 SELECT T1.*, T2.CMPL_REASON_CONT, T2.STSF_IVST_YN
                                   FROM CR_0906T T1 INNER JOIN CR_0905T T2
                                     ON T1.DLR_CD = T2.DLR_CD
                                    AND T1.STSF_IVST_RSLT_SEQ = T2.STSF_IVST_RSLT_SEQ
                                    AND T1.STSF_IVST_SEQ = T2.STSF_IVST_SEQ
                                    AND T1.SUBY_TMPL_SEQ = T2.SUBY_TMPL_SEQ
                                  INNER JOIN CR_1112T T3
                                     ON T2.DLR_CD = T3.DLR_CD
                                    AND T2.STSF_IVST_RSLT_SEQ = T3.STSF_IVST_RSLT_SEQ
                                    AND T2.EMP_ID = T3.EMP_ID
                                    AND T3.IVST_TP = #{sIvstTp}
                                    AND T3.DLR_CD = #{sDlrCd}
                                    AND T3.MAK_CD = #{sMakCd}
                                    AND T3.EMP_ID = #{sEmpId}
                                    AND T2.STSF_IVST_SEQ = #{sSeq}
                                    AND T2.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
                                ) D
                ON C.DLR_CD = D.DLR_CD
                AND C.SUBY_TMPL_SEQ = D.SUBY_TMPL_SEQ
                AND C.SUBY_TMPL_QEST_SEQ = D.QEST_SEQ
                AND C.ITEM_SEQ = D.ANSW_SEQ
        WHERE   A.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
        AND     A.DLR_CD = #{sDlrCd}
        UNION ALL
        SELECT  A.DLR_CD
               ,A.SUBY_TMPL_SEQ
               ,B.SUBY_TMPL_QEST_SEQ
               ,NULL AS ITEM_SEQ
               ,ROW_NUMBER()OVER (PARTITION BY B.SUBY_TMPL_QEST_SEQ ORDER BY B.SORT_ORDER) AS QEST_NUM
               ,NULL AS ANSW_CONT
               ,NULL AS ANSW_SCORE_VAL
               ,D.ANSW_SEQ
               ,D.SBJV_ANSW_CONT
               ,D.CMPL_REASON_CONT
               ,D.STSF_IVST_YN
       FROM    CR_0902T A LEFT OUTER JOIN (SELECT * FROM CR_0903T WHERE QEST_TP_CD = '03') B
               ON A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
               AND A.DLR_CD = B.DLR_CD
               LEFT OUTER JOIN (
                                SELECT T1.*, T2.CMPL_REASON_CONT, T2.STSF_IVST_YN
                                  FROM CR_0906T T1 INNER JOIN CR_0905T T2
                                    ON T1.DLR_CD = T2.DLR_CD
                                   AND T1.STSF_IVST_RSLT_SEQ = T2.STSF_IVST_RSLT_SEQ
                                   AND T1.STSF_IVST_SEQ = T2.STSF_IVST_SEQ
                                   AND T1.SUBY_TMPL_SEQ = T2.SUBY_TMPL_SEQ
                                 INNER JOIN CR_1112T T3
                                    ON T2.DLR_CD = T3.DLR_CD
                                   AND T2.STSF_IVST_RSLT_SEQ = T3.STSF_IVST_RSLT_SEQ
                                   AND T2.EMP_ID = T3.EMP_ID
                                   AND T3.IVST_TP = #{sIvstTp}
                                   AND T3.DLR_CD = #{sDlrCd}
                                   AND T3.MAK_CD = #{sMakCd}
                                   AND T3.EMP_ID = #{sEmpId}
                                   AND T2.STSF_IVST_SEQ = #{sSeq}
                                   AND T2.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
                               ) D
               ON B.DLR_CD = D.DLR_CD
               AND B.SUBY_TMPL_SEQ = D.SUBY_TMPL_SEQ
               AND B.SUBY_TMPL_QEST_SEQ = D.QEST_SEQ
       WHERE   A.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
       AND     A.DLR_CD = #{sDlrCd}
    </select>


    <insert id="insertCampaignAnswerSurvey" parameterType="CampaignResultVO">
        INSERT INTO CR_0906T        --만족도설문상세결과
        (
            DLR_CD                    --딜러코드
            ,SEQ                       --일련번호
            ,STSF_IVST_RSLT_SEQ        --만족도조사결과일련번호
            ,STSF_IVST_SEQ             --만족도조사일련번호
            ,SUBY_TMPL_SEQ             --설문템플릿일련번호
            ,QEST_SEQ                  --질문일련번호
            ,ANSW_SEQ                  --답변일련번호
            ,ANSW_SCORE_VAL            --답변점수값
            ,SBJV_ANSW_CONT            --주관식답변내용
            ,REG_USR_ID                --등록자ID
            ,REG_DT                    --등록일자
        )
        VALUES
        (
            #{dlrCd}                    --딜러코드
            ,SEQ_CR_0906T.NEXTVAL  --일련번호
            ,#{stsfIvstRsltSeq}          --만족도조사결과일련번호
            ,#{stsfIvstSeq}              --만족도조사일련번호
            ,#{subyTmplSeq}              --설문템플릿일련번호
            ,#{qestSeq}                  --질문일련번호
            ,#{answSeq}                  --답변일련번호
            ,#{answScoreVal}             --답변점수값
            ,#{sbjvAnswCont}             --주관식답변내용
            ,#{regUsrId}                 --등록자ID
            ,SYSDATE                    --등록일자
        )
    </insert>

    <!-- 마케팅 캠페인(업체평가 OR 영업사원 설문) 정보를 등록한다. -->
    <insert id="insertCropSaleEmpSurvey" parameterType="CampaignResultVO" >
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.insertCropSaleEmpSurvey] */
        INSERT INTO CR_1112T    --마케팅캠페인결과설문
        (
         DLR_CD                  --딜러코드
        ,MAK_CD                  --마케팅코드
        ,SEQ                     --일련번호
        ,IVST_TP                 --조사유형
        ,PRSN_OPN_CONT           --담당자의견내용
        ,STSF_IVST_RSLT_SEQ      --만족도조사결과인련번호
        ,EMP_ID                  --사원ID
        ,REG_USR_ID              --등록자ID
        ,REG_DT                  --등록일자
        )
        VALUES
        (
         #{dlrCd}                  --딜러코드
        ,#{makCd}                  --마케팅코드
        ,SEQ_CR_1112T.NEXTVAL      --일련번호
        ,#{ivstTp}                 --조사유형
        ,#{prsnOpnCont}            --담당자의견내용
        ,#{stsfIvstRsltSeq}        --만족도조사결과인련번호
        ,#{empId}                  --사원ID
        ,#{regUsrId}               --등록자ID
        ,SYSDATE                   --등록일자
        )
    </insert>





    <!-- 캠페인결과(담당자 의견) 정보를 조회한다. -->
    <select id="selectPrsnContByKey" parameterType="CampaignResultSearchVO" resultType="CampaignResultVO">
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.selectPrsnContByKey] */
        SELECT
               CR_1112T.DLR_CD                    --딜러코드
              ,CR_1112T.MAK_CD                    --마케팅코드
              ,CR_1112T.SEQ                       --일련번호
              ,CR_1112T.IVST_TP                   --조사유형
              ,CR_1112T.PRSN_OPN_CONT             --담당자의견내용
              ,CR_1112T.DOC_ID                       --첨부파일아이디
         FROM CR_1112T CR_1112T             --마케팅캠페인결과설문
        WHERE CR_1112T.DLR_CD  = #{sDlrCd}
          AND CR_1112T.MAK_CD  = #{sMakCd}
          AND CR_1112T.IVST_TP = '03'
    </select>

    <!-- 마케팅 캠페인(담당자 의견) 정보를 등록한다. -->
    <insert id="insertPrsnCont" parameterType="CampaignResultVO" >
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.insertPrsnCont] */
        INSERT INTO CR_1112T    --마케팅캠페인결과설문
        (
         DLR_CD                  --딜러코드
        ,MAK_CD                  --마케팅코드
        ,SEQ                     --일련번호
        ,IVST_TP                 --조사유형
        ,PRSN_OPN_CONT           --담당자의견내용
        ,STSF_IVST_RSLT_SEQ      --만족도조사결과인련번호
        ,EMP_ID                  --사원ID
        ,DOC_ID                  --문서아이디
        ,REG_USR_ID              --등록자ID
        ,REG_DT                  --등록일자
        )
        VALUES
        (
         #{dlrCd}                  --딜러코드
        ,#{makCd}                  --마케팅코드
        ,SEQ_CR_1112T.NEXTVAL      --일련번호
        ,'03'                      --조사유형
        ,#{prsnOpnCont}            --담당자의견내용
        ,#{stsfIvstRsltSeq}        --만족도조사결과인련번호
        ,#{empId}                  --사원ID
        ,#{docId}                  --문서아이디
        ,#{regUsrId}               --등록자ID
        ,SYSDATE                   --등록일자
        )
    </insert>

    <!-- 캠페인결과(담당자 의견) 정보를 수정한다. -->
    <update id="updatePrsnCont" parameterType="CampaignResultVO" >
        /* [chn.bhmc.dms.crm.mcm.service.dao.CampaignResultDAO.updatePrsnCont] */
        UPDATE CR_1112T                   --마케팅캠페인결과설문
           SET
               PRSN_OPN_CONT = #{prsnOpnCont}         --담당자 의견
              ,UPDT_USR_ID   = #{updtUsrId}           --수정자ID
              ,DOC_ID        = #{docId}               --문서아이디
              ,UPDT_DT       = SYSDATE                --수정일자
         WHERE 1 = 1
           AND DLR_CD        = #{dlrCd}               --딜러코드
           AND MAK_CD        = #{makCd}               --마케팅코드
           AND SEQ           = #{seq}                 --일련번호
           AND IVST_TP       = '03'
    </update>

    <!-- 캠페인 기본목표에 대한 결과값을 계산처리 한다. -->
    <select id="selectCrmDefultTargSum" statementType="CALLABLE" parameterType="CampaignResultVO">

         { call SP_CRM_DEFAULT_TARG_SUM (
             #{dlrCd, mode=IN, jdbcType=VARCHAR}
           , #{updtUsrId, mode=IN, jdbcType=VARCHAR}
           , #{result, mode=OUT, jdbcType=VARCHAR}
         ) }

    </select>

</mapper>