<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : SatisFactionManageDAO_SqlMap.xml
    Description : 설문 템플릿 관리
    author Hyun Ho Kim
    since 2016. 03. 04.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 03. 04.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO">
    <!-- 만족도 조사 검색조건 -->
    <sql id="searchSatisFactionManage">
        <where>
            AND DLR_CD = #{sDlrCd}
            <if test='sStsfIvstMthCd != null and sStsfIvstMthCd != ""'>
                AND     STSF_IVST_MTH_CD  = #{sStsfIvstMthCd}           --만족도조사방법코드(유형?)
            </if>

            <if test='sStsfIvstExpdCd != null and sStsfIvstExpdCd != ""'>
                AND     STSF_IVST_EXPD_CD = #{sStsfIvstExpdCd}          --만족도조사수단코드
            </if>

            <if test='sStsfIvstTpCd != null and sStsfIvstTpCd != ""'>
                AND     STSF_IVST_TP_CD = #{sStsfIvstTpCd}          --만족도조사타입코드
            </if>

            <if test='sUseYn != null and sUseYn != ""'>
                AND     USE_YN = #{sUseYn}          --사용여부
            </if>

            <choose>
                <when test='(sStartDt != null and sEndDt == null)'>
                    AND     REG_DT <![CDATA[>=]]> #{sStartDt}
                </when>
                <when test='(sStartDt == null and sEndDt != null)'>
                    <!-- AND     TO_CHAR(REG_DT,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sEndDt},'YYYYMMDD') -->
                    AND     REG_DT <![CDATA[<=]]> #{sEndDt}
                </when>
                <otherwise>
                    <if test='(sStartDt != null) and (sEndDt != null)'>
                        AND     (REG_DT <![CDATA[>=]]> #{sStartDt} AND REG_DT <![CDATA[<=]]> #{sEndDt})
                    </if>
                </otherwise>
            </choose>
            <if test='sStsfIvstNm != null and sStsfIvstNm != ""'>
                AND STSF_IVST_NM LIKE '%'||#{sStsfIvstNm}||'%'
            </if>
        </where>
    </sql>

    <!-- 만족도 조사 대상자 검색조건 -->
    <sql id="searchSatisFactionManageUsr">
        <where>
            AND A.DLR_CD = #{sDlrCd}
            <if test='sStsfIvstMthCd != null and sStsfIvstMthCd != ""'>
                AND A.STSF_IVST_MTH_CD  = #{sStsfIvstMthCd}           <!-- 만족도조사방법코드(유형?) -->
            </if>
            <if test='sStsfIvstExpdCd != null and sStsfIvstExpdCd != ""'>
                AND A.STSF_IVST_EXPD_CD = #{sStsfIvstExpdCd}          <!-- 만족도조사수단코드 -->
            </if>
            <if test='sStsfIvstSeq != null and sStsfIvstSeq != ""'>
                AND A.STSF_IVST_SEQ = #{sStsfIvstSeq} <!-- 만족도 결과쪽 만족도조사 일련번호 -->
            </if>
            <if test='sSeq != null and sSeq != ""'>
                AND A.SEQ = #{sSeq} <!-- 만족도 조사 일련번호 -->
            </if>
            <if test='sSubyTmplSeq != null and sSubyTmplSeq != ""'>
                AND A.SUBY_TMPL_SEQ = #{sSubyTmplSeq} <!-- 설문지 일련번호 -->
            </if>
            <if test='sStsfIvstTpCd != null and sStsfIvstTpCd != ""'>
                AND A.STSF_IVST_TP_CD = #{sStsfIvstTpCd}
            </if>
            <choose>
                <when test='(sStartDt != null and sEndDt == null)'>
                    AND     A.REG_DT <![CDATA[>=]]> #{sStartDt}
                </when>
                <when test='(sStartDt == null and sEndDt != null)'>
                    <!-- AND     TO_CHAR(REG_DT,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sEndDt},'YYYYMMDD') -->
                    AND     A.REG_DT <![CDATA[<=]]> #{sEndDt}
                </when>
                <otherwise>
                    <if test='(sStartDt != null) and (sEndDt != null)'>
                        AND     (A.REG_DT <![CDATA[>=]]> #{sStartDt} AND A.REG_DT <![CDATA[<=]]> #{sEndDt})
                    </if>
                </otherwise>
            </choose>
            <if test='sStsfIvstNm != null and sStsfIvstNm != ""'>
                AND A.STSF_IVST_NM LIKE '%'||#{sStsfIvstNm}||'%'
                <!-- <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sStsfIvstNm,"*")'>
                        <bind name='sStsfIvstNm' value='@org.apache.commons.lang3.StringUtils@replace(sStsfIvstNm, "*", "%")' />
                        AND A.STSF_IVST_NM LIKE #{sStsfIvstNm}
                    </when>
                    <otherwise>
                        AND A.STSF_IVST_NM = #{sStsfIvstNm}
                    </otherwise>
                </choose> -->
            </if>
        </where>
    </sql>

    <!-- 만족도 조사 관리 목록수를 조회한다. -->
    <select id="selectSatisFactionManagesByConditionCnt" parameterType="SurveySatisFactionSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionManagesByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0901T    --만족도마스터
        <include refid="searchSatisFactionManage" />
    </select>

    <!-- 만족도 조사 관리 정보 목록을 조회한다. -->
    <select id="selectSatisFactionManagesByCondition" parameterType="SurveySatisFactionSearchVO" resultType="SatisFactionManageVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionManagesByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT  DLR_CD                    --딜러코드
                        ,SEQ                      --일련번호
                        ,STSF_IVST_NM             --만족도조사명
                        ,STSF_IVST_MTH_CD         --만족도조사방법코드
                        ,STSF_IVST_EXPD_CD        --만족도조사수단코드
                        ,STSF_IVST_TP_CD          --만족도조사타입코드
                        ,SUBY_TMPL_SEQ            --설문템플릿일련번호
                        ,RCPE_EXTR_SEQ            --대상자추출일련번호
                        ,START_DT                 --시작일자
                        ,END_DT                   --종료일자
                        ,USE_YN                   --사용여부
                        ,CUST_TARG_YN             --고객대상여부
                        ,REG_USR_ID               --등록자ID
                        ,REG_DT                   --등록일자
                        ,UPDT_USR_ID              --수정자ID
                        ,UPDT_DT                  --수정일자
                        ,CUST_EXTR_AUTO_YN        --고객추출자동여부
                        ,CUST_EXTR_CYCLE_TP       --고객추출주기유형
                        ,CUST_EXTR_CYCLE_CONT     --고객추출주기내용
                        ,LAST_EXTR_DT             --최종추출일자
                        ,STSF_CONT                --설명/화술
                        ,NVL(BAT_OPER_ID,'') AS BAT_OPER_ID      --배치작업 ID
                        ,CASE WHEN START_DT <![CDATA[>]]> SYSDATE THEN 'Y' ELSE 'N' END AS EDIT_YN --수정가능여부
                FROM    CR_0901T    --만족도마스터
                <include refid="searchSatisFactionManage" />
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "stsfIvstNm"'>STSF_IVST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "stsfIvstMthCd"'>STSF_IVST_MTH_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "stsfIvstExpd"'>STSF_IVST_EXPD_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "stsfIvstExpdCd"'>STSF_IVST_EXPD_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "stsfIvstTpCd"'>STSF_IVST_TP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "subyTmplSeq"'>SUBY_TMPL_SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "rcpeExtrSeq"'>RCPE_EXTR_SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "startDt"'>START_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "endDt"'>END_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "useYn"'>USE_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custTargYn"'>CUST_TARG_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custExtrAutoYn"'>CUST_EXTR_AUTO_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custExtrCycleCont"'>CUST_EXTR_CYCLE_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "lastExtrDt"'>LAST_EXTR_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "stsfCont"'>STSF_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "batOperId"'>BAT_OPER_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "custExtrCycleTp"'>CUST_EXTR_CYCLE_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    START_DT DESC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        START_DT DESC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <insert id="insertSatisFactionManage" parameterType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.insertSatisFactionManage] */
        INSERT INTO CR_0901T    --만족도마스터
        (
            DLR_CD                    --딜러코드
            ,SEQ                      --일련번호
            ,STSF_IVST_NM             --만족도조사명
            ,STSF_IVST_MTH_CD         --유형코드
            ,STSF_IVST_TP_CD          --조사타입
            ,STSF_IVST_EXPD_CD        --만족도조사수단코드
            ,SUBY_TMPL_SEQ            --설문템플릿일련번호
            ,RCPE_EXTR_SEQ            --대상자추출일련번호
            ,START_DT                 --시작일자
            ,END_DT                   --종료일자
            ,USE_YN                   --사용여부
            ,CUST_TARG_YN             --고객대상여부
            ,REG_USR_ID               --등록자ID
            ,REG_DT                   --등록일자
            ,CUST_EXTR_AUTO_YN        --고객추출자동여부
            ,CUST_EXTR_CYCLE_TP       --고객추출주기유형
            ,CUST_EXTR_CYCLE_CONT     --고객추출주기내용
            ,STSF_CONT                --설명/화술
            ,BAT_OPER_ID              --배치작업ID
        )
        VALUES
        (
            #{dlrCd}                    --딜러코드
            ,SEQ_CR_0901T.NEXTVAL  -- 일련번호
            ,#{stsfIvstNm}              --만족도조사명
            ,#{stsfIvstMthCd}           --유형코드
            ,#{stsfIvstTpCd}           --유형코드
            ,#{stsfIvstExpdCd}          --만족도조사수단코드
            ,#{subyTmplSeq}             --설문템플릿일련번호
            ,#{rcpeExtrSeq}             --대상자추출일련번호
            ,#{startDt}                 --시작일자
            ,#{endDt}                   --종료일자
            ,#{useYn}                   --사용여부
            ,#{custTargYn}              --고객대상여부
            ,#{regUsrId}                --등록자ID
            ,SYSDATE                    --등록일자
            ,#{custExtrAutoYn}          --고객추출자동여부
            ,#{custExtrCycleTp}         --고객추출주기유형
            ,#{custExtrCycleCont}       --고객추출주기내용
            ,#{stsfCont}                --설명/화술
            ,#{batOperId}               --배치작업ID
        )
    </insert>

    <update id="updateSatisFactionManage" parameterType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.updateSatisFactionManage] */
        UPDATE  CR_0901T    --만족도마스터
                SET     USE_YN            = #{useYn}                   --사용여부
                        ,BAT_OPER_ID       = #{batOperId}               -- 배치작업ID
                <if test='editYn != null and editYn == "N"'>
                        ,START_DT          = #{startDt}                 --시작일자
                        ,END_DT            = #{endDt}                   --종료일자
                </if>
                <if test='editYn != null and editYn == "Y"'>
                        ,STSF_IVST_NM       = #{stsfIvstNm}              --만족도조사명
                        ,STSF_IVST_MTH_CD  = #{stsfIvstMthCd}           --만족도조사방법코드
                        ,STSF_IVST_EXPD_CD = #{stsfIvstExpdCd}          --만족도조사수단코드
                        ,STSF_IVST_TP_CD   = #{stsfIvstTpCd}            --만족도조사타입코드
                        ,SUBY_TMPL_SEQ     = #{subyTmplSeq}             --설문템플릿일련번호
                        ,RCPE_EXTR_SEQ     = #{rcpeExtrSeq}             --대상자추출일련번호
                        ,CUST_TARG_YN      = #{custTargYn}               --고객대상여부
                        ,UPDT_USR_ID       = #{updtUsrId}               --수정자ID
                        ,UPDT_DT           = SYSDATE                    --수정일자
                        ,CUST_EXTR_AUTO_YN = #{custExtrAutoYn}      --고객추출자동여부
                        ,CUST_EXTR_CYCLE_TP= #{custExtrCycleTp}         --고객추출주기유형
                        ,CUST_EXTR_CYCLE_CONT = #{custExtrCycleCont}  --고객추출주기내용
                        ,STSF_CONT = #{stsfCont}               --설명/화술
                        ,START_DT          = #{startDt}                 --시작일자
                        ,END_DT            = #{endDt}                   --종료일자
                </if>
        WHERE   SEQ                = #{seq}                      --일련번호
        AND     DLR_CD             = #{dlrCd}                      --딜러코드
    </update>

    <update id="updateLastExtrDt" parameterType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.updateLastExtrDt] */
        UPDATE  CR_0901T    --만족도마스터
        SET     LAST_EXTR_DT = SYSDATE               --마지막 추출일
        WHERE   DLR_CD             = #{dlrCd}                      --딜러코드
        AND     SEQ                = #{seq}                      --일련번호
    </update>

    <delete id="deleteSatisFactionManage" parameterType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.deleteSatisFactionManage] */
        DELETE  CR_0901T
        WHERE   DLR_CD = #{dlrCd}
        AND     SEQ = #{seq}
    </delete>

    <select id="selectStsfIvstNmsByCondition" parameterType="SurveySatisFactionSearchVO" resultType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectStsfIvstNmsByCondition] */
        SELECT A.DLR_CD
               ,A.SEQ
               ,A.STSF_IVST_NM
               ,A.STSF_IVST_EXPD_CD
               ,A.SUBY_TMPL_SEQ
               ,B.SUBY_TMPL_NM
        FROM    CR_0901T A INNER JOIN CR_0902T B
                ON A.DLR_CD = B.DLR_CD
                AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                <if test='sCustTargYn == "Y"'>
                    AND A.STSF_IVST_EXPD_CD IN ('03','04') -- 조사수단(전시장/고객휴게소방문, 기타)
                </if>
                AND A.CUST_TARG_YN = #{sCustTargYn}
                AND A.DLR_CD = #{sDlrCd}
                AND A.USE_YN = #{sUseYn}
                AND (TO_CHAR(SYSDATE,'YYYYMMDD') <![CDATA[>=]]> TO_CHAR(A.START_DT,'YYYYMMDD') AND TO_CHAR(SYSDATE,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(A.END_DT,'YYYYMMDD'))
        <!-- <if test='sStsfIvstNm != null and sStsfIvstNm != ""'>
        AND     STSF_IVST_NM = #{sStsfIvstNm}
        </if> -->
        <!-- AND     USR_ID = #{usrId} -->
    </select>

    <select id="selectSurveyCdByKey" parameterType="SatisFactionMobileSearchVO" resultType="SatisFactionManageVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSurveyCdByKey] */
        SELECT   A.DLR_CD
                ,A.STSF_IVST_NM
                ,A.SEQ
                ,A.SUBY_TMPL_SEQ
            <if test='sQestTp != null and sQestTp != ""'>
                , ( SELECT COUNT(STSF_IVST_YN) AS CNT FROM CR_0905T WHERE  A.SEQ = STSF_IVST_SEQ AND STSF_IVST_YN = 'Y') AS STSF_IVST_Y
                , ( SELECT COUNT(STSF_IVST_YN) AS CNT FROM CR_0905T WHERE  A.SEQ = STSF_IVST_SEQ AND STSF_IVST_YN = 'N') AS STSF_IVST_N
            </if>
        FROM    CR_0901T A
        WHERE   A.DLR_CD = #{sDlrCd}
        AND     A.SEQ = ${sSeq}
    </select>

        <!-- 만족도 조사 대상인원수를 조회한다. -->
    <select id="selectSatisFactionManageUsrsByConditionCnt" parameterType="SatisFactionManageSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionManageUsrsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0901T A INNER JOIN CR_0905T B
                ON A.DLR_CD = B.DLR_CD
                AND A.SEQ = B.STSF_IVST_SEQ
                AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                LEFT OUTER JOIN CR_0101T C
                ON B.DLR_CD = C.DLR_CD
                AND B.CUST_NO = C.CUST_NO
        <include refid="searchSatisFactionManageUsr"/>
    </select>

    <!-- 만족도 조사 대상인원을 조회한다. -->
    <select id="selectSatisFactionManageUsrsByCondition" parameterType="SatisFactionManageSearchVO" resultType="SatisFactionManageVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionManageUsrsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,A.SEQ
                            ,A.STSF_IVST_NM
                            ,A.STSF_IVST_MTH_CD
                            ,A.STSF_IVST_EXPD_CD
                            ,A.SUBY_TMPL_SEQ
                            ,A.RCPE_EXTR_SEQ
                            ,A.START_DT
                            ,A.END_DT
                            ,A.USE_YN
                            ,A.CUST_TARG_YN
                            ,A.STSF_IVST_TP_CD
                            ,A.BAT_OPER_ID
                            ,B.STSF_IVST_RSLT_SEQ
                            ,B.STSF_IVST_SEQ
                            ,B.CUST_NO
                            ,B.STSF_IVST_EMP_ID
                            ,B.EMP_ID
                            ,B.HP_NO
                            ,B.CALL_CEN_SEND_DT
                            ,B.CALL_CEN_RSLT_CONT
                            ,B.REG_DT
                            ,C.CUST_NM
                    FROM    CR_0901T A INNER JOIN CR_0905T B
                            ON A.DLR_CD = B.DLR_CD
                            AND A.SEQ = B.STSF_IVST_SEQ
                            AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                            LEFT OUTER JOIN CR_0101T C
                            ON B.DLR_CD = C.DLR_CD
                            AND B.CUST_NO = C.CUST_NO
                    <include refid="searchSatisFactionManageUsr"/>
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "custNm"'>C.CUST_NM     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "useYn"'>A.USE_YN     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "hpNo"'>B.HP_NO    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "regDt"'>B.REG_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstTpCd"'>A.STSF_IVST_TP_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "callCenRsltCont"'>,B.CALL_CEN_RSLT_CONT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        A.SEQ DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.SEQ DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>


    <!-- 만족도 조사 현황수를 조회한다. -->
    <select id="selectSatisFactionPresentResultsByConditionCnt" parameterType="SatisFactionManageSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionPresentResultsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0901T A LEFT OUTER JOIN (
                    SELECT  DLR_CD
                            ,STSF_IVST_SEQ
                            ,SUBY_TMPL_SEQ
                            ,CUST_EXTR_TERM_NO
                            ,COUNT(STSF_IVST_RSLT_SEQ) AS STSF_CUST_CNT
                            ,COUNT(STSF_IVST_SCORE_VAL) AS SURVEY_USR_CNT
                            ,SUM(STSF_IVST_SCORE_VAL)/COUNT(STSF_IVST_RSLT_SEQ) AS AVG_SCORE
                    FROM    CR_0905T
                    WHERE   DLR_CD = #{sDlrCd}
                    AND     DEL_YN = 'N'
                    GROUP BY DLR_CD, STSF_IVST_SEQ, SUBY_TMPL_SEQ,CUST_EXTR_TERM_NO
                ) B
          ON A.DLR_CD = B.DLR_CD
          AND A.SEQ = B.STSF_IVST_SEQ
          LEFT OUTER JOIN CM_0304T STSF_IVST_MTH_CD_NM ON STSF_IVST_MTH_CD_NM.CMM_GRP_CD = 'CRM094' AND STSF_IVST_MTH_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_MTH_CD_NM.CMM_CD = A.STSF_IVST_MTH_CD
          LEFT OUTER JOIN CM_0304T STSF_IVST_EXPD_CD_NM ON STSF_IVST_EXPD_CD_NM.CMM_GRP_CD = 'CRM092' AND STSF_IVST_EXPD_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_EXPD_CD_NM.CMM_CD = A.STSF_IVST_EXPD_CD
          LEFT OUTER JOIN CM_0304T STSF_IVST_TP_CD_NM ON STSF_IVST_TP_CD_NM.CMM_GRP_CD = 'CRM091' AND STSF_IVST_TP_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_TP_CD_NM.CMM_CD = A.STSF_IVST_TP_CD
          <include refid="searchSatisFactionManageUsr"/>
    </select>

    <!-- 만족도 조사 현황 대상자목록을 조회한다. -->
    <select id="selectSatisFactionPresentResultsByCondition" parameterType="SatisFactionManageSearchVO" resultType="SatisFactionManageVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionPresentResultsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,B.STSF_IVST_SEQ
                            ,A.SEQ
                            ,A.STSF_IVST_TP_CD --만족도조사 타입
                            ,STSF_IVST_MTH_CD_NM.CMM_CD_TXT AS STSF_IVST_MTH_CD_NM        --만족도조사방법코드
                            ,A.STSF_IVST_NM --만족도 조사명
                            ,A.STSF_IVST_MTH_CD --유형
                            ,STSF_IVST_TP_CD_NM.CMM_CD_TXT AS STSF_IVST_TP_CD_NM        --만족도조사유형코드
                            ,A.STSF_IVST_EXPD_CD -- 조사수단(실행타입)
                            ,STSF_IVST_EXPD_CD_NM.CMM_CD_TXT AS STSF_IVST_EXPD_CD_NM        --만족도조사수단코드
                            ,A.START_DT
                            ,A.END_DT
                            ,A.RCPE_EXTR_SEQ --대상자추출조건
                            ,B.STSF_CUST_CNT --대상자수
                            ,B.SURVEY_USR_CNT --설문완료수
                            ,B.AVG_SCORE --평균점수
                            ,B.SUBY_TMPL_SEQ --설문지일련번호
                            ,B.CUST_EXTR_TERM_NO --고객추출조건번호
                            ,A.REG_DT -- 등록일
                            ,CASE WHEN A.START_DT <![CDATA[<]]> SYSDATE THEN 'Y' ELSE 'N' END AS EDIT_YN --수정가능여부
                    FROM CR_0901T A LEFT OUTER JOIN (
                            SELECT  DLR_CD
                                    ,STSF_IVST_SEQ
                                    ,SUBY_TMPL_SEQ
                                    ,CUST_EXTR_TERM_NO
                                    ,COUNT(STSF_IVST_RSLT_SEQ) AS STSF_CUST_CNT
                                    ,COUNT(STSF_IVST_SCORE_VAL) AS SURVEY_USR_CNT
                                    ,SUM(STSF_IVST_SCORE_VAL)/COUNT(STSF_IVST_RSLT_SEQ) AS AVG_SCORE
                            FROM    CR_0905T
                            WHERE   DLR_CD = #{sDlrCd}
                            AND     DEL_YN = 'N'
                            GROUP BY DLR_CD, STSF_IVST_SEQ, SUBY_TMPL_SEQ,CUST_EXTR_TERM_NO
                          )  B
                          ON A.DLR_CD = B.DLR_CD
                          AND A.SEQ = B.STSF_IVST_SEQ
                          LEFT OUTER JOIN CM_0304T STSF_IVST_MTH_CD_NM ON STSF_IVST_MTH_CD_NM.CMM_GRP_CD = 'CRM094' AND STSF_IVST_MTH_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_MTH_CD_NM.CMM_CD = A.STSF_IVST_MTH_CD
                          LEFT OUTER JOIN CM_0304T STSF_IVST_EXPD_CD_NM ON STSF_IVST_EXPD_CD_NM.CMM_GRP_CD = 'CRM092' AND STSF_IVST_EXPD_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_EXPD_CD_NM.CMM_CD = A.STSF_IVST_EXPD_CD
                          LEFT OUTER JOIN CM_0304T STSF_IVST_TP_CD_NM ON STSF_IVST_TP_CD_NM.CMM_GRP_CD = 'CRM091' AND STSF_IVST_TP_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_TP_CD_NM.CMM_CD = A.STSF_IVST_TP_CD
                    <include refid="searchSatisFactionManageUsr"/>
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "stsfIvstNm"'>A.STSF_IVST_NM     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstTpCd"'>A.STSF_IVST_TP_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstMthCd"'>A.STSF_IVST_MTH_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstExpdCd"'>A.STSF_IVST_EXPD_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "startDt"'>A.START_DT     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "endDt"'>A.END_DT     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfCustCnt"'>B.STSF_CUST_CNT    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "surveyUsrCnt"'>B.SURVEY_USR_CNT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "avgScore"'>B.AVG_SCORE        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "regDt"'>A.REG_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstMthCdNm"'> STSF_IVST_MTH_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstExpdCdNm"'> STSF_IVST_EXPD_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstTpCdNm"'> STSF_IVST_TP_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <otherwise>
                                        A.SEQ DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.SEQ DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>


    <!-- 만족도 조사 고객추출 - 오늘 고객 추출 수량 조회 ( 배치에서 사용 )
     * @param searchVO - sDlrCd / sCurruntDt
     * @return 오늘 스케줄 돌아야 할 수량
     -->
    <select id="selectSatisFactionBatchCnt" parameterType="SurveySatisFactionSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionManageDAO.selectSatisFactionBatchCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CR_0901T
        WHERE DLR_CD = #{sDlrCd}
        AND (
          (
            CUST_EXTR_CYCLE_TP = 'W' AND CUST_EXTR_CYCLE_CONT LIKE '%'||UPPER(to_char(#{sCurruntDt}, 'dy','NLS_DATE_LANGUAGE=ENGLISH'))||'%'
          ) OR (
            CUST_EXTR_CYCLE_TP = 'S' AND CUST_EXTR_CYCLE_CONT LIKE '%'||to_char(#{sCurruntDt}, 'YYYYMMDD')||'%'
          ) OR (
            CUST_EXTR_CYCLE_TP = 'D'
          )
        )
    </select>

</mapper>