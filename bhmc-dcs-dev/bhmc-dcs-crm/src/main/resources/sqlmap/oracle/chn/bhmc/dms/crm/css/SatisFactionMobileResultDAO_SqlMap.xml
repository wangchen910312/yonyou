<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : SatisFactionMobileDAO_SqlMap.xml
    Description : 만족도 조사 모바일설문
    author Hyun Ho Kim
    since 2016. 03. 15.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 03. 15.    Hyun Ho Kim    최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO">

    <sql id="satisFactionMobileResultSearch">
        <where>
            AND A.DLR_CD = #{sDlrCd}
            AND B.DEL_YN = 'N'
            <if test='sVocYn != null and sVocYn != ""'>
                AND B.VOC_YN = #{sVocYn}
            </if>
            <if test='sStsfIvstSeq != null and sStsfIvstSeq != ""'>
                AND A.STSF_IVST_SEQ = #{sStsfIvstSeq}
            </if>
            <if test='sSeq != null and sSeq != ""'>
                AND A.SEQ = #{sSeq}
            </if>
            <if test='sSubyTmplSeq != null and sSubyTmplSeq != ""'>
                AND A.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
            </if>
            <if test='sStsfIvstExpdCd != null and sStsfIvstExpdCd != ""'>
                AND A.STSF_IVST_EXPD_CD = #{sStsfIvstExpdCd}
            </if>
            <if test='sStsfIvstMthCd != null and sStsfIvstMthCd != ""'>
                AND A.STSF_IVST_MTH_CD = #{sStsfIvstMthCd}
            </if>
            <if test='sStsfIvstTpCd != null and sStsfIvstTpCd != ""'>
                AND A.STSF_IVST_TP_CD = #{sStsfIvstTpCd}
            </if>
            <if test='sStsfIvstScoreVal != null and sStsfIvstScoreVal != ""'>
                AND B.STSF_IVST_SCORE_VAL <![CDATA[<=]]> #{sStsfIvstScoreVal}
            </if>
            <if test='sCmplReasonContYn != null and sCmplReasonContYn != ""'>
                AND NVL(B.CMPL_REASON_CONT,'N') = #{sCmplReasonContYn}
            </if>
            <if test='sStsfIvstNm != null and sStsfIvstNm != ""'>
                AND A.STSF_IVST_NM LIKE '%'||#{sStsfIvstNm}||'%'
                <!-- <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sStsfIvstNm,"*")'>
                        <bind name='sStsfIvstNm' value='@org.apache.commons.lang3.StringUtils@replace(sStsfIvstNm, "*", "%")' />
                        AND A.STSF_IVST_NM LIKE #{sStsfIvstNm}
                    </when>
                    <otherwise>
                        AND A.STSF_IVST_NM = #{sStsfIvstNm}
                    </otherwise>
                </choose> -->
            </if>
            <choose>
                <when test='(sStartDt != null and sEndDt == null)'>
                    AND     B.STSF_IVST_DT <![CDATA[>=]]> #{sStartDt}
                </when>
                <when test='(sStartDt == null and sEndDt != null)'>
                    <!-- AND     TO_CHAR(REG_DT,'YYYYMMDD') <![CDATA[<=]]> TO_CHAR(#{sEndDt},'YYYYMMDD') -->
                    AND     B.STSF_IVST_DT <![CDATA[<=]]> #{sEndDt}
                </when>
                <otherwise>
                    <if test='(sStartDt != null) and (sEndDt != null)'>
                        AND     (B.STSF_IVST_DT <![CDATA[>=]]> #{sStartDt} AND B.STSF_IVST_DT <![CDATA[<=]]> #{sEndDt})
                    </if>
                </otherwise>
            </choose>
        </where>
    </sql>

    <insert id="insertSurveyResult" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.insertSurveyResult] */
        INSERT INTO CR_0905T    --만족도설문결과
        (
            DLR_CD                     --딜러코드
            ,STSF_IVST_RSLT_SEQ         --만족도조사결과일련번호
            ,STSF_IVST_SEQ              --만족도조사일련번호
            ,SUBY_TMPL_SEQ              --설문템플릿일련번호
            ,CUST_NO                    --고객번호
            ,CUST_NM                    --고객명
            ,STSF_IVST_SCORE_VAL        --만족도조사점수값
            ,STSF_IVST_DT               --만족도조사일자
            ,STSF_IVST_EMP_ID           --만족도조사사원ID
            ,DEL_YN                     --삭제여부
            ,EMP_ID                     --사원설문ID
            ,CMPL_REASON_CONT           --불만사유내용
            ,REG_USR_ID                 --등록자ID
            ,REG_DT                     --등록일자
            ,CUST_EXTR_TERM_NO          --고객추출조건번호
        )
        VALUES
        (
            #{dlrCd}                      --딜러코드
            ,#{stsfIvstRsltSeq}           --만족도조사결과일련번호
            ,#{stsfIvstSeq}               --만족도조사일련번호
            ,#{subyTmplSeq}               --설문템플릿일련번호
            ,#{custNo}                    --고객번호
            ,#{custNm}                    --고객명
            ,#{stsfIvstScoreVal}          --만족도조사점수값
            ,SYSDATE                      --만족도조사일자
            ,#{stsfIvstEmpId}             --만족도조사사원ID
            ,'N'                          --삭제여부
            ,#{empId}                     --사원설문ID
            ,#{cmplReasonCont}            --불만사유내용
            ,#{regUsrId}                  --등록자ID
            ,SYSDATE                      --등록일자
            ,#{custExtrTermNo}            --고객추출조건번호
        )
    </insert>

    <select id="selectStsfIvstRsltSeq" parameterType="SatisFactionMobileResultVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectStsfIvstRsltSeq] */
        SELECT  SEQ_CR_0905T.NEXTVAL  FROM DUAL
    </select>

    <select id="selectUseSurvey"  parameterType="SatisFactionMobileResultVO" resultType="int">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectUseSurvey] */
        SELECT  COUNT(*)
        FROM    CR_0905T
        WHERE   DLR_CD = #{sDlrCd}
        AND     SUBY_TMPL_SEQ = #{sSubyTmplSeq}
    </select>

    <select id="selectUseSurveyDetail"  parameterType="SatisFactionMobileResultVO" resultType="int">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectUseSurveyDetail] */
        SELECT  COUNT(*)
        FROM    CR_0905T A INNER JOIN CR_0906T B
                ON A.DLR_CD = B.DLR_CD
                AND A.STSF_IVST_RSLT_SEQ = B.STSF_IVST_RSLT_SEQ
                AND A.STSF_IVST_SEQ = B.STSF_IVST_SEQ
                AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
        WHERE   A.DLR_CD = #{sDlrCd}
        AND     A.STSF_IVST_RSLT_SEQ = #{sStsfIvstRsltSeq}
        AND     A.STSF_IVST_SEQ = #{sStsfIvstSeq}
        AND     A.SUBY_TMPL_SEQ = #{sSubyTmplSeq}
        AND     A.CUST_NO = #{sCustNo}
        AND     A.DEL_YN = 'N'
    </select>

    <!-- 만족도 조사결과 현황 목록수를 조회한다. -->
    <select id="selectSatisFactionPresentsByConditionCnt" parameterType="SatisFactionMobileResultSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSatisFactionPresentsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0901T A INNER JOIN CR_0905T B
                ON A.DLR_CD = B.DLR_CD
                AND A.SEQ = B.STSF_IVST_SEQ
                AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                LEFT OUTER JOIN CR_0101T C
                ON B.DLR_CD = C.DLR_CD
                AND B.CUST_NO = C.CUST_NO
        <include refid="satisFactionMobileResultSearch"/>
    </select>

    <!-- 만족도 조사결과 현황 목록을 조회한다. -->
    <select id="selectSatisFactionPresentsByCondition" parameterType="SatisFactionMobileResultSearchVO" resultType="SatisFactionMobileResultVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSatisFactionPresentsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,A.SEQ
                            ,A.STSF_IVST_NM
                            ,A.STSF_IVST_MTH_CD
                            ,STSF_IVST_MTH_CD_NM.CMM_CD_TXT AS STSF_IVST_MTH_CD_NM        --만족도조사방법코드
                            ,A.STSF_IVST_EXPD_CD
                            ,STSF_IVST_EXPD_CD_NM.CMM_CD_TXT AS STSF_IVST_EXPD_CD_NM        --만족도조사수단코드
                            ,A.SUBY_TMPL_SEQ
                            ,A.RCPE_EXTR_SEQ
                            ,A.START_DT
                            ,A.END_DT
                            ,A.USE_YN
                            ,A.CUST_TARG_YN
                            ,A.STSF_IVST_TP_CD
                            ,STSF_IVST_TP_CD_NM.CMM_CD_TXT AS STSF_IVST_TP_CD_NM        --만족도조사유형코드
                            ,B.STSF_IVST_RSLT_SEQ
                            ,B.STSF_IVST_SEQ
                            ,B.CUST_NO
                            ,B.STSF_IVST_SCORE_VAL
                            ,B.STSF_IVST_DT
                            ,B.STSF_IVST_EMP_ID
                            ,D.USR_NM
                            ,B.VOC_YN
                            ,B.VOC_REG_DT
                            ,B.DEL_YN
                            ,B.EMP_ID
                            ,B.CMPL_REASON_CONT
                            ,B.CUST_EXTR_TERM_NO
                            ,B.TEL_NO
                            ,B.HP_NO
                            ,B.WECHAT_ID
                            ,B.EMAIL_NM
                            ,B.SUNG_NM
                            ,B.CITY_NM
                            ,B.DIST_NM
                            ,B.ZIP_CD
                            ,B.EXT_ZIP_CD
                            ,B.ADDR_NM
                            ,B.ADDR_DETL_CONT
                            ,B.CALL_CEN_SEND_DT
                            ,B.CALL_CEN_RSLT_CONT
                            ,B.VOC_PROC_ID
                            ,B.VOC_PROC_DT
                            ,B.VOC_PROC_CONT
                            ,C.CUST_NM
                    FROM    CR_0901T A INNER JOIN CR_0905T B
                            ON A.DLR_CD = B.DLR_CD
                            AND A.SEQ = B.STSF_IVST_SEQ
                            AND A.SUBY_TMPL_SEQ = B.SUBY_TMPL_SEQ
                            LEFT OUTER JOIN CR_0101T C
                            ON B.DLR_CD = C.DLR_CD
                            AND B.CUST_NO = C.CUST_NO
                            LEFT OUTER JOIN CM_0304T STSF_IVST_MTH_CD_NM ON STSF_IVST_MTH_CD_NM.CMM_GRP_CD = 'CRM091' AND STSF_IVST_MTH_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_MTH_CD_NM.CMM_CD = A.STSF_IVST_MTH_CD
                            LEFT OUTER JOIN CM_0304T STSF_IVST_EXPD_CD_NM ON STSF_IVST_EXPD_CD_NM.CMM_GRP_CD = 'CRM092' AND STSF_IVST_EXPD_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_EXPD_CD_NM.CMM_CD = A.STSF_IVST_EXPD_CD
                            LEFT OUTER JOIN CM_0304T STSF_IVST_TP_CD_NM ON STSF_IVST_TP_CD_NM.CMM_GRP_CD = 'CRM094' AND STSF_IVST_TP_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_TP_CD_NM.CMM_CD = A.STSF_IVST_TP_CD
                            LEFT OUTER JOIN CM_0801T D ON B.STSF_IVST_EMP_ID = D.USR_ID

                    <include refid="satisFactionMobileResultSearch"/>
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "custNm"'>C.CUST_NM     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstNm"'>A.STSF_IVST_NM     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstExpdCd"'>A.STSF_IVST_EXPD_CD    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstMthCd"'>A.STSF_IVST_MTH_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "subyTmplSeq"'>A.SUBY_TMPL_SEQ        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "rcpeExtrSeq"'>A.RCPE_EXTR_SEQ        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "startDt"'>A.START_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "endDt"'>A.END_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "useYn"'>A.USE_YN        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "custTargYn"'>A.CUST_TARG_YN        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstTpCd"'>A.STSF_IVST_TP_CD        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstRsltSeq"'>B.STSF_IVST_RSLT_SEQ        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "callCenRsltCont"'>,B.CALL_CEN_RSLT_CONT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstScoreVal"'>B.STSF_IVST_SCORE_VAL        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstMthCdNm"'> STSF_IVST_MTH_CD_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstExpdCdNm"'> STSF_IVST_EXPD_CD_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstTpCdNm"'> STSF_IVST_TP_CD_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstDtFormat"'> STSF_IVST_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "vocProcDtFormat"'> VOC_PROC_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>

                                    <otherwise>
                                        A.SEQ DESC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            A.SEQ DESC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 만족도 조사결과 설문항목 상세 수를 조회한다. -->
    <select id="selectSurveyResultsByConditionCnt" parameterType="SatisFactionMobileResultSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSurveyResultsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0905T A INNER JOIN CR_0906T B
                ON A.DLR_CD = B.DLR_CD
                AND A.STSF_IVST_RSLT_SEQ = B.STSF_IVST_RSLT_SEQ
                LEFT OUTER JOIN CR_0902T C
                ON B.DLR_CD = C.DLR_CD
                AND B.SUBY_TMPL_SEQ = C.SUBY_TMPL_SEQ
                LEFT OUTER JOIN CR_0903T D
                ON C.DLR_CD = D.DLR_CD
                AND C.SUBY_TMPL_SEQ = D.SUBY_TMPL_SEQ
                AND B.QEST_SEQ = D.SUBY_TMPL_QEST_SEQ
                LEFT OUTER JOIN CR_0904T E
                ON D.DLR_CD = E.DLR_CD
                AND D.SUBY_TMPL_SEQ = E.SUBY_TMPL_SEQ
                AND D.SUBY_TMPL_QEST_SEQ = E.SUBY_TMPL_QEST_SEQ
                AND B.QEST_SEQ = E.SUBY_TMPL_QEST_SEQ
                AND B.ANSW_SEQ = E.ITEM_SEQ
        WHERE A.DLR_CD = #{sDlrCd}
        AND A.STSF_IVST_RSLT_SEQ = #{sStsfIvstRsltSeq}
        <!-- AND A.CUST_NO = #{sCustNo} -->
        <!-- AND A.STSF_IVST_SEQ = #{stsfIvstSeq} -->
    </select>

    <!-- 만족도 조사결과 설문항목 상세 목록을 조회한다. -->
    <select id="selectSurveyResultsByCondition" parameterType="SatisFactionMobileResultSearchVO" resultType="SatisFactionMobileResultVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSurveyResultsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT A.DLR_CD
                          ,A.STSF_IVST_RSLT_SEQ
                          ,A.STSF_IVST_SEQ
                          ,A.SUBY_TMPL_SEQ
                          ,A.CUST_NO
                          ,B.SEQ
                          ,B.QEST_SEQ
                          ,B.ANSW_SEQ
                          ,B.ANSW_SCORE_VAL
                          ,B.SBJV_ANSW_CONT
                          ,C.SUBY_TMPL_NM
                          ,D.SUBY_TMPL_QEST_SEQ
                          ,D.QEST_CONT
                          ,D.QEST_WGT_VAL
                          ,D.QEST_TP_CD
                          ,D.ANSW_SEL_CNT
                          ,D.SORT_ORDER
                          ,E.ITEM_SEQ
                          ,E.ANSW_CONT
                    FROM CR_0905T A INNER JOIN CR_0906T B
                          ON A.DLR_CD = B.DLR_CD
                          AND A.STSF_IVST_RSLT_SEQ = B.STSF_IVST_RSLT_SEQ
                          LEFT OUTER JOIN CR_0902T C
                          ON B.DLR_CD = C.DLR_CD
                          AND B.SUBY_TMPL_SEQ = C.SUBY_TMPL_SEQ
                          LEFT OUTER JOIN CR_0903T D
                          ON C.DLR_CD = D.DLR_CD
                          AND C.SUBY_TMPL_SEQ = D.SUBY_TMPL_SEQ
                          AND B.QEST_SEQ = D.SUBY_TMPL_QEST_SEQ
                          LEFT OUTER JOIN CR_0904T E
                          ON D.DLR_CD = E.DLR_CD
                          AND D.SUBY_TMPL_SEQ = E.SUBY_TMPL_SEQ
                          AND D.SUBY_TMPL_QEST_SEQ = E.SUBY_TMPL_QEST_SEQ
                          AND B.QEST_SEQ = E.SUBY_TMPL_QEST_SEQ
                          AND B.ANSW_SEQ = E.ITEM_SEQ
                    WHERE A.DLR_CD = #{sDlrCd}
                    AND A.STSF_IVST_RSLT_SEQ = #{sStsfIvstRsltSeq}
                    <!-- AND A.CUST_NO = #{sCustNo} -->
                    <!-- AND A.STSF_IVST_SEQ = #{stsfIvstSeq} -->
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "qestCont"'>D.QEST_CONT     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "qestWgtVal"'>D.QEST_WGT_VAL     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "answCont"'>E.ANSW_CONT    <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "sbjvAnswCont"'>B.SBJV_ANSW_CONT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "answScoreVal"'>B.ANSW_SCORE_VAL        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <otherwise>
                                        D.SORT_ORDER ASC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            D.SORT_ORDER ASC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <update id="updateSatisFactionPresent" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.updateSatisFactionPresent] */
    UPDATE  CR_0905T
    SET     VOC_YN = 'Y'
            ,VOC_REG_DT = SYSDATE
            ,UPDT_DT = SYSDATE
            ,UPDT_USR_ID = #{updtUsrId}
    WHERE   DLR_CD = #{dlrCd}
    AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </update>

    <!-- 만족도 조사 현황에서 대상자목록  총 갯수를 조회한다. -->
    <select id="selectSurveyCustResultsByConditionCnt" parameterType="SatisFactionMobileResultSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSurveyCustResultsByConditionCnt] */
        SELECT  COUNT(*) AS VALUE
        FROM    CR_0901T A INNER JOIN CR_0905T B
                ON A.DLR_CD = B.DLR_CD
                AND A.SEQ = B.STSF_IVST_SEQ
                LEFT OUTER JOIN CR_0101T C
                ON B.DLR_CD = C.DLR_CD
                AND B.CUST_NO = C.CUST_NO
                LEFT OUTER JOIN CM_0304T STSF_IVST_MTH_CD_NM ON STSF_IVST_MTH_CD_NM.CMM_GRP_CD = 'CRM094' AND STSF_IVST_MTH_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_MTH_CD_NM.CMM_CD = A.STSF_IVST_MTH_CD
                LEFT OUTER JOIN CM_0304T STSF_IVST_EXPD_CD_NM ON STSF_IVST_EXPD_CD_NM.CMM_GRP_CD = 'CRM092' AND STSF_IVST_EXPD_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_EXPD_CD_NM.CMM_CD = A.STSF_IVST_EXPD_CD
                LEFT OUTER JOIN CM_0304T STSF_IVST_TP_CD_NM ON STSF_IVST_TP_CD_NM.CMM_GRP_CD = 'CRM091' AND STSF_IVST_TP_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_TP_CD_NM.CMM_CD = A.STSF_IVST_TP_CD
        WHERE   A.DLR_CD = #{sDlrCd}
        AND     A.SEQ = #{sSeq}
        AND     B.DEL_YN = 'N'
    </select>

    <!-- 만족도 조사 현황에서 대상자목록  정보를 조회한다. -->
    <select id="selectSurveyCustResultsByCondition" parameterType="SatisFactionMobileResultSearchVO" resultType="SatisFactionMobileResultVO">
        /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.selectSurveyCustResultsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                    SELECT  A.DLR_CD
                            ,A.SEQ
                            ,A.STSF_IVST_NM
                            ,A.STSF_IVST_MTH_CD
                            ,STSF_IVST_MTH_CD_NM.CMM_CD_TXT AS STSF_IVST_MTH_CD_NM        --만족도조사방법코드
                            ,STSF_IVST_EXPD_CD_NM.CMM_CD_TXT AS STSF_IVST_EXPD_CD_NM        --만족도조사수단코드
                            ,STSF_IVST_TP_CD_NM.CMM_CD_TXT AS STSF_IVST_TP_CD_NM        --만족도조사유형코드
                            ,A.STSF_IVST_EXPD_CD
                            ,A.STSF_IVST_TP_CD
                            ,B.STSF_IVST_RSLT_SEQ
                            ,B.STSF_IVST_SEQ
                            ,B.SUBY_TMPL_SEQ
                            ,B.CUST_NO
                            ,C.CUST_NM
                            ,C.MNG_SC_ID
                            ,C.MNG_TEC_ID
                            ,C.SALE_SC_ID
                            ,B.CUST_EXTR_TERM_NO
                            ,B.STSF_IVST_SCORE_VAL
                            ,B.STSF_IVST_DT
                            ,B.STSF_IVST_EMP_ID
                            ,B.VOC_YN
                            ,B.VOC_REG_DT
                            ,B.REG_DT
                            ,B.EMP_ID
                            ,B.CALL_CEN_SEND_DT
                            ,B.CALL_CEN_RSLT_CONT
                            ,C.HP_NO
                    FROM    CR_0901T A INNER JOIN CR_0905T B
                            ON A.DLR_CD = B.DLR_CD
                            AND A.SEQ = B.STSF_IVST_SEQ
                            LEFT OUTER JOIN CR_0101T C
                            ON B.DLR_CD = C.DLR_CD
                            AND B.CUST_NO = C.CUST_NO
                            LEFT OUTER JOIN CM_0304T STSF_IVST_MTH_CD_NM ON STSF_IVST_MTH_CD_NM.CMM_GRP_CD = 'CRM094' AND STSF_IVST_MTH_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_MTH_CD_NM.CMM_CD = A.STSF_IVST_MTH_CD
                            LEFT OUTER JOIN CM_0304T STSF_IVST_EXPD_CD_NM ON STSF_IVST_EXPD_CD_NM.CMM_GRP_CD = 'CRM092' AND STSF_IVST_EXPD_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_EXPD_CD_NM.CMM_CD = A.STSF_IVST_EXPD_CD
                            LEFT OUTER JOIN CM_0304T STSF_IVST_TP_CD_NM ON STSF_IVST_TP_CD_NM.CMM_GRP_CD = 'CRM091' AND STSF_IVST_TP_CD_NM.LANG_CD = #{sLangCd} AND STSF_IVST_TP_CD_NM.CMM_CD = A.STSF_IVST_TP_CD
                    WHERE   A.DLR_CD = #{sDlrCd}
                    AND     A.SEQ = #{sSeq}
                    AND     B.DEL_YN = 'N'
                    ORDER BY
                    <choose>
                        <when test='sort != null'>
                            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                                <choose>
                                    <when test='item.field == "custNm"'>C.CUST_NM     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "hpNo"'>C.HP_NO     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstEmpId"'>B.STSF_IVST_EMP_ID     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstDt"'>B.STSF_IVST_DT     <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstScoreVal"'>B.STSF_IVST_SCORE_VAL        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "callCenSendDt"'>B.CALL_CEN_SEND_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "regDt"'>B.REG_DT        <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                    <when test='item.field == "stsfIvstMthCdNm"'> STSF_IVST_MTH_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstExpdCdNm"'> STSF_IVST_EXPD_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                    <when test='item.field == "stsfIvstTpCdNm"'> STSF_IVST_TP_CD_NM.CMM_CD_TXT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>

                                    <otherwise>
                                        C.CUST_NM ASC
                                    </otherwise>
                                </choose>
                            </foreach>
                        </when>
                        <otherwise>
                            C.CUST_NM ASC
                        </otherwise>
                    </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <insert id="insertSatisFactionManageTargExtUsr" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.insertSatisFactionManageTargExtUsr] */
        INSERT INTO CR_0905T    --만족도설문결과
        (
            DLR_CD                      --딜러코드
            ,STSF_IVST_RSLT_SEQ         --만족도조사결과일련번호
            ,STSF_IVST_SEQ              --만족도조사일련번호
            ,SUBY_TMPL_SEQ              --설문템플릿일련번호
            ,CUST_NO                    --고객번호
            ,STSF_IVST_SCORE_VAL        --만족도조사점수값
            ,STSF_IVST_DT               --만족도조사일자
            ,STSF_IVST_EMP_ID           --만족도조사사원ID
            ,DEL_YN                     --삭제여부
            ,EMP_ID                     --사원설문ID
            ,CMPL_REASON_CONT           --불만사유내용
            ,REG_USR_ID                 --등록자ID
            ,REG_DT                     --등록일자
            ,CUST_EXTR_TERM_NO          --고객추출조건번호
            ,HP_NO
            ,TEL_NO
            ,WECHAT_ID
            ,EMAIL_NM
            ,SUNG_NM
            ,CITY_NM
            ,DIST_NM
            ,ZIP_CD
            ,ADDR_NM
            ,ADDR_DETL_CONT
            ,CUST_NM
        )
        SELECT  B.DLR_CD
                ,SEQ_CR_0905T.NEXTVAL
                ,#{stsfIvstSeq} --만족도조사일련번호
                ,#{subyTmplSeq} --설문템플릿일련번호
                ,B.CUST_NO
                ,NULL --만족도조사 점수값
                ,NULL --만족도조사일자
                ,NULL -- 만족도조사사원ID
                ,'N' -- 삭제여부
                ,NULL --사원설문ID
                ,NULL --불만사유내용
                ,#{regUsrId}--등록자
                ,SYSDATE--등록일자
                ,#{custExtrTermNo} --고객추출조건번호
                ,C.HP_NO
                ,C.TEL_NO
                ,C.WECHAT_ID
                ,C.EMAIL_NM
                ,ADDR.SUNG_NM
                ,ADDR.CITY_NM
                ,ADDR.DIST_NM
                ,ADDR.ZIP_CD
                ,ADDR.SUNG_NM || ' ' || ADDR.CITY_NM || ' ' || ADDR.DIST_NM AS ADDR_NM
                ,ADDR.ADDR_DETL_CONT
                ,C.CUST_NM
        FROM    CR_1003T B
                INNER JOIN CR_0101T C ON B.DLR_CD = C.DLR_CD AND B.CUST_NO = C.CUST_NO
                LEFT OUTER JOIN CR_0116T ADDR ON C.CUST_NO = ADDR.REF_KEY_NM AND C.DLR_CD = ADDR.DLR_CD AND ADDR.REF_TABLE_NM = 'CR_0101T' AND FLAG_YN = 'Y'
        WHERE   B.DLR_CD = #{dlrCd}
        AND     B.SEQ = #{seq}
    </insert>

    <delete id="deleteSatisFactionMobileResult"  parameterType="SatisFactionMobileResultVO" >
        DELETE  CR_0905T
        WHERE   DLR_CD = #{dlrCd}
        AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </delete>


    <update id="updateCallCenRslt" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.updateCallCenRslt] */
    UPDATE  CR_0905T
    SET     CALL_CEN_SEND_DT = SYSDATE
            ,CALL_CEN_RSLT_CONT = #{callCenRsltCont}
    WHERE   DLR_CD = #{dlrCd}
    AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </update>

    <update id="updateStsfResultInvalidity" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.updateStsfResultInvalidity] */
    UPDATE  CR_0905T
    SET     DEL_YN = 'Y'
            ,UPDT_DT = SYSDATE
            ,UPDT_USR_ID = #{updtUsrId}
    WHERE   DLR_CD = #{dlrCd}
    AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </update>

    <update id="updateSurveyResultScore" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.updateSurveyResultScore] */
    UPDATE  CR_0905T
    SET     STSF_IVST_SCORE_VAL = #{stsfIvstScoreVal}
            ,STSF_IVST_DT = SYSDATE
            ,STSF_IVST_EMP_ID = #{updtUsrId}
            <if test='cmplReasonCont != null and cmplReasonCont != ""'>
                ,CMPL_REASON_CONT = #{cmplReasonCont}
            </if>
            <if test='custNm != null and custNm != ""'>
                ,CUST_NM = #{custNm}
            </if>
            ,UPDT_DT = SYSDATE
            ,UPDT_USR_ID = #{updtUsrId}
    WHERE   DLR_CD = #{dlrCd}
    AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </update>

    <update id="updateVocResult" parameterType="SatisFactionMobileResultVO">
    /* [chn.bhmc.dms.crm.css.service.dao.SatisFactionMobileResultDAO.updateVocResult] */
    UPDATE  CR_0905T
    SET     VOC_PROC_DT = #{vocProcDt}
            ,VOC_PROC_ID = #{vocProcId}
            ,VOC_PROC_CONT = #{vocProcCont}
            ,UPDT_DT = SYSDATE
            ,UPDT_USR_ID = #{updtUsrId}
    WHERE   DLR_CD = #{dlrCd}
    AND     STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}
    </update>

    <!-- 콜센터 콜처리완료여부(CALL_PROC_END_YN)가 Y 이면 콜내용(CALL_CONT)을 각 업무 콜센터결과내용(CALL_CEN_RSLT_CONT) 에 업데이트 해준다. -->
    <update id="updateCallCenRsltCont" parameterType="SatisFactionMobileResultVO" >
        UPDATE DMSDB.CR_0905T SET                             -- 고객케어대상자
             UPDT_DT            = SYSDATE                     -- 수정일자
            ,UPDT_USR_ID        = #{updtUsrId}                -- 수정자ID
            ,CALL_CEN_RSLT_CONT = #{callCenRsltCont}          -- 콜센터결과내용
        WHERE DLR_CD            = #{dlrCd}                    -- 딜러코드
            AND STSF_IVST_RSLT_SEQ = #{stsfIvstRsltSeq}              -- 고객케어일련번호
    </update>


</mapper>