<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : CustomerCareExtrTargetDAO_SqlMap.xml
    Description : 대상자 목록에 관한 데이터처리
    author in moon Lee
    since 2016.05.25.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016.05.25.     in moon Lee     최초 생성
-->

<mapper namespace="chn.bhmc.dms.crm.crq.service.dao.CustomerCareExtrTargetDAO">


    <!-- 대상자 목록 정보 검색조건 -->
    <sql id="searchCustomerCareExtrTarget">
        INNER JOIN CR_0501T CR0501T ON CR0502T.CUST_CARE_SEQ = CR0501T.CUST_CARE_SEQ AND CR0502T.DLR_CD = CR0501T.DLR_CD
        LEFT OUTER JOIN CM_0801T USRT ON CR0501T.REG_USR_ID = USRT.USR_ID
        <where>
            AND CR0502T.DLR_CD = #{sDlrCd}
            AND CR0502T.CUST_CARE_SEQ = #{sCustCareSeq}

        <!-- 추출차수 -->
        <if test='sExtrDgreCnt != null and sExtrDgreCnt != ""'>
            AND CR0502T.EXTR_DGRE_CNT = #{sExtrDgreCnt}
        </if>

        <!-- SMS 전송여부 -->
        <if test='sSmsSendYn != null and sSmsSendYn != ""'>
            <choose>
                <when test='sSmsSendYn eq "Y"'>
                    AND CR0502T.SMS_SEND_DT IS NOT NULL
                </when>
                <when test='sSmsSendYn eq "N"'>
                    AND CR0502T.SMS_SEND_DT IS NULL
                </when>
            </choose>
        </if>

        <!-- 콜센터 전송여부 -->
        <if test='sCallCenSendYn != null and sCallCenSendYn != ""'>
            <choose>
                <when test='sCallCenSendYn eq "Y"'>
                    AND CR0502T.CALL_CEN_SEND_DT IS NOT NULL
                </when>
                <when test='sCallCenSendYn eq "N"'>
                    AND CR0502T.CALL_CEN_SEND_DT IS NULL
                </when>
            </choose>
        </if>

        </where>
    </sql>


    <!-- 대상자 목록 정보 목록수를 조회한다. -->
    <select id="selectCustomerCareExtrTargetsByConditionCnt" parameterType="CustomerCareExtrTargetSearchVO" resultType="int">
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.selectCustomerCareExtrTargetsByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CR_0502T CR0502T
        <include refid="searchCustomerCareExtrTarget" />
    </select>

    <!-- 대상자 목록 정보 목록을 조회한다. -->
    <select id="selectCustomerCareExtrTargetsByCondition" parameterType="CustomerCareExtrTargetSearchVO" resultType="CustomerCareExtrTargetVO">
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.selectCustomerCareExtrTargetsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT

                     CR0502T.DLR_CD                    --딜러코드
                    ,CR0502T.CUST_CARE_SEQ             --고객케어일련번호
                    ,CR0502T.EXTR_DGRE_CNT             --추출차수
                    ,CR0502T.CUST_NO                   --고객번호
                    ,CR0502T.CUST_EXTR_TERM_NO         --고객추출조건번호
                    ,CR0502T.TEL_NO                    --전화번호
                    ,CR0502T.HP_NO                     --휴대폰번호
                    ,CR0502T.WECHAT_ID                 --위챗ID
                    ,CR0502T.EMAIL_NM                  --이메일명
                    ,CR0502T.SUNG_NM                   --성명
                    ,CR0502T.CITY_NM                   --도시명
                    ,CR0502T.DIST_NM                   --지역명
                    ,CR0502T.ZIP_CD                    --우편번호
                    ,CR0502T.EXT_ZIP_CD                --확장우편번호
                    ,CR0502T.ADDR_NM                   --주소명
                    ,CR0502T.ADDR_DETL_CONT            --주소상세내용
                    ,CR0502T.SMS_SEND_DT               --SMS발송일자
                    ,CR0502T.SMS_SEND_RSLT_CONT        --SMS발송결과내용
                    ,CR0502T.CALL_CEN_SEND_DT          --콜센터전송일자
                    ,CR0502T.CALL_CEN_RSLT_CONT        --콜센터결과내용
                    ,CR0502T.REG_USR_ID                --등록자ID
                    ,CR0502T.REG_DT                    --등록일자
                    ,CR0502T.UPDT_USR_ID               --수정자ID
                    ,CR0502T.UPDT_DT                   --수정일자

                    ,CR0501T.ACTIVE_TP_CD              --실행유형코드
                    ,(
                        SELECT NVL(B.CMM_CD_TXT, A.CMM_CD_NM)
                            FROM CM_0303T A, CM_0304T B
                        WHERE A.CMM_GRP_CD = B.CMM_GRP_CD
                        AND A.CMM_CD = B.CMM_CD
                        AND B.LANG_CD = #{sLangCd}
                        AND A.CMM_GRP_CD = 'CRM101'
                        AND A.CMM_CD = CR0501T.ACTIVE_TP_CD
                    ) AS ACTIVE_TP_NM                  --실행유형이름
                    ,CR0501T.AUTO_ACTIVE_YN            --자동실행여부

                    ,CR0502T.CUST_NM                   --고객명
                    ,USRT.USR_NM AS REG_USR_NM         --등록자이름
                FROM CR_0502T CR0502T

                <include refid="searchCustomerCareExtrTarget" />
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>

                                <when test='item.field == "dlrCd"'>             CR0502T.DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "custCareSeq"'>       CR0502T.CUST_CARE_SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "extrDgreCnt"'>       CR0502T.EXTR_DGRE_CNT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                                <when test='item.field == "custNo"'>            CR0502T.CUST_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "custExtrTermNo"'>    CR0502T.CUST_EXTR_TERM_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose> </when>
                                <when test='item.field == "telNo"'>             CR0502T.TEL_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "hpNo"'>              CR0502T.HP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>             </when>
                                <when test='item.field == "wechatId"'>          CR0502T.WECHAT_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                                <when test='item.field == "emailNm"'>           CR0502T.EMAIL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                                <when test='item.field == "sungNm"'>            CR0502T.SUNG_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "cityNm"'>            CR0502T.CITY_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "distNm"'>            CR0502T.DIST_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "zipCd"'>             CR0502T.ZIP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "extZipCd"'>          CR0502T.EXT_ZIP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "addrNm"'>            CR0502T.ADDR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                                <when test='item.field == "addrDetlCont"'>      CR0502T.ADDR_DETL_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>    </when>
                                <when test='item.field == "smsSendDt"'>         CR0502T.SMS_SEND_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "smsSendRsltCont"'>   CR0502T.SMS_SEND_RSLT_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "callCenSendDt"'>     CR0502T.CALL_CEN_SEND_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>  </when>
                                <when test='item.field == "callCenRsltCont"'>   CR0502T.CALL_CEN_RSLT_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "regUsrId"'>          CR0502T.REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>        </when>
                                <when test='item.field == "regDt"'>             CR0502T.REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>            </when>
                                <when test='item.field == "updtUsrId"'>         CR0502T.UPDT_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                                <when test='item.field == "updtDt"'>            CR0502T.UPDT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>

                                <otherwise>
                                       CR0502T.DLR_CD ASC ,CR0502T.CUST_CARE_SEQ ASC ,CR0502T.EXTR_DGRE_CNT ASC ,CR0502T.CUST_NO ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        CR0502T.DLR_CD ASC ,CR0502T.CUST_CARE_SEQ ASC ,CR0502T.EXTR_DGRE_CNT ASC ,CR0502T.CUST_NO ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 고객 추출 프로시저 호출. -->
    <insert id="insertTargExtract" parameterType="CustomerCareExtrTargetVO" >
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareMgmtDAO.insertTargExtract] */
        INSERT INTO CR_0502T (
              DLR_CD
            , CUST_CARE_SEQ
            , EXTR_DGRE_CNT
            , CUST_NO
            , CUST_EXTR_TERM_NO
            , TEL_NO
            , HP_NO
            , WECHAT_ID
            , EMAIL_NM
            , SUNG_NM
            , CITY_NM
            , DIST_NM
            , ZIP_CD
            , EXT_ZIP_CD
            , ADDR_NM
            , ADDR_DETL_CONT
            , REG_USR_ID
            , REG_DT
            , CUST_NM
        ) SELECT
              T1.DLR_CD
            , #{custCareSeq}
            , #{extrDgreCnt}
            , T1.CUST_NO
            , #{custExtrTermNo}
            , T2.TEL_NO
            , T2.HP_NO
            , T2.WECHAT_ID
            , T2.EMAIL_NM
            , ADDR.SUNG_NM
            , ADDR.CITY_NM
            , ADDR.DIST_NM
            , ADDR.ZIP_CD
            , ADDR.EXT_ZIP_CD
            , ADDR.ADDR_NM
            , ADDR.ADDR_DETL_CONT
            , #{regUsrId}
            , SYSDATE
            , T2.CUST_NM
        FROM CR_1003T T1
        INNER JOIN CR_0101T T2 ON T1.CUST_NO = T2.CUST_NO AND T1.DLR_CD = T2.DLR_CD AND T2.DEL_YN = 'N' and T2.cust_tp = '01'
        LEFT OUTER JOIN CR_0116T ADDR ON T2.CUST_NO = ADDR.REF_KEY_NM AND T2.DLR_CD = ADDR.DLR_CD AND ADDR.REF_TABLE_NM = 'CR_0101T' AND FLAG_YN = 'Y'
        where T1.DLR_CD = #{dlrCd} and T1.SEQ = #{extrSeq}
    </insert>

    <!-- 대상자에게 SMS 전송후 SMS 전송일을 수정한다. -->
    <update id="updateCustomerCareExtrTargetSmsSendDt" parameterType="CustomerCareExtrTargetVO" >
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.updateCustomerCareExtrTargetSmsSendDt] */
        UPDATE DMSDB.CR_0502T SET    --고객케어대상자
             UPDT_DT            = SYSDATE                     --수정일자
            ,UPDT_USR_ID        = #{updtUsrId}                --수정자ID
            ,SMS_SEND_DT        = SYSDATE                     --SMS발송일자
        WHERE DLR_CD            = #{dlrCd}                    --딜러코드
            AND CUST_CARE_SEQ   = #{custCareSeq}              --고객케어일련번호
            AND CUST_NO         = #{custNo}              --고객케어일련번호
    </update>

    <!-- [그룹전송] 대상자에게 SMS 전송후 SMS 전송일을 수정한다. ( SMS 전송 대상자 임시 테이블에서 select insert ) -->
    <update id="updateGroupCustomerCareExtrTargetSmsSendDt" parameterType="CustomerCareExtrTargetVO" >
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.updateGroupCustomerCareExtrTargetSmsSendDt] */
        UPDATE DMSDB.CR_0502T SET    --고객케어대상자
             UPDT_DT            = SYSDATE                     --수정일자
            ,UPDT_USR_ID        = #{updtUsrId}                --수정자ID
            ,SMS_SEND_DT        = SYSDATE                     --SMS발송일자
        WHERE DLR_CD            = #{dlrCd}                    --딜러코드
            AND CUST_CARE_SEQ   = #{custCareSeq}              --고객케어일련번호
            AND CUST_NO         IN ( SELECT CUST_NO FROM CR_0104T WHERE SEQ = #{smsTmplUserSeq} )
    </update>

    <!-- 대상자에게 콜센터 전송후 콜센터 전송일을 수정한다. // 콜센터 전송 완료후 콜센터 전송일 업데이트 ( 프로시저에서 처리해줌. )
    <update id="updateCallCenSendDt" parameterType="CustomerCareExtrTargetVO" >
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.updateCallCenSendDt] */
        UPDATE DMSDB.CR_0502T SET                             고객케어대상자
             UPDT_DT            = SYSDATE                     수정일자
            ,UPDT_USR_ID        = #{updtUsrId}                수정자ID
            ,CALL_CEN_SEND_DT   = SYSDATE                     콜센터전송일자
        WHERE DLR_CD            = #{dlrCd}                    딜러코드
            AND CUST_CARE_SEQ   = #{custCareSeq}              고객케어일련번호
            AND EXTR_DGRE_CNT   = #{extrDgreCnt}              추출차수
    </update>
    -->

    <!-- 추출한 대상자 삭제 -->
    <delete id="deleteExtrTarget" parameterType="CustomerCareExtrTargetVO" >
        /* [chn.bhmc.dms.crm.sac.service.dao.CustomerCareExtrTargetDAO.deleteExtrTarget] */
        DELETE FROM DMSDB.CR_0502T --고객케어대상자
        WHERE DLR_CD            = #{dlrCd}                    --딜러코드
            AND CUST_CARE_SEQ   = #{custCareSeq}              --고객케어일련번호
    </delete>

</mapper>