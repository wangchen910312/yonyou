<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : DmsProfileDAO_SqlMap.xml
    Description : DMS Profile에 관한 데이터처리
    author Cheol Man Oh
    since 2016. 3. 21.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 03. 21.     Cheol Man Oh     최초 생성
-->

<mapper namespace="chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO">

    <!-- DMS Profile 목록을 조회한다. -->
    <select id="selectDmsProfileByCondition" parameterType="DmsProfileSearchVO" resultType="DmsProfileVO">
        /* [chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO.selectDmsProfileByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
            SELECT A.DLR_CD
                 , A.DEPLOY_TARG_YN
                 , A.LAST_ACHK_REQ_DT
                 , A.LAST_ACHK_RES_DT
                 , A.LAST_ACHK_RES_CD
                 , A.LAST_ACHK_RES_MSG_CONT
                 , A.DLR_NM
                 , A.TEL_NO
                 , A.FAX_NO
                 , A.DMS_IP_NM AS IP
                 , A.DMS_PORT_NM AS PORT
                 , A.DMS_TEST_URL_NM AS HOMEPAGE_URL
                 , A.DMS_OPER_EMAIL_NM
                 , A.DMS_OPER_TEL_NO
                 , A.DEPLOY_TP_CD
                 , DECODE(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<dbms>']]>)+6, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<dbms>']]>)+6)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</dbms>']]>)))),'OK','OK','NOK') AS SQL_DEPLOY
                 , DECODE(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<repository>']]>)+12, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<repository>']]>)+12)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</repository>']]>)))),'OK','OK','NOK') AS REPO_DEPLOY
                 , DECODE(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<http>']]>)+6, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<http>']]>)+6)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</http>']]>)))),'OK','OK','NOK') AS FILE_DEPLOY
                 , DECODE(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<process>']]>)+9, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<process>']]>)+9)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</process>']]>)))),'OK','OK','NOK') AS DEPLOY_PROCESS
                 , DECODE(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<result>']]>)+8, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<result>']]>)+8)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</result>']]>)))),'OK','OK','NOK') AS RESULT
                 , SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<result_msg>']]>)+12, LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['<result_msg>']]>)+12)) - LENGTHB(SUBSTRB(LAST_ACHK_RES_MSG_CONT, INSTRB(LAST_ACHK_RES_MSG_CONT,<![CDATA['</result_msg>']]>)))) AS RESULT_MSG
              FROM VW_COM_DLR_INFO A
             WHERE 1 = 1
                     <if test='sDlrCd != null and sDlrCd != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
                                <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
                                 AND A.DLR_CD LIKE #{sDlrCd}
                            </when>
                            <otherwise>
                                 AND A.DLR_CD = #{sDlrCd}
                            </otherwise>
                        </choose>
                    </if>

                     <if test='sDlrNm != null and sDlrNm != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrNm,"*")'>
                                <bind name='sDlrNm' value='@org.apache.commons.lang3.StringUtils@replace(sDlrNm, "*", "%")' />
                                 AND A.DLR_NM LIKE #{sDlrNm}
                            </when>
                            <otherwise>
                                 AND A.DLR_NM = #{sDlrNm}
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sDeployTargYn != null and sDeployTargYn != ""'>
                        AND A.DEPLOY_TARG_YN = #{sDeployTargYn}
                    </if>

                    <if test='sLastAchkResCd != null and sLastAchkResCd != ""'>
                        AND A.LAST_ACHK_RES_CD = #{sLastAchkResCd}
                    </if>

                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "dlrNm"'>DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dlrCd"'>DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    A.DLR_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        A.DLR_CD ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- DMS Profile 목록수를 조회한다. -->
    <select id="selectDmsProfileByConditionCnt" parameterType="DmsProfileSearchVO" resultType="int">
        /* [chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO.selectDmsProfileByConditionCnt] */
        SELECT COUNT(*) AS VALUE FROM VW_COM_DLR_INFO A WHERE 1 = 1
                     <if test='sDlrCd != null and sDlrCd != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
                                <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
                                 AND A.DLR_CD LIKE #{sDlrCd}
                            </when>
                            <otherwise>
                                 AND A.DLR_CD = #{sDlrCd}
                            </otherwise>
                        </choose>
                    </if>

                     <if test='sDlrNm != null and sDlrNm != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrNm,"*")'>
                                <bind name='sDlrNm' value='@org.apache.commons.lang3.StringUtils@replace(sDlrNm, "*", "%")' />
                                 AND A.DLR_NM LIKE #{sDlrNm}
                            </when>
                            <otherwise>
                                 AND A.DLR_NM = #{sDlrNm}
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sDeployTargYn != null and sDeployTargYn != ""'>
                        AND A.DEPLOY_TARG_YN = #{sDeployTargYn}
                    </if>

                    <if test='sLastAchkResCd != null and sLastAchkResCd != ""'>
                        AND A.LAST_ACHK_RES_CD = #{sLastAchkResCd}
                    </if>

    </select>


    <!--  BundleDeployHistory 정보를 조회한다. -->
    <select id="selectBundleDeployHistoryByKey" parameterType="BundleDeployHistorySearchVO" resultType="BundleDeployHistoryVO">
        /* [chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO.selectBundleDeployHistoryByKey] */
        SELECT ROWNUM AS RNUM, A.* FROM (
            SELECT SS.SPEC_CD
                 , (SELECT SPEC_NM FROM CM_1401T WHERE SPEC_CD = SS.SPEC_CD) AS SPEC_NM
                   , SS.SYMBOLIC_NM
                 , SS.BUNDLE_VER_NO
                 , SS.OPER_CMD_NM
                 , RD.DEPLOY_PROC_YN
                 , TO_DATE(RD.DEPLOY_PROC_DT, 'YYYYMMDDHH24MISS') AS DEPLOY_PROC_DT
                 , RD.DEPLOY_RSLT_CD
                 , RD.DEPLOY_RSLT_MESG_CONT
                 , RD.ROLLBACK_RSLT_CD
                 , RD.ROLLBACK_RSLT_MESG_CONT
                 , SS.ROLLBACK_OPER_CMD_NM
                 , SS.BUNDLE_NM
              FROM CM_1506T RM, CM_1507T RD, CM_1403T SS
             WHERE RM.DEPLOY_REQ_SEQ = RD.DEPLOY_REQ_SEQ
               AND RD.SPEC_CD = SS.SPEC_CD
               AND RD.SEQ = SS.SEQ
               AND RD.SPEC_TP_NM = 'SERVICE'
               AND SS.SYMBOLIC_NM = #{sSymbolicNm}
               AND SS.BUNDLE_VER_NO = #{sBundleVerNo}
               AND RM.DLR_CD = #{sDlrCd}
           ORDER BY DEPLOY_PROC_DT DESC
       ) A
    </select>

    <!-- DMS Profile Target 대상 여부 'E'로 변경  -->
    <update id="updateDeployTargetToE" parameterType="DmsProfileVO">
    /* [chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO.updateDeployTargetToE] */
        UPDATE CM_1301T
           SET DEPLOY_TARG_YN  = 'E'
             , UPDT_USR_ID     = #{updtUsrId}
             , UPDT_DT         = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND DEPLOY_TARG_YN <![CDATA[<>]]> 'E'

    </update>

    <!-- DMS Profile Target 대상 여부 'Y'로 변경  -->
    <update id="updateDeployTargetToY" parameterType="DmsProfileVO">
    /* [chn.bhmc.dms.dply.dms.service.dao.DmsProfileDAO.updateDeployTargetToY] */
        UPDATE CM_1301T
           SET DEPLOY_TARG_YN  = 'Y'
             , UPDT_USR_ID     = #{updtUsrId}
             , UPDT_DT         = SYSDATE
         WHERE DLR_CD = #{dlrCd}
           AND DEPLOY_TARG_YN <![CDATA[<>]]> 'N'
           AND DEPLOY_TARG_YN <![CDATA[<>]]> 'Y'
    </update>


</mapper>