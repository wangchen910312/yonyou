<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : DplyCmmDAO_SqlMap.xml
    Description : 형상관리 공통업무에 관한 데이터 처리
    author Cheol Man Oh
    since 2016. 4. 6.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 04. 06.     Cheol Man Oh     최초 생성
-->

<mapper namespace="chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO">


    <!-- PROPERTY 정보 전체 LIST를 조회한다. -->
    <select id="selectCmmPrtyList" parameterType="DplyCmmSearchVO" resultType="CmmPrtyVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.selectCmmPrtyList] */
        SELECT ROWNUM AS RNUM, T.* FROM (
        SELECT PRTY_NM
             , PRTY_CONT
             , PRTY_VAL
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
             , PRTY_CONT_ZH
             , PRTY_TYPE
          FROM CM_1510T
         WHERE 1 = 1
        <if test='sPrtyNm != null and sPrtyNm != ""'>
           AND PRTY_NM = #{sPrtyNm}
        </if>
        ORDER BY UPPER(PRTY_NM)
        ) T
    </select>

    <!-- SYSTEM PROPERTY 정보 생성  -->
    <insert id="insertCmmPrty" parameterType="CmmPrtyVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.insertCmmPrty] */
        INSERT
          INTO CM_1510T(
               PRTY_NM
             , PRTY_CONT
             , PRTY_VAL
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
             , PRTY_CONT_ZH
             , PRTY_TYPE
        )VALUES(
               #{prtyNm         }
             , #{prtyCont       }
             , #{prtyVal        }
             , #{regUsrId       }
             , SYSDATE
             , ''
             , ''
             , #{prtyContZh     }
             , #{prtyType       }
        )
    </insert>

    <!-- SYSTEM PROPERTY 정보 수정  -->
    <update id="updateCmmPrty" parameterType="CmmPrtyVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.updateCmmPrty] */
        UPDATE CM_1510T
                    SET PRTY_CONT    = #{prtyCont      }
                      , PRTY_VAL     = #{prtyVal       }
                      , PRTY_CONT_ZH = #{prtyContZh    }
                      , PRTY_TYPE    = #{prtyType      }
                      , UPDT_USR_ID  = #{updtUsrId     }
                      , UPDT_DT      = SYSDATE
                  WHERE PRTY_NM      = #{prtyNm        }
    </update>


    <!-- SYSTEM PROPERTY 정보 삭제  -->
    <delete id="deleteCmmPrty" parameterType="CmmPrtyVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.deleteCmmPrty] */
        DELETE
          FROM CM_1510T
         WHERE PRTY_NM      = #{prtyNm}
    </delete>

    <!-- Sync Command 송수신 이력을 조회한다. -->
    <select id="selectSyncCommandSendReceiveHistoryByCondition" parameterType="SyncCommandSendReceiveHistorySearchVO" resultType="SyncCommandSendReceiveHistoryVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectSyncCommandSendReceiveHistoryByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, V1.* FROM (
            SELECT * FROM (
                SELECT 'SEND' AS FLAG
                     , T1.SEND_RECEIVE_TRX_ID
                     , T1.SEND_DT AS EVENT_DT
                     , T1.CMD_CD
                     , T1.DLR_CD
                     , (SELECT D.DLR_NM FROM VW_COM_DLR_INFO D WHERE D.DLR_CD = T1.DLR_CD) AS DLR_NM
                     , T1.CMD_TC_XML_BODY_CONT
                     , NULL AS RES_TC_XML_BODY_CONT
                     , NULL AS RES_PROC_RSLT_CD
                     , NULL AS RES_PROC_RSLT_MESG_CONT
                     , DLR_IP_ADDR_NM
                     , DLR_PORT_NO
                  FROM CM_1508T T1
                <where>
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        T1.DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sCmdCd != null and sCmdCd != ""'>
                        AND T1.CMD_CD = #{sCmdCd}
                    </if>
                    <if test='sSendReceiveTrxId != null and sSendReceiveTrxId != ""'>
                        AND T1.SEND_RECEIVE_TRX_ID = #{sSendReceiveTrxId}
                    </if>
                    <if test='sStartTrxDt != null'>
                        AND T1.SEND_DT <![CDATA[ >= ]]> #{sStartTrxDt}
                    </if>
                    <if test='sEndTrxDt != null'>
                        AND T1.SEND_DT <![CDATA[ < ]]> #{sEndTrxDt} + 1
                    </if>
                </where>
                UNION ALL
                SELECT 'RECEIVE' AS FLAG
                     , T1.SEND_RECEIVE_TRX_ID
                     , T1.RECEIVE_DT AS EVENT_DT
                     , T1.CMD_CD
                     , T1.DLR_CD
                     , (SELECT D.DLR_NM FROM VW_COM_DLR_INFO D WHERE D.DLR_CD = T1.DLR_CD) AS DLR_NM
                     , NULL CMD_TC_XML_BODY_CONT
                     , T1.RES_TC_XML_BODY_CONT
                     , T1.RES_PROC_RSLT_CD
                     , T1.RES_PROC_RSLT_MESG_CONT
                     , (SELECT MAX(DLR_IP_ADDR_NM) FROM CM_1508T S WHERE S.SEND_RECEIVE_TRX_ID = T1.SEND_RECEIVE_TRX_ID) AS DLR_IP_ADDR_NM
                     , (SELECT MAX(DLR_PORT_NO) FROM CM_1508T S WHERE S.SEND_RECEIVE_TRX_ID = T1.SEND_RECEIVE_TRX_ID) AS DLR_PORT_NO
                  FROM CM_1509T T1
                <where>
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        T1.DLR_CD = #{sDlrCd}
                    </if>
                    <if test='sCmdCd != null and sCmdCd != ""'>
                        AND T1.CMD_CD = #{sCmdCd}
                    </if>
                    <if test='sSendReceiveTrxId != null and sSendReceiveTrxId != ""'>
                        AND T1.SEND_RECEIVE_TRX_ID = #{sSendReceiveTrxId}
                    </if>
                    <if test='sStartTrxDt != null'>
                        AND T1.RECEIVE_DT <![CDATA[ >= ]]> #{sStartTrxDt}
                    </if>
                    <if test='sEndTrxDt != null'>
                        AND T1.RECEIVE_DT <![CDATA[ < ]]> #{sEndTrxDt} + 1
                    </if>
                </where>
            )
            <where>
                <if test='sFlag != null and sFlag != ""'>
                    FLAG = #{sFlag}
                </if>
            </where>

                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "flag"'>FLAG <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "sendReceiveTrxId"'>SEND_RECEIVE_TRX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "eventDt"'>EVENT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "dlrNm"'>DLR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    SEND_RECEIVE_TRX_ID ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        EVENT_DT DESC, FLAG
                    </otherwise>
                </choose>
            ) V1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- Sync Command 송수신 이력 목록수를 조회한다. -->
    <select id="selectSyncCommandSendReceiveHistoryByConditionCnt" parameterType="SyncCommandSendReceiveHistorySearchVO" resultType="int">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectSyncCommandSendReceiveHistoryByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM (
        SELECT * FROM (
            SELECT T1.SEND_RECEIVE_TRX_ID, 'SEND' AS FLAG
              FROM CM_1508T T1
            <where>
                <if test='sDlrCd != null and sDlrCd != ""'>
                    T1.DLR_CD = #{sDlrCd}
                </if>
                <if test='sCmdCd != null and sCmdCd != ""'>
                    AND T1.CMD_CD = #{sCmdCd}
                </if>
                <if test='sSendReceiveTrxId != null and sSendReceiveTrxId != ""'>
                    AND T1.SEND_RECEIVE_TRX_ID = #{sSendReceiveTrxId}
                </if>
                <if test='sStartTrxDt != null'>
                    AND T1.SEND_DT <![CDATA[ >= ]]> #{sStartTrxDt}
                </if>
                <if test='sEndTrxDt != null'>
                    AND T1.SEND_DT <![CDATA[ < ]]> #{sEndTrxDt} + 1
                </if>
            </where>
            UNION ALL
            SELECT T1.SEND_RECEIVE_TRX_ID, 'RECEIVE' AS FLAG
              FROM CM_1509T T1
            <where>
                <if test='sDlrCd != null and sDlrCd != ""'>
                    T1.DLR_CD = #{sDlrCd}
                </if>
                <if test='sCmdCd != null and sCmdCd != ""'>
                    AND T1.CMD_CD = #{sCmdCd}
                </if>
                <if test='sSendReceiveTrxId != null and sSendReceiveTrxId != ""'>
                    AND T1.SEND_RECEIVE_TRX_ID = #{sSendReceiveTrxId}
                </if>
                <if test='sStartTrxDt != null'>
                    AND T1.RECEIVE_DT <![CDATA[ >= ]]> #{sStartTrxDt}
                </if>
                <if test='sEndTrxDt != null'>
                    AND T1.RECEIVE_DT <![CDATA[ < ]]> #{sEndTrxDt} + 1
                </if>
            </where>
            )
        )
        <where>
            <if test='sFlag != null and sFlag != ""'>
                FLAG = #{sFlag}
            </if>
        </where>

    </select>


    <!-- 특정 조건의 Message Template를 조회한다. -->
    <select id="selectMessageTemplateByCondition" parameterType="HashMap" resultType="SyncMessageTemplateVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.selectMessageTemplateByCondition] */
        SELECT
              MESG_CD
             , MESG_GRP_CD
             , MESG_NM
             , MESG_BODY_CONT
             , DEL_YN
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
         FROM CM_1603T
        <where>
            <if test='mesgCd != null and mesgCd != ""'>
                AND MESG_CD LIKE #{mesgCd} || '%'
            </if>
        </where>
        ORDER BY MESG_CD
    </select>

    <!-- MessageTemplate 정보 생성  -->
    <insert id="insertMessageTemplate" parameterType="SyncMessageTemplateVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.insertMessageTemplate] */
        INSERT
          INTO CM_1603T(
              MESG_CD
             , MESG_GRP_CD
             , MESG_NM
             , MESG_BODY_CONT
             , DEL_YN
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
        )VALUES(
               #{mesgCd      }
             , #{mesgGrpCd   }
             , #{mesgNm      }
             , #{mesgBodyCont}
             , #{delYn       }
             , #{regUsrId    }
             , SYSDATE
             , ''
             , ''
        )
    </insert>

    <!-- MessageTemplate 정보 수정  -->
    <update id="updateMessageTemplate" parameterType="SyncMessageTemplateVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.updateMessageTemplate] */
        UPDATE CM_1603T
                    SET MESG_GRP_CD    = #{mesgGrpCd    }
                      , MESG_NM        = #{mesgNm       }
                      , MESG_BODY_CONT = #{mesgBodyCont }
                      , DEL_YN         = #{delYn        }
                      , UPDT_USR_ID    = #{updtUsrId    }
                      , UPDT_DT        = SYSDATE
                  WHERE MESG_CD        = #{mesgCd       }
    </update>


    <!-- MessageTemplate 정보 삭제  -->
    <delete id="deleteMessageTemplate" parameterType="SyncMessageTemplateVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.deleteMessageTemplate] */
        DELETE
          FROM CM_1603T
         WHERE MESG_CD      = #{mesgCd}
    </delete>


    <!-- Virtual DMS Profile 목록을 조회한다. -->
    <select id="selectSimulationServer" parameterType="HashMap" resultType="SimulationServerVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.selectSimulationServer] */
        SELECT DLR_CD
             , DLR_NM
             , TEL_NO
             , FAX_NO
             , DMS_IP_NM
             , DMS_PORT_NM
             , DMS_TEST_URL_NM
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
          FROM CM_1610T
    </select>


    <!-- SimulationServer 정보 생성  -->
    <insert id="insertSimulationServer" parameterType="SimulationServerVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.insertSimulationServer] */
        INSERT
          INTO CM_1610T(
               DLR_CD
             , DLR_NM
             , TEL_NO
             , FAX_NO
             , DMS_IP_NM
             , DMS_PORT_NM
             , DMS_TEST_URL_NM
             , REG_USR_ID
             , REG_DT
             , UPDT_USR_ID
             , UPDT_DT
        )VALUES(
               #{dlrCd        }
             , #{dlrNm        }
             , #{telNo        }
             , #{faxNo        }
             , #{dmsIpNm      }
             , #{dmsPortNm    }
             , #{dmsTestUrlNm }
             , #{regUsrId     }
             , SYSDATE
             , ''
             , ''
        )
    </insert>

    <!-- Virtual DMS Profile 정보 수정  -->
    <update id="updateSimulationServer" parameterType="SimulationServerVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.updateSimulationServer] */
        UPDATE CM_1610T
                    SET DLR_NM          = #{dlrNm        }
                      , TEL_NO          = #{telNo        }
                      , FAX_NO          = #{faxNo        }
                      , DMS_IP_NM       = #{dmsIpNm      }
                      , DMS_PORT_NM     = #{dmsPortNm    }
                      , DMS_TEST_URL_NM = #{dmsTestUrlNm }
                      , UPDT_USR_ID     = #{updtUsrId    }
                      , UPDT_DT         = SYSDATE
                  WHERE DLR_CD          = #{dlrCd        }
    </update>

    <!-- Virtual DMS Profile 정보 삭제  -->
    <delete id="deleteSimulationServer" parameterType="SimulationServerVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.DplyCmmDAO.deleteSimulationServer] */
        DELETE
          FROM CM_1610T
         WHERE DLR_CD = #{dlrCd}
    </delete>

</mapper>