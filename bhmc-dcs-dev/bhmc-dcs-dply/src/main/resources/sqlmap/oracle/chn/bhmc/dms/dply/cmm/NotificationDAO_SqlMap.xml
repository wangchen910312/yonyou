<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : NotificationDAO_SqlMap.xml
    Description : Notification에 관한 데이터처리
    author Cheol Man Oh
    since 2016. 4. 25.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 4. 25.     Cheol Man Oh     최초 생성
-->

<mapper namespace="chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO">

	<!-- Notification Receiver 정보 목록을 조회한다. -->
	<select id="selectNotificationReceiverByCondition" parameterType="NotificationReceiverSearchVO" resultType="NotificationReceiverVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectNotificationReceiverByCondition] */
		SELECT * FROM (
            SELECT ROWNUM AS RNUM, V1.* FROM (
                SELECT
                     T1.SEQ
                    ,T1.EMAIL_NM
                    ,T1.HP_NO
                    ,T1.DEPLOY_NOTI_YN
                    ,T1.SYSTEM_NOTI_YN
                    ,T1.DEL_YN
                    ,T1.REG_USR_ID
                    ,T1.REG_DT
                    ,T1.UPDT_USR_ID
                    ,T1.UPDT_DT
                    ,T1.EMAIL_NOTI_YN
                    ,T1.HP_NOTI_YN
                FROM CM_1604T T1
                <where>
                    <if test='sSeq != null and sSeq != ""'>
                        T1.SEQ = #{sSeq}
                    </if>
                    <if test='sEmailNm != null and sEmailNm != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sEmailNm,"*")'>
                                <bind name='sEmailNm' value='@org.apache.commons.lang3.StringUtils@replace(sEmailNm, "*", "%")' />
                                 AND T1.EMAIL_NM LIKE #{sEmailNm}
                            </when>
                            <otherwise>
                                 AND T1.EMAIL_NM = #{sEmailNm}
                            </otherwise>
                        </choose>
                    </if>
                    <if test='sHpNo != null and sHpNo != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sHpNo,"*")'>
                                <bind name='sHpNo' value='@org.apache.commons.lang3.StringUtils@replace(sHpNo, "*", "%")' />
                                 AND T1.HP_NO LIKE #{sHpNo}
                            </when>
                            <otherwise>
                                 AND T1.HP_NO = #{sHpNo}
                            </otherwise>
                        </choose>
                    </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "seq"'>SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "emailNm"'>EMAIL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "hpNo"'>HP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "deployNotiYn"'>DEPLOY_NOTI_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "systemNotiYn"'>SYSTEM_NOTI_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "delYn"'>DEL_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "emailNotiYn"'>EMAIL_NOTI_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "hpNotiYn"'>HP_NOTI_YN <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    SEQ ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        SEQ ASC
                    </otherwise>
                </choose>
            ) V1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

	<!-- Notification Receiver 목록수를 조회한다. -->
	<select id="selectNotificationReceiverByConditionCnt" parameterType="NotificationReceiverSearchVO" resultType="int">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectNotificationReceiverByConditionCnt] */
		SELECT COUNT(*) AS VALUE
        FROM CM_1604T T1
		<where>
            <if test='sSeq != null and sSeq != ""'>
                T1.SEQ = #{sSeq}
            </if>
            <if test='sEmailNm != null and sEmailNm != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sEmailNm,"*")'>
                        <bind name='sEmailNm' value='@org.apache.commons.lang3.StringUtils@replace(sEmailNm, "*", "%")' />
                         AND T1.EMAIL_NM LIKE #{sEmailNm}
                    </when>
                    <otherwise>
                         AND T1.EMAIL_NM = #{sEmailNm}
                    </otherwise>
                </choose>
            </if>
            <if test='sHpNo != null and sHpNo != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sHpNo,"*")'>
                        <bind name='sHpNo' value='@org.apache.commons.lang3.StringUtils@replace(sHpNo, "*", "%")' />
                         AND T1.HP_NO LIKE #{sHpNo}
                    </when>
                    <otherwise>
                         AND T1.HP_NO = #{sHpNo}
                    </otherwise>
                </choose>
            </if>
		</where>
	</select>

    <!-- Notification Receiver 정보 생성  -->
    <insert id="insertNotificationReceiver" parameterType="NotificationReceiverVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.insertNotificationReceiver] */
        INSERT INTO CM_1604T(
             SEQ
            ,EMAIL_NM
            ,HP_NO
            ,DEPLOY_NOTI_YN
            ,SYSTEM_NOTI_YN
            ,DEL_YN
            ,REG_USR_ID
            ,REG_DT
            ,UPDT_USR_ID
            ,UPDT_DT
            ,EMAIL_NOTI_YN
            ,HP_NOTI_YN
        )VALUES(
             (SELECT NVL(MAX(SEQ),0) + 1 FROM CM_1604T)
            ,#{emailNm}
            ,#{hpNo}
            ,#{deployNotiYn}
            ,#{systemNotiYn}
            ,#{delYn}
            ,#{regUsrId}
            ,SYSDATE
            ,''
            ,''
            ,#{emailNotiYn}
            ,#{hpNotiYn}
        )
    </insert>

    <!-- Notification Receiver 정보 수정  -->
    <update id="updateNotificationReceiver" parameterType="NotificationReceiverVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.updateNotificationReceiver] */
        UPDATE CM_1604T SET
             EMAIL_NM = #{emailNm}
            ,HP_NO = #{hpNo}
            ,DEPLOY_NOTI_YN = #{deployNotiYn}
            ,SYSTEM_NOTI_YN = #{systemNotiYn}
            ,DEL_YN = #{delYn}
            ,EMAIL_NOTI_YN = #{emailNotiYn}
            ,HP_NOTI_YN = #{hpNotiYn}
            ,UPDT_USR_ID = #{updtUsrId}
            ,UPDT_DT = SYSDATE
        WHERE SEQ = #{seq}
    </update>

    <!-- Notification Receiver 정보 삭제  -->
    <delete id="deleteNotificationReceiver" parameterType="NotificationReceiverVO">
    /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.deleteNotificationReceiver] */
        DELETE FROM CM_1604T
        WHERE SEQ = #{seq}
    </delete>

    <!-- Notification History 정보 목록을 조회한다. -->
    <select id="selectNotificationHistoryByCondition" parameterType="NotificationHistorySearchVO" resultType="NotificationHistoryVO">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectNotificationHistoryByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, V1.* FROM (
                SELECT
                      T1.EVENT_DT
                     ,T1.SEQ
                     ,T1.NOTI_TP
                     ,T1.EMAIL_NM
                     ,T1.HP_NO
                     ,T1.NOTI_MESG_BODY_CONT
                     ,T1.BUNDLE_NM
                     ,T1.REG_USR_ID
                     ,T1.REG_DT
                     ,T1.UPDT_USR_ID
                     ,T1.UPDT_DT
                FROM CM_1605T T1
                <where>
                    <if test='sEventDt != null and sEventDt != ""'>
                        SUBSTR(T1.EVENT_DT, 1, 8) = #{sEventDt}
                    </if>
                    <if test='sNotiTp != null and sNotiTp != ""'>
                        T1.NOTI_TP = #{sNotiTp}
                    </if>
                    <if test='sEmailNm != null and sEmailNm != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sEmailNm,"*")'>
                                <bind name='sEmailNm' value='@org.apache.commons.lang3.StringUtils@replace(sEmailNm, "*", "%")' />
                                 AND T1.EMAIL_NM LIKE #{sEmailNm}
                            </when>
                            <otherwise>
                                 AND T1.EMAIL_NM = #{sEmailNm}
                            </otherwise>
                        </choose>
                    </if>
                    <if test='sHpNo != null and sHpNo != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sHpNo,"*")'>
                                <bind name='sHpNo' value='@org.apache.commons.lang3.StringUtils@replace(sHpNo, "*", "%")' />
                                 AND T1.HP_NO LIKE #{sHpNo}
                            </when>
                            <otherwise>
                                 AND T1.HP_NO = #{sHpNo}
                            </otherwise>
                        </choose>
                    </if>
                    <if test='sBundleNm != null and sBundleNm != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sBundleNm,"*")'>
                                <bind name='sBundleNm' value='@org.apache.commons.lang3.StringUtils@replace(sBundleNm, "*", "%")' />
                                 AND T1.BUNDLE_NM LIKE #{sBundleNm}
                            </when>
                            <otherwise>
                                 AND T1.BUNDLE_NM = #{sBundleNm}
                            </otherwise>
                        </choose>
                    </if>
                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "eventDt"'>EVENT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "seq"'>SEQ <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "notiTp"'>NOTI_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "emailNm"'>EMAIL_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "hpNo"'>HP_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "notiMesgBodyCont"'>NOTI_MESG_BODY_CONT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <when test='item.field == "bundleNm"'>BUNDLE_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    EVENT_DT ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        EVENT_DT ASC
                    </otherwise>
                </choose>
            ) V1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- Notification History 목록수를 조회한다. -->
    <select id="selectNotificationHistoryByConditionCnt" parameterType="NotificationHistorySearchVO" resultType="int">
        /* [chn.bhmc.dms.dply.cmm.service.dao.NotificationDAO.selectNotificationHistoryByConditionCnt] */
        SELECT COUNT(*) AS VALUE
        FROM CM_1605T T1
        <where>
            <if test='sEventDt != null and sEventDt != ""'>
                SUBSTR(T1.EVENT_DT, 1, 8) = #{sEventDt}
            </if>
            <if test='sNotiTp != null and sNotiTp != ""'>
                T1.NOTI_TP = #{sNotiTp}
            </if>
            <if test='sEmailNm != null and sEmailNm != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sEmailNm,"*")'>
                        <bind name='sEmailNm' value='@org.apache.commons.lang3.StringUtils@replace(sEmailNm, "*", "%")' />
                         AND T1.EMAIL_NM LIKE #{sEmailNm}
                    </when>
                    <otherwise>
                         AND T1.EMAIL_NM = #{sEmailNm}
                    </otherwise>
                </choose>
            </if>
            <if test='sHpNo != null and sHpNo != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sHpNo,"*")'>
                        <bind name='sHpNo' value='@org.apache.commons.lang3.StringUtils@replace(sHpNo, "*", "%")' />
                         AND T1.HP_NO LIKE #{sHpNo}
                    </when>
                    <otherwise>
                         AND T1.HP_NO = #{sHpNo}
                    </otherwise>
                </choose>
            </if>
            <if test='sBundleNm != null and sBundleNm != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sBundleNm,"*")'>
                        <bind name='sBundleNm' value='@org.apache.commons.lang3.StringUtils@replace(sBundleNm, "*", "%")' />
                         AND T1.BUNDLE_NM LIKE #{sBundleNm}
                    </when>
                    <otherwise>
                         AND T1.BUNDLE_NM = #{sBundleNm}
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>
</mapper>