<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    SQL File Name : ServiceLaborDAO_SqlMap.xml
    Description : 공통공임에 관한 데이터처리
    author KyungMok Kim
    since 2016. 08. 23.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 08. 23.  KyungMok Kim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.ser.cmm.service.dao.ServiceLaborDAO">

    <!-- 공임 등록. -->
    <insert id="insertServiceLabor" parameterType="ServiceLaborVO">
        /* [chn.bhmc.dms.ser.ro.service.dao.ServiceLaborDAO.insertServiceLabor] */
        INSERT INTO SE_0170T    --정비항목
        (
            DLR_CD                  --딜러코드
            ,PREFIX_ID               --PREFIX ID
            ,DOC_NO                  --문서번호
            ,LINE_NO                 --라인번호
            ,RO_TP                   --RO유형
            ,LBR_CD                  --공임코드
            ,LBR_NM                  --공임명
            ,PKG_ITEM_CD             --패키지품목코드
            ,LBR_TP                  --공임유형
            ,LBR_PRC                 --공임단가
            ,LBR_QTY                 --공임수량
            ,LBR_HM                  --공임시간
            ,DSTB_HM                 --배분시간
            ,DC_AMT                  --할인금액
            ,DC_RATE                 --할인율
            ,LBR_TOT_AMT             --공임합계금액
            ,CR_NO                   --캠페인리콜번호
            ,CR_NM                   --캠페인리콜명
            ,CR_TP                   --캠페인리콜유형
            ,FMS_CUPN_ITEM_CD        --FMS쿠폰품목코드
            ,FMS_ITEM_CD             --FMS품목코드
            ,SUB_BP_CD               --외주거래처코드
            ,SUB_BP_NM               --외주거래처명
            ,PAY_CMP_NM              --지불회사명
            ,PAYM_TP                 --결제자유형
            ,PAYM_USR_NM             --결제자명
            ,REMARK                  --비고
            ,CAU_CD                  --원인코드
            ,CAU_NM                  --원인명
            ,PHEN_CD                 --현상코드
            ,PHEN_NM                 --현상명
            ,REG_USR_ID              --등록자ID
            ,REG_DT                  --등록일자
        )
        VALUES
        (
            #{dlrCd}                  --딜러코드
            ,#{preFixId}               --PREFIX ID
            ,#{docNo}                  --문서번호
            ,#{lineNo}                 --라인번호
            ,#{roTp}                   --RO유형
            ,#{lbrCd}                  --공임코드
            ,#{lbrNm}                  --공임명
            ,#{pkgItemCd}              --패키지품목코드
            ,#{lbrTp}                  --공임유형
            ,#{lbrPrc}                 --공임단가
            ,#{lbrQty}                 --공임수량
            ,#{lbrHm}                  --공임시간
            ,#{dstbHm}                 --배분시간
            ,#{dcAmt}                  --할인금액
            ,#{dcRate}                 --할인율
            ,#{lbrTotAmt}              --공임합계금액
            ,#{crNo}                   --캠페인리콜번호
            ,#{crNm}                   --캠페인리콜명
            ,#{crTp}                   --캠페인리콜유형
            ,#{fmsCupnItemCd}          --FMS쿠폰품목코드
            ,#{fmsItemCd}              --FMS품목코드
            ,#{subBpCd}                --외주거래처코드
            ,#{subBpNm}                --외주거래처명
            ,#{payCmpNm}               --지불회사명
            ,#{paymTp}                 --결제자유형
            ,#{paymUsrNm}              --결제자명
            ,#{remark}                 --비고
            ,#{cauCd}                  --원인코드
            ,#{cauNm}                  --원인명
            ,#{phenCd}                 --현상코드
            ,#{phenNm}                 --현상명
            ,#{regUsrId}               --등록자ID
            ,SYSDATE                   --등록일자
        )
    </insert>

    <!-- 공임  수정. -->
    <update id="updateServiceLabor" parameterType="ServiceLaborVO">
        /* [chn.bhmc.dms.ser.ro.service.dao.ServiceLaborDAO.updateServiceLabor] */
        UPDATE SE_0170T SET  --정비항목
            DLR_CD           = #{dlrCd}                  --딜러코드
            ,PREFIX_ID        = #{preFixId}               --PREFIX ID
            ,DOC_NO           = #{docNo}                  --문서번호
            ,LINE_NO          = #{lineNo}                 --라인번호
            ,RO_TP            = #{roTp}                   --RO유형
            ,LBR_CD           = #{lbrCd}                  --공임코드
            ,LBR_NM           = #{lbrNm}                  --공임명
            ,PKG_ITEM_CD      = #{pkgItemCd}              --패키지품목코드
            ,LBR_TP           = #{lbrTp}                  --공임유형
            ,LBR_PRC          = #{lbrPrc}                 --공임단가
            ,LBR_QTY          = #{lbrQty}                 --공임수량
            ,LBR_HM           = #{lbrHm}                  --공임시간
            ,DSTB_HM          = #{dstbHm}                 --배분시간
            ,DC_AMT           = #{dcAmt}                  --할인금액
            ,DC_RATE          = #{dcRate}                 --할인율
            ,LBR_TOT_AMT      = #{lbrTotAmt}              --공임합계금액
            ,CR_NO            = #{crNo}                   --캠페인리콜번호
            ,CR_NM            = #{crNm}                   --캠페인리콜명
            ,CR_TP            = #{crTp}                   --캠페인리콜유형
            ,FMS_CUPN_ITEM_CD = #{fmsCupnItemCd}          --FMS쿠폰품목코드
            ,FMS_ITEM_CD      = #{fmsItemCd}              --FMS품목코드
            ,SUB_BP_CD        = #{subBpCd}                --외주거래처코드
            ,SUB_BP_NM        = #{subBpNm}                --외주거래처명
            ,PAY_CMP_NM       = #{payCmpNm}               --지불회사명
            ,PAYM_TP          = #{paymTp}                 --결제자유형
            ,PAYM_USR_NM      = #{paymUsrNm}              --결제자명
            ,REMARK           = #{remark}                 --비고
            ,CAU_CD           = #{cauCd}                  --원인코드
            ,CAU_NM           = #{cauNm}                  --원인명
            ,PHEN_CD          = #{phenCd}                 --현상코드
            ,PHEN_NM          = #{phenNm}                 --현상명
            ,REG_USR_ID       = #{regUsrId}               --등록자ID
            ,REG_DT           = #{regDt}                  --등록일자
            ,UPDT_USR_ID      = #{updtUsrId}              --수정자ID
            ,UPDT_DT          = SYSDATE                   --수정일자
        WHERE 1 = 1
        AND PREFIX_ID        = #{preFixId}               --PREFIX ID
        AND DOC_NO           = #{docNo}                  --문서번호
        AND LINE_NO          = #{lineNo}                 --라인번호
        <if test='dlrCd != null and dlrCd != ""'>
            AND DLR_CD           = #{dlrCd}                  --딜러코드
        </if>
    </update>

    <!-- 공임 삭제. -->
    <delete id="deleteServiceLabor" parameterType="ServiceLaborVO">
        /* [chn.bhmc.dms.ser.ro.service.dao.ServiceLaborDAO.deleteServiceLabor] */
        DELETE FROM SE_0170T
        WHERE 1 = 1
        AND PREFIX_ID = #{preFixId}            --PREFIX ID
        AND DOC_NO = #{docNo}                  --문서번호
        <if test='dlrCd != null and dlrCd != ""'>
            AND DLR_CD = #{dlrCd}              --딜러코드
        </if>
    </delete>

    <!-- 공임 목록 조회. -->
    <select id="selectServiceLaborsByCondition" parameterType="TabInfoSearchVO" resultType="ServiceLaborVO">
        /* [chn.bhmc.dms.ser.ro.service.dao.ServiceLaborDAO.selectServiceLaborsByCondition] */
        SELECT
            A.DLR_CD                                  --딜러코드
           ,A.PREFIX_ID                               --PREFIX ID
           ,A.DOC_NO                                  --문서번호
           ,A.LINE_NO                                 --라인번호
           ,A.RO_TP                                   --RO유형
           ,A.LBR_CD                                  --공임코드
           ,A.LBR_NM                                  --공임명
           ,A.PKG_ITEM_CD                             --패키지품목코드
           ,A.LBR_TP                                  --공임유형
           ,NVL(A.LBR_PRC,0) AS LBR_PRC               --공임단가
           ,NVL(A.LBR_QTY,1) AS LBR_QTY               --공임수량
           ,A.LBR_HM                                  --공임시간
           ,NVL(A.DSTB_HM , A.LBR_HM) AS DSTB_HM       --배분시간
           ,NVL(A.DC_AMT ,0) AS DC_AMT                 --할인금액
           ,NVL(A.DC_RATE,0) AS DC_RATE                --할인율
           ,CASE WHEN A.CR_NO IS NOT NULL THEN A.LBR_TOT_AMT ELSE (A.LBR_PRC * A.LBR_QTY * A.LBR_HM ) END AS LBR_AMT             --공임금액
           ,NVL(A.LBR_TOT_AMT,0) AS LBR_TOT_AMT       --공임합계금액
           ,A.CR_NO                                   --캠페인리콜번호
           ,A.CR_NM                                   --캠페인리콜명
           ,A.CR_TP                                   --캠페인리콜유형
           ,A.FMS_CUPN_ITEM_CD                        --FMS쿠폰품목코드
           ,A.FMS_ITEM_CD                             --FMS품목코드
           ,A.SUB_BP_CD                               --점검코드
           ,A.SUB_BP_NM                               --의견번호
           ,A.PAY_CMP_NM                              --지불회사명
           ,A.PAYM_CD                                  --결제자번호
           ,A.PAYM_TP                                 --결제자유형
           ,A.PAYM_USR_NM                             --결제자명
           ,A.REMARK                                  --비고
           ,A.CAU_CD                                  --원인코드
           ,A.CAU_NM                                  --원인명
           ,A.PHEN_CD                                 --현상코드
           ,A.PHEN_NM                                 --현상명
           ,A.REG_USR_ID                              --등록자ID
           ,A.REG_DT                                  --등록일자
           ,A.UPDT_USR_ID                             --수정자ID
           ,A.UPDT_DT                                 --수정일자
           ,A.DSTIN_CD                                --구분코드
           ,B.REAL_TEC_NM                             --정비사
           ,B.WKGRP_NO                                --소조번호
           ,B.WKGRP_NM                                --소조명
           ,B.BAY_NO                                  --BAY NO
           ,(SELECT BAY_NM
               FROM SE_1012T
              WHERE DLR_CD = A.DLR_CD
                AND BAY_NO = B.BAY_NO) AS BAY_NM     --BAY 명
            ,B.SHT_CNT                               --정비건수
            ,B.SHT_CNT AS SER_CNT                    --정비건수
            ,B.PAINT_CNT                             --페인트 갯수
            ,B.LBR_CNT                               --공임계수
            ,B.DIFF_VAL                              --난의도계수
            ,'N' AS CAU_LBR_YN
             ,B.ALLOC_STAT_CD
             ,B.WRK_STAT_CD
        FROM SE_0170T A  LEFT OUTER JOIN SE_0330T B
         ON B.DLR_CD     = A.DLR_CD
         AND B.RO_DOC_NO = A.DOC_NO
         AND B.RPIR_CD   = A.LBR_CD
         WHERE A.DLR_CD  = #{sDlrCd}
         AND A.PREFIX_ID = #{sPreFixId}
         AND A.DOC_NO    = #{sDocNo}
        <if test='sCrYn == "Y"'>
           AND CR_NO IS NOT NULL
        </if>
        ORDER BY
        <choose>
            <when test='sort != null'>
            <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                <choose>
                    <when test='item.field == "dlrCd"'>           DLR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "preFixId"'>        PREFIX_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                    <when test='item.field == "docNo"'>           DOC_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lineNo"'>          LINE_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "roTp"'>            RO_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                    <when test='item.field == "lbrCd"'>           LBR_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrNm"'>           LBR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "pkgItemCd"'>       PKG_ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "lbrTp"'>           LBR_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "lbrPrc"'>          LBR_PRC <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrQty"'>          LBR_QTY <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrHm"'>           LBR_HM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "dstbHm"'>          DSTB_HM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "dcAmt"'>           DC_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "dcRate"'>          DC_RATE <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "lbrTotAmt"'>       LBR_TOT_AMT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "crNo"'>            CR_NO <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                    <when test='item.field == "crNm"'>            CR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                    <when test='item.field == "crTp"'>            CR_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>           </when>
                    <when test='item.field == "fmsCupnItemCd"'>   FMS_CUPN_ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                    <when test='item.field == "fmsItemCd"'>       FMS_ITEM_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "subBpCd"'>         SUB_BP_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                    <when test='item.field == "subBpNm"'>         SUB_BP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>       </when>
                    <when test='item.field == "payCmpNm"'>        PAY_CMP_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                    <when test='item.field == "paymTp"'>          PAYM_TP <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "paymUsrNm"'>       PAYM_USR_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "remark"'>          REMARK <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "cauCd"'>           CAU_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "cauNm"'>           CAU_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "phenCd"'>          PHEN_CD <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "phenNm"'>          PHEN_NM <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <when test='item.field == "regUsrId"'>        REG_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>      </when>
                    <when test='item.field == "regDt"'>           REG_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>          </when>
                    <when test='item.field == "updtUsrId"'>       UPDT_USR_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>     </when>
                    <when test='item.field == "updtDt"'>          UPDT_DT <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose>         </when>
                    <otherwise>
                        DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
                    </otherwise>
                </choose>
            </foreach>
            </when>
            <otherwise>
                DLR_CD ASC ,DOC_NO ASC ,LINE_NO ASC
            </otherwise>
        </choose>
    </select>

    <!-- 공임 목록수를 조회. -->
    <select id="selectServiceLaborsByConditionCnt" parameterType="TabInfoSearchVO" resultType="int">
        /* [chn.bhmc.dms.ser.ro.service.dao.ServiceLaborDAO.selectServiceLaborsByConditionCnt] */
        SELECT COUNT(DOC_NO)
          FROM SE_0170T    --정비항목
         WHERE DLR_CD = #{sDlrCd}
           AND PREFIX_ID = #{sPreFixId}
           AND DOC_NO = #{sDocNo}
        <if test='sCrYn == "Y"'>
           AND CR_NO IS NOT NULL
        </if>
    </select>
</mapper>