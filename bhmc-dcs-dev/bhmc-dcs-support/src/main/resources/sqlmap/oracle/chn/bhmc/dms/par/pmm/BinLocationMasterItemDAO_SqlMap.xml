<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--
    SQL File Name : LocationMasterItemDAO_SqlMap.xml
    Description : 부번별 로케이션 마스터 정보.
    author In Bo Shim
    since 2016. 6. 15.
    version 1.0
    Modification Information
       since          author              description
    ===========    =============    ===========================
    2016. 06. 15.     In Bo Shim     최초 생성
-->

<mapper namespace="chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterItemDAO">

    <!-- 부번별 로케이션 마스터 정보 추가한다. -->
    <insert id="insertBinLocationMasterItem" parameterType="BinLocationMasterVO">
        /* [chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterItemDAO.insertBinLocationMasterItem] */
        INSERT INTO PT_0222T(
            DLR_CD
            ,LOC_ID
            ,PLT_CD
            ,STRGE_CD
            ,LVL_ID
            ,LOC_CD
            ,LOC_NM
            ,UPPER_LOC_ID
            ,ITEM_CD
            ,MAIN_LOC_YN
            ,UPPER_LVL_ID
            ,BASE_LVL_ID
            ,REG_USR_ID
            ,REG_DT
        ) VALUES (
            #{dlrCd}
            ,#{locId}
            ,#{pltCd}
            ,#{strgeCd}
            ,#{lvlId}
            ,#{locCd}
            ,#{locNm}
            ,#{upperLocId}
            ,#{itemCd}
            ,'N'
            ,#{lvlId}-1
            ,( select count(0)+1 from PT_0222T A WHERE A.DLR_CD = #{dlrCd} AND A.ITEM_CD IS NULL AND A.MAIN_LOC_YN = 'N' )
            ,#{regUsrId}
            ,SYSDATE
        )
    </insert>

    <!-- 부번별 로케이션 마스터 정보 수정한다. -->
    <update id="updateBinLocationMasterItem" parameterType="BinLocationMasterVO">
        /* [chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterItemDAO.updateBinLocationMasterItem] */
        UPDATE PT_0222T SET
            UPDT_DT = SYSDATE
            ,UPDT_USR_ID = #{updtUsrId}
            ,STRGE_CD = #{strgeCd}
            ,LOC_CD = #{locCd}
            ,LOC_NM = #{locNm}
            ,UPPER_LOC_ID = #{upperLocId}
        WHERE DLR_CD = #{dlrCd}
        AND LOC_ID = #{dbLocId}

    </update>

    <!-- 부번별 로케이션 마스터 정보 삭제한다. -->
    <update id="deleteBinLocationMasterItem" parameterType="BinLocationMasterVO">
        /* [chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterItemDAO.deleteBinLocationMasterItem] */
        DELETE FROM PT_0222T
        WHERE DLR_CD = #{dlrCd}
        AND LOC_CD = #{locCd}
    </update>

    <!-- 부번별 로케이션 마스터 정보 목록을 조회한다. -->
    <select id="selectBinLocationMasterItemsByCondition" parameterType="BinLocationMasterSearchVO" resultType="BinLocationMasterItemVO">
        /* [chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterDAO.selectBinLocationMasterItemsByCondition] */
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, T1.* FROM (
                SELECT
                    A.GR_STRGE_CD
                    ,A.ITEM_CD
                    ,A.ITEM_NM
                    ,B.LOC_ID AS DB_LOC_ID
                    ,B.LOC_ID
                    ,B.PLT_CD
                    ,NVL(B.STRGE_CD, A.GR_STRGE_CD) AS STRGE_CD
                    ,NVL(B.LVL_ID,3) AS LVL_ID
                    ,B.LOC_CD AS DB_LOC_CD
                    ,B.LOC_CD
                    ,B.LOC_NM
                    ,B.UPPER_LOC_ID
                    ,A.CARLINE_CD
                    ,A.ITEM_DSTIN_CD
                    ,NVL(C.LGTH_CNT, 5) AS LGTH_CNT
                    ,NVL(C.CD_TP,'N') AS CD_TP
                FROM PT_0201T A
                LEFT JOIN PT_0222T B ON A.DLR_CD = B.DLR_CD AND A.GR_STRGE_CD = B.STRGE_CD AND A.ITEM_CD = B.ITEM_CD
                LEFT JOIN PT_0221T C ON A.DLR_CD = B.DLR_CD AND B.LVL_ID = C.LVL_ID
                <where>
                    <if test='sDlrCd != null and sDlrCd != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
                                <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
                                 AND A.DLR_CD LIKE #{sDlrCd}
                            </when>
                            <otherwise>
                                 AND A.DLR_CD = #{sDlrCd}
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sStrgeCd != null and sStrgeCd != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sStrgeCd,"*")'>
                                <bind name='sStrgeCd' value='@org.apache.commons.lang3.StringUtils@replace(sStrgeCd, "*", "%")' />
                                 AND A.GR_STRGE_CD LIKE #{sStrgeCd}
                            </when>
                            <otherwise>
                                 AND A.GR_STRGE_CD = #{sStrgeCd}
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sItemCd != null and sItemCd != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                                <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                                 AND A.ITEM_CD LIKE #{sItemCd}
                            </when>
                            <otherwise>
                                 AND A.ITEM_CD = #{sItemCd}
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sLocCond != null and sLocCond != ""'>
                        <choose>
                            <when test='@org.apache.commons.lang3.StringUtils@contains(sLocCond,"01")'>
                                 AND B.LOC_CD is null
                            </when>
                            <otherwise>
                                 AND B.LOC_CD is not null
                            </otherwise>
                        </choose>
                    </if>

                    <if test='sLocId != null and sLocId != ""'>
                        AND B.LOC_ID = #{sLocId}
                    </if>

                </where>
                ORDER BY
                <choose>
                    <when test='sort != null'>
                        <foreach item="item" index="index" collection="sort" open="" separator="," close="">
                            <choose>
                                <when test='item.field == "locId"'>B.LOC_ID <choose><when test='item.dir == "asc"'>ASC</when><otherwise>DESC</otherwise></choose></when>
                                <otherwise>
                                    A.DLR_CD, B.LOC_CD ASC
                                </otherwise>
                            </choose>
                        </foreach>
                    </when>
                    <otherwise>
                        A.DLR_CD, B.LOC_CD ASC
                    </otherwise>
                </choose>
            ) T1
            <where>
                <if test='firstIndex != -1 and lastIndex != -1'>
                    ROWNUM <![CDATA[<=]]> #{lastIndex}
                </if>
            </where>
        )
        <where>
            <if test='firstIndex != -1 and lastIndex != -1'>
                RNUM > #{firstIndex}
            </if>
        </where>
    </select>

    <!-- 부번별 로케이션 마스터 정보 카운트를 조회한다. -->
    <select id="selectBinLocationMasterItemsByConditionCnt" parameterType="BinLocationMasterSearchVO" resultType="int">
        /* [chn.bhmc.dms.par.pmm.service.dao.BinLocationMasterDAO.selectBinLocationMasterItemsByConditionCnt] */
        SELECT
          COUNT(0)
        FROM PT_0201T A
        LEFT JOIN PT_0222T B ON A.DLR_CD = B.DLR_CD AND A.GR_STRGE_CD = B.STRGE_CD AND A.ITEM_CD = B.ITEM_CD
        <where>
            <if test='sDlrCd != null and sDlrCd != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sDlrCd,"*")'>
                        <bind name='sDlrCd' value='@org.apache.commons.lang3.StringUtils@replace(sDlrCd, "*", "%")' />
                         AND A.DLR_CD LIKE #{sDlrCd}
                    </when>
                    <otherwise>
                         AND A.DLR_CD = #{sDlrCd}
                    </otherwise>
                </choose>
            </if>

            <if test='sStrgeCd != null and sStrgeCd != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sStrgeCd,"*")'>
                        <bind name='sFullCd' value='@org.apache.commons.lang3.StringUtils@replace(sStrgeCd, "*", "%")' />
                         AND A.GR_STRGE_CD LIKE #{sStrgeCd}
                    </when>
                    <otherwise>
                         AND A.GR_STRGE_CD = #{sStrgeCd}
                    </otherwise>
                </choose>
            </if>

            <if test='sItemCd != null and sItemCd != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sItemCd,"*")'>
                        <bind name='sItemCd' value='@org.apache.commons.lang3.StringUtils@replace(sItemCd, "*", "%")' />
                         AND A.ITEM_CD LIKE #{sItemCd}
                    </when>
                    <otherwise>
                         AND A.ITEM_CD = #{sItemCd}
                    </otherwise>
                </choose>
            </if>

            <if test='sLocCond != null and sLocCond != ""'>
                <choose>
                    <when test='@org.apache.commons.lang3.StringUtils@contains(sLocCond,"01")'>
                         AND B.LOC_CD is null
                    </when>
                    <otherwise>
                         AND B.LOC_CD is not null
                    </otherwise>
                </choose>
            </if>

            <if test='sLocId != null and sLocId != ""'>
                AND B.LOC_ID = #{sLocId}
            </if>

        </where>
    </select>

</mapper>